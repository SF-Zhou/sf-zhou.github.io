<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>Rust 二进制序列化 | SF-Zhou's Blog</title>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GQ26H3JQ3G"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-GQ26H3JQ3G');
    </script>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> Rust 二进制序列化 </h1>
      </div>
      <div class="info">
        <div class="date"> 2024.07.19 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <p>最近在做 Rust RDMA RPC 框架，需要一套二进制序列化库。因为对 Rust 编程中的范型和宏不是太熟悉，所以刚好自己做一套用以练手。项目 repo 是 <a href="https://github.com/SF-Zhou/derse">SF-Zhou/derse</a>，本文简述一下该序列化库的设计方案。</p>
<h3 id="1.-二进制格式" tabindex="-1"><a href="#1.-%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%A0%BC%E5%BC%8F">1. 二进制格式</a></h3>
<p>序列化的二进制格式参考我原先做的 C++ 库，大概原则是这样的：</p>
<ol>
<li>所有字段仅保留值，不记录类型信息，不进行对齐操作；</li>
<li>数值直接使用小端存储；</li>
<li>String/Vec 先序列化其长度，再序列化具体内容；</li>
<li>各类长度信息使用 VarInt 存储以减少长度；</li>
<li>对结构体，先序列化整个序列化结果的长度，再依次序列化所有字段；</li>
<li>支持在结构体尾部增加字段，维持兼容性。</li>
</ol>
<p>举例：</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">A</span> <span class="token punctuation">{</span>
  x<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
  y<span class="token punctuation">:</span> <span class="token keyword">i32</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">B</span> <span class="token punctuation">{</span>
  a<span class="token punctuation">:</span> <span class="token class-name">A</span><span class="token punctuation">,</span>
  b<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// 以下是一个 B 类型对象的序列化结果</span>
data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x1a</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">,</span> <span class="token number">0x0c</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token number">0x65</span><span class="token punctuation">,</span> <span class="token number">0x6c</span><span class="token punctuation">,</span> <span class="token number">0x6c</span><span class="token punctuation">,</span> <span class="token number">0x6f</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0x77</span><span class="token punctuation">,</span> <span class="token number">0x6f</span><span class="token punctuation">,</span> <span class="token number">0x72</span><span class="token punctuation">,</span> <span class="token number">0x6c</span><span class="token punctuation">,</span> <span class="token number">0x64</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xe9</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

data <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token number">0x1a</span><span class="token punctuation">,</span> <span class="token comment">// B 类型各个字段序列化的总长度为 26</span>
    <span class="token comment">// 第一个字段：结构体 a</span>
    <span class="token number">0x11</span><span class="token punctuation">,</span> <span class="token comment">// A 类型各个字段序列化的总长度为 17</span>
      <span class="token comment">// 第一个字段：String</span>
      <span class="token number">0x0c</span><span class="token punctuation">,</span> <span class="token comment">// 字符串的长度为 12</span>
        <span class="token comment">// 解析字符串，得到 "hello world!"</span>
        <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token number">0x65</span><span class="token punctuation">,</span> <span class="token number">0x6c</span><span class="token punctuation">,</span> <span class="token number">0x6c</span><span class="token punctuation">,</span> <span class="token number">0x6f</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0x77</span><span class="token punctuation">,</span> <span class="token number">0x6f</span><span class="token punctuation">,</span> <span class="token number">0x72</span><span class="token punctuation">,</span> <span class="token number">0x6c</span><span class="token punctuation">,</span> <span class="token number">0x64</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span>
      <span class="token comment">// 第二个字段：i32</span>
      <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token comment">// 小端解析得到数字 32</span>
    <span class="token comment">// 第二个字段：u64</span>
    <span class="token number">0xe9</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token comment">// 小端解析得到数字 233</span>
<span class="token punctuation">]</span>
</code></pre>
<h3 id="2.-序列化" tabindex="-1"><a href="#2.-%E5%BA%8F%E5%88%97%E5%8C%96">2. 序列化</a></h3>
<p>实现这样的序列化似乎并不复杂：</p>
<ol>
<li>对数值来说，可以直接调用 <code>&amp;x.to_le_bytes()</code> 获得 <code>&amp;[u8]</code></li>
<li>对字符串来说，可以直接调用 <code>x.as_bytes()</code> 获得 <code>&amp;[u8]</code></li>
<li>对于结构体，按顺序将每个字段转为 <code>&amp;[u8]</code>，再拼接上长度</li>
<li>对于类似 <code>Vec&lt;Item&gt;</code> 这样的容器，按顺序将每个 <code>Item</code> 转为 <code>&amp;[u8]</code></li>
</ol>
<p>所以需要一个容器，用以存储序列化的结果。并且该容器最好是可以用户自定义的，故这里定义一个 <code>Serializer</code> 的 trait 用以表征承载序列化结果的容器。考虑上一节中提到的第 5 条，因为结构体序列化的长度是记录在最前方的，而该长度又是变长的，我们无法在序列化完成前轻松地获得该长度，也不希望先序列化字段到某个 buffer 后再复制，所以这里定义一个反向增长的 <code>prepend</code> 接口，会将当前传入的 <code>&amp;[u8]</code> 复制到 <code>serializer</code> 的前方。序列化结构体时，先<strong>逆序</strong>地序列化所有字段，最后再序列化长度。最终 <code>Serializer</code> 的定义如下：</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">Serializer</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">prepend</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token keyword">impl</span> <span class="token class-name">AsRef</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">len</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>对于序列化操作本身，定义一个 <code>Serialize</code> 的 trait，需要用户自行实现的接口函数是 <code>serialize_to</code>，即将某个对象序列化到现有的 <code>serializer</code> 上：</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">Serialize</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">serialize</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Serializer</span> <span class="token operator">+</span> <span class="token class-name">Default</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> serializer <span class="token operator">=</span> <span class="token class-name">S</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">serialize_to</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> serializer<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>serializer<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">serialize_to</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Serializer</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> serializer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">S</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>基础类型的 <code>Serialize</code> 实现举例：</p>
<pre class="language-rust"><code class="language-rust"><span class="token comment">// 1. bool 类型序列化结果占用一个字节</span>
<span class="token keyword">impl</span> <span class="token class-name">Serialize</span> <span class="token keyword">for</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">serialize_to</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Serializer</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> serializer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">S</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        serializer<span class="token punctuation">.</span><span class="token function">prepend</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token keyword">self</span> <span class="token keyword">as</span> <span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 2. 各类数值类型使用宏避免重复代码</span>
<span class="token macro property">macro_rules!</span> impl_serialize_trait <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$t</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">ty</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        $<span class="token punctuation">(</span><span class="token keyword">impl</span> <span class="token class-name">Serialize</span> <span class="token keyword">for</span> <span class="token variable">$t</span> <span class="token punctuation">{</span>
            <span class="token keyword">fn</span> <span class="token function-definition function">serialize_to</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Serializer</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> serializer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">S</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
                serializer<span class="token punctuation">.</span><span class="token function">prepend</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">to_le_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property">impl_serialize_trait!</span> <span class="token punctuation">{</span><span class="token keyword">i8</span><span class="token punctuation">,</span> <span class="token keyword">i16</span><span class="token punctuation">,</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token keyword">i64</span><span class="token punctuation">,</span> <span class="token keyword">i128</span><span class="token punctuation">,</span> <span class="token keyword">u8</span><span class="token punctuation">,</span> <span class="token keyword">u16</span><span class="token punctuation">,</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> <span class="token keyword">u128</span><span class="token punctuation">,</span> <span class="token keyword">f32</span><span class="token punctuation">,</span> <span class="token keyword">f64</span><span class="token punctuation">}</span>

<span class="token comment">// 3. 对于 usize 这种按平台有不同大小的类型，统一转为 u64 保证统一</span>
<span class="token keyword">impl</span> <span class="token class-name">Serialize</span> <span class="token keyword">for</span> <span class="token keyword">usize</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">serialize_to</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Serializer</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> serializer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">S</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">self</span> <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serialize_to</span><span class="token punctuation">(</span>serializer<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 4. 对于字符串，先序列化字符串的内容，再序列化它的长度</span>
<span class="token keyword">impl</span> <span class="token class-name">Serialize</span> <span class="token keyword">for</span> <span class="token keyword">str</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">serialize_to</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Serializer</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> serializer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">S</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        serializer<span class="token punctuation">.</span><span class="token function">prepend</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token class-name">VarInt64</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serialize_to</span><span class="token punctuation">(</span>serializer<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> <span class="token class-name">Serialize</span> <span class="token keyword">for</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">serialize_to</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Serializer</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> serializer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">S</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">as_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serialize_to</span><span class="token punctuation">(</span>serializer<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 5. 对 Vec 亦然，并且序列化 Item 时需要逆序</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">:</span> <span class="token class-name">Serialize</span><span class="token operator">></span> <span class="token class-name">Serialize</span> <span class="token keyword">for</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Item</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">serialize_to</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Serializer</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> serializer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">S</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> item <span class="token keyword">in</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            item<span class="token punctuation">.</span><span class="token function">serialize_to</span><span class="token punctuation">(</span>serializer<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">VarInt64</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serialize_to</span><span class="token punctuation">(</span>serializer<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 6. 对于 Option，需要额外的一个字节记录是否存在值</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">:</span> <span class="token class-name">Serialize</span><span class="token operator">></span> <span class="token class-name">Serialize</span> <span class="token keyword">for</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Item</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">serialize_to</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Serializer</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> serializer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">S</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span> <span class="token punctuation">{</span>
            item<span class="token punctuation">.</span><span class="token function">serialize_to</span><span class="token punctuation">(</span>serializer<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
            <span class="token boolean">true</span><span class="token punctuation">.</span><span class="token function">serialize_to</span><span class="token punctuation">(</span>serializer<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token boolean">false</span><span class="token punctuation">.</span><span class="token function">serialize_to</span><span class="token punctuation">(</span>serializer<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 7. 对于不同长度的 tuple，同样借助宏生成代码</span>
<span class="token macro property">macro_rules!</span> tuple_serialization <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">ident</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">+</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$idx</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">tt</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">+</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">impl</span><span class="token operator">&lt;</span>$<span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">+</span><span class="token operator">></span> <span class="token class-name">Serialize</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">)</span>
        <span class="token keyword">where</span>
            $<span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">:</span> <span class="token class-name">Serialize</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">+</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">fn</span> <span class="token function-definition function">serialize_to</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Serializer</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> serializer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">S</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
                $<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token variable">$idx</span><span class="token punctuation">.</span><span class="token function">serialize_to</span><span class="token punctuation">(</span>serializer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token operator">+</span>
                <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property">tuple_serialization!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">H</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">tuple_serialization!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">H</span><span class="token punctuation">,</span> <span class="token class-name">I</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">tuple_serialization!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">H</span><span class="token punctuation">,</span> <span class="token class-name">I</span><span class="token punctuation">,</span> <span class="token class-name">J</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">tuple_serialization!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">H</span><span class="token punctuation">,</span> <span class="token class-name">I</span><span class="token punctuation">,</span> <span class="token class-name">J</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">tuple_serialization!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">H</span><span class="token punctuation">,</span> <span class="token class-name">I</span><span class="token punctuation">,</span> <span class="token class-name">J</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">tuple_serialization!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">H</span><span class="token punctuation">,</span> <span class="token class-name">I</span><span class="token punctuation">,</span> <span class="token class-name">J</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">,</span> <span class="token class-name">M</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">tuple_serialization!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">H</span><span class="token punctuation">,</span> <span class="token class-name">I</span><span class="token punctuation">,</span> <span class="token class-name">J</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">,</span> <span class="token class-name">M</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="3.-反序列化" tabindex="-1"><a href="#3.-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96">3. 反序列化</a></h3>
<p>根据 <code>Serialize</code>，可以设计出对称的 <code>Deserialize</code> 接口：</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">Deserialize</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">deserialize</span><span class="token operator">&lt;</span><span class="token class-name">D</span><span class="token punctuation">:</span> <span class="token class-name">Deserializer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token keyword">mut</span> der<span class="token punctuation">:</span> <span class="token class-name">D</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">></span>
    <span class="token keyword">where</span>
        <span class="token keyword">Self</span><span class="token punctuation">:</span> <span class="token class-name">Sized</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">deserialize_from</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> der<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">deserialize_from</span><span class="token operator">&lt;</span><span class="token class-name">D</span><span class="token punctuation">:</span> <span class="token class-name">Deserializer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">>></span><span class="token punctuation">(</span>buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">D</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">></span>
    <span class="token keyword">where</span>
        <span class="token keyword">Self</span><span class="token punctuation">:</span> <span class="token class-name">Sized</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>带有生命周期是为了返回值可以直接引用 <code>deserializer</code> 中的一些内容以减少内存复制。依照序列化的格式，<code>Deserializer</code> 需要提供如下接口：</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">Deserializer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment">// 检查 Deserilizer 是否为空，维持兼容性时使用</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">is_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span><span class="token punctuation">;</span>

    <span class="token comment">// 向前跳过指定长度，同时返回跳过的这段</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">advance</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> len<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">></span>
    <span class="token keyword">where</span>
        <span class="token keyword">Self</span><span class="token punctuation">:</span> <span class="token class-name">Sized</span><span class="token punctuation">;</span>

    <span class="token comment">// pop 出指定长度的 &amp;[u8] 用于反序列化</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">pop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> len<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Cow</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 对 &amp;[u8] 实现 Deserializer</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token class-name">Deserializer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Checks if the byte slice is empty.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">is_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Advances the byte slice by the specified length.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">advance</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> len<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">></span>
    <span class="token keyword">where</span>
        <span class="token keyword">Self</span><span class="token punctuation">:</span> <span class="token class-name">Sized</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> len <span class="token operator">&lt;=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token punctuation">(</span>front<span class="token punctuation">,</span> back<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">split_at</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">*</span><span class="token keyword">self</span> <span class="token operator">=</span> back<span class="token punctuation">;</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span>front<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">::</span><span class="token class-name">DataIsShort</span> <span class="token punctuation">{</span>
                expect<span class="token punctuation">:</span> len<span class="token punctuation">,</span>
                actual<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Pops the specified length of data from the byte slice.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">pop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> len<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Cow</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token operator">>></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> len <span class="token operator">&lt;=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token punctuation">(</span>front<span class="token punctuation">,</span> back<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">split_at</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">*</span><span class="token keyword">self</span> <span class="token operator">=</span> back<span class="token punctuation">;</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Cow</span><span class="token punctuation">::</span><span class="token class-name">Borrowed</span><span class="token punctuation">(</span>front<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">::</span><span class="token class-name">DataIsShort</span> <span class="token punctuation">{</span>
                expect<span class="token punctuation">:</span> len<span class="token punctuation">,</span>
                actual<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>基础类型的 <code>Deserialize</code> 实现举例：</p>
<pre class="language-rust"><code class="language-rust"><span class="token comment">// 1. bool 类型，仅 0u8 和 1u8 是合法值</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token class-name">Deserialize</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">deserialize_from</span><span class="token operator">&lt;</span><span class="token class-name">D</span><span class="token punctuation">:</span> <span class="token class-name">Deserializer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">>></span><span class="token punctuation">(</span>buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">D</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">></span>
    <span class="token keyword">where</span>
        <span class="token keyword">Self</span><span class="token punctuation">:</span> <span class="token class-name">Sized</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">let</span> front <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">match</span> front<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
            <span class="token number">0</span> <span class="token operator">=></span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token number">1</span> <span class="token operator">=></span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            v <span class="token operator">=></span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">::</span><span class="token class-name">InvalidBool</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 2. 各类数值类型</span>
<span class="token macro property">macro_rules!</span> impl_deserialize_trait <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$t</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">ty</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token class-name">Deserialize</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token variable">$t</span> <span class="token punctuation">{</span>
            <span class="token keyword">fn</span> <span class="token function-definition function">deserialize_from</span><span class="token operator">&lt;</span><span class="token class-name">D</span><span class="token punctuation">:</span> <span class="token class-name">Deserializer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">>></span><span class="token punctuation">(</span>buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">D</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">></span>
            <span class="token keyword">where</span>
                <span class="token keyword">Self</span><span class="token punctuation">:</span> <span class="token class-name">Sized</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">let</span> front <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
                <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">from_le_bytes</span><span class="token punctuation">(</span>front<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">try_into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">*</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property">impl_deserialize_trait!</span> <span class="token punctuation">{</span><span class="token keyword">i8</span><span class="token punctuation">,</span> <span class="token keyword">i16</span><span class="token punctuation">,</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token keyword">i64</span><span class="token punctuation">,</span> <span class="token keyword">i128</span><span class="token punctuation">,</span> <span class="token keyword">u8</span><span class="token punctuation">,</span> <span class="token keyword">u16</span><span class="token punctuation">,</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> <span class="token keyword">u128</span><span class="token punctuation">,</span> <span class="token keyword">f32</span><span class="token punctuation">,</span> <span class="token keyword">f64</span><span class="token punctuation">}</span>

<span class="token comment">// 3. 对于字符串，支持反序列化得到 Cow&lt;'a, str> 以减少复制</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token class-name">Deserialize</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token class-name">Cow</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token keyword">str</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">deserialize_from</span><span class="token operator">&lt;</span><span class="token class-name">D</span><span class="token punctuation">:</span> <span class="token class-name">Deserializer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">>></span><span class="token punctuation">(</span>buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">D</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">></span>
    <span class="token keyword">where</span>
        <span class="token keyword">Self</span><span class="token punctuation">:</span> <span class="token class-name">Sized</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">let</span> len <span class="token operator">=</span> <span class="token class-name">VarInt64</span><span class="token punctuation">::</span><span class="token function">deserialize_from</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> front <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">match</span> front <span class="token punctuation">{</span>
            <span class="token class-name">Cow</span><span class="token punctuation">::</span><span class="token class-name">Borrowed</span><span class="token punctuation">(</span>borrowed<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">match</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">str</span><span class="token punctuation">::</span><span class="token function">from_utf8</span><span class="token punctuation">(</span>borrowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Cow</span><span class="token punctuation">::</span><span class="token class-name">Borrowed</span><span class="token punctuation">(</span><span class="token keyword">str</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">Err</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">::</span><span class="token class-name">InvalidString</span><span class="token punctuation">(</span><span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>borrowed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token class-name">Cow</span><span class="token punctuation">::</span><span class="token class-name">Owned</span><span class="token punctuation">(</span>owned<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">match</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">str</span><span class="token punctuation">::</span><span class="token function">from_utf8</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>owned<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Ok</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Cow</span><span class="token punctuation">::</span><span class="token class-name">Owned</span><span class="token punctuation">(</span><span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from_utf8_unchecked</span><span class="token punctuation">(</span>owned<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">Err</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">::</span><span class="token class-name">InvalidString</span><span class="token punctuation">(</span>owned<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token class-name">Deserialize</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">deserialize_from</span><span class="token operator">&lt;</span><span class="token class-name">D</span><span class="token punctuation">:</span> <span class="token class-name">Deserializer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">>></span><span class="token punctuation">(</span>buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">D</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">></span>
    <span class="token keyword">where</span>
        <span class="token keyword">Self</span><span class="token punctuation">:</span> <span class="token class-name">Sized</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Cow</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">str</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">deserialize_from</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">into_owned</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 4. Vec 的反序列化也很简单、直接</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">Item</span><span class="token punctuation">:</span> <span class="token class-name">Deserialize</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">>></span> <span class="token class-name">Deserialize</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Item</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">deserialize_from</span><span class="token operator">&lt;</span><span class="token class-name">D</span><span class="token punctuation">:</span> <span class="token class-name">Deserializer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">>></span><span class="token punctuation">(</span>buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">D</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">></span>
    <span class="token keyword">where</span>
        <span class="token keyword">Self</span><span class="token punctuation">:</span> <span class="token class-name">Sized</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">let</span> len <span class="token operator">=</span> <span class="token class-name">VarInt64</span><span class="token punctuation">::</span><span class="token function">deserialize_from</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> out <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>len <span class="token punctuation">{</span>
            out<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Item</span><span class="token punctuation">::</span><span class="token function">deserialize_from</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="4.-结构体" tabindex="-1"><a href="#4.-%E7%BB%93%E6%9E%84%E4%BD%93">4. 结构体</a></h3>
<p>对于结构体，序列化和反序列化的思路已经有了，但肯定不会对每个结构体都手写代码实现 <code>Serialize</code> / <code>Deserialize</code> 接口。这里使用 derive 过程宏，类似 <code>#[derive(Default)]</code>，帮助生成这两个 trait 的 impl 代码。<a href="https://github.com/SF-Zhou/derse/blob/main/derse-derive/src/lib.rs">代码略长这里就不列了</a>，生成的代码举例：</p>
<pre class="language-rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(derse::Deserialize, derse::Serialize)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">A</span> <span class="token punctuation">{</span>
  x<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
  y<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token namespace">derse<span class="token punctuation">::</span></span><span class="token class-name">Serialize</span> <span class="token keyword">for</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
  <span class="token keyword">fn</span> <span class="token function-definition function">serialize_to</span><span class="token operator">&lt;</span><span class="token class-name">Serializer</span><span class="token punctuation">:</span> <span class="token namespace">derse<span class="token punctuation">::</span></span><span class="token class-name">Serializer</span><span class="token operator">></span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span>
    serializer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Serializer</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">derse<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> start <span class="token operator">=</span> serializer<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>y<span class="token punctuation">.</span><span class="token function">serialize_to</span><span class="token punctuation">(</span>serializer<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>x<span class="token punctuation">.</span><span class="token function">serialize_to</span><span class="token punctuation">(</span>serializer<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> len <span class="token operator">=</span> serializer<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
    <span class="token namespace">derse<span class="token punctuation">::</span></span><span class="token class-name">VarInt64</span><span class="token punctuation">(</span>len <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serialize_to</span><span class="token punctuation">(</span>serializer<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'derse</span><span class="token operator">></span> <span class="token namespace">derse<span class="token punctuation">::</span></span><span class="token class-name">Deserialize</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'derse</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
  <span class="token keyword">fn</span> <span class="token function-definition function">deserialize_from</span><span class="token operator">&lt;</span><span class="token class-name">Deserializer</span><span class="token punctuation">:</span> <span class="token namespace">derse<span class="token punctuation">::</span></span><span class="token class-name">Deserializer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'derse</span><span class="token operator">>></span><span class="token punctuation">(</span>
    buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Deserializer</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">derse<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">></span>
  <span class="token keyword">where</span>
  <span class="token keyword">Self</span><span class="token punctuation">:</span> <span class="token class-name">Sized</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">derse<span class="token punctuation">::</span></span><span class="token class-name">DetailedDeserialize</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> len <span class="token operator">=</span> <span class="token namespace">derse<span class="token punctuation">::</span></span><span class="token class-name">VarInt64</span><span class="token punctuation">::</span><span class="token function">deserialize_from</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> buf <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">advance</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
      x<span class="token punctuation">:</span> <span class="token keyword">if</span> buf<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token namespace">derse<span class="token punctuation">::</span></span><span class="token class-name">Deserialize</span><span class="token punctuation">::</span><span class="token function">deserialize_from</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> buf<span class="token punctuation">)</span><span class="token operator">?</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      y<span class="token punctuation">:</span> <span class="token keyword">if</span> buf<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token namespace">derse<span class="token punctuation">::</span></span><span class="token class-name">Deserialize</span><span class="token punctuation">::</span><span class="token function">deserialize_from</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> buf<span class="token punctuation">)</span><span class="token operator">?</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>注意在反序列化时对兼容性的考量。序列化到某个字段时，如果 <code>buf</code> 恰好为空，说明序列化的代码中并没有该字段，所以直接使用 <code>Default::default()</code> 默认初始化；如果反序列化完 <code>buf</code> 仍然有内容，说明序列化的代码中还有更新的字段，这里会直接丢掉。支持增加字段对 RPC 类型的应用非常有用。</p>

      </div>
      <script src="https://giscus.app/client.js"
      data-repo="SF-Zhou/sf-zhou.github.io"
      data-repo-id="MDEwOlJlcG9zaXRvcnk4MDc5ODgwNg=="
      data-category="Announcements"
      data-category-id="DIC_kwDOBNDkVs4CA6GQ"
      data-mapping="title"
      data-reactions-enabled="0"
      data-emit-metadata="0"
      data-input-position="bottom"
      data-theme="preferred_color_scheme"
      data-lang="en"
      crossorigin="anonymous"
      async>
    </script>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2017 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/main.js"></script>
  </body>
</html>
