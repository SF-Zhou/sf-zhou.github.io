<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>Rust 2024 Return Position Impl Trait 的变化 | SF-Zhou's Blog</title>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GQ26H3JQ3G"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-GQ26H3JQ3G');
    </script>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> Rust 2024 Return Position Impl Trait 的变化 </h1>
      </div>
      <div class="info">
        <div class="date"> 2024.10.11 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <p>一个月前，Rust 官方发布了一篇博客 <a href="https://blog.rust-lang.org/2024/09/05/impl-trait-capture-rules.html">Changes to <code>impl Trait</code> in Rust 2024</a>，介绍了 Return Position Impl Trait (RPIT) 在使用和语法上的变化。新的设计对简化异步编程十分有用，故简述一下。</p>
<h3 id="1.-背景" tabindex="-1"><a href="#1.-%E8%83%8C%E6%99%AF">1. 背景</a></h3>
<p>RPIT 举例（<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=cc36dc9420e0d02f1f15e37ce9a04f6a">在线执行</a>）：</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">process</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">impl</span> <span class="token class-name">Iterator</span><span class="token operator">&lt;</span><span class="token class-name">Item</span> <span class="token operator">=</span> <span class="token keyword">u8</span><span class="token operator">></span> <span class="token punctuation">{</span>
    data<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>v<span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">*</span>v <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>上方的函数声明中隐藏了返回值的实际类型，返回 <code>impl Iterator</code> 表明它返回的是某种迭代器。调用方获得返回值后，也仅能通过迭代器的相关方法操作返回值。当然，编译器是知道该函数返回的是什么类型的，内部仍然是静态派发。</p>
<p>虽然调用者不知道返回的类型，但需要让它知道它会继续借用 <code>data</code> 参数，这样才能保证合法使用返回的迭代器。RPIT 原先的规则是必须显式地在函数声明中注明生命周期，所以上方的代码可以这样修改（<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=97b6c616e644e75b5cd41c7374e588fe">在线执行</a>）：</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">process</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">impl</span> <span class="token class-name">Iterator</span><span class="token operator">&lt;</span><span class="token class-name">Item</span> <span class="token operator">=</span> <span class="token keyword">u8</span><span class="token operator">></span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'_</span> <span class="token punctuation">{</span>
    data<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>v<span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">*</span>v <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 更加显式的声明</span>
<span class="token keyword">fn</span> <span class="token function-definition function">process</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'d</span><span class="token operator">></span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'d</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">impl</span> <span class="token class-name">Iterator</span><span class="token operator">&lt;</span><span class="token class-name">Item</span> <span class="token operator">=</span> <span class="token keyword">u8</span><span class="token operator">></span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'d</span> <span class="token punctuation">{</span>
    data<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>v<span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">*</span>v <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="2.-问题" tabindex="-1"><a href="#2.-%E9%97%AE%E9%A2%98">2. 问题</a></h3>
<p>对于原先的 RPIT 方案，官方列举了以下问题：</p>
<ol>
<li>不是正确的默认行为：官方统计了 Rust 编译器和 <a href="http://crates.io">crates.io</a> 上的代码，大部分使用 RPIT 均需要使用生命周期，默认不使用生命周期的方案不方便</li>
<li>不够灵活：</li>
<li>难以解释：缺少生命周期声明时，难以向用户解释该错误</li>
<li>生命周期标注表达能力不足：将在下方举例说明</li>
<li>当前设计也与 Rust 的其他部分存在不一致，尤其是异步编程。</li>
</ol>
<p>对于第 4 点，部分情况下当前 RPIT 的生命周期标注的表达能力是不足的，例如（<a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=dd220df1f954d1f3e0c8b65d7d911b82">在线执行</a>）：</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">process</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span><span class="token operator">></span><span class="token punctuation">(</span>label<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">impl</span> <span class="token class-name">Iterator</span><span class="token operator">&lt;</span><span class="token class-name">Item</span> <span class="token operator">=</span> <span class="token class-name">String</span><span class="token operator">></span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'a</span> <span class="token punctuation">{</span>
    data<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>v<span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"{}-{}"</span><span class="token punctuation">,</span> label<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>上述代码会报错：the parameter type <code>T</code> must be valid for the lifetime <code>'a</code> as defined here. 但实际上这一点是不需要的。出现该错误的原因有点微妙，因为返回的类型中我们需要使用到 <code>label: 'a</code>，就目前的设计来看，我们只能把 <code>'a</code> 标注在返回类型的尾部。但显示地标注生命周期实际上产生了更严格的生命周期约束，<code>+ 'a</code> 的语义是返回的隐藏类型的生命周期是 <code>'a</code>。但实际上该函数的返回类型是 <code>std::iter::Map&lt;impl Iterator&lt;Item = T&gt;, impl FnMut(T) -&gt; String + 'a&gt;</code>，当下的生命周期标注会间接地要求 <code>T: 'a</code>，实际上这并不是需要的。当前的生命周期标注的表达能力无法处理该问题。</p>
<p>对于第 5 点，异步函数实际上是一种语法糖，它会将异步函数解糖为一个 RPIT 函数：</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">process</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">..</span>
<span class="token punctuation">}</span>

<span class="token comment">// desugared</span>
<span class="token keyword">fn</span> <span class="token function-definition function">process</span><span class="token punctuation">(</span>
    data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">></span>
<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">impl</span> <span class="token class-name">Future</span><span class="token operator">&lt;</span><span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token keyword">move</span> <span class="token punctuation">{</span>
      <span class="token punctuation">..</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>但实际上，由于生命周期使用规则存在问题，这并不是真正的脱糖。真正的脱糖是一种允许使用所有生命周期的特殊 RPIT，但这种形式的 RPIT 并未向最终用户公开，与默认规则的 RPIT 并不一致。RPITIT 中也有类似的不一致问题。</p>
<h3 id="3.-方案" tabindex="-1"><a href="#3.-%E6%96%B9%E6%A1%88">3. 方案</a></h3>
<p>对于上述问题，Rust 2024 的解决方案是这样的：</p>
<ol>
<li>在默认情况下，RPIT 使用所有生命周期</li>
<li>新增 <code>+ use&lt;'x, T&gt;</code> 语法，精确指定使用到的生命周期</li>
</ol>
<p>新特性下，之前报错的代码可以顺利编译了（<a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2024&amp;gist=5e4d40e79a81f561d5b64e50f27f7341">在线执行</a>）：</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">process</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">impl</span> <span class="token class-name">Iterator</span><span class="token operator">&lt;</span><span class="token class-name">Item</span> <span class="token operator">=</span> <span class="token keyword">u8</span><span class="token operator">></span> <span class="token punctuation">{</span>
    data<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>v<span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">*</span>v <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>原先 <code>+ 'a</code> 表达能力不足的情况，也可以修改为 <code>+ use&lt;'a, T&gt;</code> 来解决（<a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2024&amp;gist=180b5d8ffc03314d2c420863d2e11c65">在线执行</a>）：</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">process</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span><span class="token operator">></span><span class="token punctuation">(</span>label<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">impl</span> <span class="token class-name">Iterator</span><span class="token operator">&lt;</span><span class="token class-name">Item</span> <span class="token operator">=</span> <span class="token class-name">String</span><span class="token operator">></span> <span class="token operator">+</span> <span class="token keyword">use</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
    data<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>v<span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"{}-{}"</span><span class="token punctuation">,</span> label<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// warning: all possible in-scope parameters are already captured, so `use&lt;...>` syntax is redundant</span>
</code></pre>
<h3 id="references" tabindex="-1"><a href="#references">References</a></h3>
<ol>
<li><a href="https://blog.rust-lang.org/2024/09/05/impl-trait-capture-rules.html">Changes to <code>impl Trait</code> in Rust 2024</a></li>
</ol>

      </div>
      <script src="https://giscus.app/client.js"
      data-repo="SF-Zhou/sf-zhou.github.io"
      data-repo-id="MDEwOlJlcG9zaXRvcnk4MDc5ODgwNg=="
      data-category="Announcements"
      data-category-id="DIC_kwDOBNDkVs4CA6GQ"
      data-mapping="title"
      data-reactions-enabled="0"
      data-emit-metadata="0"
      data-input-position="bottom"
      data-theme="preferred_color_scheme"
      data-lang="en"
      crossorigin="anonymous"
      async>
    </script>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2017 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/main.js"></script>
  </body>
</html>
