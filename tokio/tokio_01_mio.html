<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/gitalk.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>Tokio 源码分析「一、事件驱动 IO」 | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> Tokio 源码分析「一、事件驱动 IO」 </h1>
      </div>
      <div class="info">
        <div class="date"> 2020.11.08 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <p><a href="https://tokio.rs/">Tokio</a> 是 Rust 语言下的一个异步运行时，基于非阻塞 IO 和事件驱动。Tokio 中应用了协程及 <a href="https://en.wikipedia.org/wiki/Work_stealing">Work Stealing</a> 策略，实现类似 Goroutine 的 M:N 线程效果。本系列逐步分析 Tokio 的代码实现，版本为 v0.3.3，本篇关注事件驱动 IO 封装库 <a href="https://github.com/tokio-rs/mio/tree/v0.7.5">Mio</a>。</p>
<h3 id="1.-mio-概览" tabindex="-1"><a href="#1.-mio-%E6%A6%82%E8%A7%88">1. Mio 概览</a></h3>
<p>Mio 是对系统事件驱动 IO API 的封装，Linux 环境下封装的是 <a href="https://en.wikipedia.org/wiki/Epoll">epoll</a>，其他系统环境下封装的是 kqueue 和 IOCP，对外提供一致的 API 接口。本文分析 Mio v0.7.5 的源码，先看 <code>src</code> 目录下的文件结构：</p>
<pre class="language-markup"><code class="language-markup">src
├── event          # 对事件的封装
│   ├── event.rs
│   ├── events.rs
│   ├── mod.rs
│   └── source.rs
├── interest.rs    # 感兴趣的事件类型
├── io_source.rs   # 感兴趣的 IO 对象基类
├── lib.rs
├── macros
│   └── mod.rs
├── net            # 不同类型网络的接口
│   ├── mod.rs
│   ├── tcp
│   ├── udp.rs
│   └── uds
├── poll.rs        # 对外统一的 Poll 接口
├── sys            # 不同系统下的底层实现
│   ├── mod.rs
│   ├── shell
│   ├── unix
│   └── windows
├── token.rs       # 用以区分 Poll 得到的 event
└── waker.rs       # 跨线程唤醒 Poll
</code></pre>
<p>再来看官方提供的样例：</p>
<pre class="language-rust"><code class="language-rust"><span class="token comment">// You can run this example from the root of the mio repo:</span>
<span class="token comment">// cargo run --example tcp_server --features="os-poll tcp"</span>
<span class="token keyword">use</span> <span class="token namespace">mio<span class="token punctuation">::</span>event<span class="token punctuation">::</span></span><span class="token class-name">Event</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">mio<span class="token punctuation">::</span>net<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">TcpListener</span><span class="token punctuation">,</span> <span class="token class-name">TcpStream</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">mio<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Events</span><span class="token punctuation">,</span> <span class="token class-name">Interest</span><span class="token punctuation">,</span> <span class="token class-name">Poll</span><span class="token punctuation">,</span> <span class="token class-name">Registry</span><span class="token punctuation">,</span> <span class="token class-name">Token</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token class-name">Read</span><span class="token punctuation">,</span> <span class="token class-name">Write</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">str</span><span class="token punctuation">::</span>from_utf8<span class="token punctuation">;</span>

<span class="token comment">// 使用 Token 用以区分不同的 Socket 连接</span>
<span class="token keyword">const</span> <span class="token constant">SERVER</span><span class="token punctuation">:</span> <span class="token class-name">Token</span> <span class="token operator">=</span> <span class="token class-name">Token</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">DATA</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">b"Hello world!\n"</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token namespace">env_logger<span class="token punctuation">::</span></span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建 Poll 实例</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> poll <span class="token operator">=</span> <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建一个长度为 128 的空事件列表</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> events <span class="token operator">=</span> <span class="token class-name">Events</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建 TcpListener 实例 server，监听 9000 端口</span>
    <span class="token keyword">let</span> addr <span class="token operator">=</span> <span class="token string">"127.0.0.1:9000"</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> server <span class="token operator">=</span> <span class="token class-name">TcpListener</span><span class="token punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token comment">// 将 server 注册到 poll 对象中，监听可读事件</span>
    poll<span class="token punctuation">.</span><span class="token function">registry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> server<span class="token punctuation">,</span> <span class="token constant">SERVER</span><span class="token punctuation">,</span> <span class="token class-name">Interest</span><span class="token punctuation">::</span><span class="token constant">READABLE</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token comment">// 存储 &lt;Token, TcpStream> 映射</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> connections <span class="token operator">=</span> <span class="token class-name">HashMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 自增的唯一 Token </span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> unique_token <span class="token operator">=</span> <span class="token class-name">Token</span><span class="token punctuation">(</span><span class="token constant">SERVER</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"You can connect to the server using `nc`:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">" $ nc 127.0.0.1 9000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"You'll see our welcome message and anything you type we'll be printed here."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token comment">// 无限循环，poll 等待事件，None 表示不超时</span>
        poll<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> events<span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token comment">// 迭代事件</span>
        <span class="token keyword">for</span> event <span class="token keyword">in</span> events<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 根据事件对应的 token 区分事件并做相应处理</span>
            <span class="token keyword">match</span> event<span class="token punctuation">.</span><span class="token function">token</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果是 SERVER，则说明是 CLIENT 请求连接</span>
                <span class="token constant">SERVER</span> <span class="token operator">=></span> <span class="token keyword">loop</span> <span class="token punctuation">{</span>
                    <span class="token comment">// accept 获取连接 TcpStream 对象及其地址</span>
                    <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> connection<span class="token punctuation">,</span> address<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">match</span> server<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>connection<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token keyword">if</span> e<span class="token punctuation">.</span><span class="token function">kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">ErrorKind</span><span class="token punctuation">::</span><span class="token class-name">WouldBlock</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                            <span class="token comment">// `WouldBlock` 表示误报，实际上并没有连接</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>

                    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Accepted connection from: {}"</span><span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// 使用唯一的 token 注册</span>
                    <span class="token keyword">let</span> token <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> unique_token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    poll<span class="token punctuation">.</span><span class="token function">registry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>
                        <span class="token operator">&amp;</span><span class="token keyword">mut</span> connection<span class="token punctuation">,</span>
                        token<span class="token punctuation">,</span>
                        <span class="token class-name">Interest</span><span class="token punctuation">::</span><span class="token constant">READABLE</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Interest</span><span class="token punctuation">::</span><span class="token constant">WRITABLE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

                    connections<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">// 如果是其他连接的事件</span>
                token <span class="token operator">=></span> <span class="token punctuation">{</span>
                    <span class="token comment">// 从映射中获取对应的连接 connection</span>
                    <span class="token keyword">let</span> done <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span> <span class="token operator">=</span> connections<span class="token punctuation">.</span><span class="token function">get_mut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 调用函数处理读写</span>
                        <span class="token function">handle_connection_event</span><span class="token punctuation">(</span>poll<span class="token punctuation">.</span><span class="token function">registry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> connection<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token operator">?</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token boolean">false</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> done <span class="token punctuation">{</span>
                        <span class="token comment">// 及时删除无效连接</span>
                        connections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">next</span><span class="token punctuation">(</span>current<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Token</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Token</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> next <span class="token operator">=</span> current<span class="token number">.0</span><span class="token punctuation">;</span>
    current<span class="token number">.0</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token class-name">Token</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/// 如果连接结束返回 true</span>
<span class="token keyword">fn</span> <span class="token function-definition function">handle_connection_event</span><span class="token punctuation">(</span>
    registry<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Registry</span><span class="token punctuation">,</span>
    connection<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">TcpStream</span><span class="token punctuation">,</span>
    event<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Event</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> event<span class="token punctuation">.</span><span class="token function">is_writable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果是可写事件，则写入 DATA</span>
        <span class="token keyword">match</span> connection<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token constant">DATA</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这里期望一次写完，如果没有写完会返回错误</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">if</span> n <span class="token operator">&lt;</span> <span class="token constant">DATA</span><span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">ErrorKind</span><span class="token punctuation">::</span><span class="token class-name">WriteZero</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token comment">// 完整写完后，重新注册该连接，只关注可读事件</span>
                registry<span class="token punctuation">.</span><span class="token function">reregister</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Interest</span><span class="token punctuation">::</span><span class="token constant">READABLE</span><span class="token punctuation">)</span><span class="token operator">?</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// WouldBlock 表示仍没有准备好，直接跳过</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token keyword">ref</span> err<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token function">would_block</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token comment">// 中断则直接递归再重试一次</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token keyword">ref</span> err<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token function">interrupted</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">handle_connection_event</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> connection<span class="token punctuation">,</span> event<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 其他错误直接返回</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> event<span class="token punctuation">.</span><span class="token function">is_readable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果是可读事件</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> connection_closed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> received_data <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">4096</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> bytes_read <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// 循环读取</span>
        <span class="token keyword">loop</span> <span class="token punctuation">{</span>
            <span class="token keyword">match</span> connection<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> received_data<span class="token punctuation">[</span>bytes_read<span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                    <span class="token comment">// 返回 0 表示连接已关闭</span>
                    connection_closed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">Ok</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                    <span class="token comment">// 正常读取到 n 字节</span>
                    bytes_read <span class="token operator">+=</span> n<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> bytes_read <span class="token operator">==</span> received_data<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        received_data<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>received_data<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 错误处理与上方一致</span>
                <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token keyword">ref</span> err<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token function">would_block</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">break</span><span class="token punctuation">,</span>
                <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token keyword">ref</span> err<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token function">interrupted</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">continue</span><span class="token punctuation">,</span>
                <span class="token class-name">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

      	<span class="token comment">// 打印读取到的字节流</span>
        <span class="token keyword">if</span> bytes_read <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> received_data <span class="token operator">=</span> <span class="token operator">&amp;</span>received_data<span class="token punctuation">[</span><span class="token punctuation">..</span>bytes_read<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>str_buf<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">from_utf8</span><span class="token punctuation">(</span>received_data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Received data: {}"</span><span class="token punctuation">,</span> str_buf<span class="token punctuation">.</span><span class="token function">trim_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Received (none UTF-8) data: {:?}"</span><span class="token punctuation">,</span> received_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 如果连接关闭，返回 true</span>
        <span class="token keyword">if</span> connection_closed <span class="token punctuation">{</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Connection closed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">would_block</span><span class="token punctuation">(</span>err<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
    err<span class="token punctuation">.</span><span class="token function">kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">ErrorKind</span><span class="token punctuation">::</span><span class="token class-name">WouldBlock</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">interrupted</span><span class="token punctuation">(</span>err<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
    err<span class="token punctuation">.</span><span class="token function">kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">ErrorKind</span><span class="token punctuation">::</span><span class="token class-name">Interrupted</span>
<span class="token punctuation">}</span>
</code></pre>
<p>如果之前接触过 epoll，会发现调用接口和使用模式是类似的。Mio 仅在系统 API 层面上做了一致的封装，依靠 Rust 的零成本抽象并不会带来额外的开销。</p>
<h3 id="2.-epoll-封装" tabindex="-1"><a href="#2.-epoll-%E5%B0%81%E8%A3%85">2. Epoll 封装</a></h3>
<p>Mio 对外的 Poll 接口是在 <a href="https://github.com/tokio-rs/mio/blob/v0.7.5/src/poll.rs"><code>poll.rs</code></a> 中定义的。<code>Poll</code> 对象中包含一个 <code>Registry</code> 对象，<code>Registry</code> 对象中包含一个 <code>sys::Selector</code>：</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Poll</span> <span class="token punctuation">{</span>
    registry<span class="token punctuation">:</span> <span class="token class-name">Registry</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Registers I/O resources.</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Registry</span> <span class="token punctuation">{</span>
    selector<span class="token punctuation">:</span> <span class="token namespace">sys<span class="token punctuation">::</span></span><span class="token class-name">Selector</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Poll</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">registry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token class-name">Registry</span> <span class="token punctuation">{</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>registry
    <span class="token punctuation">}</span>

  	<span class="token comment">/// 等待事件</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> events<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Events</span><span class="token punctuation">,</span> timeout<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Duration</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>events<span class="token punctuation">.</span><span class="token function">sys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Registry</span> <span class="token punctuation">{</span>
    <span class="token comment">/// 注册事件源 event::Source</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">register</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> source<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">S</span><span class="token punctuation">,</span> token<span class="token punctuation">:</span> <span class="token class-name">Token</span><span class="token punctuation">,</span> interests<span class="token punctuation">:</span> <span class="token class-name">Interest</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span>
    <span class="token keyword">where</span>
        <span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token namespace">event<span class="token punctuation">::</span></span><span class="token class-name">Source</span> <span class="token operator">+</span> <span class="token operator">?</span><span class="token class-name">Sized</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token macro property">trace!</span><span class="token punctuation">(</span>
            <span class="token string">"registering event source with poller: token={:?}, interests={:?}"</span><span class="token punctuation">,</span>
            token<span class="token punctuation">,</span>
            interests
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        source<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> token<span class="token punctuation">,</span> interests<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// 注册唤醒器</span>
    <span class="token attribute attr-name">#[cfg(debug_assertions)]</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">register_waker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">register_waker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">"Only a single `Waker` can be active per `Poll` instance"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这里出现了一些新的类，<code>sys::Selector</code> / <code>Events</code> / <code>Token</code> / <code>Interest</code> / <code>event::Source</code>。首先看 <a href="https://github.com/tokio-rs/mio/blob/v0.7.5/src/token.rs"><code>token.rs</code></a>，它的实现非常简单，一个 <code>usize</code> 的结构体封装：</p>
<pre class="language-rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Copy, Clone, Debug, PartialEq, Eq, PartialOrd, Ord, Hash)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Token</span><span class="token punctuation">(</span><span class="token keyword">pub</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>Token</code> 对象会在 <code>register</code> 时指定，当 <code>event::Source</code> 发生感兴趣的事件时，返回的事件 <code>event</code> 中会包含对应的 <code>token</code> 信息。接着看 <a href="https://github.com/tokio-rs/mio/blob/v0.7.5/src/interest.rs"><code>interest.rs</code></a>：</p>
<pre class="language-rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Copy, PartialEq, Eq, Clone, PartialOrd, Ord)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Interest</span><span class="token punctuation">(</span><span class="token class-name">NonZeroU8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 定义可读/可写的值</span>
<span class="token keyword">const</span> <span class="token constant">READABLE</span><span class="token punctuation">:</span> <span class="token keyword">u8</span> <span class="token operator">=</span> <span class="token number">0b0_001</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">WRITABLE</span><span class="token punctuation">:</span> <span class="token keyword">u8</span> <span class="token operator">=</span> <span class="token number">0b0_010</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Interest</span> <span class="token punctuation">{</span>
    <span class="token comment">/// 创建可读/可写对应的 Interest 常量</span>
    <span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">READABLE</span><span class="token punctuation">:</span> <span class="token class-name">Interest</span> <span class="token operator">=</span> <span class="token class-name">Interest</span><span class="token punctuation">(</span><span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">NonZeroU8</span><span class="token punctuation">::</span><span class="token function">new_unchecked</span><span class="token punctuation">(</span><span class="token constant">READABLE</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">WRITABLE</span><span class="token punctuation">:</span> <span class="token class-name">Interest</span> <span class="token operator">=</span> <span class="token class-name">Interest</span><span class="token punctuation">(</span><span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">NonZeroU8</span><span class="token punctuation">::</span><span class="token function">new_unchecked</span><span class="token punctuation">(</span><span class="token constant">WRITABLE</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Interest 的加法（按位或）</span>
    <span class="token attribute attr-name">#[allow(clippy::should_implement_trait)]</span>
    <span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token keyword">fn</span> <span class="token function-definition function">add</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> other<span class="token punctuation">:</span> <span class="token class-name">Interest</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Interest</span> <span class="token punctuation">{</span>
        <span class="token class-name">Interest</span><span class="token punctuation">(</span><span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">NonZeroU8</span><span class="token punctuation">::</span><span class="token function">new_unchecked</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span> other<span class="token number">.0</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Interest 的减法</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">remove</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> other<span class="token punctuation">:</span> <span class="token class-name">Interest</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Interest</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token class-name">NonZeroU8</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">!</span>other<span class="token number">.0</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Interest</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 判断是否可读/可写</span>
    <span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token keyword">fn</span> <span class="token function-definition function">is_readable</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token constant">READABLE</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token keyword">fn</span> <span class="token function-definition function">is_writable</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token constant">WRITABLE</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>接下来继续看 <a href="https://github.com/tokio-rs/mio/blob/v0.7.5/src/event/event.rs"><code>event.rs</code></a>，<code>Event</code> 是对内部结构体的透明封装：</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token punctuation">{</span>sys<span class="token punctuation">,</span> <span class="token class-name">Token</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 透明封装，保持一致的内存布局</span>
<span class="token attribute attr-name">#[repr(transparent)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Event</span> <span class="token punctuation">{</span>
    inner<span class="token punctuation">:</span> <span class="token namespace">sys<span class="token punctuation">::</span></span><span class="token class-name">Event</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Event</span> <span class="token punctuation">{</span>
    <span class="token comment">/// 返回事件对应的 Token</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">token</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Token</span> <span class="token punctuation">{</span>
        <span class="token namespace">sys<span class="token punctuation">::</span>event<span class="token punctuation">::</span></span><span class="token function">token</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// 在 sys::event 之上的接口封装</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">is_readable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token namespace">sys<span class="token punctuation">::</span>event<span class="token punctuation">::</span></span><span class="token function">is_readable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">is_writable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token namespace">sys<span class="token punctuation">::</span>event<span class="token punctuation">::</span></span><span class="token function">is_writable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">is_error</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token namespace">sys<span class="token punctuation">::</span>event<span class="token punctuation">::</span></span><span class="token function">is_error</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

  	<span class="token punctuation">...</span>
  
    <span class="token comment">/// 将 sys::Event 转为 Event 对象</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">from_sys_event_ref</span><span class="token punctuation">(</span>sys_event<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">sys<span class="token punctuation">::</span></span><span class="token class-name">Event</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token class-name">Event</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
            <span class="token comment">// 由于内存布局一致，直接强转</span>
            <span class="token operator">&amp;</span><span class="token operator">*</span><span class="token punctuation">(</span>sys_event <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token namespace">sys<span class="token punctuation">::</span></span><span class="token class-name">Event</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token class-name">Event</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>继续看 <a href="https://github.com/tokio-rs/mio/blob/v0.7.5/src/event/events.rs"><code>events.rs</code></a> 的实现。与 <code>Event</code> 类似，同样是对内部结构体的封装。这里学习一下迭代器的实现，其中 <code>'a</code> 是生命周期标志。</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>event<span class="token punctuation">::</span></span><span class="token class-name">Event</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>sys</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Events</span> <span class="token punctuation">{</span>
    inner<span class="token punctuation">:</span> <span class="token namespace">sys<span class="token punctuation">::</span></span><span class="token class-name">Events</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[derive(Debug, Clone)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Iter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">{</span>
    inner<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Events</span><span class="token punctuation">,</span>
    pos<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Events</span> <span class="token punctuation">{</span>
    <span class="token comment">/// 创建一个指定容量的事件列表</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">with_capacity</span><span class="token punctuation">(</span>capacity<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Events</span> <span class="token punctuation">{</span>
        <span class="token class-name">Events</span> <span class="token punctuation">{</span>
            inner<span class="token punctuation">:</span> <span class="token namespace">sys<span class="token punctuation">::</span></span><span class="token class-name">Events</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>capacity<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// 返回迭代器</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">iter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Iter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token class-name">Iter</span> <span class="token punctuation">{</span>
            inner<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
            pos<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// 清理事件列表，可供下次 Poll 使用</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">clear</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Returns the inner `sys::Events`.</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">sys</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token namespace">sys<span class="token punctuation">::</span></span><span class="token class-name">Events</span> <span class="token punctuation">{</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">.</span>inner
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token class-name">IntoIterator</span> <span class="token keyword">for</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Events</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Item</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Event</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">IntoIter</span> <span class="token operator">=</span> <span class="token class-name">Iter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">into_iter</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">IntoIter</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token class-name">Iterator</span> <span class="token keyword">for</span> <span class="token class-name">Iter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Item</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Event</span><span class="token punctuation">;</span>

    <span class="token comment">// 迭代器的下一个，就是事件列表中的下一项</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">next</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Item</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token keyword">self</span>
            <span class="token punctuation">.</span>inner
            <span class="token punctuation">.</span>inner
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>pos<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Event</span><span class="token punctuation">::</span>from_sys_event_ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>pos <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        ret
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>现在可以继续看一下内部究竟是如何实现的。首先看 Linux 系统下对 epoll 的封装 <a href="https://github.com/tokio-rs/mio/blob/v0.7.5/src/sys/unix/selector/epoll.rs"><code>epoll.rs</code></a>：</p>
<pre class="language-rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Selector</span> <span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[cfg(debug_assertions)]</span>
    id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    ep<span class="token punctuation">:</span> <span class="token class-name">RawFd</span><span class="token punctuation">,</span>
    <span class="token attribute attr-name">#[cfg(debug_assertions)]</span>
    has_waker<span class="token punctuation">:</span> <span class="token class-name">AtomicBool</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Selector</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Selector</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token macro property">syscall!</span><span class="token punctuation">(</span><span class="token function">epoll_create1</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>ep<span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">Selector</span> <span class="token punctuation">{</span>
            <span class="token attribute attr-name">#[cfg(debug_assertions)]</span>
            id<span class="token punctuation">:</span> <span class="token constant">NEXT_ID</span><span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            ep<span class="token punctuation">,</span>
            <span class="token attribute attr-name">#[cfg(debug_assertions)]</span>
            has_waker<span class="token punctuation">:</span> <span class="token class-name">AtomicBool</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">select</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> events<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Events</span><span class="token punctuation">,</span> timeout<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Duration</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token attribute attr-name">#[cfg(target_pointer_width = <span class="token string">"32"</span>)]</span>
        <span class="token keyword">const</span> <span class="token constant">MAX_SAFE_TIMEOUT</span><span class="token punctuation">:</span> <span class="token keyword">u128</span> <span class="token operator">=</span> <span class="token number">1789569</span><span class="token punctuation">;</span>
        <span class="token attribute attr-name">#[cfg(not(target_pointer_width = <span class="token string">"32"</span>))]</span>
        <span class="token keyword">const</span> <span class="token constant">MAX_SAFE_TIMEOUT</span><span class="token punctuation">:</span> <span class="token keyword">u128</span> <span class="token operator">=</span> <span class="token namespace">libc<span class="token punctuation">::</span>c_int<span class="token punctuation">::</span></span><span class="token function">max_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u128</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> timeout <span class="token operator">=</span> timeout
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>to<span class="token closure-punctuation punctuation">|</span></span> <span class="token namespace">cmp<span class="token punctuation">::</span></span><span class="token function">min</span><span class="token punctuation">(</span>to<span class="token punctuation">.</span><span class="token function">as_millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">MAX_SAFE_TIMEOUT</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">libc<span class="token punctuation">::</span></span>c_int<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">unwrap_or</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        events<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">syscall!</span><span class="token punctuation">(</span><span class="token function">epoll_wait</span><span class="token punctuation">(</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>ep<span class="token punctuation">,</span>
            events<span class="token punctuation">.</span><span class="token function">as_mut_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            events<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
            timeout<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>n_events<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token comment">// This is safe because `epoll_wait` ensures that `n_events` are</span>
            <span class="token comment">// assigned.</span>
            <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> events<span class="token punctuation">.</span><span class="token function">set_len</span><span class="token punctuation">(</span>n_events <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> fd<span class="token punctuation">:</span> <span class="token class-name">RawFd</span><span class="token punctuation">,</span> token<span class="token punctuation">:</span> <span class="token class-name">Token</span><span class="token punctuation">,</span> interests<span class="token punctuation">:</span> <span class="token class-name">Interest</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment">// 注册时将 Interest 和 Token 转为 epoll_event 对象</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> event <span class="token operator">=</span> <span class="token namespace">libc<span class="token punctuation">::</span></span>epoll_event <span class="token punctuation">{</span>
            events<span class="token punctuation">:</span> <span class="token function">interests_to_epoll</span><span class="token punctuation">(</span>interests<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">u64</span><span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token macro property">syscall!</span><span class="token punctuation">(</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>ep<span class="token punctuation">,</span> <span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token constant">EPOLL_CTL_ADD</span><span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<p>这里的 <code>Selector</code> 就是对 <code>epoll</code> 调用的封装。接着看事件的实现，先前提到的 <code>sys.Event</code> 直接使用了 <code>libc::epoll_event</code>，<code>sys.Events</code> 则是 <code>Vec&lt;sys.Event&gt;</code>。</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">interests_to_epoll</span><span class="token punctuation">(</span>interests<span class="token punctuation">:</span> <span class="token class-name">Interest</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">u32</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> kind <span class="token operator">=</span> <span class="token constant">EPOLLET</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> interests<span class="token punctuation">.</span><span class="token function">is_readable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        kind <span class="token operator">=</span> kind <span class="token operator">|</span> <span class="token constant">EPOLLIN</span> <span class="token operator">|</span> <span class="token constant">EPOLLRDHUP</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> interests<span class="token punctuation">.</span><span class="token function">is_writable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        kind <span class="token operator">|=</span> <span class="token constant">EPOLLOUT</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    kind <span class="token keyword">as</span> <span class="token keyword">u32</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">type</span> <span class="token class-name">Event</span> <span class="token operator">=</span> <span class="token namespace">libc<span class="token punctuation">::</span></span>epoll_event<span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">type</span> <span class="token class-name">Events</span> <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Event</span><span class="token operator">></span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">mod</span> <span class="token module-declaration namespace">event</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>fmt<span class="token punctuation">;</span>

    <span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>sys<span class="token punctuation">::</span></span><span class="token class-name">Event</span><span class="token punctuation">;</span>
    <span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">Token</span><span class="token punctuation">;</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">token</span><span class="token punctuation">(</span>event<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Event</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Token</span> <span class="token punctuation">{</span>
        <span class="token class-name">Token</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token keyword">u64</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">is_readable</span><span class="token punctuation">(</span>event<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Event</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span>event<span class="token punctuation">.</span>events <span class="token keyword">as</span> <span class="token namespace">libc<span class="token punctuation">::</span></span>c_int <span class="token operator">&amp;</span> <span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token constant">EPOLLIN</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
            <span class="token operator">||</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>events <span class="token keyword">as</span> <span class="token namespace">libc<span class="token punctuation">::</span></span>c_int <span class="token operator">&amp;</span> <span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token constant">EPOLLPRI</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">is_writable</span><span class="token punctuation">(</span>event<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Event</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span>event<span class="token punctuation">.</span>events <span class="token keyword">as</span> <span class="token namespace">libc<span class="token punctuation">::</span></span>c_int <span class="token operator">&amp;</span> <span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token constant">EPOLLOUT</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">is_error</span><span class="token punctuation">(</span>event<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Event</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span>event<span class="token punctuation">.</span>events <span class="token keyword">as</span> <span class="token namespace">libc<span class="token punctuation">::</span></span>c_int <span class="token operator">&amp;</span> <span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token constant">EPOLLERR</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="3.-socket-封装" tabindex="-1"><a href="#3.-socket-%E5%B0%81%E8%A3%85">3. Socket 封装</a></h3>
<p>Poll 的逻辑看完了，接着来看 Socket 相关的封装，这里主要看 TCP 的实现。<code>src/net/tcp</code> 下方按照功能划分了三个类 <code>TcpSocket</code>/ <code>TcpListener</code>/ <code>TcpStream</code>，首先看 <a href="https://github.com/tokio-rs/mio/blob/v0.7.5/src/net/tcp/socket.rs"><code>socket.rs</code></a>：</p>
<pre class="language-rust"><code class="language-rust"><span class="token comment">/// 非阻塞 TCP 连接，用以创建 `TcpListener` 或者 `TcpStream`</span>
<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">TcpSocket</span> <span class="token punctuation">{</span>
    sys<span class="token punctuation">:</span> <span class="token namespace">sys<span class="token punctuation">::</span>tcp<span class="token punctuation">::</span></span><span class="token class-name">TcpSocket</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">TcpSocket</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Create a new IPv4 TCP socket.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new_v4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">TcpSocket</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token namespace">sys<span class="token punctuation">::</span>tcp<span class="token punctuation">::</span></span><span class="token function">new_v4_socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>sys<span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">TcpSocket</span> <span class="token punctuation">{</span>
            sys
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Connect the socket to `addr`.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">connect</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> addr<span class="token punctuation">:</span> <span class="token class-name">SocketAddr</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">TcpStream</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> stream <span class="token operator">=</span> <span class="token namespace">sys<span class="token punctuation">::</span>tcp<span class="token punctuation">::</span></span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>sys<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token comment">// Don't close the socket</span>
        <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">forget</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">TcpStream</span><span class="token punctuation">::</span><span class="token function">from_std</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Listen for inbound connections, converting the socket to a</span>
    <span class="token comment">/// `TcpListener`.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">listen</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> backlog<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">TcpListener</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> listener <span class="token operator">=</span> <span class="token namespace">sys<span class="token punctuation">::</span>tcp<span class="token punctuation">::</span></span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>sys<span class="token punctuation">,</span> backlog<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token comment">// Don't close the socket</span>
        <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">forget</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">TcpListener</span><span class="token punctuation">::</span><span class="token function">from_std</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Drop</span> <span class="token keyword">for</span> <span class="token class-name">TcpSocket</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">drop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token namespace">sys<span class="token punctuation">::</span>tcp<span class="token punctuation">::</span></span><span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>sys<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这里需要注意 <a href="https://doc.rust-lang.org/std/mem/fn.forget.html"><code>mem::forget</code></a> 的使用，<code>connect</code> 和 <code>listen</code> 的内部实现中会将 <code>self.sys</code> 的所有权转移到 <code>TcpStream</code> 和 <code>TpcListener</code> 上，以保证在 <code>TpcSocket</code> 析构时不会关闭对应的连接。接着看 <code>TcpListener</code> 和 <code>TcpStream</code> 的实现：</p>
<pre class="language-rust"><code class="language-rust"><span class="token comment">// 对标准库中的 TcpListener 的封装</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">TcpListener</span> <span class="token punctuation">{</span>
    inner<span class="token punctuation">:</span> <span class="token class-name">IoSource</span><span class="token operator">&lt;</span><span class="token namespace">net<span class="token punctuation">::</span></span><span class="token class-name">TcpListener</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">TcpListener</span> <span class="token punctuation">{</span>
    <span class="token comment">/// 绑定指定地址，返回 TcpListener 对象</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">bind</span><span class="token punctuation">(</span>addr<span class="token punctuation">:</span> <span class="token class-name">SocketAddr</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">TcpListener</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> socket <span class="token operator">=</span> <span class="token class-name">TcpSocket</span><span class="token punctuation">::</span><span class="token function">new_for_addr</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token attribute attr-name">#[cfg(not(windows))]</span>
        socket<span class="token punctuation">.</span><span class="token function">set_reuseaddr</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        socket<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        socket<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// 将 net::TcpListener 封装为 TcpListener</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">from_std</span><span class="token punctuation">(</span>listener<span class="token punctuation">:</span> <span class="token namespace">net<span class="token punctuation">::</span></span><span class="token class-name">TcpListener</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">TcpListener</span> <span class="token punctuation">{</span>
        <span class="token class-name">TcpListener</span> <span class="token punctuation">{</span>
            inner<span class="token punctuation">:</span> <span class="token class-name">IoSource</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 接收来自 Client 的连接，返回 TcpStream 对象</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">accept</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token class-name">TcpStream</span><span class="token punctuation">,</span> <span class="token class-name">SocketAddr</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">.</span><span class="token function">do_io</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>inner<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token namespace">sys<span class="token punctuation">::</span>tcp<span class="token punctuation">::</span></span><span class="token function">accept</span><span class="token punctuation">(</span>inner<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">(</span><span class="token class-name">TcpStream</span><span class="token punctuation">::</span><span class="token function">from_std</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 实现 event::Source 接口</span>
<span class="token keyword">impl</span> <span class="token namespace">event<span class="token punctuation">::</span></span><span class="token class-name">Source</span> <span class="token keyword">for</span> <span class="token class-name">TcpListener</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">register</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        registry<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Registry</span><span class="token punctuation">,</span>
        token<span class="token punctuation">:</span> <span class="token class-name">Token</span><span class="token punctuation">,</span>
        interests<span class="token punctuation">:</span> <span class="token class-name">Interest</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> token<span class="token punctuation">,</span> interests<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">reregister</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        registry<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Registry</span><span class="token punctuation">,</span>
        token<span class="token punctuation">:</span> <span class="token class-name">Token</span><span class="token punctuation">,</span>
        interests<span class="token punctuation">:</span> <span class="token class-name">Interest</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">.</span><span class="token function">reregister</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> token<span class="token punctuation">,</span> interests<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">deregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> registry<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Registry</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">.</span><span class="token function">deregister</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[cfg(unix)]</span>
<span class="token keyword">impl</span> <span class="token class-name">FromRawFd</span> <span class="token keyword">for</span> <span class="token class-name">TcpListener</span> <span class="token punctuation">{</span>
    <span class="token comment">// 从 fd 转为 net::TcpListener 再转为 TcpListener</span>
    <span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function-definition function">from_raw_fd</span><span class="token punctuation">(</span>fd<span class="token punctuation">:</span> <span class="token class-name">RawFd</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">TcpListener</span> <span class="token punctuation">{</span>
        <span class="token class-name">TcpListener</span><span class="token punctuation">::</span><span class="token function">from_std</span><span class="token punctuation">(</span><span class="token class-name">FromRawFd</span><span class="token punctuation">::</span><span class="token function">from_raw_fd</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">/// A non-blocking TCP stream between a local socket and a remote socket.</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">TcpStream</span> <span class="token punctuation">{</span>
    inner<span class="token punctuation">:</span> <span class="token class-name">IoSource</span><span class="token operator">&lt;</span><span class="token namespace">net<span class="token punctuation">::</span></span><span class="token class-name">TcpStream</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">TcpStream</span> <span class="token punctuation">{</span>
    <span class="token comment">/// 连接指定地址，返回 TcpStream 对象</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">connect</span><span class="token punctuation">(</span>addr<span class="token punctuation">:</span> <span class="token class-name">SocketAddr</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">TcpStream</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> socket <span class="token operator">=</span> <span class="token class-name">TcpSocket</span><span class="token punctuation">::</span><span class="token function">new_for_addr</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        socket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

  	<span class="token comment">/// 将标准库中的 net::TcpStream 封装为 TcpStream</span>
  	<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">from_std</span><span class="token punctuation">(</span>stream<span class="token punctuation">:</span> <span class="token namespace">net<span class="token punctuation">::</span></span><span class="token class-name">TcpStream</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">TcpStream</span> <span class="token punctuation">{</span>
        <span class="token class-name">TcpStream</span> <span class="token punctuation">{</span>
            inner<span class="token punctuation">:</span> <span class="token class-name">IoSource</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// 实现读取接口</span>
<span class="token keyword">impl</span> <span class="token class-name">Read</span> <span class="token keyword">for</span> <span class="token class-name">TcpStream</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">.</span><span class="token function">do_io</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>inner<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token operator">*</span>inner<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">read_vectored</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> bufs<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token class-name">IoSliceMut</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">.</span><span class="token function">do_io</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>inner<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token operator">*</span>inner<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read_vectored</span><span class="token punctuation">(</span>bufs<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">...</span>
</code></pre>
<p><code>IoSource</code> 和 <code>event::Source</code> 的定义位于 <a href="https://github.com/tokio-rs/mio/blob/v0.7.5/src/io_source.rs"><code>io_source.rs</code></a>：</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">IoSource</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
    state<span class="token punctuation">:</span> <span class="token class-name">IoSourceState</span><span class="token punctuation">,</span>
    inner<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">,</span>
    <span class="token attribute attr-name">#[cfg(debug_assertions)]</span>
    selector_id<span class="token punctuation">:</span> <span class="token class-name">SelectorId</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token class-name">IoSource</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment">/// Create a new `IoSource`.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>io<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">IoSource</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token class-name">IoSource</span> <span class="token punctuation">{</span>
            state<span class="token punctuation">:</span> <span class="token class-name">IoSourceState</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            inner<span class="token punctuation">:</span> io<span class="token punctuation">,</span>
            <span class="token attribute attr-name">#[cfg(debug_assertions)]</span>
            selector_id<span class="token punctuation">:</span> <span class="token class-name">SelectorId</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Windows 下需要多做一次转换，其他系统等价 f(&amp;self.inner)</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">do_io</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">></span>
    <span class="token keyword">where</span>
        <span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">do_io</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Returns the I/O source, dropping the state.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">into_inner</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">T</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>inner
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[cfg(unix)]</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token namespace">event<span class="token punctuation">::</span></span><span class="token class-name">Source</span> <span class="token keyword">for</span> <span class="token class-name">IoSource</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">where</span>
    <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">AsRawFd</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">register</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        registry<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Registry</span><span class="token punctuation">,</span>
        token<span class="token punctuation">:</span> <span class="token class-name">Token</span><span class="token punctuation">,</span>
        interests<span class="token punctuation">:</span> <span class="token class-name">Interest</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token attribute attr-name">#[cfg(debug_assertions)]</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>selector_id<span class="token punctuation">.</span><span class="token function">associate</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token comment">// 通过 RawFd 注册</span>
        <span class="token namespace">poll<span class="token punctuation">::</span></span><span class="token function">selector</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">.</span><span class="token function">as_raw_fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> token<span class="token punctuation">,</span> interests<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">...</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Linux TCP 网络的具体实现放在 <code>src/sys/unix</code> 下 <a href="https://github.com/tokio-rs/mio/blob/v0.7.5/src/sys/unix/tcp.rs"><code>tcp.rs</code></a>，可以看到是对 Socket API 的简单封装：</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">type</span> <span class="token class-name">TcpSocket</span> <span class="token operator">=</span> <span class="token namespace">libc<span class="token punctuation">::</span></span>c_int<span class="token punctuation">;</span>

<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">bind</span><span class="token punctuation">(</span>socket<span class="token punctuation">:</span> <span class="token class-name">TcpSocket</span><span class="token punctuation">,</span> addr<span class="token punctuation">:</span> <span class="token class-name">SocketAddr</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>raw_addr<span class="token punctuation">,</span> raw_addr_length<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">socket_addr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">syscall!</span><span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> raw_addr<span class="token punctuation">,</span> raw_addr_length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">connect</span><span class="token punctuation">(</span>socket<span class="token punctuation">:</span> <span class="token class-name">TcpSocket</span><span class="token punctuation">,</span> addr<span class="token punctuation">:</span> <span class="token class-name">SocketAddr</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token namespace">net<span class="token punctuation">::</span></span><span class="token class-name">TcpStream</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>raw_addr<span class="token punctuation">,</span> raw_addr_length<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">socket_addr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">match</span> <span class="token macro property">syscall!</span><span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> raw_addr<span class="token punctuation">,</span> raw_addr_length<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">if</span> err<span class="token punctuation">.</span><span class="token function">raw_os_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token constant">EINPROGRESS</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        _ <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token namespace">net<span class="token punctuation">::</span></span><span class="token class-name">TcpStream</span><span class="token punctuation">::</span><span class="token function">from_raw_fd</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">listen</span><span class="token punctuation">(</span>socket<span class="token punctuation">:</span> <span class="token class-name">TcpSocket</span><span class="token punctuation">,</span> backlog<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token namespace">net<span class="token punctuation">::</span></span><span class="token class-name">TcpListener</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>convert<span class="token punctuation">::</span></span><span class="token class-name">TryInto</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> backlog <span class="token operator">=</span> backlog<span class="token punctuation">.</span><span class="token function">try_into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap_or</span><span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">::</span><span class="token function">max_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">syscall!</span><span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> backlog<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token namespace">net<span class="token punctuation">::</span></span><span class="token class-name">TcpListener</span><span class="token punctuation">::</span><span class="token function">from_raw_fd</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">accept</span><span class="token punctuation">(</span>listener<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">net<span class="token punctuation">::</span></span><span class="token class-name">TcpListener</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token namespace">net<span class="token punctuation">::</span></span><span class="token class-name">TcpStream</span><span class="token punctuation">,</span> <span class="token class-name">SocketAddr</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> addr<span class="token punctuation">:</span> <span class="token class-name">MaybeUninit</span><span class="token operator">&lt;</span><span class="token namespace">libc<span class="token punctuation">::</span></span>sockaddr_storage<span class="token operator">></span> <span class="token operator">=</span> <span class="token class-name">MaybeUninit</span><span class="token punctuation">::</span><span class="token function">uninit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> length <span class="token operator">=</span> <span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token namespace">libc<span class="token punctuation">::</span></span>sockaddr_storage<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">libc<span class="token punctuation">::</span></span>socklen_t<span class="token punctuation">;</span>

    <span class="token keyword">let</span> stream <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token macro property">syscall!</span><span class="token punctuation">(</span><span class="token function">accept4</span><span class="token punctuation">(</span>
            listener<span class="token punctuation">.</span><span class="token function">as_raw_fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            addr<span class="token punctuation">.</span><span class="token function">as_mut_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> _<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span><span class="token keyword">mut</span> length<span class="token punctuation">,</span>
            <span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token constant">SOCK_CLOEXEC</span> <span class="token operator">|</span> <span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token constant">SOCK_NONBLOCK</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>socket<span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token namespace">net<span class="token punctuation">::</span></span><span class="token class-name">TcpStream</span><span class="token punctuation">::</span><span class="token function">from_raw_fd</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token comment">// This is safe because `accept` calls above ensures the address</span>
    <span class="token comment">// initialised.</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token function">to_socket_addr</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span><span class="token function">as_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>addr<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">(</span>stream<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="4.-总结" tabindex="-1"><a href="#4.-%E6%80%BB%E7%BB%93">4. 总结</a></h3>
<p>最近工作比较忙，很久没看代码、写博客，以至于朋友都来吐槽我不“勤劳”。Mio 的封装实现还是比较简单的，比较适合笔者这样的 Rust 初学者来学习。希望接下来把 Tokio 分模块学习完，过年的时候用 C++ 20 或者 Rust 实现一套 1:N 的协程运行时。</p>

      </div>
      <div id="gitalk-container">
      </div>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2017 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/gitalk.min.js"></script>
    <script src="/dist/main.js"></script>
    <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-61723712-2', 'auto'); ga('send', 'pageview'); </script>
  </body>
</html>
