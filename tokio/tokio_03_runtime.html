<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/gitalk.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>Tokio 源码分析「三、运行时 Runtime」 | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> Tokio 源码分析「三、运行时 Runtime」 </h1>
      </div>
      <div class="info">
        <div class="date"> 2021.04.25 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <p>Tokio 的核心是一套 M:N 的协程 Runtime，下层通过 Rust 协程和 Mio 驱动，支撑上层的 HTTP / RPC 应用。本篇开始分析 Runtime，代码版本 <a href="https://github.com/tokio-rs/tokio/tree/tokio-1.5.0">v1.5.0</a>。</p>
<figure tabindex="1"><a href="../images/5e364463cf50f41fec2e028df84f6a4a.svg"><img src="../images/5e364463cf50f41fec2e028df84f6a4a.svg" alt=""></a><figcaption>Tokio 架构图 from <a href="http://tokio.rs">tokio.rs</a></figcaption></figure>
<h3 id="1.-概览" tabindex="-1"><a href="#1.-%E6%A6%82%E8%A7%88">1. 概览</a></h3>
<p>在阅读核心代码前，先介绍一下异步编程中的核心关键字：</p>
<p><strong>Asynchrony</strong>：异步指事件的发生与主程序流及处理此类事件的方式无关。这些事件可能是像信号这样的外部事件，或者是由程序引发的动作，会和程序的执行同时发生，而程序不会阻塞地等待结果。简而言之，事件发生在非调用方的线程中。同步与异步关注的是事件是否是在本线程中处理。</p>
<p><strong>Non-blocking</strong>：非阻塞指执行的操作不会阻塞程序的继续执行。阻塞与非阻塞关注的是调用方等待结果时的状态。阻塞非阻塞和同步异步是正交的，即存在同步阻塞、同步非阻塞、异步阻塞、异步非阻塞。</p>
<p><strong>Resumable Function</strong>：可恢复函数指可以暂停执行并从调用中返回，并且可以在将来从暂停的位置恢复执行的函数。可恢复函数是协程的基石。</p>
<p><strong>Asynchronous Runtime</strong>：异步运行时，上述概念的整合，通过可恢复函数、挂起位置埋点和用户态调度实现非抢占式的用户态线程切换，称之为协程。一般将同步阻塞 IO 的位置作为默认的挂起位置。</p>
<p>Tokio 库的代码量十分巨大，<a href="https://github.com/tokio-rs/tokio/tree/tokio-1.5.0/tokio/src"><code>tokio/src</code></a> 目录下共计 256 个代码文件，行数 5w+。核心代码的文件结构为：</p>
<pre class="language-markup"><code class="language-markup">tokio/src
├── blocking.rs
├── coop.rs
├── fs
├── future
├── io
├── lib.rs
├── loom
├── macros
├── net
├── park
├── process
├── runtime
├── signal
├── sync
├── task
├── time
└── util
</code></pre>
<p>再来看官方提供的样例：</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">tokio<span class="token punctuation">::</span>net<span class="token punctuation">::</span></span><span class="token class-name">TcpListener</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">tokio<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">AsyncReadExt</span><span class="token punctuation">,</span> <span class="token class-name">AsyncWriteExt</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[tokio::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token namespace">std<span class="token punctuation">::</span>error<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token operator">>></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> listener <span class="token operator">=</span> <span class="token class-name">TcpListener</span><span class="token punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:8080"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> socket<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=</span> listener<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token namespace">tokio<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">move</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> buf <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token comment">// In a loop, read data from the socket and write the data back.</span>
            <span class="token keyword">loop</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> n <span class="token operator">=</span> <span class="token keyword">match</span> socket<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> buf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span> <span class="token punctuation">{</span>
                    <span class="token comment">// socket closed</span>
                    <span class="token class-name">Ok</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">=></span> <span class="token keyword">return</span><span class="token punctuation">,</span>
                    <span class="token class-name">Ok</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">=></span> n<span class="token punctuation">,</span>
                    <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                        <span class="token macro property">eprintln!</span><span class="token punctuation">(</span><span class="token string">"failed to read from socket; err = {:?}"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>

                <span class="token comment">// Write the data back</span>
                <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">..</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span> <span class="token punctuation">{</span>
                    <span class="token macro property">eprintln!</span><span class="token punctuation">(</span><span class="token string">"failed to write to socket; err = {:?}"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>如果之前接触过协程和网络编程，肯定会赞叹上方 Echo Server 的高效和简洁。</p>
<h3 id="2.-tokio/runtime/task" tabindex="-1"><a href="#2.-tokio%2Fruntime%2Ftask">2. <code>tokio/runtime/task</code></a></h3>
<p>Tokio 的 Runtime 提供以下能力：</p>
<blockquote>
<ul>
<li>An <strong>I/O event loop</strong>, called the driver, which drives I/O resources and dispatches I/O events to tasks that depend on them.</li>
<li>A <strong>scheduler</strong> to execute <a href="https://docs.rs/tokio/0.2.24/tokio/task/index.html">tasks</a> that use these I/O resources.</li>
<li>A <strong>timer</strong> for scheduling work to run after a set period of time.</li>
</ul>
</blockquote>
<p>这一节来看任务 <code>task</code> 相关的抽象，代码路径为 <a href="https://github.com/tokio-rs/tokio/tree/tokio-1.5.0/tokio/src/runtime/task">tokio/src/runtime/task</a>。先看任务状态 <a href="https://github.com/tokio-rs/tokio/blob/tokio-1.5.0/tokio/src/runtime/task/state.rs"><code>state.rs</code></a>：</p>
<pre class="language-rust"><code class="language-rust"><span class="token comment">// State 本身是原子无符号数</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">State</span> <span class="token punctuation">{</span>
    val<span class="token punctuation">:</span> <span class="token class-name">AtomicUsize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// Snapshot 是从 State 读取到的值</span>
<span class="token attribute attr-name">#[derive(Copy, Clone)]</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Snapshot</span><span class="token punctuation">(</span><span class="token keyword">usize</span><span class="token punctuation">)</span>

<span class="token comment">// 更新 State 时的 Result，成功返回更新后的 Snapshot</span>
<span class="token keyword">type</span> <span class="token type-definition class-name">UpdateResult</span> <span class="token operator">=</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Snapshot</span><span class="token punctuation">,</span> <span class="token class-name">Snapshot</span><span class="token operator">></span><span class="token punctuation">;</span>

<span class="token comment">// State 实际的编码，包括一个引用计数</span>
<span class="token keyword">const</span> <span class="token constant">RUNNING</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">0b0001</span><span class="token punctuation">;</span>       <span class="token comment">// 是否在运行</span>
<span class="token keyword">const</span> <span class="token constant">COMPLETE</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">0b0010</span><span class="token punctuation">;</span>      <span class="token comment">// 是否已完成</span>
<span class="token keyword">const</span> <span class="token constant">LIFECYCLE_MASK</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">0b11</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">NOTIFIED</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">0b100</span><span class="token punctuation">;</span>       <span class="token comment">// task 是否已经加入运行队列</span>
<span class="token keyword">const</span> <span class="token constant">JOIN_INTEREST</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">0b1_000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">JOIN_WAKER</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">0b10_000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">CANCELLED</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">0b100_000</span><span class="token punctuation">;</span>  <span class="token comment">// 任务被取消</span>
<span class="token keyword">const</span> <span class="token constant">STATE_MASK</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token constant">LIFECYCLE_MASK</span> <span class="token operator">|</span> <span class="token constant">NOTIFIED</span> <span class="token operator">|</span> <span class="token constant">JOIN_INTEREST</span> <span class="token operator">|</span> <span class="token constant">JOIN_WAKER</span> <span class="token operator">|</span> <span class="token constant">CANCELLED</span><span class="token punctuation">;</span>  <span class="token comment">// 所有状态相关的位</span>

<span class="token keyword">const</span> <span class="token constant">REF_COUNT_MASK</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token operator">!</span><span class="token constant">STATE_MASK</span><span class="token punctuation">;</span>   <span class="token comment">// 引用计数使用的位</span>
<span class="token keyword">const</span> <span class="token constant">REF_COUNT_SHIFT</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token constant">REF_COUNT_MASK</span><span class="token punctuation">.</span><span class="token function">count_zeros</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">REF_ONE</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">REF_COUNT_SHIFT</span><span class="token punctuation">;</span>  <span class="token comment">// 引用计数中的 1</span>

<span class="token keyword">const</span> <span class="token constant">INITIAL_STATE</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">REF_ONE</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token constant">JOIN_INTEREST</span> <span class="token operator">|</span> <span class="token constant">NOTIFIED</span><span class="token punctuation">;</span>  <span class="token comment">// 初始化状态，scheduler 和 `JoinHandle` 会引用它</span>

<span class="token keyword">impl</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">State</span> <span class="token punctuation">{</span>
        <span class="token class-name">State</span> <span class="token punctuation">{</span>
            val<span class="token punctuation">:</span> <span class="token class-name">AtomicUsize</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token constant">INITIAL_STATE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 读取当前的状态，使用 Acquire Ordering</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Snapshot</span> <span class="token punctuation">{</span>
        <span class="token class-name">Snapshot</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>val<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Acquire</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 使用 CAS 实现线程安全的状态转移，转移失败时返回当前的状态</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">fetch_update</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token keyword">mut</span> f<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Snapshot</span><span class="token punctuation">,</span> <span class="token class-name">Snapshot</span><span class="token operator">></span>
    <span class="token keyword">where</span>
        <span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">FnMut</span><span class="token punctuation">(</span><span class="token class-name">Snapshot</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Snapshot</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> curr <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">loop</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> next <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token function">f</span><span class="token punctuation">(</span>curr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Some</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token operator">=></span> next<span class="token punctuation">,</span>
                <span class="token class-name">None</span> <span class="token operator">=></span> <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span>curr<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>val<span class="token punctuation">.</span><span class="token function">compare_exchange</span><span class="token punctuation">(</span>curr<span class="token number">.0</span><span class="token punctuation">,</span> next<span class="token number">.0</span><span class="token punctuation">,</span> <span class="token class-name">AcqRel</span><span class="token punctuation">,</span> <span class="token class-name">Acquire</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">match</span> res <span class="token punctuation">{</span>
                <span class="token class-name">Ok</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">Err</span><span class="token punctuation">(</span>actual<span class="token punctuation">)</span> <span class="token operator">=></span> curr <span class="token operator">=</span> <span class="token class-name">Snapshot</span><span class="token punctuation">(</span>actual<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 尝试转移到 running 状态</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">transition_to_running</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> ref_inc<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">UpdateResult</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">fetch_update</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>curr<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token macro property">assert!</span><span class="token punctuation">(</span>curr<span class="token punctuation">.</span><span class="token function">is_notified</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">let</span> <span class="token keyword">mut</span> next <span class="token operator">=</span> curr<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token operator">!</span>next<span class="token punctuation">.</span><span class="token function">is_idle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">None</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> ref_inc <span class="token punctuation">{</span>
                next<span class="token punctuation">.</span><span class="token function">ref_inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            next<span class="token punctuation">.</span><span class="token function">set_running</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            next<span class="token punctuation">.</span><span class="token function">unset_notified</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Some</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 增加引用计数</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">ref_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>process<span class="token punctuation">;</span>
        <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span>atomic<span class="token punctuation">::</span></span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> prev <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>val<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token constant">REF_ONE</span><span class="token punctuation">,</span> <span class="token class-name">Relaxed</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// If the reference count overflowed, abort.</span>
        <span class="token keyword">if</span> prev <span class="token operator">></span> <span class="token keyword">isize</span><span class="token punctuation">::</span><span class="token function">max_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">usize</span> <span class="token punctuation">{</span>
            <span class="token namespace">process<span class="token punctuation">::</span></span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Snapshot 提供状态读写的街口</span>
<span class="token keyword">impl</span> <span class="token class-name">Snapshot</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">is_running</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token operator">&amp;</span> <span class="token constant">RUNNING</span> <span class="token operator">==</span> <span class="token constant">RUNNING</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">set_running</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token operator">|=</span> <span class="token constant">RUNNING</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">...</span>
<span class="token punctuation">}</span>
</code></pre>
<p>再来看 <code>task</code> 的核心数据结构 <a href="https://github.com/tokio-rs/tokio/blob/tokio-1.5.0/tokio/src/runtime/task/core.rs"><code>core.rs</code></a>：</p>
<pre class="language-rust"><code class="language-rust"><span class="token comment">// Task Cell，包含任务相关的元数据，注意这里的 #[repr(C)] 标识</span>
<span class="token comment">// 其中 header 必须放在第一个字段，因为会有 Header 指针转 Cell 指针的操作</span>
<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Cell</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Future</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment">/// Hot task state data</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> header<span class="token punctuation">:</span> <span class="token class-name">Header</span><span class="token punctuation">,</span>

    <span class="token comment">/// Either the future or output, depending on the execution stage.</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> core<span class="token punctuation">:</span> <span class="token class-name">Core</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span><span class="token punctuation">,</span>

    <span class="token comment">/// Cold data</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> trailer<span class="token punctuation">:</span> <span class="token class-name">Trailer</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// Task 的头部，包含任务的状态 state，其他字段后续遇到的时候在看</span>
<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Header</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Task state</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> state<span class="token punctuation">:</span> <span class="token class-name">State</span><span class="token punctuation">,</span>

    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> owned<span class="token punctuation">:</span> <span class="token class-name">UnsafeCell</span><span class="token operator">&lt;</span><span class="token namespace">linked_list<span class="token punctuation">::</span></span><span class="token class-name">Pointers</span><span class="token operator">&lt;</span><span class="token class-name">Header</span><span class="token operator">>></span><span class="token punctuation">,</span>

    <span class="token comment">/// Pointer to next task, used with the injection queue</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> queue_next<span class="token punctuation">:</span> <span class="token class-name">UnsafeCell</span><span class="token operator">&lt;</span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">NonNull</span><span class="token operator">&lt;</span><span class="token class-name">Header</span><span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">,</span>

    <span class="token comment">/// Pointer to the next task in the transfer stack</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> stack_next<span class="token punctuation">:</span> <span class="token class-name">UnsafeCell</span><span class="token operator">&lt;</span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">NonNull</span><span class="token operator">&lt;</span><span class="token class-name">Header</span><span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">,</span>

    <span class="token comment">/// Table of function pointers for executing actions on the task.</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> vtable<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token class-name">Vtable</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Scheduler</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">></span> <span class="token punctuation">{</span>
    scheduler<span class="token punctuation">:</span> <span class="token class-name">UnsafeCell</span><span class="token operator">&lt;</span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">>></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">CoreStage</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Future</span><span class="token operator">></span> <span class="token punctuation">{</span>
    stage<span class="token punctuation">:</span> <span class="token class-name">UnsafeCell</span><span class="token operator">&lt;</span><span class="token class-name">Stage</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">>></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// Task 的核心部分</span>
<span class="token comment">// scheduler 表示绑定的调度器</span>
<span class="token comment">// stage 表示 future 或者输出的结果</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Core</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Future</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment">/// Scheduler used to drive this future</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> scheduler<span class="token punctuation">:</span> <span class="token class-name">Scheduler</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">></span><span class="token punctuation">,</span>

    <span class="token comment">/// Either the future or the output</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> stage<span class="token punctuation">:</span> <span class="token class-name">CoreStage</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token comment">// stage 的具体定义，三种状态，Consumed 表示数据已经被消费掉不可再用</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Stage</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Future</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token class-name">Running</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Finished</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">::</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Consumed</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// Task 的尾部，包含一个 waker 指针</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Trailer</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Consumer task waiting on completion of this task.</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> waker<span class="token punctuation">:</span> <span class="token class-name">UnsafeCell</span><span class="token operator">&lt;</span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Waker</span><span class="token operator">>></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// 给定 future 和 state，构造一个 cell 对象</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Future</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Schedule</span><span class="token operator">></span> <span class="token class-name">Cell</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment">/// Allocates a new task cell, containing the header, trailer, and core</span>
    <span class="token comment">/// structures.</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>future<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">,</span> state<span class="token punctuation">:</span> <span class="token class-name">State</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Cell</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">>></span> <span class="token punctuation">{</span>
        <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Cell</span> <span class="token punctuation">{</span>
            header<span class="token punctuation">:</span> <span class="token class-name">Header</span> <span class="token punctuation">{</span>
                state<span class="token punctuation">,</span>
                owned<span class="token punctuation">:</span> <span class="token class-name">UnsafeCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token namespace">linked_list<span class="token punctuation">::</span></span><span class="token class-name">Pointers</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                queue_next<span class="token punctuation">:</span> <span class="token class-name">UnsafeCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                stack_next<span class="token punctuation">:</span> <span class="token class-name">UnsafeCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                vtable<span class="token punctuation">:</span> <span class="token namespace">raw<span class="token punctuation">::</span></span><span class="token function">vtable</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            core<span class="token punctuation">:</span> <span class="token class-name">Core</span> <span class="token punctuation">{</span>
                scheduler<span class="token punctuation">:</span> <span class="token class-name">Scheduler</span> <span class="token punctuation">{</span>
                    scheduler<span class="token punctuation">:</span> <span class="token class-name">UnsafeCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                stage<span class="token punctuation">:</span> <span class="token class-name">CoreStage</span> <span class="token punctuation">{</span>
                    stage<span class="token punctuation">:</span> <span class="token class-name">UnsafeCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token class-name">Running</span><span class="token punctuation">(</span>future<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            trailer<span class="token punctuation">:</span> <span class="token class-name">Trailer</span> <span class="token punctuation">{</span>
                waker<span class="token punctuation">:</span> <span class="token class-name">UnsafeCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><a href="https://github.com/tokio-rs/tokio/blob/tokio-1.5.0/tokio/src/runtime/task/core.rs"><code>core.rs</code></a> 中还有 Cell 相关函数的实现，暂时跳过，来看下 <a href="https://github.com/tokio-rs/tokio/blob/tokio-1.5.0/tokio/src/runtime/task/raw.rs"><code>raw.rs</code></a>：</p>
<pre class="language-rust"><code class="language-rust"><span class="token comment">// RawTask，本质是指向 Cell 的指针</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">RawTask</span> <span class="token punctuation">{</span>
    ptr<span class="token punctuation">:</span> <span class="token class-name">NonNull</span><span class="token operator">&lt;</span><span class="token class-name">Header</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// 手动构建的虚表，Header.vtable 中有调用</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Vtable</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Poll the future</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> poll<span class="token punctuation">:</span> <span class="token keyword">unsafe</span> <span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token class-name">NonNull</span><span class="token operator">&lt;</span><span class="token class-name">Header</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Deallocate the memory</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> dealloc<span class="token punctuation">:</span> <span class="token keyword">unsafe</span> <span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token class-name">NonNull</span><span class="token operator">&lt;</span><span class="token class-name">Header</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Read the task output, if complete</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> try_read_output<span class="token punctuation">:</span> <span class="token keyword">unsafe</span> <span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token class-name">NonNull</span><span class="token operator">&lt;</span><span class="token class-name">Header</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token keyword">mut</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token class-name">Waker</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// The join handle has been dropped</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> drop_join_handle_slow<span class="token punctuation">:</span> <span class="token keyword">unsafe</span> <span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token class-name">NonNull</span><span class="token operator">&lt;</span><span class="token class-name">Header</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/// Scheduler is being shutdown</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> shutdown<span class="token punctuation">:</span> <span class="token keyword">unsafe</span> <span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token class-name">NonNull</span><span class="token operator">&lt;</span><span class="token class-name">Header</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// 返回一个静态的虚表</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">vtable</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Future</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Schedule</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token class-name">Vtable</span> <span class="token punctuation">{</span>
    <span class="token operator">&amp;</span><span class="token class-name">Vtable</span> <span class="token punctuation">{</span>
        poll<span class="token punctuation">:</span> <span class="token function">poll</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span><span class="token punctuation">,</span>
        dealloc<span class="token punctuation">:</span> <span class="token function">dealloc</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span><span class="token punctuation">,</span>
        try_read_output<span class="token punctuation">:</span> <span class="token function">try_read_output</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span><span class="token punctuation">,</span>
        drop_join_handle_slow<span class="token punctuation">:</span> <span class="token function">drop_join_handle_slow</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span><span class="token punctuation">,</span>
        shutdown<span class="token punctuation">:</span> <span class="token function">shutdown</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 虚表指向的函数，实际上会调用 Harness 中的实现</span>
<span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function-definition function">poll</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Future</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Schedule</span><span class="token operator">></span><span class="token punctuation">(</span>ptr<span class="token punctuation">:</span> <span class="token class-name">NonNull</span><span class="token operator">&lt;</span><span class="token class-name">Header</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> harness <span class="token operator">=</span> <span class="token class-name">Harness</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">from_raw</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    harness<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>顺着这个思路，继续看 <a href="https://github.com/tokio-rs/tokio/blob/tokio-1.5.0/tokio/src/runtime/task/harness.rs"><code>harness.rs</code></a>：</p>
<pre class="language-rust"><code class="language-rust"><span class="token comment">// Harness，是一个指向 Cell 对象的非空指针</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Harness</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Future</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token lifetime-annotation symbol">'static</span><span class="token operator">></span> <span class="token punctuation">{</span>
    cell<span class="token punctuation">:</span> <span class="token class-name">NonNull</span><span class="token operator">&lt;</span><span class="token class-name">Cell</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">>></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// 从 Header 指针转为 Cell 指针，从而可以使用 header / trailer / core 对象</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span> <span class="token class-name">Harness</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span>
<span class="token keyword">where</span>
    <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Future</span><span class="token punctuation">,</span>
    <span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token lifetime-annotation symbol">'static</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function-definition function">from_raw</span><span class="token punctuation">(</span>ptr<span class="token punctuation">:</span> <span class="token class-name">NonNull</span><span class="token operator">&lt;</span><span class="token class-name">Header</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Harness</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token class-name">Harness</span> <span class="token punctuation">{</span>
            cell<span class="token punctuation">:</span> ptr<span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Cell</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">header</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token class-name">Header</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>cell<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">trailer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token class-name">Trailer</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>cell<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trailer <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">core</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token class-name">Core</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>cell<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>core <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// poll 操作的结果</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">PollFuture</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token class-name">Complete</span><span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">JoinError</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">DropReference</span><span class="token punctuation">,</span>
    <span class="token class-name">Notified</span><span class="token punctuation">,</span>
    <span class="token class-name">None</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// poll 的实现</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span> <span class="token class-name">Harness</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span>
<span class="token keyword">where</span>
    <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Future</span><span class="token punctuation">,</span>
    <span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Schedule</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">poll</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">poll_inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">PollFuture</span><span class="token punctuation">::</span><span class="token class-name">Notified</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token comment">// Signal yield</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span><span class="token function">yield_now</span><span class="token punctuation">(</span><span class="token class-name">Notified</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">to_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// The ref-count was incremented as part of</span>
                <span class="token comment">// `transition_to_idle`.</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">drop_reference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">PollFuture</span><span class="token punctuation">::</span><span class="token class-name">DropReference</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">drop_reference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">PollFuture</span><span class="token punctuation">::</span><span class="token class-name">Complete</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> is_join_interested<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> is_join_interested<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">PollFuture</span><span class="token punctuation">::</span><span class="token class-name">None</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">poll_inner</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">PollFuture</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> snapshot <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">scheduler_view</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transition_to_running</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">TransitionToRunning</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span>snapshot<span class="token punctuation">)</span> <span class="token operator">=></span> snapshot<span class="token punctuation">,</span>
            <span class="token class-name">TransitionToRunning</span><span class="token punctuation">::</span><span class="token class-name">DropReference</span> <span class="token operator">=></span> <span class="token keyword">return</span> <span class="token class-name">PollFuture</span><span class="token punctuation">::</span><span class="token class-name">DropReference</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// The transition to `Running` done above ensures that a lock on the</span>
        <span class="token comment">// future has been obtained. This also ensures the `*mut T` pointer</span>
        <span class="token comment">// contains the future (as opposed to the output) and is initialized.</span>

        <span class="token keyword">let</span> waker_ref <span class="token operator">=</span> <span class="token function">waker_ref</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> cx <span class="token operator">=</span> <span class="token class-name">Context</span><span class="token punctuation">::</span><span class="token function">from_waker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token operator">*</span>waker_ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">poll_future</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>stage<span class="token punctuation">,</span> snapshot<span class="token punctuation">,</span> cx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">scheduler_view</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">SchedulerView</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token class-name">SchedulerView</span> <span class="token punctuation">{</span>
            header<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            scheduler<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>scheduler<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">enum</span> <span class="token type-definition class-name">TransitionToRunning</span> <span class="token punctuation">{</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Snapshot</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">DropReference</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">SchedulerView</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span> <span class="token punctuation">{</span>
    header<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Header</span><span class="token punctuation">,</span>
    scheduler<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Scheduler</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span> <span class="token class-name">SchedulerView</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span>
<span class="token keyword">where</span>
    <span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Schedule</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">to_task</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Task</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment">// SAFETY The header is from the same struct containing the scheduler `S` so  the cast is safe</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">Task</span><span class="token punctuation">::</span><span class="token function">from_raw</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Returns true if the task should be deallocated.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">transition_to_terminal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> is_join_interested<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> ref_dec <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span><span class="token function">is_bound</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">to_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">forget</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token boolean">true</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token boolean">false</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// This might deallocate</span>
        <span class="token keyword">let</span> snapshot <span class="token operator">=</span> <span class="token keyword">self</span>
            <span class="token punctuation">.</span>header
            <span class="token punctuation">.</span>state
            <span class="token punctuation">.</span><span class="token function">transition_to_terminal</span><span class="token punctuation">(</span><span class="token operator">!</span>is_join_interested<span class="token punctuation">,</span> ref_dec<span class="token punctuation">)</span><span class="token punctuation">;</span>

        snapshot<span class="token punctuation">.</span><span class="token function">ref_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">transition_to_running</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">TransitionToRunning</span> <span class="token punctuation">{</span>
        <span class="token comment">// 首次执行时会绑定到调度器上</span>
        <span class="token keyword">let</span> is_not_bound <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span><span class="token function">is_bound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Transition the task to the running state.</span>
        <span class="token comment">//</span>
        <span class="token comment">// A failure to transition here indicates the task has been cancelled</span>
        <span class="token comment">// while in the run queue pending execution.</span>
        <span class="token keyword">let</span> snapshot <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">transition_to_running</span><span class="token punctuation">(</span>is_not_bound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span>snapshot<span class="token punctuation">)</span> <span class="token operator">=></span> snapshot<span class="token punctuation">,</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token comment">// The task was shutdown while in the run queue. At this point,</span>
                <span class="token comment">// we just hold a ref counted reference. Since we do not have access to it here</span>
                <span class="token comment">// return `DropReference` so the caller drops it.</span>
                <span class="token keyword">return</span> <span class="token class-name">TransitionToRunning</span><span class="token punctuation">::</span><span class="token class-name">DropReference</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> is_not_bound <span class="token punctuation">{</span>
            <span class="token comment">// Ensure the task is bound to a scheduler instance. Since this is</span>
            <span class="token comment">// the first time polling the task, a scheduler instance is pulled</span>
            <span class="token comment">// from the local context and assigned to the task.</span>
            <span class="token comment">//</span>
            <span class="token comment">// The scheduler maintains ownership of the task and responds to</span>
            <span class="token comment">// `wake` calls.</span>
            <span class="token comment">//</span>
            <span class="token comment">// The task reference count has been incremented.</span>
            <span class="token comment">//</span>
            <span class="token comment">// Safety: Since we have unique access to the task so that we can</span>
            <span class="token comment">// safely call `bind_scheduler`.</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span><span class="token function">bind_scheduler</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">to_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">TransitionToRunning</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span>snapshot<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">poll_future</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Future</span><span class="token operator">></span><span class="token punctuation">(</span>
    header<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Header</span><span class="token punctuation">,</span>
    core<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">CoreStage</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">,</span>
    snapshot<span class="token punctuation">:</span> <span class="token class-name">Snapshot</span><span class="token punctuation">,</span>
    cx<span class="token punctuation">:</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">PollFuture</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> snapshot<span class="token punctuation">.</span><span class="token function">is_cancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">PollFuture</span><span class="token punctuation">::</span><span class="token class-name">Complete</span><span class="token punctuation">(</span><span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">JoinError</span><span class="token punctuation">::</span><span class="token function">cancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> snapshot<span class="token punctuation">.</span><span class="token function">is_join_interested</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token namespace">panic<span class="token punctuation">::</span></span><span class="token function">catch_unwind</span><span class="token punctuation">(</span><span class="token namespace">panic<span class="token punctuation">::</span></span><span class="token class-name">AssertUnwindSafe</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token keyword">struct</span> <span class="token type-definition class-name">Guard</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Future</span><span class="token operator">></span> <span class="token punctuation">{</span>
                core<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">CoreStage</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Future</span><span class="token operator">></span> <span class="token class-name">Drop</span> <span class="token keyword">for</span> <span class="token class-name">Guard</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token keyword">fn</span> <span class="token function-definition function">drop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span>core<span class="token punctuation">.</span><span class="token function">drop_future_or_output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">let</span> guard <span class="token operator">=</span> <span class="token class-name">Guard</span> <span class="token punctuation">{</span> core <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token keyword">let</span> res <span class="token operator">=</span> guard<span class="token punctuation">.</span>core<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>cx<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// prevent the guard from dropping the future</span>
            <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">forget</span><span class="token punctuation">(</span>guard<span class="token punctuation">)</span><span class="token punctuation">;</span>

            res
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">match</span> res <span class="token punctuation">{</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Pending</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">match</span> header<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">transition_to_idle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 需要等待，先切换到 idle 状态</span>
                <span class="token class-name">Ok</span><span class="token punctuation">(</span>snapshot<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> snapshot<span class="token punctuation">.</span><span class="token function">is_notified</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">PollFuture</span><span class="token punctuation">::</span><span class="token class-name">Notified</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token class-name">PollFuture</span><span class="token punctuation">::</span><span class="token class-name">None</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">Err</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">PollFuture</span><span class="token punctuation">::</span><span class="token class-name">Complete</span><span class="token punctuation">(</span><span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token function">cancel_task</span><span class="token punctuation">(</span>core<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Ready</span><span class="token punctuation">(</span>ok<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">PollFuture</span><span class="token punctuation">::</span><span class="token class-name">Complete</span><span class="token punctuation">(</span><span class="token class-name">Ok</span><span class="token punctuation">(</span>ok<span class="token punctuation">)</span><span class="token punctuation">,</span> snapshot<span class="token punctuation">.</span><span class="token function">is_join_interested</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token class-name">PollFuture</span><span class="token punctuation">::</span><span class="token class-name">Complete</span><span class="token punctuation">(</span><span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">JoinError</span><span class="token punctuation">::</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> snapshot<span class="token punctuation">.</span><span class="token function">is_join_interested</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Schedule</span><span class="token operator">></span> <span class="token class-name">Scheduler</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment">/// 绑定调度器</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">bind_scheduler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> task<span class="token punctuation">:</span> <span class="token class-name">Task</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">debug_assert!</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">is_bound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Bind the task to the scheduler</span>
        <span class="token keyword">let</span> scheduler <span class="token operator">=</span> <span class="token class-name">S</span><span class="token punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span><span class="token function">with_mut</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>ptr<span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
            <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>scheduler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">is_bound</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>ptr<span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span><span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_some</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">yield_now</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> task<span class="token punctuation">:</span> <span class="token class-name">Notified</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>ptr<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token comment">// Safety: Can only be called after initial `poll`, which is the</span>
            <span class="token comment">// only time the field is mutated.</span>
            <span class="token keyword">match</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token operator">*</span>ptr <span class="token punctuation">}</span> <span class="token punctuation">{</span>
                <span class="token class-name">Some</span><span class="token punctuation">(</span>scheduler<span class="token punctuation">)</span> <span class="token operator">=></span> scheduler<span class="token punctuation">.</span><span class="token function">yield_now</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">None</span> <span class="token operator">=></span> <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">"no scheduler set"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Future</span><span class="token operator">></span> <span class="token class-name">CoreStage</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment">/// Poll the future</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token keyword">mut</span> cx<span class="token punctuation">:</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Poll</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>stage<span class="token punctuation">.</span><span class="token function">with_mut</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>ptr<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token comment">// 由调用方确保线程安全</span>
                <span class="token keyword">let</span> future <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span>ptr <span class="token punctuation">}</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token class-name">Running</span><span class="token punctuation">(</span>future<span class="token punctuation">)</span> <span class="token operator">=></span> future<span class="token punctuation">,</span>
                    _ <span class="token operator">=></span> <span class="token macro property">unreachable!</span><span class="token punctuation">(</span><span class="token string">"unexpected stage"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>

                <span class="token comment">// Safety: The caller ensures the future is pinned.</span>
                <span class="token keyword">let</span> future <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">Pin</span><span class="token punctuation">::</span><span class="token function">new_unchecked</span><span class="token punctuation">(</span>future<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

              	<span class="token comment">// Rust 提供的 poll 接口</span>
                future<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> cx<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> res<span class="token punctuation">.</span><span class="token function">is_ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">drop_future_or_output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        res
    <span class="token punctuation">}</span>

    <span class="token comment">/// Drop the future</span>
    <span class="token comment">///</span>
    <span class="token comment">/// # Safety</span>
    <span class="token comment">///</span>
    <span class="token comment">/// The caller must ensure it is safe to mutate the `stage` field.</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">drop_future_or_output</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Safety: the caller ensures mutual exclusion to the field.</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">set_stage</span><span class="token punctuation">(</span><span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token class-name">Consumed</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>最后看下 <a href="https://github.com/tokio-rs/tokio/blob/tokio-1.5.0/tokio/src/runtime/task/mod.rs"><code>mod.rs</code></a>：</p>
<pre class="language-rust"><code class="language-rust"><span class="token comment">// Task 的定义，实际上是 RawTask 的封装。</span>
<span class="token comment">// PhantomData 用于绑定没有使用到的 S 类型。</span>
<span class="token attribute attr-name">#[repr(transparent)]</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Task</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token lifetime-annotation symbol">'static</span><span class="token operator">></span> <span class="token punctuation">{</span>
    raw<span class="token punctuation">:</span> <span class="token class-name">RawTask</span><span class="token punctuation">,</span>
    _p<span class="token punctuation">:</span> <span class="token class-name">PhantomData</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">type</span> <span class="token type-definition class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>result<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">JoinError</span><span class="token operator">></span><span class="token punctuation">;</span>

<span class="token comment">// 调度 trait</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">Schedule</span><span class="token punctuation">:</span> <span class="token class-name">Sync</span> <span class="token operator">+</span> <span class="token class-name">Sized</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static</span> <span class="token punctuation">{</span>
    <span class="token comment">// 绑定一个 task 到 executor</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">bind</span><span class="token punctuation">(</span>task<span class="token punctuation">:</span> <span class="token class-name">Task</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> task<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Task</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Task</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">>></span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">schedule</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> task<span class="token punctuation">:</span> <span class="token class-name">Notified</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// yield 操作，触发协程切换</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">yield_now</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> task<span class="token punctuation">:</span> <span class="token class-name">Notified</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 构造 task 和对应的 JoinHandle</span>
<span class="token macro property">cfg_rt!</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Create a new task with an associated join handle</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">joinable</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span><span class="token punctuation">(</span>task<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span><span class="token class-name">Notified</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">JoinHandle</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token operator">></span><span class="token punctuation">)</span>
    <span class="token keyword">where</span>
        <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Future</span> <span class="token operator">+</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static</span><span class="token punctuation">,</span>
        <span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Schedule</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">let</span> raw <span class="token operator">=</span> <span class="token class-name">RawTask</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">::</span><span class="token operator">&lt;</span>_<span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token operator">></span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> task <span class="token operator">=</span> <span class="token class-name">Task</span> <span class="token punctuation">{</span>
            raw<span class="token punctuation">,</span>
            _p<span class="token punctuation">:</span> <span class="token class-name">PhantomData</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> join <span class="token operator">=</span> <span class="token class-name">JoinHandle</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">(</span><span class="token class-name">Notified</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">,</span> join<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Task&lt;Schedule> 的构造</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token lifetime-annotation symbol">'static</span><span class="token operator">></span> <span class="token class-name">Task</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function-definition function">from_raw</span><span class="token punctuation">(</span>ptr<span class="token punctuation">:</span> <span class="token class-name">NonNull</span><span class="token operator">&lt;</span><span class="token class-name">Header</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Task</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token class-name">Task</span> <span class="token punctuation">{</span>
            raw<span class="token punctuation">:</span> <span class="token class-name">RawTask</span><span class="token punctuation">::</span><span class="token function">from_raw</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">,</span>
            _p<span class="token punctuation">:</span> <span class="token class-name">PhantomData</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">header</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token class-name">Header</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>raw<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Notified&lt;Schedule>，实际上还是 Task&lt;Schedule></span>
<span class="token attribute attr-name">#[repr(transparent)]</span>
<span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Notified</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token lifetime-annotation symbol">'static</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token class-name">Task</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">></span><span class="token punctuation">)</span>
<span class="token keyword">unsafe</span> <span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Schedule</span><span class="token operator">></span> <span class="token class-name">Send</span> <span class="token keyword">for</span> <span class="token class-name">Notified</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">unsafe</span> <span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Schedule</span><span class="token operator">></span> <span class="token class-name">Sync</span> <span class="token keyword">for</span> <span class="token class-name">Notified</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// Notified&lt;Schedule> 的构造</span>
<span class="token macro property">cfg_rt_multi_thread!</span> <span class="token punctuation">{</span>
    <span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token lifetime-annotation symbol">'static</span><span class="token operator">></span> <span class="token class-name">Notified</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function-definition function">from_raw</span><span class="token punctuation">(</span>ptr<span class="token punctuation">:</span> <span class="token class-name">NonNull</span><span class="token operator">&lt;</span><span class="token class-name">Header</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Notified</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token class-name">Notified</span><span class="token punctuation">(</span><span class="token class-name">Task</span><span class="token punctuation">::</span><span class="token function">from_raw</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">header</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token class-name">Header</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Notified&lt;Task>.run()，本质上是执行 poll</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Schedule</span><span class="token operator">></span> <span class="token class-name">Notified</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment">/// Run the task</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span>raw<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">forget</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Pre-emptively cancel the task as part of the shutdown process.</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">shutdown</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>配合单元测试 <a href="https://github.com/tokio-rs/tokio/blob/tokio-1.5.0/tokio/src/runtime/tests/task.rs"><code>task.rs</code></a> 整体看下：</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>runtime<span class="token punctuation">::</span>task<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token class-name">Schedule</span><span class="token punctuation">,</span> <span class="token class-name">Task</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>util<span class="token punctuation">::</span>linked_list<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Link</span><span class="token punctuation">,</span> <span class="token class-name">LinkedList</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>util<span class="token punctuation">::</span></span><span class="token class-name">TryLock</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">VecDeque</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">Arc</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[test]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">with</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>rt<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token comment">// 构造一个 task，注意这里依赖下面的 `rt.schedule` 完成类型推导</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>task<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">task<span class="token punctuation">::</span></span><span class="token function">joinable</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
            <span class="token comment">// 执行一次 yield_now，该函数定义于 tokio/src/task/yield_now.rs</span>
            <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>task<span class="token punctuation">::</span></span><span class="token function">yield_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 使用 rt 调度 task</span>
        rt<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 加入任务队列后，队列中有且仅有该任务，弹出并准备执行，此时计数为 1。</span>
        <span class="token comment">// 执行 crate::task::yield_now().await 后，</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> rt<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// yield_now 的实现</span>
<span class="token macro property">cfg_rt!</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Yields execution back to the Tokio runtime.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// A task yields by awaiting on `yield_now()`, and may resume when that</span>
    <span class="token comment">/// future completes (with no output.) The current task will be re-added as</span>
    <span class="token comment">/// a pending task at the _back_ of the pending queue. Any other pending</span>
    <span class="token comment">/// tasks will be scheduled. No other waking is required for the task to</span>
    <span class="token comment">/// continue.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// See also the usage example in the [task module](index.html#yield_now).</span>
    <span class="token attribute attr-name">#[must_use = <span class="token string">"yield_now does nothing unless polled/`await`-ed"</span>]</span>
    <span class="token keyword">pub</span> <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">yield_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/// Yield implementation</span>
        <span class="token keyword">struct</span> <span class="token type-definition class-name">YieldNow</span> <span class="token punctuation">{</span>
            yielded<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">impl</span> <span class="token class-name">Future</span> <span class="token keyword">for</span> <span class="token class-name">YieldNow</span> <span class="token punctuation">{</span>
            <span class="token keyword">type</span> <span class="token type-definition class-name">Output</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">fn</span> <span class="token function-definition function">poll</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">:</span> <span class="token class-name">Pin</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">Self</span><span class="token operator">></span><span class="token punctuation">,</span> cx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Poll</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>yielded <span class="token punctuation">{</span>
                    <span class="token comment">// 第二次执行，直接返回 Ready</span>
                    <span class="token keyword">return</span> <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Ready</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// 第一次执行时，将 yielded 置为 true，并将当前 task 再次加入任务队列</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>yielded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                cx<span class="token punctuation">.</span><span class="token function">waker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wake_by_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Poll</span><span class="token punctuation">::</span><span class="token class-name">Pending</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">YieldNow</span> <span class="token punctuation">{</span> yielded<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token keyword">await</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">with</span><span class="token punctuation">(</span>f<span class="token punctuation">:</span> <span class="token keyword">impl</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token type-definition class-name">Reset</span><span class="token punctuation">;</span>

    <span class="token keyword">impl</span> <span class="token class-name">Drop</span> <span class="token keyword">for</span> <span class="token class-name">Reset</span> <span class="token punctuation">{</span>
        <span class="token keyword">fn</span> <span class="token function-definition function">drop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 退出时将 CURRENT 绑定的引用计数释放</span>
            <span class="token keyword">let</span> _rt <span class="token operator">=</span> <span class="token constant">CURRENT</span><span class="token punctuation">.</span><span class="token function">try_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// RAII</span>
    <span class="token keyword">let</span> _reset <span class="token operator">=</span> <span class="token class-name">Reset</span><span class="token punctuation">;</span>

    <span class="token comment">// 构造 RunTime</span>
    <span class="token keyword">let</span> rt <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Inner</span> <span class="token punctuation">{</span>
        released<span class="token punctuation">:</span> <span class="token namespace">task<span class="token punctuation">::</span></span><span class="token class-name">TransferStack</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        core<span class="token punctuation">:</span> <span class="token class-name">TryLock</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Core</span> <span class="token punctuation">{</span>
            queue<span class="token punctuation">:</span> <span class="token class-name">VecDeque</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            tasks<span class="token punctuation">:</span> <span class="token class-name">LinkedList</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 使用 CURRENT 绑定当前使用的 runtime 实例的一个引用计数</span>
    <span class="token operator">*</span><span class="token constant">CURRENT</span><span class="token punctuation">.</span><span class="token function">try_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>rt<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">f</span><span class="token punctuation">(</span>rt<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[derive(Clone)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Runtime</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Inner</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Inner</span> <span class="token punctuation">{</span>
    released<span class="token punctuation">:</span> <span class="token namespace">task<span class="token punctuation">::</span></span><span class="token class-name">TransferStack</span><span class="token operator">&lt;</span><span class="token class-name">Runtime</span><span class="token operator">></span><span class="token punctuation">,</span>
    core<span class="token punctuation">:</span> <span class="token class-name">TryLock</span><span class="token operator">&lt;</span><span class="token class-name">Core</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Core</span> <span class="token punctuation">{</span>
    queue<span class="token punctuation">:</span> <span class="token class-name">VecDeque</span><span class="token operator">&lt;</span><span class="token namespace">task<span class="token punctuation">::</span></span><span class="token class-name">Notified</span><span class="token operator">&lt;</span><span class="token class-name">Runtime</span><span class="token operator">>></span><span class="token punctuation">,</span>
    tasks<span class="token punctuation">:</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span><span class="token class-name">Task</span><span class="token operator">&lt;</span><span class="token class-name">Runtime</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token class-name">Task</span><span class="token operator">&lt;</span><span class="token class-name">Runtime</span><span class="token operator">></span> <span class="token keyword">as</span> <span class="token class-name">Link</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token class-name">Target</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token constant">CURRENT</span><span class="token punctuation">:</span> <span class="token class-name">TryLock</span><span class="token operator">&lt;</span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Runtime</span><span class="token operator">>></span> <span class="token operator">=</span> <span class="token class-name">TryLock</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Runtime</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">tick</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">usize</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">tick_max</span><span class="token punctuation">(</span><span class="token keyword">usize</span><span class="token punctuation">::</span><span class="token function">max_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 任务队列循环</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">tick_max</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">usize</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> n <span class="token operator">&lt;</span> max <span class="token punctuation">{</span>
            <span class="token comment">// 获取任务并执行</span>
            <span class="token comment">// 第一次获取到 `schedule` 中定义的任务，然后执行了 yield_now，将自身任务加入任务队列</span>
            <span class="token comment">// 第二次则再次获取到同一个任务，退出</span>
            <span class="token keyword">let</span> task <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">next_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            n <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            task<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">maintenance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        n
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">is_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span>core<span class="token punctuation">.</span><span class="token function">try_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">next_task</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">task<span class="token punctuation">::</span></span><span class="token class-name">Notified</span><span class="token operator">&lt;</span><span class="token class-name">Runtime</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span>core<span class="token punctuation">.</span><span class="token function">try_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">shutdown</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> core <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span>core<span class="token punctuation">.</span><span class="token function">try_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> task <span class="token keyword">in</span> core<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            task<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span> <span class="token operator">=</span> core<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">pop_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            task<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">drop</span><span class="token punctuation">(</span>core<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span>core<span class="token punctuation">.</span><span class="token function">try_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">maintenance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Inner</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">maintenance</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span><span class="token class-name">ManuallyDrop</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> task <span class="token keyword">in</span> <span class="token keyword">self</span><span class="token punctuation">.</span>released<span class="token punctuation">.</span><span class="token function">drain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> task <span class="token operator">=</span> <span class="token class-name">ManuallyDrop</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// safety: see worker.rs</span>
            <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> ptr <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>core<span class="token punctuation">.</span><span class="token function">try_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Schedule</span> <span class="token keyword">for</span> <span class="token class-name">Runtime</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">bind</span><span class="token punctuation">(</span>task<span class="token punctuation">:</span> <span class="token class-name">Task</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Runtime</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> rt <span class="token operator">=</span> <span class="token constant">CURRENT</span><span class="token punctuation">.</span><span class="token function">try_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rt<span class="token number">.0</span><span class="token punctuation">.</span>core<span class="token punctuation">.</span><span class="token function">try_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push_front</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rt
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> task<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Task</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Task</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">>></span> <span class="token punctuation">{</span>
        <span class="token comment">// safety: copying worker.rs</span>
        <span class="token keyword">let</span> task <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">Task</span><span class="token punctuation">::</span><span class="token function">from_raw</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span>released<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">None</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">schedule</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> task<span class="token punctuation">:</span> <span class="token namespace">task<span class="token punctuation">::</span></span><span class="token class-name">Notified</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将 task 加入任务队列</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span>core<span class="token punctuation">.</span><span class="token function">try_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="references" tabindex="-1"><a href="#references">References</a></h3>
<ol>
<li><a href="https://tokio.rs/blog/2020-12-tokio-1-0">&quot;Announcing Tokio 1.0&quot;, <em>tokio.rs</em></a></li>
<li><a href="https://en.wikipedia.org/wiki/Asynchrony_(computer_programming)">&quot;Asynchrony (computer programming)&quot;, <em>Wikipedia</em></a></li>
<li><a href="https://en.wikipedia.org/wiki/Asynchronous_I/O">&quot;Asynchronous I/O&quot;, <em>Wikipedia</em></a></li>
<li><a href="https://en.wikipedia.org/wiki/Talk:Asynchronous_I/O#async_is_not_nonblocking">&quot;async is not nonblocking&quot;, <em>Wikipedia</em></a></li>
</ol>

      </div>
      <div id="gitalk-container">
      </div>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2017 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/gitalk.min.js"></script>
    <script src="/dist/main.js"></script>
    <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-61723712-2', 'auto'); ga('send', 'pageview'); </script>
  </body>
</html>
