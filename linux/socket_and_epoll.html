<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/gitalk.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>Linux Socket é€šä¿¡ä¸ IO å¤šè·¯å¤ç”¨ | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> Linux Socket é€šä¿¡ä¸ IO å¤šè·¯å¤ç”¨ </h1>
      </div>
      <div class="info">
        <div class="date"> 2020.02.03 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <p>æœ€è¿‘åœ¨è¿›è¡Œ Linux ç³»ç»Ÿä¸‹ Socket ä¸ RPC ç›¸å…³çš„å·¥ä½œï¼Œæ•…ç³»ç»ŸåŒ–å­¦ä¹ ä¸€ä¸‹ Socket æ–¹é¢çš„çŸ¥è¯†ã€‚ä¸»è¦å‚è€ƒæ–‡çŒ®ä¸º ã€Š<a href="http://man7.org/tlpi/">The Linux Programming Interface</a>ã€‹ï¼Œä¸­æ–‡ç‰ˆä¸ºã€Š<a href="https://www.epubit.com/bookDetails?id=N6862">Linux/UNIX ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œ</a>ã€‹ï¼Œå¯ä»¥åœ¨çº¿è´­ä¹°ç”µå­ç‰ˆã€‚æœ¬æ–‡é‡ç‚¹ä»‹ç» <em>Internet domain stream socket</em>ï¼Œä¹Ÿå°±æ˜¯ <em>TCP socket</em>ã€‚</p>
<h3 id="1.-tcp-socket-é€šä¿¡" tabindex="-1"><a href="#1.-tcp-socket-%E9%80%9A%E4%BF%A1">1. TCP Socket é€šä¿¡</a></h3>
<p>TCP Socket é€šä¿¡æ—¶çš„ç³»ç»Ÿè°ƒç”¨æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚é¦–å…ˆ Server å’Œ Client å‡é€šè¿‡ <code>socket</code> åˆ›å»º Socket å¹¶è·å¾—å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ <code>sockfd</code>ï¼›è€Œå Server ä¾§éœ€ç»‘å®š <code>bind</code> ä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„åœ°å€ï¼Œå¹¶ä½¿ç”¨ <code>listen</code> å°† <code>sockfd</code> æ ‡è®°ä¸º <em>Passive</em> çŠ¶æ€ï¼Œæœ€åé€šè¿‡ <code>accept</code> æ¥å— Client çš„ <code>connect</code> è¿æ¥è¯·æ±‚ã€‚Server ä¾§ <code>accept</code> æˆåŠŸåä¼šè¿”å›ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ <code>fd</code>ï¼Œå¯¹è¯¥æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œè¯»å†™å¯ä»¥å®Œæˆ Server å’Œ Client çš„é€šä¿¡ã€‚</p>
<figure tabindex="1"><a href="../images/57146ab1ee3c1cdedc5ea738f4ebfea7.svg"><img src="../images/57146ab1ee3c1cdedc5ea738f4ebfea7.svg" alt=""></a><figcaption>TCP Socket é€šä¿¡ç³»ç»Ÿè°ƒç”¨ from &quot;The Linux Programming Interface&quot;</figcaption></figure>
<p>Unix ä¸‹ä¸€åˆ‡çš†æ–‡ä»¶ï¼ˆEverything is a fileï¼‰ï¼Œå¯¹ Socket æ–‡ä»¶æè¿°ç¬¦ <code>fd</code> çš„æ“ä½œä¸ä¸€èˆ¬æ–‡ä»¶æ“ä½œæ— å¼‚ï¼Œå¸¸ç”¨ç³»ç»Ÿè°ƒç”¨ <code>read</code> / <code>write</code> / <code>close</code> / <code>fcntl</code> å‡æ­£å¸¸ä½¿ç”¨ã€‚Socket ç›¸å…³çš„å‡½æ•°å£°æ˜äº <code>sys/socket.h</code> ä¸­ï¼Œæœ‰è¯¦ç»†çš„æ³¨é‡Šï¼Œè¿™é‡Œæ‘˜å½•éƒ¨åˆ†ï¼š</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">/* Create a new socket of type TYPE in domain DOMAIN, using
   protocol PROTOCOL.  If PROTOCOL is zero, one is chosen automatically.
   Returns a file descriptor for the new socket, or -1 for errors.  */</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">socket</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __domain<span class="token punctuation">,</span> <span class="token keyword">int</span> __type<span class="token punctuation">,</span> <span class="token keyword">int</span> __protocol<span class="token punctuation">)</span> __THROW<span class="token punctuation">;</span>

<span class="token comment">/* Give the socket FD the local address ADDR (which is LEN bytes long).  */</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">bind</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __fd<span class="token punctuation">,</span> __CONST_SOCKADDR_ARG __addr<span class="token punctuation">,</span> socklen_t __len<span class="token punctuation">)</span>

<span class="token comment">/* Open a connection on socket FD to peer at ADDR (which LEN bytes long).
   For connectionless socket types, just set the default address to send to
   and the only address from which to accept transmissions.
   Return 0 on success, -1 for errors.

   This function is a cancellation point and therefore not marked with
   __THROW.  */</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">connect</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __fd<span class="token punctuation">,</span> __CONST_SOCKADDR_ARG __addr<span class="token punctuation">,</span> socklen_t __len<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* Prepare to accept connections on socket FD.
   N connection requests will be queued before further requests are refused.
   Returns 0 on success, -1 for errors.  */</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">listen</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __fd<span class="token punctuation">,</span> <span class="token keyword">int</span> __n<span class="token punctuation">)</span> __THROW<span class="token punctuation">;</span>

<span class="token comment">/* Await a connection on socket FD.
   When a connection arrives, open a new socket to communicate with it,
   set *ADDR (which is *ADDR_LEN bytes long) to the address of the connecting
   peer and *ADDR_LEN to the address's actual length, and return the
   new socket's descriptor, or -1 for errors.

   This function is a cancellation point and therefore not marked with
   __THROW.  */</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">accept</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __fd<span class="token punctuation">,</span> __SOCKADDR_ARG __addr<span class="token punctuation">,</span>
		   socklen_t <span class="token operator">*</span>__restrict __addr_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>ç®€å• Socket é€šä¿¡ä¸¾ä¾‹ï¼ˆ<a href="https://paiza.io/projects/CwP7rJLhNe4EuGXb0a6jpg?language=cpp">åœ¨çº¿è¿è¡Œ</a>ï¼‰ã€‚è¿™é‡Œå¿½ç•¥äº†é”™è¯¯å¤„ç†éƒ¨åˆ†ï¼Œä»…å±•ç¤ºç³»ç»Ÿè°ƒç”¨æµç¨‹ï¼š</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;chrono></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ZERO_OR_RETURN</span><span class="token expression"><span class="token punctuation">(</span>expr<span class="token punctuation">)</span>                             </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">do</span> <span class="token punctuation">{</span>                                                   </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token punctuation">(</span>expr<span class="token punctuation">)</span><span class="token punctuation">;</span>                                    </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                      </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span></span><span class="token string">"ERR: line %d return %d\n"</span><span class="token expression"><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token keyword">return</span> ret<span class="token punctuation">;</span>                                        </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span>                                                    </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>

<span class="token keyword">int</span> <span class="token function">Server</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server_addr<span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  server_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
  server_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  server_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
  socklen_t server_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SERVER: Create Socket [%d]\n"</span><span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">ZERO_OR_RETURN</span><span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span> server_len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SERVER: Bind [%d] on [%d] port\n"</span><span class="token punctuation">,</span> sockfd<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">ZERO_OR_RETURN</span><span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SERVER: Listen [%d]\n"</span><span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_addr<span class="token punctuation">;</span>
  socklen_t client_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>client_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SERVER: Accept [%d]\n"</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token double-colon punctuation">::</span>string <span class="token function">buffer</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  buffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SERVER: Recv [%s]\n"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> w <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  buffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SERVER: Send [%s]\n"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">ZERO_OR_RETURN</span><span class="token punctuation">(</span><span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ZERO_OR_RETURN</span><span class="token punctuation">(</span><span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">Client</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_addr<span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  client_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
  client_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  client_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
  socklen_t client_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"CLIENT: Create Socket [%d]\n"</span><span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">ZERO_OR_RETURN</span><span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_addr<span class="token punctuation">,</span> client_len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"CLIENT: Connect [%d] on [%d] port\n"</span><span class="token punctuation">,</span> sockfd<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token double-colon punctuation">::</span>string <span class="token function">buffer</span><span class="token punctuation">(</span><span class="token string">"Hello Socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> w <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  buffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"CLIENT: Send [%s]\n"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  buffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"CLIENT: Recv [%s]\n"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">ZERO_OR_RETURN</span><span class="token punctuation">(</span><span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">srand</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10000</span> <span class="token operator">+</span> <span class="token number">10000</span><span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>thread <span class="token function">server</span><span class="token punctuation">(</span>Server<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>thread <span class="token function">client</span><span class="token punctuation">(</span>Client<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
  client<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  server<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
SERVER: Create Socket [4]
SERVER: Bind [4] on [12650] port
SERVER: Listen [4]
CLIENT: Create Socket [6]
CLIENT: Connect [6] on [12650] port
SERVER: Accept [5]
CLIENT: Send [Hello Socket]
SERVER: Recv [Hello Socket]
SERVER: Send [Hello Socket]
CLIENT: Recv [Hello Socket]
*/</span>
</code></pre>
<h3 id="2.-é˜»å¡ä¸-io-å¤šè·¯å¤ç”¨" tabindex="-1"><a href="#2.-%E9%98%BB%E5%A1%9E%E4%B8%8E-io-%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8">2. é˜»å¡ä¸ IO å¤šè·¯å¤ç”¨</a></h3>
<p>ä¸€åˆ‡çš†æ–‡ä»¶ï¼Œå®é™…ä¸Šæ˜¯ä¸€åˆ‡çš†å­—èŠ‚æµï¼Œæœ¬è´¨ä¸Šæ˜¯å¯ä»¥è¿›è¡Œ IO æ“ä½œçš„å†…æ ¸å¯¹è±¡ã€‚æ—¢ç„¶æ˜¯æµï¼Œå°±ä¼šæœ‰è¯»åˆ°ç©ºæˆ–è€…å†™åˆ°æ»¡çš„çŠ¶æ€ï¼Œå³ <code>read buffer</code> ä¸ºç©ºæˆ– <code>write buffer</code> å·²æ»¡ã€‚</p>
<figure tabindex="2"><a href="../images/75c22dd97ad9905403a1f494d68ea392.svg"><img src="../images/75c22dd97ad9905403a1f494d68ea392.svg" alt=""></a><figcaption>TCP Socket é€šä¿¡ç¼“å­˜æ¨¡å‹</figcaption></figure>
<p>è¿™æ—¶æœ‰ä¸¤ç§ç­‰å¾…æ–¹å¼å¯ä»¥é€‰æ‹©ï¼š</p>
<ol>
<li>é˜»å¡ï¼šåœ¨è°ƒç”¨å¤„ç¡è§‰ï¼Œå½“ buffer å¯ç”¨æ—¶å†…æ ¸ä¼šå«é†’ä½ å¹¶è¿”å›ï¼Œä½†ç¡è§‰æ—¶æ²¡æ³•åšåˆ«çš„äº‹æƒ…ï¼›</li>
<li>éé˜»å¡ï¼šè°ƒç”¨ä¼šç«‹å³è¿”å›ï¼Œè¿™æ—¶å¯ä»¥åšåˆ«çš„äº‹æƒ…ï¼Œä½†å¹¶ä¸çŸ¥é“ä½•æ—¶ buffer å¯ç”¨ï¼Œéœ€è¦è‡ªè¡Œå®šæœŸæ£€æŸ¥ï¼ˆè½®è¯¢ï¼‰ã€‚</li>
</ol>
<p>å½“åªæœ‰ä¸€ä¸ªæµéœ€è¦å¤„ç†æ—¶ï¼Œé˜»å¡ç­‰å¾…æ˜¯å¯è¡Œçš„ã€‚ä½†ç°å®æƒ…å†µé€šå¸¸æ˜¯éœ€è¦å¤„ç†å¤šä¸ªæµï¼Œè¿™æ—¶å¦‚æœç»§ç»­ä½¿ç”¨é˜»å¡ç­‰å¾…ï¼Œä¸€ä¸ªæµå°†ä¼šé˜»å¡å…¶ä»–æ‰€æœ‰æµçš„å¤„ç†ã€‚è¿™æ—¶ä¸€ä¸ªå¯è¡Œçš„æ–¹æ¡ˆæ˜¯ä½¿ç”¨å¤šçº¿ç¨‹/å¤šè¿›ç¨‹ï¼Œä¸€ä¸ªæµçš„é˜»å¡ä¸å½±å“å…¶ä»–æµçš„å¤„ç†ã€‚å¦ä¸€ä¸ªå¯è¡Œçš„æ–¹æ¡ˆæ˜¯å°†æ‰€æœ‰éœ€è¦ç­‰å¾…çš„æµå­˜åœ¨åˆ—è¡¨é‡Œï¼Œä½¿ç”¨éé˜»å¡æ¨¡å¼ï¼Œè½®è¯¢ï¼Œå¯¹å¯ç”¨çš„æµè¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚</p>
<p>ä¸ºäº†æ›´æ¸…æ¥šåœ°æè¿°è¿™å‡ ç§ç­‰å¾…æ–¹å¼ï¼Œè¿™é‡Œå¼•ç”¨<a href="https://www.zhihu.com/question/28594409/answer/52835876">çŸ¥ä¹ä¸ŠæŸ´å°å–µçš„ä¸€ä¸ªå›ç­”</a>å¹¶ç¨ä½œä¿®æ”¹ï¼š</p>
<blockquote>
<p>å‡è®¾ä½ æ˜¯ä¸€ä¸ªè€å¸ˆï¼Œè®© 30 ä¸ªå­¦ç”Ÿåšä½œä¸šï¼Œç„¶åæ‰¹æ”¹å­¦ç”Ÿçš„ä½œä¸šï¼Œä½ æœ‰ä¸‹é¢å‡ ä¸ªé€‰æ‹©ï¼š</p>
<ol>
<li><strong>æŒ‰é¡ºåºé€ä¸ªæ£€æŸ¥å’Œæ‰¹æ”¹</strong>ï¼Œå…ˆç­‰å¾… A å®Œæˆï¼Œæ‰¹æ”¹ A çš„ä½œä¸šï¼›ç„¶åæ˜¯ Bï¼Œä¹‹åæ˜¯ Cã€Dï¼Œä»¥æ­¤ç±»æ¨ã€‚è¿™ä¸­é—´å¦‚æœæœ‰ä¸€ä¸ªå­¦ç”Ÿåšå¾—æ…¢ï¼Œé‚£ä¹ˆå…¨ç­éƒ½ä¼šè¢«è€½è¯¯ï¼›</li>
<li><strong>åˆ›å»º 30 ä¸ªåˆ†èº«</strong>ï¼Œæ¯ä¸ªåˆ†èº«ç­‰å¾…ä¸€ä¸ªå­¦ç”Ÿåšå®Œï¼Œå¹¶å¯¹å…¶ä½œä¸šæ‰¹æ”¹ï¼Œä¹Ÿå°±æ˜¯å¤šçº¿ç¨‹/å¤šè¿›ç¨‹æ¨¡å¼ï¼›</li>
<li><strong>ä¾æ¬¡æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦å®Œæˆï¼Œæ‰¹æ”¹å·²ç»å®Œæˆçš„ä½œä¸š</strong>ï¼Œå…ˆçœ‹ A æœ‰æ²¡æœ‰åšå®Œï¼Œåšå®Œçš„è¯å°±æ‰¹æ”¹ä»–çš„ï¼›æ²¡åšå®Œå°±ç»§ç»­çœ‹ B æœ‰æ²¡æœ‰åšå®Œï¼Œåšå®Œçš„è¯å°±æ‰¹æ”¹ä»–çš„ï¼›è¿™æ ·å°±ä¸ä¼šé—²ç€äº†ï¼Œåœ¨ç­é‡Œæ™ƒå‡ åœˆå°±å¯ä»¥ï¼Œä½†è€å¸ˆå§‹ç»ˆæ²¡æœ‰ä¼‘æ¯ï¼Œè¦ä¹ˆåœ¨æ£€æŸ¥è¦ä¹ˆåœ¨æ‰¹æ”¹ï¼Œå¯èƒ½æ£€æŸ¥äº† 20 ä¸ªæ‰ä¼šæ‰¹æ”¹ä¸€ä»½ï¼Œåšäº†å¾ˆå¤šæ— ç”¨åŠŸï¼›</li>
<li><strong>åœ¨è®²å°ä¼‘æ¯ï¼Œè®©å­¦ä¹ å§”å‘˜æŠŠå®Œæˆä½œä¸šçš„åŒå­¦åå­—è®°ä¸‹æ¥ï¼Œè€Œåæ‰¾å­¦ä¹ å§”å‘˜æ‹¿åå•ã€æ‰¹æ”¹åå•ä¸ŠåŒå­¦çš„ä½œä¸š</strong>ï¼Œè¿™å°±æ˜¯ IO å¤šè·¯å¤ç”¨ã€‚</li>
</ol>
</blockquote>
<p>ç¬¬å››ç§å°±éœ€è¦å€ŸåŠ©äºç³»ç»Ÿè°ƒç”¨ <code>select</code> / <code>poll</code> / <code>epoll</code>ï¼Œæœ¬æ–‡ä»…ä»‹ç» <code>epoll</code>ã€‚<code>epoll</code> çš„æ ¸å¿ƒè°ƒç”¨å¦‚ä¸‹ï¼š</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">/* Creates an epoll instance.  Returns an fd for the new instance.
   The "size" parameter is a hint specifying the number of file
   descriptors to be associated with the new instance.  The fd
   returned by epoll_create() should be closed with close().  */</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">epoll_create</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __size<span class="token punctuation">)</span> __THROW<span class="token punctuation">;</span>

<span class="token comment">/* Manipulate an epoll instance "epfd". Returns 0 in case of success,
   -1 in case of error ( the "errno" variable will contain the
   specific error code ) The "op" parameter is one of the EPOLL_CTL_*
   constants defined above. The "fd" parameter is the target of the
   operation. The "event" parameter describes which events the caller
   is interested in and any associated user data.  */</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">epoll_ctl</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __epfd<span class="token punctuation">,</span> <span class="token keyword">int</span> __op<span class="token punctuation">,</span> <span class="token keyword">int</span> __fd<span class="token punctuation">,</span>
		      <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>__event<span class="token punctuation">)</span> __THROW<span class="token punctuation">;</span>

<span class="token comment">/* Wait for events on an epoll instance "epfd". Returns the number of
   triggered events returned in "events" buffer. Or -1 in case of
   error with the "errno" variable set to the specific error code. The
   "events" parameter is a buffer that will contain triggered
   events. The "maxevents" is the maximum number of events to be
   returned ( usually size of "events" ). The "timeout" parameter
   specifies the maximum wait time in milliseconds (-1 == infinite).

   This function is a cancellation point and therefore not marked with
   __THROW.  */</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">epoll_wait</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __epfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>__events<span class="token punctuation">,</span>
		       <span class="token keyword">int</span> __maxevents<span class="token punctuation">,</span> <span class="token keyword">int</span> __timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>epoll_create</code> åˆ›å»ºå­¦ä¹ å§”å‘˜ï¼›<code>epoll_ctl</code> åˆ™æ˜¯æ³¨å†Œç­é‡Œçš„åŒå­¦ï¼Œå­¦å§”å°±çŸ¥é“è¦è®°å½•å“ªäº›åŒå­¦ä¸¾æ‰‹äº†ï¼›æœ€å <code>epoll_wait</code> åˆ™æ˜¯æ‰¾å­¦å§”æ‹¿åå•ã€‚æ‹¿åå•æ—¶å­¦å§”å¯èƒ½è¿˜æ²¡æœ‰å‘ç°åŒå­¦ä¸¾æ‰‹ï¼Œè¿™æ—¶å¯ä»¥é€‰æ‹©ä¸€ç›´ç­‰ç€å­¦å§”è®°ä¸‹ç¬¬ä¸€ä¸ªåå­—ï¼Œæˆ–è€…é™æ—¶ <code>timeout</code>ï¼Œåˆ°æ—¶é—´ä¹Ÿå¾—æŠŠç©ºåå•æ‹¿ä¸Šæ¥ã€‚</p>
<p>å­¦å§”è®°åå­—ä¹Ÿæ˜¯æœ‰æŠ€å·§çš„ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<ol>
<li>æ°´å¹³è§¦å‘ <code>Level Triggered</code>ï¼Œå­¦å§”è®©å®Œæˆä½œä¸šå¹¶ä¸”è¿˜æ²¡æœ‰è¢«æ‰¹æ”¹çš„åŒå­¦ä¸¾æ‰‹ï¼Œè€å¸ˆè¦åå•æ—¶å­¦å§”è‡ªå·±æŠŠä¸¾æ‰‹çš„åŒå­¦åå­—è®°ä¸‹æ¥ï¼Œè¿™æ˜¯ç›¸å¯¹å‹¤å¥‹çš„å­¦å§”ï¼›</li>
<li>è¾¹ç¼˜è§¦å‘ <code>Edge Triggered</code>ï¼Œå­¦å§”è®©åŒå­¦åšå®Œä½œä¸šæ—¶ï¼Œè‡ªå·±æŠŠåå­—å†™åˆ°åå•ä¸Šï¼Œè€å¸ˆæ‹¿åå•æ—¶å°±ç›´æ¥æŠŠåå•ä¸¢ç»™è€å¸ˆã€‚è¿™æ ·è‡ªå·±é—²ä¸€ç‚¹ï¼Œä½†æ˜¯å¦‚æœè€å¸ˆæ‹¿äº†åå•åå¿˜äº†æ‰¹æ”¹ï¼Œè¿™äº›åŒå­¦çš„ä½œä¸šå°±æ²¡æœ‰æœºä¼šè¢«æ‰¹æ”¹äº†ã€‚</li>
</ol>
<h3 id="3.-reactor-æ¨¡å¼ä¸åç¨‹" tabindex="-1"><a href="#3.-reactor-%E6%A8%A1%E5%BC%8F%E4%B8%8E%E5%8D%8F%E7%A8%8B">3. Reactor æ¨¡å¼ä¸åç¨‹</a></h3>
<p>ä½¿ç”¨åŸºäº <code>Epoll</code> çš„ Reactor æ¨¡å¼ï¼Œå¯ä»¥åœ¨å•çº¿ç¨‹ä¸‹â€œå¹¶å‘â€åœ°å¤„ç†å¤šä¸ªæµã€‚ä¸¾ä¸ªæ —å­ğŸŒ°ï¼š</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ctype.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ZERO_OR_RETURN</span><span class="token expression"><span class="token punctuation">(</span>expr<span class="token punctuation">)</span>            </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">do</span> <span class="token punctuation">{</span>                                  </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token punctuation">(</span>expr<span class="token punctuation">)</span><span class="token punctuation">;</span>                   </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                     </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span></span><span class="token string">"%d %d\n"</span><span class="token expression"><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token keyword">return</span> ret<span class="token punctuation">;</span>                       </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span>                                   </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serv_addr<span class="token punctuation">;</span>
  socklen_t serv_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serv_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> lfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>serv_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serv_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  serv_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
  serv_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  serv_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ZERO_OR_RETURN</span><span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>lfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serv_addr<span class="token punctuation">,</span> serv_len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ZERO_OR_RETURN</span><span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>lfd<span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_addr<span class="token punctuation">;</span>
  socklen_t cli_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> epfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> ev<span class="token punctuation">;</span>
  ev<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span>
  ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> lfd<span class="token punctuation">;</span>
  <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> lfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> all<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> all<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>all<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>all<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ret<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">int</span> fd <span class="token operator">=</span> all<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> lfd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> cfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>lfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cli_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"> Accept Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> flag <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>cfd<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        flag <span class="token operator">|=</span> O_NONBLOCK<span class="token punctuation">;</span>
        <span class="token function">fcntl</span><span class="token punctuation">(</span>cfd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> temp<span class="token punctuation">;</span>
        temp<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN <span class="token operator">|</span> EPOLLET<span class="token punctuation">;</span>
        temp<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> cfd<span class="token punctuation">;</span>
        <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> cfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> ip<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"> New Client [%s:%d] => [%d]\n"</span><span class="token punctuation">,</span>
               <span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token operator">&amp;</span>client_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               <span class="token function">ntohs</span><span class="token punctuation">(</span>client_addr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">,</span> cfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>all<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> len<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EAGAIN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Buffer Data is Finished!;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"> Recv Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"> Client [%d] Disconnected!\n"</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_DEL<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">close</span><span class="token punctuation">(</span>lfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ä¸Šæ–¹æ˜¯ Server ç«¯çš„ä»£ç ï¼Œå¯ä»¥ä½¿ç”¨ <code>netcat</code> è¿›è¡Œæµ‹è¯•ï¼Œæˆ–è€…ä½¿ç”¨ä¸‹æ–¹çš„ Client ä»£ç æµ‹è¯•ï¼š</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;atomic></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;chrono></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ZERO_OR_RETURN</span><span class="token expression"><span class="token punctuation">(</span>expr<span class="token punctuation">)</span>            </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">do</span> <span class="token punctuation">{</span>                                  </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token punctuation">(</span>expr<span class="token punctuation">)</span><span class="token punctuation">;</span>                   </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                     </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span></span><span class="token string">"%d %d\n"</span><span class="token expression"><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token keyword">return</span> ret<span class="token punctuation">;</span>                       </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span>                                   </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>

std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> quit<span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> alive<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">do_quit</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  quit <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>alive <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s [port=8000] [thread=1] [data_size=100]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span> do_quit<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> port <span class="token operator">=</span> argc <span class="token operator">>=</span> <span class="token number">2</span> <span class="token operator">?</span> std<span class="token double-colon punctuation">::</span><span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">8000</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> thread <span class="token operator">=</span> argc <span class="token operator">>=</span> <span class="token number">3</span> <span class="token operator">?</span> std<span class="token double-colon punctuation">::</span><span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> data_size <span class="token operator">=</span> argc <span class="token operator">>=</span> <span class="token number">4</span> <span class="token operator">?</span> std<span class="token double-colon punctuation">::</span><span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>string <span class="token function">data</span><span class="token punctuation">(</span>data_size<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">&amp;</span>ch <span class="token operator">:</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ch <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">26</span> <span class="token operator">+</span> <span class="token string">'A'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> qps<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> thread<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
      <span class="token operator">++</span>alive<span class="token punctuation">;</span>
      <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> cli_addr<span class="token punctuation">;</span>
      socklen_t cli_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cli_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cli_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cli_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cli_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
      cli_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
      cli_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
      std<span class="token double-colon punctuation">::</span>string <span class="token function">buffer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">int</span> sock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">ZERO_OR_RETURN</span><span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>cli_addr<span class="token punctuation">,</span> cli_len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>quit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> writen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>writen <span class="token operator">&lt;</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">int</span> w <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">[</span>writen<span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> writen<span class="token punctuation">)</span><span class="token punctuation">;</span>
          writen <span class="token operator">+=</span> w<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> readed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>readed <span class="token operator">&lt;</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer<span class="token punctuation">[</span>readed<span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> readed<span class="token punctuation">)</span><span class="token punctuation">;</span>
          readed <span class="token operator">+=</span> r<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          qps <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token function">ZERO_OR_RETURN</span><span class="token punctuation">(</span><span class="token function">close</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">--</span>alive<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"QPS: %d\n"</span><span class="token punctuation">,</span> qps<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    qps <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Reactor æ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³æ˜¯å½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼ˆæµå¯ç”¨ï¼‰ï¼Œæ¥é€šçŸ¥å¯¹è±¡å¤„ç†è¯¥äº‹ä»¶ï¼ˆIO æ“ä½œï¼‰ï¼Œå…¶ä»–æ—¶é—´åˆ™å¯ä»¥ä¼‘æ¯ã€‚è¿™ä¸åç¨‹çš„é£æ ¼æ˜¯è¿‘ä¼¼çš„ï¼Œä¸åŒçš„æ˜¯åç¨‹å†™å‡ºæ¥çš„ä»£ç å’ŒåŒæ­¥çš„ä»£ç é£æ ¼ä¸€è‡´ï¼Œå½“æµé˜»å¡æ—¶è‡ªåŠ¨æ”¾å¼ƒæ‰§è¡Œæƒ <code>Yield</code>ï¼Œå½“æµå¯ç”¨æ—¶å†æ¢å¤ <code>Resume</code>ã€‚å®é™…ä¸Šå¾ˆå¤šåç¨‹åº“çš„æ ¸å¿ƒå°±æ˜¯ <code>Epoll</code>ï¼Œä¾‹å¦‚å¾®ä¿¡å¼€æºçš„ <a href="https://github.com/Tencent/libco">libco</a>ã€‚è¿™éƒ¨åˆ†å¾…ç¬”è€…å®Œå–„åç»§ç»­è¡¥å……ã€‚</p>
<h3 id="references" tabindex="-1"><a href="#references">References</a></h3>
<ol>
<li><a href="http://man7.org/tlpi/">&quot;The Linux Programming Interface&quot;, <em>Michael Kerrisk</em></a></li>
</ol>

      </div>
      <div id="gitalk-container">
      </div>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          CopyrightÂ©2017 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/gitalk.min.js"></script>
    <script src="/dist/main.js"></script>
    <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-61723712-2', 'auto'); ga('send', 'pageview'); </script>
  </body>
</html>
