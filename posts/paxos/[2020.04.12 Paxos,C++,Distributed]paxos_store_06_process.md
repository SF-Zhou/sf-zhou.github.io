# PaxosStore 源码分析「六、流程细节」

> Work in Progress

本篇继续来看 PaxosStore 中 Paxos 流程的细节。

### 1. Paxos 流程

PaxosStore 中一次普通的 Paxos 协议过程如下图所示：

![](../images/ff2cd1a1c77f43848425b96df20946f8.svg)

PaxosStore 中通过消息队列和 RPC 将整个流程彻底异步化，提高了并发性能。可以看到，总的 Latency 至少包括 2 次 RPC RTT。对于 3 个节点的集群，共计 8 次 fsync，单节点平均执行 2.67 次 fsync，Latency 里至少包含 5 次 fsync 的时间。对于高并发系统这样的性能表现仍然是不够的，所以 PaxosStore 中额外使用了预授权优化提高性能。

### 2. 预授权优化

回忆一下 Paxos 流程：第一阶段 Proposer 发起 Prepare 请求，Acceptor 接受后回复 Promised；Proposer 获得多数派支持后，进入第二阶段发送 Accept 请求，Acceptor 接受后回复 Accepted，多数派通过后值被 Chosen。

PaxosStore 通过下面两个简单的操作实现一阶段提交：

1. 如果当前节点 $i$ 发起的 Paxos 过程成功，记录 LocalPreAuthEntry = Entry + 1；
2. 如果当前节点 $i$ 发起 Paxos 过程的 Entry = LocalPreAuthEntry，则将 PreparedNum / ProposalNum / AcceptedNum 设定为 $i$，直接发送 Accept 请求；否则将 PreparedNum / ProposalNum 设定为 $i + N$，走正常流程发送 Prepare 请求。

简单来想，就是 Acceptor 在 Accept Entry 的请求时，已经 Promise 了 Entry + 1 且 PreparedNum < N 的请求。另一个角度看，只有上一轮成功发起 Paxos 流程的唯一节点会发送 PreparedNum < N 的请求，可以在不违反 Paxos 协议的前提下直接发送 Accept 请求。

理解了这个操作后就会感受到这个优化的精妙。经过优化后整个 Paxos 过程的 Latency 降低到 1 次 RPC RTT，对于 3 节点集群，单节点平均执行 1.33 次 fsync。

### 总结

PS：这个系列一直难产，我自己也在不断加深理解，慢慢努力吧😄

