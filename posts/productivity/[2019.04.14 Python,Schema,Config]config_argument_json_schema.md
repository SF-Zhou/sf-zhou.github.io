# Config, Argument and JSON Schema

æœ€è¿‘åœ¨é‡æ„ç°æœ‰çš„ `PyTorch` è®­ç»ƒæ¡†æ¶ï¼Œç›®æ ‡æ˜¯ç»„ä»¶åŒ–ã€ä½è€¦åˆã€é«˜å¤ç”¨ï¼Œæé«˜å¤§å®¶çš„ç ”ç©¶æ•ˆç‡ã€‚å¼€å‘è¿‡ç¨‹ä¸­æ€è€ƒäº†ä¸€äº›å…³äº Config å’Œ Command Line Argument çš„é—®é¢˜ï¼Œå¹¶ä¸”é¡ºæ‰‹å¼€å‘äº†å‡ ä¸ªè¾…åŠ©å°å·¥å…·ã€‚æœ¬æ–‡å¯ä»¥çœ‹æˆæ˜¯è¿™å‡ ä¸ªå·¥å…·çš„è¯´æ˜æ–‡æ¡£äº†ã€‚

### 1. Config File

è®­ç»ƒæ¡†æ¶é‡Œï¼ŒConfig File çš„ä½¿ç”¨éå¸¸å¹¿æ³›ã€‚é…ç½®æ–‡ä»¶ä¸€èˆ¬ä½¿ç”¨ YAML å’Œ JSON æ ¼å¼ï¼Œå…¶ä¸­å­˜å‚¨äº†å…³äºå®éªŒçš„ä¸€äº›ç»†èŠ‚ï¼Œæ¯”å¦‚ç”¨å“ªä¸€ç§æ¨¡å‹ã€å¤šå°‘çš„å­¦ä¹ ç‡ä»¥åŠä½¿ç”¨å“ªç§æ•°æ®é›†ã€‚ä¸€èˆ¬è®­ç»ƒå¼€å§‹æ—¶ç›´æ¥å°†é…ç½®æ–‡ä»¶åŠ è½½è¿›æ¥ï¼Œè¯»å–ä¸º `dict`ï¼Œç„¶åæ ¹æ®éœ€è¦çš„ `key` è·å¾— `value` å³å¯ï¼Œæ¯”å¦‚ `config["model_type"]`ã€‚

ç„¶è€Œè¿™ç§åšæ³•å­˜åœ¨ä¸€äº›æ½œåœ¨é£é™©ï¼š

1. ç”¨æˆ·å¹¶ä¸çŸ¥é“å¦‚ä½•é…ç½®ã€‚å¦‚æœæ²¡æœ‰è¯¦ç»†çš„é…ç½®æ–‡æ¡£ï¼Œç”¨æˆ·æ˜¯ä¸çŸ¥é“å¯ä»¥è®¾ç½®å“ªäº› `key` ä»¥åŠå¯¹åº”çš„ `value` çš„ã€‚å³ä½¿åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®äº† `model_type`ï¼Œä½ ä¹Ÿæ— æ³•ç¡®å®š `model_type` æ˜¯å¦è¢«è¯»å–å’Œä½¿ç”¨äº†ï¼›
2. è·å–é»˜è®¤å€¼æ—¶çš„æ½œåœ¨é£é™©ï¼Œä¾‹å¦‚ `config.get("model_type", "ResNet")`ã€‚è¿™ç§å†™æ³•ä»¤äººâ€œå®³æ€•â€ï¼Œå³ä½¿ä½ çš„ `key` å†™é”™äº†ï¼Œä»£ç ä¾ç„¶æ­£å¸¸æ‰§è¡Œï¼›
3. ç¼–å†™ä»£ç è¿‡ç¨‹ä¸­å¿ƒæ™ºè´Ÿæ‹…è¿‡é‡ã€‚å³ä½¿å¼€å‘è€…çŸ¥é“ `config` æœ‰å“ªäº› `key`ï¼Œä¹Ÿä¼šæ‹…å¿ƒè‡ªå·±çš„ `key` æ˜¯ä¸æ˜¯å†™é”™äº†ã€‚

é’ˆå¯¹ä¸Šè¿°é—®é¢˜ï¼Œç¬”è€…å¼€å‘äº†ä¸€ä¸ªå°å·¥å…· [`json-schema-to-class`](<https://github.com/FebruaryBreeze/json-schema-to-class>)ã€‚å¯ä»¥ä½¿ç”¨ `pip3` å®‰è£…ï¼ˆPython 3.6+ï¼‰ï¼š

```bash
pip3 install json-schema-to-class
```

è¯¥å·¥å…·çš„ç›®çš„å°±æ˜¯é€šè¿‡ `JSON Schema` æ¥æŒ‡å¯¼å’Œçº¦æŸå¼€å‘è€…å’Œç”¨æˆ·ï¼š

1. ç”¨æˆ·å¯ä»¥å‚è€ƒ Schema æ–‡ä»¶æ¥ç¼–å†™é…ç½®æ–‡ä»¶ï¼›
2. Schema æ–‡ä»¶é™„å¸¦å‚æ•°é»˜è®¤å€¼åŠå‚æ•°æè¿°ï¼›
3. é€šè¿‡è¿è¡Œæ—¶è¯»å– schema æ–‡ä»¶å¹¶ç¼–è¯‘ä¸º Python Class ä»£ç ï¼Œä½¿å¾—å¼€å‘è€…åœ¨å¼€å‘è¿‡ç¨‹ä¸­è·å¾—è¶³å¤Ÿçš„ä»£ç æç¤ºï¼Œè§„é¿äº†ç›´æ¥å†™ `key` çš„çƒ¦æ¼ã€‚

ç›´æ¥å‚è€ƒä¸€ä¸ªç°æœ‰çš„ demo å§ï¼š[torch-basic-models](https://github.com/FebruaryBreeze/torch-basic-models)ã€‚è¯¥é¡¹ç›®æä¾›äº†ä¸¤ä¸ªåŸºç¡€çš„ PyTorch æ¨¡å‹ä»£ç ï¼šResNet å’Œ MobileNetV2ã€‚ä¸¤ä¸ªæ¨¡å‹å…·æœ‰ä¸åŒé…ç½®é¡¹ï¼Œå…¶ Schema æ”¾ç½®äº [torch_basic_models/schema](https://github.com/FebruaryBreeze/torch-basic-models/tree/master/torch_basic_models/schema)ã€‚ä»¥ `ResNet` ä¸ºä¾‹ï¼Œå…¶Schema å®šä¹‰å¦‚ä¸‹ï¼š

```json
{
  "$schema": "http://json-schema.org/draft-04/schema#",
  "title": "res_net_config",
  "description": "ResNet Model Config",
  "type": "object",
  "properties": {
    "layers_list": {
      "type": "array",
      "items": {
        "type": "integer"
      },
      "default": [3, 4, 6, 3]
    },
    "feature_dim": {
      "type": "integer",
      "default": 1000
    }
  },
  "additionalProperties": false
}
```

ç”¨æˆ·å¯ä»¥è½»æ¾çš„çŸ¥é“é…ç½®é¡¹ç›®åŒ…æ‹¬ `layers_list` å’Œ `feature_dim`ï¼Œå³ä½¿æ²¡æœ‰å†™æ˜ `description` ä¹Ÿèƒ½çŒœåˆ°å¯¹åº”çš„å«ä¹‰ã€‚è€Œå¼€å‘è€…å¯ä»¥é€šè¿‡ [torch_basic_models/configs/\_\_init\_\_.py](<https://github.com/FebruaryBreeze/torch-basic-models/blob/master/torch_basic_models/configs/__init__.py>) è°ƒç”¨ `json-schema-to-class` åŠ¨æ€ç”Ÿæˆ `torch_basic_models/configs/build/resnet_config.py`ï¼š

```python
from typing import List


class ResNetConfig:
    def __init__(self, values: dict = None):
        values = values if values is not None else {}
        self.layers_list: List[int] = values.get("layers_list", [3, 4, 6, 3])
        self.feature_dim: int = values.get("feature_dim", 1000)
```

è¿›è€Œåœ¨ç¼–å†™ä»£ç è¿‡ç¨‹ç›´æ¥è®¿é—® Python å¯¹è±¡æ¥è·å–é…ç½®é¡¹ï¼Œå¹¶ä¸”é™„å¸¦ä»£ç æç¤ºä¸è‡³äºçŠ¯å°é”™è¯¯ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è¯¦ç»†ç ”ç©¶ä¸‹è¿™ä¸ªå°é¡¹ç›®ã€‚

### Command Line Argument

Python è‡ªå¸¦çš„ `argparse` å¯ä»¥è¯»å–å‘½ä»¤è¡Œå‚æ•°ï¼Œç„¶è€Œé…ç½®å‚æ•°é¡¹å’Œè¯»å–å‚æ•°å€¼æ—¶ä¾ç„¶ä¸å¤Ÿæ–¹ä¾¿ã€‚ä»¥ PyTorch å®˜æ–¹çš„ ImageNet è®­ç»ƒé¡¹ç›®ä¸ºä¾‹ï¼š

```python
parser = argparse.ArgumentParser(description='PyTorch ImageNet Training')
parser.add_argument('data', metavar='DIR',
                    help='path to dataset')
parser.add_argument('-a', '--arch', metavar='ARCH', default='resnet18',
                    choices=model_names,
                    help='model architecture: ' +
                        ' | '.join(model_names) +
                        ' (default: resnet18)')
parser.add_argument('-j', '--workers', default=4, type=int, metavar='N',
                    help='number of data loading workers (default: 4)')
parser.add_argument('--epochs', default=90, type=int, metavar='N',
                    help='number of total epochs to run')
parser.add_argument('--start-epoch', default=0, type=int, metavar='N',
                    help='manual epoch number (useful on restarts)')

# ...

def main():
    args = parser.parse_args()

    if args.seed is not None:
        random.seed(args.seed)
        torch.manual_seed(args.seed)
        cudnn.deterministic = True
        warnings.warn('You have chosen to seed training. '
                      'This will turn on the CUDNN deterministic setting, '
                      'which can slow down your training considerably! '
                      'You may see unexpected behavior when restarting '
                      'from checkpoints.')

    if args.gpu is not None:
        warnings.warn('You have chosen a specific GPU. This will completely '
                      'disable data parallelism.')

    if args.dist_url == "env://" and args.world_size == -1:
        args.world_size = int(os.environ["WORLD_SIZE"])
```

åŒæ ·ä»¤äººâ€œå®³æ€•ğŸ˜¨â€ã€‚ç¬”è€…åŒæ ·åˆ©ç”¨ `JSON Schema` å¼€å‘äº† [`argparse-schema`](<https://github.com/FebruaryBreeze/argparse-schema>) æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚è¯¥å·¥å…·åŒæ ·å¯ä»¥ä½¿ç”¨ `pip3` ç›´æ¥å®‰è£…ï¼Œé€šè¿‡è¯»å– Schema æ–‡ä»¶æ¥æ„å»º `argparse.ArgumentParser` å¯¹è±¡ã€‚Schema ä¸¾ä¾‹ [`tests/argument_config.json`](https://github.com/FebruaryBreeze/argparse-schema/blob/master/tests/argument_config.json)ï¼š

```json
{
  "$schema": "http://json-schema.org/draft-04/schema#",
  "title": "argument_config",
  "description": "Arg-parse Schema UnitTest",
  "type": "object",
  "properties": {
    "config": {
      "type": "string",
      "description": "path of config file"
    },
    "resume": {
      "type": "boolean",
      "description": "resume from checkpoint or not"
    },
    "scale": {
      "type": "number",
      "default": 1.0,
      "description": "scale of image"
    }
  },
  "required": [
    "config"
  ]
}
```

å¯ä»¥é€šè¿‡å¦‚ä¸‹çš„ Python ä»£ç è°ƒç”¨ï¼š

```python
# demo.py
import argparse_schema

print(argparse_schema.parse(schema='./tests/argument_config.json'))
```

æ‰§è¡Œï¼š

```bash
python3 demo.py --config /path/to/config.py
#> {'config': '/path/to/config.py', 'resume': False, 'scale': 1.0}
```

ä¹Ÿå¯ä»¥é€šè¿‡æä¾›çš„ CLI å·¥å…·æŸ¥çœ‹ Argument Schema å¯¹åº”çš„å‘½ä»¤è¡Œå¸®åŠ©ï¼š

```bash
argparse-schema --schema_path tests/argument_config.json
#> Show help for [tests/argument_config.json]:
#> usage: argparse-schema [-h] --config CONFIG [--resume] [--scale SCALE]
#>
#> Arg-parse Schema UnitTest
#>
#> optional arguments:
#>   -h, --help       show this help message and exit
#>   --config CONFIG  path of config file
#>   --resume         resume from checkpoint or not
#>   --scale SCALE    scale of image
```

ä¸ `json-schema-to-class` ç»“åˆåï¼Œå¯ä»¥å¾—åˆ°æ›´ä¸º Fancy çš„ç»“æœï¼Œå¯ä»¥æ‰“å¼€è„‘æ´æƒ³ä¸€ä¸‹ã€‚

### References

1. JSON Schema, [https://json-schema.org](https://json-schema.org)