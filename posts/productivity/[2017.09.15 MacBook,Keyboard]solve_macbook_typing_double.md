# è§£å†³ MacBook é”®ç›˜åŒå‡»é—®é¢˜

æ‰‹ä¸Šçš„ MacBook Pro æ˜¯ 2016 å¹´å¹´åº•ä¹°çš„ï¼Œè‡³ä»Šä¸€å¹´éƒ½æ²¡åˆ°ã€‚å‰ä¸€æ®µæ—¶é—´å°±å‡ºç°äº† b é”®æœ‰æ—¶å€™æŒ‰ä¸€ä¸‹å‡ºæ¥ä¸¤ä¸ªå­—ç¬¦çš„é—®é¢˜ã€‚æœ€è¿‘å‡ å¤© n é”®ä¹Ÿå‡ºç°äº†ç›¸åŒçš„é—®é¢˜ã€‚è¿™ä¸ªäº‹ä»¶è¿˜æ˜¯æœ‰æ¦‚ç‡ä¼šå‘ç”Ÿï¼Œæ‰“å­—çš„æ—¶å€™è®©äººéå¸¸ä¸çˆ½ã€‚

æˆ‘åœ¨ç½‘ä¸ŠæŸ¥äº†ä¸€ä¸‹ï¼Œå‡ºç°ç±»ä¼¼é—®é¢˜çš„ä¸æ­¢æˆ‘ä¸€ä¸ªäººã€‚çœ‹èµ·æ¥æ˜¯æ–°å‡ºçš„è´è¶é”®ç›˜å“æ§çš„é—®é¢˜ã€‚æœ‰äººè¯´æ‹¿å»é€ä¿®äº†ï¼Œä¿®å®Œäº†è¿˜æ˜¯æœ‰è¿™ä¸ªé—®é¢˜ã€‚æ‰€ä»¥æˆ‘å°±ä¸€ç›´å¿ç€ï¼Œå¿ç€å¿ç€å¿ç€å¿ä¸äº†äº†ğŸ˜‚å“ªæœ‰æ‰“å­—ï¼Œæ‰“åˆ°ä¸€åŠï¼Œå‘ç°å¤šäº†ä¸ª nï¼Œå†å›æ¥åˆ é™¤çš„é“ç†ï¼

æ‰€ä»¥ï¼Œä»Šå¤©è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼

### 1. æ€è·¯

1. ç¡¬ä»¶æ–¹æ¡ˆ
   1. é€ä¿®ï¼šå¤§æ¦‚ç‡ä¿®ä¸å¥½ï¼Œè€Œä¸”éº»çƒ¦
   2. å¤–æ¥é”®ç›˜ï¼šä¸æ–¹ä¾¿ï¼Œå‡ºé—¨å¸¦é”®ç›˜éº»çƒ¦
2. è½¯ä»¶æ–¹æ¡ˆ

æ€ç´¢ä¸€ä¸‹è½¯ä»¶æ–¹æ¡ˆã€‚é¦–å…ˆåˆ†æåŒå‡»çš„äº‹ä»¶çš„åŸå› ï¼ŒçŒœæµ‹æ˜¯æŒ‰ä¸‹ n é”®åï¼Œè§¦å‘ `KeyDown`ï¼Œé‡Šæ”¾ n é”®åï¼Œè§¦å‘ `KeyUp`ï¼›è€Œåæ‰‹æŠ¬èµ·çš„è¿‡ç¨‹ä¸­ï¼Œæ„å¤–åœ°å†ä¸€æ¬¡è§¦å‘äº† `KeyDown` å’Œ `KeyUp`ã€‚è¿™ä¸­é—´çš„æ—¶é—´å¾ˆçŸ­ã€‚

å¦‚æœè¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦å®ç°çš„åŠŸèƒ½å°±æ˜¯ï¼šåˆ†æå½“å‰çš„ `KeyDown` äº‹ä»¶ï¼Œä¸ä¸Šä¸€æ¬¡è¯¥é”®çš„ `KeyUp` æ—¶é—´é—´éš”ã€‚å¦‚æœå¼‚å¸¸çš„çŸ­ï¼Œè¯´æ˜æ˜¯é”®ç›˜å¯¼è‡´çš„åŒå‡»äº‹ä»¶ï¼Œåˆ™å¿½ç•¥è¯¥ `KeyDown` ä¿¡å·ã€‚

æœ‰äº†æ€è·¯ä¹‹åï¼Œå†è€ƒè™‘å¦‚ä½•å®ç°è¯¥åŠŸèƒ½ã€‚macOS ä¸Šæœ‰ä¸€å¤§æ‰¹é”®ç›˜ç›¸å…³çš„è½¯ä»¶ï¼ŒåŒ…æ‹¬æ”¶è´¹çš„ [Keyboard Maestro](https://www.keyboardmaestro.com/)ï¼Œå¼€æºçš„ [Karabiner-Elements](https://github.com/tekezo/Karabiner-Elements)ï¼Œè¿˜æœ‰é’ˆå¯¹è‡ªå®šä¹‰å¿«æ·é”®çš„ [Hammerspoon](http://www.hammerspoon.org/)ã€‚ç¬”è€…éƒ½å°è¯•äº†ä¸€éä¹‹åï¼Œå‘ç°å¹¶ä¸å®¹æ˜“åœ¨è¿™äº›è½¯ä»¶ä¸Šå®ç°éœ€æ±‚ã€‚

åªèƒ½é è‡ªå·±å†™äº†ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘æ˜¯ä¸ªè½¯ä»¶å·¥ç¨‹å¸ˆ :D

### 2. å®ç°

é¦–å…ˆï¼Œæœç´¢ç›¸å…³çš„æ–¹æ¡ˆã€‚éœ€æ±‚ä¸ºæ‹¦æˆªå…¨å±€çš„é”®ç›˜ä¿¡å·ï¼Œæœç´¢è¯ä¸º "macOS global keyboard event"ã€‚

çœ‹äº†ä¸€äº›æœç´¢ç»“æœä¹‹åï¼Œå‘ç°äº†ä¸€æ®µä¸é”™çš„ä»£ç ï¼š[Global keyboard hook for OSX](https://gist.github.com/quietcricket/8313195)ï¼Œä½œè€…ä¸º [quietcricket](https://gist.github.com/quietcricket)ï¼Œå››å¹´å‰ä¸Šä¼ çš„ã€‚ä»£ç å®ç°çš„åŠŸèƒ½ä¸ºè°ƒæ¢ a é”®å’Œ z é”®ã€‚æŒ‰ç…§ä»£ç ä¸­æç¤ºçš„ç¼–è¯‘å‘½ä»¤ç¼–è¯‘ï¼ŒæˆåŠŸã€‚

æ‰§è¡Œï¼Œæç¤º Accessibility é—®é¢˜ï¼Œä¸€èˆ¬æ¶‰åŠåˆ°å…¨å±€é”®ç›˜çš„è½¯ä»¶éƒ½ä¼šéœ€è¦ Accessibility æˆæƒã€‚åœ¨è®¾ç½®ä¸­æ‰¾åˆ° `Security & Privacy` â†’ `Accessibility`ã€‚ç¬”è€…æ˜¯åœ¨ iTerm2 ä¸­æ‰§è¡Œç¼–è¯‘åçš„ binary çš„ï¼Œæ‰€ä»¥æ‰“å¼€ iTerm2 çš„æˆæƒã€‚å†æ¬¡æ‰§è¡Œï¼ŒOKã€‚æµ‹è¯•ï¼Œå…¨å±€çš„ a é”®å’Œ z é”®ç¡®å®è¢«è°ƒæ¢äº†ï¼ŒåŒ…æ‹¬å¿«æ·é”®ã€‚

é˜…è¯»ä»£ç ã€‚ä»£ç ä¸­ï¼š

```c
// Swap 'a' (keycode=0) and 'z' (keycode=6).
if (keycode == (CGKeyCode)0)
  keycode = (CGKeyCode)6;
else if (keycode == (CGKeyCode)6)
  keycode = (CGKeyCode)0;
```

å®ç°äº†è°ƒæ¢çš„åŠŸèƒ½ã€‚ç¨‹åºä½¿ç”¨äº† C ç¼–å†™ï¼Œå¯ä»¥ç›´æ¥å°†ä»£ç åç¼€åæ”¹æˆ C++ï¼Œä½¿ç”¨ G++ ç¼–è¯‘ã€‚åŠ ä¸Šæ‰“å° keycode çš„åŠŸèƒ½ï¼Œå°±å¯ä»¥çœ‹åˆ°æ‰€æœ‰æŒ‰é”®çš„ keycode å€¼äº†ã€‚ç»è¿‡æµ‹è¯•ï¼Œn é”®å’Œ b é”®çš„ keycode å€¼ä¸º 45 å’Œ 11ã€‚

ä½¿ç”¨ chrono è·å–æŒ‰é”® `KeyUp` æ—¶çš„æ—¶é—´ç‚¹ï¼Œå¹¶è®°å½•ï¼›åœ¨ `KeyDown` æ—¶åˆ¤æ–­ï¼Œå¦‚æœä¸ä¸Šæ¬¡ `KeyUp` çš„æ—¶é—´é—´éš”è¿‡çŸ­ï¼Œåˆ™å¿½ç•¥è¯¥äº‹ä»¶ã€‚æœ€ç»ˆä»£ç å¦‚ä¸‹ï¼š

```C++
// alterkeys.c
// http://osxbook.com
//
// You need superuser privileges to create the event tap, unless accessibility
// is enabled. To do so, select the "Enable access for assistive devices"
// checkbox in the Universal Access system preference pane.

// modified by SF-Zhou
// To: Kill Double Typing on MacBook
// Complile: g++ -O2 -Wall -o kill_double_typing kill_double_typing.cpp -framework ApplicationServices
// Run: ./kill_double_typing

#include <ApplicationServices/ApplicationServices.h>
#include <iostream>
#include <chrono>
#include <unordered_map>
using namespace std;

typedef chrono::time_point<std::chrono::high_resolution_clock> Time;
typedef long long ll;

unordered_map<CGKeyCode, Time> last_time;

Time time_now() {
  return chrono::high_resolution_clock::now();
}

// This callback will be invoked every time there is a keystroke.
CGEventRef myCGEventCallback(CGEventTapProxy proxy, CGEventType type, CGEventRef event, void *refcon) {
  // Paranoid sanity check.
  if ((type != kCGEventKeyDown) && (type != kCGEventKeyUp)) {
    return event;
  }

  // The incoming keycode.
  CGKeyCode keycode = (CGKeyCode)CGEventGetIntegerValueField(event, kCGKeyboardEventKeycode);

  // printf("%d\n", keycode);  // print keycode
  if (keycode == 11 /* b */ || keycode == 45 /* n */) {
    if (type == kCGEventKeyUp) {
      last_time[keycode] = time_now();
    } else {
      if (last_time.count(keycode)) {
        ll microseconds = chrono::duration_cast<chrono::microseconds>(
          time_now() - last_time[keycode]
        ).count();

        // ignore if time less than 30ms
        if (microseconds < 30000) {
          return NULL;
        }
      }
    }
  }

  // Set the modified keycode field in the event.
  CGEventSetIntegerValueField(event, kCGKeyboardEventKeycode, (int64_t)keycode);

  // We must return the event for it to be useful.
  return event;
}

int main(void) {
  CFMachPortRef      eventTap;
  CGEventMask        eventMask;
  CFRunLoopSourceRef runLoopSource;

  // Create an event tap. We are interested in key presses.
  eventMask = ((1 << kCGEventKeyDown) | (1 << kCGEventKeyUp));
  eventTap = CGEventTapCreate(kCGSessionEventTap, kCGHeadInsertEventTap, 0, eventMask, myCGEventCallback, NULL);
  if (!eventTap) {
      fprintf(stderr, "failed to create event tap\n");
      exit(1);
  }

  // Create a run loop source.
  runLoopSource = CFMachPortCreateRunLoopSource(kCFAllocatorDefault, eventTap, 0);

  // Add to the current run loop.
  CFRunLoopAddSource(CFRunLoopGetCurrent(), runLoopSource, kCFRunLoopCommonModes);

  // Enable the event tap.
  CGEventTapEnable(eventTap, true);

  // Set it all running.
  CFRunLoopRun();

  // In a real program, one would have arranged for cleaning up.

  exit(0);
}
```

å°†ä¸Šè¿°ä»£ç å‘½åä¸º `kill_double_typing.cpp`ï¼Œç¼–è¯‘ï¼š

```bash
g++ -O2 -Wall -o kill_double_typing kill_double_typing.cpp -framework ApplicationServices
```

ç¼–è¯‘åå¾—åˆ°å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ nohup å‘½ä»¤ï¼Œå°†å…¶è®¾ä¸ºåå°æ‰§è¡Œã€‚åšå¾—æ›´å¤æ‚ä¸€ç‚¹çš„ï¼Œå¯ä»¥è®¾ç½®ä¸ºè‡ªåŠ¨å¯åŠ¨ï¼Œå°±è‡ªå·±æœç´¢å•¦ã€‚

### 3. æ€»ç»“

ç›®å‰åªæ˜¯ä¸€ä¸ªéå¸¸åˆçº§çš„ç‰ˆæœ¬ï¼Œè¿˜æœ‰å¾ˆå¤šå¯ä»¥è°ƒä¼˜çš„åœ°æ–¹ï¼Œç¬”è€…ä¼šæ…¢æ…¢æ”¹è¿›è¿™ä¸ªå°ç¨‹åºçš„ã€‚

è½¯ä»¶çš„æ–¹å¼æ˜¯å¾ˆæœ‰å±€é™æ€§çš„ï¼Œæœ€å¥½çš„æ–¹æ¡ˆï¼Œå½“ç„¶æ˜¯æé«˜è‹¹æœçš„å“æ§å•¦ï¼Œä¸è¿‡æˆ‘è¯´æ˜¯æ²¡ç”¨çš„ğŸ˜‚ã€‚