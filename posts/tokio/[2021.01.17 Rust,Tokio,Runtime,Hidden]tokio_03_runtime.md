# Tokio 源码分析「三、运行时 Runtime」

Tokio 的核心是一套 M:N 的协程 Runtime，下层通过 Rust 协程和 Mio 驱动，支撑上层的 HTTP / RPC 应用。本篇开始分析 Runtime，代码版本 [v1.0.2](https://github.com/tokio-rs/tokio/tree/tokio-1.0.2)。

![Tokio 架构图 from tokio.rs](../images/5e364463cf50f41fec2e028df84f6a4a.svg)

### 1. 概览

在阅读核心代码前，先介绍一下异步编程中的核心关键字：

**Asynchrony**：异步指事件的发生与主程序流及处理此类事件的方式无关。这些事件可能是像信号这样的外部事件，或者是由程序引发的动作，会和程序的执行同时发生，而程序不会阻塞地等待结果。简而言之，事件发生在非调用方的线程中。同步与异步关注的是事件是否是在本线程中处理。

**Non-blocking**：非阻塞指执行的操作不会阻塞程序的继续执行。阻塞与非阻塞关注的是调用方等待结果时的状态。阻塞非阻塞和同步异步是正交的，即存在同步阻塞、同步非阻塞、异步阻塞、异步非阻塞。

**Resumable Function**：可恢复函数指可以暂停执行并从调用中返回，并且可以在将来从暂停的位置恢复执行的函数。可恢复函数是协程的基石。

**Asynchronous Runtime**：异步运行时，上述概念的整合，通过可恢复函数、挂起位置埋点和用户态调度实现非抢占式的用户态线程切换，称之为协程。一般将同步阻塞 IO 的位置作为默认的挂起位置。

Tokio 库的代码量十分巨大，[`tokio/src`](https://github.com/tokio-rs/tokio/tree/tokio-1.0.2/tokio/src) 目录下共计 242 个代码文件，行数 5w+。核心代码的文件结构为：

```
tokio/src
├── blocking.rs
├── coop.rs
├── fs
├── future
├── io
├── lib.rs
├── loom
├── macros
├── net
├── park
├── process
├── runtime
├── signal
├── sync
├── task
├── time
└── util
```

再来看官方提供的样例：

```rust
use tokio::net::TcpListener;
use tokio::io::{AsyncReadExt, AsyncWriteExt};

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    let mut listener = TcpListener::bind("127.0.0.1:8080").await?;

    loop {
        let (mut socket, _) = listener.accept().await?;

        tokio::spawn(async move {
            let mut buf = [0; 1024];

            // In a loop, read data from the socket and write the data back.
            loop {
                let n = match socket.read(&mut buf).await {
                    // socket closed
                    Ok(n) if n == 0 => return,
                    Ok(n) => n,
                    Err(e) => {
                        eprintln!("failed to read from socket; err = {:?}", e);
                        return;
                    }
                };

                // Write the data back
                if let Err(e) = socket.write_all(&buf[0..n]).await {
                    eprintln!("failed to write to socket; err = {:?}", e);
                    return;
                }
            }
        });
    }
}
```

如果之前接触过协程和网络编程，肯定会赞叹上方 Echo Server 的高效和简洁。

### References

1. ["Announcing Tokio 1.0", *tokio.rs*](https://tokio.rs/blog/2020-12-tokio-1-0)
2. ["Asynchrony (computer programming)", *Wikipedia*](https://en.wikipedia.org/wiki/Asynchrony_(computer_programming))
3. ["Asynchronous I/O", *Wikipedia*](https://en.wikipedia.org/wiki/Asynchronous_I/O)
4. ["async is not nonblocking", *Wikipedia*](https://en.wikipedia.org/wiki/Talk:Asynchronous_I/O#async_is_not_nonblocking)

