# C++ Macro: Number of Arguments

åœ¨ C++ ä¸­ä¸å»ºè®®ä½¿ç”¨å®ï¼Œå¯¹äºåŸå…ˆ C ä¸­å¤§é‡ä½¿ç”¨å®çš„åœºæ™¯ï¼Œå‡å»ºè®®ä½¿ç”¨å…¶ä»–æ–¹å¼æ›¿ä»£ï¼Œæ¯”å¦‚ä½¿ç”¨ `const` å¸¸é‡å’Œ `enum` æšä¸¾é‡ä»£æ›¿å®å®šä¹‰çš„å¸¸é‡ï¼Œä½¿ç”¨ `template` æ¨¡ç‰ˆå‡½æ•°/æ¨¡æ¿ç±»æ›¿ä»£å®å®šä¹‰çš„å‡½æ•°æ®µã€‚ä½†æŸäº›åœºæ™¯ä¸‹å®ä¾ç„¶æ˜¯ä¸å¯æ›¿ä»£çš„ï¼Œä¾‹å¦‚ä»£ç çš„æ¡ä»¶ç¼–è¯‘ã€å‡½æ•°å¤æ‚æµç¨‹æ§åˆ¶ã€‚æœ¬æ–‡ä¸»è¦è®²è¿°å¦‚ä½•åœ¨å˜é•¿å‚æ•°çš„å®é‡Œç¡®å®šå‚æ•°çš„ä¸ªæ•°åŠå…¶åº”ç”¨ã€‚

### 1. å®ä¸­çš„å˜é•¿å‚æ•°

ä» C++ 11 å¼€å§‹ï¼Œå®å¼€å§‹æ”¯æŒå˜é•¿å‚æ•°ï¼Œä¾‹å¦‚ï¼š

```c++
#define Array(...) { __VA_ARGS__ }
#define Print(fmt, ...) printf(fmt, ##__VA_ARGS__)

int main() {
  int a[] = Array(1, 2, 3);  // int a[] = {1, 2, 3};
  int b[] = Array();         // int b[] = {};

  Print("OK");            // printf("OK");
  Print("%d, %d", 1, 2);  // printf("%d, %d", 1, 2);
}
```

ç‚¹å‡»[æ­¤å¤„](https://godbolt.org/z/uVUwWq)æŸ¥çœ‹åœ¨çº¿ç¼–è¯‘ç»“æœã€‚ä½¿ç”¨ `__VA_ARGS__` ä»£æ›¿å‚æ•°åˆ—è¡¨ï¼Œå’Œæ¨¡æ¿ä¸­çš„å˜é•¿å‚æ•° `Args...` ç±»ä¼¼ã€‚å¯ä»¥ä½¿ç”¨ `g++ -std=c++11 -E` å¾—åˆ°å®å±•å¼€åçš„ä»£ç ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ `Print("OK")` ä¼šè¢«å±•å¼€æˆ `printf("OK")`ï¼Œå®é‡Œé¢ `fmt` åé¢çš„é€—å·è¢«è‡ªåŠ¨çœç•¥äº†ã€‚è¿™å¹¶éæ˜¯ C++ æ ‡å‡†ï¼Œè€Œæ˜¯ç¼–è¯‘å™¨çš„ç‰¹æ€§ï¼Œgcc å’Œ clang å‡å®ç°äº†è¯¥ç‰¹æ€§ã€‚ä¸‹æ–‡æˆªå–è‡ª[æ–‡çŒ®1](https://en.cppreference.com/w/cpp/preprocessor/replace)ï¼š

> Note: some compilers offer an extension that allows ## to appear after a comma and before `__VA_ARGS__`, in which case the ## does nothing when the variable arguments are present, but removes the comma when the variable arguments are not present: this makes it possible to define macros such as `fprintf (stderr, format, ##__VA_ARGS__)`.

### 2. å˜é•¿å‚æ•°çš„é•¿åº¦

C++ æ ‡å‡†ä¸­å¹¶æ²¡æœ‰ç›´æ¥æä¾›ä¸€ç§æ–¹æ³•æ¥è·å– `__VA_ARGS__` å˜é•¿å‚æ•°çš„é•¿åº¦ï¼Œä½†äººæ°‘çš„æ™ºæ…§æ˜¯æ— ç©·æ— å°½çš„ï¼Œå‚è€ƒ[æ–‡çŒ® 2](https://stackoverflow.com/questions/2124339/c-preprocessor-va-args-number-of-arguments) å’Œ[æ–‡çŒ® 3](https://stackoverflow.com/questions/3046889/optional-parameters-with-c-macros/3048361) ä¸­å°±æä¾›äº†ä¸€äº›å¥‡æŠ€æ·«å·§æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç®€å•æ¥è¯´æ˜¯è¿™æ ·ï¼š

```c++
#define TENTH(_1, _2, _3, _4, _5, _6, _7, _8, _9, N, ...) N
#define COUNT(...) TENTH(__VA_ARGS__, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0)

int main() {
  COUNT(2);
  COUNT(2, 3);
  COUNT(2, 3, 3);
}
```

ç‚¹å‡»[æ­¤å¤„](https://godbolt.org/z/HhM46C)æŸ¥çœ‹åœ¨çº¿ç¼–è¯‘ç»“æœã€‚é¦–å…ˆå®šä¹‰ä¸ªåä¸º `TENTH` çš„å®ï¼Œæ¥è·å–å‚æ•°åˆ—è¡¨ä¸­çš„ç¬¬åä¸ªå‚æ•°ï¼›å†å®šä¹‰ä¸€ä¸ª `COUNT` å®ï¼Œå°† `__VA_ARGS__` å’Œ 9 åˆ° 1 è¿èµ·æ¥ä¹‹åï¼Œè¿”å›å…¶ç¬¬åä½ã€‚å¦‚æœ `__VA_ARGS__` çš„é•¿åº¦ä¸º 1ï¼Œé‚£ä¹ˆè¿”å›çš„æ•°å€¼åˆšå¥½æ˜¯ 1ï¼Œä»¥æ­¤ç±»æ¨ã€‚è¿™é‡Œçš„ `TENTH` å¯ä»¥æŒ‰éœ€æ±‚æ”¹æˆæ›´é•¿çš„å®ã€‚

ä½†è¯¥å®æœ‰ä¸€ä¸ªä¸¥é‡çš„ `bug`ï¼Œå³å½“å‚æ•°ä¸ºç©ºæ—¶ï¼Œä»ç„¶ä¼šè¿”å› 1ã€‚å…¶åŸå› ä¸ºï¼š

```c++
COUNT()
-> TENTH(, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0)
-> 1
```

`__VA_ARGS__` è™½ç„¶ä¸ºç©ºï¼Œä½†æ˜¯å…¶åé¢çš„é€—å·å´ä¾ç„¶ä¼šä¿ç•™ï¼Œå¹¶å æ®ä¸€ä¸ªå‚æ•°çš„ä½ç½®ã€‚å¦‚æœä½¿ç”¨ C++ 20ï¼Œé‚£ä¹ˆä½¿ç”¨ `__VA_OPT__` å®ä¾¿å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†ç›®å‰ä½¿ç”¨ 20 æ˜¯ä¸ç°å®çš„ã€‚å¯¹äº C++ 11ï¼Œå¦‚æœä½¿ç”¨ G++ï¼Œå¹¶ä½¿ç”¨ `-std=gnu++11` æ ‡å‡†ï¼Œåˆ™å¯ä»¥é€šè¿‡ä»¥ä¸‹æŠ€å·§è§£å†³è¯¥é—®é¢˜ï¼š

```c++
#define ELEVENTH(_1, _2, _3, _4, _5, _6, _7, _8, _9, _10, N, ...) N
#define COUNT(...) ELEVENTH(dummy, ##__VA_ARGS__, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0)

int main() {
  COUNT();
  COUNT(2);
  COUNT(2, 3);
  COUNT(2, 3, 3);
}
```

ç‚¹å‡»[æ­¤å¤„](https://godbolt.org/z/wDzRpE)æŸ¥çœ‹åœ¨çº¿ç¼–è¯‘ç»“æœã€‚é€šè¿‡ `,##__VA_ARGS__` ä¸ºç©ºæ—¶è‡ªåŠ¨çœç•¥é€—å·çš„æ–¹å¼ï¼Œå·§å¦™çš„è§„é¿è¿™ä¸ªé—®é¢˜ã€‚ä½†ä½¿ç”¨ `-std=c++11` æ—¶è¯¥ trick å¤±æ•ˆï¼Œå¯ä»¥ç‚¹å‡»[æ­¤å¤„](https://godbolt.org/z/cgmXBB)æŸ¥çœ‹ï¼Œæ•…è¯¥æ–¹æ³•å¹¶ä¸èƒ½å¾ˆå¥½çš„æ¨å¹¿ä½¿ç”¨ã€‚

ä»¥ä¸Šè§£å†³æ–¹æ¡ˆå‡å±äºåœ¨é¢„å¤„ç†æœŸé—´è·å¾—å‚æ•°é•¿åº¦ã€‚å¦‚æœå°†èŒƒå›´æ‹“å±•è‡³ç¼–è¯‘æœŸï¼Œé‚£ä¹ˆè¿˜å¯ä»¥é€šè¿‡ C++ çš„æ¨¡æ¿æ–¹æ³•è§£å†³è¯¥é—®é¢˜ï¼š

```c++
#include <cstdio>
#include <tuple>

#define COUNT(...) \
  std::tuple_size<decltype(std::make_tuple(__VA_ARGS__))>::value

int main() {
  printf("%d\n", COUNT());
  printf("%d\n", COUNT(2));
  printf("%d\n", COUNT(2, 3));
  printf("%d\n", COUNT(2, 3, 3));
}
```

ç‚¹å‡»[æ­¤å¤„](https://godbolt.org/z/G8eE2V)æŸ¥çœ‹åœ¨çº¿ç¼–è¯‘ç»“æœã€‚

### 3. æ¥è¿‘â€å›¾çµå®Œå¤‡â€œçš„å®

ç½‘ç»œä¸Šæœ‰å¹¿æ³›çš„å…³äºå®æ˜¯å¦æ˜¯å›¾çµå®Œå¤‡çš„è®¨è®ºï¼Œä¾‹å¦‚å‚è€ƒ[æ–‡çŒ® 4](https://stackoverflow.com/questions/3136686/is-the-c99-preprocessor-turing-complete) å’Œå‚è€ƒ[æ–‡çŒ® 5](https://www.zhihu.com/question/36183392)ã€‚åœ¨ä½¿ç”¨ä¸€äº›æŠ€å·§ã€ä½¿å¾—å®å¯ä»¥å¾ˆå¤šæ¬¡å±•å¼€çš„æƒ…å†µä¸‹ï¼Œç¬”è€…å€¾å‘äºè®¤ä¸ºå®æ˜¯æ¥è¿‘å›¾çµå®Œå¤‡çš„ã€‚æ—¢ç„¶å·²ç»æ¥è¿‘å›¾çµå®Œå¤‡äº†ï¼Œé‚£ä¹ˆå˜é•¿å‚æ•°ä¸ºç©ºçš„é—®é¢˜å°±ä¸€å®šå¯ä»¥è§£å†³ã€‚å®é™…ä¸Š[å‚è€ƒæ–‡çŒ® 6](http://jhnet.co.uk/articles/cpp_magic) ä¸­ç¡®å®æœ‰è§£å†³æ–¹æ¡ˆï¼Œä¸€ä¸ªåä¸º `HAS_ARGS` çš„å®ï¼Œè¿™é‡Œç®€åŒ–å¦‚ä¸‹ï¼š

```c++
#define CAT(a, b) a##b
#define FIRST(first, ...) first
#define SECOND(first, second, ...) second
#define IS_PROBE(...) SECOND(__VA_ARGS__, 0)
#define PROBE() ~, 1
#define NOT(x) IS_PROBE(CAT(_NOT_, x))
#define _NOT_0 PROBE()
#define BOOL(x) NOT(NOT(x))
#define HAS_ARGS(...) BOOL(FIRST(_END_OF_ARGUMENTS_ __VA_ARGS__)())
#define _END_OF_ARGUMENTS_() 0

int main() {
  HAS_ARGS();      // 0
  HAS_ARGS(1);     // 1
  HAS_ARGS(1, 2);  // 1
}
```

ç‚¹å‡»[æ­¤å¤„](https://godbolt.org/z/jT4mqx)æŸ¥çœ‹åœ¨çº¿ç¼–è¯‘ç»“æœã€‚è¿™é‡Œç”¨åˆ°äº†å…±è®¡ 10 ä¸ªå®ï¼Œéå¸¸å®Œç¾åœ°åœ¨é¢„å¤„ç†æœŸå®ç°äº†å˜é•¿å‚æ•°æ˜¯å¦ä¸ºç©ºçš„åˆ¤æ–­ã€‚æœ‰äº†è¿™ä¸ªå®ï¼Œå†åŠ ä¸Š `IF_ELSE`ï¼Œå°±å¯ä»¥å®ç°å®Œç¾çš„ã€C++ 11 å…¼å®¹çš„å˜é•¿å‚æ•°é•¿åº¦è·å–ï¼š

```c++
#define CAT(a, b) a##b
#define FIRST(first, ...) first
#define SECOND(first, second, ...) second
#define IS_PROBE(...) SECOND(__VA_ARGS__, 0)
#define PROBE() ~, 1
#define NOT(x) IS_PROBE(CAT(_NOT_, x))
#define _NOT_0 PROBE()
#define BOOL(x) NOT(NOT(x))
#define HAS_ARGS(...) BOOL(FIRST(_END_OF_ARGUMENTS_ __VA_ARGS__)())
#define _END_OF_ARGUMENTS_() 0

#define IF_ELSE(condition) _IF_ELSE(BOOL(condition))
#define _IF_ELSE(condition) CAT(_IF_, condition)
#define _IF_1(...) __VA_ARGS__ _IF_1_ELSE
#define _IF_0(...) _IF_0_ELSE
#define _IF_1_ELSE(...)
#define _IF_0_ELSE(...) __VA_ARGS__

#define TENTH(_1, _2, _3, _4, _5, _6, _7, _8, _9, N, ...) N
#define COUNT(...)               \
  IF_ELSE(HAS_ARGS(__VA_ARGS__)) \
  (TENTH(__VA_ARGS__, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0))(0)

int main() {
  COUNT();         // 0
  COUNT(2);        // 1
  COUNT(2, 3);     // 2
  COUNT(2, 3, 3);  // 3
}
```

ç‚¹å‡»[æ­¤å¤„](https://godbolt.org/z/taaXeQ)æŸ¥çœ‹åœ¨çº¿ç¼–è¯‘ç»“æœã€‚[å‚è€ƒæ–‡çŒ® 6](http://jhnet.co.uk/articles/cpp_magic) ä¸­è¿˜ä»‹ç»äº†å®é€’å½’çš„å®ç°ï¼Œæœ‰å…´è¶£å¯ä»¥ç»§ç»­å­¦ä¹ ä¸€ä¸‹ã€‚

### 4. å˜é•¿å‚æ•°çš„åº”ç”¨

è´¹åŠ²åƒè¾›ä¸‡è‹¦ï¼Œè·å¾—äº†å®å†…å˜é•¿å‚æ•°çš„é•¿åº¦ï¼Œå…·ä½“æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿç®€å•æ¥è¯´ï¼Œå¯ä»¥é€šè¿‡å‚æ•°é•¿åº¦çš„åˆ¤æ–­ï¼Œå®ç°å®å‡½æ•°çš„é‡è½½ï¼Œå¹¶ä¸”æ˜¯é¢„å¤„ç†æœŸçš„é‡è½½ã€‚ä¸¾ä¸ªä¾‹å­ğŸŒ°ï¼š

```c++
#define CHECK_RET(expr) \
  do {                  \
    int _ret = (expr);  \
    if (_ret != 0) {    \
      return _ret;      \
    }                   \
  } while (0)
```

è¿™æ˜¯ç¬”è€… 17 å¹´åœ¨ä¸€å®¶å…¬å¸å®ä¹ æ—¶å­¦ä¼šçš„æŠ€å·§ã€‚C++ å¾ˆå¤šé¡¹ç›®ä¸­ä½¿ç”¨è¿”å›ç è€Œéå¼‚å¸¸æ¥è¿›è¡Œé”™è¯¯å¤„ç†ï¼Œå½“è¿”å›å€¼é 0 æ—¶å³ä¸ºå‡ºé”™ï¼Œå¾ˆå¤šåœºæ™¯ä¸‹å¯ä»¥ç›´æ¥è¿”å›è¯¥é”™è¯¯ç ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨ `CHECK_RET` å®ã€‚å¦‚æœæœ‰éœ€è¦å‡ºé”™æ—¶è¿”å›æŒ‡å®šå€¼ï¼Œé‚£ä¹ˆæ­£å¸¸æ¥è¯´å°±éœ€è¦å¢åŠ ä¸€ä¸ªæ–°çš„å®ã€‚ä½†ä½¿ç”¨å®çš„é‡è½½çš„è¯ï¼Œå°±å¯ä»¥è¿™æ ·å®ç°ï¼š

```c++
#define CHECK_RET(expr, ...)                                    \
  do {                                                          \
    int _ret = (expr);                                          \
    if (_ret != 0) {                                            \
      return IF_ELSE(HAS_ARGS(__VA_ARGS__))(__VA_ARGS__)(_ret); \
    }                                                           \
  } while (0)

int main() {
  CHECK_RET(1);
  // do { int _ret = (1); if (_ret != 0) { return _ret; } } while (0);
  CHECK_RET(1, 233);
  // do { int _ret = (1); if (_ret != 0) { return 233 ; } } while (0);
}
```

ç‚¹å‡»[æ­¤å¤„](https://godbolt.org/z/tJ5UwQ)æŸ¥çœ‹åœ¨çº¿ç¼–è¯‘ç»“æœã€‚å½“å˜é•¿å‚æ•°é•¿åº¦ä¸º 0 æ—¶ï¼Œç›´æ¥è¿”å›é”™è¯¯ç ï¼›å½“å˜é•¿å‚æ•°é•¿åº¦ä¸º 1 æ—¶ï¼Œè¿”å›æŒ‡å®šé”™è¯¯ç ã€‚

### References

1. ["Replacing text macros", *C++ Reference*](https://en.cppreference.com/w/cpp/preprocessor/replace)
2. ["C++ preprocessor `__VA_ARGS__` number of arguments", *Stack Overflow*](https://stackoverflow.com/questions/2124339/c-preprocessor-va-args-number-of-arguments)
3. ["Optional Parameters with C++ Macros", *Stack Overflow*](https://stackoverflow.com/questions/3046889/optional-parameters-with-c-macros/3048361)
4. ["Is the C99 preprocessor Turing complete?", *Stack Overflow*](https://stackoverflow.com/questions/3136686/is-the-c99-preprocessor-turing-complete)
5. ["Cè¯­è¨€çš„å®æ˜¯å›¾çµå®Œå¤‡çš„å—ï¼Ÿ", çŸ¥ä¹](https://www.zhihu.com/question/36183392)
6. ["C Pre-Processor Magic", *Jhnet Blog*](http://jhnet.co.uk/articles/cpp_magic)
