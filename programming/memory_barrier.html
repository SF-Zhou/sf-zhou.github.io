<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/gitalk.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>内存屏障和内存模型 | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> 内存屏障和内存模型 </h1>
      </div>
      <div class="info">
        <div class="date"> 2020.06.10 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <h3 id="1.-内存屏障"><a href="#1.-%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C">1. 内存屏障</a></h3>
<p>从维基百科中摘录的定义：</p>
<blockquote>
<p>A <strong>memory barrier</strong>, also known as a <strong>membar</strong>, <strong>memory fence</strong> or <strong>fence instruction</strong>, is a type of <a href="https://en.wikipedia.org/wiki/Barrier_(computer_science)">barrier</a> <a href="https://en.wikipedia.org/wiki/Instruction_(computer_science)">instruction</a> that causes a <a href="https://en.wikipedia.org/wiki/Central_processing_unit">central processing unit</a> (CPU) or <a href="https://en.wikipedia.org/wiki/Compiler">compiler</a> to enforce an <a href="https://en.wikipedia.org/wiki/Memory_ordering">ordering</a> constraint on <a href="https://en.wikipedia.org/wiki/Random-access_memory">memory</a> operations issued before and after the barrier instruction.</p>
</blockquote>
<p>定义来看，内存屏障是用来强制约束屏障指令前后内存操作顺序。现代 CPU 会采用乱序执行、流水线、分支预测、多级缓存等方法提高性能，但这些方法同时也影响了指令<strong>执行</strong>和<strong>生效</strong>的次序。这种乱序对单线程执行是无影响的，执行的结果与原指令顺序执行保持一致，但在多线程环境下则会造成非预期的行为，举个例子（参考文献 2 Example 8-3）：</p>
<pre class="language-nasm"><code class="language-nasm"><span class="token comment">; initially x = y = 0</span>

<span class="token comment">; processor 0</span>
mov <span class="token operator">[</span>_x<span class="token operator">]</span>, <span class="token number">1</span>
mov <span class="token register variable">r1</span>, <span class="token operator">[</span>_y<span class="token operator">]</span>

<span class="token comment">; processor 1</span>
mov <span class="token operator">[</span>_y<span class="token operator">]</span>, <span class="token number">1</span>
mov <span class="token register variable">r2</span>, <span class="token operator">[</span>_x<span class="token operator">]</span>

<span class="token comment">; r1 = r2 = 0 is allowed</span>
</code></pre>
<p>如果严格按顺序执行，<code>r1</code> 和 <code>r2</code> 至少有一个会是 1；但如果有乱序发生，<code>r1</code> 和 <code>r2</code> 的赋值中 <code>x</code> 和 <code>y</code> 的读取发生在 <code>x</code> 和 <code>y</code> 的赋值生效前，那就可能产生 <code>r1 = r2 = 0</code> 的情况。这时候就需要使用内存屏障来约束指令的执行和生效的次序，解决硬件层面的指令重排序和可见性问题。</p>
<p>以 Intel 的 x86 系列 CPU 为例，可以使用 <code>mfence</code> 指令实现内存屏障。<code>mfence</code> 前后的指令会严格以 <code>mfence</code> 为界线，<code>mfence</code> 之前的读写指令会在界线之前完成并全局生效，之后的指令不会重排到界线之前执行。使用 <code>mfence</code> 指令修改上面的例子：</p>
<pre class="language-nasm"><code class="language-nasm"><span class="token comment">; initially x = y = 0</span>

<span class="token comment">; processor 0</span>
mov <span class="token operator">[</span>_x<span class="token operator">]</span>, <span class="token number">1</span>
mfence
mov <span class="token register variable">r1</span>, <span class="token operator">[</span>_y<span class="token operator">]</span>

<span class="token comment">; processor 1</span>
mov <span class="token operator">[</span>_y<span class="token operator">]</span>, <span class="token number">1</span>
mfence
mov <span class="token register variable">r2</span>, <span class="token operator">[</span>_x<span class="token operator">]</span>

<span class="token comment">; r1 = r2 = 0 is not allowed</span>
</code></pre>
<p>除了 <code>mfence</code> 外，<code>lock add</code>、<code>xchg</code> 等指令也可以实现内存屏障的功能，不过一般情况下并不推荐在代码中直接使用这些汇编指令。</p>
<h3 id="2.-内存模型"><a href="#2.-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B">2. 内存模型</a></h3>
<p>高级编程环境一般有自己的高级内存模型并定义了内存可见性语义，其内存模型是建立在硬件内存模型之上的一层抽象，见参考文献 3。高级编程环境一般会提供内存序、互斥量、信号量等同步原语，通过编译器翻译到硬件层的汇编指令，这种情况下一般不需要显式地使用内存屏障指令。</p>
<p>以 C++ 为例，C++ 11 之后提供了原子量和六种内存序来解决多线程下的内存一致性问题。建议先耐心地看完参考文献 5 中 <code>std::memory_order</code> 的描述。下面是笔者的一些理解：</p>
<ol>
<li><code>std::memory_order_relaxed</code> 对原子量只保证原子性；</li>
<li>Release-Acquire 语义，当 <code>x.load(std::memory_order_acquire)</code> 读到 <code>x.store(r, std::memory_order_release)</code> 的修改时，前者后面的指令必定可以读到后者前面指令的修改；</li>
<li>Sequentially-Consistent 语义，包含 Release-Acquire 语义，并且所有线程都以相同的顺序观察到所有 <code>std::memory_order_seq_cst</code> 的修改；</li>
<li><code>std::memory_order</code> 是通过限制本线程内的代码执行和生效顺序，来解决多线程下的内存一致性/可见性问题。</li>
</ol>
<p>高级内存可见性语义与硬件内存屏障语义并不是一一对应的。以 x86 系列 CPU 为例，由于其本身已经具备了强内存一致性语义，C++ 提供的大部分内存序在编译后都会被省略掉，仅会阻止编译器的重排。x86 只会在 Store-Load 情况下产生可见性乱序，举个例子（修改自参考文献 7）：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;bits/stdc++.h></span></span>

<span class="token keyword">void</span> <span class="token function">threadfun</span><span class="token punctuation">(</span>std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token operator">&amp;</span>cnt0<span class="token punctuation">,</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token operator">&amp;</span>cnt1<span class="token punctuation">,</span>
               std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token operator">&amp;</span>x<span class="token punctuation">,</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token operator">&amp;</span>y<span class="token punctuation">,</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// barrier, wait cnt0 increase</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>cnt0 <span class="token operator">==</span> cnt1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    x<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> std<span class="token operator">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// need std::memory_order_seq_cst</span>
    r<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token operator">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>

    cnt1<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> std<span class="token operator">::</span>memory_order_acq_rel<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">alignas</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> cnt0<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">alignas</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> cnt1<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">alignas</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> cnt2<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">alignas</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> x<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">alignas</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> y<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">alignas</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> r1<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">alignas</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> r2<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  std<span class="token operator">::</span>thread <span class="token function">thr1</span><span class="token punctuation">(</span>threadfun<span class="token punctuation">,</span> <span class="token function">ref</span><span class="token punctuation">(</span>cnt0<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ref</span><span class="token punctuation">(</span>cnt1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ref</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ref</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ref</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>thread <span class="token function">thr2</span><span class="token punctuation">(</span>threadfun<span class="token punctuation">,</span> <span class="token function">ref</span><span class="token punctuation">(</span>cnt0<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ref</span><span class="token punctuation">(</span>cnt2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ref</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ref</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ref</span><span class="token punctuation">(</span>r2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    x<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> std<span class="token operator">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
    y<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> std<span class="token operator">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>

    cnt0<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> std<span class="token operator">::</span>memory_order_acq_rel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// barrier, wait cnt1 and cnt2 increase</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>cnt1 <span class="token operator">!=</span> cnt0 <span class="token operator">||</span> cnt2 <span class="token operator">!=</span> cnt0<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>r1 <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> r2 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"store-load reorder"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>代码和第一节中的汇编例子是一致的。即使全部使用了原子量和 Release-Acquire 语义，这里依然会存在 Store-Load 乱序。在 C++ 语言层面上这段代码也是错的，可以仔细揣摩下。下面是笔者的一些观察：</p>
<ol>
<li>当 <code>cnt1==cnt0</code> 时，根据可见性的递推，<code>r1</code> 必定可以读到线程中的修改，其他多线程通信中的可见性问题也与之类似；</li>
<li><a href="https://godbolt.org/z/n-ZJ3L">在 x86 环境下上述代码 <code>x.store</code> 和 <code>y.load</code> 之间不会产生 <code>mfence</code> 或其他内存屏障指令</a>，硬件层面也说明上面的代码是错的；</li>
<li><code>std::atomic::fetch_add</code> 会编译成 <code>lock add</code>，由于自带了内存屏障语义，在 x86 环境下使用任何内存序编译结果都是一样的；</li>
<li><code>std::atomic::load</code> 由于 x86 的强一致性，使用任何内存序编译结果都不会产生内存屏障指令，但使用非 relaxed 内存序时会阻止编译器的重排。</li>
</ol>
<p>上面这段代码有几种修改方法：</p>
<ol>
<li>对 <code>x.store</code> 使用 <code>std::memory_order_seq_cst</code>；</li>
<li>在 <code>x.store</code> 和 <code>y.load</code> 之间增加 <code>std::atomic_thread_fence(std::memory_order_seq_cst)</code>。</li>
</ol>
<h3 id="3.-应用举例"><a href="#3.-%E5%BA%94%E7%94%A8%E4%B8%BE%E4%BE%8B">3. 应用举例</a></h3>
<p>使用原子量实现一个基于 Ring-Buffer 的 MPSC 无锁队列：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;atomic></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cstdint></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;memory></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vector></span></span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
<span class="token keyword">class</span> <span class="token class-name">LockFreeQueue</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">enum</span> <span class="token punctuation">{</span>
    kEmpty <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    kFull <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
    kConflict <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
    kInvalid <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">explicit</span> <span class="token function">LockFreeQueue</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> capacity<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">capacity_</span><span class="token punctuation">(</span>capacity<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">items_</span><span class="token punctuation">(</span>std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">(</span>capacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">uint64_t</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> t <span class="token operator">=</span> tail_<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> h <span class="token operator">=</span> head_<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> h <span class="token operator">-</span> t<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">bool</span> <span class="token function">Empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">bool</span> <span class="token function">Full</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> capacity_<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">int</span> <span class="token function">PopByOneThread</span><span class="token punctuation">(</span>std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token operator">*</span>item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> t <span class="token operator">=</span> tail_<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> h <span class="token operator">=</span> head_<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">==</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> kEmpty<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">auto</span> <span class="token operator">&amp;</span>pop <span class="token operator">=</span> items_<span class="token punctuation">[</span>t <span class="token operator">%</span> capacity_<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pop <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> kConflict<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">*</span>item <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>pop<span class="token punctuation">)</span><span class="token punctuation">;</span>

    tail_<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">int</span> <span class="token function">PushByMultiThread</span><span class="token punctuation">(</span>std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token operator">*</span>item<span class="token punctuation">,</span> <span class="token keyword">int</span> retry_times <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> kInvalid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> retry_times <span class="token operator">||</span> retry_times <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">auto</span> t <span class="token operator">=</span> tail_<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">auto</span> h <span class="token operator">=</span> head_<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">-</span> t <span class="token operator">>=</span> capacity_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> kFull<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>head_<span class="token punctuation">.</span><span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> h <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        item<span class="token operator">-></span><span class="token function">swap</span><span class="token punctuation">(</span>items_<span class="token punctuation">[</span>h <span class="token operator">%</span> capacity_<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> kConflict<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">uint64_t</span><span class="token operator">></span> head_<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">uint64_t</span><span class="token operator">></span> tail_<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> capacity_<span class="token punctuation">;</span>
  std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> items_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">constexpr</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
  <span class="token keyword">constexpr</span> <span class="token keyword">int</span> M <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
  LockFreeQueue<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">queue</span><span class="token punctuation">(</span>N <span class="token operator">*</span> M<span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>thread<span class="token operator">></span> threads<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> M<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    threads<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> item <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span><span class="token function">PushByMultiThread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>item<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> item<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N <span class="token operator">*</span> M<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span><span class="token function">PopByOneThread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>item<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>thread <span class="token operator">:</span> threads<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> queue<span class="token punctuation">.</span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>该队列有一个隐含的假设，即对指针长度的数据读写是原子的，在 x86 上该假设是满足的。通过 CAS 可以实现多线程的 Push，Pop 部分也可以改为 CAS 实现 MPMC 队列。</p>
<p>接下来分析 C++ 层面是否可以优化 <code>std::memory_order</code>。<code>fetch_add</code> 和 <code>compare_exchange_strong</code> 操作均需要被接下来的读取立即读到，所以这里需要用默认的 <code>std::memory_order_seq_cst</code>；<code>tail_.load</code> 和 <code>head_.load</code> 立即读到上次的修改会更好，所以也使用 <code>std::memory_order_seq_cst</code>；这样保持使用默认参数即可。</p>
<p>在 x86 平台上，原子量的 <code>load</code> 操作使用非 <code>std::memory_order_relaxed</code> 的编译结果是一致的；<code>fetch_add</code> 和 CAS 自带内存屏障也没有优化的必要和可能，这样看使用默认参数就已经足够好了。</p>
<h3 id="4.-非对称内存屏障"><a href="#4.-%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C">4. 非对称内存屏障</a></h3>
<p>某些并发算法中会存在简单路径和复杂路径，并且需要内存屏障完成同步。如果全部使用 <code>std::memory_order_seq_cst</code>，会导致简单路径时间成本过高。这时候就可以用上非对称内存屏障，在简单路径中快速执行，将同步的复杂度转移到复杂路径中。以 x86 平台为例，简单路径中可只保证编译器指令不重排，复杂路径中可使用 <code>mprotect</code> 强制所有线程内存一致，可参考 <a href="https://github.com/facebook/folly/blob/master/folly/synchronization/AsymmetricMemoryBarrier.cpp"><code>folly</code> 的实现</a>。这里举个例子（<a href="https://wandbox.org/permlink/rjXzHCCEDl1fPblZ">在线执行</a>）：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;bits/stdc++.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h></span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cassert></span></span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">CreatePage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">auto</span> ptr <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> PROT_READ<span class="token punctuation">,</span> MAP_PRIVATE <span class="token operator">|</span> MAP_ANONYMOUS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>ssize_t<span class="token operator">></span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Optimistically try to lock the page so it stays resident. Could make the</span>
  <span class="token comment">// heavy barrier faster.</span>
  <span class="token keyword">auto</span> r <span class="token operator">=</span> <span class="token function">mlock</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Do nothing.</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">HeavyBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">auto</span> page <span class="token operator">=</span> <span class="token function">CreatePage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// This function is required to be safe to call on shutdown, so we must leak</span>
  <span class="token comment">// the mutex.</span>
  <span class="token keyword">static</span> std<span class="token operator">::</span>mutex mutex<span class="token punctuation">;</span>
  std<span class="token operator">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">></span> <span class="token function">lg</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// We want to downgrade the page while it is resident. To do that, it must</span>
  <span class="token comment">// first be upgraded and forced to be resident.</span>
  <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">mprotect</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Force the page to be resident. If it is already resident, almost no-op.</span>
  <span class="token operator">*</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>page<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">// Downgrade the page. Forces a memory barrier in every core running any of</span>
  <span class="token comment">// the process's threads. On a sane platform.</span>
  r <span class="token operator">=</span> <span class="token function">mprotect</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> PROT_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">LightBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">""</span> <span class="token operator">:</span> <span class="token operator">:</span> <span class="token operator">:</span> <span class="token string">"memory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">threadfun</span><span class="token punctuation">(</span>std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token operator">&amp;</span>cnt0<span class="token punctuation">,</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token operator">&amp;</span>cnt1<span class="token punctuation">,</span>
               std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token operator">&amp;</span>x<span class="token punctuation">,</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token operator">&amp;</span>y<span class="token punctuation">,</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token operator">&amp;</span>r<span class="token punctuation">,</span>
               <span class="token keyword">int</span> barrier_type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// barrier, wait cnt0 increase</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>cnt0 <span class="token operator">==</span> cnt1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    x<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> std<span class="token operator">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>barrier_type <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">LightBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">HeavyBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    r<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token operator">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>

    cnt1<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> std<span class="token operator">::</span>memory_order_acq_rel<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">alignas</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> cnt0<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">alignas</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> cnt1<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">alignas</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> cnt2<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">alignas</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> x<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">alignas</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> y<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">alignas</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> r1<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">alignas</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> r2<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  std<span class="token operator">::</span>thread <span class="token function">thr1</span><span class="token punctuation">(</span>threadfun<span class="token punctuation">,</span> <span class="token function">ref</span><span class="token punctuation">(</span>cnt0<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ref</span><span class="token punctuation">(</span>cnt1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ref</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ref</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ref</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>thread <span class="token function">thr2</span><span class="token punctuation">(</span>threadfun<span class="token punctuation">,</span> <span class="token function">ref</span><span class="token punctuation">(</span>cnt0<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ref</span><span class="token punctuation">(</span>cnt2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ref</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ref</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ref</span><span class="token punctuation">(</span>r2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    x<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> std<span class="token operator">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
    y<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> std<span class="token operator">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>

    cnt0<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> std<span class="token operator">::</span>memory_order_acq_rel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// barrier, wait cnt1 and cnt2 increase</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>cnt1 <span class="token operator">!=</span> cnt0 <span class="token operator">||</span> cnt2 <span class="token operator">!=</span> cnt0<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>r1 <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> r2 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"store-load reorder"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>显然这里 <code>HeavyBarrier</code> 的成本是比较高的，所以使用上需要慎重，类似 Hazard Pointer 这种简单路径非常频繁就比较适合。好消息是 Linux 4.x 之后提供了 <code>membarrier</code> 系统调用效率更高，可以替代掉这里的 <code>HeavyBarrier</code>。该函数的文档中也有关于非对称内存屏障的说明，见参考文献 10。</p>
<h3 id="references"><a href="#references">References</a></h3>
<ol>
<li><a href="https://en.wikipedia.org/wiki/Memory_barrier">&quot;Memory Barrier&quot;, <em>Wikipedia</em></a></li>
<li><a href="https://software.intel.com/content/www/us/en/develop/download/intel-64-and-ia-32-architectures-sdm-volume-3a-system-programming-guide-part-1.html">&quot;Intel® 64 and IA-32 Architectures Software Developer's Manual Volume 3A: System Programming Guide, Part 1&quot;, <em>Intel</em></a></li>
<li><a href="https://en.cppreference.com/w/cpp/language/memory_model">&quot;std::memory_model&quot;, <em>C++ Reference</em></a></li>
<li><a href="https://en.cppreference.com/w/cpp/atomic/atomic">&quot;std::atomic&quot;, <em>C++ Reference</em></a></li>
<li><a href="https://en.cppreference.com/w/cpp/atomic/memory_order">&quot;std::memory_order&quot;, <em>C++ Reference</em></a></li>
<li><a href="https://zhuanlan.zhihu.com/p/43526907">&quot;volatile与内存屏障总结&quot;, <em>郑传军</em></a></li>
<li><a href="https://zhuanlan.zhihu.com/p/41872203">&quot;X86/GCC memory fence的一些见解&quot;, <em>饶萌</em></a></li>
<li><a href="https://www.zhihu.com/question/24301047/answer/1193956492">&quot;如何理解 C++11 的六种 memory order？&quot;, <em>陈文礼</em></a></li>
<li><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p1202r0.pdf">&quot;P1202: Asymmetric fences&quot;, <em>David Goldblatt</em></a></li>
<li><a href="https://man7.org/linux/man-pages/man2/membarrier.2.html">&quot;membarrier(2)&quot;, <em>Linux manual page</em></a></li>
</ol>

      </div>
      <div id="gitalk-container">
      </div>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2020 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://travis-ci.com/SF-Zhou/sf-zhou.github.io">Travis CI</a>.
        </div>
      </div>
    </div>
    <script src="/dist/gitalk.min.js"></script>
    <script src="/dist/main.js"></script>
  </body>
</html>
