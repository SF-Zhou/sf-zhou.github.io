<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>C++ 静态反射与序列化 | SF-Zhou's Blog</title>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GQ26H3JQ3G"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-GQ26H3JQ3G');
    </script>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> C++ 静态反射与序列化 </h1>
      </div>
      <div class="info">
        <div class="date"> 2022.11.16 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <p>最近使用 FlatBuffers 作为 RPC 的序列化协议时，遇到一些问题：</p>
<ol>
<li>FlatBuffers 支持的数据类型是有限的，特定的数据类型需要在序列化/反序列化时手动进行转换；</li>
<li>FlatBuffers 代码生成的 TableType 并不易用，手动调用 Builder 进行构造容易出错；</li>
<li>FlatBuffers 代码生成的 NativeType 性能堪忧，使用该类型也会丧失无需反序列化的优势。</li>
</ol>
<p>仔细思考了下，当前的项目并不需要支持跨语言的 RPC 调用，只需要处理 C++ 中的序列化/反序列化；易用性反而是需求的重点，各类自定义的数据结构都希望可以方便的进行序列化/反序列化而不需要手动的进行转换。在参考了部分开源项目的思路后，决定抛弃 FlatBuffers、使用 C++ 原生数据结构 + 宏的方式定义类型 Schema、完成序列化/反序列化。</p>
<h3 id="1.-静态反射" tabindex="-1"><a href="#1.-%E9%9D%99%E6%80%81%E5%8F%8D%E5%B0%84">1. 静态反射</a></h3>
<p>静态反射的实现参考 <a href="https://github.com/garbageslam/visit_struct#intrusive-syntax">garbageslam/visit_struct</a> 项目中侵入式定义，它的核心原理是函数的可见范围，及派生类向基类的自动类型转换。举个例子（<a href="https://godbolt.org/z/TGaqKvoMz">在线执行</a>）：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;algorithm></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string_view></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;tuple></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;type_traits></span></span>

<span class="token keyword">namespace</span> reflection <span class="token punctuation">{</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">List</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">struct</span> <span class="token class-name">Append</span><span class="token punctuation">;</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> Ts<span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">struct</span> <span class="token class-name">Append</span><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>tuple<span class="token operator">&lt;</span>Ts<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">></span><span class="token punctuation">,</span> T<span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">using</span> type <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>tuple<span class="token operator">&lt;</span>Ts<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> T<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">64</span><span class="token operator">></span>
<span class="token keyword">struct</span> <span class="token class-name">Rank</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token class-name">Rank</span><span class="token operator">&lt;</span><span class="token class-name">N</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">></span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token operator">></span>
<span class="token keyword">struct</span> <span class="token class-name">Rank</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token punctuation">[</span>maybe_unused<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>tuple<span class="token operator">&lt;</span><span class="token operator">></span> <span class="token function">CollectField</span><span class="token punctuation">(</span>Rank<span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Helper</span> <span class="token punctuation">{</span>
  <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">></span>
  <span class="token keyword">static</span> <span class="token keyword">auto</span> <span class="token function">getFieldInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">decltype</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token double-colon punctuation">::</span><span class="token function">CollectField</span><span class="token punctuation">(</span>Rank<span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">></span>
  <span class="token keyword">using</span> FieldInfoList <span class="token operator">=</span> <span class="token keyword">decltype</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">getFieldInfo</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">></span>
  <span class="token keyword">static</span> <span class="token keyword">constexpr</span> size_t Size <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>tuple_size_v<span class="token operator">&lt;</span>FieldInfoList<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">;</span>

  <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token punctuation">,</span> size_t I<span class="token operator">></span>
  <span class="token keyword">using</span> FieldInfo <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>tuple_element_t<span class="token operator">&lt;</span>I<span class="token punctuation">,</span> FieldInfoList<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">REFL_NOW</span> <span class="token expression"><span class="token keyword">decltype</span><span class="token punctuation">(</span><span class="token function">CollectField</span><span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>reflection<span class="token double-colon punctuation">::</span>Rank<span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">REFL_ADD</span><span class="token expression"><span class="token punctuation">(</span>info<span class="token punctuation">)</span>                                                      </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">static</span> <span class="token double-colon punctuation">::</span>reflection<span class="token double-colon punctuation">::</span>Append<span class="token operator">&lt;</span>REFL_NOW<span class="token punctuation">,</span> <span class="token keyword">decltype</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token operator">></span><span class="token double-colon punctuation">::</span>type <span class="token function">CollectField</span><span class="token punctuation">(</span> </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token double-colon punctuation">::</span>reflection<span class="token double-colon punctuation">::</span>Rank<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>tuple_size_v<span class="token operator">&lt;</span>REFL_NOW<span class="token operator">></span> <span class="token operator">+</span> <span class="token number">1</span><span class="token operator">></span><span class="token punctuation">)</span></span></span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace reflection</span>

<span class="token keyword">namespace</span> thief <span class="token punctuation">{</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">struct</span> <span class="token class-name">Bridge</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__GNUC__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>__clang__<span class="token punctuation">)</span></span></span>
<span class="token comment">// Silence unnecessary warning</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">GCC diagnostic push</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">GCC diagnostic ignored </span><span class="token string">"-Wnon-template-friend"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
  <span class="token keyword">friend</span> <span class="token keyword">auto</span> <span class="token function">ADL</span><span class="token punctuation">(</span>Bridge<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__GNUC__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>__clang__<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">GCC diagnostic pop</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">U</span><span class="token operator">></span>
<span class="token keyword">struct</span> <span class="token class-name">StealType</span> <span class="token punctuation">{</span>
  <span class="token keyword">friend</span> <span class="token keyword">auto</span> <span class="token function">ADL</span><span class="token punctuation">(</span>Bridge<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span>type_identity<span class="token operator">&lt;</span>U<span class="token operator">></span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">Tag</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">Store</span><span class="token operator">></span>
<span class="token keyword">using</span> steal <span class="token operator">=</span> <span class="token keyword">decltype</span><span class="token punctuation">(</span>StealType<span class="token operator">&lt;</span>Tag<span class="token punctuation">,</span> Store<span class="token operator">></span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">Tag</span><span class="token operator">></span>
<span class="token keyword">using</span> retrieve <span class="token operator">=</span> <span class="token keyword">typename</span> <span class="token keyword">decltype</span><span class="token punctuation">(</span><span class="token function">ADL</span><span class="token punctuation">(</span>Bridge<span class="token operator">&lt;</span>Tag<span class="token operator">></span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token double-colon punctuation">::</span>type<span class="token punctuation">;</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace thief</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span>size_t N<span class="token operator">></span>
<span class="token keyword">struct</span> <span class="token class-name">NameWrapper</span> <span class="token punctuation">{</span>
  <span class="token keyword">constexpr</span> <span class="token function">NameWrapper</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>str<span class="token punctuation">)</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> std<span class="token double-colon punctuation">::</span><span class="token function">copy_n</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> N<span class="token punctuation">,</span> string<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">constexpr</span> <span class="token keyword">operator</span> std<span class="token double-colon punctuation">::</span><span class="token function">string_view</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">{</span>string<span class="token punctuation">,</span> N <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">char</span> string<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span>NameWrapper Name<span class="token punctuation">,</span> <span class="token keyword">auto</span> Getter<span class="token operator">></span>
<span class="token keyword">struct</span> <span class="token class-name">FieldInfo</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">constexpr</span> std<span class="token double-colon punctuation">::</span>string_view name <span class="token operator">=</span> Name<span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">constexpr</span> <span class="token keyword">auto</span> getter <span class="token operator">=</span> Getter<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ADD_FIELD</span><span class="token expression"><span class="token punctuation">(</span>NAME<span class="token punctuation">,</span> DEFAULT<span class="token punctuation">)</span>                                       </span><span class="token punctuation">\</span>
 <span class="token expression"><span class="token keyword">protected</span><span class="token operator">:</span>                                                            </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">friend</span> <span class="token keyword">struct</span> <span class="token double-colon punctuation">::</span>reflection<span class="token double-colon punctuation">::</span>Helper<span class="token punctuation">;</span>                                  </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">T</span></span><span class="token punctuation">##</span><span class="token expression">NAME <span class="token operator">:</span> std<span class="token double-colon punctuation">::</span>type_identity<span class="token operator">&lt;</span><span class="token keyword">decltype</span><span class="token punctuation">(</span>DEFAULT<span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>           </span><span class="token punctuation">\</span>
                                                                       <span class="token punctuation">\</span>
 <span class="token expression"><span class="token keyword">public</span><span class="token operator">:</span>                                                               </span><span class="token punctuation">\</span>
  <span class="token expression">T</span><span class="token punctuation">##</span><span class="token expression">NAME<span class="token double-colon punctuation">::</span>type NAME <span class="token operator">=</span> DEFAULT<span class="token punctuation">;</span>                                        </span><span class="token punctuation">\</span>
                                                                       <span class="token punctuation">\</span>
 <span class="token expression"><span class="token keyword">private</span><span class="token operator">:</span>                                                              </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">constexpr</span> <span class="token keyword">auto</span> T</span><span class="token punctuation">##</span><span class="token expression"><span class="token function">NAME</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                             </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token operator">-></span><span class="token double-colon punctuation">::</span>thief<span class="token double-colon punctuation">::</span>steal<span class="token operator">&lt;</span><span class="token keyword">struct</span> <span class="token class-name">T</span></span><span class="token punctuation">##</span><span class="token expression">NAME<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>decay_t<span class="token operator">&lt;</span><span class="token keyword">decltype</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token function">REFL_ADD</span><span class="token punctuation">(</span><span class="token punctuation">(</span>FieldInfo<span class="token operator">&lt;</span>#NAME<span class="token punctuation">,</span> <span class="token operator">&amp;</span>thief<span class="token double-colon punctuation">::</span>retrieve<span class="token operator">&lt;</span><span class="token keyword">struct</span> <span class="token class-name">T</span></span><span class="token punctuation">##</span><span class="token expression">NAME<span class="token operator">></span><span class="token double-colon punctuation">::</span>NAME<span class="token operator">></span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">struct</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
  <span class="token function">ADD_FIELD</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ADD_FIELD</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token keyword">short</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ADD_FIELD</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static_assert</span><span class="token punctuation">(</span>reflection<span class="token double-colon punctuation">::</span>Helper<span class="token double-colon punctuation">::</span>Size<span class="token operator">&lt;</span>A<span class="token operator">></span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static_assert</span><span class="token punctuation">(</span>reflection<span class="token double-colon punctuation">::</span>Helper<span class="token double-colon punctuation">::</span>FieldInfo<span class="token operator">&lt;</span>A<span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">></span><span class="token double-colon punctuation">::</span>name <span class="token operator">==</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static_assert</span><span class="token punctuation">(</span>reflection<span class="token double-colon punctuation">::</span>Helper<span class="token double-colon punctuation">::</span>FieldInfo<span class="token operator">&lt;</span>A<span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">></span><span class="token double-colon punctuation">::</span>name <span class="token operator">==</span> <span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static_assert</span><span class="token punctuation">(</span>reflection<span class="token double-colon punctuation">::</span>Helper<span class="token double-colon punctuation">::</span>FieldInfo<span class="token operator">&lt;</span>A<span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">></span><span class="token double-colon punctuation">::</span>name <span class="token operator">==</span> <span class="token string">"c"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  A a<span class="token punctuation">;</span>
  a<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  a<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
  a<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">;</span>

  std<span class="token double-colon punctuation">::</span><span class="token function">apply</span><span class="token punctuation">(</span>
      <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"name: "</span> <span class="token operator">&lt;&lt;</span> type<span class="token punctuation">.</span>name <span class="token operator">&lt;&lt;</span> <span class="token string">", value: "</span> <span class="token operator">&lt;&lt;</span> a<span class="token punctuation">.</span><span class="token operator">*</span>type<span class="token punctuation">.</span>getter
                    <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token double-colon punctuation">::</span>reflection<span class="token double-colon punctuation">::</span>Helper<span class="token double-colon punctuation">::</span>FieldInfoList<span class="token operator">&lt;</span>A<span class="token operator">></span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * name: a, value: 10
 * name: b, value: 20
 * name: c, value: hello
 */</span>
</code></pre>
<h3 id="2.-序列化" tabindex="-1"><a href="#2.-%E5%BA%8F%E5%88%97%E5%8C%96">2. 序列化</a></h3>
<p>有了静态反射，序列化就变成了一项体力活了。这里参考了 <a href="https://github.com/eyalz800/zpp_bits">eyalz800/zpp_bits</a> 项目中的二进制序列化方式，同时使用 <a href="https://github.com/marzer/tomlplusplus">marzer/tomlplusplus</a> 也实现了一套序列化到 TOML 类型的逻辑。</p>
<h3 id="references" tabindex="-1"><a href="#references">References</a></h3>
<ol>
<li><a href="https://github.com/garbageslam/visit_struct">garbageslam/visit_struct</a></li>
<li><a href="https://github.com/eyalz800/zpp_bits">eyalz800/zpp_bits</a></li>
<li><a href="https://github.com/marzer/tomlplusplus">marzer/tomlplusplus</a></li>
</ol>

      </div>
      <script src="https://giscus.app/client.js"
      data-repo="SF-Zhou/sf-zhou.github.io"
      data-repo-id="MDEwOlJlcG9zaXRvcnk4MDc5ODgwNg=="
      data-category="Announcements"
      data-category-id="DIC_kwDOBNDkVs4CA6GQ"
      data-mapping="title"
      data-reactions-enabled="0"
      data-emit-metadata="0"
      data-input-position="bottom"
      data-theme="preferred_color_scheme"
      data-lang="en"
      crossorigin="anonymous"
      async>
    </script>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2017 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/main.js"></script>
  </body>
</html>
