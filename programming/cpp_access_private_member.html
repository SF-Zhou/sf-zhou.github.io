<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/gitalk.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>C++ 访问类私有成员变量 | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> C++ 访问类私有成员变量 </h1>
      </div>
      <div class="info">
        <div class="date"> 2020.07.01 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <p>首先介绍一下类的数据成员指针。当对类的数据成员执行取址操作时，可以获得类的数据成员指针。本质上是附带类型信息的地址偏移。这部分可以参考文献 1。</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cassert></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdint></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>

<span class="token keyword">struct</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> x<span class="token punctuation">;</span>
  <span class="token keyword">int</span> y<span class="token punctuation">;</span>
  <span class="token keyword">double</span> z<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> A<span class="token double-colon punctuation">::</span><span class="token operator">*</span>a <span class="token operator">=</span> <span class="token operator">&amp;</span>A<span class="token double-colon punctuation">::</span>x<span class="token punctuation">;</span>  <span class="token comment">// a 的类型为 `int A::*`</span>
  <span class="token keyword">int</span> A<span class="token double-colon punctuation">::</span><span class="token operator">*</span>b <span class="token operator">=</span> <span class="token operator">&amp;</span>A<span class="token double-colon punctuation">::</span>y<span class="token punctuation">;</span>
  <span class="token keyword">double</span> A<span class="token double-colon punctuation">::</span><span class="token operator">*</span>c <span class="token operator">=</span> <span class="token operator">&amp;</span>A<span class="token double-colon punctuation">::</span>z<span class="token punctuation">;</span>

  A o<span class="token punctuation">;</span>
  o<span class="token punctuation">.</span><span class="token operator">*</span>a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>  <span class="token comment">// 可以使用 obj.* 运算符访问</span>
  o<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>A<span class="token double-colon punctuation">::</span>y<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>x <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>y <span class="token operator">==</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  a <span class="token operator">=</span> b<span class="token punctuation">;</span>  <span class="token comment">// 同类型可以赋值，本质上是地址偏移</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 与指针大小一致</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>uintptr_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 偏移量为 4</span>

  <span class="token operator">*</span><span class="token punctuation">(</span>uintptr_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 也就可以强行修改值了</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token operator">*</span>a <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 偏移量为 0 时会访问 A::x</span>
<span class="token punctuation">}</span>
</code></pre>
<p>那么如果有类私有数据成员指针，就可以访问对应的私有变量了，但 C++ 并不允许直接对类私有成员取址：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cassert></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdint></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>

<span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">int</span> <span class="token function">X</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> x_<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">int</span> <span class="token function">Y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> y_<span class="token punctuation">;</span> <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">int</span> x_<span class="token punctuation">;</span>
  <span class="token keyword">int</span> y_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  A o<span class="token punctuation">;</span>

  <span class="token keyword">int</span> A<span class="token double-colon punctuation">::</span><span class="token operator">*</span>a<span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>uintptr_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  o<span class="token punctuation">.</span><span class="token operator">*</span>a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">X</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token operator">*</span><span class="token punctuation">(</span>uintptr_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
  o<span class="token punctuation">.</span><span class="token operator">*</span>a <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">Y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// a = &amp;A::x_;  // not allowed</span>
<span class="token punctuation">}</span>
</code></pre>
<p>幸运的是 C++ 模版类的显式实例化会忽略成员访问说明符，<a href="https://en.cppreference.com/w/cpp/language/class_template#Explicit_instantiation">参考文献 3</a>：</p>
<blockquote>
<p>Explicit instantiation definitions ignore member access specifiers: parameter types and return types may be private.</p>
</blockquote>
<p>这也就允许传入类私有成员变量地址。如此设计的原因暂不得知，但利用该规则就可以实现访问任意类的私有成员变量：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cassert></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>

<span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">int</span> <span class="token function">X</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> x_<span class="token punctuation">;</span> <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">int</span> x_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> A<span class="token double-colon punctuation">::</span><span class="token operator">*</span><span class="token function">FiledPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">int</span> A<span class="token double-colon punctuation">::</span><span class="token operator">*</span>M<span class="token operator">></span>
<span class="token keyword">struct</span> <span class="token class-name">Rob</span> <span class="token punctuation">{</span>
  <span class="token keyword">friend</span> <span class="token keyword">int</span> A<span class="token double-colon punctuation">::</span><span class="token operator">*</span><span class="token function">FiledPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> M<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">template</span> <span class="token keyword">struct</span> <span class="token class-name">Rob</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span>A<span class="token double-colon punctuation">::</span>x_<span class="token operator">></span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  A o<span class="token punctuation">;</span>
  o<span class="token punctuation">.</span><span class="token operator">*</span><span class="token function">FiledPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">X</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>说它是奇技淫巧不为过，但某些场景下确实需要这样的黑科技。例如 folly 库中实现的 <code>atomic_shared_ptr</code>，就需要访问标准库 <code>std::shared_ptr</code> 的私有引用计数成员进行<a href="https://github.com/facebook/folly/blob/master/folly/concurrency/detail/AtomicSharedPtr-detail.h">计数的修改</a>。</p>
<p>这种方法还是需要定义几个辅助类，如果想访问标准库中的类私有成员，有没有更简单、直接的技巧呢？有的 :D</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">private</span> <span class="token expression"><span class="token keyword">public</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression"><span class="token keyword">private</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> a<span class="token punctuation">;</span>
  a<span class="token punctuation">.</span>_M_refcount<span class="token punctuation">;</span>  <span class="token comment">// gcc, access private member</span>
<span class="token punctuation">}</span>
</code></pre>
<p>宏替换 <code>private</code> 并不总是有效，不建议在实际项目中使用，仅适用于单元测试场景。实际项目中可以使用 <a href="https://github.com/martong/access_private">access_private</a>，其头文件中定义了一些访问私有成员 / 函数的宏，原理仍然是模版类显式实例化：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cassert></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"access_private.hpp"</span></span>

<span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> m_i <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">ACCESS_PRIVATE_FIELD</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> m_i<span class="token punctuation">)</span>

<span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  A a<span class="token punctuation">;</span>
  <span class="token keyword">auto</span> <span class="token operator">&amp;</span>i <span class="token operator">=</span> access_private<span class="token double-colon punctuation">::</span><span class="token function">m_i</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="references" tabindex="-1"><a href="#references">References</a></h3>
<ol>
<li><a href="https://en.cppreference.com/w/cpp/language/pointer#Pointers_to_data_members">&quot;Pointers to data members&quot;, <em>C++ Reference</em></a></li>
<li><a href="https://en.cppreference.com/w/cpp/language/operator_member_access">&quot;Member access operators&quot;, <em>C++ Reference</em></a></li>
<li><a href="https://en.cppreference.com/w/cpp/language/class_template#Explicit_instantiation">&quot;Explicit instantiation&quot;, <em>C++ Reference</em></a></li>
</ol>

      </div>
      <div id="gitalk-container">
      </div>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2017 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/gitalk.min.js"></script>
    <script src="/dist/main.js"></script>
    <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-61723712-2', 'auto'); ga('send', 'pageview'); </script>
  </body>
</html>
