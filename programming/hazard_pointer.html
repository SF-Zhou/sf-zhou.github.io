<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/gitalk.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>C++ Lock-free Hazard Pointer | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> C++ Lock-free Hazard Pointer </h1>
      </div>
      <div class="info">
        <div class="date"> 2020.07.19 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <h3 id="1.-safe-reclamation-methods"><a href="#1.-safe-reclamation-methods">1. Safe Reclamation Methods</a></h3>
<p>Folly 的 Hazard Pointer 实现中有<a href="https://github.com/facebook/folly/blob/master/folly/synchronization/Hazptr.h">一段注释</a>，详细描述了 C++ 里几种主流的安全内存回收方法，列表如下：</p>
<table>
<thead>
<tr>
<th></th>
<th>优点</th>
<th>缺点</th>
<th>场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>Locking</td>
<td>易用</td>
<td>读高开销 / 抢占式 / 死锁</td>
<td>非性能敏感</td>
</tr>
<tr>
<td>Reference Couting</td>
<td>自动回收 / 线程无关 / 免于死锁</td>
<td>读高开销 / 抢占式</td>
<td>需要自动回收</td>
</tr>
<tr>
<td>Read-copy-update (RCU)</td>
<td>简单 / 高速 / 可拓展</td>
<td>对阻塞敏感</td>
<td>性能敏感</td>
</tr>
<tr>
<td>Hazard Pointer</td>
<td>高速 / 可拓展 / 阻塞场景可用</td>
<td>性能依赖 TLS</td>
<td>性能敏感 / 读多写少</td>
</tr>
</tbody>
</table>
<p>C++ 标准库中提供了锁和引用计数方案。锁的缺点很明显，无论是哪种锁，在读的时候都会产生较大的开销。引用计数则相对好一些，但每次读取都需要修改引用计数，高并发场景下这样的原子操作也会成为性能瓶颈，毕竟原子加对应的 CPU 指令 <code>lock add</code> 也可以看成是微型锁。</p>
<p>Linux 内核中提供了 RCU 方法，笔者目前对此还没有太多的了解。本文主要介绍 Hazard Pointer，一种无锁编程中广泛使用的安全内存回收方法，适用于需要高性能读、读多写少的场景。其论文可参考<a href="https://cs.nyu.edu/courses/fall16/CSCI-GA.3033-017/readings/hazard_pointers.pdf">文献 1</a>，标准草案可参考<a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0566r5.pdf">文献 2</a>，代码实现可参考 Folly 中的 <code>HazPtr</code>。</p>
<h3 id="2.-hazard-pointer"><a href="#2.-hazard-pointer">2. Hazard Pointer</a></h3>
<p>首先回忆下<a href="/programming/atomic_shared_ptr.html#1.-shared-pointer">引用计数的做法</a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;atomic></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory></span></span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">class</span> <span class="token class-name">ReferenceCount</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">ReferenceCount</span><span class="token punctuation">(</span>std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>T<span class="token operator">></span> ptr<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">ptr_</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cnt_</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  T <span class="token operator">*</span><span class="token function">Ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> ptr_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  ReferenceCount <span class="token operator">*</span><span class="token function">Ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">++</span>cnt_<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">Deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>cnt_ <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>T<span class="token operator">></span> ptr_<span class="token punctuation">;</span>
  std<span class="token operator">::</span>atomic_uint32_t cnt_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>仔细观察可以发现：</p>
<ol>
<li>每一次的读取操作对应引用计数中增加的数值 1；</li>
<li>当所有的读取操作都完成时引用计数归 0，此时内存可以安全回收。</li>
</ol>
<p>总结起来，当对象正在使用时，就不能回收内存。每一个“正在使用”都需要对应一个标记，引用计数使用的标记是计数数值一，对应的原子操作性能问题就成为它无法摆脱的原罪。而 Hazard Pointer 使用的标记更为轻巧，一般通过在链表中标记该对象的指针实现，回收时如果发现链表中有对应的指针就不进行内存回收，将标记的复杂度转移到回收部分，也就更适合读多写少的场景。Hazard Pointer 的简单实现（<a href="https://wandbox.org/permlink/qbEzCwR6J31yH5jm">在线执行</a>）：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;atomic></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unordered_set></span></span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">struct</span> <span class="token class-name">HazardPointer</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">class</span> <span class="token class-name">Holder</span> <span class="token punctuation">{</span>
   <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">explicit</span> <span class="token function">Holder</span><span class="token punctuation">(</span>HazardPointer<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token operator">*</span>pointer<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">pointer_</span><span class="token punctuation">(</span>pointer<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">Holder</span><span class="token punctuation">(</span><span class="token keyword">const</span> HazardPointer <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">Holder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> pointer_<span class="token operator">-></span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    T <span class="token operator">*</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> pointer_<span class="token operator">-></span>target_<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token operator">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">operator</span> <span class="token keyword">bool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    T <span class="token operator">*</span><span class="token keyword">operator</span><span class="token operator">-></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    T <span class="token operator">&amp;</span><span class="token keyword">operator</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">*</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

   <span class="token keyword">private</span><span class="token operator">:</span>
    HazardPointer<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token operator">*</span>pointer_<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token operator">~</span><span class="token function">HazardPointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>next_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> next_<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target_<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> std<span class="token operator">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
    active_<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>std<span class="token operator">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> Holder <span class="token function">Acquire</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span>T <span class="token operator">*</span><span class="token operator">></span> <span class="token operator">&amp;</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> pointer <span class="token operator">=</span> <span class="token class-name">HazardPointer</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">Alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      pointer<span class="token operator">-></span>target_ <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token operator">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>pointer<span class="token operator">-></span>target_<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token operator">::</span>memory_order_acquire<span class="token punctuation">)</span> <span class="token operator">!=</span>
             target<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token operator">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">Holder</span><span class="token punctuation">(</span>pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Update</span><span class="token punctuation">(</span>std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span>T <span class="token operator">*</span><span class="token operator">></span> <span class="token operator">&amp;</span>target<span class="token punctuation">,</span> T <span class="token operator">*</span>new_target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> old <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>new_target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Retire</span><span class="token punctuation">(</span>old<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Reclaim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// collect in-use pointers</span>
    std<span class="token operator">::</span>unordered_set<span class="token operator">&lt;</span>T <span class="token operator">*</span><span class="token operator">></span> in_use<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> p <span class="token operator">=</span> head_list_<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token operator">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span> p<span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-></span>next_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      in_use<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>p<span class="token operator">-></span>target_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// delete useless pointers</span>
    List <span class="token operator">*</span>retire_head <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    List <span class="token operator">*</span>retire_tail <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

    <span class="token keyword">auto</span> p <span class="token operator">=</span> retire_list_<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">auto</span> next <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>in_use<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>p<span class="token operator">-></span>target<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">delete</span> p<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        p<span class="token operator">-></span>next <span class="token operator">=</span> retire_head<span class="token punctuation">;</span>
        retire_head <span class="token operator">=</span> p<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>retire_tail <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          retire_tail <span class="token operator">=</span> p<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      p <span class="token operator">=</span> next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>retire_head<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// push to retired list again</span>
      <span class="token keyword">auto</span> <span class="token operator">&amp;</span>tail <span class="token operator">=</span> retire_tail<span class="token operator">-></span>next<span class="token punctuation">;</span>
      <span class="token keyword">do</span> <span class="token punctuation">{</span>
        tail <span class="token operator">=</span> retire_list_<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token operator">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>retire_list_<span class="token punctuation">.</span><span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span>tail<span class="token punctuation">,</span> retire_head<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">static</span> HazardPointer<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token operator">*</span><span class="token function">Alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> p <span class="token operator">=</span> head_list_<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token operator">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span> p<span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-></span>next_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token operator">-></span>active_<span class="token punctuation">.</span><span class="token function">test_and_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> p<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">auto</span> p <span class="token operator">=</span> <span class="token keyword">new</span> HazardPointer<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p<span class="token operator">-></span>active_<span class="token punctuation">.</span><span class="token function">test_and_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      p<span class="token operator">-></span>next_ <span class="token operator">=</span> head_list_<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token operator">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>head_list_<span class="token punctuation">.</span><span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span>p<span class="token operator">-></span>next_<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Retire</span><span class="token punctuation">(</span>T <span class="token operator">*</span>ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> p <span class="token operator">=</span> <span class="token keyword">new</span> List<span class="token punctuation">;</span>
    p<span class="token operator">-></span>target<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      p<span class="token operator">-></span>next <span class="token operator">=</span> retire_list_<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token operator">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>retire_list_<span class="token punctuation">.</span><span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span>p<span class="token operator">-></span>next<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>retire_count_ <span class="token operator">==</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      retire_count_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token function">Reclaim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">struct</span> <span class="token class-name">List</span> <span class="token punctuation">{</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>T<span class="token operator">></span> target<span class="token punctuation">{</span><span class="token keyword">nullptr</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    List <span class="token operator">*</span>next <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span>T <span class="token operator">*</span><span class="token operator">></span> target_<span class="token punctuation">{</span><span class="token keyword">nullptr</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  HazardPointer<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token operator">*</span>next_<span class="token punctuation">;</span>
  std<span class="token operator">::</span>atomic_flag active_ <span class="token operator">=</span> ATOMIC_FLAG_INIT<span class="token punctuation">;</span>

  <span class="token keyword">static</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span>HazardPointer<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token operator">*</span><span class="token operator">></span> head_list_<span class="token punctuation">;</span>
  <span class="token keyword">static</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token operator">></span> retire_count_<span class="token punctuation">;</span>
  <span class="token keyword">static</span> std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span>List <span class="token operator">*</span><span class="token operator">></span> retire_list_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">></span>
std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span>HazardPointer<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token operator">*</span><span class="token operator">></span> HazardPointer<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span>head_list_<span class="token punctuation">{</span><span class="token keyword">nullptr</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">></span>
std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token operator">></span> HazardPointer<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span>retire_count_<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">></span>
std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">HazardPointer</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span>List <span class="token operator">*</span><span class="token operator">></span> HazardPointer<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span>retire_list_<span class="token punctuation">{</span>
    <span class="token keyword">nullptr</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// example</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdint></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector></span></span>

std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> g_count<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">explicit</span> <span class="token function">A</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">value_</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">++</span>g_count<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token operator">~</span><span class="token function">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">--</span>g_count<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">int</span> <span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> value_<span class="token punctuation">;</span> <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">int</span> value_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span>A <span class="token operator">*</span><span class="token operator">></span> target<span class="token punctuation">{</span><span class="token keyword">new</span> <span class="token function">A</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">constexpr</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
  <span class="token keyword">constexpr</span> <span class="token keyword">int</span> M <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
  <span class="token keyword">constexpr</span> <span class="token keyword">int</span> W <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>thread<span class="token operator">></span> threads<span class="token punctuation">;</span>
  std<span class="token operator">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">uint64_t</span><span class="token operator">></span> sum<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> t <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> t <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> <span class="token operator">++</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    threads<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">,</span> t<span class="token punctuation">]</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> M<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> W <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// write less</span>
          <span class="token class-name">HazardPointer</span><span class="token operator">&lt;</span>A<span class="token operator">></span><span class="token operator">::</span><span class="token function">Update</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token function">A</span><span class="token punctuation">(</span>t <span class="token operator">*</span> M <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// read more</span>
          <span class="token keyword">auto</span> holder <span class="token operator">=</span> <span class="token class-name">HazardPointer</span><span class="token operator">&lt;</span>A<span class="token operator">></span><span class="token operator">::</span><span class="token function">Acquire</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
          sum<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span>holder<span class="token operator">-></span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// wait finish</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>thread <span class="token operator">:</span> threads<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">HazardPointer</span><span class="token operator">&lt;</span>A<span class="token operator">></span><span class="token operator">::</span><span class="token function">Reclaim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Remain: %d\n"</span><span class="token punctuation">,</span> g_count<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>简单解释下原理。Hazard Pointer 申请读取时，会在对象链表中申请一个空位置，将对象的指针写入该位置中，读取结束时将该位置重新置空即可；而发生更新时，将更新替换下来的旧指针加入退休列表里，退休列表积攒到一定程度时则检查哪些对象已经不在对象链表中，不再使用的则可以执行删除。</p>
<p>如果使用 <code>std::shared_ptr</code> 实现上述逻辑，你会发现它的执行速度还要高于上述代码。原因在于这里实现的 Hazard Pointer 没有使用非对称内存屏障和线程本地存储优化。如果仔细观察，可以发现 <code>Acquire</code> 函数中使用顺序一致性内部屏障 <code>pointer-&gt;target_ = ...</code>，x86 平台上会翻译为 <code>mfence</code> 指令，与 <code>lock add</code> 指令相比也不遑多让。在读多写少的前提下，可以将读写两边的屏障替换为非对称内存屏障，将读部分的开销转移到写部分中。可参考<a href="/programming/memory_barrier.html#4.-%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C">先前内存屏障博文中的介绍</a>。</p>
<p>另一方面，Hazard Pointer 的高性能依赖于平台上线程本地存储（TLS）的性能。单纯使用 CAS 更新全局的对象链表和退休列表的性能太低，可以使用 TLS 做为缓冲层，这样大部分时间都是更新本线程的数据。这部分可以参考 Folly 中的 <a href="https://github.com/facebook/folly/blob/master/folly/ThreadLocal.h"><code>ThreadLocalPtr</code></a>，其中实现了遍历所有线程 TLS 的黑魔法。</p>
<h3 id="references"><a href="#references">References</a></h3>
<ol>
<li><a href="https://cs.nyu.edu/courses/fall16/CSCI-GA.3033-017/readings/hazard_pointers.pdf">&quot;Hazard Pointers: Safe Memory Reclamation forLock-Free Objects&quot;, <em>Maged M. Michael</em></a></li>
<li><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0566r5.pdf">&quot;Proposed Wording for Concurrent Data Structures: Hazard Pointer and Read­Copy­Update (RCU)&quot;, <em>Open Standards</em></a></li>
</ol>

      </div>
      <div id="gitalk-container">
      </div>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2021 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/gitalk.min.js"></script>
    <script src="/dist/main.js"></script>
    <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-61723712-2', 'auto'); ga('send', 'pageview'); </script>
  </body>
</html>
