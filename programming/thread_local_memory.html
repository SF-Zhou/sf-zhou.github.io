<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>C++ TLS 触发的栈溢出 | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> C++ TLS 触发的栈溢出 </h1>
      </div>
      <div class="info">
        <div class="date"> 2021.06.21 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <p>先看一段代码，猜猜 Linux 下编译后执行会发生什么（编译参数 <code>-pthread -O2 -std=c++11</code>，<a href="https://godbolt.org/z/Pv9o8oeqs">在线执行</a>）：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span>

<span class="token keyword">thread_local</span> <span class="token keyword">char</span> tls<span class="token punctuation">[</span><span class="token number">8</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span> arr<span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  arr<span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'A'</span><span class="token punctuation">;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p %p\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tls<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre>
<p>如果你系统的栈大小是默认的 8MB，那么上述代码会导致栈溢出。原因在于 pthread 实现中 TLS 和线程栈使用的是同一块内存空间，TLS 使用的多时留给线程栈的就少了。</p>
<p>pthread <a href="https://github.com/lattera/glibc/blob/master/nptl/nptl-init.c#L372">初始化时</a>会根据系统设定的栈大小、TLS 占用的内存空间大小计算默认的栈空间：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// 1. 获取 TLS 内存大小</span>
size_t static_tls_align<span class="token punctuation">;</span>
<span class="token function">_dl_get_tls_static_info</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>__static_tls_size<span class="token punctuation">,</span> <span class="token operator">&amp;</span>static_tls_align<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2. 获取系统栈大小</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__getrlimit</span> <span class="token punctuation">(</span>RLIMIT_STACK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>limit<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> limit<span class="token punctuation">.</span>rlim_cur <span class="token operator">==</span> RLIM_INFINITY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  limit<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> ARCH_STACK_DEFAULT_SIZE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 3. 设定 pthread 默认栈大小</span>
<span class="token keyword">const</span> size_t minstack <span class="token operator">=</span> pagesz <span class="token operator">+</span> __static_tls_size <span class="token operator">+</span> MINIMAL_REST_STACK<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>limit<span class="token punctuation">.</span>rlim_cur <span class="token operator">&lt;</span> minstack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  limit<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> minstack<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
limit<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> <span class="token function">ALIGN_UP</span> <span class="token punctuation">(</span>limit<span class="token punctuation">.</span>rlim_cur<span class="token punctuation">,</span> pagesz<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">lll_lock</span> <span class="token punctuation">(</span>__default_pthread_attr_lock<span class="token punctuation">,</span> LLL_PRIVATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
__default_pthread_attr<span class="token punctuation">.</span>stacksize <span class="token operator">=</span> limit<span class="token punctuation">.</span>rlim_cur<span class="token punctuation">;</span>
__default_pthread_attr<span class="token punctuation">.</span>guardsize <span class="token operator">=</span> <span class="token function">GLRO</span> <span class="token punctuation">(</span>dl_pagesize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">lll_unlock</span> <span class="token punctuation">(</span>__default_pthread_attr_lock<span class="token punctuation">,</span> LLL_PRIVATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>pthread_create</code> 时如果没有指定使用的栈大小，则会使用上述计算的<a href="https://github.com/lattera/glibc/blob/master/nptl/allocatestack.c#L429">默认栈大小</a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>attr<span class="token operator">-></span>stacksize <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size <span class="token operator">=</span> attr<span class="token operator">-></span>stacksize<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token function">lll_lock</span> <span class="token punctuation">(</span>__default_pthread_attr_lock<span class="token punctuation">,</span> LLL_PRIVATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  size <span class="token operator">=</span> __default_pthread_attr<span class="token punctuation">.</span>stacksize<span class="token punctuation">;</span>
  <span class="token function">lll_unlock</span> <span class="token punctuation">(</span>__default_pthread_attr_lock<span class="token punctuation">,</span> LLL_PRIVATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>如果担心 TLS 触发栈溢出，可以在程序启动时通过下方代码获取 TLS 需要使用的内存空间总大小（<a href="https://godbolt.org/z/EoEKxhhhf">在线执行</a>），可以根据该值进行阈值的判断：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>

<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">void</span> <span class="token function">_dl_get_tls_static_info</span><span class="token punctuation">(</span>size_t <span class="token operator">*</span>sizep<span class="token punctuation">,</span> size_t <span class="token operator">*</span>alignp<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  size_t size<span class="token punctuation">;</span>
  size_t align<span class="token punctuation">;</span>
  <span class="token function">_dl_get_tls_static_info</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>size<span class="token punctuation">,</span> <span class="token operator">&amp;</span>align<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"size %lu\n"</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="references" tabindex="-1"><a href="#references">References</a></h3>
<ol>
<li><a href="https://www.uclibc.org/docs/tls.pdf">&quot;ELF Handling For Thread-Local Storage&quot;, <em>Ulrich Drepper</em></a></li>
</ol>

      </div>
      <script src="https://giscus.app/client.js"
      data-repo="SF-Zhou/sf-zhou.github.io"
      data-repo-id="MDEwOlJlcG9zaXRvcnk4MDc5ODgwNg=="
      data-category="Announcements"
      data-category-id="DIC_kwDOBNDkVs4CA6GQ"
      data-mapping="title"
      data-reactions-enabled="0"
      data-emit-metadata="0"
      data-input-position="bottom"
      data-theme="preferred_color_scheme"
      data-lang="en"
      crossorigin="anonymous"
      async>
    </script>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2017 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/main.js"></script>
    <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-61723712-2', 'auto'); ga('send', 'pageview'); </script>
  </body>
</html>
