<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/gitalk.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>C++ Macro: Number of Arguments | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> C++ Macro: Number of Arguments </h1>
      </div>
      <div class="info">
        <div class="date"> 2019.11.18 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <p>在 C++ 中不建议使用宏，对于原先 C 中大量使用宏的场景，均建议使用其他方式替代，比如使用 <code>const</code> 常量和 <code>enum</code> 枚举量代替宏定义的常量，使用 <code>template</code> 模版函数/模板类替代宏定义的函数段。但某些场景下宏依然是不可替代的，例如代码的条件编译、函数复杂流程控制。本文主要讲述如何在变长参数的宏里确定参数的个数及其应用。</p>
<h3 id="1.-宏中的变长参数" tabindex="-1"><a href="#1.-%E5%AE%8F%E4%B8%AD%E7%9A%84%E5%8F%98%E9%95%BF%E5%8F%82%E6%95%B0">1. 宏中的变长参数</a></h3>
<p>从 C++ 11 开始，宏开始支持变长参数，例如：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">Array</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> __VA_ARGS__ <span class="token punctuation">}</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">Print</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// int a[] = {1, 2, 3};</span>
  <span class="token keyword">int</span> b<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// int b[] = {};</span>

  <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">"OK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// printf("OK");</span>
  <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">"%d, %d"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// printf("%d, %d", 1, 2);</span>
<span class="token punctuation">}</span>
</code></pre>
<p>点击<a href="https://godbolt.org/z/uVUwWq">此处</a>查看在线编译结果。使用 <code>__VA_ARGS__</code> 代替参数列表，和模板中的变长参数 <code>Args...</code> 类似。可以使用 <code>g++ -std=c++11 -E</code> 得到宏展开后的代码。值得注意的是 <code>Print(&quot;OK&quot;)</code> 会被展开成 <code>printf(&quot;OK&quot;)</code>，宏里面 <code>fmt</code> 后面的逗号被自动省略了。这并非是 C++ 标准，而是编译器的特性，gcc 和 clang 均实现了该特性。下文截取自<a href="https://en.cppreference.com/w/cpp/preprocessor/replace">文献1</a>：</p>
<blockquote>
<p>Note: some compilers offer an extension that allows ## to appear after a comma and before <code>__VA_ARGS__</code>, in which case the ## does nothing when the variable arguments are present, but removes the comma when the variable arguments are not present: this makes it possible to define macros such as <code>fprintf (stderr, format, ##__VA_ARGS__)</code>.</p>
</blockquote>
<h3 id="2.-变长参数的长度" tabindex="-1"><a href="#2.-%E5%8F%98%E9%95%BF%E5%8F%82%E6%95%B0%E7%9A%84%E9%95%BF%E5%BA%A6">2. 变长参数的长度</a></h3>
<p>C++ 标准中并没有直接提供一种方法来获取 <code>__VA_ARGS__</code> 变长参数的长度，但人民的智慧是无穷无尽的，参考<a href="https://stackoverflow.com/questions/2124339/c-preprocessor-va-args-number-of-arguments">文献 2</a> 和<a href="https://stackoverflow.com/questions/3046889/optional-parameters-with-c-macros/3048361">文献 3</a> 中就提供了一些奇技淫巧来解决这个问题，简单来说是这样：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">TENTH</span><span class="token expression"><span class="token punctuation">(</span>_1<span class="token punctuation">,</span> _2<span class="token punctuation">,</span> _3<span class="token punctuation">,</span> _4<span class="token punctuation">,</span> _5<span class="token punctuation">,</span> _6<span class="token punctuation">,</span> _7<span class="token punctuation">,</span> _8<span class="token punctuation">,</span> _9<span class="token punctuation">,</span> N<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> N</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">COUNT</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">TENTH</span><span class="token punctuation">(</span>__VA_ARGS__<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>点击<a href="https://godbolt.org/z/HhM46C">此处</a>查看在线编译结果。首先定义个名为 <code>TENTH</code> 的宏，来获取参数列表中的第十个参数；再定义一个 <code>COUNT</code> 宏，将 <code>__VA_ARGS__</code> 和 9 到 1 连起来之后，返回其第十位。如果 <code>__VA_ARGS__</code> 的长度为 1，那么返回的数值刚好是 1，以此类推。这里的 <code>TENTH</code> 可以按需求改成更长的宏。</p>
<p>但该宏有一个严重的 <code>bug</code>，即当参数为空时，仍然会返回 1。其原因为：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">-></span> <span class="token function">TENTH</span><span class="token punctuation">(</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token operator">-></span> <span class="token number">1</span>
</code></pre>
<p><code>__VA_ARGS__</code> 虽然为空，但是其后面的逗号却依然会保留，并占据一个参数的位置。如果使用 C++ 20，那么使用 <code>__VA_OPT__</code> 宏便可以解决这个问题，但目前使用 20 是不现实的。对于 C++ 11，如果使用 G++，并使用 <code>-std=gnu++11</code> 标准，则可以通过以下技巧解决该问题：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ELEVENTH</span><span class="token expression"><span class="token punctuation">(</span>_1<span class="token punctuation">,</span> _2<span class="token punctuation">,</span> _3<span class="token punctuation">,</span> _4<span class="token punctuation">,</span> _5<span class="token punctuation">,</span> _6<span class="token punctuation">,</span> _7<span class="token punctuation">,</span> _8<span class="token punctuation">,</span> _9<span class="token punctuation">,</span> _10<span class="token punctuation">,</span> N<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> N</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">COUNT</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">ELEVENTH</span><span class="token punctuation">(</span>dummy<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>点击<a href="https://godbolt.org/z/wDzRpE">此处</a>查看在线编译结果。通过 <code>,##__VA_ARGS__</code> 为空时自动省略逗号的方式，巧妙的规避这个问题。但使用 <code>-std=c++11</code> 时该 trick 失效，可以点击<a href="https://godbolt.org/z/cgmXBB">此处</a>查看，故该方法并不能很好的推广使用。</p>
<p>以上解决方案均属于在预处理期间获得参数长度。如果将范围拓展至编译期，那么还可以通过 C++ 的模板方法解决该问题：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdio></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;tuple></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">COUNT</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
  <span class="token expression">std<span class="token operator">::</span>tuple_size<span class="token operator">&lt;</span><span class="token keyword">decltype</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">make_tuple</span><span class="token punctuation">(</span>__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token operator">::</span>value</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>点击<a href="https://godbolt.org/z/G8eE2V">此处</a>查看在线编译结果。</p>
<h3 id="3.-接近”图灵完备“的宏" tabindex="-1"><a href="#3.-%E6%8E%A5%E8%BF%91%E2%80%9D%E5%9B%BE%E7%81%B5%E5%AE%8C%E5%A4%87%E2%80%9C%E7%9A%84%E5%AE%8F">3. 接近”图灵完备“的宏</a></h3>
<p>网络上有广泛的关于宏是否是图灵完备的讨论，例如参考<a href="https://stackoverflow.com/questions/3136686/is-the-c99-preprocessor-turing-complete">文献 4</a> 和参考<a href="https://www.zhihu.com/question/36183392">文献 5</a>。在使用一些技巧、使得宏可以很多次展开的情况下，笔者倾向于认为宏是接近图灵完备的。既然已经接近图灵完备了，那么变长参数为空的问题就一定可以解决。实际上<a href="http://jhnet.co.uk/articles/cpp_magic">参考文献 6</a> 中确实有解决方案，一个名为 <code>HAS_ARGS</code> 的宏，这里简化如下：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">CAT</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> a</span><span class="token punctuation">##</span><span class="token expression">b</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">FIRST</span><span class="token expression"><span class="token punctuation">(</span>first<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> first</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SECOND</span><span class="token expression"><span class="token punctuation">(</span>first<span class="token punctuation">,</span> second<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> second</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">IS_PROBE</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">SECOND</span><span class="token punctuation">(</span>__VA_ARGS__<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PROBE</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">,</span> <span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">NOT</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token function">IS_PROBE</span><span class="token punctuation">(</span><span class="token function">CAT</span><span class="token punctuation">(</span>_NOT_<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_NOT_0</span> <span class="token expression"><span class="token function">PROBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BOOL</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token function">NOT</span><span class="token punctuation">(</span><span class="token function">NOT</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">HAS_ARGS</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">BOOL</span><span class="token punctuation">(</span><span class="token function">FIRST</span><span class="token punctuation">(</span>_END_OF_ARGUMENTS_ __VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_END_OF_ARGUMENTS_</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token number">0</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">HAS_ARGS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 0</span>
  <span class="token function">HAS_ARGS</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 1</span>
  <span class="token function">HAS_ARGS</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 1</span>
<span class="token punctuation">}</span>
</code></pre>
<p>点击<a href="https://godbolt.org/z/jT4mqx">此处</a>查看在线编译结果。这里用到了共计 10 个宏，非常完美地在预处理期实现了变长参数是否为空的判断。有了这个宏，再加上 <code>IF_ELSE</code>，就可以实现完美的、C++ 11 兼容的变长参数长度获取：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">CAT</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> a</span><span class="token punctuation">##</span><span class="token expression">b</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">FIRST</span><span class="token expression"><span class="token punctuation">(</span>first<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> first</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SECOND</span><span class="token expression"><span class="token punctuation">(</span>first<span class="token punctuation">,</span> second<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> second</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">IS_PROBE</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">SECOND</span><span class="token punctuation">(</span>__VA_ARGS__<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PROBE</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">,</span> <span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">NOT</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token function">IS_PROBE</span><span class="token punctuation">(</span><span class="token function">CAT</span><span class="token punctuation">(</span>_NOT_<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_NOT_0</span> <span class="token expression"><span class="token function">PROBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BOOL</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token function">NOT</span><span class="token punctuation">(</span><span class="token function">NOT</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">HAS_ARGS</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">BOOL</span><span class="token punctuation">(</span><span class="token function">FIRST</span><span class="token punctuation">(</span>_END_OF_ARGUMENTS_ __VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_END_OF_ARGUMENTS_</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token number">0</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">IF_ELSE</span><span class="token expression"><span class="token punctuation">(</span>condition<span class="token punctuation">)</span> <span class="token function">_IF_ELSE</span><span class="token punctuation">(</span><span class="token function">BOOL</span><span class="token punctuation">(</span>condition<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_IF_ELSE</span><span class="token expression"><span class="token punctuation">(</span>condition<span class="token punctuation">)</span> <span class="token function">CAT</span><span class="token punctuation">(</span>_IF_<span class="token punctuation">,</span> condition<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_IF_1</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> __VA_ARGS__ _IF_1_ELSE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_IF_0</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> _IF_0_ELSE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_IF_1_ELSE</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_IF_0_ELSE</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> __VA_ARGS__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">TENTH</span><span class="token expression"><span class="token punctuation">(</span>_1<span class="token punctuation">,</span> _2<span class="token punctuation">,</span> _3<span class="token punctuation">,</span> _4<span class="token punctuation">,</span> _5<span class="token punctuation">,</span> _6<span class="token punctuation">,</span> _7<span class="token punctuation">,</span> _8<span class="token punctuation">,</span> _9<span class="token punctuation">,</span> N<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> N</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">COUNT</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>               </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token function">IF_ELSE</span><span class="token punctuation">(</span><span class="token function">HAS_ARGS</span><span class="token punctuation">(</span>__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">(</span><span class="token function">TENTH</span><span class="token punctuation">(</span>__VA_ARGS__<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 0</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 1</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 2</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 3</span>
<span class="token punctuation">}</span>
</code></pre>
<p>点击<a href="https://godbolt.org/z/taaXeQ">此处</a>查看在线编译结果。<a href="http://jhnet.co.uk/articles/cpp_magic">参考文献 6</a> 中还介绍了宏递归的实现，有兴趣可以继续学习一下。</p>
<h3 id="4.-变长参数的应用" tabindex="-1"><a href="#4.-%E5%8F%98%E9%95%BF%E5%8F%82%E6%95%B0%E7%9A%84%E5%BA%94%E7%94%A8">4. 变长参数的应用</a></h3>
<p>费劲千辛万苦，获得了宏内变长参数的长度，具体有什么用呢？简单来说，可以通过参数长度的判断，实现宏函数的重载，并且是预处理期的重载。举个例子🌰：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">CHECK_RET</span><span class="token expression"><span class="token punctuation">(</span>expr<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">do</span> <span class="token punctuation">{</span>                  </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">int</span> _ret <span class="token operator">=</span> <span class="token punctuation">(</span>expr<span class="token punctuation">)</span><span class="token punctuation">;</span>  </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>_ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token keyword">return</span> _ret<span class="token punctuation">;</span>      </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span>                   </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>
</code></pre>
<p>这是笔者 17 年在一家公司实习时学会的技巧。C++ 很多项目中使用返回码而非异常来进行错误处理，当返回值非 0 时即为出错，很多场景下可以直接返回该错误码，也就是使用 <code>CHECK_RET</code> 宏。如果有需要出错时返回指定值，那么正常来说就需要增加一个新的宏。但使用宏的重载的话，就可以这样实现：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">CHECK_RET</span><span class="token expression"><span class="token punctuation">(</span>expr<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>                                    </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">do</span> <span class="token punctuation">{</span>                                                          </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">int</span> _ret <span class="token operator">=</span> <span class="token punctuation">(</span>expr<span class="token punctuation">)</span><span class="token punctuation">;</span>                                          </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>_ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                            </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token keyword">return</span> <span class="token function">IF_ELSE</span><span class="token punctuation">(</span><span class="token function">HAS_ARGS</span><span class="token punctuation">(</span>__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">(</span>_ret<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span>                                                           </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">CHECK_RET</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// do { int _ret = (1); if (_ret != 0) { return _ret; } } while (0);</span>
  <span class="token function">CHECK_RET</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">233</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// do { int _ret = (1); if (_ret != 0) { return 233 ; } } while (0);</span>
<span class="token punctuation">}</span>
</code></pre>
<p>点击<a href="https://godbolt.org/z/tJ5UwQ">此处</a>查看在线编译结果。当变长参数长度为 0 时，直接返回错误码；当变长参数长度为 1 时，返回指定错误码。</p>
<h3 id="references" tabindex="-1"><a href="#references">References</a></h3>
<ol>
<li><a href="https://en.cppreference.com/w/cpp/preprocessor/replace">&quot;Replacing text macros&quot;, <em>C++ Reference</em></a></li>
<li><a href="https://stackoverflow.com/questions/2124339/c-preprocessor-va-args-number-of-arguments">&quot;C++ preprocessor <code>__VA_ARGS__</code> number of arguments&quot;, <em>Stack Overflow</em></a></li>
<li><a href="https://stackoverflow.com/questions/3046889/optional-parameters-with-c-macros/3048361">&quot;Optional Parameters with C++ Macros&quot;, <em>Stack Overflow</em></a></li>
<li><a href="https://stackoverflow.com/questions/3136686/is-the-c99-preprocessor-turing-complete">&quot;Is the C99 preprocessor Turing complete?&quot;, <em>Stack Overflow</em></a></li>
<li><a href="https://www.zhihu.com/question/36183392">&quot;C语言的宏是图灵完备的吗？&quot;, 知乎</a></li>
<li><a href="http://jhnet.co.uk/articles/cpp_magic">&quot;C Pre-Processor Magic&quot;, <em>Jhnet Blog</em></a></li>
</ol>

      </div>
      <div id="gitalk-container">
      </div>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2021 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/gitalk.min.js"></script>
    <script src="/dist/main.js"></script>
    <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-61723712-2', 'auto'); ga('send', 'pageview'); </script>
  </body>
</html>
