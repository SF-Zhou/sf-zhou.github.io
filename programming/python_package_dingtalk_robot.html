<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>Build a Python Package Step by Step | SF-Zhou's Blog</title>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GQ26H3JQ3G"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-GQ26H3JQ3G');
    </script>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> Build a Python Package Step by Step </h1>
      </div>
      <div class="info">
        <div class="date"> 2018.03.14 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <blockquote>
<p>今天是 π 节，祝大家 π 节快乐 :D</p>
</blockquote>
<p>通常大家使用 Python 提供的包的时候，无外乎使用 <code>pip</code> 完成安装，然后在源代码头部使用 <code>import</code> 引入需要的包，再来就可以愉快地使用了。对于初学者来说，可能会困惑，要如何构建这样一个简单易用的包呢？</p>
<p>由此本文应运而生，这里将带大家一步一步实现一个这样的 Python 包。包的功能是封装钉钉群聊中自定义机器人的 HTTP API，方便 Python 用户直接调用该包实现机器人的消息发送。<a href="https://open-doc.dingtalk.com/docs/doc.htm?spm=a219a.7629140.0.0.0I6tty&amp;treeId=257&amp;articleId=105735&amp;docType=1">点击此处可以查看钉钉自定义机器人的文档</a>。</p>
<p>整个过程包含以下几步：</p>
<ol>
<li>编写功能代码；</li>
<li>编写单元测试；</li>
<li>构建 Python 包；</li>
<li>上传 Python 包到 <a href="https://pypi.python.org/pypi/">PyPI</a>；</li>
<li>配置 CI；</li>
<li>配置 CD。</li>
</ol>
<h3 id="1.-编写功能代码" tabindex="-1"><a href="#1.-%E7%BC%96%E5%86%99%E5%8A%9F%E8%83%BD%E4%BB%A3%E7%A0%81">1. 编写功能代码</a></h3>
<p>根据钉钉自定义机器人的文档，可以通过向如下的链接发送 POST 请求来实现发送消息的功能。</p>
<pre class="language-markup"><code class="language-markup">https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxx
</code></pre>
<p>链接中的 <code>xxxxxxxx</code> 为 <code>Token</code>，该值可以在机器人的配置中找到。</p>
<p>发送文本消息需要 POST 的内容如下，发送其他消息类型可以参看文档。</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"msgtype"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span> 
  <span class="token property">"text"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"我就是我, 是不一样的烟火"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>发送 POST 请求的操作可以使用 Python 中的 <code>requests</code> 库来实现，下面就可以写代码了。</p>
<p>这里将该库命名为 <code>dingtalk_robot</code>。找一个空文件夹，新建一个 <code>dingtalk_robot.py</code> 文件。这里确定仅需要一个源代码文件，如果有多个源代码文件，可以建立一个名为 <code>dingtalk_robot</code> 的文件夹，并在该文件夹中使用 <code>__init__.py</code> 引入各个源代码文件。</p>
<p><code>dingtalk_robot.py</code> 中，实现钉钉自定义机器人的 HTTP API：</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> requests


<span class="token keyword">class</span> <span class="token class-name">DingtalkRobot</span><span class="token punctuation">:</span>
    BaseUrl <span class="token operator">=</span> <span class="token string">'https://oapi.dingtalk.com/robot/send?access_token='</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> token<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>token <span class="token operator">=</span> token
        self<span class="token punctuation">.</span>access_url <span class="token operator">=</span> self<span class="token punctuation">.</span>BaseUrl <span class="token operator">+</span> token

    <span class="token keyword">def</span> <span class="token function">send_text</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> content<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        message <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'msgtype'</span><span class="token punctuation">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
            <span class="token string">'text'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">'content'</span><span class="token punctuation">:</span> content
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>self<span class="token punctuation">.</span>access_url<span class="token punctuation">,</span> json<span class="token operator">=</span>message<span class="token punctuation">)</span>
        status <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> status<span class="token punctuation">[</span><span class="token string">'errcode'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> DingtalkRobot<span class="token punctuation">.</span>Error<span class="token punctuation">(</span><span class="token string">'Error Code: {}, {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                status<span class="token punctuation">[</span><span class="token string">'errcode'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                status<span class="token punctuation">[</span><span class="token string">'errmsg'</span><span class="token punctuation">]</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">class</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>ValueError<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
</code></pre>
<p>注意到代码中自定义了一个 <code>Error</code> 类。钉钉自定义机器人的 HTTP 接口有状态返回码，如果返回值异常则抛出这样一个 <code>Error</code>。</p>
<p>另外需要注意 <code>requests</code> 可能也会抛出网络相关的异常类，使用包的过程中同样需要做好异常处理。</p>
<p>至此本步骤完成。</p>
<h3 id="2.-编写单元测试" tabindex="-1"><a href="#2.-%E7%BC%96%E5%86%99%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95">2. 编写单元测试</a></h3>
<p>单元测试，是针对程序模块来进行正确性检验的测试工作。Python 自带了单元测试框架 <code>unittest</code>，<a href="https://docs.python.org/3/library/unittest.html">点击此处可以查看 <code>unittest</code> 的官方文档</a>。</p>
<p>单元测试简单来说，就是在正常使用一个类或者一个函数的功能，并在测试中对比预期结果与运行结果是否一致。如果不一致则说明代码出了问题。</p>
<p>在同上的文件夹中，新建单元测试文件 <code>test_dingtalk_robot.py</code>。按照 <code>unittest</code> 的文档，编写如下的测试代码：</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> unittest
<span class="token keyword">from</span> dingtalk_robot <span class="token keyword">import</span> DingtalkRobot


<span class="token keyword">class</span> <span class="token class-name">MyTestCase</span><span class="token punctuation">(</span>unittest<span class="token punctuation">.</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    valid_token <span class="token operator">=</span> <span class="token string">'e2bfbac46ed921563dcd852ae65b3adc7797db997ea6c2cc75843b74e4365842'</span>
    invalid_token <span class="token operator">=</span> <span class="token string">'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'</span>

    <span class="token keyword">def</span> <span class="token function">test_send_text</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        dingtalk_robot <span class="token operator">=</span> DingtalkRobot<span class="token punctuation">(</span>token<span class="token operator">=</span>self<span class="token punctuation">.</span>valid_token<span class="token punctuation">)</span>
        success <span class="token operator">=</span> dingtalk_robot<span class="token punctuation">.</span>send_text<span class="token punctuation">(</span><span class="token string">'Send text to Dingding'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertTrue<span class="token punctuation">(</span>success<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">test_send_text_to_invalid_token</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        dingtalk_robot <span class="token operator">=</span> DingtalkRobot<span class="token punctuation">(</span>token<span class="token operator">=</span>self<span class="token punctuation">.</span>invalid_token<span class="token punctuation">)</span>
        error_here <span class="token operator">=</span> <span class="token boolean">False</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            dingtalk_robot<span class="token punctuation">.</span>send_text<span class="token punctuation">(</span><span class="token string">'Send text to Dingding'</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> dingtalk_robot<span class="token punctuation">.</span>Error <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            error_here <span class="token operator">=</span> <span class="token boolean">True</span>

        self<span class="token punctuation">.</span>assertTrue<span class="token punctuation">(</span>error_here<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    unittest<span class="token punctuation">.</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>这里分别测试了向正常 <code>token</code> 和异常 <code>token</code> 发送消息。正常 <code>token</code> 发送成功，而异常 <code>token</code> 发送失败抛出异常。</p>
<p>测试代码完成后，可以运行单元测试命令进行测试。这里推荐使用 <code>pytest</code>。使用 <code>pip</code> 安装，然后执行 <code>pytest</code>，得到如下的输出：</p>
<pre class="language-markup"><code class="language-markup">==================== test session starts =====================
platform darwin -- Python 3.6.4, pytest-2.9.2, py-1.4.33, pluggy-0.3.1
benchmark: 3.1.1 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: /Users/sfzhou/Code/07_Python/04_DingtalkRobot, inifile:
plugins: tornado-0.4.5, timeout-1.2.1, pep8-1.0.6, cov-2.5.1, benchmark-3.1.1
collected 2 items

test_dingtalk_robot.py ..

================== 2 passed in 0.52 seconds ==================
</code></pre>
<p>可以看到两个测试均通过，本步骤完成。</p>
<h3 id="3.-构建-python-包" tabindex="-1"><a href="#3.-%E6%9E%84%E5%BB%BA-python-%E5%8C%85">3. 构建 Python 包</a></h3>
<p>接下来可以打包上述的 <code>dingtalk_robot</code> 工具了。Python 的打包还是比较简单的，编写一个 <code>setup.py</code>，写入相关信息即可。<a href="https://packaging.python.org/tutorials/distributing-packages/">点击此处可以查看打包的详细文档</a>。</p>
<p>按照文档，继续新建一个 <code>setup.py</code> 文件，写入如下代码：</p>
<pre class="language-python"><code class="language-python"><span class="token triple-quoted-string string">"""
Python Package for Dingtalk Robot
Author: SF-Zhou
Date: 2018-03-15
"""</span>

<span class="token keyword">import</span> dingtalk_robot
<span class="token keyword">from</span> setuptools <span class="token keyword">import</span> setup


setup<span class="token punctuation">(</span>
    name<span class="token operator">=</span>dingtalk_robot<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span>
    version<span class="token operator">=</span>dingtalk_robot<span class="token punctuation">.</span>__version__<span class="token punctuation">,</span>
    description<span class="token operator">=</span>dingtalk_robot<span class="token punctuation">.</span>__description__<span class="token punctuation">,</span>
    url<span class="token operator">=</span>dingtalk_robot<span class="token punctuation">.</span>__github__<span class="token punctuation">,</span>
    author<span class="token operator">=</span>dingtalk_robot<span class="token punctuation">.</span>__author__<span class="token punctuation">,</span>
    author_email<span class="token operator">=</span>dingtalk_robot<span class="token punctuation">.</span>__email__<span class="token punctuation">,</span>

    license<span class="token operator">=</span><span class="token string">'MIT'</span><span class="token punctuation">,</span>
    classifiers<span class="token operator">=</span><span class="token punctuation">[</span>
        <span class="token string">'Development Status :: 3 - Alpha'</span><span class="token punctuation">,</span>
        <span class="token string">'Intended Audience :: Developers'</span><span class="token punctuation">,</span>
        <span class="token string">'License :: OSI Approved :: MIT License'</span><span class="token punctuation">,</span>
        <span class="token string">'Programming Language :: Python :: 3'</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>

    keywords<span class="token operator">=</span><span class="token string">'tools dingtalk robot'</span><span class="token punctuation">,</span>
    py_modules<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'dingtalk_robot'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    install_requires<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'requests'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    extras_require<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'test'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'pytest'</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre>
<p>可以看到，这里引入了一个 <code>setup</code> 函数，并且向该函数传递了很多关于 <code>dingtalk_robot</code> 的信息。上述的 <code>dingtalk_robot</code> 的信息还需要在 <code>dingtalk_robot.py</code> 中补充，在 <code>dingtalk_robot.py</code> 文件头部可以继续加上：</p>
<pre class="language-python"><code class="language-python">__version__ <span class="token operator">=</span> <span class="token string">'0.0.1'</span>
__author__ <span class="token operator">=</span> <span class="token string">'SF-Zhou'</span>
__email__ <span class="token operator">=</span> <span class="token string">'sfzhou.scut@gmail.com'</span>
__github__ <span class="token operator">=</span> <span class="token string">'https://github.com/SF-Zhou/DingtalkRobot'</span>
__description__ <span class="token operator">=</span> <span class="token string">'Python Package for Dingtalk Robot'</span>
</code></pre>
<p><code>install_requires</code> 参数中描述了该包的依赖，<code>dingtalk_robot</code> 的外部依赖只有 <code>requests</code>。对于一个 Python 项目通常也会使用 <code>requirements.txt</code> 来描述依赖，故而新建一个 <code>requirements.txt</code>，文件内容仅填入一行 <code>requests</code> 即可。当其他人需要手动安装依赖的时候，可以执行：</p>
<pre class="language-bash"><code class="language-bash">pip3 <span class="token function">install</span> <span class="token parameter variable">-r</span> requirements.txt
</code></pre>
<p>各项配置工作均已完成，下面可以执行 <code>build</code> 命令构建包：</p>
<pre class="language-bash"><code class="language-bash">python setup.py build
</code></pre>
<p>可以看到类似如下的输出：</p>
<pre class="language-markup"><code class="language-markup">running build
running build_py
creating build
creating build/lib
copying dingtalk_robot.py -> build/lib
warning: build_py: byte-compiling is disabled, skipping.
</code></pre>
<p>如果希望把该包安装到本地，可以执行：</p>
<pre class="language-bash"><code class="language-bash">python setup.py <span class="token function">install</span>
</code></pre>
<p>这样在本地的环境中，可以直接通过 <code>import dingtalk_robot</code> 来使用该包了。</p>
<p>如果希望可以将该包发布出去，被大家广泛地使用，那还需要构建一个源码包：</p>
<pre class="language-bash"><code class="language-bash">python setup.py sdist
</code></pre>
<p>可以看到类似如下的输出：</p>
<pre class="language-markup"><code class="language-markup">running sdist
running egg_info
creating dingtalk_robot.egg-info
writing dingtalk_robot.egg-info/PKG-INFO
writing dependency_links to dingtalk_robot.egg-info/dependency_links.txt
writing requirements to dingtalk_robot.egg-info/requires.txt
writing top-level names to dingtalk_robot.egg-info/top_level.txt
writing manifest file 'dingtalk_robot.egg-info/SOURCES.txt'
reading manifest file 'dingtalk_robot.egg-info/SOURCES.txt'
writing manifest file 'dingtalk_robot.egg-info/SOURCES.txt'
running check
creating dingtalk_robot-0.0.1
creating dingtalk_robot-0.0.1/dingtalk_robot.egg-info
copying files to dingtalk_robot-0.0.1...
copying README.md -> dingtalk_robot-0.0.1
copying dingtalk_robot.py -> dingtalk_robot-0.0.1
copying setup.py -> dingtalk_robot-0.0.1
copying dingtalk_robot.egg-info/PKG-INFO -> dingtalk_robot-0.0.1/dingtalk_robot.egg-info
copying dingtalk_robot.egg-info/SOURCES.txt -> dingtalk_robot-0.0.1/dingtalk_robot.egg-info
copying dingtalk_robot.egg-info/dependency_links.txt -> dingtalk_robot-0.0.1/dingtalk_robot.egg-info
copying dingtalk_robot.egg-info/requires.txt -> dingtalk_robot-0.0.1/dingtalk_robot.egg-info
copying dingtalk_robot.egg-info/top_level.txt -> dingtalk_robot-0.0.1/dingtalk_robot.egg-info
Writing dingtalk_robot-0.0.1/setup.cfg
creating dist
Creating tar archive
removing 'dingtalk_robot-0.0.1' (and everything under it)
</code></pre>
<p>并且当前文件夹下会多出两个新文件夹：<code>dist</code> 和 <code>dingtalk_robot.egg-info</code>。<code>dist</code> 文件夹中有一个名为 <code>dingtalk_robot-0.0.1.tar.gz</code> 的压缩包，该包的内容为如下：</p>
<figure tabindex="1"><a href="../images/2d5631a9cbc8980f7982958b30a94693.jpg"><img src="../images/2d5631a9cbc8980f7982958b30a94693.jpg" alt=""></a></figure>
<p>可以看到这里包含了源代码文件，还有一些 INFO 文件。将该文件发布出去，其他人也可以轻松地安装并使用 <code>dingtalk_robot</code> 了。</p>
<p>至此本步骤完成。</p>
<h3 id="4.-上传-python-包到-pypi" tabindex="-1"><a href="#4.-%E4%B8%8A%E4%BC%A0-python-%E5%8C%85%E5%88%B0-pypi">4. 上传 Python 包到 <a href="https://pypi.python.org/pypi/">PyPI</a></a></h3>
<p>Python Package Index，简称 PyPI，为 Python 官方的软件库。可以在 PyPI 中查看、下载所有公开的 Python 包，也可以发布自己的 Python 包供大家使用。当然，首先需要注册一个账号，<a href="https://pypi.python.org/pypi?%3Aaction=register_form">可以点击此处注册</a>。</p>
<p>拥有账号后，就可以使用 <code>twine</code> 上传上一步骤中构建的 Python 包了。</p>
<p>使用 <code>pip</code> 安装 <code>twine</code> 后，需要简单配置一下。在 HOME 目录下新建一个 <code>.pypirc</code> 文件，即 <code>~/.pypirc</code>，填入以下信息：</p>
<pre class="language-markup"><code class="language-markup">[distutils]
index-servers=pypi

[pypi]
username = sfzhou
password = xxxxxxxx
</code></pre>
<p>上方的 <code>username</code> 和 <code>password</code> 替换为 PyPI 中的用户名和密码。然后在包所在的目录执行：</p>
<pre class="language-markup"><code class="language-markup">twine upload dist/dingtalk_robot-0.0.1.tar.gz
</code></pre>
<p>上传上一步骤中构建的 <code>dingtalk_robot</code> 包，可以看到类似如下的输出：</p>
<pre class="language-markup"><code class="language-markup">Uploading distributions to https://upload.pypi.org/legacy/
Uploading dingtalk_robot-0.0.1.tar.gz
100%|████████████████████████████████████████████| 4.57k/4.57k [00:01&lt;00:00, 4.09kB/s]
</code></pre>
<p>如果显示有其他错误，则按照错误提示修正即可。比如笔者就遇到了注册邮箱没有验证的错误，完整邮箱验证后上传成功。</p>
<p>上传成功后，就可以在 <a href="https://pypi.python.org/pypi/dingtalk-robot">PyPI</a> 页面看到 <code>dingtalk_robot</code> 的信息了。也可以直接通过 <code>pip</code> 命令实现安装：</p>
<pre class="language-bash"><code class="language-bash">pip <span class="token function">install</span> dingtalk_robot
</code></pre>
<p>进而每个人都可以方便地安装和使用这个小工具了。</p>
<h3 id="5.-配置-ci" tabindex="-1"><a href="#5.-%E9%85%8D%E7%BD%AE-ci">5. 配置 CI</a></h3>
<p><strong>Continuous Improvement</strong>，简称 CI，也就是常说的持续集成。该步骤并不是必须的，但是配置有持续集成的项目更容易得到大家的信赖：持续集成意味着项目提供了准确的环境配置，并且通过了多项测试。</p>
<p>目前 GitHub 上常用的 CI 平台有 <a href="https://travis-ci.org">Travis-CI</a>、<a href="https://ci.appveyor.com">AppVeyor</a> 及 <a href="https://circleci.com">Circle-CI</a>。本文以 Travis-CI 为例介绍 CI 的配置，<a href="https://docs.travis-ci.com/">点击此处可以查看 Travis-CI 的详细文档</a>。</p>
<p>在项目文件夹中新建 Travis-CI 的配置文件 <code>.travis.yml</code>，文件内容为：</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">language</span><span class="token punctuation">:</span> python
<span class="token key atrule">python</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">"3.4"</span>
    <span class="token punctuation">-</span> <span class="token string">"3.5"</span>
    <span class="token punctuation">-</span> <span class="token string">"3.6"</span>

<span class="token key atrule">install</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> pip install <span class="token punctuation">-</span>r requirements.txt
    <span class="token punctuation">-</span> pip install pytest pycodestyle

<span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> pycodestyle . <span class="token punctuation">-</span><span class="token punctuation">-</span>max<span class="token punctuation">-</span>line<span class="token punctuation">-</span>length=120
    <span class="token punctuation">-</span> pytest
</code></pre>
<p>该文件首先定义了持续集成的环境为 Python，包含 3.4，3.5，3.6 三个版本。而后定义了 <code>install</code> 项，使用 <code>pip</code> 安装了运行和测试所需要的依赖。最后执行了代码风格测试和单元测试。</p>
<p>假设项目的文件夹已经建立好了 Git 库并上传到了 GitHub 上。例如本文中的 <code>dingtalk_robot</code>，就放在 <a href="https://github.com/SF-Zhou/DingtalkRobot">https://github.com/SF-Zhou/DingtalkRobot</a> 中。这里还需要在 Travis-CI 中加入该项目，即在加入项目的页面打钩即可：</p>
<figure tabindex="2"><a href="../images/8d34cdb22dc785ac984c0a1d498b0930.jpg"><img src="../images/8d34cdb22dc785ac984c0a1d498b0930.jpg" alt=""></a></figure>
<p>至此配置完成，之后每次 commit 或 pull request 后，Travis-CI 会自动执行配置中的脚本，完成代码风格测试和单元测试。</p>
<p>不幸的是这里没有通过测试：</p>
<figure tabindex="3"><a href="../images/7f4631b0e8875f8ce9b94a217cbc9dcc.jpg"><img src="../images/7f4631b0e8875f8ce9b94a217cbc9dcc.jpg" alt=""></a></figure>
<p>可以点击失败的 Job 查看详情。原来是是因为 <code>setup.py</code> 文件末尾没有空行，导致代码风格检查失败：</p>
<pre class="language-markup"><code class="language-markup">$ pycodestyle . --max-line-length=120
./setup.py:31:2: W292 no newline at end of file
The command "pycodestyle . --max-line-length=120" exited with 1.
</code></pre>
<p>在 <code>setup.py</code> 文件末加入空行，再次提交，测试通过：</p>
<figure tabindex="4"><a href="../images/1e6533caebe8dbba0077fe96ed58c30a.jpg"><img src="../images/1e6533caebe8dbba0077fe96ed58c30a.jpg" alt=""></a></figure>
<p>通常 CI 平台会提供项目状态的标志，点击上图上方中的 <code>build|unknown</code> 图标，可以得到状态标志的链接：</p>
<figure tabindex="5"><a href="../images/ffd89d476c60372886880b748c141ac6.jpg"><img src="../images/ffd89d476c60372886880b748c141ac6.jpg" alt=""></a></figure>
<p>将该链接加入 <code>README.md</code> 中，之后在 GitHub 的项目页面就可以看到绿色的 Build Passing 标志了。</p>
<p>至此本步骤完成。</p>
<h3 id="6.-配置-cd" tabindex="-1"><a href="#6.-%E9%85%8D%E7%BD%AE-cd">6. 配置 CD</a></h3>
<p><strong>Continuous Deployment</strong>，简称 CD，持续部署。该步骤同样不是必须的，简单来说就是省事而已。</p>
<p>当 <code>dingtalk_robot</code> 通过单元测试后，下一步肯定是及时地发布到 PyPI 上。CD 的目的就是为我们自动化地完成这件事。Travis-CI 提供了非常方便的 PyPI 发布配置，<a href="https://docs.travis-ci.com/user/deployment/pypi/">点击此处可以查看相关文档</a>。</p>
<p>在 <code>.travis.yml</code> 底部继续加入：</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">deploy</span><span class="token punctuation">:</span>
    <span class="token key atrule">provider</span><span class="token punctuation">:</span> pypi
    <span class="token key atrule">user</span><span class="token punctuation">:</span> <span class="token string">"sfzhou"</span>
    <span class="token key atrule">on</span><span class="token punctuation">:</span>
      <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">python</span><span class="token punctuation">:</span> <span class="token number">3.6</span>
</code></pre>
<p>当然发布还需要密码，而这里并不能直接把密码放到 GitHub 中。所以 Travis-CI 提供了一个加密密码的工具。使用 <code>pip</code> 安装名为 <code>travis</code> 的小工具，在项目目录下执行：</p>
<pre class="language-bash"><code class="language-bash">travis encrypt <span class="token parameter variable">--add</span> deploy.password
</code></pre>
<p>按照提示输入密码，成功后会自动把加密的密码写入 <code>.travis.yml</code> 中。最后将变更提交。</p>
<p>注意，这里配置了当且仅当运行环境为 Python 3.6，且附带 tag，才会执行发布的操作。之后需要发布的话，可以使用类似如下的命令：</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># change __version__ to 0.0.5 in dingtalk_robot.py</span>

<span class="token function">git</span> checkout master
<span class="token function">git</span> tag V0.0.5
<span class="token function">git</span> push origin master <span class="token parameter variable">--tag</span>
</code></pre>
<p>至此本步骤完成。</p>
<h3 id="7.-总结" tabindex="-1"><a href="#7.-%E6%80%BB%E7%BB%93">7. 总结</a></h3>
<p>一个完整的 Python 包构建过程就结束了。麻雀虽小五脏俱全，大项目也是这样一步一步构建出来的。随着后续的继续迭代，单元测试和 CI 持续保证质量，CD 及时将包发布到 PyPI 上，GitHub 中接收社区的反馈和贡献，这个包也就会越来越完善，越来越稳定。</p>
<p>本文中的源代码可以在 <a href="https://github.com/SF-Zhou/DingtalkRobot"><code>SF-Zhou/DingtalkRobot</code></a> 中找到，其中的每一个 commit 对应文中的每一步。</p>

      </div>
      <script src="https://giscus.app/client.js"
      data-repo="SF-Zhou/sf-zhou.github.io"
      data-repo-id="MDEwOlJlcG9zaXRvcnk4MDc5ODgwNg=="
      data-category="Announcements"
      data-category-id="DIC_kwDOBNDkVs4CA6GQ"
      data-mapping="title"
      data-reactions-enabled="0"
      data-emit-metadata="0"
      data-input-position="bottom"
      data-theme="preferred_color_scheme"
      data-lang="en"
      crossorigin="anonymous"
      async>
    </script>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2017 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/main.js"></script>
  </body>
</html>
