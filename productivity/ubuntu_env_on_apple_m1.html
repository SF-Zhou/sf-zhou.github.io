<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>在 Apple M1 平台搭建 Ubuntu 开发环境 | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> 在 Apple M1 平台搭建 Ubuntu 开发环境 </h1>
      </div>
      <div class="info">
        <div class="date"> 2022.06.22 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <p>去年年底笔者更新了自己的开发设备，换成了 Apple M1 芯片的 MacBook，偶尔做开发的时候还是会因为环境问题不太方便。所以希望在这台笔记本上搭建一套 Ubuntu 的开发环境。因为可能会有内核开发相关的需求，所以没有使用 Docker，而是选择了 Ubuntu 的发行商 Canonical 开发的 Multipass。安装步骤如下：</p>
<pre class="language-sh"><code class="language-sh"># 1. install
brew install multipass

# 2. launch a instance
multipass launch --name primary --cpus 8 --mem 8G --disk 20G

# 3. list instances
multipass list
#&gt; Name                    State             IPv4             Image
#&gt; primary                 Running           192.168.64.4     Ubuntu 20.04 LTS

# 4. show info
multipass info --all
#&gt; Name:           primary
#&gt; State:          Running
#&gt; IPv4:           192.168.64.4
#&gt; Release:        Ubuntu 20.04.4 LTS
#&gt; Image hash:     95a027336e19 (Ubuntu 20.04 LTS)
#&gt; Load:           0.06 0.03 0.00
#&gt; Disk usage:     1.3G out of 19.2G
#&gt; Memory usage:   232.2M out of 7.7G
#&gt; Mounts:         /Users/sf-zhou =&gt; Home
#&gt;                     UID map: 501:default
#&gt;                     GID map: 20:default

# 5. open shell
multipass shell
#&gt; Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-120-generic aarch64)
#&gt; 
#&gt;  * Documentation:  https://help.ubuntu.com
#&gt;  * Management:     https://landscape.canonical.com
#&gt;  * Support:        https://ubuntu.com/advantage
#&gt; 
#&gt;   System information as of Wed Jun 22 22:50:02 CST 2022
#&gt; 
#&gt;   System load:             0.14
#&gt;   Usage of /:              6.7% of 19.22GB
#&gt;   Memory usage:            3%
#&gt;   Swap usage:              0%
#&gt;   Processes:               174
#&gt;   Users logged in:         0
#&gt;   IPv4 address for enp0s1: 192.168.64.2
#&gt;   IPv6 address for enp0s1: fd33:cb6c:2e62:89c5:5054:ff:feb9:9b5
#&gt; 
#&gt; 
#&gt; 0 updates can be applied immediately.
#&gt; 
#&gt; 
#&gt; To run a command as administrator (user &quot;root&quot;), use &quot;sudo &lt;command&gt;&quot;.
#&gt; See &quot;man sudo_root&quot; for details.
#&gt; 
#&gt; ubuntu@test:~$ uname -a
#&gt; Linux test 5.4.0-120-generic #136-Ubuntu SMP Fri Jun 10 13:46:10 UTC 2022 aarch64 aarch64 aarch64 GNU/Linux
</code></pre>
<p>可以看到在 Apple M1 平台上，Multipass 启动的虚拟机也是 ARM64 平台。启动 shell 后就可以像一般的虚拟机一样正常使用了。这里再补充一些开发可能遇到的问题。</p>
<h3 id="1.-ssh-登录" tabindex="-1"><a href="#1.-ssh-%E7%99%BB%E5%BD%95">1. ssh 登录</a></h3>
<p>直接在 Mac 上使用 ssh 登录虚拟机会被拒绝：</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">ssh</span> ubuntu@192.168.64.2
<span class="token comment">#> The authenticity of host '192.168.64.2 (192.168.64.2)' can't be established.</span>
<span class="token comment">#> ED25519 key fingerprint is SHA256:UNQUAycErI2TheKOfF4zKc5HSFad+7q36Z+MCpdIA2U.</span>
<span class="token comment">#> This key is not known by any other names</span>
<span class="token comment">#> Are you sure you want to continue connecting (yes/no/[fingerprint])? yes</span>
<span class="token comment">#> Warning: Permanently added '192.168.64.2' (ED25519) to the list of known hosts.</span>
<span class="token comment">#> ubuntu@192.168.64.2: Permission denied (publickey).</span>
</code></pre>
<p>这里需要手动的将自己 Mac 的 ssh 公钥加入到 Ubuntu 虚拟机的信任列表里：</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 1. in your mac</span>
<span class="token function">cat</span> ~/.ssh/id_rsa.pub
<span class="token comment">#> ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDsc8Oz4jg8u2x1GiHceHTwO9PUyogZSMPZ2w1Fi9Vne8vBmv38lNTJ4BMUUYj8gtVFeoXE2TLeuOsAmrjV9hArKmwBTjMNtN7Bnwhptu+2nimYuVbXj4dfpfhErEyHBl2o51CIxeavoLeOEWpI2BBnKaT+a7SQ8G5uZtYnl2Jx7btaly1Q1uCcjSNP2ZxX5lBzfft5HT5WCMPsP+i9vrIRnUEFE9ITjSxzOcDOlPqjmnvC2MMJiR4HcpsUR36MvuGW0R3NcvdZlmF8Lna668YXFEHe4MGb2BgfS2m3YIJqPNvBLXPtdc= sf-zhou@SF-Zhous-MacBook-Pro.local</span>

<span class="token comment"># 2. copy this</span>
multipass shell
<span class="token comment">#> ubuntu@test:~$ echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDsc8Oz4jg8u2x1GiHceHTwO9PUyogZSMPZ2w1Fi9Vne8vBmv38lNTJ4BMUUYj8gtVFeoXE2TLeuOsAmrjV9hArKmwBTjMNtN7Bnwhptu+2nimYuVbXj4dfpfhErEyHBl2o51CIxeavoLeOEWpI2BBnKaT+a7SQ8G5uZtYnl2Jx7btaly1Q1uCcjSNP2ZxX5lBzfft5HT5WCMPsP+i9vrIRnUEFE9ITjSxzOcDOlPqjmnvC2MMJiR4HcpsUR36MvuGW0R3NcvdZlmF8Lna668YXFEHe4MGb2BgfS2m3YIJqPNvBLXPtdc= sf-zhou@SF-Zhous-MacBook-Pro.local" >> ~/.ssh/authorized_keys</span>
<span class="token comment">#> ubuntu@test:~$ exit</span>

<span class="token comment"># 3. ssh again</span>
<span class="token function">ssh</span> ubuntu@192.168.64.2
<span class="token comment">#> Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-120-generic aarch64)</span>
<span class="token comment">#> </span>
<span class="token comment">#>  * Documentation:  https://help.ubuntu.com</span>
<span class="token comment">#>  * Management:     https://landscape.canonical.com</span>
<span class="token comment">#>  * Support:        https://ubuntu.com/advantage</span>
<span class="token comment">#> </span>
<span class="token comment">#>   System information as of Wed Jun 22 23:01:56 CST 2022</span>
<span class="token comment">#> </span>
<span class="token comment">#>   System load:             0.0</span>
<span class="token comment">#>   Usage of /:              6.7% of 19.22GB</span>
<span class="token comment">#>   Memory usage:            3%</span>
<span class="token comment">#>   Swap usage:              0%</span>
<span class="token comment">#>   Processes:               159</span>
<span class="token comment">#>   Users logged in:         0</span>
<span class="token comment">#>   IPv4 address for enp0s1: 192.168.64.2</span>
<span class="token comment">#>   IPv6 address for enp0s1: fd33:cb6c:2e62:89c5:5054:ff:feb9:9b5</span>
<span class="token comment">#> </span>
<span class="token comment">#> </span>
<span class="token comment">#> 0 updates can be applied immediately.</span>
<span class="token comment">#> </span>
<span class="token comment">#> </span>
<span class="token comment">#> Last login: Wed Jun 22 23:00:51 2022 from 192.168.64.1</span>
<span class="token comment">#> To run a command as administrator (user "root"), use "sudo &lt;command>".</span>
<span class="token comment">#> See "man sudo_root" for details.</span>
<span class="token comment">#> </span>
<span class="token comment">#> ubuntu@test:~$</span>
</code></pre>
<p>然后就可以使用 VS Code 的远程开发套件进行开发了。</p>
<h3 id="2.-镜像大小调整" tabindex="-1"><a href="#2.-%E9%95%9C%E5%83%8F%E5%A4%A7%E5%B0%8F%E8%B0%83%E6%95%B4">2. 镜像大小调整</a></h3>
<p>可以使用 <code>qemu-img</code> 命令调整已经创建的实例的磁盘大小：</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 1. install</span>
brew <span class="token function">install</span> qemu

<span class="token comment"># 2. stop instance</span>
multipass stop primary

<span class="token comment"># 3. resize</span>
<span class="token function">sudo</span> qemu-img resize <span class="token string">"/var/root/Library/Application Support/multipassd/qemu/vault/instances/primary/ubuntu-20.04-server-cloudimg-arm64.img"</span> +20G

<span class="token comment"># 4. start again</span>
multipass start primary
</code></pre>
<p>这里也展示了实例的存储路径。实际上可以通过直接替换镜像文件的方式启动自己下载的镜像文件。</p>
<h3 id="references" tabindex="-1"><a href="#references">References</a></h3>
<ol>
<li><a href="https://multipass.run">Multipass</a></li>
</ol>

      </div>
      <script src="https://giscus.app/client.js"
      data-repo="SF-Zhou/sf-zhou.github.io"
      data-repo-id="MDEwOlJlcG9zaXRvcnk4MDc5ODgwNg=="
      data-category="Announcements"
      data-category-id="DIC_kwDOBNDkVs4CA6GQ"
      data-mapping="title"
      data-reactions-enabled="0"
      data-emit-metadata="0"
      data-input-position="bottom"
      data-theme="preferred_color_scheme"
      data-lang="en"
      crossorigin="anonymous"
      async>
    </script>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2017 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/main.js"></script>
    <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-61723712-2', 'auto'); ga('send', 'pageview'); </script>
  </body>
</html>
