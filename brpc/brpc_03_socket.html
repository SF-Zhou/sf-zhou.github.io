<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>bRPC 源码分析「三、网络通信」 | SF-Zhou's Blog</title>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GQ26H3JQ3G"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-GQ26H3JQ3G');
    </script>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> bRPC 源码分析「三、网络通信」 </h1>
      </div>
      <div class="info">
        <div class="date"> 2021.03.04 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <figure tabindex="1"><a href="../images/fc464d977f5fe4c4f5152fb14b02e9e4.png"><img src="../images/fc464d977f5fe4c4f5152fb14b02e9e4.png" alt=""></a><figcaption>bRPC 网络收发流程图 from 官方文档</figcaption></figure>
<h3 id="1.-single-connection" tabindex="-1"><a href="#1.-single-connection">1. Single Connection</a></h3>
<p>bRPC 支持短连接、连接池和单连接，前两种是非常通用的方案。而单连接是指进程内所有 client 与一台 server 最多只有一个连接，在该连接上同时处理多个请求，不要求回复返回顺序与请求发送顺序一致。</p>
<p>对于连接池，请求时 client 端从连接池中取出一个可用的连接并独占使用，写入请求，server 端在该连接上收到请求后进行处理，最后在该连接上写入回复。对该连接来说，读和写并不会同时发生，实际工作模式是半双工的。而对于单连接，可以连续地在该连接上写入请求并同时读取回复，工作模式是全双工的，不过需要有通过回复定位请求的能力，可以通过 UUID 解决。连续的写入和读取也可以形成更好的批量效果，减少系统调用次数。在多线程环境下，bRPC 的单连接读写操作做到了 <a href="http://en.wikipedia.org/wiki/Non-blocking_algorithm#Wait-freedom">wait-free</a>。</p>
<h3 id="2.-message-sending" tabindex="-1"><a href="#2.-message-sending">2. Message Sending</a></h3>
<p>“消息”是指向连接写出的有边界的二进制串。使用单连接的场景中，多线程可能会向同一个连接发送消息，该操作显然是非原子的，这时候就需要高效率地排队不同线程发送的数据包。bRPC 中使用了一个 MPSC 队列实现该需求，具体步骤如下：</p>
<ol>
<li>为每个连接维护一个 MPSC 的单向链表，当线程需要写消息时尝试获取该连接的独占写入权限（原子操作），成功获取权限的线程执行一次写入，而获取权限失败的线程仅将消息插入到该链表的头部（原子操作），并挂起等待回复；</li>
<li>获得写入权限的线程根据连接对应的链表，批量地写入本线程以及其他线程发送的数据包，尽可能多的写入数据，但只写入一次防止本线程的请求产生过长的延迟，如果写入时连接的缓冲池已满无法写入，则启动一个新的 KeepWrite bthread 执行后续的写入操作；</li>
<li>KeepWrite bthread 负责将链表中的所有数据包写入连接直到链表为空，当连接缓冲池已满时则挂起等待 epoll 唤醒。</li>
</ol>
<p>下面对照代码进行分析。单连接的实现位于 <a href="https://github.com/apache/incubator-brpc/blob/0.9.7/src/brpc/socket.cpp">src/brpc/socket.cpp</a>，写入的流程为：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// socket.cpp，写入 IOBuf</span>
<span class="token keyword">int</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">Write</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>IOBuf <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">const</span> WriteOptions <span class="token operator">*</span>options_in<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  WriteOptions opt<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options_in<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    opt <span class="token operator">=</span> <span class="token operator">*</span>options_in<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token operator">-></span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">SetError</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>id_wait<span class="token punctuation">,</span> EINVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opt<span class="token punctuation">.</span>pipelined_count <span class="token operator">></span> MAX_PIPELINED_COUNT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"pipelined_count="</span> <span class="token operator">&lt;&lt;</span> opt<span class="token punctuation">.</span>pipelined_count <span class="token operator">&lt;&lt;</span> <span class="token string">" is too large"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">SetError</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>id_wait<span class="token punctuation">,</span> EOVERFLOW<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Failed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">ConductError</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>id_wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>opt<span class="token punctuation">.</span>ignore_eovercrowded <span class="token operator">&amp;&amp;</span> _overcrowded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">SetError</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>id_wait<span class="token punctuation">,</span> EOVERCROWDED<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 对象池中获取一个 WriteRequest 对象</span>
  WriteRequest <span class="token operator">*</span>req <span class="token operator">=</span> butil<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get_object</span><span class="token generic class-name"><span class="token operator">&lt;</span>WriteRequest<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">SetError</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>id_wait<span class="token punctuation">,</span> ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  req<span class="token operator">-></span>data<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span><span class="token operator">*</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// move 数据到 request 中</span>
  <span class="token comment">// Set `req->next' to UNCONNECTED so that the KeepWrite thread will</span>
  <span class="token comment">// wait until it points to a valid WriteRequest or NULL.</span>
  <span class="token comment">// 先将 next 指针设为非法，后续判断依赖该操作</span>
  req<span class="token operator">-></span>next <span class="token operator">=</span> WriteRequest<span class="token double-colon punctuation">::</span>UNCONNECTED<span class="token punctuation">;</span>
  req<span class="token operator">-></span>id_wait <span class="token operator">=</span> opt<span class="token punctuation">.</span>id_wait<span class="token punctuation">;</span>
  req<span class="token operator">-></span><span class="token function">set_pipelined_count_and_user_message</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>pipelined_count<span class="token punctuation">,</span>
                                            DUMMY_USER_MESSAGE<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>with_auth<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">StartWrite</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> opt<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 调用写入</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">StartWrite</span><span class="token punctuation">(</span>WriteRequest <span class="token operator">*</span>req<span class="token punctuation">,</span> <span class="token keyword">const</span> WriteOptions <span class="token operator">&amp;</span>opt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Release fence makes sure the thread getting request sees *req</span>
  <span class="token comment">// 将链表头原子地替换为待写入的 request，原先的头部返回给 prev_head</span>
  WriteRequest <span class="token operator">*</span><span class="token keyword">const</span> prev_head <span class="token operator">=</span>
      _write_head<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>prev_head <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Someone is writing to the fd. The KeepWrite thread may spin</span>
    <span class="token comment">// until req->next to be non-UNCONNECTED. This process is not</span>
    <span class="token comment">// lock-free, but the duration is so short(1~2 instructions,</span>
    <span class="token comment">// depending on compiler) that the spin rarely occurs in practice</span>
    <span class="token comment">// (I've not seen any spin in highly contended tests).</span>
    <span class="token comment">// 如果 prev_head 非空，说明有其他线程拿到了权限在执行写入。</span>
    <span class="token comment">// 此时将 next 指针设为 prev_head。</span>
    <span class="token comment">// 该操作前 next 指向 WriteRequest::UNCONNECTED，写入的线程可以 spin 等待。</span>
    req<span class="token operator">-></span>next <span class="token operator">=</span> prev_head<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">int</span> saved_errno <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  bthread_t th<span class="token punctuation">;</span>
  SocketUniquePtr ptr_for_keep_write<span class="token punctuation">;</span>
  ssize_t nw <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">// We've got the right to write.</span>
  <span class="token comment">// 获得连接的写入权限，将指向改为 NULL</span>
  <span class="token comment">// 下方所有操作均保证在单线程环境下执行</span>
  req<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

  <span class="token comment">// Connect to remote_side() if not.</span>
  <span class="token comment">// 尝试连接对机</span>
  <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">ConnectIfNot</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>abstime<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    saved_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
    <span class="token function">SetFailed</span><span class="token punctuation">(</span>errno<span class="token punctuation">,</span> <span class="token string">"Fail to connect %s directly: %m"</span><span class="token punctuation">,</span> <span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> FAIL_TO_WRITE<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// We are doing connection. Callback `KeepWriteIfConnected'</span>
    <span class="token comment">// will be called with `req' at any moment after</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// NOTE: Setup() MUST be called after Connect which may call app_connect,</span>
  <span class="token comment">// which is assumed to run before any SocketMessage.AppendAndDestroySelf()</span>
  <span class="token comment">// in some protocols(namely RTMP).</span>
  req<span class="token operator">-></span><span class="token function">Setup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 不确定功能，暂时搁置</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ssl_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> SSL_OFF<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Writing into SSL may block the current bthread, always write</span>
    <span class="token comment">// in the background.</span>
    <span class="token comment">// 对于 SSL，始终使用后台写入</span>
    <span class="token keyword">goto</span> KEEPWRITE_IN_BACKGROUND<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Write once in the calling thread. If the write is not complete,</span>
  <span class="token comment">// continue it in KeepWrite thread.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    butil<span class="token double-colon punctuation">::</span>IOBuf <span class="token operator">*</span>data_arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">&amp;</span>req<span class="token operator">-></span>data<span class="token punctuation">}</span><span class="token punctuation">;</span>
    nw <span class="token operator">=</span> _conn<span class="token operator">-></span><span class="token function">CutMessageIntoFileDescriptor</span><span class="token punctuation">(</span><span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data_arr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行一次写入，默认 size_hint 为 1MB</span>
    nw <span class="token operator">=</span> req<span class="token operator">-></span>data<span class="token punctuation">.</span><span class="token function">cut_into_file_descriptor</span><span class="token punctuation">(</span><span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nw <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// RTMP may return EOVERCROWDED</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EAGAIN <span class="token operator">&amp;&amp;</span> errno <span class="token operator">!=</span> EOVERCROWDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      saved_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
      <span class="token comment">// EPIPE is common in pooled connections + backup requests.</span>
      <span class="token function">PLOG_IF</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">,</span> errno <span class="token operator">!=</span> EPIPE<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to write into "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token function">SetFailed</span><span class="token punctuation">(</span>saved_errno<span class="token punctuation">,</span> <span class="token string">"Fail to write into %s: %s"</span><span class="token punctuation">,</span> <span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">berror</span><span class="token punctuation">(</span>saved_errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> FAIL_TO_WRITE<span class="token punctuation">;</span>  <span class="token comment">// 失败时跳转</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">AddOutputBytes</span><span class="token punctuation">(</span>nw<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsWriteComplete</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 判断所有写入完成，直接返回</span>
    <span class="token function">ReturnSuccessfulWriteRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

KEEPWRITE_IN_BACKGROUND<span class="token operator">:</span>
  <span class="token comment">// 写入未完成，启动后台 bthread 继续执行写入操作</span>
  <span class="token function">ReAddress</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptr_for_keep_write<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 复制当前指针到新的 SocketUniquePtr</span>
  req<span class="token operator">-></span>socket <span class="token operator">=</span> ptr_for_keep_write<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bthread_start_background</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>th<span class="token punctuation">,</span> <span class="token operator">&amp;</span>BTHREAD_ATTR_NORMAL<span class="token punctuation">,</span> KeepWrite<span class="token punctuation">,</span> req<span class="token punctuation">)</span> <span class="token operator">!=</span>
      <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to start KeepWrite"</span><span class="token punctuation">;</span>
    <span class="token comment">// bthread 启动失败的情况下继续同步调用写入</span>
    <span class="token function">KeepWrite</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

FAIL_TO_WRITE<span class="token operator">:</span>
  <span class="token comment">// `SetFailed' before `ReturnFailedWriteRequest' (which will calls</span>
  <span class="token comment">// `on_reset' callback inside the id object) so that we immediately</span>
  <span class="token comment">// know this socket has failed inside the `on_reset' callback</span>
  <span class="token function">ReleaseAllFailedWriteRequests</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  errno <span class="token operator">=</span> saved_errno<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// iobuf_inl.h</span>
<span class="token keyword">inline</span> ssize_t <span class="token class-name">IOBuf</span><span class="token double-colon punctuation">::</span><span class="token function">cut_into_file_descriptor</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> size_t size_hint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">pcut_into_file_descriptor</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size_hint<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// iobuf.cpp</span>
ssize_t <span class="token class-name">IOBuf</span><span class="token double-colon punctuation">::</span><span class="token function">pcut_into_file_descriptor</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> off_t offset<span class="token punctuation">,</span>
                                         size_t size_hint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> size_t nref <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token function">_ref_num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> IOBUF_IOV_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">iovec</span> vec<span class="token punctuation">[</span>nref<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 将 IOBuf 转为 iovec，批量写入</span>
  size_t nvec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  size_t cur_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    IOBuf<span class="token double-colon punctuation">::</span>BlockRef <span class="token keyword">const</span> <span class="token operator">&amp;</span>r <span class="token operator">=</span> <span class="token function">_ref_at</span><span class="token punctuation">(</span>nvec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vec<span class="token punctuation">[</span>nvec<span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> r<span class="token punctuation">.</span>block<span class="token operator">-></span>data <span class="token operator">+</span> r<span class="token punctuation">.</span>offset<span class="token punctuation">;</span>
    vec<span class="token punctuation">[</span>nvec<span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> r<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token operator">++</span>nvec<span class="token punctuation">;</span>
    cur_len <span class="token operator">+=</span> r<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nvec <span class="token operator">&lt;</span> nref <span class="token operator">&amp;&amp;</span> cur_len <span class="token operator">&lt;</span> size_hint<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// size_hint 非精确限制</span>

  ssize_t nw <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> iobuf<span class="token double-colon punctuation">::</span>iov_function pwritev_func <span class="token operator">=</span> iobuf<span class="token double-colon punctuation">::</span><span class="token function">get_pwritev_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nw <span class="token operator">=</span> <span class="token function">pwritev_func</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> vec<span class="token punctuation">,</span> nvec<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    nw <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">writev</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> vec<span class="token punctuation">,</span> nvec<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 非阻塞批量写入</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nw <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pop_front</span><span class="token punctuation">(</span>nw<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 写入成功的部分 pop 掉</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> nw<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>KeepWrite</code> 的流程为：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">KeepWrite</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>void_arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  g_vars<span class="token operator">-></span>nkeepwrite <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
  WriteRequest <span class="token operator">*</span>req <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>WriteRequest <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>void_arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  SocketUniquePtr <span class="token function">s</span><span class="token punctuation">(</span>req<span class="token operator">-></span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 恢复 socket 的 unique_ptr</span>

  <span class="token comment">// When error occurs, spin until there's no more requests instead of</span>
  <span class="token comment">// returning directly otherwise _write_head is permantly non-NULL which</span>
  <span class="token comment">// makes later Write() abnormal.</span>
  WriteRequest <span class="token operator">*</span>cur_tail <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token comment">// req was written, skip it.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token operator">-></span>next <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> req<span class="token operator">-></span>data<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      WriteRequest <span class="token operator">*</span><span class="token keyword">const</span> saved_req <span class="token operator">=</span> req<span class="token punctuation">;</span>
      req <span class="token operator">=</span> req<span class="token operator">-></span>next<span class="token punctuation">;</span>
      <span class="token comment">// 已经写完的包及时从链表中剔除，并回复</span>
      s<span class="token operator">-></span><span class="token function">ReturnSuccessfulWriteRequest</span><span class="token punctuation">(</span>saved_req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> ssize_t nw <span class="token operator">=</span> s<span class="token operator">-></span><span class="token function">DoWrite</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 尝试执行写入</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nw <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EAGAIN <span class="token operator">&amp;&amp;</span> errno <span class="token operator">!=</span> EOVERCROWDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> saved_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
        <span class="token function">PLOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to keep-write into "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>s<span class="token punctuation">;</span>
        s<span class="token operator">-></span><span class="token function">SetFailed</span><span class="token punctuation">(</span>saved_errno<span class="token punctuation">,</span> <span class="token string">"Fail to keep-write into %s: %s"</span><span class="token punctuation">,</span>
                     s<span class="token operator">-></span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">berror</span><span class="token punctuation">(</span>saved_errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      s<span class="token operator">-></span><span class="token function">AddOutputBytes</span><span class="token punctuation">(</span>nw<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Release WriteRequest until non-empty data or last request.</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>req<span class="token operator">-></span>next <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> req<span class="token operator">-></span>data<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      WriteRequest <span class="token operator">*</span><span class="token keyword">const</span> saved_req <span class="token operator">=</span> req<span class="token punctuation">;</span>
      req <span class="token operator">=</span> req<span class="token operator">-></span>next<span class="token punctuation">;</span>
      s<span class="token operator">-></span><span class="token function">ReturnSuccessfulWriteRequest</span><span class="token punctuation">(</span>saved_req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// TODO(gejun): wait for epollout when we actually have written</span>
    <span class="token comment">// all the data. This weird heuristic reduces 30us delay...</span>
    <span class="token comment">// Update(12/22/2015): seem not working. better switch to correct code.</span>
    <span class="token comment">// Update(1/8/2016, r31823): Still working.</span>
    <span class="token comment">// Update(8/15/2017): Not working, performance downgraded.</span>
    <span class="token comment">// if (nw &lt;= 0 || req->data.empty()/*note*/) {</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nw <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      g_vars<span class="token operator">-></span>nwaitepollout <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">bool</span> pollin <span class="token operator">=</span> <span class="token punctuation">(</span>s<span class="token operator">-></span>_on_edge_triggered_events <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// NOTE: Waiting epollout within timeout is a must to force</span>
      <span class="token comment">// KeepWrite to check and setup pending WriteRequests periodically,</span>
      <span class="token comment">// which may turn on _overcrowded to stop pending requests from</span>
      <span class="token comment">// growing infinitely.</span>
      <span class="token keyword">const</span> timespec duetime <span class="token operator">=</span>
          butil<span class="token double-colon punctuation">::</span><span class="token function">milliseconds_from_now</span><span class="token punctuation">(</span>WAIT_EPOLLOUT_TIMEOUT_MS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token keyword">int</span> rc <span class="token operator">=</span> s<span class="token operator">-></span><span class="token function">WaitEpollOut</span><span class="token punctuation">(</span>s<span class="token operator">-></span><span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pollin<span class="token punctuation">,</span> <span class="token operator">&amp;</span>duetime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">!=</span> ETIMEDOUT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> saved_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
        <span class="token function">PLOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to wait epollout of "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>s<span class="token punctuation">;</span>
        s<span class="token operator">-></span><span class="token function">SetFailed</span><span class="token punctuation">(</span>saved_errno<span class="token punctuation">,</span> <span class="token string">"Fail to wait epollout of %s: %s"</span><span class="token punctuation">,</span>
                     s<span class="token operator">-></span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">berror</span><span class="token punctuation">(</span>saved_errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> cur_tail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>cur_tail <span class="token operator">=</span> req<span class="token punctuation">;</span> cur_tail<span class="token operator">-></span>next <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> cur_tail <span class="token operator">=</span> cur_tail<span class="token operator">-></span>next<span class="token punctuation">)</span>
        <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Return when there's no more WriteRequests and req is completely</span>
    <span class="token comment">// written.</span>
    <span class="token comment">// 判断是否全部写完</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-></span><span class="token function">IsWriteComplete</span><span class="token punctuation">(</span>cur_tail<span class="token punctuation">,</span> <span class="token punctuation">(</span>req <span class="token operator">==</span> cur_tail<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>cur_tail<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CHECK_EQ</span><span class="token punctuation">(</span>cur_tail<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span>
      s<span class="token operator">-></span><span class="token function">ReturnSuccessfulWriteRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Error occurred, release all requests until no new requests.</span>
  s<span class="token operator">-></span><span class="token function">ReleaseAllFailedWriteRequests</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ssize_t <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">DoWrite</span><span class="token punctuation">(</span>WriteRequest <span class="token operator">*</span>req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Group butil::IOBuf in the list into a batch array.</span>
  butil<span class="token double-colon punctuation">::</span>IOBuf <span class="token operator">*</span>data_list<span class="token punctuation">[</span>DATA_LIST_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>
  size_t ndata <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>WriteRequest <span class="token operator">*</span>p <span class="token operator">=</span> req<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> ndata <span class="token operator">&lt;</span> DATA_LIST_MAX<span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data_list<span class="token punctuation">[</span>ndata<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>p<span class="token operator">-></span>data<span class="token punctuation">;</span>  <span class="token comment">// 收集一批待写入的数据包后批量写入</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ssl_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> SSL_OFF<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Write IOBuf in the batch array into the fd.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> _conn<span class="token operator">-></span><span class="token function">CutMessageIntoFileDescriptor</span><span class="token punctuation">(</span><span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data_list<span class="token punctuation">,</span> ndata<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      ssize_t nw <span class="token operator">=</span> butil<span class="token double-colon punctuation">::</span><span class="token class-name">IOBuf</span><span class="token double-colon punctuation">::</span><span class="token function">cut_multiple_into_file_descriptor</span><span class="token punctuation">(</span>
          <span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data_list<span class="token punctuation">,</span> ndata<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> nw<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">CHECK_EQ</span><span class="token punctuation">(</span>SSL_CONNECTED<span class="token punctuation">,</span> <span class="token function">ssl_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO: Separate SSL stuff from SocketConnection</span>
    <span class="token keyword">return</span> _conn<span class="token operator">-></span><span class="token function">CutMessageIntoSSLChannel</span><span class="token punctuation">(</span>_ssl_session<span class="token punctuation">,</span> data_list<span class="token punctuation">,</span> ndata<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">int</span> ssl_error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  ssize_t nw <span class="token operator">=</span> butil<span class="token double-colon punctuation">::</span><span class="token class-name">IOBuf</span><span class="token double-colon punctuation">::</span><span class="token function">cut_multiple_into_SSL_channel</span><span class="token punctuation">(</span>
      _ssl_session<span class="token punctuation">,</span> data_list<span class="token punctuation">,</span> ndata<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ssl_error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>ssl_error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> SSL_ERROR_NONE<span class="token operator">:</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">case</span> SSL_ERROR_WANT_READ<span class="token operator">:</span>
    <span class="token comment">// Disable renegotiation</span>
    errno <span class="token operator">=</span> EPROTO<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token keyword">case</span> SSL_ERROR_WANT_WRITE<span class="token operator">:</span>
    errno <span class="token operator">=</span> EAGAIN<span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> e <span class="token operator">=</span> <span class="token function">ERR_get_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">LOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to write into ssl_fd="</span> <span class="token operator">&lt;&lt;</span> <span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": "</span>
                   <span class="token operator">&lt;&lt;</span> <span class="token function">SSLError</span><span class="token punctuation">(</span><span class="token function">ERR_get_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      errno <span class="token operator">=</span> ESSL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// System error with corresponding errno set</span>
      <span class="token function">PLOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to write into ssl_fd="</span> <span class="token operator">&lt;&lt;</span> <span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> nw<span class="token punctuation">;</span>  <span class="token comment">// 返回成功写入的长度</span>
<span class="token punctuation">}</span>

<span class="token comment">// Check if there're new requests appended.</span>
<span class="token comment">// If yes, point old_head to to reversed new requests and return false;</span>
<span class="token comment">// If no:</span>
<span class="token comment">//    old_head is fully written, set _write_head to NULL and return true;</span>
<span class="token comment">//    old_head is not written yet, keep _write_head unchanged and return false;</span>
<span class="token comment">// `old_head' is last new_head got from this function or (in another word)</span>
<span class="token comment">// tail of current writing list.</span>
<span class="token comment">// `singular_node' is true iff `old_head' is the only node in its list.</span>
<span class="token keyword">bool</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">IsWriteComplete</span><span class="token punctuation">(</span>Socket<span class="token double-colon punctuation">::</span>WriteRequest <span class="token operator">*</span>old_head<span class="token punctuation">,</span> <span class="token keyword">bool</span> singular_node<span class="token punctuation">,</span>
                             Socket<span class="token double-colon punctuation">::</span>WriteRequest <span class="token operator">*</span><span class="token operator">*</span>new_tail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">CHECK</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> old_head<span class="token operator">-></span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Try to set _write_head to NULL to mark that the write is done.</span>
  WriteRequest <span class="token operator">*</span>new_head <span class="token operator">=</span> old_head<span class="token punctuation">;</span>
  WriteRequest <span class="token operator">*</span>desired <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> return_when_no_more <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>old_head<span class="token operator">-></span>data<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>singular_node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当前写入链表还不能判断已经写完（当前节点非空或者链表不止一个节点）</span>
    desired <span class="token operator">=</span> old_head<span class="token punctuation">;</span>
    <span class="token comment">// Write is obviously not complete if old_head is not fully written.</span>
    return_when_no_more <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// CAS 检查是否存在需要写入的数据包</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_write_head<span class="token punctuation">.</span><span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>new_head<span class="token punctuation">,</span> desired<span class="token punctuation">,</span>
                                          butil<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// No one added new requests.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>new_tail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>new_tail <span class="token operator">=</span> old_head<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> return_when_no_more<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// CAS 失败，new_head 获得最新的写入链表头部</span>
  <span class="token function">CHECK_NE</span><span class="token punctuation">(</span>new_head<span class="token punctuation">,</span> old_head<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Above acquire fence pairs release fence of exchange in Write() to make</span>
  <span class="token comment">// sure that we see all fields of requests set.</span>

  <span class="token comment">// Someone added new requests.</span>
  <span class="token comment">// Reverse the list until old_head.</span>
  WriteRequest <span class="token operator">*</span>tail <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  WriteRequest <span class="token operator">*</span>p <span class="token operator">=</span> new_head<span class="token punctuation">;</span>
  <span class="token comment">// 翻转链表，从 new_head 到 old_head 翻转</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>next <span class="token operator">==</span> WriteRequest<span class="token double-colon punctuation">::</span>UNCONNECTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// TODO(gejun): elaborate this</span>
      <span class="token comment">// 如前文提到的，p->next 短时间内可能指向 UNCONNECTED，需要 spin 等待</span>
      <span class="token function">sched_yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    WriteRequest <span class="token operator">*</span><span class="token keyword">const</span> saved_next <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span>
    p<span class="token operator">-></span>next <span class="token operator">=</span> tail<span class="token punctuation">;</span>
    tail <span class="token operator">=</span> p<span class="token punctuation">;</span>
    p <span class="token operator">=</span> saved_next<span class="token punctuation">;</span>
    <span class="token function">CHECK</span><span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> old_head<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Link old list with new list.</span>
  old_head<span class="token operator">-></span>next <span class="token operator">=</span> tail<span class="token punctuation">;</span>
  <span class="token comment">// Call Setup() from oldest to newest, notice that the calling sequence</span>
  <span class="token comment">// matters for protocols using pipelined_count, this is why we don't</span>
  <span class="token comment">// calling Setup in above loop which is from newest to oldest.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>WriteRequest <span class="token operator">*</span>q <span class="token operator">=</span> tail<span class="token punctuation">;</span> q<span class="token punctuation">;</span> q <span class="token operator">=</span> q<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    q<span class="token operator">-></span><span class="token function">Setup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 链表翻转完成后，头部是 old_head，尾部是 new_head，new_head 指向 NULL</span>
  <span class="token comment">// 这一段将会在下次写入时批量完成</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>new_tail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>new_tail <span class="token operator">=</span> new_head<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<figure tabindex="2"><a href="../images/453c1a23d92766864abfb955acd6eba3.svg"><img src="../images/453c1a23d92766864abfb955acd6eba3.svg" alt=""></a><figcaption>写入请求链表示意图</figcaption></figure>
<h3 id="3.-message-receiving" tabindex="-1"><a href="#3.-message-receiving">3. Message Receiving</a></h3>
<p>传统 RPC 框架一般通过独立的 IO 线程监听并读取连接上的数据，存在的问题是单一时间内一个线程只能读取一个连接，当多个繁忙的连接聚集在同一个 IO 线程中时，会导致部分的连接的读取被延迟，影响可用性。bRPC 中使用 <code>EventDispatcher</code> 监听连接是否可用，当连接可读时，会在当前线程启动一个新的 bthread 并立即切换过去执行读取操作，使其有更好的缓存局部性。而 <code>EventDispatcher</code> 所在的 bthread  会重新加入 bthread 的队列中，依赖 work stealing 继续在其他线程中执行。该方法使得 bRPC 读取同一个连接时产生的竞争是 <a href="http://en.wikipedia.org/wiki/Non-blocking_algorithm#Wait-freedom">wait-free</a> 的。当从连接上解析出多个数据包时，也会立即启动新的 bthread 并发处理这些数据包。这样连接间和连接内的消息在 bRPC 中都获得了并发处理，在高负载时仍能及时处理不同来源的消息，减少长尾。</p>
<p>先来看 <code>EventDispatcher</code> 的代码（仅保留 Linux 平台实现）：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// event_dispatcher.cpp</span>
<span class="token function">DEFINE_int32</span><span class="token punctuation">(</span>event_dispatcher_num<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Number of event dispatcher"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 默认 1</span>

EventDispatcher <span class="token operator">&amp;</span><span class="token function">GetGlobalEventDispatcher</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">pthread_once</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_edisp_once<span class="token punctuation">,</span> InitializeGlobalDispatchers<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>FLAGS_event_dispatcher_num <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> g_edisp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">int</span> index <span class="token operator">=</span> butil<span class="token double-colon punctuation">::</span><span class="token function">fmix32</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span> <span class="token operator">%</span> FLAGS_event_dispatcher_num<span class="token punctuation">;</span>
  <span class="token keyword">return</span> g_edisp<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">InitializeGlobalDispatchers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  g_edisp <span class="token operator">=</span> <span class="token keyword">new</span> EventDispatcher<span class="token punctuation">[</span>FLAGS_event_dispatcher_num<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> FLAGS_event_dispatcher_num<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> bthread_attr_t attr <span class="token operator">=</span>
        FLAGS_usercode_in_pthread <span class="token operator">?</span> BTHREAD_ATTR_PTHREAD <span class="token operator">:</span> BTHREAD_ATTR_NORMAL<span class="token punctuation">;</span>
    <span class="token function">CHECK_EQ</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> g_edisp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 启动 EventDispatcher</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// This atexit is will be run before g_task_control.stop() because above</span>
  <span class="token comment">// Start() initializes g_task_control by creating bthread (to run</span>
  <span class="token comment">// epoll/kqueue).</span>
  <span class="token function">CHECK_EQ</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">atexit</span><span class="token punctuation">(</span>StopAndJoinGlobalDispatchers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Dispatch edge-triggered events of file descriptors to consumers</span>
<span class="token comment">// running in separate bthreads.</span>
<span class="token keyword">class</span> <span class="token class-name">EventDispatcher</span> <span class="token punctuation">{</span>
  <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">Socket</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">EventDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">EventDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Start this dispatcher in a bthread.</span>
  <span class="token comment">// Use |*consumer_thread_attr| (if it's not NULL) as the attribute to</span>
  <span class="token comment">// create bthreads running user callbacks.</span>
  <span class="token comment">// Returns 0 on success, -1 otherwise.</span>
  <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token keyword">const</span> bthread_attr_t <span class="token operator">*</span>consumer_thread_attr<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// True iff this dispatcher is running in a bthread</span>
  <span class="token keyword">bool</span> <span class="token function">Running</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

  <span class="token comment">// Stop bthread of this dispatcher.</span>
  <span class="token keyword">void</span> <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Suspend calling thread until bthread of this dispatcher stops.</span>
  <span class="token keyword">void</span> <span class="token function">Join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// When edge-triggered events happen on `fd', call</span>
  <span class="token comment">// `on_edge_triggered_events' of `socket_id'.</span>
  <span class="token comment">// Notice that this function also transfers ownership of `socket_id',</span>
  <span class="token comment">// When the file descriptor is removed from internal epoll, the Socket</span>
  <span class="token comment">// will be dereferenced once additionally.</span>
  <span class="token comment">// Returns 0 on success, -1 otherwise.</span>
  <span class="token keyword">int</span> <span class="token function">AddConsumer</span><span class="token punctuation">(</span>SocketId socket_id<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Watch EPOLLOUT event on `fd' into epoll device. If `pollin' is</span>
  <span class="token comment">// true, EPOLLIN event will also be included and EPOLL_CTL_MOD will</span>
  <span class="token comment">// be used instead of EPOLL_CTL_ADD. When event arrives,</span>
  <span class="token comment">// `Socket::HandleEpollOut' will be called with `socket_id'</span>
  <span class="token comment">// Returns 0 on success, -1 otherwise and errno is set</span>
  <span class="token keyword">int</span> <span class="token function">AddEpollOut</span><span class="token punctuation">(</span>SocketId socket_id<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">bool</span> pollin<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Remove EPOLLOUT event on `fd'. If `pollin' is true, EPOLLIN event</span>
  <span class="token comment">// will be kept and EPOLL_CTL_MOD will be used instead of EPOLL_CTL_DEL</span>
  <span class="token comment">// Returns 0 on success, -1 otherwise and errno is set</span>
  <span class="token keyword">int</span> <span class="token function">RemoveEpollOut</span><span class="token punctuation">(</span>SocketId socket_id<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">bool</span> pollin<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token function">DISALLOW_COPY_AND_ASSIGN</span><span class="token punctuation">(</span>EventDispatcher<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Calls Run()</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">RunThis</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Thread entry.</span>
  <span class="token keyword">void</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Remove the file descriptor `fd' from epoll.</span>
  <span class="token keyword">int</span> <span class="token function">RemoveConsumer</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// The epoll to watch events.</span>
  <span class="token keyword">int</span> _epfd<span class="token punctuation">;</span>

  <span class="token comment">// false unless Stop() is called.</span>
  <span class="token keyword">volatile</span> <span class="token keyword">bool</span> _stop<span class="token punctuation">;</span>

  <span class="token comment">// identifier of hosting bthread</span>
  bthread_t _tid<span class="token punctuation">;</span>

  <span class="token comment">// The attribute of bthreads calling user callbacks.</span>
  bthread_attr_t _consumer_thread_attr<span class="token punctuation">;</span>

  <span class="token comment">// Pipe fds to wakeup EventDispatcher from `epoll_wait' in order to quit</span>
  <span class="token keyword">int</span> _wakeup_fds<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">EventDispatcher</span><span class="token double-colon punctuation">::</span><span class="token function">EventDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">_epfd</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_stop</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_tid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">_consumer_thread_attr</span><span class="token punctuation">(</span>BTHREAD_ATTR_NORMAL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  _epfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_epfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">PLOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to create epoll"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">CHECK_EQ</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span><span class="token function">make_close_on_exec</span><span class="token punctuation">(</span>_epfd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  _wakeup_fds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  _wakeup_fds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pipe</span><span class="token punctuation">(</span>_wakeup_fds<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 用于 stop 操作时唤醒 epoll</span>
    <span class="token function">PLOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to create pipe"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token class-name">EventDispatcher</span><span class="token double-colon punctuation">::</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token keyword">const</span> bthread_attr_t <span class="token operator">*</span>consumer_thread_attr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_epfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"epoll was not created"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>_tid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Already started this dispatcher("</span> <span class="token operator">&lt;&lt;</span> <span class="token keyword">this</span>
               <span class="token operator">&lt;&lt;</span> <span class="token string">") in bthread="</span> <span class="token operator">&lt;&lt;</span> _tid<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Set _consumer_thread_attr before creating epoll/kqueue thread to make sure</span>
  <span class="token comment">// everyting seems sane to the thread.</span>
  _consumer_thread_attr <span class="token operator">=</span>
      <span class="token punctuation">(</span>consumer_thread_attr <span class="token operator">?</span> <span class="token operator">*</span>consumer_thread_attr <span class="token operator">:</span> BTHREAD_ATTR_NORMAL<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Polling thread uses the same attr for consumer threads (NORMAL right</span>
  <span class="token comment">// now). Previously, we used small stack (32KB) which may be overflowed</span>
  <span class="token comment">// when the older comlog (e.g. 3.1.85) calls com_openlog_r(). Since this</span>
  <span class="token comment">// is also a potential issue for consumer threads, using the same attr</span>
  <span class="token comment">// should be a reasonable solution.</span>
  <span class="token comment">// 启动 bthread 处理</span>
  <span class="token keyword">int</span> rc <span class="token operator">=</span>
      <span class="token function">bthread_start_background</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_tid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_consumer_thread_attr<span class="token punctuation">,</span> RunThis<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to create epoll/kqueue thread: "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">berror</span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token class-name">EventDispatcher</span><span class="token double-colon punctuation">::</span><span class="token function">RunThis</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">(</span><span class="token punctuation">(</span>EventDispatcher <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">EventDispatcher</span><span class="token double-colon punctuation">::</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>_stop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    epoll_event e<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>_epfd<span class="token punctuation">,</span> e<span class="token punctuation">,</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 注意没有设定超时</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>_stop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// epoll_ctl/epoll_wait should have some sort of memory fencing</span>
      <span class="token comment">// guaranteeing that we(after epoll_wait) see _stop set before</span>
      <span class="token comment">// epoll_ctl.</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>EINTR <span class="token operator">==</span> errno<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// We've checked _stop, no wake-up will be missed.</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">PLOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to epoll_wait epfd="</span> <span class="token operator">&lt;&lt;</span> _epfd<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> <span class="token punctuation">(</span>EPOLLIN <span class="token operator">|</span> EPOLLERR <span class="token operator">|</span> EPOLLHUP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// We don't care about the return value.</span>
        <span class="token comment">// 处理读取事件</span>
        <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">StartInputEvent</span><span class="token punctuation">(</span>e<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>u64<span class="token punctuation">,</span> e<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events<span class="token punctuation">,</span>
                                _consumer_thread_attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> <span class="token punctuation">(</span>EPOLLOUT <span class="token operator">|</span> EPOLLERR <span class="token operator">|</span> EPOLLHUP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// We don't care about the return value.</span>
        <span class="token comment">// 处理写入事件</span>
        <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">HandleEpollOut</span><span class="token punctuation">(</span>e<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>u64<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">EventDispatcher</span><span class="token double-colon punctuation">::</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  _stop <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>_epfd <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    epoll_event evt <span class="token operator">=</span> <span class="token punctuation">{</span>EPOLLOUT<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token constant">NULL</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 停止时插入一个可写的 pipe fd，唤醒无超时的 epoll_wait</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>_epfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> _wakeup_fds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 增加读取事件监听</span>
<span class="token keyword">int</span> <span class="token class-name">EventDispatcher</span><span class="token double-colon punctuation">::</span><span class="token function">AddConsumer</span><span class="token punctuation">(</span>SocketId socket_id<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_epfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errno <span class="token operator">=</span> EINVAL<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  epoll_event evt<span class="token punctuation">;</span>
  evt<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN <span class="token operator">|</span> EPOLLET<span class="token punctuation">;</span>  <span class="token comment">// 边缘触发</span>
  evt<span class="token punctuation">.</span>data<span class="token punctuation">.</span>u64 <span class="token operator">=</span> socket_id<span class="token punctuation">;</span>  <span class="token comment">// 直接存储 socket_id</span>
  <span class="token keyword">return</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>_epfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 增加写入事件监听</span>
<span class="token keyword">int</span> <span class="token class-name">EventDispatcher</span><span class="token double-colon punctuation">::</span><span class="token function">AddEpollOut</span><span class="token punctuation">(</span>SocketId socket_id<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">bool</span> pollin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_epfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errno <span class="token operator">=</span> EINVAL<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  epoll_event evt<span class="token punctuation">;</span>
  evt<span class="token punctuation">.</span>data<span class="token punctuation">.</span>u64 <span class="token operator">=</span> socket_id<span class="token punctuation">;</span>
  evt<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLOUT <span class="token operator">|</span> EPOLLET<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pollin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    evt<span class="token punctuation">.</span>events <span class="token operator">|=</span> EPOLLIN<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>_epfd<span class="token punctuation">,</span> EPOLL_CTL_MOD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>evt<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// This fd has been removed from epoll via `RemoveConsumer',</span>
      <span class="token comment">// in which case errno will be ENOENT</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>_epfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>evt<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>多线程下并发调用 <code>epoll_wait</code> 与 <code>epoll_ctl</code> 是线程安全的，可以参考文献 2。bRPC 默认会启动一个 bthread 执行 <code>EventDispatcher</code> 的事件循环，创建连接时会将连接加入到 <code>EventDispatcher</code> 中：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// socket.cpp</span>
<span class="token keyword">int</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token keyword">const</span> SocketOptions <span class="token operator">&amp;</span>options<span class="token punctuation">,</span> SocketId <span class="token operator">*</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token operator">-></span><span class="token function">ResetFileDescriptor</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>fd<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> saved_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
    <span class="token function">PLOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to ResetFileDescriptor"</span><span class="token punctuation">;</span>
    m<span class="token operator">-></span><span class="token function">SetFailed</span><span class="token punctuation">(</span>saved_errno<span class="token punctuation">,</span> <span class="token string">"Fail to ResetFileDescriptor: %s"</span><span class="token punctuation">,</span>
                 <span class="token function">berror</span><span class="token punctuation">(</span>saved_errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">ResetFileDescriptor</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Reset message sizes when fd is changed.</span>
  _last_msg_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  _avg_msg_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// MUST store `_fd' before adding itself into epoll device to avoid</span>
  <span class="token comment">// race conditions with the callback function inside epoll</span>
  _fd<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
  _reset_fd_real_us <span class="token operator">=</span> butil<span class="token double-colon punctuation">::</span><span class="token function">gettimeofday_us</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 判断 fd 是否合法</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ValidFileDescriptor</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// OK to fail, non-socket fd does not support this.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span><span class="token function">get_local_side</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_local_side<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _local_side <span class="token operator">=</span> butil<span class="token double-colon punctuation">::</span><span class="token function">EndPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// FIXME : close-on-exec should be set by new syscalls or worse: set right</span>
  <span class="token comment">// after fd-creation syscall. Setting at here has higher probabilities of</span>
  <span class="token comment">// race condition.</span>
  butil<span class="token double-colon punctuation">::</span><span class="token function">make_close_on_exec</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Make the fd non-blocking.</span>
  <span class="token comment">// 非阻塞模式</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span><span class="token function">make_non_blocking</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">PLOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to set fd="</span> <span class="token operator">&lt;&lt;</span> fd <span class="token operator">&lt;&lt;</span> <span class="token string">" to non-blocking"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// turn off nagling.</span>
  <span class="token comment">// OK to fail, namely unix domain socket does not support this.</span>
  butil<span class="token double-colon punctuation">::</span><span class="token function">make_no_delay</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_tos <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">setsockopt</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> IPPROTO_IP<span class="token punctuation">,</span> IP_TOS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_tos<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>_tos<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">PLOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to set tos of fd="</span> <span class="token operator">&lt;&lt;</span> fd <span class="token operator">&lt;&lt;</span> <span class="token string">" to "</span> <span class="token operator">&lt;&lt;</span> _tos<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>FLAGS_socket_send_buffer_size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> buff_size <span class="token operator">=</span> FLAGS_socket_send_buffer_size<span class="token punctuation">;</span>
    socklen_t size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buff_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_SNDBUF<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buff_size<span class="token punctuation">,</span> size<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">PLOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to set sndbuf of fd="</span> <span class="token operator">&lt;&lt;</span> fd <span class="token operator">&lt;&lt;</span> <span class="token string">" to "</span> <span class="token operator">&lt;&lt;</span> buff_size<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>FLAGS_socket_recv_buffer_size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> buff_size <span class="token operator">=</span> FLAGS_socket_recv_buffer_size<span class="token punctuation">;</span>
    socklen_t size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buff_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_RCVBUF<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buff_size<span class="token punctuation">,</span> size<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">PLOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to set rcvbuf of fd="</span> <span class="token operator">&lt;&lt;</span> fd <span class="token operator">&lt;&lt;</span> <span class="token string">" to "</span> <span class="token operator">&lt;&lt;</span> buff_size<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>_on_edge_triggered_events<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 监听连接的读取事件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GetGlobalEventDispatcher</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddConsumer</span><span class="token punctuation">(</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">PLOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to add SocketId="</span> <span class="token operator">&lt;&lt;</span> <span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" into EventDispatcher"</span><span class="token punctuation">;</span>
      _fd<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>当发现有可用读取事件时，事件循环会调用连接对应的 <code>StartInputEvent</code> 函数：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// socket.cpp</span>
<span class="token keyword">int</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">StartInputEvent</span><span class="token punctuation">(</span>SocketId id<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> events<span class="token punctuation">,</span>
                            <span class="token keyword">const</span> bthread_attr_t <span class="token operator">&amp;</span>thread_attr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  SocketUniquePtr s<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Address</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> s<span class="token operator">-></span>_on_edge_triggered_events<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Callback can be NULL when receiving error epoll events</span>
    <span class="token comment">// (Added into epoll by `WaitConnected')</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-></span><span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CHECK</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"epoll_events="</span> <span class="token operator">&lt;&lt;</span> events<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Passing e[i].events causes complex visibility issues and</span>
  <span class="token comment">// requires stronger memory fences, since reading the fd returns</span>
  <span class="token comment">// error as well, we don't pass the events.</span>
  <span class="token comment">// _nevent 记录当前待处理的事件数量，保证至多有一个 bthread 处理读取事件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-></span>_nevent<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_acq_rel<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// According to the stats, above fetch_add is very effective. In a</span>
    <span class="token comment">// server processing 1 million requests per second, this counter</span>
    <span class="token comment">// is just 1500~1700/s</span>
    g_vars<span class="token operator">-></span>neventthread <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>

    bthread_t tid<span class="token punctuation">;</span>
    <span class="token comment">// transfer ownership as well, don't use s anymore!</span>
    Socket <span class="token operator">*</span><span class="token keyword">const</span> p <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    bthread_attr_t attr <span class="token operator">=</span> thread_attr<span class="token punctuation">;</span>
    attr<span class="token punctuation">.</span>keytable_pool <span class="token operator">=</span> p<span class="token operator">-></span>_keytable_pool<span class="token punctuation">;</span>
    <span class="token comment">// 启动一个新的 bthread 处理读取事件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bthread_start_urgent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>attr<span class="token punctuation">,</span> ProcessEvent<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to start ProcessEvent"</span><span class="token punctuation">;</span>
      <span class="token function">ProcessEvent</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">ProcessEvent</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// the enclosed Socket is valid and free to access inside this function.</span>
  SocketUniquePtr <span class="token function">s</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Socket <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 调用 _on_edge_triggered_events 处理事件</span>
  s<span class="token operator">-></span><span class="token function">_on_edge_triggered_events</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>_on_edge_triggered_events</code> 有 <code>OnNewConnections</code> 和 <code>OnNewMessages</code> 两种取值，前者负责处理新连接，将在下一节详述，这里先看后者负责收消息的处理：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// 处理新消息</span>
<span class="token keyword">void</span> <span class="token class-name">InputMessenger</span><span class="token double-colon punctuation">::</span><span class="token function">OnNewMessages</span><span class="token punctuation">(</span>Socket <span class="token operator">*</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Notes:</span>
  <span class="token comment">// - If the socket has only one message, the message will be parsed and</span>
  <span class="token comment">//   processed in this bthread. nova-pbrpc and http works in this way.</span>
  <span class="token comment">// - If the socket has several messages, all messages will be parsed (</span>
  <span class="token comment">//   meaning cutting from butil::IOBuf. serializing from protobuf is part of</span>
  <span class="token comment">//   "process") in this bthread. All messages except the last one will be</span>
  <span class="token comment">//   processed in separate bthreads. To minimize the overhead, scheduling</span>
  <span class="token comment">//   is batched(notice the BTHREAD_NOSIGNAL and bthread_flush).</span>
  <span class="token comment">// - Verify will always be called in this bthread at most once and before</span>
  <span class="token comment">//   any process.</span>
  InputMessenger <span class="token operator">*</span>messenger <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>InputMessenger <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>m<span class="token operator">-></span><span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> InputMessageHandler <span class="token operator">*</span>handlers <span class="token operator">=</span> messenger<span class="token operator">-></span>_handlers<span class="token punctuation">;</span>
  <span class="token keyword">int</span> progress <span class="token operator">=</span> Socket<span class="token double-colon punctuation">::</span>PROGRESS_INIT<span class="token punctuation">;</span>

  <span class="token comment">// Notice that all *return* no matter successful or not will run last</span>
  <span class="token comment">// message, even if the socket is about to be closed. This should be</span>
  <span class="token comment">// OK in most cases.</span>
  std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>InputMessageBase<span class="token punctuation">,</span> RunLastMessage<span class="token operator">></span> last_msg<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> read_eof <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>read_eof<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">int64_t</span> received_us <span class="token operator">=</span> butil<span class="token double-colon punctuation">::</span><span class="token function">cpuwide_time_us</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int64_t</span> base_realtime <span class="token operator">=</span> butil<span class="token double-colon punctuation">::</span><span class="token function">gettimeofday_us</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> received_us<span class="token punctuation">;</span>

    <span class="token comment">// Calculate bytes to be read.</span>
    size_t once_read <span class="token operator">=</span> m<span class="token operator">-></span>_avg_msg_size <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>once_read <span class="token operator">&lt;</span> MIN_ONCE_READ<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      once_read <span class="token operator">=</span> MIN_ONCE_READ<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>once_read <span class="token operator">></span> MAX_ONCE_READ<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      once_read <span class="token operator">=</span> MAX_ONCE_READ<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Read.</span>
    <span class="token comment">// 从连接中读取数据</span>
    <span class="token keyword">const</span> ssize_t nr <span class="token operator">=</span> m<span class="token operator">-></span><span class="token function">DoRead</span><span class="token punctuation">(</span>once_read<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nr <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> nr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Set `read_eof' flag and proceed to feed EOF into `Protocol'</span>
        <span class="token comment">// (implied by m->_read_buf.empty), which may produce a new</span>
        <span class="token comment">// `InputMessageBase' under some protocols such as HTTP</span>
        <span class="token function">LOG_IF</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">,</span> FLAGS_log_connection_close<span class="token punctuation">)</span>
            <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>m <span class="token operator">&lt;&lt;</span> <span class="token string">" was closed by remote side"</span><span class="token punctuation">;</span>
        read_eof <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EAGAIN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">// just retry</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> saved_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
        <span class="token function">PLOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to read from "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>m<span class="token punctuation">;</span>
        m<span class="token operator">-></span><span class="token function">SetFailed</span><span class="token punctuation">(</span>saved_errno<span class="token punctuation">,</span> <span class="token string">"Fail to read from %s: %s"</span><span class="token punctuation">,</span>
                     m<span class="token operator">-></span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">berror</span><span class="token punctuation">(</span>saved_errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m<span class="token operator">-></span><span class="token function">MoreReadEvents</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>progress<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 当没有更多可读取的消息时，bthread 退出</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// new events during processing</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    m<span class="token operator">-></span><span class="token function">AddInputBytes</span><span class="token punctuation">(</span>nr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Avoid this socket to be closed due to idle_timeout_s</span>
    m<span class="token operator">-></span>_last_readtime_us<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>received_us<span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>

    size_t last_size <span class="token operator">=</span> m<span class="token operator">-></span>_read_buf<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> num_bthread_created <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      size_t index <span class="token operator">=</span> <span class="token number">8888</span><span class="token punctuation">;</span>
      <span class="token comment">// 尝试解析消息</span>
      ParseResult pr <span class="token operator">=</span> messenger<span class="token operator">-></span><span class="token function">CutInputMessage</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token operator">&amp;</span>index<span class="token punctuation">,</span> read_eof<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pr<span class="token punctuation">.</span><span class="token function">is_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pr<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> PARSE_ERROR_NOT_ENOUGH_DATA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// incomplete message, re-read.</span>
          <span class="token comment">// However, some buffer may have been consumed</span>
          <span class="token comment">// under protocols like HTTP. Record this size</span>
          m<span class="token operator">-></span>_last_msg_size <span class="token operator">+=</span> <span class="token punctuation">(</span>last_size <span class="token operator">-</span> m<span class="token operator">-></span>_read_buf<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pr<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> PARSE_ERROR_TRY_OTHERS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">LOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Close "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>m <span class="token operator">&lt;&lt;</span> <span class="token string">" due to unknown message: "</span>
                       <span class="token operator">&lt;&lt;</span> butil<span class="token double-colon punctuation">::</span><span class="token function">ToPrintable</span><span class="token punctuation">(</span>m<span class="token operator">-></span>_read_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
          m<span class="token operator">-></span><span class="token function">SetFailed</span><span class="token punctuation">(</span>EINVAL<span class="token punctuation">,</span> <span class="token string">"Close %s due to unknown message"</span><span class="token punctuation">,</span>
                       m<span class="token operator">-></span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">LOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Close "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>m <span class="token operator">&lt;&lt;</span> <span class="token string">": "</span> <span class="token operator">&lt;&lt;</span> pr<span class="token punctuation">.</span><span class="token function">error_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          m<span class="token operator">-></span><span class="token function">SetFailed</span><span class="token punctuation">(</span>EINVAL<span class="token punctuation">,</span> <span class="token string">"Close %s: %s"</span><span class="token punctuation">,</span> m<span class="token operator">-></span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                       pr<span class="token punctuation">.</span><span class="token function">error_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      m<span class="token operator">-></span><span class="token function">AddInputMessages</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Calculate average size of messages</span>
      <span class="token keyword">const</span> size_t cur_size <span class="token operator">=</span> m<span class="token operator">-></span>_read_buf<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// _read_buf is consumed, it's good timing to return blocks</span>
        <span class="token comment">// cached internally back to TLS, otherwise the memory is not</span>
        <span class="token comment">// reused until next message arrives which is quite uncertain</span>
        <span class="token comment">// in situations that most connections are idle.</span>
        m<span class="token operator">-></span>_read_buf<span class="token punctuation">.</span><span class="token function">return_cached_blocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      m<span class="token operator">-></span>_last_msg_size <span class="token operator">+=</span> <span class="token punctuation">(</span>last_size <span class="token operator">-</span> cur_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
      last_size <span class="token operator">=</span> cur_size<span class="token punctuation">;</span>
      <span class="token keyword">const</span> size_t old_avg <span class="token operator">=</span> m<span class="token operator">-></span>_avg_msg_size<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>old_avg <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        m<span class="token operator">-></span>_avg_msg_size <span class="token operator">=</span>
            <span class="token punctuation">(</span>old_avg <span class="token operator">*</span> <span class="token punctuation">(</span>MSG_SIZE_WINDOW <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> m<span class="token operator">-></span>_last_msg_size<span class="token punctuation">)</span> <span class="token operator">/</span>
            MSG_SIZE_WINDOW<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        m<span class="token operator">-></span>_avg_msg_size <span class="token operator">=</span> m<span class="token operator">-></span>_last_msg_size<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      m<span class="token operator">-></span>_last_msg_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>pr<span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// the Process() step can be skipped.</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      pr<span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>_received_us <span class="token operator">=</span> received_us<span class="token punctuation">;</span>
      pr<span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>_base_real_us <span class="token operator">=</span> base_realtime<span class="token punctuation">;</span>

      <span class="token comment">// This unique_ptr prevents msg to be lost before transfering</span>
      <span class="token comment">// ownership to last_msg</span>
      DestroyingPtr<span class="token operator">&lt;</span>InputMessageBase<span class="token operator">></span> <span class="token function">msg</span><span class="token punctuation">(</span>pr<span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 处理新消息</span>
      <span class="token function">QueueMessage</span><span class="token punctuation">(</span>last_msg<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>num_bthread_created<span class="token punctuation">,</span> m<span class="token operator">-></span>_keytable_pool<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>handlers<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>process <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"process of index="</span> <span class="token operator">&lt;&lt;</span> index <span class="token operator">&lt;&lt;</span> <span class="token string">" is NULL"</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      m<span class="token operator">-></span><span class="token function">ReAddress</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token operator">-></span>_socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
      m<span class="token operator">-></span><span class="token function">PostponeEOF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      msg<span class="token operator">-></span>_process <span class="token operator">=</span> handlers<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>process<span class="token punctuation">;</span>
      msg<span class="token operator">-></span>_arg <span class="token operator">=</span> handlers<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>arg<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>handlers<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>verify <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> auth_error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> m<span class="token operator">-></span><span class="token function">FightAuthentication</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>auth_error<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Get the right to authenticate</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>handlers<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            m<span class="token operator">-></span><span class="token function">SetAuthentication</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            m<span class="token operator">-></span><span class="token function">SetAuthentication</span><span class="token punctuation">(</span>ERPCAUTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to authenticate "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>m<span class="token punctuation">;</span>
            m<span class="token operator">-></span><span class="token function">SetFailed</span><span class="token punctuation">(</span>ERPCAUTH<span class="token punctuation">,</span> <span class="token string">"Fail to authenticate %s"</span><span class="token punctuation">,</span>
                         m<span class="token operator">-></span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">LOG_IF</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">,</span> auth_error <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
              <span class="token operator">&lt;&lt;</span> <span class="token string">"Impossible! Socket should have been "</span>
                 <span class="token string">"destroyed when authentication failed"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m<span class="token operator">-></span><span class="token function">is_read_progressive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Transfer ownership to last_msg</span>
        last_msg<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">QueueMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>num_bthread_created<span class="token punctuation">,</span> m<span class="token operator">-></span>_keytable_pool<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">bthread_flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        num_bthread_created <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>num_bthread_created<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">bthread_flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>read_eof<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    m<span class="token operator">-></span><span class="token function">SetEOF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">QueueMessage</span><span class="token punctuation">(</span>InputMessageBase <span class="token operator">*</span>to_run_msg<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>num_bthread_created<span class="token punctuation">,</span>
                         bthread_keytable_pool_t <span class="token operator">*</span>keytable_pool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>to_run_msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Create bthread for last_msg. The bthread is not scheduled</span>
  <span class="token comment">// until bthread_flush() is called (in the worse case).</span>

  <span class="token comment">// TODO(gejun): Join threads.</span>
  bthread_t th<span class="token punctuation">;</span>
  bthread_attr_t tmp <span class="token operator">=</span>
      <span class="token punctuation">(</span>FLAGS_usercode_in_pthread <span class="token operator">?</span> BTHREAD_ATTR_PTHREAD <span class="token operator">:</span> BTHREAD_ATTR_NORMAL<span class="token punctuation">)</span> <span class="token operator">|</span>
      BTHREAD_NOSIGNAL<span class="token punctuation">;</span>
  tmp<span class="token punctuation">.</span>keytable_pool <span class="token operator">=</span> keytable_pool<span class="token punctuation">;</span>
  <span class="token comment">// 启动新的 bthread 处理解析出来的消息</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bthread_start_background</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>th<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp<span class="token punctuation">,</span> ProcessInputMessage<span class="token punctuation">,</span> to_run_msg<span class="token punctuation">)</span> <span class="token operator">==</span>
      <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">++</span><span class="token operator">*</span>num_bthread_created<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">ProcessInputMessage</span><span class="token punctuation">(</span>to_run_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="4.-maintain-connection" tabindex="-1"><a href="#4.-maintain-connection">4. Maintain Connection</a></h3>
<p><code>Socket</code> 的 <code>Connect</code> 过程：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">ConnectIfNot</span><span class="token punctuation">(</span><span class="token keyword">const</span> timespec<span class="token operator">*</span> abstime<span class="token punctuation">,</span> WriteRequest<span class="token operator">*</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_fd<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_consume<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Have to hold a reference for `req'</span>
  <span class="token comment">// 范围内保证 Socket 存活</span>
  SocketUniquePtr s<span class="token punctuation">;</span>
  <span class="token function">ReAddress</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  req<span class="token operator">-></span>socket <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_conn<span class="token operator">-></span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> abstime<span class="token punctuation">,</span> KeepWriteIfConnected<span class="token punctuation">,</span> req<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Connect，注意设定了 KeepWriteIfConnected 的回调，data = req</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Connect</span><span class="token punctuation">(</span>abstime<span class="token punctuation">,</span> KeepWriteIfConnected<span class="token punctuation">,</span> req<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  s<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token keyword">const</span> timespec<span class="token operator">*</span> abstime<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>on_connect<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">void</span><span class="token operator">*</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_ssl_ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _ssl_state <span class="token operator">=</span> SSL_CONNECTING<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    _ssl_state <span class="token operator">=</span> SSL_OFF<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  butil<span class="token double-colon punctuation">::</span>fd_guard <span class="token function">sockfd</span><span class="token punctuation">(</span><span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">PLOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to create socket"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">CHECK_EQ</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span><span class="token function">make_close_on_exec</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// We need to do async connect (to manage the timeout by ourselves).</span>
  <span class="token comment">// 非阻塞</span>
  <span class="token function">CHECK_EQ</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span><span class="token function">make_non_blocking</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 尝试连接，非阻塞一般返回 EINPROGRESS</span>
  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serv_addr<span class="token punctuation">;</span>
  <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serv_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serv_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  serv_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
  serv_addr<span class="token punctuation">.</span>sin_addr <span class="token operator">=</span> <span class="token function">remote_side</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ip<span class="token punctuation">;</span>
  serv_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token function">remote_side</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> rc <span class="token operator">=</span>
      <span class="token double-colon punctuation">::</span><span class="token function">connect</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serv_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serv_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">!=</span> EINPROGRESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">PLOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to connect to "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">remote_side</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>on_connect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 因为设定了 on_connect = KeepWriteIfConnected，走该路径。</span>
    <span class="token comment">// 这个构造了一个新的 EpollOutRequest，注意它的生命周期。</span>
    EpollOutRequest<span class="token operator">*</span> req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>nothrow<span class="token punctuation">)</span> EpollOutRequest<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to new EpollOutRequest"</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    req<span class="token operator">-></span>fd <span class="token operator">=</span> sockfd<span class="token punctuation">;</span>
    req<span class="token operator">-></span>timer_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    req<span class="token operator">-></span>on_epollout_event <span class="token operator">=</span> on_connect<span class="token punctuation">;</span>  <span class="token comment">// 设定了 on_connect</span>
    req<span class="token operator">-></span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>  <span class="token comment">// 这里的 data 也就是传进来的 WriteRequest</span>
    <span class="token comment">// A temporary Socket to hold `EpollOutRequest', which will</span>
    <span class="token comment">// be added into epoll device soon</span>
    SocketId connect_id<span class="token punctuation">;</span>
    SocketOptions options<span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>user <span class="token operator">=</span> req<span class="token punctuation">;</span>
    <span class="token comment">// 使用 EpollOutRequest 构造一个临时的 Socket，用来处理 connect</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">Create</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token operator">&amp;</span>connect_id<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to create Socket"</span><span class="token punctuation">;</span>
      <span class="token keyword">delete</span> req<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// From now on, ownership of `req' has been transferred to</span>
    <span class="token comment">// `connect_id'. We hold an additional reference here to</span>
    <span class="token comment">// ensure `req' to be valid in this scope</span>
    SocketUniquePtr s<span class="token punctuation">;</span>  <span class="token comment">// 保证 Socket 的存活</span>
    <span class="token function">CHECK_EQ</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">Address</span><span class="token punctuation">(</span>connect_id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add `sockfd' into epoll so that `HandleEpollOutRequest' will</span>
    <span class="token comment">// be called with `req' when epoll event reaches</span>
    <span class="token comment">// 将 connect_id 加入 Epoll 中，当连接可用或失败时，会调用 Socket::HandleEpollOut</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GetGlobalEventDispatcher</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddEpollOut</span><span class="token punctuation">(</span>connect_id<span class="token punctuation">,</span> sockfd<span class="token punctuation">,</span>
                                                     <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token keyword">int</span> saved_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
      <span class="token function">PLOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to add fd="</span> <span class="token operator">&lt;&lt;</span> sockfd <span class="token operator">&lt;&lt;</span> <span class="token string">" into epoll"</span><span class="token punctuation">;</span>
      s<span class="token operator">-></span><span class="token function">SetFailed</span><span class="token punctuation">(</span>saved_errno<span class="token punctuation">,</span> <span class="token string">"Fail to add fd=%d into epoll: %s"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>sockfd<span class="token punctuation">,</span>
                   <span class="token function">berror</span><span class="token punctuation">(</span>saved_errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Register a timer for EpollOutRequest. Note that the timeout</span>
    <span class="token comment">// callback has no race with the one above as both of them try</span>
    <span class="token comment">// to `SetFailed' `connect_id' while only one of them can succeed</span>
    <span class="token comment">// It also work when `HandleEpollOutRequest' has already been</span>
    <span class="token comment">// called before adding the timer since it will be removed</span>
    <span class="token comment">// inside destructor of `EpollOutRequest' after leaving this scope</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>abstime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 增加超时的处理</span>
      <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">bthread_timer_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>req<span class="token operator">-></span>timer_id<span class="token punctuation">,</span> <span class="token operator">*</span>abstime<span class="token punctuation">,</span>
                                 HandleEpollOutTimeout<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>connect_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to add timer: "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">berror</span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        s<span class="token operator">-></span><span class="token function">SetFailed</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> <span class="token string">"Fail to add timer: %s"</span><span class="token punctuation">,</span> <span class="token function">berror</span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WaitEpollOut</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> abstime<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">PLOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to wait EPOLLOUT of fd="</span> <span class="token operator">&lt;&lt;</span> sockfd<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CheckConnected</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> sockfd<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Epoll 回调</span>
<span class="token keyword">int</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">HandleEpollOut</span><span class="token punctuation">(</span>SocketId id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  SocketUniquePtr s<span class="token punctuation">;</span>
  <span class="token comment">// Since Sockets might have been `SetFailed' before they were</span>
  <span class="token comment">// added into epoll, these sockets miss the signal inside</span>
  <span class="token comment">// `SetFailed' and therefore must be signalled here using</span>
  <span class="token comment">// `AddressFailedAsWell' to prevent waiting forever</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">AddressFailedAsWell</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Ignore recycled sockets</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  EpollOutRequest<span class="token operator">*</span> req <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>EpollOutRequest<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>s<span class="token operator">-></span><span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 对于 Connect，这里可以拿到之前创建的 EpollOutRequest 对象</span>
    <span class="token keyword">return</span> s<span class="token operator">-></span><span class="token function">HandleEpollOutRequest</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Currently `WaitEpollOut' needs `_epollout_butex'</span>
  <span class="token comment">// TODO(jiangrujie): Remove this in the future</span>
  s<span class="token operator">-></span>_epollout_butex<span class="token operator">-></span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  bthread<span class="token double-colon punctuation">::</span><span class="token function">butex_wake_except</span><span class="token punctuation">(</span>s<span class="token operator">-></span>_epollout_butex<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">HandleEpollOutRequest</span><span class="token punctuation">(</span><span class="token keyword">int</span> error_code<span class="token punctuation">,</span> EpollOutRequest<span class="token operator">*</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Only one thread can `SetFailed' this `Socket' successfully</span>
  <span class="token comment">// Also after this `req' will be destroyed when its reference</span>
  <span class="token comment">// hits zero</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SetFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// We've got the right to call user callback</span>
  <span class="token comment">// The timer will be removed inside destructor of EpollOutRequest</span>
  <span class="token comment">// 将之前创建的 connect_id 从 Epoll 中删除</span>
  <span class="token function">GetGlobalEventDispatcher</span><span class="token punctuation">(</span>req<span class="token operator">-></span>fd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RemoveEpollOut</span><span class="token punctuation">(</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> req<span class="token operator">-></span>fd<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 调用回调函数，也就是 on_connect，也就是 KeepWriteIfConnected</span>
  <span class="token keyword">return</span> req<span class="token operator">-></span><span class="token function">on_epollout_event</span><span class="token punctuation">(</span>req<span class="token operator">-></span>fd<span class="token punctuation">,</span> error_code<span class="token punctuation">,</span> req<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">KeepWriteIfConnected</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> err<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  WriteRequest<span class="token operator">*</span> req <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>WriteRequest<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Socket<span class="token operator">*</span> s <span class="token operator">=</span> req<span class="token operator">-></span>socket<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> s<span class="token operator">-></span><span class="token function">ssl_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> SSL_CONNECTING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Run ssl connect in a new bthread to avoid blocking</span>
    <span class="token comment">// the current bthread (thus blocking the EventDispatcher)</span>
    bthread_t th<span class="token punctuation">;</span>
    <span class="token comment">// 启动一个新的 bthread 执行 CheckConnectedAndKeepWrite</span>
    google<span class="token double-colon punctuation">::</span>protobuf<span class="token double-colon punctuation">::</span>Closure<span class="token operator">*</span> thrd_func <span class="token operator">=</span>
        brpc<span class="token double-colon punctuation">::</span><span class="token function">NewCallback</span><span class="token punctuation">(</span>Socket<span class="token double-colon punctuation">::</span>CheckConnectedAndKeepWrite<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> err<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>err <span class="token operator">=</span> <span class="token function">bthread_start_background</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>th<span class="token punctuation">,</span> <span class="token operator">&amp;</span>BTHREAD_ATTR_NORMAL<span class="token punctuation">,</span> RunClosure<span class="token punctuation">,</span>
                                        thrd_func<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 注意这里 thrd_func 会内存泄漏，笔者给 brpc 交了一个 PR 了，等待合并</span>
      <span class="token function">PLOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to start bthread"</span><span class="token punctuation">;</span>
      <span class="token comment">// Fall through with non zero `err'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">CheckConnectedAndKeepWrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> err<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">CheckConnectedAndKeepWrite</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> err<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  butil<span class="token double-colon punctuation">::</span>fd_guard <span class="token function">sockfd</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  WriteRequest<span class="token operator">*</span> req <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>WriteRequest<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Socket<span class="token operator">*</span> s <span class="token operator">=</span> req<span class="token operator">-></span>socket<span class="token punctuation">;</span>
  <span class="token function">CHECK_GE</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> s<span class="token operator">-></span><span class="token function">CheckConnected</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
      s<span class="token operator">-></span><span class="token function">ResetFileDescriptor</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-></span>_app_connect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      s<span class="token operator">-></span>_app_connect<span class="token operator">-></span><span class="token function">StartConnect</span><span class="token punctuation">(</span>req<span class="token operator">-></span>socket<span class="token punctuation">,</span> AfterAppConnected<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Successfully created a connection</span>
      <span class="token function">AfterAppConnected</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Release this socket for KeepWrite</span>
    sockfd<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      err <span class="token operator">=</span> errno <span class="token operator">?</span> errno <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">AfterAppConnected</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">AfterAppConnected</span><span class="token punctuation">(</span><span class="token keyword">int</span> err<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  WriteRequest<span class="token operator">*</span> req <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>WriteRequest<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Socket<span class="token operator">*</span> <span class="token keyword">const</span> s <span class="token operator">=</span> req<span class="token operator">-></span>socket<span class="token punctuation">;</span>
    SharedPart<span class="token operator">*</span> sp <span class="token operator">=</span> s<span class="token operator">-></span><span class="token function">GetSharedPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sp<span class="token operator">-></span>num_continuous_connect_timeouts<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// requests are not setup yet. check the comment on Setup() in Write()</span>
    req<span class="token operator">-></span><span class="token function">Setup</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bthread_t th<span class="token punctuation">;</span>
    <span class="token comment">// 最终启动一个新的 bthread 执行 KeepWrite</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bthread_start_background</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>th<span class="token punctuation">,</span> <span class="token operator">&amp;</span>BTHREAD_ATTR_NORMAL<span class="token punctuation">,</span> KeepWrite<span class="token punctuation">,</span> req<span class="token punctuation">)</span> <span class="token operator">!=</span>
        <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">PLOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to start KeepWrite"</span><span class="token punctuation">;</span>
      <span class="token function">KeepWrite</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    SocketUniquePtr <span class="token function">s</span><span class="token punctuation">(</span>req<span class="token operator">-></span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> ETIMEDOUT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      SharedPart<span class="token operator">*</span> sp <span class="token operator">=</span> s<span class="token operator">-></span><span class="token function">GetOrNewSharedPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>sp<span class="token operator">-></span>num_continuous_connect_timeouts<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span>
              <span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span> <span class="token operator">+</span>
              <span class="token number">1</span> <span class="token operator">>=</span>
          FLAGS_connect_timeout_as_unreachable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// the race between store and fetch_add(in another thread) is</span>
        <span class="token comment">// OK since a critial error is about to return.</span>
        sp<span class="token operator">-></span>num_continuous_connect_timeouts<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>
                                                  butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        err <span class="token operator">=</span> ENETUNREACH<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    s<span class="token operator">-></span><span class="token function">SetFailed</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Fail to connect %s: %s"</span><span class="token punctuation">,</span> s<span class="token operator">-></span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 <span class="token function">berror</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    s<span class="token operator">-></span><span class="token function">ReleaseAllFailedWriteRequests</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>Socket</code> 的 <code>Accept</code> 流程：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// server.cpp</span>
<span class="token keyword">int</span> <span class="token class-name">Server</span><span class="token double-colon punctuation">::</span><span class="token function">StartInternal</span><span class="token punctuation">(</span><span class="token keyword">const</span> butil<span class="token double-colon punctuation">::</span>ip_t<span class="token operator">&amp;</span> ip<span class="token punctuation">,</span>
                          <span class="token keyword">const</span> PortRange<span class="token operator">&amp;</span> port_range<span class="token punctuation">,</span>
                          <span class="token keyword">const</span> ServerOptions <span class="token operator">*</span>opt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// 启动监听</span>
  butil<span class="token double-colon punctuation">::</span>fd_guard <span class="token function">sockfd</span><span class="token punctuation">(</span><span class="token function">tcp_listen</span><span class="token punctuation">(</span>_listen_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将监听的 sockfd 所有权转移给 Accetpor 对象</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_am<span class="token operator">-></span><span class="token function">StartAccept</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> _options<span class="token punctuation">.</span>idle_timeout_sec<span class="token punctuation">,</span>
                       _default_ssl_ctx<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to start acceptor"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">// acceptor.cpp</span>
<span class="token keyword">int</span> <span class="token class-name">Acceptor</span><span class="token double-colon punctuation">::</span><span class="token function">StartAccept</span><span class="token punctuation">(</span><span class="token keyword">int</span> listened_fd<span class="token punctuation">,</span> <span class="token keyword">int</span> idle_timeout_sec<span class="token punctuation">,</span>
                          <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>SocketSSLContext<span class="token operator">></span><span class="token operator">&amp;</span> ssl_ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  SocketOptions options<span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>fd <span class="token operator">=</span> listened_fd<span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token comment">// socket user 的设定</span>
  options<span class="token punctuation">.</span>on_edge_triggered_events <span class="token operator">=</span> OnNewConnections<span class="token punctuation">;</span>  <span class="token comment">// 触发函数的设定</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">Create</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_acception_id<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Close-idle-socket thread will be stopped inside destructor</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to create _acception_id"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">// Epoll 发现 listened_fd 可用时，触发 OnNewConnections</span>
<span class="token keyword">void</span> <span class="token class-name">Acceptor</span><span class="token double-colon punctuation">::</span><span class="token function">OnNewConnections</span><span class="token punctuation">(</span>Socket<span class="token operator">*</span> acception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> progress <span class="token operator">=</span> Socket<span class="token double-colon punctuation">::</span>PROGRESS_INIT<span class="token punctuation">;</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理新连接直到 EAGAIN</span>
    <span class="token function">OnNewConnectionsUntilEAGAIN</span><span class="token punctuation">(</span>acception<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>acception<span class="token operator">-></span><span class="token function">Failed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 需要处理完当前所有的可读事件</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>acception<span class="token operator">-></span><span class="token function">MoreReadEvents</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>progress<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">Acceptor</span><span class="token double-colon punctuation">::</span><span class="token function">OnNewConnectionsUntilEAGAIN</span><span class="token punctuation">(</span>Socket<span class="token operator">*</span> acception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> in_addr<span class="token punctuation">;</span>
    socklen_t in_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>in_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// accept 接收 client 端的 connect 请求</span>
    butil<span class="token double-colon punctuation">::</span>fd_guard <span class="token function">in_fd</span><span class="token punctuation">(</span><span class="token function">accept</span><span class="token punctuation">(</span>acception<span class="token operator">-></span><span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>in_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>in_len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>in_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// no EINTR because listened fd is non-blocking.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EAGAIN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 直到 EAGAIN</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Do NOT return -1 when `accept' failed, otherwise `_listened_fd'</span>
      <span class="token comment">// will be closed. Continue to consume all the events until EAGAIN</span>
      <span class="token comment">// instead.</span>
      <span class="token comment">// If the accept was failed, the error may repeat constantly,</span>
      <span class="token comment">// limit frequency of logging.</span>
      <span class="token function">PLOG_EVERY_SECOND</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span>
          <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to accept from listened_fd="</span> <span class="token operator">&lt;&lt;</span> acception<span class="token operator">-></span><span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Acceptor<span class="token operator">*</span> am <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Acceptor<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>acception<span class="token operator">-></span><span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> am<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Impossible! acception->user() MUST be Acceptor"</span><span class="token punctuation">;</span>
      acception<span class="token operator">-></span><span class="token function">SetFailed</span><span class="token punctuation">(</span>EINVAL<span class="token punctuation">,</span>
                           <span class="token string">"Impossible! acception->user() MUST be Acceptor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    SocketId socket_id<span class="token punctuation">;</span>
    SocketOptions options<span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>keytable_pool <span class="token operator">=</span> am<span class="token operator">-></span>_keytable_pool<span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>fd <span class="token operator">=</span> in_fd<span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>remote_side <span class="token operator">=</span> butil<span class="token double-colon punctuation">::</span><span class="token function">EndPoint</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>sockaddr_in<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>in_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>user <span class="token operator">=</span> acception<span class="token operator">-></span><span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 也就是 Acceptor 对象</span>
    options<span class="token punctuation">.</span>on_edge_triggered_events <span class="token operator">=</span> InputMessenger<span class="token double-colon punctuation">::</span>OnNewMessages<span class="token punctuation">;</span>  <span class="token comment">// 后续新消息通过 OnNewMessages 处理</span>
    options<span class="token punctuation">.</span>initial_ssl_ctx <span class="token operator">=</span> am<span class="token operator">-></span>_ssl_ctx<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">Create</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token operator">&amp;</span>socket_id<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to create Socket"</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    in_fd<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// transfer ownership to socket_id</span>

    <span class="token comment">// There's a funny race condition here. After Socket::Create, messages</span>
    <span class="token comment">// from the socket are already handled and a RPC is possibly done</span>
    <span class="token comment">// before the socket is added into _socket_map below. This is found in</span>
    <span class="token comment">// ChannelTest.skip_parallel in test/brpc_channel_unittest.cpp (running</span>
    <span class="token comment">// on machines with few cores) where the _messenger.ConnectionCount()</span>
    <span class="token comment">// may surprisingly be 0 even if the RPC is already done.</span>

    SocketUniquePtr sock<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">AddressFailedAsWell</span><span class="token punctuation">(</span>socket_id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sock<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">bool</span> is_running <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">{</span>
        <span class="token function">BAIDU_SCOPED_LOCK</span><span class="token punctuation">(</span>am<span class="token operator">-></span>_map_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        is_running <span class="token operator">=</span> <span class="token punctuation">(</span>am<span class="token operator">-></span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> RUNNING<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Always add this socket into `_socket_map' whether it</span>
        <span class="token comment">// has been `SetFailed' or not, whether `Acceptor' is</span>
        <span class="token comment">// running or not. Otherwise, `Acceptor::BeforeRecycle'</span>
        <span class="token comment">// may be called (inside Socket::OnRecycle) after `Acceptor'</span>
        <span class="token comment">// has been destroyed</span>
        am<span class="token operator">-></span>_socket_map<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>socket_id<span class="token punctuation">,</span> <span class="token function">ConnectStatistics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>is_running<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Acceptor on fd="</span> <span class="token operator">&lt;&lt;</span> acception<span class="token operator">-></span><span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                     <span class="token operator">&lt;&lt;</span> <span class="token string">" has been stopped, discard newly created "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>sock<span class="token punctuation">;</span>
        sock<span class="token operator">-></span><span class="token function">SetFailed</span><span class="token punctuation">(</span>ELOGOFF<span class="token punctuation">,</span>
                        <span class="token string">"Acceptor on fd=%d has been stopped, "</span>
                        <span class="token string">"discard newly created %s"</span><span class="token punctuation">,</span>
                        acception<span class="token operator">-></span><span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sock<span class="token operator">-></span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>  <span class="token comment">// else: The socket has already been destroyed, Don't add its id</span>
       <span class="token comment">// into _socket_map</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">inline</span> <span class="token keyword">bool</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">MoreReadEvents</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> progress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Fail to CAS means that new events arrived.</span>
    <span class="token comment">// CAS 失败的话意味着有新的连接需要继续处理</span>
    <span class="token keyword">return</span> <span class="token operator">!</span>_nevent<span class="token punctuation">.</span><span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>
        <span class="token operator">*</span>progress<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">,</span>
            butil<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>Socket</code> 的 <code>Revive</code> 流程：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// Socket 失败时增加定时任务检查连接是否可用</span>
<span class="token keyword">int</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">SetFailed</span><span class="token punctuation">(</span><span class="token keyword">int</span> error_code<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> error_fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// Do health-checking even if we're not connected before, needed</span>
  <span class="token comment">// by Channel to revive never-connected socket when server side</span>
  <span class="token comment">// comes online.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_health_check_interval_s <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">GetOrNewSharedPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>circuit_breaker<span class="token punctuation">.</span><span class="token function">MarkAsBroken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">StartHealthCheck</span><span class="token punctuation">(</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                     <span class="token function">GetOrNewSharedPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>circuit_breaker<span class="token punctuation">.</span><span class="token function">isolation_duration_ms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">// health_check.cpp</span>
<span class="token keyword">void</span> <span class="token function">StartHealthCheck</span><span class="token punctuation">(</span>SocketId id<span class="token punctuation">,</span> <span class="token keyword">int64_t</span> delay_ms<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 启动定时任务</span>
  <span class="token class-name">PeriodicTaskManager</span><span class="token double-colon punctuation">::</span><span class="token function">StartTaskAt</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">HealthCheckTask</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                   butil<span class="token double-colon punctuation">::</span><span class="token function">milliseconds_from_now</span><span class="token punctuation">(</span>delay_ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// periodic_task.cpp</span>
<span class="token keyword">void</span> <span class="token class-name">PeriodicTaskManager</span><span class="token double-colon punctuation">::</span><span class="token function">StartTaskAt</span><span class="token punctuation">(</span>PeriodicTask<span class="token operator">*</span> task<span class="token punctuation">,</span> <span class="token keyword">const</span> timespec<span class="token operator">&amp;</span> abstime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Param[task] is NULL"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  bthread_timer_t timer_id<span class="token punctuation">;</span>
  <span class="token comment">// 设定定时器，执行 RunPeriodicTaskThread</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">bthread_timer_add</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span>timer_id<span class="token punctuation">,</span> abstime<span class="token punctuation">,</span> RunPeriodicTaskThread<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to add timer for RunPerodicTaskThread"</span><span class="token punctuation">;</span>
    task<span class="token operator">-></span><span class="token function">OnDestroyingTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">RunPeriodicTaskThread</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  bthread_t th <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 时间达标时启动新的 bthread 调用 PeriodicTaskThread</span>
  <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">bthread_start_background</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span>th<span class="token punctuation">,</span> <span class="token operator">&amp;</span>BTHREAD_ATTR_NORMAL<span class="token punctuation">,</span> PeriodicTaskThread<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to start PeriodicTaskThread"</span><span class="token punctuation">;</span>
    <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>PeriodicTask<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">OnDestroyingTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">PeriodicTaskThread</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  PeriodicTask<span class="token operator">*</span> task <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>PeriodicTask<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  timespec abstime<span class="token punctuation">;</span>
  <span class="token comment">// 执行 OnTriggeringTask，返回 false 则销毁该任务</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>task<span class="token operator">-></span>OnTriggeringTask，<span class="token punctuation">(</span><span class="token operator">&amp;</span>abstime<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// end</span>
    task<span class="token operator">-></span><span class="token function">OnDestroyingTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 否则继续加入到定时器</span>
  <span class="token class-name">PeriodicTaskManager</span><span class="token double-colon punctuation">::</span><span class="token function">StartTaskAt</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> abstime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">HealthCheckTask</span><span class="token double-colon punctuation">::</span><span class="token function">OnTriggeringTask</span><span class="token punctuation">(</span>timespec<span class="token operator">*</span> next_abstime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  SocketUniquePtr ptr<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">AddressFailedAsWell</span><span class="token punctuation">(</span>_id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 获取指针</span>
  <span class="token function">CHECK</span><span class="token punctuation">(</span>rc <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RPC_VLOG <span class="token operator">&lt;&lt;</span> <span class="token string">"SocketId="</span> <span class="token operator">&lt;&lt;</span> _id
      <span class="token operator">&lt;&lt;</span> <span class="token string">" was abandoned before health checking"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Note: Making a Socket re-addessable is hard. An alternative is</span>
  <span class="token comment">// creating another Socket with selected internal fields to replace</span>
  <span class="token comment">// failed Socket. Although it avoids concurrent issues with in-place</span>
  <span class="token comment">// revive, it changes SocketId: many code need to watch SocketId </span>
  <span class="token comment">// and update on change, which is impractical. Another issue with</span>
  <span class="token comment">// this method is that it has to move "selected internal fields" </span>
  <span class="token comment">// which may be accessed in parallel, not trivial to be moved.</span>
  <span class="token comment">// Finally we choose a simple-enough solution: wait until the</span>
  <span class="token comment">// reference count hits `expected_nref', which basically means no</span>
  <span class="token comment">// one is addressing the Socket(except here). Because the Socket </span>
  <span class="token comment">// is not addressable, the reference count will not increase </span>
  <span class="token comment">// again. This solution is not perfect because the `expected_nref'</span>
  <span class="token comment">// is implementation specific. In our case, one reference comes </span>
  <span class="token comment">// from SocketMapInsert(socket_map.cpp), one reference is here. </span>
  <span class="token comment">// Although WaitAndReset() could hang when someone is addressing</span>
  <span class="token comment">// the failed Socket forever (also indicating bug), this is not an </span>
  <span class="token comment">// issue in current code. </span>
  <span class="token comment">// 这里的英文注释很详细，简而言之，这里等待引用计数为 2 时再执行 Reset 保证线程安全</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_first_time<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// Only check at first time.</span>
    _first_time <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr<span class="token operator">-></span><span class="token function">WaitAndReset</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token comment">/*note*/</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Cancel checking "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// g_vars must not be NULL because it is newed at the creation of</span>
  <span class="token comment">// first Socket. When g_vars is used, the socket is at health-checking</span>
  <span class="token comment">// state, which means the socket must be created and then g_vars can</span>
  <span class="token comment">// not be NULL.</span>
  g_vars<span class="token operator">-></span>nhealthcheck <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> hc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr<span class="token operator">-></span>_user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    hc <span class="token operator">=</span> ptr<span class="token operator">-></span>_user<span class="token operator">-></span><span class="token function">CheckHealth</span><span class="token punctuation">(</span>ptr<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用 Socket::CheckHealth</span>
    hc <span class="token operator">=</span> ptr<span class="token operator">-></span><span class="token function">CheckHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr<span class="token operator">-></span><span class="token function">CreatedByConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      g_vars<span class="token operator">-></span>channel_conn <span class="token operator">&lt;&lt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>FLAGS_health_check_path<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ptr<span class="token operator">-></span>_ninflight_app_health_check<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span>
        <span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ptr<span class="token operator">-></span><span class="token function">Revive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 恢复版本和计数</span>
    ptr<span class="token operator">-></span>_hc_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>FLAGS_health_check_path<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">HealthCheckManager</span><span class="token double-colon punctuation">::</span><span class="token function">StartCheck</span><span class="token punctuation">(</span>_id<span class="token punctuation">,</span> ptr<span class="token operator">-></span>_health_check_interval_s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>hc <span class="token operator">==</span> ESTOP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Cancel checking "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">++</span> ptr<span class="token operator">-></span>_hc_count<span class="token punctuation">;</span>
  <span class="token operator">*</span>next_abstime <span class="token operator">=</span> butil<span class="token double-colon punctuation">::</span><span class="token function">seconds_from_now</span><span class="token punctuation">(</span>ptr<span class="token operator">-></span>_health_check_interval_s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// socket.cpp</span>
<span class="token keyword">int</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">WaitAndReset</span><span class="token punctuation">(</span><span class="token keyword">int32_t</span> expected_nref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token keyword">uint32_t</span> id_ver <span class="token operator">=</span> <span class="token function">VersionOfSocketId</span><span class="token punctuation">(</span>_this_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> vref<span class="token punctuation">;</span>
  <span class="token comment">// Wait until nref == expected_nref.</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The acquire fence pairs with release fence in Dereference to avoid</span>
    <span class="token comment">// inconsistent states to be seen by others.</span>
    vref <span class="token operator">=</span> _versioned_ref<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">VersionOfVRef</span><span class="token punctuation">(</span>vref<span class="token punctuation">)</span> <span class="token operator">!=</span> id_ver <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">LOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"SocketId="</span> <span class="token operator">&lt;&lt;</span> _this_id <span class="token operator">&lt;&lt;</span> <span class="token string">" is already alive or recycled"</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">NRefOfVRef</span><span class="token punctuation">(</span>vref<span class="token punctuation">)</span> <span class="token operator">></span> expected_nref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// sleep 等待引用计数</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bthread_usleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token comment">/*FIXME*/</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PLOG_IF</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">,</span> errno <span class="token operator">!=</span> ESTOP<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to sleep"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">NRefOfVRef</span><span class="token punctuation">(</span>vref<span class="token punctuation">)</span> <span class="token operator">&lt;</span> expected_nref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      RPC_VLOG <span class="token operator">&lt;&lt;</span> <span class="token string">"SocketId="</span> <span class="token operator">&lt;&lt;</span> _this_id 
        <span class="token operator">&lt;&lt;</span> <span class="token string">" was abandoned during health checking"</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// It's safe to close previous fd (provided expected_nref is correct).</span>
  <span class="token comment">// 引用计数达标时，close 原先的 fd</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> prev_fd <span class="token operator">=</span> _fd<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ValidFileDescriptor</span><span class="token punctuation">(</span>prev_fd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_on_edge_triggered_events <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">GetGlobalEventDispatcher</span><span class="token punctuation">(</span>prev_fd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RemoveConsumer</span><span class="token punctuation">(</span>prev_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>prev_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CreatedByConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      g_vars<span class="token operator">-></span>channel_conn <span class="token operator">&lt;&lt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token comment">// 执行其他 Reset 操作</span>
<span class="token punctuation">}</span>

<span class="token comment">// We don't care about the return value of Revive.</span>
<span class="token keyword">void</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">Revive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token keyword">uint32_t</span> id_ver <span class="token operator">=</span> <span class="token function">VersionOfSocketId</span><span class="token punctuation">(</span>_this_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> vref <span class="token operator">=</span> _versioned_ref<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CHECK_EQ</span><span class="token punctuation">(</span>id_ver <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">VersionOfVRef</span><span class="token punctuation">(</span>vref<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// vref 的版本在 SetFailed 时加了 1</span>

    <span class="token keyword">int32_t</span> nref <span class="token operator">=</span> <span class="token function">NRefOfVRef</span><span class="token punctuation">(</span>vref<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nref <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CHECK_EQ</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> nref<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">LOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" was abandoned during revival"</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// +1 is the additional ref added in Create(). TODO(gejun): we should</span>
    <span class="token comment">// remove this additional nref someday.</span>
    <span class="token comment">// CAS 降低 vref 的版本到可用状态</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_versioned_ref<span class="token punctuation">.</span><span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span>
      vref<span class="token punctuation">,</span> <span class="token function">MakeVRef</span><span class="token punctuation">(</span>id_ver<span class="token punctuation">,</span> nref <span class="token operator">+</span> <span class="token number">1</span><span class="token comment">/*note*/</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      butil<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">,</span>
      butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Set this flag to true since we add additional ref again</span>
      <span class="token comment">// 清理 recycle 标记</span>
      _recycle_flag<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 调用 AfterRevived，默认会打印 Revived ... (Connectable)</span>
        _user<span class="token operator">-></span><span class="token function">AfterRevived</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Revived "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" (Connectable)"</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="references" tabindex="-1"><a href="#references">References</a></h3>
<ol>
<li><a href="https://github.com/apache/incubator-brpc/blob/master/docs/cn/io.md">&quot;bRPC IO&quot;, <em>incubator-brpc</em></a></li>
<li><a href="https://man7.org/linux/man-pages/man2/epoll_wait.2.html">&quot;epoll_wait(2)&quot;, <em>Linux Manual Page</em></a></li>
</ol>

      </div>
      <script src="https://giscus.app/client.js"
      data-repo="SF-Zhou/sf-zhou.github.io"
      data-repo-id="MDEwOlJlcG9zaXRvcnk4MDc5ODgwNg=="
      data-category="Announcements"
      data-category-id="DIC_kwDOBNDkVs4CA6GQ"
      data-mapping="title"
      data-reactions-enabled="0"
      data-emit-metadata="0"
      data-input-position="bottom"
      data-theme="preferred_color_scheme"
      data-lang="en"
      crossorigin="anonymous"
      async>
    </script>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2017 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/main.js"></script>
  </body>
</html>
