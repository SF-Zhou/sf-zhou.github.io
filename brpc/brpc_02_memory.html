<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/gitalk.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>bRPC 源码分析「二、内存管理」 | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> bRPC 源码分析「二、内存管理」 </h1>
      </div>
      <div class="info">
        <div class="date"> 2021.03.03 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <h3 id="1.-object-pool"><a href="#1.-object-pool">1. Object Pool</a></h3>
<p>代码中频繁使用的结构体大部分是等长的。根据该原理，bRPC 中设计了一个对象池，简化定长对象的分配和回收策略，尽可能地在 Thread Local 环境中进行内存操作。申请对象时按照如下的规则 BAIDU_OBJECT_POOL_GET：</p>
<ol>
<li>本线程回收列表中是否有对象，有则直接返回</li>
<li>尝试从全局获取一个回收列表，有则直接返回回收列表中的一个对象</li>
<li>本线程内存块中是否还有足够的内存，有则构造一个对象返回</li>
<li>本线程申请一个新的内存块，构造对象返回</li>
</ol>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// object_pool.h</span>
<span class="token comment">// Get an object typed |T|. The object should be cleared before usage.</span>
<span class="token comment">// NOTE: T must be default-constructible.</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span> <span class="token keyword">inline</span> T <span class="token operator">*</span><span class="token function">get_object</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token class-name">ObjectPool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get_object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// object_pool_inl.h</span>
<span class="token keyword">inline</span> T <span class="token operator">*</span><span class="token class-name">ObjectPool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">get_object</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  LocalPool <span class="token operator">*</span>lp <span class="token operator">=</span> <span class="token function">get_or_new_local_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 获取 TLS 单例</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">BAIDU_LIKELY</span><span class="token punctuation">(</span>lp <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> lp<span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 分配对象</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
BAIDU_THREAD_LOCAL
    <span class="token keyword">typename</span> <span class="token class-name">ObjectPool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span>LocalPool <span class="token operator">*</span>ObjectPool<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span>_local_pool <span class="token operator">=</span> <span class="token constant">NULL</span>

<span class="token keyword">inline</span> LocalPool <span class="token operator">*</span><span class="token class-name">ObjectPool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">get_or_new_local_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  LocalPool <span class="token operator">*</span>lp <span class="token operator">=</span> _local_pool<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">BAIDU_LIKELY</span><span class="token punctuation">(</span>lp <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> lp<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  lp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>std<span class="token operator">::</span>nothrow<span class="token punctuation">)</span> <span class="token function">LocalPool</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> lp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果用 C++11 的 thread_local，可以省略掉这里的加锁和析构注册</span>
  <span class="token function">BAIDU_SCOPED_LOCK</span><span class="token punctuation">(</span>_change_thread_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// avoid race with clear()</span>
  _local_pool <span class="token operator">=</span> lp<span class="token punctuation">;</span>
  butil<span class="token operator">::</span><span class="token function">thread_atexit</span><span class="token punctuation">(</span>LocalPool<span class="token operator">::</span>delete_local_pool<span class="token punctuation">,</span> lp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  _nlocal<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token operator">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> lp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">BAIDU_CACHELINE_ALIGNMENT</span> LocalPool <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">explicit</span> <span class="token function">LocalPool</span><span class="token punctuation">(</span>ObjectPool <span class="token operator">*</span>pool<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">_pool</span><span class="token punctuation">(</span>pool<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_cur_block</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_cur_block_index</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _cur_free<span class="token punctuation">.</span>nfree <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token operator">~</span><span class="token function">LocalPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Add to global _free if there're some free objects</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_cur_free<span class="token punctuation">.</span>nfree<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _pool<span class="token operator">-></span><span class="token function">push_free_chunk</span><span class="token punctuation">(</span>_cur_free<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    _pool<span class="token operator">-></span><span class="token function">clear_from_destructor_of_local_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">delete_local_pool</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">delete</span> <span class="token punctuation">(</span>LocalPool <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token comment">// We need following macro to construct T with different CTOR_ARGS</span>
<span class="token comment">// which may include parenthesis because when T is POD, "new T()"</span>
<span class="token comment">// and "new T" are different: former one sets all fields to 0 which</span>
<span class="token comment">// we don't want.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BAIDU_OBJECT_POOL_GET</span><span class="token expression"><span class="token punctuation">(</span>CTOR_ARGS<span class="token punctuation">)</span>                                       </span><span class="token punctuation">\</span>
  <span class="token comment">/* Fetch local free ptr */</span>                                                   <span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>_cur_free<span class="token punctuation">.</span>nfree<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                                       </span><span class="token punctuation">\</span>
    <span class="token expression">BAIDU_OBJECT_POOL_FREE_ITEM_NUM_SUB1<span class="token punctuation">;</span>                                      </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">return</span> _cur_free<span class="token punctuation">.</span>ptrs<span class="token punctuation">[</span><span class="token operator">--</span>_cur_free<span class="token punctuation">.</span>nfree<span class="token punctuation">]</span><span class="token punctuation">;</span>                                  </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span>                                                                            </span><span class="token punctuation">\</span>
  <span class="token comment">/* Fetch a FreeChunk from global.                                            \
     TODO: Popping from _free needs to copy a FreeChunk which is               \
     costly, but hardly impacts amortized performance. */</span>                      <span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>_pool<span class="token operator">-></span><span class="token function">pop_free_chunk</span><span class="token punctuation">(</span>_cur_free<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                      </span><span class="token punctuation">\</span>
    <span class="token expression">BAIDU_OBJECT_POOL_FREE_ITEM_NUM_SUB1<span class="token punctuation">;</span>                                      </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">return</span> _cur_free<span class="token punctuation">.</span>ptrs<span class="token punctuation">[</span><span class="token operator">--</span>_cur_free<span class="token punctuation">.</span>nfree<span class="token punctuation">]</span><span class="token punctuation">;</span>                                  </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span>                                                                            </span><span class="token punctuation">\</span>
  <span class="token comment">/* Fetch memory from local block */</span>                                          <span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>_cur_block <span class="token operator">&amp;&amp;</span> _cur_block<span class="token operator">-></span>nitem <span class="token operator">&lt;</span> BLOCK_NITEM<span class="token punctuation">)</span> <span class="token punctuation">{</span>                         </span><span class="token punctuation">\</span>
    <span class="token expression">T <span class="token operator">*</span>obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>T <span class="token operator">*</span><span class="token punctuation">)</span>_cur_block<span class="token operator">-></span>items <span class="token operator">+</span> _cur_block<span class="token operator">-></span>nitem<span class="token punctuation">)</span> T CTOR_ARGS<span class="token punctuation">;</span>     </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ObjectPoolValidator</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">validate</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                              </span><span class="token punctuation">\</span>
      <span class="token expression">obj<span class="token operator">-></span><span class="token operator">~</span><span class="token function">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                               </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>                                                             </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span>                                                                          </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token operator">++</span>_cur_block<span class="token operator">-></span>nitem<span class="token punctuation">;</span>                                                       </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">return</span> obj<span class="token punctuation">;</span>                                                                </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span>                                                                            </span><span class="token punctuation">\</span>
  <span class="token comment">/* Fetch a Block from global */</span>                                              <span class="token punctuation">\</span>
  <span class="token expression">_cur_block <span class="token operator">=</span> <span class="token function">add_block</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_cur_block_index<span class="token punctuation">)</span><span class="token punctuation">;</span>                                   </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>_cur_block <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                                    </span><span class="token punctuation">\</span>
    <span class="token expression">T <span class="token operator">*</span>obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>T <span class="token operator">*</span><span class="token punctuation">)</span>_cur_block<span class="token operator">-></span>items <span class="token operator">+</span> _cur_block<span class="token operator">-></span>nitem<span class="token punctuation">)</span> T CTOR_ARGS<span class="token punctuation">;</span>     </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ObjectPoolValidator</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">validate</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                              </span><span class="token punctuation">\</span>
      <span class="token expression">obj<span class="token operator">-></span><span class="token operator">~</span><span class="token function">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                               </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>                                                             </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span>                                                                          </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token operator">++</span>_cur_block<span class="token operator">-></span>nitem<span class="token punctuation">;</span>                                                       </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">return</span> obj<span class="token punctuation">;</span>                                                                </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span>                                                                            </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span></span>

  <span class="token keyword">inline</span> T <span class="token operator">*</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">BAIDU_OBJECT_POOL_GET</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">A1</span><span class="token operator">></span> <span class="token keyword">inline</span> T <span class="token operator">*</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">const</span> A1 <span class="token operator">&amp;</span>a1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">BAIDU_OBJECT_POOL_GET</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">A1</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">A2</span><span class="token operator">></span>
  <span class="token keyword">inline</span> T <span class="token operator">*</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">const</span> A1 <span class="token operator">&amp;</span>a1<span class="token punctuation">,</span> <span class="token keyword">const</span> A2 <span class="token operator">&amp;</span>a2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">BAIDU_OBJECT_POOL_GET</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">BAIDU_OBJECT_POOL_GET</span></span>

  <span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">return_object</span><span class="token punctuation">(</span>T <span class="token operator">*</span>ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Return to local free list</span>
    <span class="token comment">// 线程内对象数量没有超过阈值，仍缓存在线程中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_cur_free<span class="token punctuation">.</span>nfree <span class="token operator">&lt;</span> <span class="token class-name">ObjectPool</span><span class="token operator">::</span><span class="token function">free_chunk_nitem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _cur_free<span class="token punctuation">.</span>ptrs<span class="token punctuation">[</span>_cur_free<span class="token punctuation">.</span>nfree<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> ptr<span class="token punctuation">;</span>
      BAIDU_OBJECT_POOL_FREE_ITEM_NUM_ADD1<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Local free list is full, return it to global.</span>
    <span class="token comment">// For copying issue, check comment in upper get()</span>
    <span class="token comment">// 超过阈值，将线程中对象归还到全局缓存中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_pool<span class="token operator">-></span><span class="token function">push_free_chunk</span><span class="token punctuation">(</span>_cur_free<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _cur_free<span class="token punctuation">.</span>nfree <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      _cur_free<span class="token punctuation">.</span>ptrs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> ptr<span class="token punctuation">;</span>
      BAIDU_OBJECT_POOL_FREE_ITEM_NUM_ADD1<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  ObjectPool <span class="token operator">*</span>_pool<span class="token punctuation">;</span>
  Block <span class="token operator">*</span>_cur_block<span class="token punctuation">;</span>
  size_t _cur_block_index<span class="token punctuation">;</span>
  FreeChunk _cur_free<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 从全局缓存中获取一批对象</span>
<span class="token keyword">bool</span> <span class="token class-name">ObjectPool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">pop_free_chunk</span><span class="token punctuation">(</span>FreeChunk <span class="token operator">&amp;</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Critical for the case that most return_object are called in</span>
  <span class="token comment">// different threads of get_object.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_free_chunks<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_free_chunks_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_free_chunks<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_free_chunks_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 从 _free_chunks 尾部 pop 一批对象</span>
  DynamicFreeChunk <span class="token operator">*</span>p <span class="token operator">=</span> _free_chunks<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  _free_chunks<span class="token punctuation">.</span><span class="token function">pop_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_free_chunks_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  c<span class="token punctuation">.</span>nfree <span class="token operator">=</span> p<span class="token operator">-></span>nfree<span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ptrs<span class="token punctuation">,</span> p<span class="token operator">-></span>ptrs<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">-></span>ptrs<span class="token punctuation">)</span> <span class="token operator">*</span> p<span class="token operator">-></span>nfree<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// When a thread needs memory, it allocates a Block. To improve locality,</span>
<span class="token comment">// items in the Block are only used by the thread.</span>
<span class="token comment">// To support cache-aligned objects, align Block.items by cacheline.</span>
<span class="token keyword">struct</span> <span class="token class-name">BAIDU_CACHELINE_ALIGNMENT</span> Block <span class="token punctuation">{</span>
  <span class="token keyword">char</span> items<span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token operator">*</span> BLOCK_NITEM<span class="token punctuation">]</span><span class="token punctuation">;</span>
  size_t nitem<span class="token punctuation">;</span>

  <span class="token function">Block</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">nitem</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// An Object addresses at most OP_MAX_BLOCK_NGROUP BlockGroups,</span>
<span class="token comment">// each BlockGroup addresses at most OP_GROUP_NBLOCK blocks. So an</span>
<span class="token comment">// object addresses at most OP_MAX_BLOCK_NGROUP * OP_GROUP_NBLOCK Blocks.</span>
<span class="token comment">// 用来存储一批 blocks 的地址</span>
<span class="token keyword">struct</span> <span class="token class-name">BlockGroup</span> <span class="token punctuation">{</span>
  butil<span class="token operator">::</span>atomic<span class="token operator">&lt;</span>size_t<span class="token operator">></span> nblock<span class="token punctuation">;</span>
  butil<span class="token operator">::</span>atomic<span class="token operator">&lt;</span>Block <span class="token operator">*</span><span class="token operator">></span> blocks<span class="token punctuation">[</span>OP_GROUP_NBLOCK<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">BlockGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">nblock</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// We fetch_add nblock in add_block() before setting the entry,</span>
    <span class="token comment">// thus address_resource() may sees the unset entry. Initialize</span>
    <span class="token comment">// all entries to NULL makes such address_resource() return NULL.</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>blocks<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>butil<span class="token operator">::</span>atomic<span class="token operator">&lt;</span>Block <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">*</span> OP_GROUP_NBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Create a Block and append it to right-most BlockGroup.</span>
<span class="token keyword">static</span> Block <span class="token operator">*</span><span class="token class-name">ObjectPool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">add_block</span><span class="token punctuation">(</span>size_t <span class="token operator">*</span>index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Block <span class="token operator">*</span><span class="token keyword">const</span> new_block <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>std<span class="token operator">::</span>nothrow<span class="token punctuation">)</span> Block<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> new_block<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  size_t ngroup<span class="token punctuation">;</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    ngroup <span class="token operator">=</span> _ngroup<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token operator">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ngroup <span class="token operator">>=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      BlockGroup <span class="token operator">*</span><span class="token keyword">const</span> g <span class="token operator">=</span>
        _block_groups<span class="token punctuation">[</span>ngroup <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token operator">::</span>memory_order_consume<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> size_t block_index <span class="token operator">=</span>
        g<span class="token operator">-></span>nblock<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token operator">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 原子加</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>block_index <span class="token operator">&lt;</span> OP_GROUP_NBLOCK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果当前 group 的大小没有超过阈值，成功增加 block</span>
        g<span class="token operator">-></span>blocks<span class="token punctuation">[</span>block_index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>new_block<span class="token punctuation">,</span> butil<span class="token operator">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>index <span class="token operator">=</span> <span class="token punctuation">(</span>ngroup <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> OP_GROUP_NBLOCK <span class="token operator">+</span> block_index<span class="token punctuation">;</span>
        <span class="token keyword">return</span> new_block<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 否则将增加的计数减去，增加新的 group</span>
      g<span class="token operator">-></span>nblock<span class="token punctuation">.</span><span class="token function">fetch_sub</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token operator">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">add_block_group</span><span class="token punctuation">(</span>ngroup<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Fail to add_block_group.</span>
  <span class="token keyword">delete</span> new_block<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Create a BlockGroup and append it to _block_groups.</span>
<span class="token comment">// Shall be called infrequently because a BlockGroup is pretty big.</span>
<span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">add_block_group</span><span class="token punctuation">(</span>size_t old_ngroup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  BlockGroup <span class="token operator">*</span>bg <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token function">BAIDU_SCOPED_LOCK</span><span class="token punctuation">(</span>_block_group_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 加锁</span>
  <span class="token keyword">const</span> size_t ngroup <span class="token operator">=</span> _ngroup<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token operator">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ngroup <span class="token operator">!=</span> old_ngroup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Other thread got lock and added group before this thread.</span>
    <span class="token comment">// 有其他线程成功增加了 block group，需要重试</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ngroup <span class="token operator">&lt;</span> OP_MAX_BLOCK_NGROUP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>std<span class="token operator">::</span>nothrow<span class="token punctuation">)</span> BlockGroup<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> bg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Release fence is paired with consume fence in add_block()</span>
      <span class="token comment">// to avoid un-constructed bg to be seen by other threads.</span>
      <span class="token comment">// 成功增加 block group</span>
      _block_groups<span class="token punctuation">[</span>ngroup<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>bg<span class="token punctuation">,</span> butil<span class="token operator">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
      _ngroup<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>ngroup <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token operator">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> bg <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>回收对象时不进行析构和删除，仅将其指针加入本线程的缓存列表中，积累后一定阈值后有锁地加入全局缓存中。注意申请对象时是申请整段内存，返回的对象并不具有其对应内存的所有权，必须调用内存池提供的 <code>return_object</code> 接口进行回收。默认实现中所有申请的对象都不会进行<strong>析构</strong>和<strong>删除</strong>，意味着内存占用是不会回落的，类似 <code>std::vector</code>。</p>
<h3 id="2.-resource-pool"><a href="#2.-resource-pool">2. Resource Pool</a></h3>
<p>资源池的设计与上文中的对象池类似，不同的是引入了 <code>ResourceId</code> 的概念，表示该资源在对象池中的偏移量：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// resource_pool_inl.h</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span> <span class="token keyword">struct</span> <span class="token class-name">ResourceId</span> <span class="token punctuation">{</span>
  <span class="token keyword">uint64_t</span> value<span class="token punctuation">;</span>

  <span class="token keyword">operator</span> <span class="token keyword">uint64_t</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T2</span><span class="token operator">></span> ResourceId<span class="token operator">&lt;</span>T2<span class="token operator">></span> <span class="token function">cast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    ResourceId<span class="token operator">&lt;</span>T2<span class="token operator">></span> id <span class="token operator">=</span> <span class="token punctuation">{</span>value<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> id<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token punctuation">,</span> size_t NITEM<span class="token operator">></span> <span class="token keyword">struct</span> <span class="token class-name">ResourcePoolFreeChunk</span> <span class="token punctuation">{</span>
  size_t nfree<span class="token punctuation">;</span>
  ResourceId<span class="token operator">&lt;</span>T<span class="token operator">></span> ids<span class="token punctuation">[</span>NITEM<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// We need following macro to construct T with different CTOR_ARGS</span>
    <span class="token comment">// which may include parenthesis because when T is POD, "new T()"</span>
    <span class="token comment">// and "new T" are different: former one sets all fields to 0 which</span>
    <span class="token comment">// we don't want.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BAIDU_RESOURCE_POOL_GET</span><span class="token expression"><span class="token punctuation">(</span>CTOR_ARGS<span class="token punctuation">)</span>                                     </span><span class="token punctuation">\</span>
  <span class="token comment">/* Fetch local free id */</span>                                                    <span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>_cur_free<span class="token punctuation">.</span>nfree<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                                       </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">const</span> ResourceId<span class="token operator">&lt;</span>T<span class="token operator">></span> free_id <span class="token operator">=</span> _cur_free<span class="token punctuation">.</span>ids<span class="token punctuation">[</span><span class="token operator">--</span>_cur_free<span class="token punctuation">.</span>nfree<span class="token punctuation">]</span><span class="token punctuation">;</span>            </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token operator">*</span>id <span class="token operator">=</span> free_id<span class="token punctuation">;</span>                                                             </span><span class="token punctuation">\</span>
    <span class="token expression">BAIDU_RESOURCE_POOL_FREE_ITEM_NUM_SUB1<span class="token punctuation">;</span>                                    </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">return</span> <span class="token function">unsafe_address_resource</span><span class="token punctuation">(</span>free_id<span class="token punctuation">)</span><span class="token punctuation">;</span>                                   </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span>                                                                            </span><span class="token punctuation">\</span>
  <span class="token comment">/* Fetch a FreeChunk from global.                                            \
     TODO: Popping from _free needs to copy a FreeChunk which is               \
     costly, but hardly impacts amortized performance. */</span>                      <span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>_pool<span class="token operator">-></span><span class="token function">pop_free_chunk</span><span class="token punctuation">(</span>_cur_free<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                      </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token operator">--</span>_cur_free<span class="token punctuation">.</span>nfree<span class="token punctuation">;</span>                                                         </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">const</span> ResourceId<span class="token operator">&lt;</span>T<span class="token operator">></span> free_id <span class="token operator">=</span> _cur_free<span class="token punctuation">.</span>ids<span class="token punctuation">[</span>_cur_free<span class="token punctuation">.</span>nfree<span class="token punctuation">]</span><span class="token punctuation">;</span>              </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token operator">*</span>id <span class="token operator">=</span> free_id<span class="token punctuation">;</span>                                                             </span><span class="token punctuation">\</span>
    <span class="token expression">BAIDU_RESOURCE_POOL_FREE_ITEM_NUM_SUB1<span class="token punctuation">;</span>                                    </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">return</span> <span class="token function">unsafe_address_resource</span><span class="token punctuation">(</span>free_id<span class="token punctuation">)</span><span class="token punctuation">;</span>                                   </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span>                                                                            </span><span class="token punctuation">\</span>
  <span class="token comment">/* Fetch memory from local block */</span>                                          <span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>_cur_block <span class="token operator">&amp;&amp;</span> _cur_block<span class="token operator">-></span>nitem <span class="token operator">&lt;</span> BLOCK_NITEM<span class="token punctuation">)</span> <span class="token punctuation">{</span>                         </span><span class="token punctuation">\</span>
    <span class="token expression">id<span class="token operator">-></span>value <span class="token operator">=</span> _cur_block_index <span class="token operator">*</span> BLOCK_NITEM <span class="token operator">+</span> _cur_block<span class="token operator">-></span>nitem<span class="token punctuation">;</span>            </span><span class="token punctuation">\</span>
    <span class="token expression">T <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>T <span class="token operator">*</span><span class="token punctuation">)</span>_cur_block<span class="token operator">-></span>items <span class="token operator">+</span> _cur_block<span class="token operator">-></span>nitem<span class="token punctuation">)</span> T CTOR_ARGS<span class="token punctuation">;</span>       </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ResourcePoolValidator</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">validate</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                              </span><span class="token punctuation">\</span>
      <span class="token expression">p<span class="token operator">-></span><span class="token operator">~</span><span class="token function">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                                 </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>                                                             </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span>                                                                          </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token operator">++</span>_cur_block<span class="token operator">-></span>nitem<span class="token punctuation">;</span>                                                       </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">return</span> p<span class="token punctuation">;</span>                                                                  </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span>                                                                            </span><span class="token punctuation">\</span>
  <span class="token comment">/* Fetch a Block from global */</span>                                              <span class="token punctuation">\</span>
  <span class="token expression">_cur_block <span class="token operator">=</span> <span class="token function">add_block</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_cur_block_index<span class="token punctuation">)</span><span class="token punctuation">;</span>                                   </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>_cur_block <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                                    </span><span class="token punctuation">\</span>
    <span class="token expression">id<span class="token operator">-></span>value <span class="token operator">=</span> _cur_block_index <span class="token operator">*</span> BLOCK_NITEM <span class="token operator">+</span> _cur_block<span class="token operator">-></span>nitem<span class="token punctuation">;</span>            </span><span class="token punctuation">\</span>
    <span class="token expression">T <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>T <span class="token operator">*</span><span class="token punctuation">)</span>_cur_block<span class="token operator">-></span>items <span class="token operator">+</span> _cur_block<span class="token operator">-></span>nitem<span class="token punctuation">)</span> T CTOR_ARGS<span class="token punctuation">;</span>       </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ResourcePoolValidator</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">validate</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                              </span><span class="token punctuation">\</span>
      <span class="token expression">p<span class="token operator">-></span><span class="token operator">~</span><span class="token function">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                                 </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>                                                             </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span>                                                                          </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token operator">++</span>_cur_block<span class="token operator">-></span>nitem<span class="token punctuation">;</span>                                                       </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">return</span> p<span class="token punctuation">;</span>                                                                  </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span>                                                                            </span><span class="token punctuation">\</span>
</span></code></pre>
<p>注意 <code>ResourceId</code> 的计算公式：<code>_cur_block_index * BLOCK_NITEM + _cur_block-&gt;nitem</code>，可以在 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></eq> 的时间内反推对象的内存地址：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">inline</span> T <span class="token operator">*</span><span class="token function">address_resource</span><span class="token punctuation">(</span>ResourceId<span class="token operator">&lt;</span>T<span class="token operator">></span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> size_t block_index <span class="token operator">=</span> id<span class="token punctuation">.</span>value <span class="token operator">/</span> BLOCK_NITEM<span class="token punctuation">;</span>
  <span class="token keyword">const</span> size_t group_index <span class="token operator">=</span> <span class="token punctuation">(</span>block_index <span class="token operator">>></span> RP_GROUP_NBLOCK_NBIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span>group_index <span class="token operator">&lt;</span> RP_MAX_BLOCK_NGROUP<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    BlockGroup <span class="token operator">*</span>bg <span class="token operator">=</span>
      _block_groups<span class="token punctuation">[</span>group_index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token operator">::</span>memory_order_consume<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span>bg <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Block <span class="token operator">*</span>b <span class="token operator">=</span> bg<span class="token operator">-></span>blocks<span class="token punctuation">[</span>block_index <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RP_GROUP_NBLOCK <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>
        butil<span class="token operator">::</span>memory_order_consume<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span>b <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> size_t offset <span class="token operator">=</span> id<span class="token punctuation">.</span>value <span class="token operator">-</span> block_index <span class="token operator">*</span> BLOCK_NITEM<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span>offset <span class="token operator">&lt;</span> b<span class="token operator">-></span>nitem<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">(</span>T <span class="token operator">*</span><span class="token punctuation">)</span>b<span class="token operator">-></span>items <span class="token operator">+</span> offset<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>大多数场景下 <code>ResourceId</code> 小于 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>32</mn></msup></mrow><annotation encoding="application/x-tex">2^{32}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></eq>（除非全局对象数量超过 40+ 亿），bRPC 利用这一点将其编码为 64 位 ID 的一部分，余下的部分放置对象的版本。以下描述引用自参考文献一。</p>
<blockquote>
<p>对象可以被归还，但归还后对象并没有删除，也没有被析构，而是仅仅进入回收列表。下次申请时可能会取到这种使用过的对象，需要重置后才能使用。当对象被归还后，通过对应的偏移量仍可以访问到对象，即 ResourcePool 只负责内存分配，并不解决 ABA 问题。</p>
<p>bthread 的大部分函数都需要在 O(1) 时间内通过 bthread_t 访问到 TaskMeta，并且当 bthread_t 失效后，访问应返回 NULL 以让函数做出返回错误。解决方法是：bthread_t 由 32 位的版本和 32 位的偏移量组成。版本解决 <a href="http://en.wikipedia.org/wiki/ABA_problem">ABA 问题</a>，偏移量由ResourcePool 分配。查找时先通过偏移量获得 TaskMeta，再检查版本，如果版本不匹配，说明 bthread 失效了。</p>
</blockquote>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// task_group_inl.h</span>
<span class="token comment">// Utilities to manipulate bthread_t</span>
<span class="token keyword">inline</span> bthread_t <span class="token function">make_tid</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> version<span class="token punctuation">,</span> butil<span class="token operator">::</span>ResourceId<span class="token operator">&lt;</span>TaskMeta<span class="token operator">></span> slot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bthread_t<span class="token punctuation">)</span>version<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>bthread_t<span class="token punctuation">)</span>slot<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">inline</span> butil<span class="token operator">::</span>ResourceId<span class="token operator">&lt;</span>TaskMeta<span class="token operator">></span> <span class="token function">get_slot</span><span class="token punctuation">(</span>bthread_t tid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  butil<span class="token operator">::</span>ResourceId<span class="token operator">&lt;</span>TaskMeta<span class="token operator">></span> id <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">(</span>tid <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFFul</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> id<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">inline</span> <span class="token keyword">uint32_t</span> <span class="token function">get_version</span><span class="token punctuation">(</span>bthread_t tid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tid <span class="token operator">>></span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFFul</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">inline</span> TaskMeta <span class="token operator">*</span><span class="token class-name">TaskGroup</span><span class="token operator">::</span><span class="token function">address_meta</span><span class="token punctuation">(</span>bthread_t tid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// TaskMeta * m = address_resource&lt;TaskMeta>(get_slot(tid));</span>
  <span class="token comment">// if (m != NULL &amp;&amp; m->version == get_version(tid)) {</span>
  <span class="token comment">//     return m;</span>
  <span class="token comment">// }</span>
  <span class="token comment">// return NULL;</span>
  <span class="token keyword">return</span> <span class="token function">address_resource</span><span class="token punctuation">(</span><span class="token function">get_slot</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// task_group.cpp</span>
<span class="token comment">// 版本使用举例</span>
<span class="token keyword">bool</span> <span class="token class-name">TaskGroup</span><span class="token operator">::</span><span class="token function">exists</span><span class="token punctuation">(</span>bthread_t tid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// tid of bthread is never 0.</span>
    TaskMeta <span class="token operator">*</span>m <span class="token operator">=</span> <span class="token function">address_meta</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token operator">-></span>version_butex <span class="token operator">==</span> <span class="token function">get_version</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 判断版本是否一致</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="references"><a href="#references">References</a></h3>
<ol>
<li><a href="https://github.com/apache/incubator-brpc/blob/master/docs/cn/memory_management.md">&quot;bRPC Memory Management&quot;, <em>incubator-brpc</em></a></li>
</ol>

      </div>
      <div id="gitalk-container">
      </div>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2021 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/gitalk.min.js"></script>
    <script src="/dist/main.js"></script>
  </body>
</html>
