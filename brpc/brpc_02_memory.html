<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/gitalk.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>bRPC 源码分析「二、资源管理」 | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> bRPC 源码分析「二、资源管理」 </h1>
      </div>
      <div class="markdown">
        <h3 id="1.-object-pool" tabindex="-1"><a href="#1.-object-pool">1. Object Pool</a></h3>
<p>代码中频繁使用的结构体大部分是等长的。根据该原理，bRPC 中设计了一个对象池，简化定长对象的分配和回收策略，尽可能地在 Thread Local 环境中进行内存操作。申请对象时按照如下的规则 BAIDU_OBJECT_POOL_GET：</p>
<ol>
<li>本线程回收列表中是否有对象，有则直接返回</li>
<li>尝试从全局获取一个回收列表，有则直接返回回收列表中的一个对象</li>
<li>本线程内存块中是否还有足够的内存，有则构造一个对象返回</li>
<li>本线程申请一个新的内存块，构造对象返回</li>
</ol>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// object_pool.h</span>
<span class="token comment">// Get an object typed |T|. The object should be cleared before usage.</span>
<span class="token comment">// NOTE: T must be default-constructible.</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span> <span class="token keyword">inline</span> T <span class="token operator">*</span><span class="token function">get_object</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token class-name">ObjectPool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get_object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// object_pool_inl.h</span>
<span class="token keyword">inline</span> T <span class="token operator">*</span><span class="token class-name">ObjectPool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">get_object</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  LocalPool <span class="token operator">*</span>lp <span class="token operator">=</span> <span class="token function">get_or_new_local_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 获取 TLS 单例</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">BAIDU_LIKELY</span><span class="token punctuation">(</span>lp <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> lp<span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 分配对象</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
BAIDU_THREAD_LOCAL
    <span class="token keyword">typename</span> <span class="token class-name">ObjectPool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token double-colon punctuation">::</span>LocalPool <span class="token operator">*</span>ObjectPool<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token double-colon punctuation">::</span>_local_pool <span class="token operator">=</span> <span class="token constant">NULL</span>

<span class="token keyword">inline</span> LocalPool <span class="token operator">*</span><span class="token class-name">ObjectPool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">get_or_new_local_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  LocalPool <span class="token operator">*</span>lp <span class="token operator">=</span> _local_pool<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">BAIDU_LIKELY</span><span class="token punctuation">(</span>lp <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> lp<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  lp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>nothrow<span class="token punctuation">)</span> <span class="token function">LocalPool</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> lp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果用 C++11 的 thread_local，可以省略掉这里的加锁和析构注册</span>
  <span class="token function">BAIDU_SCOPED_LOCK</span><span class="token punctuation">(</span>_change_thread_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// avoid race with clear()</span>
  _local_pool <span class="token operator">=</span> lp<span class="token punctuation">;</span>
  butil<span class="token double-colon punctuation">::</span><span class="token function">thread_atexit</span><span class="token punctuation">(</span>LocalPool<span class="token double-colon punctuation">::</span>delete_local_pool<span class="token punctuation">,</span> lp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  _nlocal<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> lp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">BAIDU_CACHELINE_ALIGNMENT</span> LocalPool <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">explicit</span> <span class="token function">LocalPool</span><span class="token punctuation">(</span>ObjectPool <span class="token operator">*</span>pool<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">_pool</span><span class="token punctuation">(</span>pool<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_cur_block</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_cur_block_index</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _cur_free<span class="token punctuation">.</span>nfree <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token operator">~</span><span class="token function">LocalPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Add to global _free if there're some free objects</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_cur_free<span class="token punctuation">.</span>nfree<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _pool<span class="token operator">-></span><span class="token function">push_free_chunk</span><span class="token punctuation">(</span>_cur_free<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    _pool<span class="token operator">-></span><span class="token function">clear_from_destructor_of_local_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">delete_local_pool</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">delete</span> <span class="token punctuation">(</span>LocalPool <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token comment">// We need following macro to construct T with different CTOR_ARGS</span>
<span class="token comment">// which may include parenthesis because when T is POD, "new T()"</span>
<span class="token comment">// and "new T" are different: former one sets all fields to 0 which</span>
<span class="token comment">// we don't want.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BAIDU_OBJECT_POOL_GET</span><span class="token expression"><span class="token punctuation">(</span>CTOR_ARGS<span class="token punctuation">)</span>                                       </span><span class="token punctuation">\</span>
  <span class="token comment">/* Fetch local free ptr */</span>                                                   <span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>_cur_free<span class="token punctuation">.</span>nfree<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                                       </span><span class="token punctuation">\</span>
    <span class="token expression">BAIDU_OBJECT_POOL_FREE_ITEM_NUM_SUB1<span class="token punctuation">;</span>                                      </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">return</span> _cur_free<span class="token punctuation">.</span>ptrs<span class="token punctuation">[</span><span class="token operator">--</span>_cur_free<span class="token punctuation">.</span>nfree<span class="token punctuation">]</span><span class="token punctuation">;</span>                                  </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span>                                                                            </span><span class="token punctuation">\</span>
  <span class="token comment">/* Fetch a FreeChunk from global.                                            \
     TODO: Popping from _free needs to copy a FreeChunk which is               \
     costly, but hardly impacts amortized performance. */</span>                      <span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>_pool<span class="token operator">-></span><span class="token function">pop_free_chunk</span><span class="token punctuation">(</span>_cur_free<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                      </span><span class="token punctuation">\</span>
    <span class="token expression">BAIDU_OBJECT_POOL_FREE_ITEM_NUM_SUB1<span class="token punctuation">;</span>                                      </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">return</span> _cur_free<span class="token punctuation">.</span>ptrs<span class="token punctuation">[</span><span class="token operator">--</span>_cur_free<span class="token punctuation">.</span>nfree<span class="token punctuation">]</span><span class="token punctuation">;</span>                                  </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span>                                                                            </span><span class="token punctuation">\</span>
  <span class="token comment">/* Fetch memory from local block */</span>                                          <span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>_cur_block <span class="token operator">&amp;&amp;</span> _cur_block<span class="token operator">-></span>nitem <span class="token operator">&lt;</span> BLOCK_NITEM<span class="token punctuation">)</span> <span class="token punctuation">{</span>                         </span><span class="token punctuation">\</span>
    <span class="token expression">T <span class="token operator">*</span>obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>T <span class="token operator">*</span><span class="token punctuation">)</span>_cur_block<span class="token operator">-></span>items <span class="token operator">+</span> _cur_block<span class="token operator">-></span>nitem<span class="token punctuation">)</span> T CTOR_ARGS<span class="token punctuation">;</span>     </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ObjectPoolValidator</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">validate</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                              </span><span class="token punctuation">\</span>
      <span class="token expression">obj<span class="token operator">-></span><span class="token operator">~</span><span class="token function">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                               </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>                                                             </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span>                                                                          </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token operator">++</span>_cur_block<span class="token operator">-></span>nitem<span class="token punctuation">;</span>                                                       </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">return</span> obj<span class="token punctuation">;</span>                                                                </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span>                                                                            </span><span class="token punctuation">\</span>
  <span class="token comment">/* Fetch a Block from global */</span>                                              <span class="token punctuation">\</span>
  <span class="token expression">_cur_block <span class="token operator">=</span> <span class="token function">add_block</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_cur_block_index<span class="token punctuation">)</span><span class="token punctuation">;</span>                                   </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>_cur_block <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                                    </span><span class="token punctuation">\</span>
    <span class="token expression">T <span class="token operator">*</span>obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>T <span class="token operator">*</span><span class="token punctuation">)</span>_cur_block<span class="token operator">-></span>items <span class="token operator">+</span> _cur_block<span class="token operator">-></span>nitem<span class="token punctuation">)</span> T CTOR_ARGS<span class="token punctuation">;</span>     </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ObjectPoolValidator</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">validate</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                              </span><span class="token punctuation">\</span>
      <span class="token expression">obj<span class="token operator">-></span><span class="token operator">~</span><span class="token function">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                               </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>                                                             </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span>                                                                          </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token operator">++</span>_cur_block<span class="token operator">-></span>nitem<span class="token punctuation">;</span>                                                       </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">return</span> obj<span class="token punctuation">;</span>                                                                </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span>                                                                            </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span></span>

  <span class="token keyword">inline</span> T <span class="token operator">*</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">BAIDU_OBJECT_POOL_GET</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">A1</span><span class="token operator">></span> <span class="token keyword">inline</span> T <span class="token operator">*</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">const</span> A1 <span class="token operator">&amp;</span>a1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">BAIDU_OBJECT_POOL_GET</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">A1</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">A2</span><span class="token operator">></span>
  <span class="token keyword">inline</span> T <span class="token operator">*</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">const</span> A1 <span class="token operator">&amp;</span>a1<span class="token punctuation">,</span> <span class="token keyword">const</span> A2 <span class="token operator">&amp;</span>a2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">BAIDU_OBJECT_POOL_GET</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">BAIDU_OBJECT_POOL_GET</span></span>

  <span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">return_object</span><span class="token punctuation">(</span>T <span class="token operator">*</span>ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Return to local free list</span>
    <span class="token comment">// 线程内对象数量没有超过阈值，仍缓存在线程中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_cur_free<span class="token punctuation">.</span>nfree <span class="token operator">&lt;</span> <span class="token class-name">ObjectPool</span><span class="token double-colon punctuation">::</span><span class="token function">free_chunk_nitem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _cur_free<span class="token punctuation">.</span>ptrs<span class="token punctuation">[</span>_cur_free<span class="token punctuation">.</span>nfree<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> ptr<span class="token punctuation">;</span>
      BAIDU_OBJECT_POOL_FREE_ITEM_NUM_ADD1<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Local free list is full, return it to global.</span>
    <span class="token comment">// For copying issue, check comment in upper get()</span>
    <span class="token comment">// 超过阈值，将线程中对象归还到全局缓存中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_pool<span class="token operator">-></span><span class="token function">push_free_chunk</span><span class="token punctuation">(</span>_cur_free<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _cur_free<span class="token punctuation">.</span>nfree <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      _cur_free<span class="token punctuation">.</span>ptrs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> ptr<span class="token punctuation">;</span>
      BAIDU_OBJECT_POOL_FREE_ITEM_NUM_ADD1<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  ObjectPool <span class="token operator">*</span>_pool<span class="token punctuation">;</span>
  Block <span class="token operator">*</span>_cur_block<span class="token punctuation">;</span>
  size_t _cur_block_index<span class="token punctuation">;</span>
  FreeChunk _cur_free<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 从全局缓存中获取一批对象</span>
<span class="token keyword">bool</span> <span class="token class-name">ObjectPool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">pop_free_chunk</span><span class="token punctuation">(</span>FreeChunk <span class="token operator">&amp;</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Critical for the case that most return_object are called in</span>
  <span class="token comment">// different threads of get_object.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_free_chunks<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_free_chunks_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_free_chunks<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_free_chunks_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 从 _free_chunks 尾部 pop 一批对象</span>
  DynamicFreeChunk <span class="token operator">*</span>p <span class="token operator">=</span> _free_chunks<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  _free_chunks<span class="token punctuation">.</span><span class="token function">pop_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_free_chunks_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  c<span class="token punctuation">.</span>nfree <span class="token operator">=</span> p<span class="token operator">-></span>nfree<span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ptrs<span class="token punctuation">,</span> p<span class="token operator">-></span>ptrs<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">-></span>ptrs<span class="token punctuation">)</span> <span class="token operator">*</span> p<span class="token operator">-></span>nfree<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// When a thread needs memory, it allocates a Block. To improve locality,</span>
<span class="token comment">// items in the Block are only used by the thread.</span>
<span class="token comment">// To support cache-aligned objects, align Block.items by cacheline.</span>
<span class="token keyword">struct</span> <span class="token class-name">BAIDU_CACHELINE_ALIGNMENT</span> Block <span class="token punctuation">{</span>
  <span class="token keyword">char</span> items<span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token operator">*</span> BLOCK_NITEM<span class="token punctuation">]</span><span class="token punctuation">;</span>
  size_t nitem<span class="token punctuation">;</span>

  <span class="token function">Block</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">nitem</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// An Object addresses at most OP_MAX_BLOCK_NGROUP BlockGroups,</span>
<span class="token comment">// each BlockGroup addresses at most OP_GROUP_NBLOCK blocks. So an</span>
<span class="token comment">// object addresses at most OP_MAX_BLOCK_NGROUP * OP_GROUP_NBLOCK Blocks.</span>
<span class="token comment">// 用来存储一批 blocks 的地址</span>
<span class="token keyword">struct</span> <span class="token class-name">BlockGroup</span> <span class="token punctuation">{</span>
  butil<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>size_t<span class="token operator">></span> nblock<span class="token punctuation">;</span>
  butil<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>Block <span class="token operator">*</span><span class="token operator">></span> blocks<span class="token punctuation">[</span>OP_GROUP_NBLOCK<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">BlockGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">nblock</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// We fetch_add nblock in add_block() before setting the entry,</span>
    <span class="token comment">// thus address_resource() may sees the unset entry. Initialize</span>
    <span class="token comment">// all entries to NULL makes such address_resource() return NULL.</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>blocks<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>Block <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">*</span> OP_GROUP_NBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Create a Block and append it to right-most BlockGroup.</span>
<span class="token keyword">static</span> Block <span class="token operator">*</span><span class="token class-name">ObjectPool</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">add_block</span><span class="token punctuation">(</span>size_t <span class="token operator">*</span>index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Block <span class="token operator">*</span><span class="token keyword">const</span> new_block <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>nothrow<span class="token punctuation">)</span> Block<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> new_block<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  size_t ngroup<span class="token punctuation">;</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    ngroup <span class="token operator">=</span> _ngroup<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ngroup <span class="token operator">>=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      BlockGroup <span class="token operator">*</span><span class="token keyword">const</span> g <span class="token operator">=</span>
        _block_groups<span class="token punctuation">[</span>ngroup <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_consume<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> size_t block_index <span class="token operator">=</span>
        g<span class="token operator">-></span>nblock<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 原子加</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>block_index <span class="token operator">&lt;</span> OP_GROUP_NBLOCK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果当前 group 的大小没有超过阈值，成功增加 block</span>
        g<span class="token operator">-></span>blocks<span class="token punctuation">[</span>block_index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>new_block<span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>index <span class="token operator">=</span> <span class="token punctuation">(</span>ngroup <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> OP_GROUP_NBLOCK <span class="token operator">+</span> block_index<span class="token punctuation">;</span>
        <span class="token keyword">return</span> new_block<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 否则将增加的计数减去，增加新的 group</span>
      g<span class="token operator">-></span>nblock<span class="token punctuation">.</span><span class="token function">fetch_sub</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">add_block_group</span><span class="token punctuation">(</span>ngroup<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Fail to add_block_group.</span>
  <span class="token keyword">delete</span> new_block<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Create a BlockGroup and append it to _block_groups.</span>
<span class="token comment">// Shall be called infrequently because a BlockGroup is pretty big.</span>
<span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">add_block_group</span><span class="token punctuation">(</span>size_t old_ngroup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  BlockGroup <span class="token operator">*</span>bg <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token function">BAIDU_SCOPED_LOCK</span><span class="token punctuation">(</span>_block_group_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 加锁</span>
  <span class="token keyword">const</span> size_t ngroup <span class="token operator">=</span> _ngroup<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ngroup <span class="token operator">!=</span> old_ngroup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Other thread got lock and added group before this thread.</span>
    <span class="token comment">// 有其他线程成功增加了 block group，需要重试</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ngroup <span class="token operator">&lt;</span> OP_MAX_BLOCK_NGROUP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>nothrow<span class="token punctuation">)</span> BlockGroup<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> bg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Release fence is paired with consume fence in add_block()</span>
      <span class="token comment">// to avoid un-constructed bg to be seen by other threads.</span>
      <span class="token comment">// 成功增加 block group</span>
      _block_groups<span class="token punctuation">[</span>ngroup<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>bg<span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
      _ngroup<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>ngroup <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> bg <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>回收对象时不进行析构和删除，仅将其指针加入本线程的缓存列表中，积累后一定阈值后有锁地加入全局缓存中。注意申请对象时是申请整段内存，返回的对象并不具有其对应内存的所有权，必须调用内存池提供的 <code>return_object</code> 接口进行回收。默认实现中所有申请的对象都不会进行<strong>析构</strong>和<strong>删除</strong>，意味着内存占用是不会回落的，类似 <code>std::vector</code>。</p>
<h3 id="2.-resource-pool" tabindex="-1"><a href="#2.-resource-pool">2. Resource Pool</a></h3>
<p>资源池的设计与上文中的对象池类似，不同的是引入了 <code>ResourceId</code> 的概念，表示该资源在对象池中的偏移量：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// resource_pool_inl.h</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span> <span class="token keyword">struct</span> <span class="token class-name">ResourceId</span> <span class="token punctuation">{</span>
  <span class="token keyword">uint64_t</span> value<span class="token punctuation">;</span>

  <span class="token keyword">operator</span> <span class="token keyword">uint64_t</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T2</span><span class="token operator">></span> ResourceId<span class="token operator">&lt;</span>T2<span class="token operator">></span> <span class="token function">cast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    ResourceId<span class="token operator">&lt;</span>T2<span class="token operator">></span> id <span class="token operator">=</span> <span class="token punctuation">{</span>value<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> id<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token punctuation">,</span> size_t NITEM<span class="token operator">></span> <span class="token keyword">struct</span> <span class="token class-name">ResourcePoolFreeChunk</span> <span class="token punctuation">{</span>
  size_t nfree<span class="token punctuation">;</span>
  ResourceId<span class="token operator">&lt;</span>T<span class="token operator">></span> ids<span class="token punctuation">[</span>NITEM<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// We need following macro to construct T with different CTOR_ARGS</span>
    <span class="token comment">// which may include parenthesis because when T is POD, "new T()"</span>
    <span class="token comment">// and "new T" are different: former one sets all fields to 0 which</span>
    <span class="token comment">// we don't want.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BAIDU_RESOURCE_POOL_GET</span><span class="token expression"><span class="token punctuation">(</span>CTOR_ARGS<span class="token punctuation">)</span>                                     </span><span class="token punctuation">\</span>
  <span class="token comment">/* Fetch local free id */</span>                                                    <span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>_cur_free<span class="token punctuation">.</span>nfree<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                                       </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">const</span> ResourceId<span class="token operator">&lt;</span>T<span class="token operator">></span> free_id <span class="token operator">=</span> _cur_free<span class="token punctuation">.</span>ids<span class="token punctuation">[</span><span class="token operator">--</span>_cur_free<span class="token punctuation">.</span>nfree<span class="token punctuation">]</span><span class="token punctuation">;</span>            </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token operator">*</span>id <span class="token operator">=</span> free_id<span class="token punctuation">;</span>                                                             </span><span class="token punctuation">\</span>
    <span class="token expression">BAIDU_RESOURCE_POOL_FREE_ITEM_NUM_SUB1<span class="token punctuation">;</span>                                    </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">return</span> <span class="token function">unsafe_address_resource</span><span class="token punctuation">(</span>free_id<span class="token punctuation">)</span><span class="token punctuation">;</span>                                   </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span>                                                                            </span><span class="token punctuation">\</span>
  <span class="token comment">/* Fetch a FreeChunk from global.                                            \
     TODO: Popping from _free needs to copy a FreeChunk which is               \
     costly, but hardly impacts amortized performance. */</span>                      <span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>_pool<span class="token operator">-></span><span class="token function">pop_free_chunk</span><span class="token punctuation">(</span>_cur_free<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                      </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token operator">--</span>_cur_free<span class="token punctuation">.</span>nfree<span class="token punctuation">;</span>                                                         </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">const</span> ResourceId<span class="token operator">&lt;</span>T<span class="token operator">></span> free_id <span class="token operator">=</span> _cur_free<span class="token punctuation">.</span>ids<span class="token punctuation">[</span>_cur_free<span class="token punctuation">.</span>nfree<span class="token punctuation">]</span><span class="token punctuation">;</span>              </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token operator">*</span>id <span class="token operator">=</span> free_id<span class="token punctuation">;</span>                                                             </span><span class="token punctuation">\</span>
    <span class="token expression">BAIDU_RESOURCE_POOL_FREE_ITEM_NUM_SUB1<span class="token punctuation">;</span>                                    </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">return</span> <span class="token function">unsafe_address_resource</span><span class="token punctuation">(</span>free_id<span class="token punctuation">)</span><span class="token punctuation">;</span>                                   </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span>                                                                            </span><span class="token punctuation">\</span>
  <span class="token comment">/* Fetch memory from local block */</span>                                          <span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>_cur_block <span class="token operator">&amp;&amp;</span> _cur_block<span class="token operator">-></span>nitem <span class="token operator">&lt;</span> BLOCK_NITEM<span class="token punctuation">)</span> <span class="token punctuation">{</span>                         </span><span class="token punctuation">\</span>
    <span class="token expression">id<span class="token operator">-></span>value <span class="token operator">=</span> _cur_block_index <span class="token operator">*</span> BLOCK_NITEM <span class="token operator">+</span> _cur_block<span class="token operator">-></span>nitem<span class="token punctuation">;</span>            </span><span class="token punctuation">\</span>
    <span class="token expression">T <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>T <span class="token operator">*</span><span class="token punctuation">)</span>_cur_block<span class="token operator">-></span>items <span class="token operator">+</span> _cur_block<span class="token operator">-></span>nitem<span class="token punctuation">)</span> T CTOR_ARGS<span class="token punctuation">;</span>       </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ResourcePoolValidator</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">validate</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                              </span><span class="token punctuation">\</span>
      <span class="token expression">p<span class="token operator">-></span><span class="token operator">~</span><span class="token function">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                                 </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>                                                             </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span>                                                                          </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token operator">++</span>_cur_block<span class="token operator">-></span>nitem<span class="token punctuation">;</span>                                                       </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">return</span> p<span class="token punctuation">;</span>                                                                  </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span>                                                                            </span><span class="token punctuation">\</span>
  <span class="token comment">/* Fetch a Block from global */</span>                                              <span class="token punctuation">\</span>
  <span class="token expression">_cur_block <span class="token operator">=</span> <span class="token function">add_block</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_cur_block_index<span class="token punctuation">)</span><span class="token punctuation">;</span>                                   </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>_cur_block <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                                    </span><span class="token punctuation">\</span>
    <span class="token expression">id<span class="token operator">-></span>value <span class="token operator">=</span> _cur_block_index <span class="token operator">*</span> BLOCK_NITEM <span class="token operator">+</span> _cur_block<span class="token operator">-></span>nitem<span class="token punctuation">;</span>            </span><span class="token punctuation">\</span>
    <span class="token expression">T <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>T <span class="token operator">*</span><span class="token punctuation">)</span>_cur_block<span class="token operator">-></span>items <span class="token operator">+</span> _cur_block<span class="token operator">-></span>nitem<span class="token punctuation">)</span> T CTOR_ARGS<span class="token punctuation">;</span>       </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ResourcePoolValidator</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">validate</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                              </span><span class="token punctuation">\</span>
      <span class="token expression">p<span class="token operator">-></span><span class="token operator">~</span><span class="token function">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                                 </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>                                                             </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span>                                                                          </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token operator">++</span>_cur_block<span class="token operator">-></span>nitem<span class="token punctuation">;</span>                                                       </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">return</span> p<span class="token punctuation">;</span>                                                                  </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span>                                                                            </span><span class="token punctuation">\</span>
</span></code></pre>
<p>注意 <code>ResourceId</code> 的计算公式：<code>_cur_block_index * BLOCK_NITEM + _cur_block-&gt;nitem</code>，可以在 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></eq> 的时间内反推对象的内存地址：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">inline</span> T <span class="token operator">*</span><span class="token function">address_resource</span><span class="token punctuation">(</span>ResourceId<span class="token operator">&lt;</span>T<span class="token operator">></span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> size_t block_index <span class="token operator">=</span> id<span class="token punctuation">.</span>value <span class="token operator">/</span> BLOCK_NITEM<span class="token punctuation">;</span>
  <span class="token keyword">const</span> size_t group_index <span class="token operator">=</span> <span class="token punctuation">(</span>block_index <span class="token operator">>></span> RP_GROUP_NBLOCK_NBIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span>group_index <span class="token operator">&lt;</span> RP_MAX_BLOCK_NGROUP<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    BlockGroup <span class="token operator">*</span>bg <span class="token operator">=</span>
      _block_groups<span class="token punctuation">[</span>group_index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_consume<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span>bg <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Block <span class="token operator">*</span>b <span class="token operator">=</span> bg<span class="token operator">-></span>blocks<span class="token punctuation">[</span>block_index <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RP_GROUP_NBLOCK <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>
        butil<span class="token double-colon punctuation">::</span>memory_order_consume<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span>b <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> size_t offset <span class="token operator">=</span> id<span class="token punctuation">.</span>value <span class="token operator">-</span> block_index <span class="token operator">*</span> BLOCK_NITEM<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span>offset <span class="token operator">&lt;</span> b<span class="token operator">-></span>nitem<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">(</span>T <span class="token operator">*</span><span class="token punctuation">)</span>b<span class="token operator">-></span>items <span class="token operator">+</span> offset<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>大多数场景下 <code>ResourceId</code> 小于 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>32</mn></msup></mrow><annotation encoding="application/x-tex">2^{32}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">32</span></span></span></span></span></span></span></span></span></span></span></span></eq>（除非全局对象数量超过 40+ 亿），bRPC 利用这一点将其编码为 64 位 ID 的一部分，余下的部分放置对象的版本。以下描述引用自参考文献一。</p>
<blockquote>
<p>对象可以被归还，但归还后对象并没有删除，也没有被析构，而是仅仅进入回收列表。下次申请时可能会取到这种使用过的对象，需要重置后才能使用。当对象被归还后，通过对应的偏移量仍可以访问到对象，即 ResourcePool 只负责内存分配，并不解决 ABA 问题。</p>
<p>bthread 的大部分函数都需要在 O(1) 时间内通过 bthread_t 访问到 TaskMeta，并且当 bthread_t 失效后，访问应返回 NULL 以让函数做出返回错误。解决方法是：bthread_t 由 32 位的版本和 32 位的偏移量组成。版本解决 <a href="http://en.wikipedia.org/wiki/ABA_problem">ABA 问题</a>，偏移量由ResourcePool 分配。查找时先通过偏移量获得 TaskMeta，再检查版本，如果版本不匹配，说明 bthread 失效了。</p>
</blockquote>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// task_group_inl.h</span>
<span class="token comment">// Utilities to manipulate bthread_t</span>
<span class="token keyword">inline</span> bthread_t <span class="token function">make_tid</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> version<span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>ResourceId<span class="token operator">&lt;</span>TaskMeta<span class="token operator">></span> slot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bthread_t<span class="token punctuation">)</span>version<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>bthread_t<span class="token punctuation">)</span>slot<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">inline</span> butil<span class="token double-colon punctuation">::</span>ResourceId<span class="token operator">&lt;</span>TaskMeta<span class="token operator">></span> <span class="token function">get_slot</span><span class="token punctuation">(</span>bthread_t tid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  butil<span class="token double-colon punctuation">::</span>ResourceId<span class="token operator">&lt;</span>TaskMeta<span class="token operator">></span> id <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">(</span>tid <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFFul</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> id<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">inline</span> <span class="token keyword">uint32_t</span> <span class="token function">get_version</span><span class="token punctuation">(</span>bthread_t tid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tid <span class="token operator">>></span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFFul</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">inline</span> TaskMeta <span class="token operator">*</span><span class="token class-name">TaskGroup</span><span class="token double-colon punctuation">::</span><span class="token function">address_meta</span><span class="token punctuation">(</span>bthread_t tid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// TaskMeta * m = address_resource&lt;TaskMeta>(get_slot(tid));</span>
  <span class="token comment">// if (m != NULL &amp;&amp; m->version == get_version(tid)) {</span>
  <span class="token comment">//     return m;</span>
  <span class="token comment">// }</span>
  <span class="token comment">// return NULL;</span>
  <span class="token keyword">return</span> <span class="token function">address_resource</span><span class="token punctuation">(</span><span class="token function">get_slot</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// task_group.cpp</span>
<span class="token comment">// 版本使用举例</span>
<span class="token keyword">bool</span> <span class="token class-name">TaskGroup</span><span class="token double-colon punctuation">::</span><span class="token function">exists</span><span class="token punctuation">(</span>bthread_t tid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// tid of bthread is never 0.</span>
    TaskMeta <span class="token operator">*</span>m <span class="token operator">=</span> <span class="token function">address_meta</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token operator">-></span>version_butex <span class="token operator">==</span> <span class="token function">get_version</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 判断版本是否一致</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="3.-io-buf" tabindex="-1"><a href="#3.-io-buf">3. IO Buf</a></h3>
<p>bRPC 中使用 <code>IOBuf</code> 处理字节流相关的数据，它是一种非连续零拷贝缓冲，提供类似 <code>std::string</code> 的接口。该数据结构和笔者之前分析的 <a href="/tokio/tokio_02_bytes.html">Tokio Bytes</a> 也很像，均使用引用计数实现零拷贝。</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// iobuf.h</span>
<span class="token comment">// IOBuf is a non-continuous buffer that can be cut and combined w/o copying</span>
<span class="token comment">// payload. It can be read from or flushed into file descriptors as well.</span>
<span class="token comment">// IOBuf is [thread-compatible]. Namely using different IOBuf in different</span>
<span class="token comment">// threads simultaneously is safe, and reading a static IOBuf from different</span>
<span class="token comment">// threads is safe as well.</span>
<span class="token comment">// IOBuf is [NOT thread-safe]. Modifying a same IOBuf from different threads</span>
<span class="token comment">// simultaneously is unsafe and likely to crash.</span>
<span class="token keyword">class</span> <span class="token class-name">IOBuf</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">static</span> <span class="token keyword">const</span> size_t DEFAULT_BLOCK_SIZE <span class="token operator">=</span> <span class="token number">8192</span><span class="token punctuation">;</span>  <span class="token comment">// block 默认大小 8KB</span>

  <span class="token comment">// can't directly use `struct iovec' here because we also need to access the</span>
  <span class="token comment">// reference counter(nshared) in Block*</span>
  <span class="token keyword">struct</span> <span class="token class-name">BlockRef</span> <span class="token punctuation">{</span>
    <span class="token comment">// NOTICE: first bit of `offset' is shared with BigView::start</span>
    <span class="token keyword">uint32_t</span> offset<span class="token punctuation">;</span>  <span class="token comment">// block 上的偏移，这里保证 offset &lt;= max_int</span>
    <span class="token keyword">uint32_t</span> length<span class="token punctuation">;</span>  <span class="token comment">// 和长度</span>
    Block <span class="token operator">*</span>block<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// IOBuf is essentially a tiny queue of BlockRefs.</span>
  <span class="token keyword">struct</span> <span class="token class-name">SmallView</span> <span class="token punctuation">{</span>
    BlockRef refs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 引用少于两个 block</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// SmallView 与 BigView 大小相同</span>
  <span class="token keyword">struct</span> <span class="token class-name">BigView</span> <span class="token punctuation">{</span>
    <span class="token keyword">int32_t</span> magic<span class="token punctuation">;</span>
    <span class="token keyword">uint32_t</span> start<span class="token punctuation">;</span>  <span class="token comment">// 起始的 block 下标</span>
    BlockRef <span class="token operator">*</span>refs<span class="token punctuation">;</span>  <span class="token comment">// block 列表</span>
    <span class="token keyword">uint32_t</span> nref<span class="token punctuation">;</span>   <span class="token comment">// block 列表大小</span>
    <span class="token keyword">uint32_t</span> cap_mask<span class="token punctuation">;</span>
    size_t nbytes<span class="token punctuation">;</span>  <span class="token comment">// 当前总长度</span>

    <span class="token keyword">const</span> BlockRef <span class="token operator">&amp;</span><span class="token function">ref_at</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> i<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> refs<span class="token punctuation">[</span><span class="token punctuation">(</span>start <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> cap_mask<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    BlockRef <span class="token operator">&amp;</span><span class="token function">ref_at</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> refs<span class="token punctuation">[</span><span class="token punctuation">(</span>start <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> cap_mask<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">uint32_t</span> <span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> cap_mask <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>  <span class="token comment">// block 列表容量</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">bool</span> <span class="token function">_small</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> _bv<span class="token punctuation">.</span>magic <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>  <span class="token comment">// 小于 0 时为 BigView</span>

  size_t <span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">_small</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>_sv<span class="token punctuation">.</span>refs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">+</span> _sv<span class="token punctuation">.</span>refs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">:</span> _bv<span class="token punctuation">.</span>nbytes<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">union</span> <span class="token punctuation">{</span>
    BigView _bv<span class="token punctuation">;</span>  <span class="token comment">// _bv.magic 与 _sv.refs[0].offset 地址相同，小于 0 时表示 BigView</span>
    SmallView _sv<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">// iobuf.cpp，看一下 append 的流程</span>
<span class="token keyword">void</span> <span class="token class-name">IOBuf</span><span class="token double-colon punctuation">::</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token keyword">const</span> IOBuf <span class="token operator">&amp;</span>other<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> size_t nref <span class="token operator">=</span> other<span class="token punctuation">.</span><span class="token function">_ref_num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nref<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">_push_back_ref</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span><span class="token function">_ref_at</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 引用的 Block 数量</span>
<span class="token keyword">inline</span> size_t <span class="token class-name">IOBuf</span><span class="token double-colon punctuation">::</span><span class="token function">_ref_num</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">_small</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>_sv<span class="token punctuation">.</span>refs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>block <span class="token operator">+</span> <span class="token operator">!</span><span class="token operator">!</span>_sv<span class="token punctuation">.</span>refs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>block<span class="token punctuation">)</span> <span class="token operator">:</span> _bv<span class="token punctuation">.</span>nref<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token class-name">IOBuf</span><span class="token double-colon punctuation">::</span><span class="token function">_push_back_ref</span><span class="token punctuation">(</span><span class="token keyword">const</span> BlockRef <span class="token operator">&amp;</span>r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_small</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">_push_or_move_back_ref_to_smallview</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token boolean">false</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">_push_or_move_back_ref_to_bigview</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token boolean">false</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">bool</span> MOVE<span class="token operator">></span>
<span class="token keyword">void</span> <span class="token class-name">IOBuf</span><span class="token double-colon punctuation">::</span><span class="token function">_push_or_move_back_ref_to_bigview</span><span class="token punctuation">(</span><span class="token keyword">const</span> BlockRef <span class="token operator">&amp;</span>r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  BlockRef <span class="token operator">&amp;</span>back <span class="token operator">=</span> _bv<span class="token punctuation">.</span><span class="token function">ref_at</span><span class="token punctuation">(</span>_bv<span class="token punctuation">.</span>nref <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>back<span class="token punctuation">.</span>block <span class="token operator">==</span> r<span class="token punctuation">.</span>block <span class="token operator">&amp;&amp;</span> back<span class="token punctuation">.</span>offset <span class="token operator">+</span> back<span class="token punctuation">.</span>length <span class="token operator">==</span> r<span class="token punctuation">.</span>offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Merge ref</span>
    back<span class="token punctuation">.</span>length <span class="token operator">+=</span> r<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    _bv<span class="token punctuation">.</span>nbytes <span class="token operator">+=</span> r<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>MOVE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      r<span class="token punctuation">.</span>block<span class="token operator">-></span><span class="token function">dec_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>_bv<span class="token punctuation">.</span>nref <span class="token operator">!=</span> _bv<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// block 列表有容量的情况下，直接增加对该 block 的引用</span>
    _bv<span class="token punctuation">.</span><span class="token function">ref_at</span><span class="token punctuation">(</span>_bv<span class="token punctuation">.</span>nref<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">=</span> r<span class="token punctuation">;</span>
    _bv<span class="token punctuation">.</span>nbytes <span class="token operator">+=</span> r<span class="token punctuation">.</span>length<span class="token punctuation">;</span>  <span class="token comment">// 长度叠加</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>MOVE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      r<span class="token punctuation">.</span>block<span class="token operator">-></span><span class="token function">inc_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// resize, don't modify bv until new_refs is fully assigned</span>
  <span class="token comment">// 当前 block 列表容量不足，倍增申请</span>
  <span class="token keyword">const</span> <span class="token keyword">uint32_t</span> new_cap <span class="token operator">=</span> _bv<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
  BlockRef <span class="token operator">*</span>new_refs <span class="token operator">=</span> iobuf<span class="token double-colon punctuation">::</span><span class="token function">acquire_blockref_array</span><span class="token punctuation">(</span>new_cap<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _bv<span class="token punctuation">.</span>nref<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 复制原 block</span>
    new_refs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> _bv<span class="token punctuation">.</span><span class="token function">ref_at</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  new_refs<span class="token punctuation">[</span>_bv<span class="token punctuation">.</span>nref<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">;</span>

  <span class="token comment">// Change other variables</span>
  _bv<span class="token punctuation">.</span>start <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 删除原 block 列表</span>
  iobuf<span class="token double-colon punctuation">::</span><span class="token function">release_blockref_array</span><span class="token punctuation">(</span>_bv<span class="token punctuation">.</span>refs<span class="token punctuation">,</span> _bv<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  _bv<span class="token punctuation">.</span>refs <span class="token operator">=</span> new_refs<span class="token punctuation">;</span>
  _bv<span class="token punctuation">.</span>cap_mask <span class="token operator">=</span> new_cap <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  _bv<span class="token punctuation">.</span>nbytes <span class="token operator">+=</span> r<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>MOVE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    r<span class="token punctuation">.</span>block<span class="token operator">-></span><span class="token function">inc_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Block 的实现</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>blockmem_allocate<span class="token punctuation">)</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>malloc<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>blockmem_deallocate<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>free<span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">uint16_t</span> IOBUF_BLOCK_FLAGS_USER_DATA <span class="token operator">=</span> <span class="token number">0x1</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>UserDataDeleter<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">UserDataExtension</span> <span class="token punctuation">{</span>
  UserDataDeleter deleter<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">IOBuf</span><span class="token operator">:</span><span class="token base-clause"><span class="token operator">:</span><span class="token class-name">Block</span></span> <span class="token punctuation">{</span>
  butil<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> nshared<span class="token punctuation">;</span>  <span class="token comment">// 引用计数</span>
  <span class="token keyword">uint16_t</span> flags<span class="token punctuation">;</span>  <span class="token comment">// 是否使用自定义 deleter，可以看下方的英文注释</span>
  <span class="token keyword">uint16_t</span> abi_check<span class="token punctuation">;</span> <span class="token comment">// original cap, never be zero.</span>
  <span class="token keyword">uint32_t</span> size<span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> cap<span class="token punctuation">;</span>
  Block <span class="token operator">*</span>portal_next<span class="token punctuation">;</span>
  <span class="token comment">// When flag is 0, data points to `size` bytes starting at</span>
  <span class="token comment">// `(char*)this+sizeof(Block)' When flag &amp; IOBUF_BLOCK_FLAGS_USER_DATA is</span>
  <span class="token comment">// non-0, data points to the user data and the deleter is put in</span>
  <span class="token comment">// UserDataExtension at `(char*)this+sizeof(Block)'</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>

  <span class="token function">Block</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>data_in<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> data_size<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">nshared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">flags</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">abi_check</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>data_size<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">portal_next</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">data</span><span class="token punctuation">(</span>data_in<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    iobuf<span class="token double-colon punctuation">::</span>g_nblock<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    iobuf<span class="token double-colon punctuation">::</span>g_blockmem<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span>data_size <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>Block<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">Block</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>data_in<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> data_size<span class="token punctuation">,</span> UserDataDeleter deleter<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">nshared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">flags</span><span class="token punctuation">(</span>IOBUF_BLOCK_FLAGS_USER_DATA<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">abi_check</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">size</span><span class="token punctuation">(</span>data_size<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>data_size<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">portal_next</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">data</span><span class="token punctuation">(</span>data_in<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">get_user_data_extension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>deleter <span class="token operator">=</span> deleter<span class="token punctuation">;</span>  <span class="token comment">// 自定义 deleter</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Undefined behavior when (flags &amp; IOBUF_BLOCK_FLAGS_USER_DATA) is 0.</span>
  UserDataExtension <span class="token operator">*</span><span class="token function">get_user_data_extension</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>UserDataExtension <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>Block<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 当前内存之后的 4 字节</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">inc_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">check_abi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nshared<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">dec_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">check_abi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nshared<span class="token punctuation">.</span><span class="token function">fetch_sub</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      butil<span class="token double-colon punctuation">::</span><span class="token function">atomic_thread_fence</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        iobuf<span class="token double-colon punctuation">::</span>g_nblock<span class="token punctuation">.</span><span class="token function">fetch_sub</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        iobuf<span class="token double-colon punctuation">::</span>g_blockmem<span class="token punctuation">.</span><span class="token function">fetch_sub</span><span class="token punctuation">(</span>cap <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>Block<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token operator">-></span><span class="token operator">~</span><span class="token function">Block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 调用析构函数，不删除内存</span>
        iobuf<span class="token double-colon punctuation">::</span><span class="token function">blockmem_deallocate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 删除内存</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> IOBUF_BLOCK_FLAGS_USER_DATA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">get_user_data_extension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">deleter</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 执行自定义删除</span>
        <span class="token keyword">this</span><span class="token operator">-></span><span class="token operator">~</span><span class="token function">Block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">int</span> <span class="token function">ref_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> nshared<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">bool</span> <span class="token function">full</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> size <span class="token operator">>=</span> cap<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  size_t <span class="token function">left_space</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> cap <span class="token operator">-</span> size<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 创建 block，同时存储 Block 对象和实际数据</span>
<span class="token keyword">inline</span> IOBuf<span class="token double-colon punctuation">::</span>Block <span class="token operator">*</span><span class="token function">create_block</span><span class="token punctuation">(</span><span class="token keyword">const</span> size_t block_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>block_size <span class="token operator">></span> <span class="token number">0xFFFFFFFFULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"block_size="</span> <span class="token operator">&lt;&lt;</span> block_size <span class="token operator">&lt;&lt;</span> <span class="token string">" is too large"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>mem <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>iobuf<span class="token double-colon punctuation">::</span><span class="token function">blockmem_allocate</span><span class="token punctuation">(</span>block_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>mem<span class="token punctuation">)</span> <span class="token class-name">IOBuf</span><span class="token double-colon punctuation">::</span><span class="token function">Block</span><span class="token punctuation">(</span>mem <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>IOBuf<span class="token double-colon punctuation">::</span>Block<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                block_size <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>IOBuf<span class="token double-colon punctuation">::</span>Block<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 追加用户数据，所有权取决于传入的 deleter</span>
<span class="token keyword">int</span> <span class="token class-name">IOBuf</span><span class="token double-colon punctuation">::</span><span class="token function">append_user_data</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> size_t size<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>deleter<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">></span> <span class="token number">0xFFFFFFFFULL</span> <span class="token operator">-</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"data_size="</span> <span class="token operator">&lt;&lt;</span> size <span class="token operator">&lt;&lt;</span> <span class="token string">" is too large"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>mem <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>IOBuf<span class="token double-colon punctuation">::</span>Block<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>UserDataExtension<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>deleter <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    deleter <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>free<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  IOBuf<span class="token double-colon punctuation">::</span>Block <span class="token operator">*</span>b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>mem<span class="token punctuation">)</span> <span class="token class-name">IOBuf</span><span class="token double-colon punctuation">::</span><span class="token function">Block</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>data<span class="token punctuation">,</span> size<span class="token punctuation">,</span> deleter<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> IOBuf<span class="token double-colon punctuation">::</span>BlockRef r <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> b<span class="token operator">-></span>cap<span class="token punctuation">,</span> b<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">_move_back_ref</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>IOBuf</code> 提供了丰富的字节流处理能力，整体代码也非常长，超过 3k 行。这里省略其他处理细节的分析了，有兴趣可以自行阅读。</p>
<h3 id="4.-socket" tabindex="-1"><a href="#4.-socket">4. Socket</a></h3>
<p>bRPC 中使用 <code>Socket</code> 来管理连接，并且使用了 64 位的 <code>SocketId</code> 来指代 <code>Socket</code> 对象方便在多线程下环境下使用连接。使用 Socket 时会用到以下数据结构：</p>
<ol>
<li><code>Socket</code> 对象本身；</li>
<li><code>SocketUniquePtr</code>，实际上更像是 <code>std::shared_ptr</code>，析构时减少引用计数；</li>
<li><code>SocketId</code>，带版本校验，使用上类似 <code>std::weak_ptr</code>。</li>
</ol>
<p>常用的方法有：</p>
<ol>
<li><code>Create</code>：创建 Socket 对象并返回 <code>SocketId</code>；</li>
<li><code>Address</code>：获取 <code>SocketId</code> 对应的 <code>Socket</code> 对象，会返回一个 <code>SocketUniquePtr</code>；</li>
<li><code>SetFailed</code>：标记一个 <code>Socket</code> 对象为失败，之后所有对该 <code>SocketId</code> 的 <code>Address</code> 操作会返回空指针，当 <code>Socket</code> 对象使用计数为 0 时触发回收。</li>
</ol>
<p>官方文档上也解释了为何设计地如此复杂（摘录自参考文献 3）：</p>
<blockquote>
<p>Socket 独有的 SetFailed 可以在需要时确保 Socket 不能被继续 Address 而最终引用计数归 0，单纯使用 shared_ptr/weak_ptr 则无法保证这点，当一个 server 需要退出时，如果请求仍频繁地到来，对应 Socket 的引用计数可能迟迟无法清 0 而导致 server 无法退出。另外 weak_ptr 无法直接作为 epoll 的 data，而 SocketId 可以。这些因素使我们设计了 Socket。</p>
<p>存储 SocketUniquePtr 还是 SocketId 取决于是否需要强引用。像 Controller 贯穿了 RPC 的整个流程，和 Socket 中的数据有大量交互，它存放的是 SocketUniquePtr。epoll 主要是提醒对应 fd 上发生了事件，如果 Socket 回收了，那这个事件是可有可无的，所以它存放了 SocketId。</p>
<p>由于 SocketUniquePtr 只要有效，其中的数据就不会变，这个机制使用户不用关心麻烦的 race conditon 和 ABA  problem，可以放心地对共享的 fd 进行操作。这种方法也规避了隐式的引用计数，内存的 ownership 明确，程序的质量有很好的保证。bRPC 中有大量的 SocketUniquePtr 和 SocketId，它们确实简化了我们的开发。</p>
</blockquote>
<p>部分理念需要等分析完 bRPC 全流程的代码后才能体会到了。先看 <code>Socket</code> 本身的实现：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">BAIDU_CACHELINE_ALIGNMENT</span> Socket <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">Forbidden</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">Socket</span><span class="token punctuation">(</span>Forbidden<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 禁止用户直接构造，但 ResourcePool 又需要访问 public 的构造函数，私有的 Forbidden 可以实现这个 trick</span>

  <span class="token comment">// Create a Socket according to `options', put the identifier into `id'.</span>
  <span class="token comment">// Returns 0 on sucess, -1 otherwise.</span>
  <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">Create</span><span class="token punctuation">(</span><span class="token keyword">const</span> SocketOptions <span class="token operator">&amp;</span>options<span class="token punctuation">,</span> SocketId <span class="token operator">*</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Place the Socket associated with identifier `id' into unique_ptr `ptr',</span>
  <span class="token comment">// which will be released automatically when out of scope (w/o explicit</span>
  <span class="token comment">// std::move). User can still access `ptr' after calling ptr->SetFailed()</span>
  <span class="token comment">// before release of `ptr'.</span>
  <span class="token comment">// This function is wait-free.</span>
  <span class="token comment">// Returns 0 on success, -1 when the Socket was SetFailed().</span>
  <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">Address</span><span class="token punctuation">(</span>SocketId id<span class="token punctuation">,</span> SocketUniquePtr <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Mark this Socket or the Socket associated with `id' as failed.</span>
  <span class="token comment">// Any later Address() of the identifier shall return NULL unless the</span>
  <span class="token comment">// Socket was revivied by HealthCheckThread. The Socket is NOT recycled</span>
  <span class="token comment">// after calling this function, instead it will be recycled when no one</span>
  <span class="token comment">// references it. Internal fields of the Socket are still accessible</span>
  <span class="token comment">// after calling this function. Calling SetFailed() of a Socket more</span>
  <span class="token comment">// than once is OK.</span>
  <span class="token comment">// This function is lock-free.</span>
  <span class="token comment">// Returns -1 when the Socket was already SetFailed(), 0 otherwise.</span>
  <span class="token keyword">int</span> <span class="token function">SetFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token comment">// unsigned 32-bit version + signed 32-bit referenced-count.</span>
  <span class="token comment">// Meaning of version:</span>
  <span class="token comment">// * Created version: no SetFailed() is called on the Socket yet. Must be</span>
  <span class="token comment">//   same evenness with initial _versioned_ref because during lifetime of</span>
  <span class="token comment">//   a Socket on the slot, the version is added with 1 twice. This is</span>
  <span class="token comment">//   also the version encoded in SocketId.</span>
  <span class="token comment">// * Failed version: = created version + 1, SetFailed()-ed but returned.</span>
  <span class="token comment">// * Other versions: the socket is already recycled.</span>
  <span class="token comment">// Socket 自身记录的版本+引用计数，首次构造对象时为 0</span>
  butil<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">uint64_t</span><span class="token operator">></span> _versioned_ref<span class="token punctuation">;</span>

  <span class="token comment">// Flag used to mark whether additional reference has been decreased</span>
  <span class="token comment">// by either `SetFailed' or `SetRecycle'</span>
  <span class="token comment">// 回收标记</span>
  butil<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> _recycle_flag<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// SocketId = 32-bit version + 32-bit slot.</span>
<span class="token comment">//   version: from version part of _versioned_nref, must be an EVEN number.</span>
<span class="token comment">//   slot: designated by ResourcePool.</span>
<span class="token keyword">int</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token keyword">const</span> SocketOptions <span class="token operator">&amp;</span>options<span class="token punctuation">,</span> SocketId <span class="token operator">*</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  butil<span class="token double-colon punctuation">::</span>ResourceId<span class="token operator">&lt;</span>Socket<span class="token operator">></span> slot<span class="token punctuation">;</span>  <span class="token comment">// 接收返回的资源 ID</span>
  Socket <span class="token operator">*</span><span class="token keyword">const</span> m <span class="token operator">=</span> butil<span class="token double-colon punctuation">::</span><span class="token function">get_resource</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>slot<span class="token punctuation">,</span> <span class="token function">Forbidden</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to get_resource&lt;Socket>"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  g_vars<span class="token operator">-></span>nsocket <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">CHECK</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> m<span class="token operator">-></span>_shared_part<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// nref can be non-zero due to concurrent AddressSocket().</span>
  <span class="token comment">// _this_id will only be used in destructor/Destroy of referenced</span>
  <span class="token comment">// slots, which is safe and properly fenced. Although it's better</span>
  <span class="token comment">// to put the id into SocketUniquePtr.</span>
  <span class="token comment">// 构造 SocketId，_versioned_ref 引用计数加 1，首次构造时版本为 0</span>
  m<span class="token operator">-></span>_this_id <span class="token operator">=</span> <span class="token function">MakeSocketId</span><span class="token punctuation">(</span><span class="token function">VersionOfVRef</span><span class="token punctuation">(</span>m<span class="token operator">-></span>_versioned_ref<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span>
                                 <span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token operator">*</span>id <span class="token operator">=</span> m<span class="token operator">-></span>_this_id<span class="token punctuation">;</span>  <span class="token comment">// 返回 socket id</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Utility functions to combine and extract SocketId.</span>
BUTIL_FORCE_INLINE SocketId <span class="token function">MakeSocketId</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> version<span class="token punctuation">,</span>
                                         butil<span class="token double-colon punctuation">::</span>ResourceId<span class="token operator">&lt;</span>Socket<span class="token operator">></span> slot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">SocketId</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">)</span>version<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">|</span> slot<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Utility functions to combine and extract Socket::_versioned_ref</span>
BUTIL_FORCE_INLINE <span class="token keyword">uint32_t</span> <span class="token function">VersionOfVRef</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> vref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>vref <span class="token operator">>></span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

BUTIL_FORCE_INLINE butil<span class="token double-colon punctuation">::</span>ResourceId<span class="token operator">&lt;</span>Socket<span class="token operator">></span> <span class="token function">SlotOfSocketId</span><span class="token punctuation">(</span>SocketId sid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  butil<span class="token double-colon punctuation">::</span>ResourceId<span class="token operator">&lt;</span>Socket<span class="token operator">></span> id <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">(</span>sid <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFFul</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> id<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

BUTIL_FORCE_INLINE <span class="token keyword">int32_t</span> <span class="token function">NRefOfVRef</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> vref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>vref <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFFul</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">Address</span><span class="token punctuation">(</span>SocketId id<span class="token punctuation">,</span> SocketUniquePtr <span class="token operator">*</span>ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 解析 ResourceId</span>
  <span class="token keyword">const</span> butil<span class="token double-colon punctuation">::</span>ResourceId<span class="token operator">&lt;</span>Socket<span class="token operator">></span> slot <span class="token operator">=</span> <span class="token function">SlotOfSocketId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取对象地址</span>
  Socket <span class="token operator">*</span><span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token function">address_resource</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span>m <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// acquire fence makes sure this thread sees latest changes before</span>
    <span class="token comment">// Dereference() or Revive().</span>
    <span class="token comment">// 引用计数 +1，注意这里返回的 vref1 是自增前的 _versioned_ref</span>
    <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> vref1 <span class="token operator">=</span>
        m<span class="token operator">-></span>_versioned_ref<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取版本</span>
    <span class="token keyword">const</span> <span class="token keyword">uint32_t</span> ver1 <span class="token operator">=</span> <span class="token function">VersionOfVRef</span><span class="token punctuation">(</span>vref1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ver1 <span class="token operator">==</span> <span class="token function">VersionOfSocketId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 版本与 SocketId 的版本一致则返回成功</span>
      ptr<span class="token operator">-></span><span class="token function">reset</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 版本不一致，恢复引用计数，返回的 vref2 是前面自增后的 _versioned_ref</span>
    <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> vref2 <span class="token operator">=</span>
        m<span class="token operator">-></span>_versioned_ref<span class="token punctuation">.</span><span class="token function">fetch_sub</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 取出引用数量</span>
    <span class="token keyword">const</span> <span class="token keyword">int32_t</span> nref <span class="token operator">=</span> <span class="token function">NRefOfVRef</span><span class="token punctuation">(</span>vref2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nref <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span>nref <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 无引用，再次读取版本</span>
      <span class="token keyword">const</span> <span class="token keyword">uint32_t</span> ver2 <span class="token operator">=</span> <span class="token function">VersionOfVRef</span><span class="token punctuation">(</span>vref2<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果版本是奇数，说明刚进行了 SetFailed 操作</span>
      <span class="token comment">// 并且当前无引用，触发 socket 回收</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ver2 <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ver1 <span class="token operator">==</span> ver2 <span class="token operator">||</span> ver1 <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> ver2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">uint64_t</span> expected_vref <span class="token operator">=</span> vref2 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 自减后 _versioned_ref 的理论值</span>
          <span class="token comment">// 尝试 CAS，原子地将 _versioned_ref 替换为版本 id_ver + 2，计数 0</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token operator">-></span>_versioned_ref<span class="token punctuation">.</span><span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>
                  expected_vref<span class="token punctuation">,</span> <span class="token function">MakeVRef</span><span class="token punctuation">(</span>ver2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  butil<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 成功 CAS 后，执行回收</span>
            m<span class="token operator">-></span><span class="token function">OnRecycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 执行实际的回收操作</span>
            <span class="token function">return_resource</span><span class="token punctuation">(</span><span class="token function">SlotOfSocketId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">CHECK</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ref-version="</span> <span class="token operator">&lt;&lt;</span> ver1 <span class="token operator">&lt;&lt;</span> <span class="token string">" unref-version="</span> <span class="token operator">&lt;&lt;</span> ver2<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">CHECK_EQ</span><span class="token punctuation">(</span>ver1<span class="token punctuation">,</span> ver2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Addressed a free slot.</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">CHECK</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Over dereferenced SocketId="</span> <span class="token operator">&lt;&lt;</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">SetFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">SetFailed</span><span class="token punctuation">(</span>EFAILEDSOCKET<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">SetFailed</span><span class="token punctuation">(</span><span class="token keyword">int</span> error_code<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>error_fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error_code <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CHECK</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"error_code is 0"</span><span class="token punctuation">;</span>
    error_code <span class="token operator">=</span> EFAILEDSOCKET<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token keyword">uint32_t</span> id_ver <span class="token operator">=</span> <span class="token function">VersionOfSocketId</span><span class="token punctuation">(</span>_this_id<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 获取 socket id 上的版本</span>
  <span class="token keyword">uint64_t</span> vref <span class="token operator">=</span> _versioned_ref<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// need iteration to retry compare_exchange_strong</span>
    <span class="token comment">// version_ref 的版本与 socket id 的版本不一致，返回失败</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">VersionOfVRef</span><span class="token punctuation">(</span>vref<span class="token punctuation">)</span> <span class="token operator">!=</span> id_ver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Try to set version=id_ver+1 (to make later Address() return NULL),</span>
    <span class="token comment">// retry on fail.</span>
    <span class="token comment">// 尝试 CAS，原子地将 _version_ref 替换为版本 id_ver + 1，计数不变</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_versioned_ref<span class="token punctuation">.</span><span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>
            vref<span class="token punctuation">,</span> <span class="token function">MakeVRef</span><span class="token punctuation">(</span>id_ver <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">NRefOfVRef</span><span class="token punctuation">(</span>vref<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            butil<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// CAS 成功后，原先的 socket id Address 操作会因为版本校验而失败</span>
      <span class="token comment">// _version_ref 的版本也会修改为一个**奇数**</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

      <span class="token comment">// Deref additionally which is added at creation so that this</span>
      <span class="token comment">// Socket's reference will hit 0(recycle) when no one addresses it.</span>
      <span class="token function">ReleaseAdditionalReference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// NOTE: This Socket may be recycled at this point, don't</span>
      <span class="token comment">// touch anything.</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">ReleaseAdditionalReference</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">bool</span> expect <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">// Use `relaxed' fence here since `Dereference' has `released' fence</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_recycle_flag<span class="token punctuation">.</span><span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>expect<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                                            butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">,</span>
                                            butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">Dereference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 引用计数 -1</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>每次 <code>SocketUniquePtr</code> 析构时，会调用 <code>DereferenceSocket</code> 减少引用计数，当引用计数为 0 时回收 <code>Socket</code> 对象。中间 <code>SetFailed</code> 与 <code>Address</code> 操作并发时会产生一些计数的特殊情况，需要特殊处理，这里可以仔细思考下。</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// socket_id.h</span>
<span class="token keyword">typedef</span> <span class="token keyword">uint64_t</span> SocketId<span class="token punctuation">;</span>

<span class="token keyword">const</span> SocketId INVALID_SOCKET_ID <span class="token operator">=</span> <span class="token punctuation">(</span>SocketId<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Socket</span><span class="token punctuation">;</span>

<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">DereferenceSocket</span><span class="token punctuation">(</span>Socket <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">SocketDeleter</span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Socket <span class="token operator">*</span>m<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token function">DereferenceSocket</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// RAII，析构时执行 SocketDeleter() -> DereferenceSocket</span>
<span class="token keyword">typedef</span> std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>Socket<span class="token punctuation">,</span> SocketDeleter<span class="token operator">></span> SocketUniquePtr<span class="token punctuation">;</span>

<span class="token comment">// socket.cpp</span>
<span class="token keyword">void</span> <span class="token function">DereferenceSocket</span><span class="token punctuation">(</span>Socket <span class="token operator">*</span>s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 减少引用计数</span>
    s<span class="token operator">-></span><span class="token function">Dereference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">Dereference</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> SocketId id <span class="token operator">=</span> _this_id<span class="token punctuation">;</span>
  <span class="token comment">// 引用计数 -1</span>
  <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> vref <span class="token operator">=</span>
      _versioned_ref<span class="token punctuation">.</span><span class="token function">fetch_sub</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int32_t</span> nref <span class="token operator">=</span> <span class="token function">NRefOfVRef</span><span class="token punctuation">(</span>vref<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 获得计数的值</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nref <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 存在其他引用，直接返回</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span>nref <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 无引用，需要回收</span>
    <span class="token keyword">const</span> <span class="token keyword">uint32_t</span> ver <span class="token operator">=</span> <span class="token function">VersionOfVRef</span><span class="token punctuation">(</span>vref<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 获取 version_ref 上的版本</span>
    <span class="token keyword">const</span> <span class="token keyword">uint32_t</span> id_ver <span class="token operator">=</span> <span class="token function">VersionOfSocketId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 获取 socket id 上的版本</span>
    <span class="token comment">// SetFailed 与 Address 并发时对特殊情况的处理，可以自行看英文注释</span>
    <span class="token comment">// Besides first successful SetFailed() adds 1 to version, one of</span>
    <span class="token comment">// those dereferencing nref from 1->0 adds another 1 to version.</span>
    <span class="token comment">// Notice "one of those": The wait-free Address() may make ref of a</span>
    <span class="token comment">// version-unmatched slot change from 1 to 0 for mutiple times, we</span>
    <span class="token comment">// have to use version as a guard variable to prevent returning the</span>
    <span class="token comment">// Socket to pool more than once.</span>
    <span class="token comment">//</span>
    <span class="token comment">// Note: `ver == id_ver' means this socket has been `SetRecycle'</span>
    <span class="token comment">// before rather than `SetFailed'; `ver == ide_ver+1' means we</span>
    <span class="token comment">// had `SetFailed' this socket before. We should destroy the</span>
    <span class="token comment">// socket under both situation</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span>ver <span class="token operator">==</span> id_ver <span class="token operator">||</span> ver <span class="token operator">==</span> id_ver <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// sees nref:1->0, try to set version=id_ver+2,--nref.</span>
      <span class="token comment">// No retry: if version changes, the slot is already returned by</span>
      <span class="token comment">// another one who sees nref:1->0 concurrently; if nref changes,</span>
      <span class="token comment">// which must be non-zero, the slot will be returned when</span>
      <span class="token comment">// nref changes from 1->0 again.</span>
      <span class="token comment">// Example:</span>
      <span class="token comment">//   SetFailed(): --nref, sees nref:1->0           (1)</span>
      <span class="token comment">//                try to set version=id_ver+2      (2)</span>
      <span class="token comment">//    Address():  ++nref, unmatched version        (3)</span>
      <span class="token comment">//                --nref, sees nref:1->0           (4)</span>
      <span class="token comment">//                try to set version=id_ver+2      (5)</span>
      <span class="token comment">// 1,2,3,4,5 or 1,3,4,2,5:</span>
      <span class="token comment">//            SetFailed() succeeds, Address() fails at (5).</span>
      <span class="token comment">// 1,3,2,4,5: SetFailed() fails with (2), the slot will be</span>
      <span class="token comment">//            returned by (5) of Address()</span>
      <span class="token comment">// 1,3,4,5,2: SetFailed() fails with (2), the slot is already</span>
      <span class="token comment">//            returned by (5) of Address().</span>
      <span class="token keyword">uint64_t</span> expected_vref <span class="token operator">=</span> vref <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_versioned_ref<span class="token punctuation">.</span><span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>
              expected_vref<span class="token punctuation">,</span> <span class="token function">MakeVRef</span><span class="token punctuation">(</span>id_ver <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              butil<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">OnRecycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 执行实际的回收操作</span>
        <span class="token function">return_resource</span><span class="token punctuation">(</span><span class="token function">SlotOfSocketId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Invalid SocketId="</span> <span class="token operator">&lt;&lt;</span> id<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Over dereferenced SocketId="</span> <span class="token operator">&lt;&lt;</span> id<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="references" tabindex="-1"><a href="#references">References</a></h3>
<ol>
<li><a href="https://github.com/apache/incubator-brpc/blob/master/docs/cn/memory_management.md">&quot;bRPC Memory Management&quot;, <em>incubator-brpc</em></a></li>
<li><a href="https://github.com/apache/incubator-brpc/blob/master/docs/cn/iobuf.md">&quot;bRPC IOBuf&quot;, <em>incubator-brpc</em></a></li>
<li><a href="https://github.com/apache/incubator-brpc/blob/master/docs/cn/io.md">&quot;bRPC IO&quot;, <em>incubator-brpc</em></a></li>
</ol>

      </div>
      <div id="gitalk-container">
      </div>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2017 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/gitalk.min.js"></script>
    <script src="/dist/main.js"></script>
    <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-61723712-2', 'auto'); ga('send', 'pageview'); </script>
  </body>
</html>
