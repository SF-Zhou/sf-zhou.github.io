<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/gitalk.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>bRPC 源码分析「四、协程调度」 | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> bRPC 源码分析「四、协程调度」 </h1>
      </div>
      <div class="info">
        <div class="date"> 2021.03.10 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <h3 id="1.-task-runner"><a href="#1.-task-runner">1. Task Runner</a></h3>
<p>bRPC 中所有协程的入口都是 <code>TaskGroup::task_runner</code> 函数，该函数的具体实现为：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">TaskGroup</span><span class="token operator">::</span><span class="token function">task_runner</span><span class="token punctuation">(</span>intptr_t skip_remained<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// NOTE: tls_task_group is volatile since tasks are moved around</span>
  <span class="token comment">//       different groups.</span>
  TaskGroup <span class="token operator">*</span>g <span class="token operator">=</span> tls_task_group<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skip_remained<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 用户函数执行前，先执行 remained 函数</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>g<span class="token operator">-></span>_last_context_remained<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      RemainedFn fn <span class="token operator">=</span> g<span class="token operator">-></span>_last_context_remained<span class="token punctuation">;</span>
      g<span class="token operator">-></span>_last_context_remained <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      <span class="token function">fn</span><span class="token punctuation">(</span>g<span class="token operator">-></span>_last_context_remained_arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      g <span class="token operator">=</span> tls_task_group<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token comment">// Meta and identifier of the task is persistent in this run.</span>
    <span class="token comment">// 通过 TLS 获取当前线程待执行的任务 TaskMeta</span>
    TaskMeta <span class="token operator">*</span><span class="token keyword">const</span> m <span class="token operator">=</span> g<span class="token operator">-></span>_cur_meta<span class="token punctuation">;</span>

    <span class="token comment">// Not catch exceptions except ExitException which is for implementing</span>
    <span class="token comment">// bthread_exit(). User code is intended to crash when an exception is</span>
    <span class="token comment">// not caught explicitly. This is consistent with other threading</span>
    <span class="token comment">// libraries.</span>
    <span class="token comment">// 通过捕获 ExitException 异常，实现协程中执行 bthread_exit() 时提前退出</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>thread_return<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 执行用户指定的函数，中途可能触发协程切换</span>
      thread_return <span class="token operator">=</span> m<span class="token operator">-></span><span class="token function">fn</span><span class="token punctuation">(</span>m<span class="token operator">-></span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>ExitException <span class="token operator">&amp;</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      thread_return <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Group is probably changed</span>
    <span class="token comment">// 用户指定的函数中可能触发协程切换，需要通过 TLS 重新确定当前的线程</span>
    g <span class="token operator">=</span> tls_task_group<span class="token punctuation">;</span>

    <span class="token comment">// TODO: Save thread_return</span>
    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>thread_return<span class="token punctuation">;</span>

    <span class="token comment">// Logging must be done before returning the keytable, since the logging lib</span>
    <span class="token comment">// use bthread local storage internally, or will cause memory leak.</span>
    <span class="token comment">// FIXME: the time from quiting fn to here is not counted into cputime</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token operator">-></span>attr<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> BTHREAD_LOG_START_AND_FINISH<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Finished bthread "</span> <span class="token operator">&lt;&lt;</span> m<span class="token operator">-></span>tid
                <span class="token operator">&lt;&lt;</span> <span class="token string">", cputime="</span> <span class="token operator">&lt;&lt;</span> m<span class="token operator">-></span>stat<span class="token punctuation">.</span>cputime_ns <span class="token operator">/</span> <span class="token number">1000000.0</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ms"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Clean tls variables, must be done before changing version_butex</span>
    <span class="token comment">// otherwise another thread just joined this thread may not see side</span>
    <span class="token comment">// effects of destructing tls variables.</span>
    KeyTable <span class="token operator">*</span>kt <span class="token operator">=</span> tls_bls<span class="token punctuation">.</span>keytable<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>kt <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">return_keytable</span><span class="token punctuation">(</span>m<span class="token operator">-></span>attr<span class="token punctuation">.</span>keytable_pool<span class="token punctuation">,</span> kt<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// After deletion: tls may be set during deletion.</span>
      tls_bls<span class="token punctuation">.</span>keytable <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      m<span class="token operator">-></span>local_storage<span class="token punctuation">.</span>keytable <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// optional</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Increase the version and wake up all joiners, if resulting version</span>
    <span class="token comment">// is 0, change it to 1 to make bthread_t never be 0. Any access</span>
    <span class="token comment">// or join to the bthread after changing version will be rejected.</span>
    <span class="token comment">// The spinlock is for visibility of TaskGroup::get_attr.</span>
    <span class="token punctuation">{</span>
      <span class="token function">BAIDU_SCOPED_LOCK</span><span class="token punctuation">(</span>m<span class="token operator">-></span>version_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 通过增加版本的方式标记当前 TaskMeta 不再可用</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token operator">++</span><span class="token operator">*</span>m<span class="token operator">-></span>version_butex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">++</span><span class="token operator">*</span>m<span class="token operator">-></span>version_butex<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">butex_wake_except</span><span class="token punctuation">(</span>m<span class="token operator">-></span>version_butex<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    g<span class="token operator">-></span>_control<span class="token operator">-></span>_nbthreads <span class="token operator">&lt;&lt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// </span>
    g<span class="token operator">-></span><span class="token function">set_remained</span><span class="token punctuation">(</span>TaskGroup<span class="token operator">::</span>_release_last_context<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ending_sched</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 调度后可能拿到一个 pthread 任务，则继续在该函数中执行</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>g<span class="token operator">-></span>_cur_meta<span class="token operator">-></span>tid <span class="token operator">!=</span> g<span class="token operator">-></span>_main_tid<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Was called from a pthread and we don't have BTHREAD_STACKTYPE_PTHREAD</span>
  <span class="token comment">// tasks to run, quit for more tasks.</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">TaskGroup</span><span class="token operator">::</span><span class="token function">_release_last_context</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 下一个协程用户函数启动前，执行该函数</span>
  TaskMeta<span class="token operator">*</span> m <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>TaskMeta<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token operator">-></span><span class="token function">stack_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> stack_type_t<span class="token operator">::</span>PTHREAD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 回收协程栈</span>
    <span class="token function">return_stack</span><span class="token punctuation">(</span>m<span class="token operator">-></span><span class="token function">release_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    m<span class="token operator">-></span><span class="token function">set_stack</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 回收 TaskMeta</span>
  mem<span class="token operator">::</span><span class="token function">return_resource</span><span class="token punctuation">(</span><span class="token function">get_slot</span><span class="token punctuation">(</span>m<span class="token operator">-></span>tid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 当前协程函数执行结束时，尝试拿取新任务执行</span>
<span class="token keyword">void</span> <span class="token class-name">TaskGroup</span><span class="token operator">::</span><span class="token function">ending_sched</span><span class="token punctuation">(</span>TaskGroup<span class="token operator">*</span><span class="token operator">*</span> pg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  TaskGroup<span class="token operator">*</span> g <span class="token operator">=</span> <span class="token operator">*</span>pg<span class="token punctuation">;</span>
  task_t next_tid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">bool</span> popped <span class="token operator">=</span> g<span class="token operator">-></span>_rq<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>next_tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>popped <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>g<span class="token operator">-></span><span class="token function">steal_task</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>next_tid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Jump to main task if there's no task to run.</span>
    <span class="token comment">// 如果没有新任务，则跳回主协程</span>
    next_tid <span class="token operator">=</span> g<span class="token operator">-></span>_main_tid<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  TaskMeta<span class="token operator">*</span> <span class="token keyword">const</span> cur_meta <span class="token operator">=</span> g<span class="token operator">-></span>_cur_meta<span class="token punctuation">;</span>
  TaskMeta<span class="token operator">*</span> next_meta <span class="token operator">=</span> <span class="token function">address_meta</span><span class="token punctuation">(</span>next_tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>next_meta<span class="token operator">-></span>stack <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>next_meta<span class="token operator">-></span><span class="token function">stack_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> cur_meta<span class="token operator">-></span><span class="token function">stack_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// also works with pthread_task scheduling to pthread_task, the</span>
      <span class="token comment">// transfered stack is just _main_stack.</span>
      <span class="token comment">// 将当前协程使用的栈转移给新任务，减少一次栈分配</span>
      next_meta<span class="token operator">-></span><span class="token function">set_stack</span><span class="token punctuation">(</span>cur_meta<span class="token operator">-></span><span class="token function">release_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">auto</span> stk <span class="token operator">=</span> <span class="token function">get_stack</span><span class="token punctuation">(</span>next_meta<span class="token operator">-></span><span class="token function">stack_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task_runner<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>stk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        next_meta<span class="token operator">-></span><span class="token function">set_stack</span><span class="token punctuation">(</span>stk<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// stack_type is BTHREAD_STACKTYPE_PTHREAD or out of memory,</span>
        <span class="token comment">// In latter case, attr is forced to be BTHREAD_STACKTYPE_PTHREAD.</span>
        <span class="token comment">// This basically means that if we can't allocate stack, run</span>
        <span class="token comment">// the task in pthread directly.</span>
        <span class="token comment">// 对于 pthread 任务或者栈空间不足的情况，直接在主协程中执行这些任务</span>
        next_meta<span class="token operator">-></span>attr<span class="token punctuation">.</span>stack_type <span class="token operator">=</span> stack_type_t<span class="token operator">::</span>PTHREAD<span class="token punctuation">;</span>
        next_meta<span class="token operator">-></span><span class="token function">set_stack</span><span class="token punctuation">(</span>g<span class="token operator">-></span>_main_stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">sched_to</span><span class="token punctuation">(</span>pg<span class="token punctuation">,</span> next_meta<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 调度</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">TaskGroup</span><span class="token operator">::</span><span class="token function">sched_to</span><span class="token punctuation">(</span>TaskGroup<span class="token operator">*</span><span class="token operator">*</span> pg<span class="token punctuation">,</span> TaskMeta<span class="token operator">*</span> next_meta<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  TaskGroup<span class="token operator">*</span> g <span class="token operator">=</span> <span class="token operator">*</span>pg<span class="token punctuation">;</span>
  <span class="token comment">// Save errno so that errno is task-specific.</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> saved_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
  <span class="token comment">// void* saved_unique_user_ptr = tls_unique_user_ptr;</span>

  TaskMeta<span class="token operator">*</span> <span class="token keyword">const</span> cur_meta <span class="token operator">=</span> g<span class="token operator">-></span>_cur_meta<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int64_t</span> now <span class="token operator">=</span> utils<span class="token operator">::</span><span class="token function">cpuwide_time_ns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int64_t</span> elp_ns <span class="token operator">=</span> now <span class="token operator">-</span> g<span class="token operator">-></span>_last_run_ns<span class="token punctuation">;</span>
  g<span class="token operator">-></span>_last_run_ns <span class="token operator">=</span> now<span class="token punctuation">;</span>
  cur_meta<span class="token operator">-></span>stat<span class="token punctuation">.</span>cputime_ns <span class="token operator">+=</span> elp_ns<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_meta<span class="token operator">-></span>tid <span class="token operator">!=</span> g<span class="token operator">-></span><span class="token function">main_tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    g<span class="token operator">-></span>_cumulated_cputime_ns <span class="token operator">+=</span> elp_ns<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">++</span>cur_meta<span class="token operator">-></span>stat<span class="token punctuation">.</span>nswitch<span class="token punctuation">;</span>
  <span class="token operator">++</span>g<span class="token operator">-></span>_nswitch<span class="token punctuation">;</span>
  <span class="token comment">// Switch to the task</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PAXOS_LIKELY</span><span class="token punctuation">(</span>next_meta <span class="token operator">!=</span> cur_meta<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    g<span class="token operator">-></span>_cur_meta <span class="token operator">=</span> next_meta<span class="token punctuation">;</span>
    <span class="token comment">// Switch tls_bls</span>
    cur_meta<span class="token operator">-></span>local_storage <span class="token operator">=</span> tls_bls<span class="token punctuation">;</span>
    tls_bls <span class="token operator">=</span> next_meta<span class="token operator">-></span>local_storage<span class="token punctuation">;</span>

    <span class="token comment">// Logging must be done after switching the local storage, since the logging</span>
    <span class="token comment">// lib use task local storage internally, or will cause memory leak.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cur_meta<span class="token operator">-></span>attr<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> LOG_CONTEXT_SWITCH<span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span>next_meta<span class="token operator">-></span>attr<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> LOG_CONTEXT_SWITCH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Switch task: "</span> <span class="token operator">&lt;&lt;</span> cur_meta<span class="token operator">-></span>tid <span class="token operator">&lt;&lt;</span> <span class="token string">" -> "</span> <span class="token operator">&lt;&lt;</span> next_meta<span class="token operator">-></span>tid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_meta<span class="token operator">-></span>stack <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>next_meta<span class="token operator">-></span>stack <span class="token operator">!=</span> cur_meta<span class="token operator">-></span>stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 当栈不相同时才执行协程切换</span>
        <span class="token comment">// 对于 pthread 任务：</span>
        <span class="token comment">// 1. pthread -> pthread 不切换</span>
        <span class="token comment">// 2. pthread -> bthread 从 main_stack 切换到协程栈</span>
        <span class="token comment">// 3. bthread -> pthread 从协程栈协换到 main_stack</span>
        <span class="token function">jump_stack</span><span class="token punctuation">(</span>cur_meta<span class="token operator">-></span>stack<span class="token punctuation">,</span> next_meta<span class="token operator">-></span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// probably went to another group, need to assign g again.</span>
        g <span class="token operator">=</span> tls_task_group<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// else because of ending_sched(including pthread_task->pthread_task)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"task="</span> <span class="token operator">&lt;&lt;</span> g<span class="token operator">-></span><span class="token function">current_tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" sched_to itself!"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 当协程切回时，也需要执行指定的 Remained 函数</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>g<span class="token operator">-></span>_last_context_remained<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RemainedFn fn <span class="token operator">=</span> g<span class="token operator">-></span>_last_context_remained<span class="token punctuation">;</span>
    g<span class="token operator">-></span>_last_context_remained <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token function">fn</span><span class="token punctuation">(</span>g<span class="token operator">-></span>_last_context_remained_arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    g <span class="token operator">=</span> tls_task_group<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Restore errno</span>
  errno <span class="token operator">=</span> saved_errno<span class="token punctuation">;</span>
  <span class="token comment">// tls_unique_user_ptr = saved_unique_user_ptr;</span>

  <span class="token operator">*</span>pg <span class="token operator">=</span> g<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">TaskGroup</span><span class="token operator">::</span><span class="token function">run_main_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  TaskGroup<span class="token operator">*</span> dummy <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  task_t tid<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">wait_task</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">TaskGroup</span><span class="token operator">::</span><span class="token function">sched_to</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dummy<span class="token punctuation">,</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// DCHECK_EQ(this, dummy);</span>
    <span class="token comment">// DCHECK_EQ(_cur_meta->stack, _main_stack);</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_cur_meta<span class="token operator">-></span>tid <span class="token operator">!=</span> _main_tid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 对于没有切换到协程栈的任务，在主线程中执行</span>
      <span class="token class-name">TaskGroup</span><span class="token operator">::</span><span class="token function">task_runner</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// stop_main_task() was called.</span>
  <span class="token comment">// Don't forget to add elapse of last wait_task.</span>
  <span class="token function">current_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>stat<span class="token punctuation">.</span>cputime_ns <span class="token operator">+=</span> utils<span class="token operator">::</span><span class="token function">cpuwide_time_ns</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> _last_run_ns<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="2.-timer-thread"><a href="#2.-timer-thread">2. Timer Thread</a></h3>
<blockquote>
<p>WIP</p>
</blockquote>
<h3 id="references"><a href="#references">References</a></h3>
<ol>
<li><a href="https://github.com/apache/incubator-brpc/blob/master/docs/cn/timer_keeping.md">&quot;bRPC Timer Keeping&quot;, <em>incubator-brpc</em></a></li>
</ol>

      </div>
      <div id="gitalk-container">
      </div>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2021 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/gitalk.min.js"></script>
    <script src="/dist/main.js"></script>
    <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-61723712-2', 'auto'); ga('send', 'pageview'); </script>
  </body>
</html>
