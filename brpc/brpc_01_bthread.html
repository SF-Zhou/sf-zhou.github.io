<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/gitalk.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>bRPC 源码分析「一、协程设计」 | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> bRPC 源码分析「一、协程设计」 </h1>
      </div>
      <div class="markdown">
        <h3 id="1.-context-switching" tabindex="-1"><a href="#1.-context-switching">1. Context Switching</a></h3>
<p>bthread 中使用 <a href="https://github.com/twlostow/libcontext">libcontext</a> 实现协程间的切换，原理类似<a href="/programming/cpp_magic_coroutine.html">汇编魔法实现 C++ 协程</a>中的方法。看一个单元测试中的例子（<a href="https://godbolt.org/z/sf7vhK">在线执行</a>）：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token operator">*</span>bthread_fcontext_t<span class="token punctuation">;</span>

<span class="token keyword">extern</span> <span class="token string">"C"</span> bthread_fcontext_t <span class="token function">bthread_make_fcontext</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>sp<span class="token punctuation">,</span> size_t size<span class="token punctuation">,</span>
                                                    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>fn<span class="token punctuation">)</span><span class="token punctuation">(</span>intptr_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">__asm</span><span class="token punctuation">(</span>
    <span class="token string">".text\n"</span>
    <span class="token string">".globl bthread_make_fcontext\n"</span>
    <span class="token string">".type bthread_make_fcontext,@function\n"</span>
    <span class="token string">".align 16\n"</span>
    <span class="token string">"bthread_make_fcontext:\n"</span>
    <span class="token string">"    movq  %rdi, %rax\n"</span>
    <span class="token string">"    andq  $-16, %rax\n"</span>
    <span class="token string">"    leaq  -0x48(%rax), %rax\n"</span>
    <span class="token string">"    movq  %rdx, 0x38(%rax)\n"</span>
    <span class="token string">"    stmxcsr  (%rax)\n"</span>
    <span class="token string">"    fnstcw   0x4(%rax)\n"</span>
    <span class="token string">"    leaq  finish(%rip), %rcx\n"</span>
    <span class="token string">"    movq  %rcx, 0x40(%rax)\n"</span>
    <span class="token string">"    ret \n"</span>
    <span class="token string">"finish:\n"</span>
    <span class="token string">"    xorq  %rdi, %rdi\n"</span>
    <span class="token string">"    call  _exit@PLT\n"</span>
    <span class="token string">"    hlt\n"</span>
    <span class="token string">".size bthread_make_fcontext,.-bthread_make_fcontext\n"</span>
    <span class="token string">".section .note.GNU-stack,\"\",%progbits\n"</span>
    <span class="token string">".previous\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">extern</span> <span class="token string">"C"</span> intptr_t <span class="token function">bthread_jump_fcontext</span><span class="token punctuation">(</span>bthread_fcontext_t <span class="token operator">*</span>ofc<span class="token punctuation">,</span>
                                          bthread_fcontext_t nfc<span class="token punctuation">,</span> intptr_t vp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">__asm</span><span class="token punctuation">(</span>
    <span class="token string">".text\n"</span>
    <span class="token string">".globl bthread_jump_fcontext\n"</span>
    <span class="token string">".type bthread_jump_fcontext,@function\n"</span>
    <span class="token string">".align 16\n"</span>
    <span class="token string">"bthread_jump_fcontext:\n"</span>
    <span class="token string">"    pushq  %rbp  \n"</span>
    <span class="token string">"    pushq  %rbx  \n"</span>
    <span class="token string">"    pushq  %r15  \n"</span>
    <span class="token string">"    pushq  %r14  \n"</span>
    <span class="token string">"    pushq  %r13  \n"</span>
    <span class="token string">"    pushq  %r12  \n"</span>
    <span class="token string">"    leaq  -0x8(%rsp), %rsp\n"</span>
    <span class="token string">"    movq  %rsp, (%rdi)\n"</span>
    <span class="token string">"    movq  %rsi, %rsp\n"</span>
    <span class="token string">"    leaq  0x8(%rsp), %rsp\n"</span>
    <span class="token string">"    popq  %r12  \n"</span>
    <span class="token string">"    popq  %r13  \n"</span>
    <span class="token string">"    popq  %r14  \n"</span>
    <span class="token string">"    popq  %r15  \n"</span>
    <span class="token string">"    popq  %rbx  \n"</span>
    <span class="token string">"    popq  %rbp  \n"</span>
    <span class="token string">"    popq  %r8\n"</span>
    <span class="token string">"    movq  %rdx, %rax\n"</span>
    <span class="token string">"    movq  %rdx, %rdi\n"</span>
    <span class="token string">"    jmp  *%r8\n"</span>
    <span class="token string">".size bthread_jump_fcontext,.-bthread_jump_fcontext\n"</span>
    <span class="token string">".section .note.GNU-stack,\"\",%progbits\n"</span>
    <span class="token string">".previous\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

bthread_fcontext_t fcm<span class="token punctuation">;</span>
bthread_fcontext_t fc<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">></span> pair_t<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span>intptr_t param<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pair_t <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span>pair_t <span class="token operator">*</span><span class="token punctuation">)</span>param<span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"In Routine: fcm %p fc %p\n"</span><span class="token punctuation">,</span> fcm<span class="token punctuation">,</span> fc<span class="token punctuation">)</span><span class="token punctuation">;</span>

  p <span class="token operator">=</span> <span class="token punctuation">(</span>pair_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">bthread_jump_fcontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fc<span class="token punctuation">,</span> fcm<span class="token punctuation">,</span>
                                      <span class="token punctuation">(</span>intptr_t<span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token operator">-></span>first <span class="token operator">+</span> p<span class="token operator">-></span>second<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"In Routine Again: fcm %p fc %p\n"</span><span class="token punctuation">,</span> fcm<span class="token punctuation">,</span> fc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">bthread_jump_fcontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fc<span class="token punctuation">,</span> fcm<span class="token punctuation">,</span> <span class="token punctuation">(</span>intptr_t<span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token operator">-></span>first <span class="token operator">+</span> p<span class="token operator">-></span>second<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fcm <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>size_t <span class="token function">size</span><span class="token punctuation">(</span><span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>sp <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

  pair_t <span class="token function">p</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fc <span class="token operator">=</span> <span class="token function">bthread_make_fcontext</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>sp <span class="token operator">+</span> size<span class="token punctuation">,</span> size<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Start Routine: fcm %p fc %p\n"</span><span class="token punctuation">,</span> fcm<span class="token punctuation">,</span> fc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">bthread_jump_fcontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fcm<span class="token punctuation">,</span> fc<span class="token punctuation">,</span> <span class="token punctuation">(</span>intptr_t<span class="token punctuation">)</span><span class="token operator">&amp;</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Back to Main: %d + %d = %d\n"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>first<span class="token punctuation">,</span> p<span class="token punctuation">.</span>second<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>

  p <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Resume Routine: fcm %p fc %p\n"</span><span class="token punctuation">,</span> fcm<span class="token punctuation">,</span> fc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">bthread_jump_fcontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fcm<span class="token punctuation">,</span> fc<span class="token punctuation">,</span> <span class="token punctuation">(</span>intptr_t<span class="token punctuation">)</span><span class="token operator">&amp;</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Back to Main Again: %d + %d = %d\n"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>first<span class="token punctuation">,</span> p<span class="token punctuation">.</span>second<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>bthread 中使用 <code>TaskMeta</code> 结构封装协程的元信息：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// task_meta.h</span>
<span class="token keyword">struct</span> <span class="token class-name">TaskMeta</span> <span class="token punctuation">{</span>
  <span class="token comment">// [Not Reset]</span>
  butil<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>ButexWaiter<span class="token operator">*</span><span class="token operator">></span> current_waiter<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> current_sleep<span class="token punctuation">;</span>

  <span class="token comment">// A builtin flag to mark if the thread is stopping.</span>
  <span class="token keyword">bool</span> stop<span class="token punctuation">;</span>

  <span class="token comment">// The thread is interrupted and should wake up from some blocking ops.</span>
  <span class="token keyword">bool</span> interrupted<span class="token punctuation">;</span>

  <span class="token comment">// Scheduling of the thread can be delayed.</span>
  <span class="token keyword">bool</span> about_to_quit<span class="token punctuation">;</span>

  <span class="token comment">// [Not Reset] guarantee visibility of version_butex.</span>
  pthread_spinlock_t version_lock<span class="token punctuation">;</span>

  <span class="token comment">// [Not Reset] only modified by one bthread at any time, no need to be atomic</span>
  <span class="token keyword">uint32_t</span><span class="token operator">*</span> version_butex<span class="token punctuation">;</span>

  <span class="token comment">// The identifier. It does not have to be here, however many code is</span>
  <span class="token comment">// simplified if they can get tid from TaskMeta.</span>
  bthread_t tid<span class="token punctuation">;</span>

  <span class="token comment">// User function and argument</span>
  <span class="token keyword">void</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>fn<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">;</span>

  <span class="token comment">// Stack of this task.</span>
  ContextualStack<span class="token operator">*</span> stack<span class="token punctuation">;</span>

  <span class="token comment">// Attributes creating this task</span>
  bthread_attr_t attr<span class="token punctuation">;</span>

  <span class="token comment">// Statistics</span>
  <span class="token keyword">int64_t</span> cpuwide_start_ns<span class="token punctuation">;</span>
  TaskStatistics stat<span class="token punctuation">;</span>

  <span class="token comment">// bthread local storage, sync with tls_bls (defined in task_group.cpp)</span>
  <span class="token comment">// when the bthread is created or destroyed.</span>
  <span class="token comment">// DO NOT use this field directly, use tls_bls instead.</span>
  LocalStorage local_storage<span class="token punctuation">;</span>

 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token comment">// Only initialize [Not Reset] fields, other fields will be reset in</span>
  <span class="token comment">// bthread_start* functions</span>
  <span class="token function">TaskMeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">current_waiter</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
      <span class="token punctuation">,</span> <span class="token function">current_sleep</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">,</span> <span class="token function">stack</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">pthread_spin_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>version_lock<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      version_butex <span class="token operator">=</span> <span class="token generic-function"><span class="token function">butex_create_checked</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">*</span>version_butex <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token operator">~</span><span class="token function">TaskMeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">butex_destroy</span><span class="token punctuation">(</span>version_butex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    version_butex <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token function">pthread_spin_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>version_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">set_stack</span><span class="token punctuation">(</span>ContextualStack<span class="token operator">*</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    stack <span class="token operator">=</span> s<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  ContextualStack<span class="token operator">*</span> <span class="token function">release_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ContextualStack<span class="token operator">*</span> tmp <span class="token operator">=</span> stack<span class="token punctuation">;</span>
    stack <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> tmp<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  StackType <span class="token function">stack_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>StackType<span class="token operator">></span></span></span><span class="token punctuation">(</span>attr<span class="token punctuation">.</span>stack_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>这里先只关注协程栈 <code>stack</code>。协程首次调度前会分配对应的调用栈：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// task_group_inl.h</span>
ContextualStack<span class="token operator">*</span> stk <span class="token operator">=</span> <span class="token function">get_stack</span><span class="token punctuation">(</span>next_meta<span class="token operator">-></span><span class="token function">stack_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task_runner<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// stack_inl.h</span>
<span class="token keyword">inline</span> ContextualStack<span class="token operator">*</span> <span class="token function">get_stack</span><span class="token punctuation">(</span>StackType type<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>entry<span class="token punctuation">)</span><span class="token punctuation">(</span>intptr_t<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> STACK_TYPE_PTHREAD<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> STACK_TYPE_SMALL<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token class-name">StackFactory</span><span class="token operator">&lt;</span>SmallStackClass<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">get_stack</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> STACK_TYPE_NORMAL<span class="token operator">:</span>  <span class="token comment">// 默认使用 Normal</span>
      <span class="token keyword">return</span> <span class="token class-name">StackFactory</span><span class="token operator">&lt;</span>NormalStackClass<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">get_stack</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> STACK_TYPE_LARGE<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token class-name">StackFactory</span><span class="token operator">&lt;</span>LargeStackClass<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">get_stack</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> STACK_TYPE_MAIN<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token class-name">StackFactory</span><span class="token operator">&lt;</span>MainStackClass<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">get_stack</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">StackClass</span><span class="token operator">></span> <span class="token keyword">struct</span> <span class="token class-name">StackFactory</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">Wrapper</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">ContextualStack</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">explicit</span> <span class="token function">Wrapper</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>entry<span class="token punctuation">)</span><span class="token punctuation">(</span>intptr_t<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 分配栈内存，默认带内存保护，注意这里的 StackClass::stack_size_flag</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">allocate_stack_storage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>storage<span class="token punctuation">,</span> <span class="token operator">*</span>StackClass<span class="token double-colon punctuation">::</span>stack_size_flag<span class="token punctuation">,</span>
                                 FLAGS_guard_page_size<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        storage<span class="token punctuation">.</span><span class="token function">zeroize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 初始化 context</span>
      context <span class="token operator">=</span> <span class="token function">bthread_make_fcontext</span><span class="token punctuation">(</span>storage<span class="token punctuation">.</span>bottom<span class="token punctuation">,</span> storage<span class="token punctuation">.</span>stacksize<span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
      stacktype <span class="token operator">=</span> <span class="token punctuation">(</span>StackType<span class="token punctuation">)</span>StackClass<span class="token double-colon punctuation">::</span>stacktype<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">Wrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        context <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token comment">// 析构时释放</span>
        <span class="token function">deallocate_stack_storage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>storage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        storage<span class="token punctuation">.</span><span class="token function">zeroize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> ContextualStack<span class="token operator">*</span> <span class="token function">get_stack</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>entry<span class="token punctuation">)</span><span class="token punctuation">(</span>intptr_t<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> butil<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get_object</span><span class="token generic class-name"><span class="token operator">&lt;</span>Wrapper<span class="token operator">></span></span></span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">return_stack</span><span class="token punctuation">(</span>ContextualStack<span class="token operator">*</span> sc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 对象池回收时不会执行析构，申请的栈空间可以复用</span>
    butil<span class="token double-colon punctuation">::</span><span class="token function">return_object</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Wrapper<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">// stack.h</span>
<span class="token keyword">struct</span> <span class="token class-name">StackStorage</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> stacksize<span class="token punctuation">;</span>
  <span class="token keyword">int</span> guardsize<span class="token punctuation">;</span>
  <span class="token keyword">void</span><span class="token operator">*</span> bottom<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> valgrind_stack_id<span class="token punctuation">;</span>

  <span class="token comment">// Clears all members.</span>
  <span class="token keyword">void</span> <span class="token function">zeroize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    stacksize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    guardsize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    bottom <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    valgrind_stack_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Allocate a piece of stack.</span>
<span class="token keyword">int</span> <span class="token function">allocate_stack_storage</span><span class="token punctuation">(</span>StackStorage<span class="token operator">*</span> s<span class="token punctuation">,</span> <span class="token keyword">int</span> stacksize<span class="token punctuation">,</span> <span class="token keyword">int</span> guardsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Deallocate a piece of stack. Parameters MUST be returned or set by the</span>
<span class="token comment">// corresponding allocate_stack_storage() otherwise behavior is undefined.</span>
<span class="token keyword">void</span> <span class="token function">deallocate_stack_storage</span><span class="token punctuation">(</span>StackStorage<span class="token operator">*</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">enum</span> <span class="token class-name">StackType</span> <span class="token punctuation">{</span>
  STACK_TYPE_MAIN <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
  STACK_TYPE_PTHREAD <span class="token operator">=</span> BTHREAD_STACKTYPE_PTHREAD<span class="token punctuation">,</span>
  STACK_TYPE_SMALL <span class="token operator">=</span> BTHREAD_STACKTYPE_SMALL<span class="token punctuation">,</span>
  STACK_TYPE_NORMAL <span class="token operator">=</span> BTHREAD_STACKTYPE_NORMAL<span class="token punctuation">,</span>
  STACK_TYPE_LARGE <span class="token operator">=</span> BTHREAD_STACKTYPE_LARGE
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">ContextualStack</span> <span class="token punctuation">{</span>
  bthread_fcontext_t context<span class="token punctuation">;</span>
  StackType stacktype<span class="token punctuation">;</span>
  StackStorage storage<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">// stack.cpp</span>
<span class="token keyword">int</span> <span class="token function">allocate_stack_storage</span><span class="token punctuation">(</span>StackStorage<span class="token operator">*</span> s<span class="token punctuation">,</span> <span class="token keyword">int</span> stacksize_in<span class="token punctuation">,</span> <span class="token keyword">int</span> guardsize_in<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token keyword">static</span> <span class="token keyword">int</span> PAGESIZE <span class="token operator">=</span> <span class="token function">getpagesize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> PAGESIZE_M1 <span class="token operator">=</span> PAGESIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> MIN_STACKSIZE <span class="token operator">=</span> PAGESIZE <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> MIN_GUARDSIZE <span class="token operator">=</span> PAGESIZE<span class="token punctuation">;</span>

  <span class="token comment">// Align stacksize</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> stacksize <span class="token operator">=</span>
    <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span>stacksize_in<span class="token punctuation">,</span> MIN_STACKSIZE<span class="token punctuation">)</span> <span class="token operator">+</span> PAGESIZE_M1<span class="token punctuation">)</span> <span class="token operator">&amp;</span>
    <span class="token operator">~</span>PAGESIZE_M1<span class="token punctuation">;</span>  <span class="token comment">// 栈对齐，PAGESIZE 一般是 4K</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>guardsize_in <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Align guardsize</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> guardsize <span class="token operator">=</span>
      <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span>guardsize_in<span class="token punctuation">,</span> MIN_GUARDSIZE<span class="token punctuation">)</span> <span class="token operator">+</span> PAGESIZE_M1<span class="token punctuation">)</span> <span class="token operator">&amp;</span>
      <span class="token operator">~</span>PAGESIZE_M1<span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">int</span> memsize <span class="token operator">=</span> stacksize <span class="token operator">+</span> guardsize<span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token operator">*</span> <span class="token keyword">const</span> mem <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> memsize<span class="token punctuation">,</span> <span class="token punctuation">(</span>PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">)</span><span class="token punctuation">,</span>
                           <span class="token punctuation">(</span>MAP_PRIVATE <span class="token operator">|</span> MAP_ANONYMOUS<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>MAP_FAILED <span class="token operator">==</span> mem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">PLOG_EVERY_SECOND</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> 
        <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to mmap size="</span> <span class="token operator">&lt;&lt;</span> memsize <span class="token operator">&lt;&lt;</span> <span class="token string">" stack_count="</span>
        <span class="token operator">&lt;&lt;</span> s_stack_count<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span>
        <span class="token operator">&lt;&lt;</span> <span class="token string">", possibly limited by /proc/sys/vm/max_map_count"</span><span class="token punctuation">;</span>
      <span class="token comment">// may fail due to limit of max_map_count (65536 in default)</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span><span class="token operator">*</span> aligned_mem <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>intptr_t<span class="token punctuation">)</span>mem <span class="token operator">+</span> PAGESIZE_M1<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span>PAGESIZE_M1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>aligned_mem <span class="token operator">!=</span> mem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">LOG_ONCE</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"addr="</span> <span class="token operator">&lt;&lt;</span> mem <span class="token operator">&lt;&lt;</span> <span class="token string">" returned by mmap is not "</span>
        <span class="token string">"aligned by pagesize="</span> <span class="token operator">&lt;&lt;</span> PAGESIZE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>aligned_mem <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">;</span>
    <span class="token comment">// 使用 mprotect，当栈溢出时抛出异常</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>guardsize <span class="token operator">&lt;=</span> offset <span class="token operator">||</span>
        <span class="token function">mprotect</span><span class="token punctuation">(</span>aligned_mem<span class="token punctuation">,</span> guardsize <span class="token operator">-</span> offset<span class="token punctuation">,</span> PROT_NONE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">munmap</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> memsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">PLOG_EVERY_SECOND</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> 
        <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to mprotect "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>aligned_mem <span class="token operator">&lt;&lt;</span> <span class="token string">" length="</span>
        <span class="token operator">&lt;&lt;</span> guardsize <span class="token operator">-</span> offset<span class="token punctuation">;</span> 
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    s_stack_count<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    s<span class="token operator">-></span>bottom <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>mem <span class="token operator">+</span> memsize<span class="token punctuation">;</span>
    s<span class="token operator">-></span>stacksize <span class="token operator">=</span> stacksize<span class="token punctuation">;</span>
    s<span class="token operator">-></span>guardsize <span class="token operator">=</span> guardsize<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">RunningOnValgrind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      s<span class="token operator">-></span>valgrind_stack_id <span class="token operator">=</span> <span class="token function">VALGRIND_STACK_REGISTER</span><span class="token punctuation">(</span>
        s<span class="token operator">-></span>bottom<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>s<span class="token operator">-></span>bottom <span class="token operator">-</span> stacksize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      s<span class="token operator">-></span>valgrind_stack_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span><span class="token operator">*</span> SmallStackClass<span class="token double-colon punctuation">::</span>stack_size_flag <span class="token operator">=</span> <span class="token operator">&amp;</span>FLAGS_stack_size_small<span class="token punctuation">;</span>
<span class="token keyword">int</span><span class="token operator">*</span> NormalStackClass<span class="token double-colon punctuation">::</span>stack_size_flag <span class="token operator">=</span> <span class="token operator">&amp;</span>FLAGS_stack_size_normal<span class="token punctuation">;</span>
<span class="token keyword">int</span><span class="token operator">*</span> LargeStackClass<span class="token double-colon punctuation">::</span>stack_size_flag <span class="token operator">=</span> <span class="token operator">&amp;</span>FLAGS_stack_size_large<span class="token punctuation">;</span>
</code></pre>
<h3 id="2.-work-stealing" tabindex="-1"><a href="#2.-work-stealing">2. Work Stealing</a></h3>
<p>核心思路是当本线程内没有待执行的任务时，从其他线程的任务队列中窃取任务执行。首先来看 work stealing 时使用的无锁队列 <a href="https://github.com/apache/incubator-brpc/blob/0.9.7/src/bthread/work_stealing_queue.h">src/bthread/work_stealing_queue.h</a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">class</span> <span class="token class-name">WorkStealingQueue</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">WorkStealingQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_bottom</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_capacity</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_buffer</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_top</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">int</span> <span class="token function">init</span><span class="token punctuation">(</span>size_t capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_capacity <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Already initialized"</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>capacity <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Invalid capacity="</span> <span class="token operator">&lt;&lt;</span> capacity<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>capacity <span class="token operator">&amp;</span> <span class="token punctuation">(</span>capacity <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Invalid capacity="</span> <span class="token operator">&lt;&lt;</span> capacity
                 <span class="token operator">&lt;&lt;</span> <span class="token string">" which must be power of 2"</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>nothrow<span class="token punctuation">)</span> T<span class="token punctuation">[</span>capacity<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> _buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _capacity <span class="token operator">=</span> capacity<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 从底部追加，非线程安全，与 steal 线程安全</span>
  <span class="token keyword">bool</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">const</span> T<span class="token operator">&amp;</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> size_t b <span class="token operator">=</span> _bottom<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> size_t t <span class="token operator">=</span> _top<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">>=</span> t <span class="token operator">+</span> _capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// Full queue.</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _buffer<span class="token punctuation">[</span>b <span class="token operator">&amp;</span> <span class="token punctuation">(</span>_capacity <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>
    _bottom<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>b <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 从底部弹出，非线程安全，与 steal 线程安全</span>
  <span class="token keyword">bool</span> <span class="token function">pop</span><span class="token punctuation">(</span>T<span class="token operator">*</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> size_t b <span class="token operator">=</span> _bottom<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    size_t t <span class="token operator">=</span> _top<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">>=</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// fast check since we call pop() in each sched.</span>
      <span class="token comment">// Stale _top which is smaller should not enter this branch.</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> size_t newb <span class="token operator">=</span> b <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    _bottom<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>newb<span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    butil<span class="token double-colon punctuation">::</span><span class="token function">atomic_thread_fence</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_seq_cst<span class="token punctuation">)</span><span class="token punctuation">;</span>
    t <span class="token operator">=</span> _top<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">></span> newb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _bottom<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">*</span>val <span class="token operator">=</span> _buffer<span class="token punctuation">[</span>newb <span class="token operator">&amp;</span> <span class="token punctuation">(</span>_capacity <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> newb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Single last element, compete with steal()</span>
    <span class="token comment">// 对于最后一个元素，使用 CAS 保证和 steal 并发时的线程安全</span>
    <span class="token keyword">const</span> <span class="token keyword">bool</span> popped <span class="token operator">=</span> _top<span class="token punctuation">.</span><span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>
        t<span class="token punctuation">,</span> t <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_seq_cst<span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _bottom<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> popped<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 从顶部窃取，线程安全</span>
  <span class="token keyword">bool</span> <span class="token function">steal</span><span class="token punctuation">(</span>T<span class="token operator">*</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    size_t t <span class="token operator">=</span> _top<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
    size_t b <span class="token operator">=</span> _bottom<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">>=</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Permit false negative for performance considerations.</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      butil<span class="token double-colon punctuation">::</span><span class="token function">atomic_thread_fence</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_seq_cst<span class="token punctuation">)</span><span class="token punctuation">;</span>
      b <span class="token operator">=</span> _bottom<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">>=</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token operator">*</span>val <span class="token operator">=</span> _buffer<span class="token punctuation">[</span>t <span class="token operator">&amp;</span> <span class="token punctuation">(</span>_capacity <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// CAS 保证线程安全</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>_top<span class="token punctuation">.</span><span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>
        t<span class="token punctuation">,</span> t <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_seq_cst<span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token comment">// Copying a concurrent structure makes no sense.</span>
  <span class="token function">DISALLOW_COPY_AND_ASSIGN</span><span class="token punctuation">(</span>WorkStealingQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>

  butil<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>size_t<span class="token operator">></span> _bottom<span class="token punctuation">;</span>
  size_t _capacity<span class="token punctuation">;</span>
  T<span class="token operator">*</span> _buffer<span class="token punctuation">;</span>
  butil<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>size_t<span class="token operator">></span> BAIDU_CACHELINE_ALIGNMENT _top<span class="token punctuation">;</span>  <span class="token comment">// 分开到两个 CacheLine</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p><code>push</code> 和 <code>pop</code> 仅在底部操作，非线程安全。<code>steal</code> 仅在顶部窃取，通过 CAS 保证线程安全。</p>
<p>接着来看 bthread 启动的流程：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// test/bthread_unittest.cpp</span>
<span class="token function">TEST_F</span><span class="token punctuation">(</span>BthreadTest<span class="token punctuation">,</span> sanity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bthread_t th1<span class="token punctuation">;</span>
  <span class="token function">ASSERT_EQ</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">bthread_start_urgent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>th1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> misc<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"back to main thread "</span> <span class="token operator">&lt;&lt;</span> th1 <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ASSERT_EQ</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">bthread_join</span><span class="token punctuation">(</span>th1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// bthread.cpp</span>
<span class="token keyword">int</span> <span class="token function">bthread_start_urgent</span><span class="token punctuation">(</span>bthread_t<span class="token operator">*</span> __restrict tid<span class="token punctuation">,</span>
                         <span class="token keyword">const</span> bthread_attr_t<span class="token operator">*</span> __restrict attr<span class="token punctuation">,</span>
                         <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>fn<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         <span class="token keyword">void</span><span class="token operator">*</span> __restrict arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  bthread<span class="token double-colon punctuation">::</span>TaskGroup<span class="token operator">*</span> g <span class="token operator">=</span> bthread<span class="token double-colon punctuation">::</span>tls_task_group<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>g<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// start from worker</span>
    <span class="token keyword">return</span> bthread<span class="token double-colon punctuation">::</span><span class="token class-name">TaskGroup</span><span class="token double-colon punctuation">::</span><span class="token function">start_foreground</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g<span class="token punctuation">,</span> tid<span class="token punctuation">,</span> attr<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 首次执行，需要初始化</span>
  <span class="token keyword">return</span> bthread<span class="token double-colon punctuation">::</span><span class="token function">start_from_non_worker</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> attr<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

BUTIL_FORCE_INLINE <span class="token keyword">int</span>
  <span class="token function">start_from_non_worker</span><span class="token punctuation">(</span>bthread_t<span class="token operator">*</span> __restrict tid<span class="token punctuation">,</span>
                        <span class="token keyword">const</span> bthread_attr_t<span class="token operator">*</span> __restrict attr<span class="token punctuation">,</span>
                        <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>fn<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">void</span><span class="token operator">*</span> __restrict arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取 TaskControl 全局单例</span>
  TaskControl<span class="token operator">*</span> c <span class="token operator">=</span> <span class="token function">get_or_new_task_control</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> ENOMEM<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>attr <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>attr<span class="token operator">-></span>flags <span class="token operator">&amp;</span> BTHREAD_NOSIGNAL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Remember the TaskGroup to insert NOSIGNAL tasks for 2 reasons:</span>
    <span class="token comment">// 1. NOSIGNAL is often for creating many bthreads in batch,</span>
    <span class="token comment">//    inserting into the same TaskGroup maximizes the batch.</span>
    <span class="token comment">// 2. bthread_flush() needs to know which TaskGroup to flush.</span>
    TaskGroup<span class="token operator">*</span> g <span class="token operator">=</span> tls_task_group_nosignal<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      g <span class="token operator">=</span> c<span class="token operator">-></span><span class="token function">choose_one_group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      tls_task_group_nosignal <span class="token operator">=</span> g<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> g<span class="token operator">-></span><span class="token generic-function"><span class="token function">start_background</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token boolean">true</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> attr<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 加入队列</span>
  <span class="token keyword">return</span> c<span class="token operator">-></span><span class="token function">choose_one_group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token generic-function"><span class="token function">start_background</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token boolean">true</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>
    tid<span class="token punctuation">,</span> attr<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">inline</span> TaskControl<span class="token operator">*</span> <span class="token function">get_or_new_task_control</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  butil<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>TaskControl<span class="token operator">*</span><span class="token operator">></span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>TaskControl<span class="token operator">*</span><span class="token operator">></span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>g_task_control<span class="token punctuation">;</span>
  TaskControl<span class="token operator">*</span> c <span class="token operator">=</span> p<span class="token operator">-></span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_consume<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> c<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">BAIDU_SCOPED_LOCK</span><span class="token punctuation">(</span>g_task_control_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 全局锁</span>
  c <span class="token operator">=</span> p<span class="token operator">-></span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_consume<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> c<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>nothrow<span class="token punctuation">)</span> TaskControl<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">int</span> concurrency <span class="token operator">=</span> FLAGS_bthread_min_concurrency <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span>
    FLAGS_bthread_min_concurrency <span class="token operator">:</span>
  FLAGS_bthread_concurrency<span class="token punctuation">;</span>
  <span class="token comment">// 初始化，concurrency 为工作线程数</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token operator">-></span><span class="token function">init</span><span class="token punctuation">(</span>concurrency<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to init g_task_control"</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> c<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  p<span class="token operator">-></span><span class="token function">store</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> c<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// task_control.cpp</span>
<span class="token keyword">int</span> <span class="token class-name">TaskControl</span><span class="token double-colon punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">int</span> concurrency<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_concurrency <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Already initialized"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>concurrency <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Invalid concurrency="</span> <span class="token operator">&lt;&lt;</span> concurrency<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  _concurrency <span class="token operator">=</span> concurrency<span class="token punctuation">;</span>

  <span class="token comment">// Make sure TimerThread is ready.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_or_create_global_timer_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to get global_timer_thread"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  _workers<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>_concurrency<span class="token punctuation">)</span><span class="token punctuation">;</span>   
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _concurrency<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 启动工作线程</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_workers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> worker_thread<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to create _workers["</span> <span class="token operator">&lt;&lt;</span> i <span class="token operator">&lt;&lt;</span> <span class="token string">"], "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">berror</span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  _worker_usage_second<span class="token punctuation">.</span><span class="token function">expose</span><span class="token punctuation">(</span><span class="token string">"bthread_worker_usage"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  _switch_per_second<span class="token punctuation">.</span><span class="token function">expose</span><span class="token punctuation">(</span><span class="token string">"bthread_switch_second"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  _signal_per_second<span class="token punctuation">.</span><span class="token function">expose</span><span class="token punctuation">(</span><span class="token string">"bthread_signal_second"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  _status<span class="token punctuation">.</span><span class="token function">expose</span><span class="token punctuation">(</span><span class="token string">"bthread_group_status"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Wait for at least one group is added so that choose_one_group()</span>
  <span class="token comment">// never returns NULL.</span>
  <span class="token comment">// TODO: Handle the case that worker quits before add_group</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>_ngroup <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// TODO: Elaborate</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>bthread 后台会开启多个 <code>worker_thread</code> 线程执行 bthread 任务：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// task_control.cpp</span>
<span class="token keyword">void</span><span class="token operator">*</span> <span class="token class-name">TaskControl</span><span class="token double-colon punctuation">::</span><span class="token function">worker_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">run_worker_startfn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  TaskControl<span class="token operator">*</span> c <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>TaskControl<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  TaskGroup<span class="token operator">*</span> g <span class="token operator">=</span> c<span class="token operator">-></span><span class="token function">create_group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 每个线程有一个对应的 TaskGroup</span>
  TaskStatistics stat<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Fail to create TaskGroup in pthread="</span> <span class="token operator">&lt;&lt;</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  BT_VLOG <span class="token operator">&lt;&lt;</span> <span class="token string">"Created worker="</span> <span class="token operator">&lt;&lt;</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">&lt;&lt;</span> <span class="token string">" bthread="</span> <span class="token operator">&lt;&lt;</span> g<span class="token operator">-></span><span class="token function">main_tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  tls_task_group <span class="token operator">=</span> g<span class="token punctuation">;</span>  <span class="token comment">// 使用 TLS 存储线程对应的 TaskGroup</span>
  c<span class="token operator">-></span>_nworkers <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
  g<span class="token operator">-></span><span class="token function">run_main_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 任务主循环</span>

  stat <span class="token operator">=</span> g<span class="token operator">-></span><span class="token function">main_stat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  BT_VLOG <span class="token operator">&lt;&lt;</span> <span class="token string">"Destroying worker="</span> <span class="token operator">&lt;&lt;</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bthread="</span>
    <span class="token operator">&lt;&lt;</span> g<span class="token operator">-></span><span class="token function">main_tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" idle="</span> <span class="token operator">&lt;&lt;</span> stat<span class="token punctuation">.</span>cputime_ns <span class="token operator">/</span> <span class="token number">1000000.0</span>
    <span class="token operator">&lt;&lt;</span> <span class="token string">"ms uptime="</span> <span class="token operator">&lt;&lt;</span> g<span class="token operator">-></span><span class="token function">current_uptime_ns</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000000.0</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ms"</span><span class="token punctuation">;</span>
  tls_task_group <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  g<span class="token operator">-></span><span class="token function">destroy_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  c<span class="token operator">-></span>_nworkers <span class="token operator">&lt;&lt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// task_group.cpp</span>
<span class="token keyword">void</span> <span class="token class-name">TaskGroup</span><span class="token double-colon punctuation">::</span><span class="token function">run_main_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  bvar<span class="token double-colon punctuation">::</span>PassiveStatus<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span> <span class="token function">cumulated_cputime</span><span class="token punctuation">(</span>
    get_cumulated_cputime_from_this<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>bvar<span class="token double-colon punctuation">::</span>PerSecond<span class="token operator">&lt;</span>bvar<span class="token double-colon punctuation">::</span>PassiveStatus<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span> <span class="token operator">></span> <span class="token operator">></span> usage_bvar<span class="token punctuation">;</span>

  TaskGroup<span class="token operator">*</span> dummy <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  bthread_t tid<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">wait_task</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 获取任务</span>
    <span class="token class-name">TaskGroup</span><span class="token double-colon punctuation">::</span><span class="token function">sched_to</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dummy<span class="token punctuation">,</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 调度执行</span>
    <span class="token function">DCHECK_EQ</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> dummy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">DCHECK_EQ</span><span class="token punctuation">(</span>_cur_meta<span class="token operator">-></span>stack<span class="token punctuation">,</span> _main_stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_cur_meta<span class="token operator">-></span>tid <span class="token operator">!=</span> _main_tid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">TaskGroup</span><span class="token double-colon punctuation">::</span><span class="token function">task_runner</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token comment">/*skip remained*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">TaskGroup</span><span class="token double-colon punctuation">::</span><span class="token function">wait_task</span><span class="token punctuation">(</span>bthread_t<span class="token operator">*</span> tid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_last_pl_state<span class="token punctuation">.</span><span class="token function">stopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _pl<span class="token operator">-></span><span class="token function">wait</span><span class="token punctuation">(</span>_last_pl_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">steal_task</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 窃取任务</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token function">steal_task</span><span class="token punctuation">(</span>bthread_t<span class="token operator">*</span> tid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 本地队列中有任务，优先本地</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_remote_rq<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 否则通过 TaskControl 窃取全局的任务</span>
  <span class="token keyword">return</span> _control<span class="token operator">-></span><span class="token function">steal_task</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_steal_seed<span class="token punctuation">,</span> _steal_offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// task_control.cpp</span>
<span class="token keyword">bool</span> <span class="token class-name">TaskControl</span><span class="token double-colon punctuation">::</span><span class="token function">steal_task</span><span class="token punctuation">(</span>bthread_t<span class="token operator">*</span> tid<span class="token punctuation">,</span> size_t<span class="token operator">*</span> seed<span class="token punctuation">,</span> size_t offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1: Acquiring fence is paired with releasing fence in _add_group to</span>
  <span class="token comment">// avoid accessing uninitialized slot of _groups.</span>
  <span class="token keyword">const</span> size_t ngroup <span class="token operator">=</span> _ngroup<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token comment">/*1*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> ngroup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// NOTE: Don't return inside `for' iteration since we need to update |seed|</span>
  <span class="token keyword">bool</span> stolen <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  size_t s <span class="token operator">=</span> <span class="token operator">*</span>seed<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ngroup<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">,</span> s <span class="token operator">+=</span> offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TaskGroup<span class="token operator">*</span> g <span class="token operator">=</span> _groups<span class="token punctuation">[</span>s <span class="token operator">%</span> ngroup<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// g is possibly NULL because of concurrent _destroy_group</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>g<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>g<span class="token operator">-></span>_rq<span class="token punctuation">.</span><span class="token function">steal</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 无锁窃取</span>
        stolen <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>g<span class="token operator">-></span>_remote_rq<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 有锁窃取</span>
        stolen <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token operator">*</span>seed <span class="token operator">=</span> s<span class="token punctuation">;</span>
  <span class="token keyword">return</span> stolen<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// task_group_inl.h</span>
<span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token class-name">TaskGroup</span><span class="token double-colon punctuation">::</span><span class="token function">sched_to</span><span class="token punctuation">(</span>TaskGroup<span class="token operator">*</span><span class="token operator">*</span> pg<span class="token punctuation">,</span> bthread_t next_tid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  TaskMeta<span class="token operator">*</span> next_meta <span class="token operator">=</span> <span class="token function">address_meta</span><span class="token punctuation">(</span>next_tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>next_meta<span class="token operator">-></span>stack <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ContextualStack<span class="token operator">*</span> stk <span class="token operator">=</span> <span class="token function">get_stack</span><span class="token punctuation">(</span>next_meta<span class="token operator">-></span><span class="token function">stack_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task_runner<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      next_meta<span class="token operator">-></span><span class="token function">set_stack</span><span class="token punctuation">(</span>stk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// stack_type is BTHREAD_STACKTYPE_PTHREAD or out of memory,</span>
      <span class="token comment">// In latter case, attr is forced to be BTHREAD_STACKTYPE_PTHREAD.</span>
      <span class="token comment">// This basically means that if we can't allocate stack, run</span>
      <span class="token comment">// the task in pthread directly.</span>
      next_meta<span class="token operator">-></span>attr<span class="token punctuation">.</span>stack_type <span class="token operator">=</span> BTHREAD_STACKTYPE_PTHREAD<span class="token punctuation">;</span>
      next_meta<span class="token operator">-></span><span class="token function">set_stack</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pg<span class="token punctuation">)</span><span class="token operator">-></span>_main_stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Update now_ns only when wait_task did yield.</span>
  <span class="token function">sched_to</span><span class="token punctuation">(</span>pg<span class="token punctuation">,</span> next_meta<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 执行</span>
<span class="token punctuation">}</span>


<span class="token comment">// task_group.cpp</span>
<span class="token keyword">void</span> <span class="token class-name">TaskGroup</span><span class="token double-colon punctuation">::</span><span class="token function">sched_to</span><span class="token punctuation">(</span>TaskGroup<span class="token operator">*</span><span class="token operator">*</span> pg<span class="token punctuation">,</span> TaskMeta<span class="token operator">*</span> next_meta<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  TaskGroup<span class="token operator">*</span> g <span class="token operator">=</span> <span class="token operator">*</span>pg<span class="token punctuation">;</span>
  <span class="token comment">// Save errno so that errno is bthread-specific.</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> saved_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
  <span class="token keyword">void</span><span class="token operator">*</span> saved_unique_user_ptr <span class="token operator">=</span> tls_unique_user_ptr<span class="token punctuation">;</span>

  TaskMeta<span class="token operator">*</span> <span class="token keyword">const</span> cur_meta <span class="token operator">=</span> g<span class="token operator">-></span>_cur_meta<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int64_t</span> now <span class="token operator">=</span> butil<span class="token double-colon punctuation">::</span><span class="token function">cpuwide_time_ns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int64_t</span> elp_ns <span class="token operator">=</span> now <span class="token operator">-</span> g<span class="token operator">-></span>_last_run_ns<span class="token punctuation">;</span>
  g<span class="token operator">-></span>_last_run_ns <span class="token operator">=</span> now<span class="token punctuation">;</span>
  cur_meta<span class="token operator">-></span>stat<span class="token punctuation">.</span>cputime_ns <span class="token operator">+=</span> elp_ns<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_meta<span class="token operator">-></span>tid <span class="token operator">!=</span> g<span class="token operator">-></span><span class="token function">main_tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    g<span class="token operator">-></span>_cumulated_cputime_ns <span class="token operator">+=</span> elp_ns<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">++</span>cur_meta<span class="token operator">-></span>stat<span class="token punctuation">.</span>nswitch<span class="token punctuation">;</span>
  <span class="token operator">++</span> g<span class="token operator">-></span>_nswitch<span class="token punctuation">;</span>
  <span class="token comment">// Switch to the task</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span>next_meta <span class="token operator">!=</span> cur_meta<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    g<span class="token operator">-></span>_cur_meta <span class="token operator">=</span> next_meta<span class="token punctuation">;</span>
    <span class="token comment">// Switch tls_bls</span>
    cur_meta<span class="token operator">-></span>local_storage <span class="token operator">=</span> tls_bls<span class="token punctuation">;</span>
    tls_bls <span class="token operator">=</span> next_meta<span class="token operator">-></span>local_storage<span class="token punctuation">;</span>

    <span class="token comment">// Logging must be done after switching the local storage, since the logging lib</span>
    <span class="token comment">// use bthread local storage internally, or will cause memory leak.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cur_meta<span class="token operator">-></span>attr<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> BTHREAD_LOG_CONTEXT_SWITCH<span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span>next_meta<span class="token operator">-></span>attr<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> BTHREAD_LOG_CONTEXT_SWITCH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Switch bthread: "</span> <span class="token operator">&lt;&lt;</span> cur_meta<span class="token operator">-></span>tid <span class="token operator">&lt;&lt;</span> <span class="token string">" -> "</span>
        <span class="token operator">&lt;&lt;</span> next_meta<span class="token operator">-></span>tid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_meta<span class="token operator">-></span>stack <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>next_meta<span class="token operator">-></span>stack <span class="token operator">!=</span> cur_meta<span class="token operator">-></span>stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">jump_stack</span><span class="token punctuation">(</span>cur_meta<span class="token operator">-></span>stack<span class="token punctuation">,</span> next_meta<span class="token operator">-></span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 协程切换</span>
        <span class="token comment">// probably went to another group, need to assign g again.</span>
        g <span class="token operator">=</span> tls_task_group<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// else because of ending_sched(including pthread_task->pthread_task)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"bthread="</span> <span class="token operator">&lt;&lt;</span> g<span class="token operator">-></span><span class="token function">current_tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" sched_to itself!"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>g<span class="token operator">-></span>_last_context_remained<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RemainedFn fn <span class="token operator">=</span> g<span class="token operator">-></span>_last_context_remained<span class="token punctuation">;</span>
    g<span class="token operator">-></span>_last_context_remained <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token function">fn</span><span class="token punctuation">(</span>g<span class="token operator">-></span>_last_context_remained_arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    g <span class="token operator">=</span> tls_task_group<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Restore errno</span>
  errno <span class="token operator">=</span> saved_errno<span class="token punctuation">;</span>
  tls_unique_user_ptr <span class="token operator">=</span> saved_unique_user_ptr<span class="token punctuation">;</span>

  <span class="token operator">*</span>pg <span class="token operator">=</span> g<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// stack_inl.h</span>
<span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">jump_stack</span><span class="token punctuation">(</span>ContextualStack<span class="token operator">*</span> from<span class="token punctuation">,</span> ContextualStack<span class="token operator">*</span> to<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">bthread_jump_fcontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>from<span class="token operator">-></span>context<span class="token punctuation">,</span> to<span class="token operator">-></span>context<span class="token punctuation">,</span> <span class="token number">0</span><span class="token comment">/*not skip remained*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>从外部线程通过 TaskControl 新增 bthread 的流程：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// task_group.cpp</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">bool</span> REMOTE<span class="token operator">></span>
<span class="token keyword">int</span> <span class="token class-name">TaskGroup</span><span class="token double-colon punctuation">::</span><span class="token function">start_background</span><span class="token punctuation">(</span>bthread_t<span class="token operator">*</span> __restrict th<span class="token punctuation">,</span>
                                <span class="token keyword">const</span> bthread_attr_t<span class="token operator">*</span> __restrict attr<span class="token punctuation">,</span>
                                <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>fn<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token keyword">void</span><span class="token operator">*</span> __restrict arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token keyword">int64_t</span> start_ns <span class="token operator">=</span> butil<span class="token double-colon punctuation">::</span><span class="token function">cpuwide_time_ns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> bthread_attr_t using_attr <span class="token operator">=</span> <span class="token punctuation">(</span>attr <span class="token operator">?</span> <span class="token operator">*</span>attr <span class="token operator">:</span> BTHREAD_ATTR_NORMAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    butil<span class="token double-colon punctuation">::</span>ResourceId<span class="token operator">&lt;</span>TaskMeta<span class="token operator">></span> slot<span class="token punctuation">;</span>
    TaskMeta<span class="token operator">*</span> m <span class="token operator">=</span> butil<span class="token double-colon punctuation">::</span><span class="token function">get_resource</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span><span class="token operator">!</span>m<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> ENOMEM<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">CHECK</span><span class="token punctuation">(</span>m<span class="token operator">-></span>current_waiter<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m<span class="token operator">-></span>stop <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    m<span class="token operator">-></span>interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    m<span class="token operator">-></span>about_to_quit <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    m<span class="token operator">-></span>fn <span class="token operator">=</span> fn<span class="token punctuation">;</span>
    m<span class="token operator">-></span>arg <span class="token operator">=</span> arg<span class="token punctuation">;</span>
    <span class="token function">CHECK</span><span class="token punctuation">(</span>m<span class="token operator">-></span>stack <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m<span class="token operator">-></span>attr <span class="token operator">=</span> using_attr<span class="token punctuation">;</span>
    m<span class="token operator">-></span>local_storage <span class="token operator">=</span> LOCAL_STORAGE_INIT<span class="token punctuation">;</span>
    m<span class="token operator">-></span>cpuwide_start_ns <span class="token operator">=</span> start_ns<span class="token punctuation">;</span>
    m<span class="token operator">-></span>stat <span class="token operator">=</span> EMPTY_STAT<span class="token punctuation">;</span>
    m<span class="token operator">-></span>tid <span class="token operator">=</span> <span class="token function">make_tid</span><span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token operator">-></span>version_butex<span class="token punctuation">,</span> slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>th <span class="token operator">=</span> m<span class="token operator">-></span>tid<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>using_attr<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> BTHREAD_LOG_START_AND_FINISH<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Started bthread "</span> <span class="token operator">&lt;&lt;</span> m<span class="token operator">-></span>tid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _control<span class="token operator">-></span>_nbthreads <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>REMOTE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 外部线程</span>
        <span class="token function">ready_to_run_remote</span><span class="token punctuation">(</span>m<span class="token operator">-></span>tid<span class="token punctuation">,</span> <span class="token punctuation">(</span>using_attr<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> BTHREAD_NOSIGNAL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">ready_to_run</span><span class="token punctuation">(</span>m<span class="token operator">-></span>tid<span class="token punctuation">,</span> <span class="token punctuation">(</span>using_attr<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> BTHREAD_NOSIGNAL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">TaskGroup</span><span class="token double-colon punctuation">::</span><span class="token function">ready_to_run_remote</span><span class="token punctuation">(</span>bthread_t tid<span class="token punctuation">,</span> <span class="token keyword">bool</span> nosignal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 加锁后加入队列</span>
    _remote_rq<span class="token punctuation">.</span>_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>_remote_rq<span class="token punctuation">.</span><span class="token function">push_locked</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">flush_nosignal_tasks_remote_locked</span><span class="token punctuation">(</span>_remote_rq<span class="token punctuation">.</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOG_EVERY_SECOND</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"_remote_rq is full, capacity="</span>
                                <span class="token operator">&lt;&lt;</span> _remote_rq<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token double-colon punctuation">::</span><span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _remote_rq<span class="token punctuation">.</span>_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nosignal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">++</span>_remote_num_nosignal<span class="token punctuation">;</span>
        _remote_rq<span class="token punctuation">.</span>_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> additional_signal <span class="token operator">=</span> _remote_num_nosignal<span class="token punctuation">;</span>
        _remote_num_nosignal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        _remote_nsignaled <span class="token operator">+=</span> <span class="token number">1</span> <span class="token operator">+</span> additional_signal<span class="token punctuation">;</span>
        _remote_rq<span class="token punctuation">.</span>_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _control<span class="token operator">-></span><span class="token function">signal_task</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> additional_signal<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 唤醒工作线程执行任务</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="3.-futex-&amp;-butex" tabindex="-1"><a href="#3.-futex-%26-butex">3. Futex &amp; Butex</a></h3>
<p>Linux 中提供了快速的用户态锁 futex，bRPC 中进行了简单的封装：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// sys_futex.h</span>
<span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">futex_wait_private</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr1<span class="token punctuation">,</span> <span class="token keyword">int</span> expected<span class="token punctuation">,</span>
                              <span class="token keyword">const</span> timespec <span class="token operator">*</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 当 *addr1 == expected 时，线程挂起等待</span>
  <span class="token keyword">return</span> <span class="token function">syscall</span><span class="token punctuation">(</span>SYS_futex<span class="token punctuation">,</span> addr1<span class="token punctuation">,</span> <span class="token punctuation">(</span>FUTEX_WAIT <span class="token operator">|</span> FUTEX_PRIVATE_FLAG<span class="token punctuation">)</span><span class="token punctuation">,</span> expected<span class="token punctuation">,</span>
                 timeout<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">futex_wake_private</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr1<span class="token punctuation">,</span> <span class="token keyword">int</span> nwake<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 唤醒 nwake 个等待的线程</span>
  <span class="token keyword">return</span> <span class="token function">syscall</span><span class="token punctuation">(</span>SYS_futex<span class="token punctuation">,</span> addr1<span class="token punctuation">,</span> <span class="token punctuation">(</span>FUTEX_WAKE <span class="token operator">|</span> FUTEX_PRIVATE_FLAG<span class="token punctuation">)</span><span class="token punctuation">,</span> nwake<span class="token punctuation">,</span>
                 <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>对于 MacOS，bthread 也提供了用户态的实现，可以自行查看 <a href="https://github.com/apache/incubator-brpc/blob/0.9.7/src/bthread/sys_futex.cpp">src/bthread/sys_futex.cpp</a> 中对应的实现。使用 futex 可以构造更快速的互斥锁：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// mutex.h</span>
<span class="token keyword">class</span> <span class="token class-name">FastPthreadMutex</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">FastPthreadMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_futex</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token operator">~</span><span class="token function">FastPthreadMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> <span class="token function">try_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token function">DISALLOW_COPY_AND_ASSIGN</span><span class="token punctuation">(</span>FastPthreadMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> <span class="token function">lock_contended</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> _futex<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">// mutex.cpp</span>
<span class="token comment">// Implement bthread_mutex_t related functions</span>
<span class="token keyword">struct</span> <span class="token class-name">MutexInternal</span> <span class="token punctuation">{</span>
  butil<span class="token double-colon punctuation">::</span>static_atomic<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> locked<span class="token punctuation">;</span>
  butil<span class="token double-colon punctuation">::</span>static_atomic<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> contended<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> padding<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> MutexInternal MUTEX_CONTENDED_RAW <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> MutexInternal MUTEX_LOCKED_RAW <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// Define as macros rather than constants which can't be put in read-only</span>
<span class="token comment">// section and affected by initialization-order fiasco.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTHREAD_MUTEX_CONTENDED</span>                                                <span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>bthread<span class="token double-colon punctuation">::</span>MUTEX_CONTENDED_RAW<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTHREAD_MUTEX_LOCKED</span> <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>bthread<span class="token double-colon punctuation">::</span>MUTEX_LOCKED_RAW<span class="token punctuation">)</span></span></span>

<span class="token keyword">int</span> <span class="token class-name">FastPthreadMutex</span><span class="token double-colon punctuation">::</span><span class="token function">lock_contended</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  butil<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">unsigned</span><span class="token operator">></span> <span class="token operator">*</span>whole <span class="token operator">=</span> <span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">unsigned</span><span class="token operator">></span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_futex<span class="token punctuation">;</span>
  <span class="token comment">// 将状态原子修改为加锁 + 等待</span>
  <span class="token comment">// 如果这期间锁被释放了，那么该函数直接退出</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>whole<span class="token operator">-></span><span class="token function">exchange</span><span class="token punctuation">(</span>BTHREAD_MUTEX_CONTENDED<span class="token punctuation">)</span> <span class="token operator">&amp;</span> BTHREAD_MUTEX_LOCKED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 否则调用 futex 尝试挂起当前线程，并且要求状态为加锁 + 等待（因为中间锁可能会被释放）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">futex_wait_private</span><span class="token punctuation">(</span>whole<span class="token punctuation">,</span> BTHREAD_MUTEX_CONTENDED<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
        errno <span class="token operator">!=</span> EWOULDBLOCK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> errno<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// futex_wait_private 非 EWOULDBLOCK 失败的情况下，继续循环重试</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">FastPthreadMutex</span><span class="token double-colon punctuation">::</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  bthread<span class="token double-colon punctuation">::</span>MutexInternal <span class="token operator">*</span>split <span class="token operator">=</span> <span class="token punctuation">(</span>bthread<span class="token double-colon punctuation">::</span>MutexInternal <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_futex<span class="token punctuation">;</span>
  <span class="token comment">// 加锁，如果 locked 原先的值为 0，lock 直接返回成功</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>split<span class="token operator">-></span>locked<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果已经是加锁状态，那么进入锁竞争的处理</span>
    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">lock_contended</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">FastPthreadMutex</span><span class="token double-colon punctuation">::</span><span class="token function">try_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  bthread<span class="token double-colon punctuation">::</span>MutexInternal <span class="token operator">*</span>split <span class="token operator">=</span> <span class="token punctuation">(</span>bthread<span class="token double-colon punctuation">::</span>MutexInternal <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_futex<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">!</span>split<span class="token operator">-></span>locked<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">FastPthreadMutex</span><span class="token double-colon punctuation">::</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  butil<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">unsigned</span><span class="token operator">></span> <span class="token operator">*</span>whole <span class="token operator">=</span> <span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">unsigned</span><span class="token operator">></span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_futex<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">unsigned</span> prev <span class="token operator">=</span> whole<span class="token operator">-></span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// CAUTION: the mutex may be destroyed, check comments before butex_create</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>prev <span class="token operator">!=</span> BTHREAD_MUTEX_LOCKED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果有挂起等待的线程，执行唤醒</span>
    <span class="token function">futex_wake_private</span><span class="token punctuation">(</span>whole<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>写了一个简单的测试样例，这里的 <code>FastPthreadMutex</code> 可以比 <code>std::mutex</code> 快一倍。</p>
<p>对于 bthread，如果直接使用互斥锁，会导致整个工作线程阻塞，进而影响同线程下的其他 bthread。这里更好的解决方案是仅挂起 bthread，主动挂起出让 CPU 让其他 bthread 继续执行。bthread 中使用 butex 提供类 futex 的同步原语，下面来看具体实现：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// butex.h</span>
<span class="token comment">// Create a butex which is a futex-like 32-bit primitive for synchronizing</span>
<span class="token comment">// bthreads/pthreads.</span>
<span class="token comment">// Returns a pointer to 32-bit data, NULL on failure.</span>
<span class="token comment">// NOTE: all butexes are private(not inter-process).</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">butex_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Wake up at most 1 thread waiting on |butex|.</span>
<span class="token comment">// Returns # of threads woken up.</span>
<span class="token keyword">int</span> <span class="token function">butex_wake</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>butex<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Atomically wait on |butex| if *butex equals |expected_value|, until the</span>
<span class="token comment">// butex is woken up by butex_wake*, or CLOCK_REALTIME reached |abstime| if</span>
<span class="token comment">// abstime is not NULL.</span>
<span class="token comment">// About |abstime|:</span>
<span class="token comment">//   Different from FUTEX_WAIT, butex_wait uses absolute time.</span>
<span class="token comment">// Returns 0 on success, -1 otherwise and errno is set.</span>
<span class="token keyword">int</span> <span class="token function">butex_wait</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>butex<span class="token punctuation">,</span> <span class="token keyword">int</span> expected_value<span class="token punctuation">,</span> <span class="token keyword">const</span> timespec <span class="token operator">*</span>abstime<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// butex.cpp</span>
<span class="token keyword">struct</span> <span class="token class-name">ButexWaiter</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> butil<span class="token double-colon punctuation">::</span><span class="token class-name">LinkNode</span><span class="token operator">&lt;</span><span class="token class-name">ButexWaiter</span><span class="token operator">></span></span> <span class="token punctuation">{</span>
  <span class="token comment">// tids of pthreads are 0</span>
  bthread_t tid<span class="token punctuation">;</span>

  <span class="token comment">// Erasing node from middle of LinkedList is thread-unsafe, we need</span>
  <span class="token comment">// to hold its container's lock.</span>
  butil<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>Butex <span class="token operator">*</span><span class="token operator">></span> container<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">ButexBthreadWaiter</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">ButexWaiter</span></span> <span class="token punctuation">{</span>
  TaskMeta <span class="token operator">*</span>task_meta<span class="token punctuation">;</span>
  TimerThread<span class="token double-colon punctuation">::</span>TaskId sleep_id<span class="token punctuation">;</span>
  WaiterState waiter_state<span class="token punctuation">;</span>
  <span class="token keyword">int</span> expected_value<span class="token punctuation">;</span>
  Butex <span class="token operator">*</span>initial_butex<span class="token punctuation">;</span>
  TaskControl <span class="token operator">*</span>control<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 双向链表</span>
<span class="token keyword">typedef</span> butil<span class="token double-colon punctuation">::</span>LinkedList<span class="token operator">&lt;</span>ButexWaiter<span class="token operator">></span> ButexWaiterList<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">BAIDU_CACHELINE_ALIGNMENT</span> Butex <span class="token punctuation">{</span>
  <span class="token function">Butex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token operator">~</span><span class="token function">Butex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  butil<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> value<span class="token punctuation">;</span>
  ButexWaiterList waiters<span class="token punctuation">;</span>
  internal<span class="token double-colon punctuation">::</span>FastPthreadMutex waiter_lock<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 注意 value 的地址与 butex 对象一致，方便后面转换</span>
<span class="token function">BAIDU_CASSERT</span><span class="token punctuation">(</span><span class="token function">offsetof</span><span class="token punctuation">(</span>Butex<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> offsetof_value_must_0<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">butex_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Butex <span class="token operator">*</span>b <span class="token operator">=</span> butil<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get_object</span><span class="token generic class-name"><span class="token operator">&lt;</span>Butex<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>b<span class="token operator">-></span>value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">butex_wait</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token keyword">int</span> expected_value<span class="token punctuation">,</span> <span class="token keyword">const</span> timespec <span class="token operator">*</span>abstime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Butex <span class="token operator">*</span>b <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>butil<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">,</span> Butex<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-></span>value<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span> <span class="token operator">!=</span> expected_value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errno <span class="token operator">=</span> EWOULDBLOCK<span class="token punctuation">;</span>
    <span class="token comment">// Sometimes we may take actions immediately after unmatched butex,</span>
    <span class="token comment">// this fence makes sure that we see changes before changing butex.</span>
    butil<span class="token double-colon punctuation">::</span><span class="token function">atomic_thread_fence</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  TaskGroup <span class="token operator">*</span>g <span class="token operator">=</span> tls_task_group<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> g <span class="token operator">||</span> g<span class="token operator">-></span><span class="token function">is_current_pthread_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">butex_wait_from_pthread</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> b<span class="token punctuation">,</span> expected_value<span class="token punctuation">,</span> abstime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 在栈上创建 waiter 对象</span>
  ButexBthreadWaiter bbw<span class="token punctuation">;</span>
  <span class="token comment">// tid is 0 iff the thread is non-bthread</span>
  bbw<span class="token punctuation">.</span>tid <span class="token operator">=</span> g<span class="token operator">-></span><span class="token function">current_tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bbw<span class="token punctuation">.</span>container<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  bbw<span class="token punctuation">.</span>task_meta <span class="token operator">=</span> g<span class="token operator">-></span><span class="token function">current_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bbw<span class="token punctuation">.</span>sleep_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  bbw<span class="token punctuation">.</span>waiter_state <span class="token operator">=</span> WAITER_STATE_READY<span class="token punctuation">;</span>
  bbw<span class="token punctuation">.</span>expected_value <span class="token operator">=</span> expected_value<span class="token punctuation">;</span>
  bbw<span class="token punctuation">.</span>initial_butex <span class="token operator">=</span> b<span class="token punctuation">;</span>
  bbw<span class="token punctuation">.</span>control <span class="token operator">=</span> g<span class="token operator">-></span><span class="token function">control</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>abstime <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token comment">// 先忽略对时间的处理</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// release fence matches with acquire fence in interrupt_and_consume_waiters</span>
  <span class="token comment">// in task_group.cpp to guarantee visibility of `interrupted'.</span>
  bbw<span class="token punctuation">.</span>task_meta<span class="token operator">-></span>current_waiter<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bbw<span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
  g<span class="token operator">-></span><span class="token function">set_remained</span><span class="token punctuation">(</span>wait_for_butex<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bbw<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 在执行下个 bthread 前执行 wait_for_butex</span>
  <span class="token class-name">TaskGroup</span><span class="token double-colon punctuation">::</span><span class="token function">sched</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 主动 Yield</span>

  <span class="token comment">// erase_from_butex_and_wakeup (called by TimerThread) is possibly still</span>
  <span class="token comment">// running and using bbw. The chance is small, just spin until it's done.</span>
  <span class="token function">BT_LOOP_WHEN</span><span class="token punctuation">(</span><span class="token function">unsleep_if_necessary</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bbw<span class="token punctuation">,</span> <span class="token function">get_global_timer_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span>
               <span class="token number">30</span> <span class="token comment">/*nops before sched_yield*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If current_waiter is NULL, TaskGroup::interrupt() is running and using bbw.</span>
  <span class="token comment">// Spin until current_waiter != NULL.</span>
  <span class="token function">BT_LOOP_WHEN</span><span class="token punctuation">(</span>bbw<span class="token punctuation">.</span>task_meta<span class="token operator">-></span>current_waiter<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>
                   <span class="token constant">NULL</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
               <span class="token number">30</span> <span class="token comment">/*nops before sched_yield*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">bool</span> is_interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>bbw<span class="token punctuation">.</span>task_meta<span class="token operator">-></span>interrupted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Race with set and may consume multiple interruptions, which are OK.</span>
    bbw<span class="token punctuation">.</span>task_meta<span class="token operator">-></span>interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    is_interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// If timed out as well as value unmatched, return ETIMEDOUT.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>WAITER_STATE_TIMEDOUT <span class="token operator">==</span> bbw<span class="token punctuation">.</span>waiter_state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errno <span class="token operator">=</span> ETIMEDOUT<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>WAITER_STATE_UNMATCHEDVALUE <span class="token operator">==</span> bbw<span class="token punctuation">.</span>waiter_state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errno <span class="token operator">=</span> EWOULDBLOCK<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>is_interrupted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errno <span class="token operator">=</span> EINTR<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">wait_for_butex</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ButexBthreadWaiter <span class="token operator">*</span><span class="token keyword">const</span> bw <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>ButexBthreadWaiter <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Butex <span class="token operator">*</span><span class="token keyword">const</span> b <span class="token operator">=</span> bw<span class="token operator">-></span>initial_butex<span class="token punctuation">;</span>
  <span class="token comment">// 1: waiter with timeout should have waiter_state == WAITER_STATE_READY</span>
  <span class="token comment">//    before they're queued, otherwise the waiter is already timedout</span>
  <span class="token comment">//    and removed by TimerThread, in which case we should stop queueing.</span>
  <span class="token comment">//</span>
  <span class="token comment">// Visibility of waiter_state:</span>
  <span class="token comment">//    [bthread]                         [TimerThread]</span>
  <span class="token comment">//    waiter_state = TIMED</span>
  <span class="token comment">//    tt_lock { add task }</span>
  <span class="token comment">//                                      tt_lock { get task }</span>
  <span class="token comment">//                                      waiter_lock { waiter_state=TIMEDOUT }</span>
  <span class="token comment">//    waiter_lock { use waiter_state }</span>
  <span class="token comment">// tt_lock represents TimerThread::_mutex. Visibility of waiter_state is</span>
  <span class="token comment">// sequenced by two locks, both threads are guaranteed to see the correct</span>
  <span class="token comment">// value.</span>
  <span class="token punctuation">{</span>
    <span class="token function">BAIDU_SCOPED_LOCK</span><span class="token punctuation">(</span>b<span class="token operator">-></span>waiter_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 加锁后，校验 value 和 expected_value 是否相等</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-></span>value<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span> <span class="token operator">!=</span> bw<span class="token operator">-></span>expected_value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      bw<span class="token operator">-></span>waiter_state <span class="token operator">=</span> WAITER_STATE_UNMATCHEDVALUE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bw<span class="token operator">-></span>waiter_state <span class="token operator">==</span> WAITER_STATE_READY <span class="token comment">/*1*/</span> <span class="token operator">&amp;&amp;</span>
               <span class="token operator">!</span>bw<span class="token operator">-></span>task_meta<span class="token operator">-></span>interrupted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      b<span class="token operator">-></span>waiters<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>bw<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 加入 waiters 队列</span>
      bw<span class="token operator">-></span>container<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// b->container is NULL which makes erase_from_butex_and_wakeup() and</span>
  <span class="token comment">// TaskGroup::interrupt() no-op, there's no race between following code and</span>
  <span class="token comment">// the two functions. The on-stack ButexBthreadWaiter is safe to use and</span>
  <span class="token comment">// bw->waiter_state will not change again.</span>
  <span class="token comment">// 如果没有成功 wait，则清理定时器，并切回原协程</span>
  <span class="token function">unsleep_if_necessary</span><span class="token punctuation">(</span>bw<span class="token punctuation">,</span> <span class="token function">get_global_timer_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tls_task_group<span class="token operator">-></span><span class="token function">ready_to_run</span><span class="token punctuation">(</span>bw<span class="token operator">-></span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// FIXME: jump back to original thread is buggy.</span>

  <span class="token comment">// // Value unmatched or waiter is already woken up by TimerThread, jump</span>
  <span class="token comment">// // back to original bthread.</span>
  <span class="token comment">// TaskGroup* g = tls_task_group;</span>
  <span class="token comment">// ReadyToRunArgs args = { g->current_tid(), false };</span>
  <span class="token comment">// g->set_remained(TaskGroup::ready_to_run_in_worker, &amp;args);</span>
  <span class="token comment">// // 2: Don't run remained because we're already in a remained function</span>
  <span class="token comment">// //    otherwise stack may overflow.</span>
  <span class="token comment">// TaskGroup::sched_to(&amp;g, bw->tid, false/*2*/);</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">butex_wake</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Butex <span class="token operator">*</span>b <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>butil<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">,</span> Butex<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ButexWaiter <span class="token operator">*</span>front <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">{</span>
    <span class="token function">BAIDU_SCOPED_LOCK</span><span class="token punctuation">(</span>b<span class="token operator">-></span>waiter_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-></span>waiters<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    front <span class="token operator">=</span> b<span class="token operator">-></span>waiters<span class="token punctuation">.</span><span class="token function">head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    front<span class="token operator">-></span><span class="token function">RemoveFromList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 从队列中取出等待的 waiter</span>
    front<span class="token operator">-></span>container<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> butil<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>front<span class="token operator">-></span>tid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">wakeup_pthread</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>ButexPthreadWaiter <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>front<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  ButexBthreadWaiter <span class="token operator">*</span>bbw <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>ButexBthreadWaiter <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>front<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">unsleep_if_necessary</span><span class="token punctuation">(</span>bbw<span class="token punctuation">,</span> <span class="token function">get_global_timer_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  TaskGroup <span class="token operator">*</span>g <span class="token operator">=</span> tls_task_group<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>g<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">TaskGroup</span><span class="token double-colon punctuation">::</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g<span class="token punctuation">,</span> bbw<span class="token operator">-></span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 如果在 bthread 环境中，直接唤醒</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 否认触发重新调度</span>
    bbw<span class="token operator">-></span>control<span class="token operator">-></span><span class="token function">choose_one_group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ready_to_run_remote</span><span class="token punctuation">(</span>bbw<span class="token operator">-></span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="ps：一些题外话" tabindex="-1"><a href="#ps%EF%BC%9A%E4%B8%80%E4%BA%9B%E9%A2%98%E5%A4%96%E8%AF%9D">PS：一些题外话</a></h3>
<p>没错，<a href="/#/Tokio">Tokio 源码分析</a>被“鸽”置了。去年下半年组里项目非常忙，导致周末也不想学习。好在项目赶在年前上线了，年初的答辩也挺顺利，今年就有更多时间自我提升了。开 bRPC 的新坑是因为该项目里有不少先进经验可以应用到自己的工作上，Tokio 会排在 bRPC 之后补上。</p>

      </div>
      <div id="gitalk-container">
      </div>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2017 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/gitalk.min.js"></script>
    <script src="/dist/main.js"></script>
    <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-61723712-2', 'auto'); ga('send', 'pageview'); </script>
  </body>
</html>
