<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/gitalk.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>LevelDB 源码分析「六、Sorted Table 续」 | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> LevelDB 源码分析「六、Sorted Table 续」 </h1>
      </div>
      <div class="info">
        <div class="date"> 2019.08.21 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <p>本系列的<a href="/leveldb/leveldb_05_sorted_table.html">上一篇</a>介绍了 Sorted Table 的构建过程，本篇就继续分析 Sorted Table 的读取、解析过程。</p>
<h3 id="4.-block" tabindex="-1"><a href="#4.-block">4. Block</a></h3>
<p>根据依赖关系，首先来看 <a href="https://github.com/google/leveldb/blob/master/table/format.cc"><code>table/format.cc</code></a> 中 <code>ReadBlock</code> 函数的实现：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">BlockContents</span> <span class="token punctuation">{</span>
  Slice data<span class="token punctuation">;</span>           <span class="token comment">// Actual contents of data</span>
  <span class="token keyword">bool</span> cachable<span class="token punctuation">;</span>        <span class="token comment">// True iff data can be cached</span>
  <span class="token keyword">bool</span> heap_allocated<span class="token punctuation">;</span>  <span class="token comment">// True iff caller should delete[] data.data()</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Read the block identified by "handle" from "file".  On failure</span>
<span class="token comment">// return non-OK.  On success fill *result and return OK.</span>
Status <span class="token function">ReadBlock</span><span class="token punctuation">(</span>RandomAccessFile<span class="token operator">*</span> file<span class="token punctuation">,</span> <span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span> options<span class="token punctuation">,</span>
                 <span class="token keyword">const</span> BlockHandle<span class="token operator">&amp;</span> handle<span class="token punctuation">,</span> BlockContents<span class="token operator">*</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  result<span class="token operator">-></span>data <span class="token operator">=</span> <span class="token function">Slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  result<span class="token operator">-></span>cachable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  result<span class="token operator">-></span>heap_allocated <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token comment">// Read the block contents as well as the type/crc footer.</span>
  <span class="token comment">// See table_builder.cc for the code that built this structure.</span>
  size_t n <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>size_t<span class="token operator">></span><span class="token punctuation">(</span>handle<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">char</span><span class="token operator">*</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span>n <span class="token operator">+</span> kBlockTrailerSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
  Slice contents<span class="token punctuation">;</span>
  Status s <span class="token operator">=</span> file<span class="token operator">-></span><span class="token function">Read</span><span class="token punctuation">(</span>handle<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> n <span class="token operator">+</span> kBlockTrailerSize<span class="token punctuation">,</span> <span class="token operator">&amp;</span>contents<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf<span class="token punctuation">;</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>contents<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> n <span class="token operator">+</span> kBlockTrailerSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token operator">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"truncated block read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Check the crc of the type and the block contents</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> data <span class="token operator">=</span> contents<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Pointer to where Read put the data</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>verify_checksums<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">uint32_t</span> crc <span class="token operator">=</span> crc32c<span class="token operator">::</span><span class="token function">Unmask</span><span class="token punctuation">(</span><span class="token function">DecodeFixed32</span><span class="token punctuation">(</span>data <span class="token operator">+</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">uint32_t</span> actual <span class="token operator">=</span> crc32c<span class="token operator">::</span><span class="token function">Value</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>actual <span class="token operator">!=</span> crc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf<span class="token punctuation">;</span>
      s <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token operator">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"block checksum mismatch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> kNoCompression<span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!=</span> buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// File implementation gave us pointer to some other data.</span>
        <span class="token comment">// Use it directly under the assumption that it will be live</span>
        <span class="token comment">// while the file is open.</span>
        <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf<span class="token punctuation">;</span>
        result<span class="token operator">-></span>data <span class="token operator">=</span> <span class="token function">Slice</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token operator">-></span>heap_allocated <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        result<span class="token operator">-></span>cachable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// Do not double-cache</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        result<span class="token operator">-></span>data <span class="token operator">=</span> <span class="token function">Slice</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token operator">-></span>heap_allocated <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        result<span class="token operator">-></span>cachable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Ok</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> kSnappyCompression<span class="token operator">:</span> <span class="token punctuation">{</span>
      size_t ulength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>port<span class="token operator">::</span><span class="token function">Snappy_GetUncompressedLength</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ulength<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token operator">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"corrupted compressed block contents"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">char</span><span class="token operator">*</span> ubuf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span>ulength<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>port<span class="token operator">::</span><span class="token function">Snappy_Uncompress</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> n<span class="token punctuation">,</span> ubuf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf<span class="token punctuation">;</span>
        <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ubuf<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token operator">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"corrupted compressed block contents"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf<span class="token punctuation">;</span>
      result<span class="token operator">-></span>data <span class="token operator">=</span> <span class="token function">Slice</span><span class="token punctuation">(</span>ubuf<span class="token punctuation">,</span> ulength<span class="token punctuation">)</span><span class="token punctuation">;</span>
      result<span class="token operator">-></span>heap_allocated <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      result<span class="token operator">-></span>cachable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token operator">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"bad block type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token operator">::</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>对于已经存储的 Sorted Table 文件，提供 <code>ReadOptions</code> 和 <code>BlockHandle</code> 后，可以将 <code>handle</code> 对应的 Block 内容读取到 <code>BlockContents</code> 中。该结构体储存 Block 的字节流，以及能否缓存、是否需要手动清理的标记。<code>ReadBlock</code> 的实现非常直接，读取文件对应位置的字节流，进行必要的校验和解压缩。继续看 <code>Block</code> 的解析部分 <a href="https://github.com/google/leveldb/blob/master/table/block.h"><code>table/block.h</code></a> ：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">BlockContents</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Comparator</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Block</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token comment">// Initialize the block with the specified contents.</span>
  <span class="token keyword">explicit</span> <span class="token function">Block</span><span class="token punctuation">(</span><span class="token keyword">const</span> BlockContents<span class="token operator">&amp;</span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">Block</span><span class="token punctuation">(</span><span class="token keyword">const</span> Block<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
  Block<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Block<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

  <span class="token operator">~</span><span class="token function">Block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  size_t <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> size_<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  Iterator<span class="token operator">*</span> <span class="token function">NewIterator</span><span class="token punctuation">(</span><span class="token keyword">const</span> Comparator<span class="token operator">*</span> comparator<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">class</span> <span class="token class-name">Iter</span><span class="token punctuation">;</span>

  <span class="token keyword">uint32_t</span> <span class="token function">NumRestarts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> data_<span class="token punctuation">;</span>
  size_t size_<span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> restart_offset_<span class="token punctuation">;</span>  <span class="token comment">// Offset in data_ of restart array</span>
  <span class="token keyword">bool</span> owned_<span class="token punctuation">;</span>               <span class="token comment">// Block owns data_[]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>接口的核心部分自然是迭代器。迭代器提供 Block 中键值对数据的遍历和查找。继续看对应函数的实现：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">inline</span> <span class="token keyword">uint32_t</span> <span class="token class-name">Block</span><span class="token operator">::</span><span class="token function">NumRestarts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>size_ <span class="token operator">>=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">DecodeFixed32</span><span class="token punctuation">(</span>data_ <span class="token operator">+</span> size_ <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">Block</span><span class="token operator">::</span><span class="token function">Block</span><span class="token punctuation">(</span><span class="token keyword">const</span> BlockContents<span class="token operator">&amp;</span> contents<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">data_</span><span class="token punctuation">(</span>contents<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">size_</span><span class="token punctuation">(</span>contents<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">owned_</span><span class="token punctuation">(</span>contents<span class="token punctuation">.</span>heap_allocated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>size_ <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    size_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// Error marker</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    size_t max_restarts_allowed <span class="token operator">=</span> <span class="token punctuation">(</span>size_ <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">NumRestarts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> max_restarts_allowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// The size is too small for NumRestarts()</span>
      size_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      restart_offset_ <span class="token operator">=</span> size_ <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token function">NumRestarts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">Block</span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">Block</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>owned_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data_<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Helper routine: decode the next block entry starting at "p",</span>
<span class="token comment">// storing the number of shared key bytes, non_shared key bytes,</span>
<span class="token comment">// and the length of the value in "*shared", "*non_shared", and</span>
<span class="token comment">// "*value_length", respectively.  Will not dereference past "limit".</span>
<span class="token comment">//</span>
<span class="token comment">// If any errors are detected, returns nullptr.  Otherwise, returns a</span>
<span class="token comment">// pointer to the key delta (just past the three decoded values).</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">DecodeEntry</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> p<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> limit<span class="token punctuation">,</span>
                                      <span class="token keyword">uint32_t</span><span class="token operator">*</span> shared<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span><span class="token operator">*</span> non_shared<span class="token punctuation">,</span>
                                      <span class="token keyword">uint32_t</span><span class="token operator">*</span> value_length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>limit <span class="token operator">-</span> p <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token operator">*</span>shared <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">uint8_t</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token operator">*</span>non_shared <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">uint8_t</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token operator">*</span>value_length <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">uint8_t</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>shared <span class="token operator">|</span> <span class="token operator">*</span>non_shared <span class="token operator">|</span> <span class="token operator">*</span>value_length<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Fast path: all three values are encoded in one byte each</span>
    p <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token function">GetVarint32Ptr</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> shared<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token function">GetVarint32Ptr</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> non_shared<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token function">GetVarint32Ptr</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> value_length<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token operator">></span><span class="token punctuation">(</span>limit <span class="token operator">-</span> p<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token operator">*</span>non_shared <span class="token operator">+</span> <span class="token operator">*</span>value_length<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>按照之前描述的 Block 存储结构，最后 4 字节存储复活点的数量，如 <code>NumRestarts</code> 实现。构造时进行必要的判断，在 <code>restart_offset_</code> 中存储复活点列表的位置。解析条目时，首先假设 <code>shared</code>、<code>non_shared</code> 和 <code>value_length</code> 都小于 128，尝试按照按字节读取长度以提高解析速度。在大部分情况下该规则都是满足的，当少数情况出现超长的串时，会回退到普通的 <code>GetVarint32Ptr</code>。继续看迭代器的实现：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Block</span><span class="token operator">:</span><span class="token base-clause"><span class="token operator">:</span><span class="token class-name">Iter</span> <span class="token operator">:</span> <span class="token keyword">public</span> <span class="token class-name">Iterator</span></span> <span class="token punctuation">{</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">const</span> Comparator<span class="token operator">*</span> <span class="token keyword">const</span> comparator_<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token keyword">const</span> data_<span class="token punctuation">;</span>       <span class="token comment">// underlying block contents</span>
  <span class="token keyword">uint32_t</span> <span class="token keyword">const</span> restarts_<span class="token punctuation">;</span>      <span class="token comment">// Offset of restart array (list of fixed32)</span>
  <span class="token keyword">uint32_t</span> <span class="token keyword">const</span> num_restarts_<span class="token punctuation">;</span>  <span class="token comment">// Number of uint32_t entries in restart array</span>

  <span class="token comment">// current_ is offset in data_ of current entry.  >= restarts_ if !Valid</span>
  <span class="token keyword">uint32_t</span> current_<span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> restart_index_<span class="token punctuation">;</span>  <span class="token comment">// Index of restart block in which current_ falls</span>
  std<span class="token operator">::</span>string key_<span class="token punctuation">;</span>
  Slice value_<span class="token punctuation">;</span>
  Status status_<span class="token punctuation">;</span>

  <span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">Compare</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> a<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> b<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> comparator_<span class="token operator">-></span><span class="token function">Compare</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Return the offset in data_ just past the end of the current entry.</span>
  <span class="token keyword">inline</span> <span class="token keyword">uint32_t</span> <span class="token function">NextEntryOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>value_<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> value_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> data_<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">uint32_t</span> <span class="token function">GetRestartPoint</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>index <span class="token operator">&lt;</span> num_restarts_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">DecodeFixed32</span><span class="token punctuation">(</span>data_ <span class="token operator">+</span> restarts_ <span class="token operator">+</span> index <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">SeekToRestartPoint</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    key_<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    restart_index_ <span class="token operator">=</span> index<span class="token punctuation">;</span>
    <span class="token comment">// current_ will be fixed by ParseNextKey();</span>

    <span class="token comment">// ParseNextKey() starts at the end of value_, so set value_ accordingly</span>
    <span class="token keyword">uint32_t</span> offset <span class="token operator">=</span> <span class="token function">GetRestartPoint</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    value_ <span class="token operator">=</span> <span class="token function">Slice</span><span class="token punctuation">(</span>data_ <span class="token operator">+</span> offset<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">Iter</span><span class="token punctuation">(</span><span class="token keyword">const</span> Comparator<span class="token operator">*</span> comparator<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> data<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> restarts<span class="token punctuation">,</span>
       <span class="token keyword">uint32_t</span> num_restarts<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">comparator_</span><span class="token punctuation">(</span>comparator<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">data_</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">restarts_</span><span class="token punctuation">(</span>restarts<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">num_restarts_</span><span class="token punctuation">(</span>num_restarts<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">current_</span><span class="token punctuation">(</span>restarts_<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">restart_index_</span><span class="token punctuation">(</span>num_restarts_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>num_restarts_ <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">bool</span> <span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> override <span class="token punctuation">{</span> <span class="token keyword">return</span> current_ <span class="token operator">&lt;</span> restarts_<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  Status <span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> override <span class="token punctuation">{</span> <span class="token keyword">return</span> status_<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  Slice <span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> override <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> key_<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  Slice <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> override <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> value_<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ParseNextKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">Prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Scan backwards to a restart point before current_</span>
    <span class="token keyword">const</span> <span class="token keyword">uint32_t</span> original <span class="token operator">=</span> current_<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">GetRestartPoint</span><span class="token punctuation">(</span>restart_index_<span class="token punctuation">)</span> <span class="token operator">>=</span> original<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>restart_index_ <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// No more entries</span>
        current_ <span class="token operator">=</span> restarts_<span class="token punctuation">;</span>
        restart_index_ <span class="token operator">=</span> num_restarts_<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      restart_index_<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">SeekToRestartPoint</span><span class="token punctuation">(</span>restart_index_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token comment">// Loop until end of current entry hits the start of original entry</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">ParseNextKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">NextEntryOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> original<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">SeekToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override <span class="token punctuation">{</span>
    <span class="token function">SeekToRestartPoint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ParseNextKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">SeekToLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override <span class="token punctuation">{</span>
    <span class="token function">SeekToRestartPoint</span><span class="token punctuation">(</span>num_restarts_ <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">ParseNextKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">NextEntryOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> restarts_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Keep skipping</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">CorruptionError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    current_ <span class="token operator">=</span> restarts_<span class="token punctuation">;</span>
    restart_index_ <span class="token operator">=</span> num_restarts_<span class="token punctuation">;</span>
    status_ <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token operator">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"bad entry in block"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    key_<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    value_<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">bool</span> <span class="token function">ParseNextKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    current_ <span class="token operator">=</span> <span class="token function">NextEntryOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> p <span class="token operator">=</span> data_ <span class="token operator">+</span> current_<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> limit <span class="token operator">=</span> data_ <span class="token operator">+</span> restarts_<span class="token punctuation">;</span>  <span class="token comment">// Restarts come right after data</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">>=</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// No more entries to return.  Mark as invalid.</span>
      current_ <span class="token operator">=</span> restarts_<span class="token punctuation">;</span>
      restart_index_ <span class="token operator">=</span> num_restarts_<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Decode next entry</span>
    <span class="token keyword">uint32_t</span> shared<span class="token punctuation">,</span> non_shared<span class="token punctuation">,</span> value_length<span class="token punctuation">;</span>
    p <span class="token operator">=</span> <span class="token function">DecodeEntry</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> <span class="token operator">&amp;</span>shared<span class="token punctuation">,</span> <span class="token operator">&amp;</span>non_shared<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value_length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">nullptr</span> <span class="token operator">||</span> key_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> shared<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CorruptionError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      key_<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>shared<span class="token punctuation">)</span><span class="token punctuation">;</span>
      key_<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> non_shared<span class="token punctuation">)</span><span class="token punctuation">;</span>
      value_ <span class="token operator">=</span> <span class="token function">Slice</span><span class="token punctuation">(</span>p <span class="token operator">+</span> non_shared<span class="token punctuation">,</span> value_length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>restart_index_ <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> num_restarts_ <span class="token operator">&amp;&amp;</span>
             <span class="token function">GetRestartPoint</span><span class="token punctuation">(</span>restart_index_ <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> current_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">++</span>restart_index_<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Iterator<span class="token operator">*</span> <span class="token class-name">Block</span><span class="token operator">::</span><span class="token function">NewIterator</span><span class="token punctuation">(</span><span class="token keyword">const</span> Comparator<span class="token operator">*</span> comparator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>size_ <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">NewErrorIterator</span><span class="token punctuation">(</span><span class="token class-name">Status</span><span class="token operator">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"bad block contents"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token keyword">uint32_t</span> num_restarts <span class="token operator">=</span> <span class="token function">NumRestarts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>num_restarts <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">NewEmptyIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token function">Iter</span><span class="token punctuation">(</span>comparator<span class="token punctuation">,</span> data_<span class="token punctuation">,</span> restart_offset_<span class="token punctuation">,</span> num_restarts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>先看成员变量：</p>
<ol>
<li>Block 的字节流存储于 <code>data_</code> 中；</li>
<li><code>restarts_</code> 和 <code>num_restarts_</code>  存储复活点列表的偏移和数量；</li>
<li><code>current_</code> 存储当前迭代器的偏移，<code>restart_index_</code> 存储 <code>current_</code> 前面最近的复活点偏移；</li>
<li><code>key_</code> 和 <code>value_</code> 存储键值对。注意 <code>key_</code> 是 <code>std::string</code>，因为有共享前缀，需要存储中间恢复的 <code>Key</code>，而 <code>value_</code> 可以直接从 <code>data_</code> 中截取。</li>
</ol>
<p>函数 <code>NextEntryOffset</code> 根据当前的 <code>value</code> 的位置和大小计算下一个键值对的起始位置，因为每个条目最后存储的是 <code>value</code>。函数 <code>GetRestartPoint</code> 读取第 <code>index</code> 个复活点的位置，函数 <code>SeekToRestartPoint</code> 将当前的 <code>key_</code> 清空、设定 <code>restart_index_</code> 并将 <code>value_</code> 设为复活点前的空串，以便于执行 <code>NextEntryOffset</code> 时获得对应复活点偏移。跳到函数 <code>ParseNextKey</code>，将 <code>current_</code> 设为下一个键值对的起点，通过 <code>DecodeEntry</code> 解析得到需要的长度信息，恢复 <code>key_</code> 并读取 <code>value_</code>。</p>
<p>迭代器存储的状态信息包括 <code>key_</code> 存储的共享前缀，和 <code>value_</code> 存储的下个条目起点。当发生起始点的切换时，需要先执行函数 <code>SeekToRestartPoint</code> 清空当前存储的状态信息，再执行函数 <code>ParseNextKey</code> 解析下一个键值对。按照这个过程读函数 <code>Prev</code>、<code>SeekToFirst</code> 和 <code>SeekToLast</code> 就非常轻松了。最后来看函数 <code>Seek</code>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">Seek</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> target<span class="token punctuation">)</span> override <span class="token punctuation">{</span>
  <span class="token comment">// Binary search in restart array to find the last restart point</span>
  <span class="token comment">// with a key &lt; target</span>
  <span class="token keyword">uint32_t</span> left <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> right <span class="token operator">=</span> num_restarts_ <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>left <span class="token operator">&lt;</span> right<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">uint32_t</span> mid <span class="token operator">=</span> <span class="token punctuation">(</span>left <span class="token operator">+</span> right <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">uint32_t</span> region_offset <span class="token operator">=</span> <span class="token function">GetRestartPoint</span><span class="token punctuation">(</span>mid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">uint32_t</span> shared<span class="token punctuation">,</span> non_shared<span class="token punctuation">,</span> value_length<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> key_ptr <span class="token operator">=</span>
      <span class="token function">DecodeEntry</span><span class="token punctuation">(</span>data_ <span class="token operator">+</span> region_offset<span class="token punctuation">,</span> data_ <span class="token operator">+</span> restarts_<span class="token punctuation">,</span> <span class="token operator">&amp;</span>shared<span class="token punctuation">,</span>
                  <span class="token operator">&amp;</span>non_shared<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value_length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key_ptr <span class="token operator">==</span> <span class="token keyword">nullptr</span> <span class="token operator">||</span> <span class="token punctuation">(</span>shared <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CorruptionError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Slice <span class="token function">mid_key</span><span class="token punctuation">(</span>key_ptr<span class="token punctuation">,</span> non_shared<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Compare</span><span class="token punctuation">(</span>mid_key<span class="token punctuation">,</span> target<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Key at "mid" is smaller than "target".  Therefore all</span>
      <span class="token comment">// blocks before "mid" are uninteresting.</span>
      left <span class="token operator">=</span> mid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Key at "mid" is >= "target".  Therefore all blocks at or</span>
      <span class="token comment">// after "mid" are uninteresting.</span>
      right <span class="token operator">=</span> mid <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Linear search (within restart block) for first key >= target</span>
  <span class="token function">SeekToRestartPoint</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ParseNextKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Compare</span><span class="token punctuation">(</span>key_<span class="token punctuation">,</span> target<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>首先在复活点上做二分查找，这里实现的二分查找的结果就是 <code>left</code> 对应的复活点 <code>Key</code> 是严格小于 <code>target</code> 的最大 <code>Key</code>。二分查找完成后跳到复活点处，按顺序恢复每个条目的键值，对比返回。</p>
<p>最后来看一个细节：<code>restart_index_</code> 只会在函数 <code>Prev</code> 里读取到，以确定上一个复活点的位置。如果仔细观察函数 <code>ParseNextKey</code> 中关于 <code>restart_index_</code> 的更新：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">while</span> <span class="token punctuation">(</span>restart_index_ <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> num_restarts_ <span class="token operator">&amp;&amp;</span>
       <span class="token function">GetRestartPoint</span><span class="token punctuation">(</span>restart_index_ <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> current_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">++</span>restart_index_<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>如果这里 <code>current_</code> 刚好到达复活点 <code>i</code>，<code>restart_index_</code> 仍然会保持在 <code>i - 1</code> 的，这样在执行 <code>Prev</code> 时 <code>while</code> 循环可以少做一次。Google 大佬实力可见一斑。但从语义的角度，这种做法比较容易让人困惑，我应该不会这么做（所以成不了 Google 大佬。</p>
<h3 id="5.-迭代器链" tabindex="-1"><a href="#5.-%E8%BF%AD%E4%BB%A3%E5%99%A8%E9%93%BE">5. 迭代器链</a></h3>
<p>上一节中分析了 Block 的迭代器实现，而对一个 Sorted Table 来说，还需要其他几种迭代器共同组成迭代器链，以高效地完成对 Sorted Table 的遍历和查找。首先来看 <code>IteratorWrapper</code> 的实现  <a href="https://github.com/google/leveldb/blob/master/table/iterator_wrapper.h"><code>table/iterator_wrapper</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// A internal wrapper class with an interface similar to Iterator that</span>
<span class="token comment">// caches the valid() and key() results for an underlying iterator.</span>
<span class="token comment">// This can help avoid virtual function calls and also gives better</span>
<span class="token comment">// cache locality.</span>
<span class="token keyword">class</span> <span class="token class-name">IteratorWrapper</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">IteratorWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">iter_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">valid_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">explicit</span> <span class="token function">IteratorWrapper</span><span class="token punctuation">(</span>Iterator<span class="token operator">*</span> iter<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">iter_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">Set</span><span class="token punctuation">(</span>iter<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token operator">~</span><span class="token function">IteratorWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">delete</span> iter_<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  Iterator<span class="token operator">*</span> <span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> iter_<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token comment">// Takes ownership of "iter" and will delete it when destroyed, or</span>
  <span class="token comment">// when Set() is invoked again.</span>
  <span class="token keyword">void</span> <span class="token function">Set</span><span class="token punctuation">(</span>Iterator<span class="token operator">*</span> iter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> iter_<span class="token punctuation">;</span>
    iter_ <span class="token operator">=</span> iter<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iter_ <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      valid_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Iterator interface methods</span>
  <span class="token keyword">bool</span> <span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> valid_<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  Slice <span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> key_<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  Slice <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> iter_<span class="token operator">-></span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Methods below require iter() != nullptr</span>
  Status <span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>iter_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> iter_<span class="token operator">-></span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>iter_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    iter_<span class="token operator">-></span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">Prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>iter_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    iter_<span class="token operator">-></span><span class="token function">Prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">Seek</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>iter_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    iter_<span class="token operator">-></span><span class="token function">Seek</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">SeekToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>iter_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    iter_<span class="token operator">-></span><span class="token function">SeekToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">SeekToLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>iter_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    iter_<span class="token operator">-></span><span class="token function">SeekToLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    valid_ <span class="token operator">=</span> iter_<span class="token operator">-></span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>valid_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      key_ <span class="token operator">=</span> iter_<span class="token operator">-></span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  Iterator<span class="token operator">*</span> iter_<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> valid_<span class="token punctuation">;</span>
  Slice key_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>迭代器的简单包装，缓存了 <code>key_</code> 和 <code>valid_</code> 属性。按照注释所说的，可以减少虚函数的调用，并且提供更好的缓存局部性。前者很好理解，后者仍然有些困惑。接着来看二级迭代器 <code>TwoLevelIterator</code> 的实现  <a href="https://github.com/google/leveldb/blob/master/table/two_level_iterator.cc"><code>table/two_level_iterator.cc</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"leveldb/table.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"table/block.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"table/format.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"table/iterator_wrapper.h"</span></span>

<span class="token keyword">namespace</span> leveldb <span class="token punctuation">{</span>

<span class="token keyword">namespace</span> <span class="token punctuation">{</span>

<span class="token keyword">typedef</span> Iterator<span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>BlockFunction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span><span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">TwoLevelIterator</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Iterator</span></span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">TwoLevelIterator</span><span class="token punctuation">(</span>Iterator<span class="token operator">*</span> index_iter<span class="token punctuation">,</span> BlockFunction block_function<span class="token punctuation">,</span>
                   <span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">,</span> <span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token operator">~</span><span class="token function">TwoLevelIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override<span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">Seek</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> target<span class="token punctuation">)</span> override<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">SeekToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">SeekToLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">Prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override<span class="token punctuation">;</span>

  <span class="token keyword">bool</span> <span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> override <span class="token punctuation">{</span> <span class="token keyword">return</span> data_iter_<span class="token punctuation">.</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  Slice <span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> override <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> data_iter_<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  Slice <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> override <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> data_iter_<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  Status <span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> override <span class="token punctuation">{</span>
    <span class="token comment">// It'd be nice if status() returned a const Status&amp; instead of a Status</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>index_iter_<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> index_iter_<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data_iter_<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>data_iter_<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> data_iter_<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> status_<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">SaveError</span><span class="token punctuation">(</span><span class="token keyword">const</span> Status<span class="token operator">&amp;</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status_<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> status_ <span class="token operator">=</span> s<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">SkipEmptyDataBlocksForward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">SkipEmptyDataBlocksBackward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">SetDataIterator</span><span class="token punctuation">(</span>Iterator<span class="token operator">*</span> data_iter<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">InitDataBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  BlockFunction block_function_<span class="token punctuation">;</span>
  <span class="token keyword">void</span><span class="token operator">*</span> arg_<span class="token punctuation">;</span>
  <span class="token keyword">const</span> ReadOptions options_<span class="token punctuation">;</span>
  Status status_<span class="token punctuation">;</span>
  IteratorWrapper index_iter_<span class="token punctuation">;</span>
  IteratorWrapper data_iter_<span class="token punctuation">;</span>  <span class="token comment">// May be nullptr</span>
  <span class="token comment">// If data_iter_ is non-null, then "data_block_handle_" holds the</span>
  <span class="token comment">// "index_value" passed to block_function_ to create the data_iter_.</span>
  std<span class="token operator">::</span>string data_block_handle_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">TwoLevelIterator</span><span class="token operator">::</span><span class="token function">TwoLevelIterator</span><span class="token punctuation">(</span>Iterator<span class="token operator">*</span> index_iter<span class="token punctuation">,</span>
                                   BlockFunction block_function<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">,</span>
                                   <span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span> options<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">block_function_</span><span class="token punctuation">(</span>block_function<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">arg_</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">options_</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">index_iter_</span><span class="token punctuation">(</span>index_iter<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">data_iter_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token class-name">TwoLevelIterator</span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">TwoLevelIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token class-name">TwoLevelIterator</span><span class="token operator">::</span><span class="token function">Seek</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  index_iter_<span class="token punctuation">.</span><span class="token function">Seek</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">InitDataBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>data_iter_<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> data_iter_<span class="token punctuation">.</span><span class="token function">Seek</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">SkipEmptyDataBlocksForward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">TwoLevelIterator</span><span class="token operator">::</span><span class="token function">SeekToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  index_iter_<span class="token punctuation">.</span><span class="token function">SeekToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">InitDataBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>data_iter_<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> data_iter_<span class="token punctuation">.</span><span class="token function">SeekToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">SkipEmptyDataBlocksForward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">TwoLevelIterator</span><span class="token operator">::</span><span class="token function">SeekToLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  index_iter_<span class="token punctuation">.</span><span class="token function">SeekToLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">InitDataBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>data_iter_<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> data_iter_<span class="token punctuation">.</span><span class="token function">SeekToLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">SkipEmptyDataBlocksBackward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">TwoLevelIterator</span><span class="token operator">::</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  data_iter_<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">SkipEmptyDataBlocksForward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">TwoLevelIterator</span><span class="token operator">::</span><span class="token function">Prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  data_iter_<span class="token punctuation">.</span><span class="token function">Prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">SkipEmptyDataBlocksBackward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">TwoLevelIterator</span><span class="token operator">::</span><span class="token function">SkipEmptyDataBlocksForward</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>data_iter_<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">nullptr</span> <span class="token operator">||</span> <span class="token operator">!</span>data_iter_<span class="token punctuation">.</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Move to next block</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>index_iter_<span class="token punctuation">.</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">SetDataIterator</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    index_iter_<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">InitDataBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data_iter_<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> data_iter_<span class="token punctuation">.</span><span class="token function">SeekToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">TwoLevelIterator</span><span class="token operator">::</span><span class="token function">SkipEmptyDataBlocksBackward</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>data_iter_<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">nullptr</span> <span class="token operator">||</span> <span class="token operator">!</span>data_iter_<span class="token punctuation">.</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Move to next block</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>index_iter_<span class="token punctuation">.</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">SetDataIterator</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    index_iter_<span class="token punctuation">.</span><span class="token function">Prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">InitDataBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data_iter_<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> data_iter_<span class="token punctuation">.</span><span class="token function">SeekToLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">TwoLevelIterator</span><span class="token operator">::</span><span class="token function">SetDataIterator</span><span class="token punctuation">(</span>Iterator<span class="token operator">*</span> data_iter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>data_iter_<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token function">SaveError</span><span class="token punctuation">(</span>data_iter_<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  data_iter_<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">TwoLevelIterator</span><span class="token operator">::</span><span class="token function">InitDataBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>index_iter_<span class="token punctuation">.</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SetDataIterator</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    Slice handle <span class="token operator">=</span> index_iter_<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data_iter_<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span>
        handle<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>data_block_handle_<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// data_iter_ is already constructed with this iterator, so</span>
      <span class="token comment">// no need to change anything</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      Iterator<span class="token operator">*</span> iter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>block_function_<span class="token punctuation">)</span><span class="token punctuation">(</span>arg_<span class="token punctuation">,</span> options_<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      data_block_handle_<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>handle<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handle<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">SetDataIterator</span><span class="token punctuation">(</span>iter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace</span>

Iterator<span class="token operator">*</span> <span class="token function">NewTwoLevelIterator</span><span class="token punctuation">(</span>Iterator<span class="token operator">*</span> index_iter<span class="token punctuation">,</span>
                              BlockFunction block_function<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">,</span>
                              <span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token function">TwoLevelIterator</span><span class="token punctuation">(</span>index_iter<span class="token punctuation">,</span> block_function<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Sorted Table 中存储了多个 Data Block，使用 Index Block 完成对 Data Block 的索引。二级迭代器的第一级 <code>index_iter_</code> 完成对 Index Block 的迭代，第二级 <code>data_iter_</code> 完成对 Data Block 的迭代。遍历时移动 <code>data_iter_</code>，并在 <code>data_iter_</code> 边界的地方使用函数 <code>SkipEmptyDataBlocksForward</code> 和 <code>SkipEmptyDataBlocksBackward</code> 实现 Data Block 的前后切换。查找时同样先在 <code>index_iter_</code> 上查找，Index Block 的每个条目存储了 Data Block 的 <code>max_key</code> 和位置大小信息，可以二分；确定 <code>index_iter_</code> 的位置后再读取对应的 Data Block 进一步二分查找。</p>
<p>总结来看 Sorted Table 使用的迭代器们组成的链路如下：</p>
<pre class="language-cpp"><code class="language-cpp">TwoLevelIterator <span class="token operator">-></span> <span class="token function">IteratorWrapper</span><span class="token punctuation">(</span>index_iter_<span class="token punctuation">)</span> <span class="token operator">-></span> Block<span class="token operator">::</span>Iter
                 <span class="token operator">-></span> <span class="token function">IteratorWrapper</span><span class="token punctuation">(</span>data_iter_<span class="token punctuation">)</span> <span class="token operator">-></span> Block<span class="token operator">::</span>Iter
</code></pre>
<p>另外还有一个合并迭代器  <a href="https://github.com/google/leveldb/blob/master/table/merger.cc"><code>MergingIterator</code></a>，将会在多 Sorted Table 文件的遍历中使用到。该迭代器管理 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span></eq> 个子迭代器，<code>Next</code> 和 <code>Seek</code> 操作时齐头并进、选择最小的那个，具体实现如下：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">MergingIterator</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Iterator</span></span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">MergingIterator</span><span class="token punctuation">(</span><span class="token keyword">const</span> Comparator<span class="token operator">*</span> comparator<span class="token punctuation">,</span> Iterator<span class="token operator">*</span><span class="token operator">*</span> children<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">comparator_</span><span class="token punctuation">(</span>comparator<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">children_</span><span class="token punctuation">(</span><span class="token keyword">new</span> IteratorWrapper<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">n_</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">current_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">direction_</span><span class="token punctuation">(</span>kForward<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      children_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token operator">~</span><span class="token function">MergingIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override <span class="token punctuation">{</span> <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> children_<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">bool</span> <span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> override <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">(</span>current_ <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">SeekToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n_<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      children_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">SeekToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">FindSmallest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    direction_ <span class="token operator">=</span> kForward<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">SeekToLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n_<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      children_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">SeekToLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">FindLargest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    direction_ <span class="token operator">=</span> kReverse<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">Seek</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> target<span class="token punctuation">)</span> override <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n_<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      children_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Seek</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">FindSmallest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    direction_ <span class="token operator">=</span> kForward<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Ensure that all children are positioned after key().</span>
    <span class="token comment">// If we are moving in the forward direction, it is already</span>
    <span class="token comment">// true for all of the non-current_ children since current_ is</span>
    <span class="token comment">// the smallest child and key() == current_->key().  Otherwise,</span>
    <span class="token comment">// we explicitly position the non-current_ children.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>direction_ <span class="token operator">!=</span> kForward<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n_<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        IteratorWrapper<span class="token operator">*</span> child <span class="token operator">=</span> <span class="token operator">&amp;</span>children_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">!=</span> current_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          child<span class="token operator">-></span><span class="token function">Seek</span><span class="token punctuation">(</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token operator">-></span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
              comparator_<span class="token operator">-></span><span class="token function">Compare</span><span class="token punctuation">(</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> child<span class="token operator">-></span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            child<span class="token operator">-></span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      direction_ <span class="token operator">=</span> kForward<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    current_<span class="token operator">-></span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FindSmallest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">Prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Ensure that all children are positioned before key().</span>
    <span class="token comment">// If we are moving in the reverse direction, it is already</span>
    <span class="token comment">// true for all of the non-current_ children since current_ is</span>
    <span class="token comment">// the largest child and key() == current_->key().  Otherwise,</span>
    <span class="token comment">// we explicitly position the non-current_ children.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>direction_ <span class="token operator">!=</span> kReverse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n_<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        IteratorWrapper<span class="token operator">*</span> child <span class="token operator">=</span> <span class="token operator">&amp;</span>children_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">!=</span> current_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          child<span class="token operator">-></span><span class="token function">Seek</span><span class="token punctuation">(</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token operator">-></span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Child is at first entry >= key().  Step back one to be &lt; key()</span>
            child<span class="token operator">-></span><span class="token function">Prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Child has no entries >= key().  Position at last entry.</span>
            child<span class="token operator">-></span><span class="token function">SeekToLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      direction_ <span class="token operator">=</span> kReverse<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    current_<span class="token operator">-></span><span class="token function">Prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FindLargest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  Slice <span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> override <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> current_<span class="token operator">-></span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  Slice <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> override <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> current_<span class="token operator">-></span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  Status <span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> override <span class="token punctuation">{</span>
    Status status<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n_<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      status <span class="token operator">=</span> children_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> status<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token comment">// Which direction is the iterator moving?</span>
  <span class="token keyword">enum</span> <span class="token class-name">Direction</span> <span class="token punctuation">{</span> kForward<span class="token punctuation">,</span> kReverse <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">FindSmallest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">FindLargest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// We might want to use a heap in case there are lots of children.</span>
  <span class="token comment">// For now we use a simple array since we expect a very small number</span>
  <span class="token comment">// of children in leveldb.</span>
  <span class="token keyword">const</span> Comparator<span class="token operator">*</span> comparator_<span class="token punctuation">;</span>
  IteratorWrapper<span class="token operator">*</span> children_<span class="token punctuation">;</span>
  <span class="token keyword">int</span> n_<span class="token punctuation">;</span>
  IteratorWrapper<span class="token operator">*</span> current_<span class="token punctuation">;</span>
  Direction direction_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token class-name">MergingIterator</span><span class="token operator">::</span><span class="token function">FindSmallest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  IteratorWrapper<span class="token operator">*</span> smallest <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n_<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    IteratorWrapper<span class="token operator">*</span> child <span class="token operator">=</span> <span class="token operator">&amp;</span>children_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token operator">-></span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>smallest <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        smallest <span class="token operator">=</span> child<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>comparator_<span class="token operator">-></span><span class="token function">Compare</span><span class="token punctuation">(</span>child<span class="token operator">-></span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> smallest<span class="token operator">-></span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        smallest <span class="token operator">=</span> child<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  current_ <span class="token operator">=</span> smallest<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">MergingIterator</span><span class="token operator">::</span><span class="token function">FindLargest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  IteratorWrapper<span class="token operator">*</span> largest <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> n_ <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    IteratorWrapper<span class="token operator">*</span> child <span class="token operator">=</span> <span class="token operator">&amp;</span>children_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token operator">-></span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>largest <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        largest <span class="token operator">=</span> child<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>comparator_<span class="token operator">-></span><span class="token function">Compare</span><span class="token punctuation">(</span>child<span class="token operator">-></span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> largest<span class="token operator">-></span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        largest <span class="token operator">=</span> child<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  current_ <span class="token operator">=</span> largest<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="6.-table" tabindex="-1"><a href="#6.-table">6. Table</a></h3>
<p>最后来看 Sorted Table 的实现 <a href="https://github.com/google/leveldb/blob/master/table/table.cc"><code>table/table.cc</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">Table</span><span class="token operator">:</span><span class="token base-clause"><span class="token operator">:</span><span class="token class-name">Rep</span></span> <span class="token punctuation">{</span>
  <span class="token operator">~</span><span class="token function">Rep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> filter<span class="token punctuation">;</span>
    <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> filter_data<span class="token punctuation">;</span>
    <span class="token keyword">delete</span> index_block<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  Options options<span class="token punctuation">;</span>
  Status status<span class="token punctuation">;</span>
  RandomAccessFile<span class="token operator">*</span> file<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> cache_id<span class="token punctuation">;</span>
  FilterBlockReader<span class="token operator">*</span> filter<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filter_data<span class="token punctuation">;</span>

  BlockHandle metaindex_handle<span class="token punctuation">;</span>  <span class="token comment">// Handle to metaindex_block: saved from footer</span>
  Block<span class="token operator">*</span> index_block<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Status <span class="token class-name">Table</span><span class="token operator">::</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token keyword">const</span> Options<span class="token operator">&amp;</span> options<span class="token punctuation">,</span> RandomAccessFile<span class="token operator">*</span> file<span class="token punctuation">,</span>
                   <span class="token keyword">uint64_t</span> size<span class="token punctuation">,</span> Table<span class="token operator">*</span><span class="token operator">*</span> table<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">*</span>table <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> Footer<span class="token operator">::</span>kEncodedLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token operator">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"file is too short to be an sstable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">char</span> footer_space<span class="token punctuation">[</span>Footer<span class="token operator">::</span>kEncodedLength<span class="token punctuation">]</span><span class="token punctuation">;</span>
  Slice footer_input<span class="token punctuation">;</span>
  Status s <span class="token operator">=</span> file<span class="token operator">-></span><span class="token function">Read</span><span class="token punctuation">(</span>size <span class="token operator">-</span> Footer<span class="token operator">::</span>kEncodedLength<span class="token punctuation">,</span> Footer<span class="token operator">::</span>kEncodedLength<span class="token punctuation">,</span>
                        <span class="token operator">&amp;</span>footer_input<span class="token punctuation">,</span> footer_space<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> s<span class="token punctuation">;</span>

  Footer footer<span class="token punctuation">;</span>
  s <span class="token operator">=</span> footer<span class="token punctuation">.</span><span class="token function">DecodeFrom</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>footer_input<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> s<span class="token punctuation">;</span>

  <span class="token comment">// Read the index block</span>
  BlockContents index_block_contents<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ReadOptions opt<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>paranoid_checks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      opt<span class="token punctuation">.</span>verify_checksums <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    s <span class="token operator">=</span> <span class="token function">ReadBlock</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> footer<span class="token punctuation">.</span><span class="token function">index_handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>index_block_contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// We've successfully read the footer and the index block: we're</span>
    <span class="token comment">// ready to serve requests.</span>
    Block<span class="token operator">*</span> index_block <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Block</span><span class="token punctuation">(</span>index_block_contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Rep<span class="token operator">*</span> rep <span class="token operator">=</span> <span class="token keyword">new</span> Table<span class="token operator">::</span>Rep<span class="token punctuation">;</span>
    rep<span class="token operator">-></span>options <span class="token operator">=</span> options<span class="token punctuation">;</span>
    rep<span class="token operator">-></span>file <span class="token operator">=</span> file<span class="token punctuation">;</span>
    rep<span class="token operator">-></span>metaindex_handle <span class="token operator">=</span> footer<span class="token punctuation">.</span><span class="token function">metaindex_handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rep<span class="token operator">-></span>index_block <span class="token operator">=</span> index_block<span class="token punctuation">;</span>
    rep<span class="token operator">-></span>cache_id <span class="token operator">=</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>block_cache <span class="token operator">?</span> options<span class="token punctuation">.</span>block_cache<span class="token operator">-></span><span class="token function">NewId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rep<span class="token operator">-></span>filter_data <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    rep<span class="token operator">-></span>filter <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>table <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Table</span><span class="token punctuation">(</span>rep<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>table<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ReadMeta</span><span class="token punctuation">(</span>footer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">Table</span><span class="token operator">::</span><span class="token function">ReadMeta</span><span class="token punctuation">(</span><span class="token keyword">const</span> Footer<span class="token operator">&amp;</span> footer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rep_<span class="token operator">-></span>options<span class="token punctuation">.</span>filter_policy <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token comment">// Do not need any metadata</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// TODO(sanjay): Skip this if footer.metaindex_handle() size indicates</span>
  <span class="token comment">// it is an empty block.</span>
  ReadOptions opt<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rep_<span class="token operator">-></span>options<span class="token punctuation">.</span>paranoid_checks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    opt<span class="token punctuation">.</span>verify_checksums <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  BlockContents contents<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ReadBlock</span><span class="token punctuation">(</span>rep_<span class="token operator">-></span>file<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> footer<span class="token punctuation">.</span><span class="token function">metaindex_handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>contents<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Do not propagate errors since meta info is not needed for operation</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  Block<span class="token operator">*</span> meta <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Block</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">;</span>

  Iterator<span class="token operator">*</span> iter <span class="token operator">=</span> meta<span class="token operator">-></span><span class="token function">NewIterator</span><span class="token punctuation">(</span><span class="token function">BytewiseComparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>string key <span class="token operator">=</span> <span class="token string">"filter."</span><span class="token punctuation">;</span>
  key<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>rep_<span class="token operator">-></span>options<span class="token punctuation">.</span>filter_policy<span class="token operator">-></span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  iter<span class="token operator">-></span><span class="token function">Seek</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iter<span class="token operator">-></span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> iter<span class="token operator">-></span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">Slice</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ReadFilter</span><span class="token punctuation">(</span>iter<span class="token operator">-></span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">delete</span> iter<span class="token punctuation">;</span>
  <span class="token keyword">delete</span> meta<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">Table</span><span class="token operator">::</span><span class="token function">ReadFilter</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> filter_handle_value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Slice v <span class="token operator">=</span> filter_handle_value<span class="token punctuation">;</span>
  BlockHandle filter_handle<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filter_handle<span class="token punctuation">.</span><span class="token function">DecodeFrom</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// We might want to unify with ReadBlock() if we start</span>
  <span class="token comment">// requiring checksum verification in Table::Open.</span>
  ReadOptions opt<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rep_<span class="token operator">-></span>options<span class="token punctuation">.</span>paranoid_checks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    opt<span class="token punctuation">.</span>verify_checksums <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  BlockContents block<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ReadBlock</span><span class="token punctuation">(</span>rep_<span class="token operator">-></span>file<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> filter_handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>block<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>block<span class="token punctuation">.</span>heap_allocated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rep_<span class="token operator">-></span>filter_data <span class="token operator">=</span> block<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Will need to delete later</span>
  <span class="token punctuation">}</span>
  rep_<span class="token operator">-></span>filter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">FilterBlockReader</span><span class="token punctuation">(</span>rep_<span class="token operator">-></span>options<span class="token punctuation">.</span>filter_policy<span class="token punctuation">,</span> block<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">Table</span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">delete</span> rep_<span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre>
<p>开始部分依然是熟悉的 <code>pImpl</code> 范式，毕竟 <code>Table</code> 是对外的接口，需要保持稳定。<code>Table::Open</code> 时，首先读取文件尾部的 <code>Footer</code>，根据 <code>Footer::index_handle()</code> 读取 <code>index_block</code> 到内存中，并按需读取 <code>meta_block</code> 和 <code>filter</code>；这些析构时也会做对应的删除。接着看迭代器部分的实现：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">DeleteCachedBlock</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Block<span class="token operator">*</span> block <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>Block<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">delete</span> block<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ReleaseBlock</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> h<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Cache<span class="token operator">*</span> cache <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>Cache<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Cache<span class="token operator">::</span>Handle<span class="token operator">*</span> handle <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>Cache<span class="token operator">::</span>Handle<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
  cache<span class="token operator">-></span><span class="token function">Release</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Convert an index iterator value (i.e., an encoded BlockHandle)</span>
<span class="token comment">// into an iterator over the contents of the corresponding block.</span>
Iterator<span class="token operator">*</span> <span class="token class-name">Table</span><span class="token operator">::</span><span class="token function">BlockReader</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">,</span> <span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span> options<span class="token punctuation">,</span>
                             <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> index_value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Table<span class="token operator">*</span> table <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>Table<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Cache<span class="token operator">*</span> block_cache <span class="token operator">=</span> table<span class="token operator">-></span>rep_<span class="token operator">-></span>options<span class="token punctuation">.</span>block_cache<span class="token punctuation">;</span>
  Block<span class="token operator">*</span> block <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  Cache<span class="token operator">::</span>Handle<span class="token operator">*</span> cache_handle <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

  BlockHandle handle<span class="token punctuation">;</span>
  Slice input <span class="token operator">=</span> index_value<span class="token punctuation">;</span>
  Status s <span class="token operator">=</span> handle<span class="token punctuation">.</span><span class="token function">DecodeFrom</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// We intentionally allow extra stuff in index_value so that we</span>
  <span class="token comment">// can add more features in the future.</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    BlockContents contents<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>block_cache <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">char</span> cache_key_buffer<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">EncodeFixed64</span><span class="token punctuation">(</span>cache_key_buffer<span class="token punctuation">,</span> table<span class="token operator">-></span>rep_<span class="token operator">-></span>cache_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">EncodeFixed64</span><span class="token punctuation">(</span>cache_key_buffer <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> handle<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Slice <span class="token function">key</span><span class="token punctuation">(</span>cache_key_buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cache_key_buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cache_handle <span class="token operator">=</span> block_cache<span class="token operator">-></span><span class="token function">Lookup</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cache_handle <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        block <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>Block<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>block_cache<span class="token operator">-></span><span class="token function">Value</span><span class="token punctuation">(</span>cache_handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        s <span class="token operator">=</span> <span class="token function">ReadBlock</span><span class="token punctuation">(</span>table<span class="token operator">-></span>rep_<span class="token operator">-></span>file<span class="token punctuation">,</span> options<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          block <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Block</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>contents<span class="token punctuation">.</span>cachable <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>fill_cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cache_handle <span class="token operator">=</span> block_cache<span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> block<span class="token punctuation">,</span> block<span class="token operator">-></span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                               <span class="token operator">&amp;</span>DeleteCachedBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      s <span class="token operator">=</span> <span class="token function">ReadBlock</span><span class="token punctuation">(</span>table<span class="token operator">-></span>rep_<span class="token operator">-></span>file<span class="token punctuation">,</span> options<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        block <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Block</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  Iterator<span class="token operator">*</span> iter<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>block <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    iter <span class="token operator">=</span> block<span class="token operator">-></span><span class="token function">NewIterator</span><span class="token punctuation">(</span>table<span class="token operator">-></span>rep_<span class="token operator">-></span>options<span class="token punctuation">.</span>comparator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cache_handle <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      iter<span class="token operator">-></span><span class="token function">RegisterCleanup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DeleteBlock<span class="token punctuation">,</span> block<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      iter<span class="token operator">-></span><span class="token function">RegisterCleanup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ReleaseBlock<span class="token punctuation">,</span> block_cache<span class="token punctuation">,</span> cache_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    iter <span class="token operator">=</span> <span class="token function">NewErrorIterator</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> iter<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Iterator<span class="token operator">*</span> <span class="token class-name">Table</span><span class="token operator">::</span><span class="token function">NewIterator</span><span class="token punctuation">(</span><span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span> options<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">NewTwoLevelIterator</span><span class="token punctuation">(</span>
      rep_<span class="token operator">-></span>index_block<span class="token operator">-></span><span class="token function">NewIterator</span><span class="token punctuation">(</span>rep_<span class="token operator">-></span>options<span class="token punctuation">.</span>comparator<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token operator">&amp;</span>Table<span class="token operator">::</span>BlockReader<span class="token punctuation">,</span> <span class="token keyword">const_cast</span><span class="token operator">&lt;</span>Table<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>Table::NewIterator</code> 中会构造一个二级迭代器，第一级自然是 <code>index_block</code> 的迭代器，并且提供了第二级迭代器的创建函数 <code>Table::BlockReader</code>。该函数的第一个参数实际上为 <code>Table</code> 对象的指针，第三个参数是 <code>index_block</code> 键值对中的 <code>Value</code>，也就是对应的 Data Block Handle。如果不考虑缓存部分，代码还是很容易理解的：首先解析对应的 <code>BlockHandle</code>，据此读取 <code>block</code>，创建迭代器并且注册迭代器清理函数 <code>DeleteBlock</code>，当删除迭代器时删除对应的 <code>block</code>。当考虑缓存时，可以回忆下<a href="/leveldb/leveldb_01_data_structure.html">系列第一篇</a>介绍的 <code>LRUCache</code> 再来看代码：使用 <code>cache_id</code> 和 <code>handle.offset</code> 构建一个缓存的 <code>Key</code>，将 <code>block</code> 作为缓存的 <code>Value</code>，后者的清理函数为 <code>DeleteCachedBlock</code>；当前使用 <code>block</code> 创建迭代器增加了 <code>block</code> 的引用计数，当迭代器析构时需要调用 <code>ReleaseBlock</code> 以减少缓存的 <code>block</code> 的引用计数。这样就非常合理且高效了。</p>
<h3 id="7.-table-cache" tabindex="-1"><a href="#7.-table-cache">7. Table Cache</a></h3>
<p>LevelDB 中会使用 <code>file_number</code> 给 Sorted Table 编号。为了提高读取性能、简化使用，LevelDB 提供了 <code>TableCache</code> 用以缓存 Sorted Table 及对应的 <code>.ldb</code> 文件，定义于 <a href="https://github.com/google/leveldb/blob/master/db/table_cache.h"><code>db/table_cache.h</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">TableCache</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">TableCache</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> dbname<span class="token punctuation">,</span> <span class="token keyword">const</span> Options<span class="token operator">&amp;</span> options<span class="token punctuation">,</span> <span class="token keyword">int</span> entries<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">~</span><span class="token function">TableCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Return an iterator for the specified file number (the corresponding</span>
  <span class="token comment">// file length must be exactly "file_size" bytes).  If "tableptr" is</span>
  <span class="token comment">// non-null, also sets "*tableptr" to point to the Table object</span>
  <span class="token comment">// underlying the returned iterator, or to nullptr if no Table object</span>
  <span class="token comment">// underlies the returned iterator.  The returned "*tableptr" object is owned</span>
  <span class="token comment">// by the cache and should not be deleted, and is valid for as long as the</span>
  <span class="token comment">// returned iterator is live.</span>
  Iterator<span class="token operator">*</span> <span class="token function">NewIterator</span><span class="token punctuation">(</span><span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span> options<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> file_number<span class="token punctuation">,</span>
                        <span class="token keyword">uint64_t</span> file_size<span class="token punctuation">,</span> Table<span class="token operator">*</span><span class="token operator">*</span> tableptr <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If a seek to internal key "k" in specified file finds an entry,</span>
  <span class="token comment">// call (*handle_result)(arg, found_key, found_value).</span>
  Status <span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span> options<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> file_number<span class="token punctuation">,</span>
             <span class="token keyword">uint64_t</span> file_size<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> k<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">,</span>
             <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>handle_result<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span><span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Evict any entry for the specified file number</span>
  <span class="token keyword">void</span> <span class="token function">Evict</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> file_number<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  Status <span class="token function">FindTable</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> file_number<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> file_size<span class="token punctuation">,</span> Cache<span class="token operator">::</span>Handle<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  Env<span class="token operator">*</span> <span class="token keyword">const</span> env_<span class="token punctuation">;</span>
  <span class="token keyword">const</span> std<span class="token operator">::</span>string dbname_<span class="token punctuation">;</span>
  <span class="token keyword">const</span> Options<span class="token operator">&amp;</span> options_<span class="token punctuation">;</span>
  Cache<span class="token operator">*</span> cache_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>核心接口 <code>TableCache::NewIterator</code>，只需要提供 <code>file_number</code> 和 <code>file_size</code>，就可以返回对应的 Sorted Table 对象及其迭代器。TableCache 封装了缓存和清理的逻辑，其实现也非常简单：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">TableAndFile</span> <span class="token punctuation">{</span>
  RandomAccessFile<span class="token operator">*</span> file<span class="token punctuation">;</span>
  Table<span class="token operator">*</span> table<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">DeleteEntry</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  TableAndFile<span class="token operator">*</span> tf <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>TableAndFile<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">delete</span> tf<span class="token operator">-></span>table<span class="token punctuation">;</span>
  <span class="token keyword">delete</span> tf<span class="token operator">-></span>file<span class="token punctuation">;</span>
  <span class="token keyword">delete</span> tf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">UnrefEntry</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg1<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> arg2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Cache<span class="token operator">*</span> cache <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>Cache<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>arg1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Cache<span class="token operator">::</span>Handle<span class="token operator">*</span> h <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>Cache<span class="token operator">::</span>Handle<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>arg2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  cache<span class="token operator">-></span><span class="token function">Release</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">TableCache</span><span class="token operator">::</span><span class="token function">TableCache</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> dbname<span class="token punctuation">,</span> <span class="token keyword">const</span> Options<span class="token operator">&amp;</span> options<span class="token punctuation">,</span>
                       <span class="token keyword">int</span> entries<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">env_</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">dbname_</span><span class="token punctuation">(</span>dbname<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">options_</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">cache_</span><span class="token punctuation">(</span><span class="token function">NewLRUCache</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token class-name">TableCache</span><span class="token operator">::</span><span class="token operator">~</span><span class="token function">TableCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">delete</span> cache_<span class="token punctuation">;</span> <span class="token punctuation">}</span>

Status <span class="token class-name">TableCache</span><span class="token operator">::</span><span class="token function">FindTable</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> file_number<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> file_size<span class="token punctuation">,</span>
                             Cache<span class="token operator">::</span>Handle<span class="token operator">*</span><span class="token operator">*</span> handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Status s<span class="token punctuation">;</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>file_number<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">EncodeFixed64</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> file_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Slice <span class="token function">key</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span>handle <span class="token operator">=</span> cache_<span class="token operator">-></span><span class="token function">Lookup</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>handle <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token operator">::</span>string fname <span class="token operator">=</span> <span class="token function">TableFileName</span><span class="token punctuation">(</span>dbname_<span class="token punctuation">,</span> file_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    RandomAccessFile<span class="token operator">*</span> file <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    Table<span class="token operator">*</span> table <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    s <span class="token operator">=</span> env_<span class="token operator">-></span><span class="token function">NewRandomAccessFile</span><span class="token punctuation">(</span>fname<span class="token punctuation">,</span> <span class="token operator">&amp;</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      std<span class="token operator">::</span>string old_fname <span class="token operator">=</span> <span class="token function">SSTTableFileName</span><span class="token punctuation">(</span>dbname_<span class="token punctuation">,</span> file_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>env_<span class="token operator">-></span><span class="token function">NewRandomAccessFile</span><span class="token punctuation">(</span>old_fname<span class="token punctuation">,</span> <span class="token operator">&amp;</span>file<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        s <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token operator">::</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      s <span class="token operator">=</span> <span class="token class-name">Table</span><span class="token operator">::</span><span class="token function">Open</span><span class="token punctuation">(</span>options_<span class="token punctuation">,</span> file<span class="token punctuation">,</span> file_size<span class="token punctuation">,</span> <span class="token operator">&amp;</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>table <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">delete</span> file<span class="token punctuation">;</span>
      <span class="token comment">// We do not cache error results so that if the error is transient,</span>
      <span class="token comment">// or somebody repairs the file, we recover automatically.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      TableAndFile<span class="token operator">*</span> tf <span class="token operator">=</span> <span class="token keyword">new</span> TableAndFile<span class="token punctuation">;</span>
      tf<span class="token operator">-></span>file <span class="token operator">=</span> file<span class="token punctuation">;</span>
      tf<span class="token operator">-></span>table <span class="token operator">=</span> table<span class="token punctuation">;</span>
      <span class="token operator">*</span>handle <span class="token operator">=</span> cache_<span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> tf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>DeleteEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Iterator<span class="token operator">*</span> <span class="token class-name">TableCache</span><span class="token operator">::</span><span class="token function">NewIterator</span><span class="token punctuation">(</span><span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span> options<span class="token punctuation">,</span>
                                  <span class="token keyword">uint64_t</span> file_number<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> file_size<span class="token punctuation">,</span>
                                  Table<span class="token operator">*</span><span class="token operator">*</span> tableptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tableptr <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>tableptr <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  Cache<span class="token operator">::</span>Handle<span class="token operator">*</span> handle <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  Status s <span class="token operator">=</span> <span class="token function">FindTable</span><span class="token punctuation">(</span>file_number<span class="token punctuation">,</span> file_size<span class="token punctuation">,</span> <span class="token operator">&amp;</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">NewErrorIterator</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  Table<span class="token operator">*</span> table <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>TableAndFile<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>cache_<span class="token operator">-></span><span class="token function">Value</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-></span>table<span class="token punctuation">;</span>
  Iterator<span class="token operator">*</span> result <span class="token operator">=</span> table<span class="token operator">-></span><span class="token function">NewIterator</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  result<span class="token operator">-></span><span class="token function">RegisterCleanup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>UnrefEntry<span class="token punctuation">,</span> cache_<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tableptr <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>tableptr <span class="token operator">=</span> table<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Status <span class="token class-name">TableCache</span><span class="token operator">::</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span> options<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> file_number<span class="token punctuation">,</span>
                       <span class="token keyword">uint64_t</span> file_size<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> k<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">,</span>
                       <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>handle_result<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span><span class="token punctuation">,</span>
                                             <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Cache<span class="token operator">::</span>Handle<span class="token operator">*</span> handle <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  Status s <span class="token operator">=</span> <span class="token function">FindTable</span><span class="token punctuation">(</span>file_number<span class="token punctuation">,</span> file_size<span class="token punctuation">,</span> <span class="token operator">&amp;</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Table<span class="token operator">*</span> t <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>TableAndFile<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>cache_<span class="token operator">-></span><span class="token function">Value</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-></span>table<span class="token punctuation">;</span>
    s <span class="token operator">=</span> t<span class="token operator">-></span><span class="token function">InternalGet</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> k<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> handle_result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cache_<span class="token operator">-></span><span class="token function">Release</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">TableCache</span><span class="token operator">::</span><span class="token function">Evict</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> file_number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>file_number<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">EncodeFixed64</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> file_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
  cache_<span class="token operator">-></span><span class="token function">Erase</span><span class="token punctuation">(</span><span class="token function">Slice</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>TableCache::FindTable</code> 中会根据 <code>file_number</code> 构建缓存的 Key，首先尝试在缓存中查找，如果找不到则手动的打开文件、构造 Table。对应迭代器的实现也很简单，只需要设定好对应的清理函数 <code>DeleteEntry</code> 和 <code>UnrefEntry</code>，就可以放心使用了。每多加一层封装，就多屏蔽一分底层实现的细节，对使用者来说就更易用。</p>
<h3 id="总结" tabindex="-1"><a href="#%E6%80%BB%E7%BB%93">总结</a></h3>
<p>前后两篇完成了对 Sorted Table 代码的阅读和分析。当数据位于内存时，查找过程中随机访问的时间微乎其微；但当数据保存到硬盘后，将 Sorted Table 载入内存的 IO 时间就非常可观了。Sorted Table 使用多级迭代器来缓和这个问题，首先完整地读取了 Index Block 到内存中；进行查找时首先在 Index Block 上二分，确定 Data Block 的位置后再进行必要的 IO 读取，并且通过缓存 Data Block 的方式提升读取的性能。</p>
<p>仔细看 LevelDB 的代码，总觉得它在合适的地方完成了合适的事情，合理且高效。向 Google 大佬低头！</p>

      </div>
      <div id="gitalk-container">
      </div>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2021 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/gitalk.min.js"></script>
    <script src="/dist/main.js"></script>
    <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-61723712-2', 'auto'); ga('send', 'pageview'); </script>
  </body>
</html>
