<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/gitalk.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>LevelDB 源码分析「七、版本管理」 | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> LevelDB 源码分析「七、版本管理」 </h1>
      </div>
      <div class="info">
        <div class="date"> 2019.08.28 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <p>本系列的<a href="/leveldb/leveldb_06_sorted_table.html">上一篇</a>介绍了 Sorted Table 的构建和读取过程。当 Sorted Table 不断构建出来时，需要使用适当的方式来组织、管理生成的 <code>.ldb</code> 文件。并且 LevelDB 支持快照，这需要 LevelDB 具有版本管理能力。本篇将分析 LevelDB 版本管理相关的代码。</p>
<h3 id="1.-版本概述" tabindex="-1"><a href="#1.-%E7%89%88%E6%9C%AC%E6%A6%82%E8%BF%B0">1. 版本概述</a></h3>
<p>LevelDB 中的版本管理是针对 Sorted Table 文件的变化的。当有新的内存数据库转为 Sorted Table，或者发生 Compaction 导致有 Sorted Table 增删，都会触发版本的更新。版本管理可以类比 git：</p>
<ol>
<li>初始的时候是一个空的 repo（没有 Sorted Table 文件）；</li>
<li>当有文件增删时，会在之前的版本上做增量的 commit 记录（VersionEdit）；</li>
<li>根据之前的版本和 commit 记录，可以推断出现在的版本（Version）；</li>
<li>根据初始状态和所有 commit 记录可以推断出所有版本（VersionSet）；</li>
<li>使用 HEAD 指向当前使用的版本（CURRENT 文件）。</li>
</ol>
<h3 id="2.-版本-version" tabindex="-1"><a href="#2.-%E7%89%88%E6%9C%AC-version">2. 版本 Version</a></h3>
<p>首先来看没有未知依赖的 <a href="https://github.com/google/leveldb/blob/master/db/version_edit.h"><code>db/version_edit.h</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">FileMetaData</span> <span class="token punctuation">{</span>
  <span class="token function">FileMetaData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">refs</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">allowed_seeks</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">file_size</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">int</span> refs<span class="token punctuation">;</span>
  <span class="token keyword">int</span> allowed_seeks<span class="token punctuation">;</span>  <span class="token comment">// Seeks allowed until compaction</span>
  <span class="token keyword">uint64_t</span> number<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> file_size<span class="token punctuation">;</span>    <span class="token comment">// File size in bytes</span>
  InternalKey smallest<span class="token punctuation">;</span>  <span class="token comment">// Smallest internal key served by table</span>
  InternalKey largest<span class="token punctuation">;</span>   <span class="token comment">// Largest internal key served by table</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p><code>FileMetaData</code> 记录了 <code>.ldb</code> 文件的元信息，包括允许查找的次数、文件编号 <code>number</code> 和大小 <code>file_size</code> 以及最小和最大的 Key。接下来是 <code>VersionEdit</code> 的定义：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">VersionEdit</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">VersionEdit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token operator">~</span><span class="token function">VersionEdit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">SetComparatorName</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    has_comparator_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    comparator_ <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">SetLogNumber</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    has_log_number_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    log_number_ <span class="token operator">=</span> num<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">SetPrevLogNumber</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    has_prev_log_number_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    prev_log_number_ <span class="token operator">=</span> num<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">SetNextFile</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    has_next_file_number_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    next_file_number_ <span class="token operator">=</span> num<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">SetLastSequence</span><span class="token punctuation">(</span>SequenceNumber seq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    has_last_sequence_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    last_sequence_ <span class="token operator">=</span> seq<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">SetCompactPointer</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">const</span> InternalKey<span class="token operator">&amp;</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    compact_pointers_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Add the specified file at the specified number.</span>
  <span class="token comment">// REQUIRES: This version has not been saved (see VersionSet::SaveTo)</span>
  <span class="token comment">// REQUIRES: "smallest" and "largest" are smallest and largest keys in file</span>
  <span class="token keyword">void</span> <span class="token function">AddFile</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> file<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> file_size<span class="token punctuation">,</span>
               <span class="token keyword">const</span> InternalKey<span class="token operator">&amp;</span> smallest<span class="token punctuation">,</span> <span class="token keyword">const</span> InternalKey<span class="token operator">&amp;</span> largest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    FileMetaData f<span class="token punctuation">;</span>
    f<span class="token punctuation">.</span>number <span class="token operator">=</span> file<span class="token punctuation">;</span>
    f<span class="token punctuation">.</span>file_size <span class="token operator">=</span> file_size<span class="token punctuation">;</span>
    f<span class="token punctuation">.</span>smallest <span class="token operator">=</span> smallest<span class="token punctuation">;</span>
    f<span class="token punctuation">.</span>largest <span class="token operator">=</span> largest<span class="token punctuation">;</span>
    new_files_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Delete the specified "file" from the specified "level".</span>
  <span class="token keyword">void</span> <span class="token function">DeleteFile</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    deleted_files_<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">EncodeTo</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> dst<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
  Status <span class="token function">DecodeFrom</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token double-colon punctuation">::</span>string <span class="token function">DebugString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">VersionSet</span><span class="token punctuation">;</span>

  <span class="token keyword">typedef</span> std<span class="token double-colon punctuation">::</span>set<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">uint64_t</span><span class="token operator">>></span> DeletedFileSet<span class="token punctuation">;</span>

  std<span class="token double-colon punctuation">::</span>string comparator_<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> log_number_<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> prev_log_number_<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> next_file_number_<span class="token punctuation">;</span>
  SequenceNumber last_sequence_<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> has_comparator_<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> has_log_number_<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> has_prev_log_number_<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> has_next_file_number_<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> has_last_sequence_<span class="token punctuation">;</span>

  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> InternalKey<span class="token operator">>></span> compact_pointers_<span class="token punctuation">;</span>
  DeletedFileSet deleted_files_<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> FileMetaData<span class="token operator">>></span> new_files_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p><code>VersionEdit</code> 包含了几项可编辑属性：</p>
<ol>
<li><code>comparator_</code>，比较器的名称；</li>
<li><code>log_number_</code>，日志编号；</li>
<li><code>prev_log_number_</code>，上一个日志编号；</li>
<li><code>next_file_number_</code>，下一个文件编号；</li>
<li><code>last_sequence_</code>，最后的序列号；</li>
<li><code>compact_pointers_</code>，暂时不清楚是什么；</li>
<li><code>delted_files_</code>，删除的文件，记录了 <code>level</code> 和文件号；</li>
<li><code>new_files_</code>，新增的文件，记录了 <code>level</code> 和 <code>FileMetaData</code>。</li>
</ol>
<p>上面几项属性有些还不清楚作用，先搁置不用慌。另外两个重要的接口 <code>EncodeTo</code> 和 <code>DecodeFrom</code> 负责编解码，实现在对应的 <a href="https://github.com/google/leveldb/blob/master/db/version_edit.cc"><code>.cc</code></a> 中，不在赘述。接下来，继续看 <code>Version</code> 的定义 <a href="https://github.com/google/leveldb/blob/master/db/version_set.h"><code>db/version_set.h</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Version</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token comment">// Lookup the value for key.  If found, store it in *val and</span>
  <span class="token comment">// return OK.  Else return a non-OK status.  Fills *stats.</span>
  <span class="token comment">// REQUIRES: lock is not held</span>
  <span class="token keyword">struct</span> <span class="token class-name">GetStats</span> <span class="token punctuation">{</span>
    FileMetaData<span class="token operator">*</span> seek_file<span class="token punctuation">;</span>
    <span class="token keyword">int</span> seek_file_level<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Append to *iters a sequence of iterators that will</span>
  <span class="token comment">// yield the contents of this Version when merged together.</span>
  <span class="token comment">// REQUIRES: This version has been saved (see VersionSet::SaveTo)</span>
  <span class="token keyword">void</span> <span class="token function">AddIterators</span><span class="token punctuation">(</span><span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Iterator<span class="token operator">*</span><span class="token operator">></span><span class="token operator">*</span> iters<span class="token punctuation">)</span><span class="token punctuation">;</span>

  Status <span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span><span class="token punctuation">,</span> <span class="token keyword">const</span> LookupKey<span class="token operator">&amp;</span> key<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> val<span class="token punctuation">,</span>
             GetStats<span class="token operator">*</span> stats<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Adds "stats" into the current state.  Returns true if a new</span>
  <span class="token comment">// compaction may need to be triggered, false otherwise.</span>
  <span class="token comment">// REQUIRES: lock is held</span>
  <span class="token keyword">bool</span> <span class="token function">UpdateStats</span><span class="token punctuation">(</span><span class="token keyword">const</span> GetStats<span class="token operator">&amp;</span> stats<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Record a sample of bytes read at the specified internal key.</span>
  <span class="token comment">// Samples are taken approximately once every config::kReadBytesPeriod</span>
  <span class="token comment">// bytes.  Returns true if a new compaction may need to be triggered.</span>
  <span class="token comment">// REQUIRES: lock is held</span>
  <span class="token keyword">bool</span> <span class="token function">RecordReadSample</span><span class="token punctuation">(</span>Slice key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Reference count management (so Versions do not disappear out from</span>
  <span class="token comment">// under live iterators)</span>
  <span class="token keyword">void</span> <span class="token function">Ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">Unref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">GetOverlappingInputs</span><span class="token punctuation">(</span>
      <span class="token keyword">int</span> level<span class="token punctuation">,</span>
      <span class="token keyword">const</span> InternalKey<span class="token operator">*</span> begin<span class="token punctuation">,</span>  <span class="token comment">// nullptr means before all keys</span>
      <span class="token keyword">const</span> InternalKey<span class="token operator">*</span> end<span class="token punctuation">,</span>    <span class="token comment">// nullptr means after all keys</span>
      std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>FileMetaData<span class="token operator">*</span><span class="token operator">></span><span class="token operator">*</span> inputs<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Returns true iff some file in the specified level overlaps</span>
  <span class="token comment">// some part of [*smallest_user_key,*largest_user_key].</span>
  <span class="token comment">// smallest_user_key==nullptr represents a key smaller than all the DB's keys.</span>
  <span class="token comment">// largest_user_key==nullptr represents a key largest than all the DB's keys.</span>
  <span class="token keyword">bool</span> <span class="token function">OverlapInLevel</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">*</span> smallest_user_key<span class="token punctuation">,</span>
                      <span class="token keyword">const</span> Slice<span class="token operator">*</span> largest_user_key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Return the level at which we should place a new memtable compaction</span>
  <span class="token comment">// result that covers the range [smallest_user_key,largest_user_key].</span>
  <span class="token keyword">int</span> <span class="token function">PickLevelForMemTableOutput</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> smallest_user_key<span class="token punctuation">,</span>
                                 <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> largest_user_key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> <span class="token function">NumFiles</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> files_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token comment">// Return a human readable string that describes this version's contents.</span>
  std<span class="token double-colon punctuation">::</span>string <span class="token function">DebugString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">Compaction</span><span class="token punctuation">;</span>
  <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">VersionSet</span><span class="token punctuation">;</span>

  <span class="token keyword">class</span> <span class="token class-name">LevelFileNumIterator</span><span class="token punctuation">;</span>

  <span class="token keyword">explicit</span> <span class="token function">Version</span><span class="token punctuation">(</span>VersionSet<span class="token operator">*</span> vset<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">vset_</span><span class="token punctuation">(</span>vset<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">next_</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">prev_</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">refs_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">file_to_compact_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">file_to_compact_level_</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">compaction_score_</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">compaction_level_</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">Version</span><span class="token punctuation">(</span><span class="token keyword">const</span> Version<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
  Version<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Version<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

  <span class="token operator">~</span><span class="token function">Version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  Iterator<span class="token operator">*</span> <span class="token function">NewConcatenatingIterator</span><span class="token punctuation">(</span><span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span><span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

  <span class="token comment">// Call func(arg, level, f) for every file that overlaps user_key in</span>
  <span class="token comment">// order from newest to oldest.  If an invocation of func returns</span>
  <span class="token comment">// false, makes no more calls.</span>
  <span class="token comment">//</span>
  <span class="token comment">// REQUIRES: user portion of internal_key == user_key.</span>
  <span class="token keyword">void</span> <span class="token function">ForEachOverlapping</span><span class="token punctuation">(</span>Slice user_key<span class="token punctuation">,</span> Slice internal_key<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">,</span>
                          <span class="token keyword">bool</span> <span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> FileMetaData<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  VersionSet<span class="token operator">*</span> vset_<span class="token punctuation">;</span>  <span class="token comment">// VersionSet to which this Version belongs</span>
  Version<span class="token operator">*</span> next_<span class="token punctuation">;</span>     <span class="token comment">// Next version in linked list</span>
  Version<span class="token operator">*</span> prev_<span class="token punctuation">;</span>     <span class="token comment">// Previous version in linked list</span>
  <span class="token keyword">int</span> refs_<span class="token punctuation">;</span>          <span class="token comment">// Number of live refs to this version</span>

  <span class="token comment">// List of files per level</span>
  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>FileMetaData<span class="token operator">*</span><span class="token operator">></span> files_<span class="token punctuation">[</span>config<span class="token double-colon punctuation">::</span>kNumLevels<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">// Next file to compact based on seek stats.</span>
  FileMetaData<span class="token operator">*</span> file_to_compact_<span class="token punctuation">;</span>
  <span class="token keyword">int</span> file_to_compact_level_<span class="token punctuation">;</span>

  <span class="token comment">// Level that should be compacted next and its compaction score.</span>
  <span class="token comment">// Score &lt; 1 means compaction is not strictly needed.  These fields</span>
  <span class="token comment">// are initialized by Finalize().</span>
  <span class="token keyword">double</span> compaction_score_<span class="token punctuation">;</span>
  <span class="token keyword">int</span> compaction_level_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>首先把属性列出来：</p>
<ol>
<li><code>vset_</code>，<code>VersionSet</code> 对象指针，该类下文再介绍，搁置；</li>
<li><code>next_</code> 和 <code>prev_</code>，成对出现，双向链表无疑；</li>
<li><code>refs_</code>，引用计数；</li>
<li><code>files_</code>，每一个 <code>level</code> 中的文件元信息列表；</li>
<li><code>file_to_compact_</code> 和 <code>file_to_compact_level_</code>，准备合并的文件及其 <code>level</code>，搁置；</li>
<li><code>compaction_score_</code> 和 <code>compaction_level_</code>，需要执行合并的 <code>level</code> 及打分，搁置。</li>
</ol>
<p>对属性有一个印象就好。接下来拆开来看这个类成员函数的实现 <a href="https://github.com/google/leveldb/blob/master/db/version_set.cc"><code>db/version_set.cc</code></a>，首先看迭代器：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// Return the smallest index i such that files[i]->largest >= key.</span>
<span class="token comment">// Return files.size() if there is no such file.</span>
<span class="token comment">// REQUIRES: "files" contains a sorted list of non-overlapping files.</span>
<span class="token keyword">int</span> <span class="token function">FindFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> InternalKeyComparator<span class="token operator">&amp;</span> icmp<span class="token punctuation">,</span>
             <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>FileMetaData<span class="token operator">*</span><span class="token operator">></span><span class="token operator">&amp;</span> files<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">uint32_t</span> left <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> right <span class="token operator">=</span> files<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>left <span class="token operator">&lt;</span> right<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">uint32_t</span> mid <span class="token operator">=</span> <span class="token punctuation">(</span>left <span class="token operator">+</span> right<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> FileMetaData<span class="token operator">*</span> f <span class="token operator">=</span> files<span class="token punctuation">[</span>mid<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>icmp<span class="token punctuation">.</span><span class="token class-name">InternalKeyComparator</span><span class="token double-colon punctuation">::</span><span class="token function">Compare</span><span class="token punctuation">(</span>f<span class="token operator">-></span>largest<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Key at "mid.largest" is &lt; "target".  Therefore all</span>
      <span class="token comment">// files at or before "mid" are uninteresting.</span>
      left <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Key at "mid.largest" is >= "target".  Therefore all files</span>
      <span class="token comment">// after "mid" are uninteresting.</span>
      right <span class="token operator">=</span> mid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> right<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// An internal iterator.  For a given version/level pair, yields</span>
<span class="token comment">// information about the files in the level.  For a given entry, key()</span>
<span class="token comment">// is the largest key that occurs in the file, and value() is an</span>
<span class="token comment">// 16-byte value containing the file number and file size, both</span>
<span class="token comment">// encoded using EncodeFixed64.</span>
<span class="token keyword">class</span> <span class="token class-name">Version</span><span class="token operator">:</span><span class="token base-clause"><span class="token operator">:</span><span class="token class-name">LevelFileNumIterator</span> <span class="token operator">:</span> <span class="token keyword">public</span> <span class="token class-name">Iterator</span></span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">LevelFileNumIterator</span><span class="token punctuation">(</span><span class="token keyword">const</span> InternalKeyComparator<span class="token operator">&amp;</span> icmp<span class="token punctuation">,</span>
                       <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>FileMetaData<span class="token operator">*</span><span class="token operator">></span><span class="token operator">*</span> flist<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">icmp_</span><span class="token punctuation">(</span>icmp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">flist_</span><span class="token punctuation">(</span>flist<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">index_</span><span class="token punctuation">(</span>flist<span class="token operator">-></span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// Marks as invalid</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">bool</span> <span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> index_ <span class="token operator">&lt;</span> flist_<span class="token operator">-></span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">Seek</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> target<span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{</span>
    index_ <span class="token operator">=</span> <span class="token function">FindFile</span><span class="token punctuation">(</span>icmp_<span class="token punctuation">,</span> <span class="token operator">*</span>flist_<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">SeekToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{</span> index_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">SeekToLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{</span>
    index_ <span class="token operator">=</span> flist_<span class="token operator">-></span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> flist_<span class="token operator">-></span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    index_<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">Prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index_ <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      index_ <span class="token operator">=</span> flist_<span class="token operator">-></span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Marks as invalid</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      index_<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  Slice <span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>flist_<span class="token punctuation">)</span><span class="token punctuation">[</span>index_<span class="token punctuation">]</span><span class="token operator">-></span>largest<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  Slice <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">EncodeFixed64</span><span class="token punctuation">(</span>value_buf_<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>flist_<span class="token punctuation">)</span><span class="token punctuation">[</span>index_<span class="token punctuation">]</span><span class="token operator">-></span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">EncodeFixed64</span><span class="token punctuation">(</span>value_buf_ <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>flist_<span class="token punctuation">)</span><span class="token punctuation">[</span>index_<span class="token punctuation">]</span><span class="token operator">-></span>file_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">Slice</span><span class="token punctuation">(</span>value_buf_<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>value_buf_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  Status <span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">const</span> InternalKeyComparator icmp_<span class="token punctuation">;</span>
  <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>FileMetaData<span class="token operator">*</span><span class="token operator">></span><span class="token operator">*</span> <span class="token keyword">const</span> flist_<span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> index_<span class="token punctuation">;</span>

  <span class="token comment">// Backing store for value().  Holds the file number and size.</span>
  <span class="token keyword">mutable</span> <span class="token keyword">char</span> value_buf_<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> Iterator<span class="token operator">*</span> <span class="token function">GetFileIterator</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">,</span> <span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span> options<span class="token punctuation">,</span>
                                 <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> file_value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  TableCache<span class="token operator">*</span> cache <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>TableCache<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>file_value<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">NewErrorIterator</span><span class="token punctuation">(</span>
        <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"FileReader invoked with unexpected value"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> cache<span class="token operator">-></span><span class="token function">NewIterator</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token function">DecodeFixed64</span><span class="token punctuation">(</span>file_value<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                              <span class="token function">DecodeFixed64</span><span class="token punctuation">(</span>file_value<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Iterator<span class="token operator">*</span> <span class="token class-name">Version</span><span class="token double-colon punctuation">::</span><span class="token function">NewConcatenatingIterator</span><span class="token punctuation">(</span><span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span> options<span class="token punctuation">,</span>
                                            <span class="token keyword">int</span> level<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">NewTwoLevelIterator</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token function">LevelFileNumIterator</span><span class="token punctuation">(</span>vset_<span class="token operator">-></span>icmp_<span class="token punctuation">,</span> <span class="token operator">&amp;</span>files_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>GetFileIterator<span class="token punctuation">,</span>
      vset_<span class="token operator">-></span>table_cache_<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">Version</span><span class="token double-colon punctuation">::</span><span class="token function">AddIterators</span><span class="token punctuation">(</span><span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span> options<span class="token punctuation">,</span>
                           std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Iterator<span class="token operator">*</span><span class="token operator">></span><span class="token operator">*</span> iters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Merge all level zero files together since they may overlap</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> files_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    iters<span class="token operator">-></span><span class="token function">push_back</span><span class="token punctuation">(</span>vset_<span class="token operator">-></span>table_cache_<span class="token operator">-></span><span class="token function">NewIterator</span><span class="token punctuation">(</span>
        options<span class="token punctuation">,</span> files_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>number<span class="token punctuation">,</span> files_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>file_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// For levels > 0, we can use a concatenating iterator that sequentially</span>
  <span class="token comment">// walks through the non-overlapping files in the level, opening them</span>
  <span class="token comment">// lazily.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> level <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> level <span class="token operator">&lt;</span> config<span class="token double-colon punctuation">::</span>kNumLevels<span class="token punctuation">;</span> level<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>files_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      iters<span class="token operator">-></span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">NewConcatenatingIterator</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<p><code>FindFile</code> 函数实现了一个简单的二分查找，可以在文件信息列表里快速找到第一个 <code>largest_key &gt;= key</code> 的文件信息编号。而后这里定义了一个文件信息列表的迭代器 <code>Version::LevelFileNumIterator</code>，其实现的功能是将 <code>largest_key</code> 作为 Key，文件编号和大小作为 Value，遍历和检索文件信息列表。该函数将在 <code>Version::NewConcatenatingIterator</code> 中作为第一级迭代器，对应的第二级便是其 Value 对应的 Sorted Table 文件的迭代器 <code>GetFileIterator</code>。这样就可以根据某个 Level 的文件信息列表，生成该 Level 下所有 Sorted Table 数据的迭代器。这还没结束，<code>Version::AddIterators</code> 会将所有 Level 的迭代器组合成一个列表，用来生成一个 <code>MergingIterator</code> 以遍历所有 Level 的数据（实现位于 <a href="https://github.com/google/leveldb/blob/master/db/db_impl.cc#L1088"><code>DBImpl::NewInternalIterator</code></a>）。仔细体会这个精妙的设计，然后继续来看 <code>Version::Get</code> 的实现：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// Callback from TableCache::Get()</span>
<span class="token keyword">namespace</span> <span class="token punctuation">{</span>
<span class="token keyword">enum</span> <span class="token class-name">SaverState</span> <span class="token punctuation">{</span>
  kNotFound<span class="token punctuation">,</span>
  kFound<span class="token punctuation">,</span>
  kDeleted<span class="token punctuation">,</span>
  kCorrupt<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">Saver</span> <span class="token punctuation">{</span>
  SaverState state<span class="token punctuation">;</span>
  <span class="token keyword">const</span> Comparator<span class="token operator">*</span> ucmp<span class="token punctuation">;</span>
  Slice user_key<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>  <span class="token comment">// namespace</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">SaveValue</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> ikey<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Saver<span class="token operator">*</span> s <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Saver<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ParsedInternalKey parsed_key<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ParseInternalKey</span><span class="token punctuation">(</span>ikey<span class="token punctuation">,</span> <span class="token operator">&amp;</span>parsed_key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s<span class="token operator">-></span>state <span class="token operator">=</span> kCorrupt<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-></span>ucmp<span class="token operator">-></span><span class="token function">Compare</span><span class="token punctuation">(</span>parsed_key<span class="token punctuation">.</span>user_key<span class="token punctuation">,</span> s<span class="token operator">-></span>user_key<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      s<span class="token operator">-></span>state <span class="token operator">=</span> <span class="token punctuation">(</span>parsed_key<span class="token punctuation">.</span>type <span class="token operator">==</span> kTypeValue<span class="token punctuation">)</span> <span class="token operator">?</span> kFound <span class="token operator">:</span> kDeleted<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-></span>state <span class="token operator">==</span> kFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        s<span class="token operator">-></span>value<span class="token operator">-></span><span class="token function">assign</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">NewestFirst</span><span class="token punctuation">(</span>FileMetaData<span class="token operator">*</span> a<span class="token punctuation">,</span> FileMetaData<span class="token operator">*</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a<span class="token operator">-></span>number <span class="token operator">></span> b<span class="token operator">-></span>number<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">Version</span><span class="token double-colon punctuation">::</span><span class="token function">ForEachOverlapping</span><span class="token punctuation">(</span>Slice user_key<span class="token punctuation">,</span> Slice internal_key<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">,</span>
                                 <span class="token keyword">bool</span> <span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> FileMetaData<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> Comparator<span class="token operator">*</span> ucmp <span class="token operator">=</span> vset_<span class="token operator">-></span>icmp_<span class="token punctuation">.</span><span class="token function">user_comparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Search level-0 in order from newest to oldest.</span>
  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>FileMetaData<span class="token operator">*</span><span class="token operator">></span> tmp<span class="token punctuation">;</span>
  tmp<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>files_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> files_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    FileMetaData<span class="token operator">*</span> f <span class="token operator">=</span> files_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ucmp<span class="token operator">-></span><span class="token function">Compare</span><span class="token punctuation">(</span>user_key<span class="token punctuation">,</span> f<span class="token operator">-></span>smallest<span class="token punctuation">.</span><span class="token function">user_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
        ucmp<span class="token operator">-></span><span class="token function">Compare</span><span class="token punctuation">(</span>user_key<span class="token punctuation">,</span> f<span class="token operator">-></span>largest<span class="token punctuation">.</span><span class="token function">user_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      tmp<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tmp<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span><span class="token function">sort</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tmp<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> NewestFirst<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tmp<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tmp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Search other levels.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> level <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> level <span class="token operator">&lt;</span> config<span class="token double-colon punctuation">::</span>kNumLevels<span class="token punctuation">;</span> level<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    size_t num_files <span class="token operator">=</span> files_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>num_files <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

    <span class="token comment">// Binary search to find earliest index whose largest key >= internal_key.</span>
    <span class="token keyword">uint32_t</span> index <span class="token operator">=</span> <span class="token function">FindFile</span><span class="token punctuation">(</span>vset_<span class="token operator">-></span>icmp_<span class="token punctuation">,</span> files_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">,</span> internal_key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> num_files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      FileMetaData<span class="token operator">*</span> f <span class="token operator">=</span> files_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ucmp<span class="token operator">-></span><span class="token function">Compare</span><span class="token punctuation">(</span>user_key<span class="token punctuation">,</span> f<span class="token operator">-></span>smallest<span class="token punctuation">.</span><span class="token function">user_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// All of "f" is past any data for user_key</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> level<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Status <span class="token class-name">Version</span><span class="token double-colon punctuation">::</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span> options<span class="token punctuation">,</span> <span class="token keyword">const</span> LookupKey<span class="token operator">&amp;</span> k<span class="token punctuation">,</span>
                    std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> value<span class="token punctuation">,</span> GetStats<span class="token operator">*</span> stats<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  stats<span class="token operator">-></span>seek_file <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  stats<span class="token operator">-></span>seek_file_level <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token keyword">struct</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>
    Saver saver<span class="token punctuation">;</span>
    GetStats<span class="token operator">*</span> stats<span class="token punctuation">;</span>
    <span class="token keyword">const</span> ReadOptions<span class="token operator">*</span> options<span class="token punctuation">;</span>
    Slice ikey<span class="token punctuation">;</span>
    FileMetaData<span class="token operator">*</span> last_file_read<span class="token punctuation">;</span>
    <span class="token keyword">int</span> last_file_read_level<span class="token punctuation">;</span>

    VersionSet<span class="token operator">*</span> vset<span class="token punctuation">;</span>
    Status s<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> found<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">Match</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">,</span> FileMetaData<span class="token operator">*</span> f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      State<span class="token operator">*</span> state <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>State<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token operator">-></span>stats<span class="token operator">-></span>seek_file <span class="token operator">==</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span>
          state<span class="token operator">-></span>last_file_read <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// We have had more than one seek for this read.  Charge the 1st file.</span>
        state<span class="token operator">-></span>stats<span class="token operator">-></span>seek_file <span class="token operator">=</span> state<span class="token operator">-></span>last_file_read<span class="token punctuation">;</span>
        state<span class="token operator">-></span>stats<span class="token operator">-></span>seek_file_level <span class="token operator">=</span> state<span class="token operator">-></span>last_file_read_level<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      state<span class="token operator">-></span>last_file_read <span class="token operator">=</span> f<span class="token punctuation">;</span>
      state<span class="token operator">-></span>last_file_read_level <span class="token operator">=</span> level<span class="token punctuation">;</span>

      state<span class="token operator">-></span>s <span class="token operator">=</span> state<span class="token operator">-></span>vset<span class="token operator">-></span>table_cache_<span class="token operator">-></span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token operator">*</span>state<span class="token operator">-></span>options<span class="token punctuation">,</span> f<span class="token operator">-></span>number<span class="token punctuation">,</span>
                                                f<span class="token operator">-></span>file_size<span class="token punctuation">,</span> state<span class="token operator">-></span>ikey<span class="token punctuation">,</span>
                                                <span class="token operator">&amp;</span>state<span class="token operator">-></span>saver<span class="token punctuation">,</span> SaveValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token operator">-></span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        state<span class="token operator">-></span>found <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token operator">-></span>saver<span class="token punctuation">.</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> kNotFound<span class="token operator">:</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token comment">// Keep searching in other files</span>
        <span class="token keyword">case</span> kFound<span class="token operator">:</span>
          state<span class="token operator">-></span>found <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> kDeleted<span class="token operator">:</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> kCorrupt<span class="token operator">:</span>
          state<span class="token operator">-></span>s <span class="token operator">=</span>
              <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"corrupted key for "</span><span class="token punctuation">,</span> state<span class="token operator">-></span>saver<span class="token punctuation">.</span>user_key<span class="token punctuation">)</span><span class="token punctuation">;</span>
          state<span class="token operator">-></span>found <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  State state<span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>found <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>stats <span class="token operator">=</span> stats<span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>last_file_read <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>last_file_read_level <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

  state<span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token operator">&amp;</span>options<span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>ikey <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">internal_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>vset <span class="token operator">=</span> vset_<span class="token punctuation">;</span>

  state<span class="token punctuation">.</span>saver<span class="token punctuation">.</span>state <span class="token operator">=</span> kNotFound<span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>saver<span class="token punctuation">.</span>ucmp <span class="token operator">=</span> vset_<span class="token operator">-></span>icmp_<span class="token punctuation">.</span><span class="token function">user_comparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>saver<span class="token punctuation">.</span>user_key <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">user_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>saver<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>

  <span class="token function">ForEachOverlapping</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>saver<span class="token punctuation">.</span>user_key<span class="token punctuation">,</span> state<span class="token punctuation">.</span>ikey<span class="token punctuation">,</span> <span class="token operator">&amp;</span>state<span class="token punctuation">,</span> <span class="token operator">&amp;</span>State<span class="token double-colon punctuation">::</span>Match<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> state<span class="token punctuation">.</span>found <span class="token operator">?</span> state<span class="token punctuation">.</span>s <span class="token operator">:</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">NotFound</span><span class="token punctuation">(</span><span class="token function">Slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>匿名空间中声明了枚举类 <code>SaverState</code>，为查找操作的四种状态：未找到，找到，删除和中断。<code>Saver</code> 负责记录输入的比较器和 <code>user_key</code>，以及输出的 <code>SaverState</code> 和查找得到的 <code>value</code>。<code>SaveValue</code> 作为查找操作的回调函数，将会在 Seek 操作完成后执行，其参数为 <code>SaverState</code> 及键值对。通过判断 <code>user_key</code> 是否一致，对 <code>SaverState</code> 进行更新。</p>
<p>再来看 <code>Version::Get</code>，其调用的 <code>Version::ForEachOverlapping</code> 会根据 <code>smallest_key</code> 和 <code>largest_key</code> 筛选出要查找的文件，再通过回调函数调用 <code>table_cache_-&gt;Get</code> 进行查找，如果找到合法的结果则调用回调函数 <code>SaveValue</code>，如果回调得到的结果是 <code>kFound</code>，就可以提前返回了。Level 0 的文件由于可能存在重叠，所以每个文件都需要进行判断；而 Level 1 及以上的文件可以使用 <code>FindFile</code> 二分查找了。</p>
<h3 id="3.-版本集-versionset" tabindex="-1"><a href="#3.-%E7%89%88%E6%9C%AC%E9%9B%86-versionset">3. 版本集 VersionSet</a></h3>
<p>首先来看 <code>VersionSet::Builder</code> 的实现：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// A helper class so we can efficiently apply a whole sequence</span>
<span class="token comment">// of edits to a particular state without creating intermediate</span>
<span class="token comment">// Versions that contain full copies of the intermediate state.</span>
<span class="token keyword">class</span> <span class="token class-name">VersionSet</span><span class="token operator">:</span><span class="token base-clause"><span class="token operator">:</span><span class="token class-name">Builder</span></span> <span class="token punctuation">{</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token comment">// Helper to sort by v->files_[file_number].smallest</span>
  <span class="token keyword">struct</span> <span class="token class-name">BySmallestKey</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> InternalKeyComparator<span class="token operator">*</span> internal_comparator<span class="token punctuation">;</span>

    <span class="token keyword">bool</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>FileMetaData<span class="token operator">*</span> f1<span class="token punctuation">,</span> FileMetaData<span class="token operator">*</span> f2<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
      <span class="token keyword">int</span> r <span class="token operator">=</span> internal_comparator<span class="token operator">-></span><span class="token function">Compare</span><span class="token punctuation">(</span>f1<span class="token operator">-></span>smallest<span class="token punctuation">,</span> f2<span class="token operator">-></span>smallest<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>r <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Break ties by file number</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>f1<span class="token operator">-></span>number <span class="token operator">&lt;</span> f2<span class="token operator">-></span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">typedef</span> std<span class="token double-colon punctuation">::</span>set<span class="token operator">&lt;</span>FileMetaData<span class="token operator">*</span><span class="token punctuation">,</span> BySmallestKey<span class="token operator">></span> FileSet<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">LevelState</span> <span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>set<span class="token operator">&lt;</span><span class="token keyword">uint64_t</span><span class="token operator">></span> deleted_files<span class="token punctuation">;</span>
    FileSet<span class="token operator">*</span> added_files<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  VersionSet<span class="token operator">*</span> vset_<span class="token punctuation">;</span>
  Version<span class="token operator">*</span> base_<span class="token punctuation">;</span>
  LevelState levels_<span class="token punctuation">[</span>config<span class="token double-colon punctuation">::</span>kNumLevels<span class="token punctuation">]</span><span class="token punctuation">;</span>

 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token comment">// Initialize a builder with the files from *base and other info from *vset</span>
  <span class="token function">Builder</span><span class="token punctuation">(</span>VersionSet<span class="token operator">*</span> vset<span class="token punctuation">,</span> Version<span class="token operator">*</span> base<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">vset_</span><span class="token punctuation">(</span>vset<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">base_</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    base_<span class="token operator">-></span><span class="token function">Ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    BySmallestKey cmp<span class="token punctuation">;</span>
    cmp<span class="token punctuation">.</span>internal_comparator <span class="token operator">=</span> <span class="token operator">&amp;</span>vset_<span class="token operator">-></span>icmp_<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> level <span class="token operator">&lt;</span> config<span class="token double-colon punctuation">::</span>kNumLevels<span class="token punctuation">;</span> level<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      levels_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">.</span>added_files <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">FileSet</span><span class="token punctuation">(</span>cmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token operator">~</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> level <span class="token operator">&lt;</span> config<span class="token double-colon punctuation">::</span>kNumLevels<span class="token punctuation">;</span> level<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> FileSet<span class="token operator">*</span> added <span class="token operator">=</span> levels_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">.</span>added_files<span class="token punctuation">;</span>
      std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>FileMetaData<span class="token operator">*</span><span class="token operator">></span> to_unref<span class="token punctuation">;</span>
      to_unref<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>added<span class="token operator">-></span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>FileSet<span class="token double-colon punctuation">::</span>const_iterator it <span class="token operator">=</span> added<span class="token operator">-></span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> added<span class="token operator">-></span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token operator">++</span>it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        to_unref<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">delete</span> added<span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> to_unref<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        FileMetaData<span class="token operator">*</span> f <span class="token operator">=</span> to_unref<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        f<span class="token operator">-></span>refs<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>refs <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">delete</span> f<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    base_<span class="token operator">-></span><span class="token function">Unref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Apply all of the edits in *edit to the current state.</span>
  <span class="token keyword">void</span> <span class="token function">Apply</span><span class="token punctuation">(</span>VersionEdit<span class="token operator">*</span> edit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Update compaction pointers</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> edit<span class="token operator">-></span>compact_pointers_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token keyword">int</span> level <span class="token operator">=</span> edit<span class="token operator">-></span>compact_pointers_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>first<span class="token punctuation">;</span>
      vset_<span class="token operator">-></span>compact_pointer_<span class="token punctuation">[</span>level<span class="token punctuation">]</span> <span class="token operator">=</span>
          edit<span class="token operator">-></span>compact_pointers_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>second<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Delete files</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> deleted_file_set_kvp <span class="token operator">:</span> edit<span class="token operator">-></span>deleted_files_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token keyword">int</span> level <span class="token operator">=</span> deleted_file_set_kvp<span class="token punctuation">.</span>first<span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> number <span class="token operator">=</span> deleted_file_set_kvp<span class="token punctuation">.</span>second<span class="token punctuation">;</span>
      levels_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">.</span>deleted_files<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Add new files</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> edit<span class="token operator">-></span>new_files_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token keyword">int</span> level <span class="token operator">=</span> edit<span class="token operator">-></span>new_files_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>first<span class="token punctuation">;</span>
      FileMetaData<span class="token operator">*</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">FileMetaData</span><span class="token punctuation">(</span>edit<span class="token operator">-></span>new_files_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>second<span class="token punctuation">)</span><span class="token punctuation">;</span>
      f<span class="token operator">-></span>refs <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

      <span class="token comment">// We arrange to automatically compact this file after</span>
      <span class="token comment">// a certain number of seeks.  Let's assume:</span>
      <span class="token comment">//   (1) One seek costs 10ms</span>
      <span class="token comment">//   (2) Writing or reading 1MB costs 10ms (100MB/s)</span>
      <span class="token comment">//   (3) A compaction of 1MB does 25MB of IO:</span>
      <span class="token comment">//         1MB read from this level</span>
      <span class="token comment">//         10-12MB read from next level (boundaries may be misaligned)</span>
      <span class="token comment">//         10-12MB written to next level</span>
      <span class="token comment">// This implies that 25 seeks cost the same as the compaction</span>
      <span class="token comment">// of 1MB of data.  I.e., one seek costs approximately the</span>
      <span class="token comment">// same as the compaction of 40KB of data.  We are a little</span>
      <span class="token comment">// conservative and allow approximately one seek for every 16KB</span>
      <span class="token comment">// of data before triggering a compaction.</span>
      f<span class="token operator">-></span>allowed_seeks <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>f<span class="token operator">-></span>file_size <span class="token operator">/</span> <span class="token number">16384U</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>allowed_seeks <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">)</span> f<span class="token operator">-></span>allowed_seeks <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>

      levels_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">.</span>deleted_files<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>f<span class="token operator">-></span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
      levels_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">.</span>added_files<span class="token operator">-></span><span class="token function">insert</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Save the current state in *v.</span>
  <span class="token keyword">void</span> <span class="token function">SaveTo</span><span class="token punctuation">(</span>Version<span class="token operator">*</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    BySmallestKey cmp<span class="token punctuation">;</span>
    cmp<span class="token punctuation">.</span>internal_comparator <span class="token operator">=</span> <span class="token operator">&amp;</span>vset_<span class="token operator">-></span>icmp_<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> level <span class="token operator">&lt;</span> config<span class="token double-colon punctuation">::</span>kNumLevels<span class="token punctuation">;</span> level<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Merge the set of added files with the set of pre-existing files.</span>
      <span class="token comment">// Drop any deleted files.  Store the result in *v.</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>FileMetaData<span class="token operator">*</span><span class="token operator">></span><span class="token operator">&amp;</span> base_files <span class="token operator">=</span> base_<span class="token operator">-></span>files_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">;</span>
      std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>FileMetaData<span class="token operator">*</span><span class="token operator">></span><span class="token double-colon punctuation">::</span>const_iterator base_iter <span class="token operator">=</span> base_files<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>FileMetaData<span class="token operator">*</span><span class="token operator">></span><span class="token double-colon punctuation">::</span>const_iterator base_end <span class="token operator">=</span> base_files<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> FileSet<span class="token operator">*</span> added_files <span class="token operator">=</span> levels_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">.</span>added_files<span class="token punctuation">;</span>
      v<span class="token operator">-></span>files_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>base_files<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> added_files<span class="token operator">-></span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> added_file <span class="token operator">:</span> <span class="token operator">*</span>added_files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Add all smaller files listed in base_</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>FileMetaData<span class="token operator">*</span><span class="token operator">></span><span class="token double-colon punctuation">::</span>const_iterator bpos <span class="token operator">=</span>
                 std<span class="token double-colon punctuation">::</span><span class="token function">upper_bound</span><span class="token punctuation">(</span>base_iter<span class="token punctuation">,</span> base_end<span class="token punctuation">,</span> added_file<span class="token punctuation">,</span> cmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
             base_iter <span class="token operator">!=</span> bpos<span class="token punctuation">;</span> <span class="token operator">++</span>base_iter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">MaybeAddFile</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> level<span class="token punctuation">,</span> <span class="token operator">*</span>base_iter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">MaybeAddFile</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> level<span class="token punctuation">,</span> added_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Add remaining base files</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> base_iter <span class="token operator">!=</span> base_end<span class="token punctuation">;</span> <span class="token operator">++</span>base_iter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">MaybeAddFile</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> level<span class="token punctuation">,</span> <span class="token operator">*</span>base_iter<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">NDEBUG</span></span>
      <span class="token comment">// Make sure there is no overlap in levels > 0</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> v<span class="token operator">-></span>files_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> InternalKey<span class="token operator">&amp;</span> prev_end <span class="token operator">=</span> v<span class="token operator">-></span>files_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-></span>largest<span class="token punctuation">;</span>
          <span class="token keyword">const</span> InternalKey<span class="token operator">&amp;</span> this_begin <span class="token operator">=</span> v<span class="token operator">-></span>files_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>smallest<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>vset_<span class="token operator">-></span>icmp_<span class="token punctuation">.</span><span class="token function">Compare</span><span class="token punctuation">(</span>prev_end<span class="token punctuation">,</span> this_begin<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"overlapping ranges in same level %s vs. %s\n"</span><span class="token punctuation">,</span>
                    prev_end<span class="token punctuation">.</span><span class="token function">DebugString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    this_begin<span class="token punctuation">.</span><span class="token function">DebugString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">MaybeAddFile</span><span class="token punctuation">(</span>Version<span class="token operator">*</span> v<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">,</span> FileMetaData<span class="token operator">*</span> f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>levels_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">.</span>deleted_files<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>f<span class="token operator">-></span>number<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// File is deleted: do nothing</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>FileMetaData<span class="token operator">*</span><span class="token operator">></span><span class="token operator">*</span> files <span class="token operator">=</span> <span class="token operator">&amp;</span>v<span class="token operator">-></span>files_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>files<span class="token operator">-></span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Must not overlap</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>vset_<span class="token operator">-></span>icmp_<span class="token punctuation">.</span><span class="token function">Compare</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>files<span class="token punctuation">)</span><span class="token punctuation">[</span>files<span class="token operator">-></span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-></span>largest<span class="token punctuation">,</span>
                                    f<span class="token operator">-></span>smallest<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      f<span class="token operator">-></span>refs<span class="token operator">++</span><span class="token punctuation">;</span>
      files<span class="token operator">-></span><span class="token function">push_back</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p><code>VersionSet::Builder</code> 中首先定义了一个比较器 <code>BySmallestKey</code>，其会按照文件信息中的 <code>smallest</code> 对文件信息集合 <code>FileSet</code> 中存储的  <code>FileMetaData</code> 排序；定义的结构体 <code>LevelState</code> 中则包括删除的文件编号列表 <code>deleted_files</code> 和新增的文件集合 <code>added_files</code>，<code>VersionSet::Builder</code> 的成员 <code>levels_</code> 则储存所有 Level 的 <code>LevelState</code>。<code>Builder</code> 的构造和析构完成必要的内存申请和释放，成员还包括版本集 <code>vset_</code> 和基础版本 <code>base</code>，核心接口为 <code>Apply</code> 和 <code>SaveTo</code>。<code>Apply</code> 函数中先忽略 <code>compact_pointer_</code> 相关的操作，剩下的就是将 <code>edit</code> 中的增删文件信息插入到 <code>Builder::levels_</code> 里；而 <code>SaveTo</code> 则是将基础版本 <code>base</code> 中的文件信息和 <code>edit</code> 中的增删文件信息合并，按顺序插入到新版本 <code>v</code> 里。</p>
<p>接着来看 <code>VersionSet</code> 的定义 <a href="https://github.com/google/leveldb/blob/master/db/version_set.h"><code>db/version_set.h</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">VersionSet</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">VersionSet</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> dbname<span class="token punctuation">,</span> <span class="token keyword">const</span> Options<span class="token operator">*</span> options<span class="token punctuation">,</span>
             TableCache<span class="token operator">*</span> table_cache<span class="token punctuation">,</span> <span class="token keyword">const</span> InternalKeyComparator<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">VersionSet</span><span class="token punctuation">(</span><span class="token keyword">const</span> VersionSet<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
  VersionSet<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> VersionSet<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

  <span class="token operator">~</span><span class="token function">VersionSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Apply *edit to the current version to form a new descriptor that</span>
  <span class="token comment">// is both saved to persistent state and installed as the new</span>
  <span class="token comment">// current version.  Will release *mu while actually writing to the file.</span>
  <span class="token comment">// REQUIRES: *mu is held on entry.</span>
  <span class="token comment">// REQUIRES: no other thread concurrently calls LogAndApply()</span>
  Status <span class="token function">LogAndApply</span><span class="token punctuation">(</span>VersionEdit<span class="token operator">*</span> edit<span class="token punctuation">,</span> port<span class="token double-colon punctuation">::</span>Mutex<span class="token operator">*</span> mu<span class="token punctuation">)</span>
      <span class="token function">EXCLUSIVE_LOCKS_REQUIRED</span><span class="token punctuation">(</span>mu<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Recover the last saved descriptor from persistent storage.</span>
  Status <span class="token function">Recover</span><span class="token punctuation">(</span><span class="token keyword">bool</span><span class="token operator">*</span> save_manifest<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Return the current version.</span>
  Version<span class="token operator">*</span> <span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> current_<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token comment">// Return the current manifest file number</span>
  <span class="token keyword">uint64_t</span> <span class="token function">ManifestFileNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> manifest_file_number_<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token comment">// Allocate and return a new file number</span>
  <span class="token keyword">uint64_t</span> <span class="token function">NewFileNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> next_file_number_<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token comment">// Arrange to reuse "file_number" unless a newer file number has</span>
  <span class="token comment">// already been allocated.</span>
  <span class="token comment">// REQUIRES: "file_number" was returned by a call to NewFileNumber().</span>
  <span class="token keyword">void</span> <span class="token function">ReuseFileNumber</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> file_number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>next_file_number_ <span class="token operator">==</span> file_number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      next_file_number_ <span class="token operator">=</span> file_number<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Return the number of Table files at the specified level.</span>
  <span class="token keyword">int</span> <span class="token function">NumLevelFiles</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

  <span class="token comment">// Return the combined file size of all files at the specified level.</span>
  <span class="token keyword">int64_t</span> <span class="token function">NumLevelBytes</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

  <span class="token comment">// Return the last sequence number.</span>
  <span class="token keyword">uint64_t</span> <span class="token function">LastSequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> last_sequence_<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token comment">// Set the last sequence number to s.</span>
  <span class="token keyword">void</span> <span class="token function">SetLastSequence</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>s <span class="token operator">>=</span> last_sequence_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    last_sequence_ <span class="token operator">=</span> s<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Mark the specified file number as used.</span>
  <span class="token keyword">void</span> <span class="token function">MarkFileNumberUsed</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Return the current log file number.</span>
  <span class="token keyword">uint64_t</span> <span class="token function">LogNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> log_number_<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token comment">// Return the log file number for the log file that is currently</span>
  <span class="token comment">// being compacted, or zero if there is no such log file.</span>
  <span class="token keyword">uint64_t</span> <span class="token function">PrevLogNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> prev_log_number_<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token comment">// Pick level and inputs for a new compaction.</span>
  <span class="token comment">// Returns nullptr if there is no compaction to be done.</span>
  <span class="token comment">// Otherwise returns a pointer to a heap-allocated object that</span>
  <span class="token comment">// describes the compaction.  Caller should delete the result.</span>
  Compaction<span class="token operator">*</span> <span class="token function">PickCompaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Return a compaction object for compacting the range [begin,end] in</span>
  <span class="token comment">// the specified level.  Returns nullptr if there is nothing in that</span>
  <span class="token comment">// level that overlaps the specified range.  Caller should delete</span>
  <span class="token comment">// the result.</span>
  Compaction<span class="token operator">*</span> <span class="token function">CompactRange</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">const</span> InternalKey<span class="token operator">*</span> begin<span class="token punctuation">,</span>
                           <span class="token keyword">const</span> InternalKey<span class="token operator">*</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Return the maximum overlapping data (in bytes) at next level for any</span>
  <span class="token comment">// file at a level >= 1.</span>
  <span class="token keyword">int64_t</span> <span class="token function">MaxNextLevelOverlappingBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Create an iterator that reads over the compaction inputs for "*c".</span>
  <span class="token comment">// The caller should delete the iterator when no longer needed.</span>
  Iterator<span class="token operator">*</span> <span class="token function">MakeInputIterator</span><span class="token punctuation">(</span>Compaction<span class="token operator">*</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Returns true iff some level needs a compaction.</span>
  <span class="token keyword">bool</span> <span class="token function">NeedsCompaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    Version<span class="token operator">*</span> v <span class="token operator">=</span> current_<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>v<span class="token operator">-></span>compaction_score_ <span class="token operator">>=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>v<span class="token operator">-></span>file_to_compact_ <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Add all files listed in any live version to *live.</span>
  <span class="token comment">// May also mutate some internal state.</span>
  <span class="token keyword">void</span> <span class="token function">AddLiveFiles</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>set<span class="token operator">&lt;</span><span class="token keyword">uint64_t</span><span class="token operator">></span><span class="token operator">*</span> live<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Return the approximate offset in the database of the data for</span>
  <span class="token comment">// "key" as of version "v".</span>
  <span class="token keyword">uint64_t</span> <span class="token function">ApproximateOffsetOf</span><span class="token punctuation">(</span>Version<span class="token operator">*</span> v<span class="token punctuation">,</span> <span class="token keyword">const</span> InternalKey<span class="token operator">&amp;</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Return a human-readable short (single-line) summary of the number</span>
  <span class="token comment">// of files per level.  Uses *scratch as backing store.</span>
  <span class="token keyword">struct</span> <span class="token class-name">LevelSummaryStorage</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">LevelSummary</span><span class="token punctuation">(</span>LevelSummaryStorage<span class="token operator">*</span> scratch<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">class</span> <span class="token class-name">Builder</span><span class="token punctuation">;</span>

  <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">Compaction</span><span class="token punctuation">;</span>
  <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">Version</span><span class="token punctuation">;</span>

  <span class="token keyword">bool</span> <span class="token function">ReuseManifest</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> dscname<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> dscbase<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">Finalize</span><span class="token punctuation">(</span>Version<span class="token operator">*</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">GetRange</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>FileMetaData<span class="token operator">*</span><span class="token operator">></span><span class="token operator">&amp;</span> inputs<span class="token punctuation">,</span> InternalKey<span class="token operator">*</span> smallest<span class="token punctuation">,</span>
                InternalKey<span class="token operator">*</span> largest<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">GetRange2</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>FileMetaData<span class="token operator">*</span><span class="token operator">></span><span class="token operator">&amp;</span> inputs1<span class="token punctuation">,</span>
                 <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>FileMetaData<span class="token operator">*</span><span class="token operator">></span><span class="token operator">&amp;</span> inputs2<span class="token punctuation">,</span>
                 InternalKey<span class="token operator">*</span> smallest<span class="token punctuation">,</span> InternalKey<span class="token operator">*</span> largest<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">SetupOtherInputs</span><span class="token punctuation">(</span>Compaction<span class="token operator">*</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Save current contents to *log</span>
  Status <span class="token function">WriteSnapshot</span><span class="token punctuation">(</span>log<span class="token double-colon punctuation">::</span>Writer<span class="token operator">*</span> log<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">AppendVersion</span><span class="token punctuation">(</span>Version<span class="token operator">*</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>

  Env<span class="token operator">*</span> <span class="token keyword">const</span> env_<span class="token punctuation">;</span>
  <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string dbname_<span class="token punctuation">;</span>
  <span class="token keyword">const</span> Options<span class="token operator">*</span> <span class="token keyword">const</span> options_<span class="token punctuation">;</span>
  TableCache<span class="token operator">*</span> <span class="token keyword">const</span> table_cache_<span class="token punctuation">;</span>
  <span class="token keyword">const</span> InternalKeyComparator icmp_<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> next_file_number_<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> manifest_file_number_<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> last_sequence_<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> log_number_<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> prev_log_number_<span class="token punctuation">;</span>  <span class="token comment">// 0 or backing store for memtable being compacted</span>

  <span class="token comment">// Opened lazily</span>
  WritableFile<span class="token operator">*</span> descriptor_file_<span class="token punctuation">;</span>
  log<span class="token double-colon punctuation">::</span>Writer<span class="token operator">*</span> descriptor_log_<span class="token punctuation">;</span>
  Version dummy_versions_<span class="token punctuation">;</span>  <span class="token comment">// Head of circular doubly-linked list of versions.</span>
  Version<span class="token operator">*</span> current_<span class="token punctuation">;</span>        <span class="token comment">// == dummy_versions_.prev_</span>

  <span class="token comment">// Per-level key at which the next compaction at that level should start.</span>
  <span class="token comment">// Either an empty string, or a valid InternalKey.</span>
  std<span class="token double-colon punctuation">::</span>string compact_pointer_<span class="token punctuation">[</span>config<span class="token double-colon punctuation">::</span>kNumLevels<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre>
<p>定义很长，先放着，继续看实现的部分（顺序经过重排）：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">Version</span><span class="token double-colon punctuation">::</span><span class="token function">Ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">++</span>refs_<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">Version</span><span class="token double-colon punctuation">::</span><span class="token function">Unref</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">!=</span> <span class="token operator">&amp;</span>vset_<span class="token operator">-></span>dummy_versions_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>refs_ <span class="token operator">>=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">--</span>refs_<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>refs_ <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">Version</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">Version</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>refs_ <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Remove from linked list</span>
  prev_<span class="token operator">-></span>next_ <span class="token operator">=</span> next_<span class="token punctuation">;</span>
  next_<span class="token operator">-></span>prev_ <span class="token operator">=</span> prev_<span class="token punctuation">;</span>

  <span class="token comment">// Drop references to files</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> level <span class="token operator">&lt;</span> config<span class="token double-colon punctuation">::</span>kNumLevels<span class="token punctuation">;</span> level<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> files_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      FileMetaData<span class="token operator">*</span> f <span class="token operator">=</span> files_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>f<span class="token operator">-></span>refs <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      f<span class="token operator">-></span>refs<span class="token operator">--</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>refs <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">delete</span> f<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">VersionSet</span><span class="token double-colon punctuation">::</span><span class="token function">VersionSet</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> dbname<span class="token punctuation">,</span> <span class="token keyword">const</span> Options<span class="token operator">*</span> options<span class="token punctuation">,</span>
                       TableCache<span class="token operator">*</span> table_cache<span class="token punctuation">,</span>
                       <span class="token keyword">const</span> InternalKeyComparator<span class="token operator">*</span> cmp<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">env_</span><span class="token punctuation">(</span>options<span class="token operator">-></span>env<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">dbname_</span><span class="token punctuation">(</span>dbname<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">options_</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">table_cache_</span><span class="token punctuation">(</span>table_cache<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">icmp_</span><span class="token punctuation">(</span><span class="token operator">*</span>cmp<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">next_file_number_</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">manifest_file_number_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// Filled by Recover()</span>
      <span class="token function">last_sequence_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">log_number_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">prev_log_number_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">descriptor_file_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">descriptor_log_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">dummy_versions_</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">current_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">AppendVersion</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Version</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">VersionSet</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">VersionSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  current_<span class="token operator">-></span><span class="token function">Unref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>dummy_versions_<span class="token punctuation">.</span>next_ <span class="token operator">==</span> <span class="token operator">&amp;</span>dummy_versions_<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// List must be empty</span>
  <span class="token keyword">delete</span> descriptor_log_<span class="token punctuation">;</span>
  <span class="token keyword">delete</span> descriptor_file_<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">VersionSet</span><span class="token double-colon punctuation">::</span><span class="token function">AppendVersion</span><span class="token punctuation">(</span>Version<span class="token operator">*</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Make "v" current</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>v<span class="token operator">-></span>refs_ <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>v <span class="token operator">!=</span> current_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current_ <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    current_<span class="token operator">-></span><span class="token function">Unref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  current_ <span class="token operator">=</span> v<span class="token punctuation">;</span>
  v<span class="token operator">-></span><span class="token function">Ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Append to linked list</span>
  v<span class="token operator">-></span>prev_ <span class="token operator">=</span> dummy_versions_<span class="token punctuation">.</span>prev_<span class="token punctuation">;</span>
  v<span class="token operator">-></span>next_ <span class="token operator">=</span> <span class="token operator">&amp;</span>dummy_versions_<span class="token punctuation">;</span>
  v<span class="token operator">-></span>prev_<span class="token operator">-></span>next_ <span class="token operator">=</span> v<span class="token punctuation">;</span>
  v<span class="token operator">-></span>next_<span class="token operator">-></span>prev_ <span class="token operator">=</span> v<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>VersionSet</code> 构造函数的参数包括数据库的 <code>name</code> 和 <code>options</code>，缓存 <code>table_cache</code> 以及内部比较器 <code>cmp</code>。大部分成员变量都初始化为 0 或 <code>nullptr</code>，值得注意的是 <code>next_file_number_=2</code>，还有 <code>dummy_versions_(this)</code>。<code>dummpy_versions_</code> 注释中说明了是版本双向链表的头部，不会有其他实际功能。构造函数中会执行 <code>AppendVersion</code> 增加一个新版本，也就是在双向链表的尾部插入版本 <code>v</code>，并且将 <code>current_</code> 指向这个最新的版本；而析构函数中会要求当 <code>current_</code> 降低引用计数、完成可能的析构后，<code>dummy_versions_</code> 所指向的双向链表为空。继续看：</p>
<pre class="language-cpp"><code class="language-cpp">Status <span class="token class-name">VersionSet</span><span class="token double-colon punctuation">::</span><span class="token function">LogAndApply</span><span class="token punctuation">(</span>VersionEdit<span class="token operator">*</span> edit<span class="token punctuation">,</span> port<span class="token double-colon punctuation">::</span>Mutex<span class="token operator">*</span> mu<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>edit<span class="token operator">-></span>has_log_number_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>edit<span class="token operator">-></span>log_number_ <span class="token operator">>=</span> log_number_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>edit<span class="token operator">-></span>log_number_ <span class="token operator">&lt;</span> next_file_number_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    edit<span class="token operator">-></span><span class="token function">SetLogNumber</span><span class="token punctuation">(</span>log_number_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>edit<span class="token operator">-></span>has_prev_log_number_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    edit<span class="token operator">-></span><span class="token function">SetPrevLogNumber</span><span class="token punctuation">(</span>prev_log_number_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  edit<span class="token operator">-></span><span class="token function">SetNextFile</span><span class="token punctuation">(</span>next_file_number_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  edit<span class="token operator">-></span><span class="token function">SetLastSequence</span><span class="token punctuation">(</span>last_sequence_<span class="token punctuation">)</span><span class="token punctuation">;</span>

  Version<span class="token operator">*</span> v <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Version</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{</span>
    Builder <span class="token function">builder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> current_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">Apply</span><span class="token punctuation">(</span>edit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">SaveTo</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">Finalize</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Initialize new descriptor log file if necessary by creating</span>
  <span class="token comment">// a temporary file that contains a snapshot of the current version.</span>
  std<span class="token double-colon punctuation">::</span>string new_manifest_file<span class="token punctuation">;</span>
  Status s<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor_log_ <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// No reason to unlock *mu here since we only hit this path in the</span>
    <span class="token comment">// first call to LogAndApply (when opening the database).</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>descriptor_file_ <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    new_manifest_file <span class="token operator">=</span> <span class="token function">DescriptorFileName</span><span class="token punctuation">(</span>dbname_<span class="token punctuation">,</span> manifest_file_number_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    edit<span class="token operator">-></span><span class="token function">SetNextFile</span><span class="token punctuation">(</span>next_file_number_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    s <span class="token operator">=</span> env_<span class="token operator">-></span><span class="token function">NewWritableFile</span><span class="token punctuation">(</span>new_manifest_file<span class="token punctuation">,</span> <span class="token operator">&amp;</span>descriptor_file_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      descriptor_log_ <span class="token operator">=</span> <span class="token keyword">new</span> log<span class="token double-colon punctuation">::</span><span class="token function">Writer</span><span class="token punctuation">(</span>descriptor_file_<span class="token punctuation">)</span><span class="token punctuation">;</span>
      s <span class="token operator">=</span> <span class="token function">WriteSnapshot</span><span class="token punctuation">(</span>descriptor_log_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Unlock during expensive MANIFEST log write</span>
  <span class="token punctuation">{</span>
    mu<span class="token operator">-></span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Write new record to MANIFEST log</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      std<span class="token double-colon punctuation">::</span>string record<span class="token punctuation">;</span>
      edit<span class="token operator">-></span><span class="token function">EncodeTo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
      s <span class="token operator">=</span> descriptor_log_<span class="token operator">-></span><span class="token function">AddRecord</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        s <span class="token operator">=</span> descriptor_file_<span class="token operator">-></span><span class="token function">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">Log</span><span class="token punctuation">(</span>options_<span class="token operator">-></span>info_log<span class="token punctuation">,</span> <span class="token string">"MANIFEST write: %s\n"</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// If we just created a new descriptor file, install it by writing a</span>
    <span class="token comment">// new CURRENT file that points to it.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>new_manifest_file<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      s <span class="token operator">=</span> <span class="token function">SetCurrentFile</span><span class="token punctuation">(</span>env_<span class="token punctuation">,</span> dbname_<span class="token punctuation">,</span> manifest_file_number_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    mu<span class="token operator">-></span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Install the new version</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">AppendVersion</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log_number_ <span class="token operator">=</span> edit<span class="token operator">-></span>log_number_<span class="token punctuation">;</span>
    prev_log_number_ <span class="token operator">=</span> edit<span class="token operator">-></span>prev_log_number_<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> v<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>new_manifest_file<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> descriptor_log_<span class="token punctuation">;</span>
      <span class="token keyword">delete</span> descriptor_file_<span class="token punctuation">;</span>
      descriptor_log_ <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
      descriptor_file_ <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
      env_<span class="token operator">-></span><span class="token function">DeleteFile</span><span class="token punctuation">(</span>new_manifest_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">VersionSet</span><span class="token double-colon punctuation">::</span><span class="token function">Finalize</span><span class="token punctuation">(</span>Version<span class="token operator">*</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Precomputed best level for next compaction</span>
  <span class="token keyword">int</span> best_level <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">double</span> best_score <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> level <span class="token operator">&lt;</span> config<span class="token double-colon punctuation">::</span>kNumLevels <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> level<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">double</span> score<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// We treat level-0 specially by bounding the number of files</span>
      <span class="token comment">// instead of number of bytes for two reasons:</span>
      <span class="token comment">//</span>
      <span class="token comment">// (1) With larger write-buffer sizes, it is nice not to do too</span>
      <span class="token comment">// many level-0 compactions.</span>
      <span class="token comment">//</span>
      <span class="token comment">// (2) The files in level-0 are merged on every read and</span>
      <span class="token comment">// therefore we wish to avoid too many files when the individual</span>
      <span class="token comment">// file size is small (perhaps because of a small write-buffer</span>
      <span class="token comment">// setting, or very high compression ratios, or lots of</span>
      <span class="token comment">// overwrites/deletions).</span>
      score <span class="token operator">=</span> v<span class="token operator">-></span>files_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span>
              <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>config<span class="token double-colon punctuation">::</span>kL0_CompactionTrigger<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Compute the ratio of current size to size limit.</span>
      <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> level_bytes <span class="token operator">=</span> <span class="token function">TotalFileSize</span><span class="token punctuation">(</span>v<span class="token operator">-></span>files_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      score <span class="token operator">=</span>
          <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>level_bytes<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">MaxBytesForLevel</span><span class="token punctuation">(</span>options_<span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>score <span class="token operator">></span> best_score<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      best_level <span class="token operator">=</span> level<span class="token punctuation">;</span>
      best_score <span class="token operator">=</span> score<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  v<span class="token operator">-></span>compaction_level_ <span class="token operator">=</span> best_level<span class="token punctuation">;</span>
  v<span class="token operator">-></span>compaction_score_ <span class="token operator">=</span> best_score<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>核心接口 <code>LogAndApply</code> 会根据当前版本 <code>current_</code> 和修订部分 <code>edit</code>，合成一个新版本 <code>v</code>，而后将修订的记录写入 Manifest 文件中，最后将新版本 <code>AppendVersion</code> 到版本集中作为新的 <code>current_</code>，这样就完成了一个新版本的构建。而 <code>Recover</code> 则对应从 Manifest 中恢复版本的过程。由于 <code>Manifest</code> 记录了所有的版本变更信息，使用 <code>VersionSet::Builder</code> 逐个 <code>Apply</code> 就可以获得存储的最新版本：</p>
<pre class="language-cpp"><code class="language-cpp">Status <span class="token class-name">VersionSet</span><span class="token double-colon punctuation">::</span><span class="token function">Recover</span><span class="token punctuation">(</span><span class="token keyword">bool</span><span class="token operator">*</span> save_manifest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">LogReporter</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> log<span class="token double-colon punctuation">::</span>Reader<span class="token double-colon punctuation">::</span><span class="token class-name">Reporter</span></span> <span class="token punctuation">{</span>
    Status<span class="token operator">*</span> status<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">Corruption</span><span class="token punctuation">(</span>size_t bytes<span class="token punctuation">,</span> <span class="token keyword">const</span> Status<span class="token operator">&amp;</span> s<span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>status<span class="token operator">-></span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token operator">-></span>status <span class="token operator">=</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Read "CURRENT" file, which contains a pointer to the current manifest file</span>
  std<span class="token double-colon punctuation">::</span>string current<span class="token punctuation">;</span>
  Status s <span class="token operator">=</span> <span class="token function">ReadFileToString</span><span class="token punctuation">(</span>env_<span class="token punctuation">,</span> <span class="token function">CurrentFileName</span><span class="token punctuation">(</span>dbname_<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> current<span class="token punctuation">[</span>current<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"CURRENT file does not end with newline"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  current<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token double-colon punctuation">::</span>string dscname <span class="token operator">=</span> dbname_ <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> current<span class="token punctuation">;</span>
  SequentialFile<span class="token operator">*</span> file<span class="token punctuation">;</span>
  s <span class="token operator">=</span> env_<span class="token operator">-></span><span class="token function">NewSequentialFile</span><span class="token punctuation">(</span>dscname<span class="token punctuation">,</span> <span class="token operator">&amp;</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">IsNotFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"CURRENT points to a non-existent file"</span><span class="token punctuation">,</span>
                                s<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">bool</span> have_log_number <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> have_prev_log_number <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> have_next_file <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> have_last_sequence <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> next_file <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> last_sequence <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> log_number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> prev_log_number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  Builder <span class="token function">builder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> current_<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">{</span>
    LogReporter reporter<span class="token punctuation">;</span>
    reporter<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token operator">&amp;</span>s<span class="token punctuation">;</span>
    log<span class="token double-colon punctuation">::</span>Reader <span class="token function">reader</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reporter<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/*checksum*/</span><span class="token punctuation">,</span>
                       <span class="token number">0</span> <span class="token comment">/*initial_offset*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Slice record<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string scratch<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>reader<span class="token punctuation">.</span><span class="token function">ReadRecord</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>record<span class="token punctuation">,</span> <span class="token operator">&amp;</span>scratch<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      VersionEdit edit<span class="token punctuation">;</span>
      s <span class="token operator">=</span> edit<span class="token punctuation">.</span><span class="token function">DecodeFrom</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>edit<span class="token punctuation">.</span>has_comparator_ <span class="token operator">&amp;&amp;</span>
            edit<span class="token punctuation">.</span>comparator_ <span class="token operator">!=</span> icmp_<span class="token punctuation">.</span><span class="token function">user_comparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          s <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">InvalidArgument</span><span class="token punctuation">(</span>
              edit<span class="token punctuation">.</span>comparator_ <span class="token operator">+</span> <span class="token string">" does not match existing comparator "</span><span class="token punctuation">,</span>
              icmp_<span class="token punctuation">.</span><span class="token function">user_comparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        builder<span class="token punctuation">.</span><span class="token function">Apply</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>edit<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>edit<span class="token punctuation">.</span>has_log_number_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log_number <span class="token operator">=</span> edit<span class="token punctuation">.</span>log_number_<span class="token punctuation">;</span>
        have_log_number <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>edit<span class="token punctuation">.</span>has_prev_log_number_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        prev_log_number <span class="token operator">=</span> edit<span class="token punctuation">.</span>prev_log_number_<span class="token punctuation">;</span>
        have_prev_log_number <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>edit<span class="token punctuation">.</span>has_next_file_number_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        next_file <span class="token operator">=</span> edit<span class="token punctuation">.</span>next_file_number_<span class="token punctuation">;</span>
        have_next_file <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>edit<span class="token punctuation">.</span>has_last_sequence_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        last_sequence <span class="token operator">=</span> edit<span class="token punctuation">.</span>last_sequence_<span class="token punctuation">;</span>
        have_last_sequence <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">delete</span> file<span class="token punctuation">;</span>
  file <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>have_next_file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      s <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"no meta-nextfile entry in descriptor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>have_log_number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      s <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"no meta-lognumber entry in descriptor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>have_last_sequence<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      s <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"no last-sequence-number entry in descriptor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>have_prev_log_number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      prev_log_number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">MarkFileNumberUsed</span><span class="token punctuation">(</span>prev_log_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MarkFileNumberUsed</span><span class="token punctuation">(</span>log_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Version<span class="token operator">*</span> v <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Version</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">SaveTo</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Install recovered version</span>
    <span class="token function">Finalize</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">AppendVersion</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    manifest_file_number_ <span class="token operator">=</span> next_file<span class="token punctuation">;</span>
    next_file_number_ <span class="token operator">=</span> next_file <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    last_sequence_ <span class="token operator">=</span> last_sequence<span class="token punctuation">;</span>
    log_number_ <span class="token operator">=</span> log_number<span class="token punctuation">;</span>
    prev_log_number_ <span class="token operator">=</span> prev_log_number<span class="token punctuation">;</span>

    <span class="token comment">// See if we can reuse the existing MANIFEST file.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReuseManifest</span><span class="token punctuation">(</span>dscname<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// No need to save new manifest</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>save_manifest <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">VersionSet</span><span class="token double-colon punctuation">::</span><span class="token function">ReuseManifest</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> dscname<span class="token punctuation">,</span>
                               <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> dscbase<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options_<span class="token operator">-></span>reuse_logs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  FileType manifest_type<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> manifest_number<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> manifest_size<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ParseFileName</span><span class="token punctuation">(</span>dscbase<span class="token punctuation">,</span> <span class="token operator">&amp;</span>manifest_number<span class="token punctuation">,</span> <span class="token operator">&amp;</span>manifest_type<span class="token punctuation">)</span> <span class="token operator">||</span>
      manifest_type <span class="token operator">!=</span> kDescriptorFile <span class="token operator">||</span>
      <span class="token operator">!</span>env_<span class="token operator">-></span><span class="token function">GetFileSize</span><span class="token punctuation">(</span>dscname<span class="token punctuation">,</span> <span class="token operator">&amp;</span>manifest_size<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token comment">// Make new compacted MANIFEST if old one is too big</span>
      manifest_size <span class="token operator">>=</span> <span class="token function">TargetFileSize</span><span class="token punctuation">(</span>options_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">assert</span><span class="token punctuation">(</span>descriptor_file_ <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>descriptor_log_ <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Status r <span class="token operator">=</span> env_<span class="token operator">-></span><span class="token function">NewAppendableFile</span><span class="token punctuation">(</span>dscname<span class="token punctuation">,</span> <span class="token operator">&amp;</span>descriptor_file_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">Log</span><span class="token punctuation">(</span>options_<span class="token operator">-></span>info_log<span class="token punctuation">,</span> <span class="token string">"Reuse MANIFEST: %s\n"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>descriptor_file_ <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">Log</span><span class="token punctuation">(</span>options_<span class="token operator">-></span>info_log<span class="token punctuation">,</span> <span class="token string">"Reusing MANIFEST %s\n"</span><span class="token punctuation">,</span> dscname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  descriptor_log_ <span class="token operator">=</span> <span class="token keyword">new</span> log<span class="token double-colon punctuation">::</span><span class="token function">Writer</span><span class="token punctuation">(</span>descriptor_file_<span class="token punctuation">,</span> manifest_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  manifest_file_number_ <span class="token operator">=</span> manifest_number<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">VersionSet</span><span class="token double-colon punctuation">::</span><span class="token function">MarkFileNumberUsed</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>next_file_number_ <span class="token operator">&lt;=</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    next_file_number_ <span class="token operator">=</span> number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="总结" tabindex="-1"><a href="#%E6%80%BB%E7%BB%93">总结</a></h3>
<p>本篇分析了版本管理相关的代码，包括 <code>VersionEdit</code>、<code>Version</code> 和 <code>VersionSet</code> 的实现。<code>VersionSet</code> 还有一大部分代码是与 Compaction 相关的，将会在下篇中继续分析。</p>

      </div>
      <div id="gitalk-container">
      </div>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2021 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/gitalk.min.js"></script>
    <script src="/dist/main.js"></script>
    <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-61723712-2', 'auto'); ga('send', 'pageview'); </script>
  </body>
</html>
