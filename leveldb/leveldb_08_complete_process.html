<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/gitalk.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>LevelDB 源码分析「八、完整流程」 | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> LevelDB 源码分析「八、完整流程」 </h1>
      </div>
      <div class="markdown">
        <p>本系列之前的数篇博文从面向对象的角度分析了 LevelDB 中的核心组件，理解了每个类的作用。本篇将从面向过程的角度，分析 LevelDB 创建、打开和读写的完整流程。</p>
<h3 id="1.-新建数据库并写入" tabindex="-1"><a href="#1.-%E6%96%B0%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E5%B9%B6%E5%86%99%E5%85%A5">1. 新建数据库并写入</a></h3>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cassert></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"leveldb/db.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  leveldb<span class="token double-colon punctuation">::</span>DB<span class="token operator">*</span> db<span class="token punctuation">;</span>

  <span class="token punctuation">{</span>
    leveldb<span class="token double-colon punctuation">::</span>Options options<span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>create_if_missing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>compression <span class="token operator">=</span> leveldb<span class="token double-colon punctuation">::</span>kNoCompression<span class="token punctuation">;</span>
    leveldb<span class="token double-colon punctuation">::</span>Status status <span class="token operator">=</span> leveldb<span class="token double-colon punctuation">::</span><span class="token class-name">DB</span><span class="token double-colon punctuation">::</span><span class="token function">Open</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token string">"testdb"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">{</span>
    leveldb<span class="token double-colon punctuation">::</span>WriteOptions options<span class="token punctuation">;</span>
    leveldb<span class="token double-colon punctuation">::</span>Status status <span class="token operator">=</span> db<span class="token operator">-></span><span class="token function">Put</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token string">"[Key]"</span><span class="token punctuation">,</span> <span class="token string">"[Value]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">delete</span> db<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>确保当前路径下没有 <code>testdb</code> 目录，然后执行上方的代码。可以在写入前加入 <code>getchar()</code> 中断以观察中间的状态，测试得到的中间状态如下：</p>
<pre class="language-bash"><code class="language-bash">❯ <span class="token function">ls</span> -l
total <span class="token number">24</span>
-rw-r--r--  <span class="token number">1</span> sfzhou  staff     0B Sep  <span class="token number">7</span> <span class="token number">10</span>:02 000003.log
-rw-r--r--  <span class="token number">1</span> sfzhou  staff    16B Sep  <span class="token number">7</span> <span class="token number">10</span>:02 CURRENT
-rw-r--r--  <span class="token number">1</span> sfzhou  staff     0B Sep  <span class="token number">7</span> <span class="token number">10</span>:02 LOCK
-rw-r--r--  <span class="token number">1</span> sfzhou  staff    56B Sep  <span class="token number">7</span> <span class="token number">10</span>:02 LOG
-rw-r--r--  <span class="token number">1</span> sfzhou  staff    50B Sep  <span class="token number">7</span> <span class="token number">10</span>:02 MANIFEST-000002
</code></pre>
<p>待写入完成后，文件 <code>000003.log</code> 的大小变为 34，其余大小不变。</p>
<p>接下来沿着代码一步一步分析，这里推荐使用 VS Code 查看函数实现。首先来看 <code>leveldb::DB::Open</code>：</p>
<pre class="language-cpp"><code class="language-cpp">Status <span class="token class-name">DB</span><span class="token double-colon punctuation">::</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token keyword">const</span> Options<span class="token operator">&amp;</span> options<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> dbname<span class="token punctuation">,</span> DB<span class="token operator">*</span><span class="token operator">*</span> dbptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">*</span>dbptr <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

  DBImpl<span class="token operator">*</span> impl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">DBImpl</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> dbname<span class="token punctuation">)</span><span class="token punctuation">;</span>
  impl<span class="token operator">-></span>mutex_<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  VersionEdit edit<span class="token punctuation">;</span>
  <span class="token comment">// Recover handles create_if_missing, error_if_exists</span>
  <span class="token keyword">bool</span> save_manifest <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  Status s <span class="token operator">=</span> impl<span class="token operator">-></span><span class="token function">Recover</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>edit<span class="token punctuation">,</span> <span class="token operator">&amp;</span>save_manifest<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> impl<span class="token operator">-></span>mem_ <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create new log and a corresponding memtable.</span>
    <span class="token keyword">uint64_t</span> new_log_number <span class="token operator">=</span> impl<span class="token operator">-></span>versions_<span class="token operator">-></span><span class="token function">NewFileNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    WritableFile<span class="token operator">*</span> lfile<span class="token punctuation">;</span>
    s <span class="token operator">=</span> options<span class="token punctuation">.</span>env<span class="token operator">-></span><span class="token function">NewWritableFile</span><span class="token punctuation">(</span><span class="token function">LogFileName</span><span class="token punctuation">(</span>dbname<span class="token punctuation">,</span> new_log_number<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                     <span class="token operator">&amp;</span>lfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      edit<span class="token punctuation">.</span><span class="token function">SetLogNumber</span><span class="token punctuation">(</span>new_log_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
      impl<span class="token operator">-></span>logfile_ <span class="token operator">=</span> lfile<span class="token punctuation">;</span>
      impl<span class="token operator">-></span>logfile_number_ <span class="token operator">=</span> new_log_number<span class="token punctuation">;</span>
      impl<span class="token operator">-></span>log_ <span class="token operator">=</span> <span class="token keyword">new</span> log<span class="token double-colon punctuation">::</span><span class="token function">Writer</span><span class="token punctuation">(</span>lfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
      impl<span class="token operator">-></span>mem_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">MemTable</span><span class="token punctuation">(</span>impl<span class="token operator">-></span>internal_comparator_<span class="token punctuation">)</span><span class="token punctuation">;</span>
      impl<span class="token operator">-></span>mem_<span class="token operator">-></span><span class="token function">Ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> save_manifest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    edit<span class="token punctuation">.</span><span class="token function">SetPrevLogNumber</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// No older logs needed after recovery.</span>
    edit<span class="token punctuation">.</span><span class="token function">SetLogNumber</span><span class="token punctuation">(</span>impl<span class="token operator">-></span>logfile_number_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    s <span class="token operator">=</span> impl<span class="token operator">-></span>versions_<span class="token operator">-></span><span class="token function">LogAndApply</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>edit<span class="token punctuation">,</span> <span class="token operator">&amp;</span>impl<span class="token operator">-></span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    impl<span class="token operator">-></span><span class="token function">DeleteObsoleteFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    impl<span class="token operator">-></span><span class="token function">MaybeScheduleCompaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  impl<span class="token operator">-></span>mutex_<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>impl<span class="token operator">-></span>mem_ <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>dbptr <span class="token operator">=</span> impl<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> impl<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>先给输出参数 <code>*dbptr</code> 赋空指针，然后 new 一个 <code>DBImpl</code> 对象。<code>DBImpl</code> 的构造函数：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token class-name">DBImpl</span><span class="token double-colon punctuation">::</span><span class="token function">DBImpl</span><span class="token punctuation">(</span><span class="token keyword">const</span> Options<span class="token operator">&amp;</span> raw_options<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> dbname<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">env_</span><span class="token punctuation">(</span>raw_options<span class="token punctuation">.</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">internal_comparator_</span><span class="token punctuation">(</span>raw_options<span class="token punctuation">.</span>comparator<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">internal_filter_policy_</span><span class="token punctuation">(</span>raw_options<span class="token punctuation">.</span>filter_policy<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">options_</span><span class="token punctuation">(</span><span class="token function">SanitizeOptions</span><span class="token punctuation">(</span>dbname<span class="token punctuation">,</span> <span class="token operator">&amp;</span>internal_comparator_<span class="token punctuation">,</span>
                               <span class="token operator">&amp;</span>internal_filter_policy_<span class="token punctuation">,</span> raw_options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">owns_info_log_</span><span class="token punctuation">(</span>options_<span class="token punctuation">.</span>info_log <span class="token operator">!=</span> raw_options<span class="token punctuation">.</span>info_log<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">owns_cache_</span><span class="token punctuation">(</span>options_<span class="token punctuation">.</span>block_cache <span class="token operator">!=</span> raw_options<span class="token punctuation">.</span>block_cache<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">dbname_</span><span class="token punctuation">(</span>dbname<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">table_cache_</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">TableCache</span><span class="token punctuation">(</span>dbname_<span class="token punctuation">,</span> options_<span class="token punctuation">,</span> <span class="token function">TableCacheSize</span><span class="token punctuation">(</span>options_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">db_lock_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">shutting_down_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">background_work_finished_signal_</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">mem_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">imm_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">has_imm_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">logfile_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">logfile_number_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">log_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">seed_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">tmp_batch_</span><span class="token punctuation">(</span><span class="token keyword">new</span> WriteBatch<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">background_compaction_scheduled_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">manual_compaction_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">versions_</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">VersionSet</span><span class="token punctuation">(</span>dbname_<span class="token punctuation">,</span> <span class="token operator">&amp;</span>options_<span class="token punctuation">,</span> table_cache_<span class="token punctuation">,</span>
                               <span class="token operator">&amp;</span>internal_comparator_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre>
<p>都是成员变量的初始化，大部分成员置为 0。值得关注的 <code>SanitizeOptions</code> 实现如下：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">V</span><span class="token operator">></span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ClipToRange</span><span class="token punctuation">(</span>T<span class="token operator">*</span> ptr<span class="token punctuation">,</span> V minvalue<span class="token punctuation">,</span> V maxvalue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>V<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token operator">*</span>ptr<span class="token punctuation">)</span> <span class="token operator">></span> maxvalue<span class="token punctuation">)</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> maxvalue<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>V<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token operator">*</span>ptr<span class="token punctuation">)</span> <span class="token operator">&lt;</span> minvalue<span class="token punctuation">)</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> minvalue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
Options <span class="token function">SanitizeOptions</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> dbname<span class="token punctuation">,</span>
                        <span class="token keyword">const</span> InternalKeyComparator<span class="token operator">*</span> icmp<span class="token punctuation">,</span>
                        <span class="token keyword">const</span> InternalFilterPolicy<span class="token operator">*</span> ipolicy<span class="token punctuation">,</span>
                        <span class="token keyword">const</span> Options<span class="token operator">&amp;</span> src<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Options result <span class="token operator">=</span> src<span class="token punctuation">;</span>
  result<span class="token punctuation">.</span>comparator <span class="token operator">=</span> icmp<span class="token punctuation">;</span>
  result<span class="token punctuation">.</span>filter_policy <span class="token operator">=</span> <span class="token punctuation">(</span>src<span class="token punctuation">.</span>filter_policy <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token operator">?</span> ipolicy <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token function">ClipToRange</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>result<span class="token punctuation">.</span>max_open_files<span class="token punctuation">,</span> <span class="token number">64</span> <span class="token operator">+</span> kNumNonTableCacheFiles<span class="token punctuation">,</span> <span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ClipToRange</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>result<span class="token punctuation">.</span>write_buffer_size<span class="token punctuation">,</span> <span class="token number">64</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ClipToRange</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>result<span class="token punctuation">.</span>max_file_size<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ClipToRange</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>result<span class="token punctuation">.</span>block_size<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>info_log <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Open a log file in the same directory as the db</span>
    src<span class="token punctuation">.</span>env<span class="token operator">-></span><span class="token function">CreateDir</span><span class="token punctuation">(</span>dbname<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// In case it does not exist</span>
    src<span class="token punctuation">.</span>env<span class="token operator">-></span><span class="token function">RenameFile</span><span class="token punctuation">(</span><span class="token function">InfoLogFileName</span><span class="token punctuation">(</span>dbname<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">OldInfoLogFileName</span><span class="token punctuation">(</span>dbname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Status s <span class="token operator">=</span> src<span class="token punctuation">.</span>env<span class="token operator">-></span><span class="token function">NewLogger</span><span class="token punctuation">(</span><span class="token function">InfoLogFileName</span><span class="token punctuation">(</span>dbname<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>result<span class="token punctuation">.</span>info_log<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// No place suitable for logging</span>
      result<span class="token punctuation">.</span>info_log <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>block_cache <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result<span class="token punctuation">.</span>block_cache <span class="token operator">=</span> <span class="token function">NewLRUCache</span><span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>SanitizeOptions</code> 函数将原 <code>src</code> 中的属性进行了安全裁剪，并且创建了 <code>dbname</code> 目录、将原 Info Log 文件重命名并创建了新的 Info Log 文件，也就是 <code>testdb/LOG</code> 文件。最后按需创建了 block cache 并返回作为 <code>DBImpl</code> 的 <code>options_</code>。 <code>DBImpl</code> 的构造函数还为 <code>table_cache_</code>、<code>tmp_batch_</code> 和 <code>version_</code> 创建了新对象。</p>
<p>回到 <code>leveldb::DB::Open</code>，创建 <code>DBImpl</code> 后上锁并执行 <code>impl-&gt;Recover</code>：</p>
<pre class="language-cpp"><code class="language-cpp">Status <span class="token class-name">DBImpl</span><span class="token double-colon punctuation">::</span><span class="token function">Recover</span><span class="token punctuation">(</span>VersionEdit<span class="token operator">*</span> edit<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token operator">*</span> save_manifest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  mutex_<span class="token punctuation">.</span><span class="token function">AssertHeld</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Ignore error from CreateDir since the creation of the DB is</span>
  <span class="token comment">// committed only when the descriptor is created, and this directory</span>
  <span class="token comment">// may already exist from a previous failed creation attempt.</span>
  env_<span class="token operator">-></span><span class="token function">CreateDir</span><span class="token punctuation">(</span>dbname_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>db_lock_ <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Status s <span class="token operator">=</span> env_<span class="token operator">-></span><span class="token function">LockFile</span><span class="token punctuation">(</span><span class="token function">LockFileName</span><span class="token punctuation">(</span>dbname_<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>db_lock_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>env_<span class="token operator">-></span><span class="token function">FileExists</span><span class="token punctuation">(</span><span class="token function">CurrentFileName</span><span class="token punctuation">(</span>dbname_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options_<span class="token punctuation">.</span>create_if_missing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      s <span class="token operator">=</span> <span class="token function">NewDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> s<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">InvalidArgument</span><span class="token punctuation">(</span>
          dbname_<span class="token punctuation">,</span> <span class="token string">"does not exist (create_if_missing is false)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options_<span class="token punctuation">.</span>error_if_exists<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">InvalidArgument</span><span class="token punctuation">(</span>dbname_<span class="token punctuation">,</span>
                                     <span class="token string">"exists (error_if_exists is true)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  s <span class="token operator">=</span> versions_<span class="token operator">-></span><span class="token function">Recover</span><span class="token punctuation">(</span>save_manifest<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>尝试创建 dbname 目录且忽略错误，启用文件锁 <code>testdb/LOCK</code> 以阻止其他进程操作当前数据库。由于当前没有 CURRENT 文件，并且我们开启了 <code>options.create_if_missing</code>，这里会继续调用 <code>NewDB</code> 函数：</p>
<pre class="language-cpp"><code class="language-cpp">Status <span class="token class-name">DBImpl</span><span class="token double-colon punctuation">::</span><span class="token function">NewDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  VersionEdit new_db<span class="token punctuation">;</span>
  new_db<span class="token punctuation">.</span><span class="token function">SetComparatorName</span><span class="token punctuation">(</span><span class="token function">user_comparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  new_db<span class="token punctuation">.</span><span class="token function">SetLogNumber</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  new_db<span class="token punctuation">.</span><span class="token function">SetNextFile</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  new_db<span class="token punctuation">.</span><span class="token function">SetLastSequence</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string manifest <span class="token operator">=</span> <span class="token function">DescriptorFileName</span><span class="token punctuation">(</span>dbname_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  WritableFile<span class="token operator">*</span> file<span class="token punctuation">;</span>
  Status s <span class="token operator">=</span> env_<span class="token operator">-></span><span class="token function">NewWritableFile</span><span class="token punctuation">(</span>manifest<span class="token punctuation">,</span> <span class="token operator">&amp;</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">{</span>
    log<span class="token double-colon punctuation">::</span>Writer <span class="token function">log</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string record<span class="token punctuation">;</span>
    new_db<span class="token punctuation">.</span><span class="token function">EncodeTo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
    s <span class="token operator">=</span> log<span class="token punctuation">.</span><span class="token function">AddRecord</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      s <span class="token operator">=</span> file<span class="token operator">-></span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">delete</span> file<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Make "CURRENT" file that points to the new manifest file.</span>
    s <span class="token operator">=</span> <span class="token function">SetCurrentFile</span><span class="token punctuation">(</span>env_<span class="token punctuation">,</span> dbname_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    env_<span class="token operator">-></span><span class="token function">DeleteFile</span><span class="token punctuation">(</span>manifest<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>NewDB</code> 中创建了一个新的 <code>VersionEdit</code> 对象，将日志编号设为 0，MANIFEST 编号设为 1，NextFile 编号自然是 2 了。而后将 <code>VersionEdit</code> 对象转为日志 Record 写入 MANIFEST 文件中，并将 CURRENT 指向该 MANIFEST。</p>
<p>ちょっと待って（桥豆麻袋），先前观察到的 MANIFEST 文件名为 MANIFEST-000002，和这里分析的编号为 1 并不相符，应该是中间发生了什么。回到 <code>DBImpl::Recover</code> 继续看，接下来将会执行 <code>versions_-&gt;Recover</code>，该函数在<a href="/leveldb/leveldb_07_version.html">上一篇文章</a>中有贴出源码，可以翻回去看一下这里不贴了。简述其过程：根据 CURRENT 文件，读取指向的 MANIFEST 文件中的 VersionEdit 记录，并合成 Version。贴一部分与编号相关的代码：</p>
<pre class="language-cpp"><code class="language-cpp">Version<span class="token operator">*</span> v <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Version</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span><span class="token function">SaveTo</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Install recovered version</span>
<span class="token function">Finalize</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">AppendVersion</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
manifest_file_number_ <span class="token operator">=</span> next_file<span class="token punctuation">;</span>
next_file_number_ <span class="token operator">=</span> next_file <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
last_sequence_ <span class="token operator">=</span> last_sequence<span class="token punctuation">;</span>
log_number_ <span class="token operator">=</span> log_number<span class="token punctuation">;</span>
prev_log_number_ <span class="token operator">=</span> prev_log_number<span class="token punctuation">;</span>

<span class="token comment">// See if we can reuse the existing MANIFEST file.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReuseManifest</span><span class="token punctuation">(</span>dscname<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// No need to save new manifest</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token operator">*</span>save_manifest <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>可以看到这里将 <code>manifest_file_number_</code> 设为了 <code>next_file</code>，也就是 2。<code>Options::reuse_logs</code> 默认为关闭状态，故这里会将 <code>save_manifest</code> 设为 <code>true</code>，所以后面保存 MANIFEST 时编号就是 2 了。</p>
<p>回到 <code>DBImpl::Recover</code>，当 <code>versions_-&gt;Recover</code> 执行完成后，会读取当前存在的日志文件。而新数据库并没有日志，中间过程就跳过、直接返回了，进而回到 <code>leveldb::DB::Open</code>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> impl<span class="token operator">-></span>mem_ <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Create new log and a corresponding memtable.</span>
  <span class="token keyword">uint64_t</span> new_log_number <span class="token operator">=</span> impl<span class="token operator">-></span>versions_<span class="token operator">-></span><span class="token function">NewFileNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  WritableFile<span class="token operator">*</span> lfile<span class="token punctuation">;</span>
  s <span class="token operator">=</span> options<span class="token punctuation">.</span>env<span class="token operator">-></span><span class="token function">NewWritableFile</span><span class="token punctuation">(</span><span class="token function">LogFileName</span><span class="token punctuation">(</span>dbname<span class="token punctuation">,</span> new_log_number<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                   <span class="token operator">&amp;</span>lfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    edit<span class="token punctuation">.</span><span class="token function">SetLogNumber</span><span class="token punctuation">(</span>new_log_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    impl<span class="token operator">-></span>logfile_ <span class="token operator">=</span> lfile<span class="token punctuation">;</span>
    impl<span class="token operator">-></span>logfile_number_ <span class="token operator">=</span> new_log_number<span class="token punctuation">;</span>
    impl<span class="token operator">-></span>log_ <span class="token operator">=</span> <span class="token keyword">new</span> log<span class="token double-colon punctuation">::</span><span class="token function">Writer</span><span class="token punctuation">(</span>lfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    impl<span class="token operator">-></span>mem_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">MemTable</span><span class="token punctuation">(</span>impl<span class="token operator">-></span>internal_comparator_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    impl<span class="token operator">-></span>mem_<span class="token operator">-></span><span class="token function">Ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> save_manifest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  edit<span class="token punctuation">.</span><span class="token function">SetPrevLogNumber</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// No older logs needed after recovery.</span>
  edit<span class="token punctuation">.</span><span class="token function">SetLogNumber</span><span class="token punctuation">(</span>impl<span class="token operator">-></span>logfile_number_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  s <span class="token operator">=</span> impl<span class="token operator">-></span>versions_<span class="token operator">-></span><span class="token function">LogAndApply</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>edit<span class="token punctuation">,</span> <span class="token operator">&amp;</span>impl<span class="token operator">-></span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>impl-&gt;mem_</code> 依然保持为空，故申请新的日志编号 3，创建日志文件和对应的内存数据库，也就是 <code>testdb/000003.log</code>。<code>save_manifest</code> 为真，则调用 <code>version_-&gt;LogAndApply</code> 将当前版本 <code>edit</code> 写入文件，也就是最终看到的 <code>testdb/MANIFEST-000002</code>。这里硬核一点，直接看下 MANIFEST 文件的内容：</p>
<pre class="language-bash"><code class="language-bash">❯ hexdump MANIFEST-000002
0000000 <span class="token number">56</span> f9 b8 f8 1c 00 01 01 1a 6c <span class="token number">65</span> <span class="token number">76</span> <span class="token number">65</span> 6c <span class="token number">64</span> <span class="token number">62</span>
0000010 2e <span class="token number">42</span> <span class="token number">79</span> <span class="token number">74</span> <span class="token number">65</span> <span class="token number">77</span> <span class="token number">69</span> <span class="token number">73</span> <span class="token number">65</span> <span class="token number">43</span> 6f 6d <span class="token number">70</span> <span class="token number">61</span> <span class="token number">72</span> <span class="token number">61</span>
0000020 <span class="token number">74</span> 6f <span class="token number">72</span> a4 9c 8b be 08 00 01 02 03 09 00 03 04
0000030 04 00
</code></pre>
<p><code>version_-&gt;LogAndApply</code> 创建 MANIFEST 文件后，会先执行 <code>VersionSet::WriteSnapshot</code>：</p>
<pre class="language-cpp"><code class="language-cpp">Status <span class="token class-name">VersionSet</span><span class="token double-colon punctuation">::</span><span class="token function">WriteSnapshot</span><span class="token punctuation">(</span>log<span class="token double-colon punctuation">::</span>Writer<span class="token operator">*</span> log<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// TODO: Break up into multiple records to reduce memory usage on recovery?</span>

  <span class="token comment">// Save metadata</span>
  VersionEdit edit<span class="token punctuation">;</span>
  edit<span class="token punctuation">.</span><span class="token function">SetComparatorName</span><span class="token punctuation">(</span>icmp_<span class="token punctuation">.</span><span class="token function">user_comparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Save compaction pointers</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> level <span class="token operator">&lt;</span> config<span class="token double-colon punctuation">::</span>kNumLevels<span class="token punctuation">;</span> level<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>compact_pointer_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      InternalKey key<span class="token punctuation">;</span>
      key<span class="token punctuation">.</span><span class="token function">DecodeFrom</span><span class="token punctuation">(</span>compact_pointer_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      edit<span class="token punctuation">.</span><span class="token function">SetCompactPointer</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Save files</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> level <span class="token operator">&lt;</span> config<span class="token double-colon punctuation">::</span>kNumLevels<span class="token punctuation">;</span> level<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>FileMetaData<span class="token operator">*</span><span class="token operator">></span><span class="token operator">&amp;</span> files <span class="token operator">=</span> current_<span class="token operator">-></span>files_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> files<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> FileMetaData<span class="token operator">*</span> f <span class="token operator">=</span> files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      edit<span class="token punctuation">.</span><span class="token function">AddFile</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> f<span class="token operator">-></span>number<span class="token punctuation">,</span> f<span class="token operator">-></span>file_size<span class="token punctuation">,</span> f<span class="token operator">-></span>smallest<span class="token punctuation">,</span> f<span class="token operator">-></span>largest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  std<span class="token double-colon punctuation">::</span>string record<span class="token punctuation">;</span>
  edit<span class="token punctuation">.</span><span class="token function">EncodeTo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> log<span class="token operator">-></span><span class="token function">AddRecord</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这里首先会将比较器的名字作为 Record 写入 MANIFEST 文件中。根据<a href="leveldb_03_write_batch_and_log.html">本系列第三篇博文</a>中分析的日志记录方式，每一条 Record 会有 7 字节的 Header，其中前 4 字节为 CRC 校验值可以不理会，5、6 字节为记录的长度，这里是 <code>0x1c = 28</code>，最后是 Record 类型，这里的类型是 <code>kFullType = 1</code>。而后的 28 字节便是记录了比较器名字的 <code>edit</code> 对象，其内容需要根据编码的方式进行解码：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// Tag numbers for serialized VersionEdit.  These numbers are written to</span>
<span class="token comment">// disk and should not be changed.</span>
<span class="token keyword">enum</span> <span class="token class-name">Tag</span> <span class="token punctuation">{</span>
  kComparator <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
  kLogNumber <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
  kNextFileNumber <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
  kLastSequence <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>
  kCompactPointer <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
  kDeletedFile <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span>
  kNewFile <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">,</span>
  <span class="token comment">// 8 was used for large value refs</span>
  kPrevLogNumber <span class="token operator">=</span> <span class="token number">9</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token class-name">VersionEdit</span><span class="token double-colon punctuation">::</span><span class="token function">EncodeTo</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> dst<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>has_comparator_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">PutVarint32</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> kComparator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PutLengthPrefixedSlice</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> comparator_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>has_log_number_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">PutVarint32</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> kLogNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PutVarint64</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> log_number_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>has_prev_log_number_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">PutVarint32</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> kPrevLogNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PutVarint64</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> prev_log_number_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>has_next_file_number_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">PutVarint32</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> kNextFileNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PutVarint64</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> next_file_number_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>has_last_sequence_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">PutVarint32</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> kLastSequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PutVarint64</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> last_sequence_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> compact_pointers_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">PutVarint32</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> kCompactPointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PutVarint32</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> compact_pointers_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// level</span>
    <span class="token function">PutLengthPrefixedSlice</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> compact_pointers_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>second<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> deleted_file_kvp <span class="token operator">:</span> deleted_files_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">PutVarint32</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> kDeletedFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PutVarint32</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> deleted_file_kvp<span class="token punctuation">.</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// level</span>
    <span class="token function">PutVarint64</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> deleted_file_kvp<span class="token punctuation">.</span>second<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// file number</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> new_files_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> FileMetaData<span class="token operator">&amp;</span> f <span class="token operator">=</span> new_files_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>second<span class="token punctuation">;</span>
    <span class="token function">PutVarint32</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> kNewFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PutVarint32</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> new_files_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// level</span>
    <span class="token function">PutVarint64</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> f<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PutVarint64</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> f<span class="token punctuation">.</span>file_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PutLengthPrefixedSlice</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> f<span class="token punctuation">.</span>smallest<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PutLengthPrefixedSlice</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> f<span class="token punctuation">.</span>largest<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class="language-markup"><code class="language-markup">01 1a 6c 65 76 65 6c 64 62 2e 42 79 74 65 77 69 73 65 43 6f 6d 70 61 72 61 74 6f 72
</code></pre>
<p>这里的 <code>kComparator=1</code>，而后是比较器的长度 <code>0x1a=26</code> 和名字对应的 ASCII 码，<a href="http://www.unit-conversion.info/texttools/hexadecimal/">翻译过来</a>就是 <code>leveldb.BytewiseComparator</code>。之后的第二条记录便是 <code>leveldb::DB:OpenDB</code> 中的 <code>edit</code> 对象的 Record 记录：</p>
<pre class="language-markup"><code class="language-markup">a4 9c 8b be 08 00 01 02 03 09 00 03 04 04 00
</code></pre>
<p>一样的 7 字节 Header，Record 长度为 8，具体内容为：</p>
<ol>
<li><code>kLogNumber=02</code>，对应的日志编号为 3；</li>
<li><code>kPrevLogNumber=09</code>，对应的上一个日志编号为 0；</li>
<li><code>kNextFileNumber=03</code>，对应的下一个文件编号为 4；</li>
<li><code>kLastSequence=04</code>，对应的最新序列号为 0。</li>
</ol>
<p>最后回到 <code>leveldb::DB::OpenDB</code>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  impl<span class="token operator">-></span><span class="token function">DeleteObsoleteFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  impl<span class="token operator">-></span><span class="token function">MaybeScheduleCompaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>创建或恢复成功后，执行 <code>DBImpl::DeleteObsoleteFiles</code> 删除废弃文件：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">DBImpl</span><span class="token double-colon punctuation">::</span><span class="token function">DeleteObsoleteFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  mutex_<span class="token punctuation">.</span><span class="token function">AssertHeld</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bg_error_<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// After a background error, we don't know whether a new version may</span>
    <span class="token comment">// or may not have been committed, so we cannot safely garbage collect.</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Make a set of all of the live files</span>
  std<span class="token double-colon punctuation">::</span>set<span class="token operator">&lt;</span><span class="token keyword">uint64_t</span><span class="token operator">></span> live <span class="token operator">=</span> pending_outputs_<span class="token punctuation">;</span>
  versions_<span class="token operator">-></span><span class="token function">AddLiveFiles</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>live<span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">></span> filenames<span class="token punctuation">;</span>
  env_<span class="token operator">-></span><span class="token function">GetChildren</span><span class="token punctuation">(</span>dbname_<span class="token punctuation">,</span> <span class="token operator">&amp;</span>filenames<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Ignoring errors on purpose</span>
  <span class="token keyword">uint64_t</span> number<span class="token punctuation">;</span>
  FileType type<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">></span> files_to_delete<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> filename <span class="token operator">:</span> filenames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ParseFileName</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token operator">&amp;</span>number<span class="token punctuation">,</span> <span class="token operator">&amp;</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">bool</span> keep <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> kLogFile<span class="token operator">:</span>
          keep <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>number <span class="token operator">>=</span> versions_<span class="token operator">-></span><span class="token function">LogNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                  <span class="token punctuation">(</span>number <span class="token operator">==</span> versions_<span class="token operator">-></span><span class="token function">PrevLogNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> kDescriptorFile<span class="token operator">:</span>
          <span class="token comment">// Keep my manifest file, and any newer incarnations'</span>
          <span class="token comment">// (in case there is a race that allows other incarnations)</span>
          keep <span class="token operator">=</span> <span class="token punctuation">(</span>number <span class="token operator">>=</span> versions_<span class="token operator">-></span><span class="token function">ManifestFileNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> kTableFile<span class="token operator">:</span>
          keep <span class="token operator">=</span> <span class="token punctuation">(</span>live<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token operator">!=</span> live<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> kTempFile<span class="token operator">:</span>
          <span class="token comment">// Any temp files that are currently being written to must</span>
          <span class="token comment">// be recorded in pending_outputs_, which is inserted into "live"</span>
          keep <span class="token operator">=</span> <span class="token punctuation">(</span>live<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token operator">!=</span> live<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> kCurrentFile<span class="token operator">:</span>
        <span class="token keyword">case</span> kDBLockFile<span class="token operator">:</span>
        <span class="token keyword">case</span> kInfoLogFile<span class="token operator">:</span>
          keep <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        files_to_delete<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> kTableFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          table_cache_<span class="token operator">-></span><span class="token function">Evict</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">Log</span><span class="token punctuation">(</span>options_<span class="token punctuation">.</span>info_log<span class="token punctuation">,</span> <span class="token string">"Delete type=%d #%lld\n"</span><span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// While deleting all files unblock other threads. All files being deleted</span>
  <span class="token comment">// have unique names which will not collide with newly created files and</span>
  <span class="token comment">// are therefore safe to delete while allowing other threads to proceed.</span>
  mutex_<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> filename <span class="token operator">:</span> files_to_delete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    env_<span class="token operator">-></span><span class="token function">DeleteFile</span><span class="token punctuation">(</span>dbname_ <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  mutex_<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这里的废弃文件也包括创建不久的 <code>testdb/MANIFEST-000001</code>。至此 <code>leveldb::DB::Open</code> 函数分析完毕。</p>
<p>而后执行的写入操作 <code>db-&gt;Put</code>，会将数据写入日志文件和内存数据库。此时使用的日志文件编号为 3，也就是 <code>testdb/000003.db</code>，其写入后的内容为：</p>
<pre class="language-bash"><code class="language-bash">❯ hexdump 000003.log
0000000 aa a0 <span class="token number">87</span> <span class="token number">24</span> 1b 00 01 01 00 00 00 00 00 00 00 01
0000010 00 00 00 01 05 5b 4b <span class="token number">65</span> <span class="token number">79</span> 5d 07 5b <span class="token number">56</span> <span class="token number">61</span> 6c <span class="token number">75</span>
0000020 <span class="token number">65</span> 5d
</code></pre>
<p>一样的 7 字节 Header，Record 长度为 <code>0x1b=27</code>，内容为 <code>WriteBatch</code> 编码结果。参考<a href="/leveldb/leveldb_03_write_batch_and_log.html">本系列第三篇博文</a>，内容的前 8 字节为序列号，这里是 1；其后的 4 字节为键值对数量，这里也是 1；再后面就是附带长度编码的键值对，分别是 <code>[Key]</code> 和 <code>[Value]</code>。最后代码结束，删除了 <code>db</code> 对象，也就得到了前文叙述的文件状态。</p>
<h3 id="2.-打开数据库并读取" tabindex="-1"><a href="#2.-%E6%89%93%E5%BC%80%E6%95%B0%E6%8D%AE%E5%BA%93%E5%B9%B6%E8%AF%BB%E5%8F%96">2. 打开数据库并读取</a></h3>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cassert></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"leveldb/db.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  leveldb<span class="token double-colon punctuation">::</span>DB<span class="token operator">*</span> db<span class="token punctuation">;</span>

  <span class="token punctuation">{</span>
    leveldb<span class="token double-colon punctuation">::</span>Options options<span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>compression <span class="token operator">=</span> leveldb<span class="token double-colon punctuation">::</span>kNoCompression<span class="token punctuation">;</span>
    leveldb<span class="token double-colon punctuation">::</span>Status status <span class="token operator">=</span> leveldb<span class="token double-colon punctuation">::</span><span class="token class-name">DB</span><span class="token double-colon punctuation">::</span><span class="token function">Open</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token string">"testdb"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>string key <span class="token operator">=</span> <span class="token string">"[Key]"</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string value<span class="token punctuation">;</span>
    leveldb<span class="token double-colon punctuation">::</span>ReadOptions read_options<span class="token punctuation">;</span>
    leveldb<span class="token double-colon punctuation">::</span>Status status <span class="token operator">=</span> db<span class="token operator">-></span><span class="token function">Get</span><span class="token punctuation">(</span>read_options<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Key: "</span> <span class="token operator">&lt;&lt;</span> key <span class="token operator">&lt;&lt;</span> <span class="token string">", Value: "</span> <span class="token operator">&lt;&lt;</span> value <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">delete</span> db<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>在上一节创建的数据库的基础上，执行上方的代码。首先打开数据库，再读取 Key 对应的 Value。最终的数据库文件状态为：</p>
<pre class="language-bash"><code class="language-bash">❯ <span class="token function">ls</span> -l
total <span class="token number">40</span>
-rw-r--r--  <span class="token number">1</span> sfzhou  staff   124B Sep  <span class="token number">7</span> 09:57 000005.ldb
-rw-r--r--  <span class="token number">1</span> sfzhou  staff     0B Sep  <span class="token number">7</span> 09:57 000006.log
-rw-r--r--  <span class="token number">1</span> sfzhou  staff    16B Sep  <span class="token number">7</span> 09:57 CURRENT
-rw-r--r--  <span class="token number">1</span> sfzhou  staff     0B Sep  <span class="token number">7</span> 09:57 LOCK
-rw-r--r--  <span class="token number">1</span> sfzhou  staff   304B Sep  <span class="token number">7</span> 09:57 LOG
-rw-r--r--  <span class="token number">1</span> sfzhou  staff    56B Sep  <span class="token number">7</span> 09:57 LOG.old
-rw-r--r--  <span class="token number">1</span> sfzhou  staff    82B Sep  <span class="token number">7</span> 09:57 MANIFEST-000004
</code></pre>
<p>和之前一样，沿着代码分析打开数据库的流程。<code>DB::Open</code> 前期的步骤一致，直接跳到 <code>impl-&gt;Recover</code>。由于存在 CURRENT 文件，所以就跳过了 <code>NewDB</code> 的步骤。随后依然是 <code>versions_-&gt;Recover</code>，读取 CURRENT 文件、继而读取 MANIFEST。如上一节中所分析的，LogNumber 为 3，NextFileNumber 为 4，故最后新建的 MANIFEST 文件编号为 4。随后回到 <code>impl-&gt;Recover</code> 执行恢复日志文件数据：</p>
<pre class="language-cpp"><code class="language-cpp">Status <span class="token class-name">DBImpl</span><span class="token double-colon punctuation">::</span><span class="token function">Recover</span><span class="token punctuation">(</span>VersionEdit<span class="token operator">*</span> edit<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token operator">*</span> save_manifest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  SequenceNumber <span class="token function">max_sequence</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Recover from all newer log files than the ones named in the</span>
  <span class="token comment">// descriptor (new log files may have been added by the previous</span>
  <span class="token comment">// incarnation without registering them in the descriptor).</span>
  <span class="token comment">//</span>
  <span class="token comment">// Note that PrevLogNumber() is no longer used, but we pay</span>
  <span class="token comment">// attention to it in case we are recovering a database</span>
  <span class="token comment">// produced by an older version of leveldb.</span>
  <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> min_log <span class="token operator">=</span> versions_<span class="token operator">-></span><span class="token function">LogNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> prev_log <span class="token operator">=</span> versions_<span class="token operator">-></span><span class="token function">PrevLogNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">></span> filenames<span class="token punctuation">;</span>
  s <span class="token operator">=</span> env_<span class="token operator">-></span><span class="token function">GetChildren</span><span class="token punctuation">(</span>dbname_<span class="token punctuation">,</span> <span class="token operator">&amp;</span>filenames<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  std<span class="token double-colon punctuation">::</span>set<span class="token operator">&lt;</span><span class="token keyword">uint64_t</span><span class="token operator">></span> expected<span class="token punctuation">;</span>
  versions_<span class="token operator">-></span><span class="token function">AddLiveFiles</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>expected<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> number<span class="token punctuation">;</span>
  FileType type<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">uint64_t</span><span class="token operator">></span> logs<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> filenames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ParseFileName</span><span class="token punctuation">(</span>filenames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>number<span class="token punctuation">,</span> <span class="token operator">&amp;</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      expected<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> kLogFile <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>number <span class="token operator">>=</span> min_log<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>number <span class="token operator">==</span> prev_log<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        logs<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>expected<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">snprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%d missing files; e.g."</span><span class="token punctuation">,</span>
             <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>expected<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token function">TableFileName</span><span class="token punctuation">(</span>dbname_<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>expected<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Recover in the order in which the logs were generated</span>
  std<span class="token double-colon punctuation">::</span><span class="token function">sort</span><span class="token punctuation">(</span>logs<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> logs<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> logs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s <span class="token operator">=</span> <span class="token function">RecoverLogFile</span><span class="token punctuation">(</span>logs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> logs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> save_manifest<span class="token punctuation">,</span> edit<span class="token punctuation">,</span>
                       <span class="token operator">&amp;</span>max_sequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// The previous incarnation may not have written any MANIFEST</span>
    <span class="token comment">// records after allocating this log number.  So we manually</span>
    <span class="token comment">// update the file number allocation counter in VersionSet.</span>
    versions_<span class="token operator">-></span><span class="token function">MarkFileNumberUsed</span><span class="token punctuation">(</span>logs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>versions_<span class="token operator">-></span><span class="token function">LastSequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> max_sequence<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    versions_<span class="token operator">-></span><span class="token function">SetLastSequence</span><span class="token punctuation">(</span>max_sequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>搜索数据库目录下的、符合条件的日志文件，然后执行 <code>DBImpl::RecoverLogFile</code> 进行恢复：</p>
<pre class="language-cpp"><code class="language-cpp">Status <span class="token class-name">DBImpl</span><span class="token double-colon punctuation">::</span><span class="token function">RecoverLogFile</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> log_number<span class="token punctuation">,</span> <span class="token keyword">bool</span> last_log<span class="token punctuation">,</span>
                              <span class="token keyword">bool</span><span class="token operator">*</span> save_manifest<span class="token punctuation">,</span> VersionEdit<span class="token operator">*</span> edit<span class="token punctuation">,</span>
                              SequenceNumber<span class="token operator">*</span> max_sequence<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">LogReporter</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> log<span class="token double-colon punctuation">::</span>Reader<span class="token double-colon punctuation">::</span><span class="token class-name">Reporter</span></span> <span class="token punctuation">{</span>
    Env<span class="token operator">*</span> env<span class="token punctuation">;</span>
    Logger<span class="token operator">*</span> info_log<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> fname<span class="token punctuation">;</span>
    Status<span class="token operator">*</span> status<span class="token punctuation">;</span>  <span class="token comment">// null if options_.paranoid_checks==false</span>
    <span class="token keyword">void</span> <span class="token function">Corruption</span><span class="token punctuation">(</span>size_t bytes<span class="token punctuation">,</span> <span class="token keyword">const</span> Status<span class="token operator">&amp;</span> s<span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{</span>
      <span class="token function">Log</span><span class="token punctuation">(</span>info_log<span class="token punctuation">,</span> <span class="token string">"%s%s: dropping %d bytes; %s"</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>status <span class="token operator">==</span> <span class="token keyword">nullptr</span> <span class="token operator">?</span> <span class="token string">"(ignoring error) "</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fname<span class="token punctuation">,</span>
          <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>status <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token operator">-></span>status<span class="token operator">-></span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token operator">-></span>status <span class="token operator">=</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  mutex_<span class="token punctuation">.</span><span class="token function">AssertHeld</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Open the log file</span>
  std<span class="token double-colon punctuation">::</span>string fname <span class="token operator">=</span> <span class="token function">LogFileName</span><span class="token punctuation">(</span>dbname_<span class="token punctuation">,</span> log_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
  SequentialFile<span class="token operator">*</span> file<span class="token punctuation">;</span>
  Status status <span class="token operator">=</span> env_<span class="token operator">-></span><span class="token function">NewSequentialFile</span><span class="token punctuation">(</span>fname<span class="token punctuation">,</span> <span class="token operator">&amp;</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">MaybeIgnoreError</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> status<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Create the log reader.</span>
  LogReporter reporter<span class="token punctuation">;</span>
  reporter<span class="token punctuation">.</span>env <span class="token operator">=</span> env_<span class="token punctuation">;</span>
  reporter<span class="token punctuation">.</span>info_log <span class="token operator">=</span> options_<span class="token punctuation">.</span>info_log<span class="token punctuation">;</span>
  reporter<span class="token punctuation">.</span>fname <span class="token operator">=</span> fname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  reporter<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token punctuation">(</span>options_<span class="token punctuation">.</span>paranoid_checks <span class="token operator">?</span> <span class="token operator">&amp;</span>status <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// We intentionally make log::Reader do checksumming even if</span>
  <span class="token comment">// paranoid_checks==false so that corruptions cause entire commits</span>
  <span class="token comment">// to be skipped instead of propagating bad information (like overly</span>
  <span class="token comment">// large sequence numbers).</span>
  log<span class="token double-colon punctuation">::</span>Reader <span class="token function">reader</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reporter<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/*checksum*/</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment">/*initial_offset*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">Log</span><span class="token punctuation">(</span>options_<span class="token punctuation">.</span>info_log<span class="token punctuation">,</span> <span class="token string">"Recovering log #%llu"</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span>log_number<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Read all the records and add to a memtable</span>
  std<span class="token double-colon punctuation">::</span>string scratch<span class="token punctuation">;</span>
  Slice record<span class="token punctuation">;</span>
  WriteBatch batch<span class="token punctuation">;</span>
  <span class="token keyword">int</span> compactions <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  MemTable<span class="token operator">*</span> mem <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>reader<span class="token punctuation">.</span><span class="token function">ReadRecord</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>record<span class="token punctuation">,</span> <span class="token operator">&amp;</span>scratch<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      reporter<span class="token punctuation">.</span><span class="token function">Corruption</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"log record too small"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">WriteBatchInternal</span><span class="token double-colon punctuation">::</span><span class="token function">SetContents</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>batch<span class="token punctuation">,</span> record<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">MemTable</span><span class="token punctuation">(</span>internal_comparator_<span class="token punctuation">)</span><span class="token punctuation">;</span>
      mem<span class="token operator">-></span><span class="token function">Ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    status <span class="token operator">=</span> <span class="token class-name">WriteBatchInternal</span><span class="token double-colon punctuation">::</span><span class="token function">InsertInto</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>batch<span class="token punctuation">,</span> mem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MaybeIgnoreError</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> SequenceNumber last_seq <span class="token operator">=</span> <span class="token class-name">WriteBatchInternal</span><span class="token double-colon punctuation">::</span><span class="token function">Sequence</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>batch<span class="token punctuation">)</span> <span class="token operator">+</span>
                                    <span class="token class-name">WriteBatchInternal</span><span class="token double-colon punctuation">::</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>batch<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>last_seq <span class="token operator">></span> <span class="token operator">*</span>max_sequence<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>max_sequence <span class="token operator">=</span> last_seq<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mem<span class="token operator">-></span><span class="token function">ApproximateMemoryUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> options_<span class="token punctuation">.</span>write_buffer_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      compactions<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token operator">*</span>save_manifest <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      status <span class="token operator">=</span> <span class="token function">WriteLevel0Table</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> edit<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      mem<span class="token operator">-></span><span class="token function">Unref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      mem <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Reflect errors immediately so that conditions like full</span>
        <span class="token comment">// file-systems cause the DB::Open() to fail.</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">delete</span> file<span class="token punctuation">;</span>

  <span class="token comment">// See if we should keep reusing the last log file.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> options_<span class="token punctuation">.</span>reuse_logs <span class="token operator">&amp;&amp;</span> last_log <span class="token operator">&amp;&amp;</span> compactions <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>logfile_ <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>log_ <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>mem_ <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">uint64_t</span> lfile_size<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>env_<span class="token operator">-></span><span class="token function">GetFileSize</span><span class="token punctuation">(</span>fname<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lfile_size<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        env_<span class="token operator">-></span><span class="token function">NewAppendableFile</span><span class="token punctuation">(</span>fname<span class="token punctuation">,</span> <span class="token operator">&amp;</span>logfile_<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">Log</span><span class="token punctuation">(</span>options_<span class="token punctuation">.</span>info_log<span class="token punctuation">,</span> <span class="token string">"Reusing old log %s \n"</span><span class="token punctuation">,</span> fname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      log_ <span class="token operator">=</span> <span class="token keyword">new</span> log<span class="token double-colon punctuation">::</span><span class="token function">Writer</span><span class="token punctuation">(</span>logfile_<span class="token punctuation">,</span> lfile_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
      logfile_number_ <span class="token operator">=</span> log_number<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mem_ <span class="token operator">=</span> mem<span class="token punctuation">;</span>
        mem <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// mem can be nullptr if lognum exists but was empty.</span>
        mem_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">MemTable</span><span class="token punctuation">(</span>internal_comparator_<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mem_<span class="token operator">-></span><span class="token function">Ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// mem did not get reused; compact it.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>save_manifest <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      status <span class="token operator">=</span> <span class="token function">WriteLevel0Table</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> edit<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mem<span class="token operator">-></span><span class="token function">Unref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>DBImpl::RecoverLogFile</code> 将日志文件中的数据读取到内存数据库中，同时更新序列号，最后将内存数据库中的数据写入 Level0 的 Sorted Table 里，也就是最终状态里的 <code>testdb/000005.ldb</code>。执行完成后回到 <code>DBImpl::Recover</code>，再回到 <code>DB::Open</code> 里。再后面就与上一节中的行为一致了。</p>
<p>最后来看下 MANIFEST 的内容：</p>
<pre class="language-bash"><code class="language-bash">❯ hexdump MANIFEST-000004
0000000 <span class="token number">56</span> f9 b8 f8 1c 00 01 01 1a 6c <span class="token number">65</span> <span class="token number">76</span> <span class="token number">65</span> 6c <span class="token number">64</span> <span class="token number">62</span>
0000010 2e <span class="token number">42</span> <span class="token number">79</span> <span class="token number">74</span> <span class="token number">65</span> <span class="token number">77</span> <span class="token number">69</span> <span class="token number">73</span> <span class="token number">65</span> <span class="token number">43</span> 6f 6d <span class="token number">70</span> <span class="token number">61</span> <span class="token number">72</span> <span class="token number">61</span>
0000020 <span class="token number">74</span> 6f <span class="token number">72</span> 9e <span class="token function">bc</span> a9 <span class="token number">67</span> <span class="token number">28</span> 00 01 02 06 09 00 03 07
0000030 04 01 07 00 05 7c 0d 5b 4b <span class="token number">65</span> <span class="token number">79</span> 5d 01 01 00 00
0000040 00 00 00 00 0d 5b 4b <span class="token number">65</span> <span class="token number">79</span> 5d 01 01 00 00 00 00
0000050 00 00
</code></pre>
<p>前面的一段比较器名和上一节中的一致，直接来看第二条记录，也就是第 0x23 个字节开始看。4 字节 CRC，忽略；记录长度为 <code>0x28=40</code>，后面依旧是 <code>VersionEdit</code> 的编码结果：</p>
<ol>
<li><code>kLogNumber=02</code>，对应的日志编号为 6；</li>
<li><code>kPrevLogNumber=09</code>，对应的上一个日志编号为 0；</li>
<li><code>kNextFileNumber=03</code>，对应的下一个文件编号为 7；</li>
<li><code>kLastSequence=04</code>，对应的最新序列号为 1；</li>
<li><code>kNewFile=07</code>，对应新增文件，其 Level 为 0，编号为 5，文件大小 <code>0x7c=124</code>，最小键和最大键都是长度为 <code>0x0d = 13</code> 的 <code>5b 4b 65 79 5d 01 01 00 00 00 00 00 00</code>，格式为 Internal Key。Internal Key 后面的 8 个字节为综合序列号，对应 <code>kTypeValue=1</code>，序列号为 1。</li>
</ol>
<p>至此数据库打开的流程分析完毕。接下来看 <code>leveldb::DB::Get</code>：</p>
<pre class="language-cpp"><code class="language-cpp">Status <span class="token class-name">DBImpl</span><span class="token double-colon punctuation">::</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span> options<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">,</span>
                   std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Status s<span class="token punctuation">;</span>
  MutexLock <span class="token function">l</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  SequenceNumber snapshot<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>snapshot <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    snapshot <span class="token operator">=</span>
        <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> SnapshotImpl<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>snapshot<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">sequence_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    snapshot <span class="token operator">=</span> versions_<span class="token operator">-></span><span class="token function">LastSequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  MemTable<span class="token operator">*</span> mem <span class="token operator">=</span> mem_<span class="token punctuation">;</span>
  MemTable<span class="token operator">*</span> imm <span class="token operator">=</span> imm_<span class="token punctuation">;</span>
  Version<span class="token operator">*</span> current <span class="token operator">=</span> versions_<span class="token operator">-></span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  mem<span class="token operator">-></span><span class="token function">Ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>imm <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> imm<span class="token operator">-></span><span class="token function">Ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  current<span class="token operator">-></span><span class="token function">Ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">bool</span> have_stat_update <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  Version<span class="token double-colon punctuation">::</span>GetStats stats<span class="token punctuation">;</span>

  <span class="token comment">// Unlock while reading from files and memtables</span>
  <span class="token punctuation">{</span>
    mutex_<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// First look in the memtable, then in the immutable memtable (if any).</span>
    LookupKey <span class="token function">lkey</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> snapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mem<span class="token operator">-></span><span class="token function">Get</span><span class="token punctuation">(</span>lkey<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Done</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>imm <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span> imm<span class="token operator">-></span><span class="token function">Get</span><span class="token punctuation">(</span>lkey<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Done</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      s <span class="token operator">=</span> current<span class="token operator">-></span><span class="token function">Get</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> lkey<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stats<span class="token punctuation">)</span><span class="token punctuation">;</span>
      have_stat_update <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mutex_<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>have_stat_update <span class="token operator">&amp;&amp;</span> current<span class="token operator">-></span><span class="token function">UpdateStats</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">MaybeScheduleCompaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  mem<span class="token operator">-></span><span class="token function">Unref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>imm <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> imm<span class="token operator">-></span><span class="token function">Unref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  current<span class="token operator">-></span><span class="token function">Unref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>DBImpl::Get</code> 首先会尝试从内存数据中读取数据，如果找不到则会使用 <code>Version::Get</code> 读取，其过程参见<a href="/leveldb/leveldb_07_version.html">上一篇博文</a>。至此读取的流程也分析完毕。</p>
<h3 id="总结" tabindex="-1"><a href="#%E6%80%BB%E7%BB%93">总结</a></h3>
<ol>
<li>LevelDB 每次打开数据库时都会创建新的 MANIFEST 文件（默认情况下 <code>Options::reuse_logs=false</code>）；</li>
<li>存储在日志中的键值对，会在下一次打开数据库时转为 <code>.ldb</code> 文件。</li>
</ol>

      </div>
      <div id="gitalk-container">
      </div>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2017 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/gitalk.min.js"></script>
    <script src="/dist/main.js"></script>
    <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-61723712-2', 'auto'); ga('send', 'pageview'); </script>
  </body>
</html>
