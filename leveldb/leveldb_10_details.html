<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/gitalk.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>LevelDB 源码分析「十、其他细节」 | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> LevelDB 源码分析「十、其他细节」 </h1>
      </div>
      <div class="info">
        <div class="date"> 2019.09.16 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <p>本篇为 LevelDB 源码分析的最后一篇博文，将会分析 LevelDB 中同步、原子量、单元测试和构建系统的一些细节。</p>
<h3 id="1.-同步-synchronization" tabindex="-1"><a href="#1.-%E5%90%8C%E6%AD%A5-synchronization">1. 同步 Synchronization</a></h3>
<p>LevelDB 中有大量并发访问的场景，也就需要同步的支持。LevelDB 使用的仍然是 C++ 标准库中的互斥量和条件变量，做了简单的封装 <a href="https://github.com/google/leveldb/blob/master/port/port_stdcxx.h"><code>port/port_stdcxx.h</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;condition_variable></span>  <span class="token comment">// NOLINT</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mutex></span>  <span class="token comment">// NOLINT</span></span>

<span class="token comment">// Thinly wraps std::mutex.</span>
<span class="token keyword">class</span> <span class="token class-name">LOCKABLE</span> Mutex <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">Mutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
  <span class="token operator">~</span><span class="token function">Mutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

  <span class="token function">Mutex</span><span class="token punctuation">(</span><span class="token keyword">const</span> Mutex<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
  Mutex<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Mutex<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">EXCLUSIVE_LOCK_FUNCTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> mu_<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">UNLOCK_FUNCTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> mu_<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">AssertHeld</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">ASSERT_EXCLUSIVE_LOCK</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">CondVar</span><span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>mutex mu_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Thinly wraps std::condition_variable.</span>
<span class="token keyword">class</span> <span class="token class-name">CondVar</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">explicit</span> <span class="token function">CondVar</span><span class="token punctuation">(</span>Mutex<span class="token operator">*</span> mu<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">mu_</span><span class="token punctuation">(</span>mu<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">assert</span><span class="token punctuation">(</span>mu <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token operator">~</span><span class="token function">CondVar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

  <span class="token function">CondVar</span><span class="token punctuation">(</span><span class="token keyword">const</span> CondVar<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
  CondVar<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> CondVar<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mu_<span class="token operator">-></span>mu_<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>adopt_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv_<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">Signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> cv_<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">SignalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> cv_<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  std<span class="token double-colon punctuation">::</span>condition_variable cv_<span class="token punctuation">;</span>
  Mutex<span class="token operator">*</span> <span class="token keyword">const</span> mu_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>其中类似 <code>EXCLUSIVE_LOCK_FUNCTION</code> 的宏定义于 <a href="https://github.com/google/leveldb/blob/master/port/thread_annotations.h"><code>port/thread_annotations.h</code></a>，作为线程安全分析的标注，在 Clang 环境下设定 <code>-Wthread-safety</code> 继而在编译期完成线程安全检查，详细资料<a href="https://clang.llvm.org/docs/ThreadSafetyAnalysis.html">参见文献 1</a>。</p>
<p>这里分析一下 <code>DBImpl::Write</code> 中控制同步的部分：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">DBImpl</span> <span class="token punctuation">{</span>
  <span class="token comment">// Queue of writers.</span>
  std<span class="token double-colon punctuation">::</span>deque<span class="token operator">&lt;</span>Writer<span class="token operator">*</span><span class="token operator">></span> writers_ <span class="token function">GUARDED_BY</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  WriteBatch<span class="token operator">*</span> tmp_batch_ <span class="token function">GUARDED_BY</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">// Information kept for every waiting writer</span>
<span class="token keyword">struct</span> <span class="token class-name">DBImpl</span><span class="token operator">:</span><span class="token base-clause"><span class="token operator">:</span><span class="token class-name">Writer</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">explicit</span> <span class="token function">Writer</span><span class="token punctuation">(</span>port<span class="token double-colon punctuation">::</span>Mutex<span class="token operator">*</span> mu<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">batch</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sync</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cv</span><span class="token punctuation">(</span>mu<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  Status status<span class="token punctuation">;</span>
  WriteBatch<span class="token operator">*</span> batch<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> sync<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> done<span class="token punctuation">;</span>
  port<span class="token double-colon punctuation">::</span>CondVar cv<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Status <span class="token class-name">DBImpl</span><span class="token double-colon punctuation">::</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteOptions<span class="token operator">&amp;</span> options<span class="token punctuation">,</span> WriteBatch<span class="token operator">*</span> updates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Writer <span class="token function">w</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  w<span class="token punctuation">.</span>batch <span class="token operator">=</span> updates<span class="token punctuation">;</span>
  w<span class="token punctuation">.</span>sync <span class="token operator">=</span> options<span class="token punctuation">.</span>sync<span class="token punctuation">;</span>
  w<span class="token punctuation">.</span>done <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  MutexLock <span class="token function">l</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  writers_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>w<span class="token punctuation">.</span>done <span class="token operator">&amp;&amp;</span> <span class="token operator">&amp;</span>w <span class="token operator">!=</span> writers_<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    w<span class="token punctuation">.</span>cv<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>w<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> w<span class="token punctuation">.</span>status<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// May temporarily unlock and wait.</span>
  Status status <span class="token operator">=</span> <span class="token function">MakeRoomForWrite</span><span class="token punctuation">(</span>updates <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> last_sequence <span class="token operator">=</span> versions_<span class="token operator">-></span><span class="token function">LastSequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Writer<span class="token operator">*</span> last_writer <span class="token operator">=</span> <span class="token operator">&amp;</span>w<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> updates <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// nullptr batch is for compactions</span>
    WriteBatch<span class="token operator">*</span> updates <span class="token operator">=</span> <span class="token function">BuildBatchGroup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>last_writer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">WriteBatchInternal</span><span class="token double-colon punctuation">::</span><span class="token function">SetSequence</span><span class="token punctuation">(</span>updates<span class="token punctuation">,</span> last_sequence <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    last_sequence <span class="token operator">+=</span> <span class="token class-name">WriteBatchInternal</span><span class="token double-colon punctuation">::</span><span class="token function">Count</span><span class="token punctuation">(</span>updates<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add to log and apply to memtable.  We can release the lock</span>
    <span class="token comment">// during this phase since &amp;w is currently responsible for logging</span>
    <span class="token comment">// and protects against concurrent loggers and concurrent writes</span>
    <span class="token comment">// into mem_.</span>
    <span class="token punctuation">{</span>
      mutex_<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      status <span class="token operator">=</span> log_<span class="token operator">-></span><span class="token function">AddRecord</span><span class="token punctuation">(</span><span class="token class-name">WriteBatchInternal</span><span class="token double-colon punctuation">::</span><span class="token function">Contents</span><span class="token punctuation">(</span>updates<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">bool</span> sync_error <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        status <span class="token operator">=</span> logfile_<span class="token operator">-></span><span class="token function">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          sync_error <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        status <span class="token operator">=</span> <span class="token class-name">WriteBatchInternal</span><span class="token double-colon punctuation">::</span><span class="token function">InsertInto</span><span class="token punctuation">(</span>updates<span class="token punctuation">,</span> mem_<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      mutex_<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// The state of the log file is indeterminate: the log record we</span>
        <span class="token comment">// just added may or may not show up when the DB is re-opened.</span>
        <span class="token comment">// So we force the DB into a mode where all future writes fail.</span>
        <span class="token function">RecordBackgroundError</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>updates <span class="token operator">==</span> tmp_batch_<span class="token punctuation">)</span> tmp_batch_<span class="token operator">-></span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    versions_<span class="token operator">-></span><span class="token function">SetLastSequence</span><span class="token punctuation">(</span>last_sequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Writer<span class="token operator">*</span> ready <span class="token operator">=</span> writers_<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    writers_<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ready <span class="token operator">!=</span> <span class="token operator">&amp;</span>w<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ready<span class="token operator">-></span>status <span class="token operator">=</span> status<span class="token punctuation">;</span>
      ready<span class="token operator">-></span>done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      ready<span class="token operator">-></span>cv<span class="token punctuation">.</span><span class="token function">Signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ready <span class="token operator">==</span> last_writer<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Notify new head of write queue</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>writers_<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    writers_<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>cv<span class="token punctuation">.</span><span class="token function">Signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// REQUIRES: Writer list must be non-empty</span>
<span class="token comment">// REQUIRES: First writer must have a non-null batch</span>
WriteBatch<span class="token operator">*</span> <span class="token class-name">DBImpl</span><span class="token double-colon punctuation">::</span><span class="token function">BuildBatchGroup</span><span class="token punctuation">(</span>Writer<span class="token operator">*</span><span class="token operator">*</span> last_writer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  mutex_<span class="token punctuation">.</span><span class="token function">AssertHeld</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>writers_<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Writer<span class="token operator">*</span> first <span class="token operator">=</span> writers_<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  WriteBatch<span class="token operator">*</span> result <span class="token operator">=</span> first<span class="token operator">-></span>batch<span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  size_t size <span class="token operator">=</span> <span class="token class-name">WriteBatchInternal</span><span class="token double-colon punctuation">::</span><span class="token function">ByteSize</span><span class="token punctuation">(</span>first<span class="token operator">-></span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Allow the group to grow up to a maximum size, but if the</span>
  <span class="token comment">// original write is small, limit the growth so we do not slow</span>
  <span class="token comment">// down the small write too much.</span>
  size_t max_size <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token number">128</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    max_size <span class="token operator">=</span> size <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">128</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token operator">*</span>last_writer <span class="token operator">=</span> first<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>deque<span class="token operator">&lt;</span>Writer<span class="token operator">*</span><span class="token operator">></span><span class="token double-colon punctuation">::</span>iterator iter <span class="token operator">=</span> writers_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">++</span>iter<span class="token punctuation">;</span>  <span class="token comment">// Advance past "first"</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> iter <span class="token operator">!=</span> writers_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>iter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Writer<span class="token operator">*</span> w <span class="token operator">=</span> <span class="token operator">*</span>iter<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>w<span class="token operator">-></span>sync <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>first<span class="token operator">-></span>sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Do not include a sync write into a batch handled by a non-sync write.</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>w<span class="token operator">-></span>batch <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      size <span class="token operator">+=</span> <span class="token class-name">WriteBatchInternal</span><span class="token double-colon punctuation">::</span><span class="token function">ByteSize</span><span class="token punctuation">(</span>w<span class="token operator">-></span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">></span> max_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Do not make batch too big</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Append to *result</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> first<span class="token operator">-></span>batch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Switch to temporary batch instead of disturbing caller's batch</span>
        result <span class="token operator">=</span> tmp_batch_<span class="token punctuation">;</span>
        <span class="token function">assert</span><span class="token punctuation">(</span><span class="token class-name">WriteBatchInternal</span><span class="token double-colon punctuation">::</span><span class="token function">Count</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WriteBatchInternal</span><span class="token double-colon punctuation">::</span><span class="token function">Append</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> first<span class="token operator">-></span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">WriteBatchInternal</span><span class="token double-colon punctuation">::</span><span class="token function">Append</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> w<span class="token operator">-></span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">*</span>last_writer <span class="token operator">=</span> w<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>假设现在有编号为 [1, 2, 3, 4] 的四个线程基本同时调用写入操作，发生的事件如下：</p>
<ol>
<li>每个线程中各自构造 <code>Writer</code>；</li>
<li>1 号线程较快地构造了 <code>MutexLock</code> 拿到锁，[2, 3, 4] 则阻塞在此处；</li>
<li>1 号线程将写入请求插入双向队列中，跳过循环，继续向下走；</li>
<li>1 号线程执行 <code>BuildBatchGroup</code>，由于队列中只有自身一个请求，不会发生合并；</li>
<li>1 号线程执行 <code>mutex_.Unlock()</code> 释放锁，随后执行写入操作，完成后执行 <code>mutex_.Lock()</code> 再次获得锁；</li>
<li>1 号线程在循环中从双向队列里将写入请求弹出，最后通知队列顶的 2 号线程唤醒；</li>
<li>1号线程析构局部变量、释放锁。</li>
</ol>
<p>在第 5 步发生释放锁的同时：</p>
<ol>
<li>2 号线程获得锁，将写入请求插入双向队列中，由于请求不在队列顶端，进而进入循环、等待、释放锁；</li>
<li>3 号线程获得锁，将写入请求插入双向队列中，由于请求不在队列顶端，进而进入循环、等待、释放锁；</li>
<li>此时 1 号线程写入完成、执行 <code>mutex_.Lock()</code> 获得锁，4 号线程继续等待；</li>
<li>1 号线程执行结束、释放锁，2 号线程唤醒获得锁，执行 <code>BuildBatchGroup</code> 将队列中的 3 号线程中的写入请求合并；</li>
<li>2 号线程执行 <code>mutex_.Unlock()</code> 解锁，随后执行写入操作，完成后执行 <code>mutex_.Lock()</code> 再次获得锁。与此同时 4 号线程获得锁，将写入请求插入双向队列中，等待、释放锁；</li>
<li>2 号线程在循环中从双向队列里将写入请求弹出，将 3 号线程的写入请求标记为完成，尝试唤醒 3 号线程；</li>
<li>2 号线程析构局部变量、释放锁。3 号线程唤醒、获得锁，判断已完成，返回、释放锁；</li>
<li>4 号线程唤醒、获得锁，正常执行。</li>
</ol>
<p>上述合并操作依赖写入时的释放锁操作，这使得其他线程有机会加入队列、然后等待，在下一次获得锁时合并队列中的其他写入请求。</p>
<h3 id="2.-原子量-atomic" tabindex="-1"><a href="#2.-%E5%8E%9F%E5%AD%90%E9%87%8F-atomic">2. 原子量 Atomic</a></h3>
<p>由于并发访问，LevelDB 中也大量使用了原子量，且使用了两种不同的内存模型。一种是 Relaxed Ordering，其只保证原子性、不保证并发时的执行顺序，一般在计数功能中使用，例如内存池中的内存使用量：</p>
<pre class="language-cpp"><code class="language-cpp">size_t <span class="token function">MemoryUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> memory_usage_<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">char</span><span class="token operator">*</span> <span class="token class-name">Arena</span><span class="token double-colon punctuation">::</span><span class="token function">AllocateNewBlock</span><span class="token punctuation">(</span>size_t block_bytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span><span class="token operator">*</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span>block_bytes<span class="token punctuation">]</span><span class="token punctuation">;</span>
  blocks_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  memory_usage_<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span>block_bytes <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                          std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>另一种是 Release-Acquire Ordering，其不仅可以保证原子性，还可以保证一定程度的执行顺序。以下摘录自<a href="https://en.cppreference.com/w/cpp/atomic/memory_order#Release-Acquire_ordering">参考文献 7</a>：</p>
<blockquote>
<p>If an atomic store in thread A is tagged <code>memory_order_release</code> and an atomic load in thread B from the same variable is tagged <code>memory_order_acquire</code>, all memory writes (non-atomic and relaxed atomic) that <em>happened-before</em> the atomic store from the point of view of thread A, become <em>visible side-effects</em> in thread B. That is, once the atomic load is completed, thread B is guaranteed to see everything thread A wrote to memory.</p>
</blockquote>
<p>LevelDB 中的使用举例：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">Key</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">Comparator</span><span class="token operator">></span>
<span class="token keyword">class</span> <span class="token class-name">SkipList</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  Node<span class="token operator">*</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>n <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Use an 'acquire load' so that we observe a fully initialized</span>
    <span class="token comment">// version of the returned Node.</span>
    <span class="token keyword">return</span> next_<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">SetNext</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">,</span> Node<span class="token operator">*</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>n <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Use a 'release store' so that anybody who reads through this</span>
    <span class="token comment">// pointer observes a fully initialized version of the inserted node.</span>
    next_<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">Key</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">Comparator</span><span class="token operator">></span>
<span class="token keyword">void</span> <span class="token class-name">SkipList</span><span class="token operator">&lt;</span>Key<span class="token punctuation">,</span> Comparator<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token keyword">const</span> Key<span class="token operator">&amp;</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// TODO(opt): We can use a barrier-free variant of FindGreaterOrEqual()</span>
  <span class="token comment">// here since Insert() is externally synchronized.</span>
  Node<span class="token operator">*</span> prev<span class="token punctuation">[</span>kMaxHeight<span class="token punctuation">]</span><span class="token punctuation">;</span>
  Node<span class="token operator">*</span> x <span class="token operator">=</span> <span class="token function">FindGreaterOrEqual</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> prev<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Our data structure does not allow duplicate insertion</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token keyword">nullptr</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">Equal</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> x<span class="token operator">-></span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> height <span class="token operator">=</span> <span class="token function">RandomHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>height <span class="token operator">></span> <span class="token function">GetMaxHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">GetMaxHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> height<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      prev<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> head_<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// It is ok to mutate max_height_ without any synchronization</span>
    <span class="token comment">// with concurrent readers.  A concurrent reader that observes</span>
    <span class="token comment">// the new value of max_height_ will see either the old value of</span>
    <span class="token comment">// new level pointers from head_ (nullptr), or a new value set in</span>
    <span class="token comment">// the loop below.  In the former case the reader will</span>
    <span class="token comment">// immediately drop to the next level since nullptr sorts after all</span>
    <span class="token comment">// keys.  In the latter case the reader will use the new node.</span>
    max_height_<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>height<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  x <span class="token operator">=</span> <span class="token function">NewNode</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> height<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// NoBarrier_SetNext() suffices since we will add a barrier when</span>
    <span class="token comment">// we publish a pointer to "x" in prev[i].</span>
    x<span class="token operator">-></span><span class="token function">NoBarrier_SetNext</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> prev<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span><span class="token function">NoBarrier_Next</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    prev<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span><span class="token function">SetNext</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="3.-单元测试" tabindex="-1"><a href="#3.-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95">3. 单元测试</a></h3>
<p>LevelDB 中的单元测试并没有使用自家的 <a href="https://github.com/google/googletest">Google Test</a>，而是自己实现了一套简单的测试工具，位于 <a href="https://github.com/google/leveldb/blob/master/util/testharness.h"><code>util/testharness.h</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// An instance of Tester is allocated to hold temporary state during</span>
<span class="token comment">// the execution of an assertion.</span>
<span class="token keyword">class</span> <span class="token class-name">Tester</span> <span class="token punctuation">{</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">bool</span> ok_<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> fname_<span class="token punctuation">;</span>
  <span class="token keyword">int</span> line_<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>stringstream ss_<span class="token punctuation">;</span>

 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">Tester</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> f<span class="token punctuation">,</span> <span class="token keyword">int</span> l<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">ok_</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">fname_</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">line_</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token operator">~</span><span class="token function">Tester</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ok_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s:%d:%s\n"</span><span class="token punctuation">,</span> fname_<span class="token punctuation">,</span> line_<span class="token punctuation">,</span> ss_<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  Tester<span class="token operator">&amp;</span> <span class="token function">Is</span><span class="token punctuation">(</span><span class="token keyword">bool</span> b<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ss_ <span class="token operator">&lt;&lt;</span> <span class="token string">" Assertion failure "</span> <span class="token operator">&lt;&lt;</span> msg<span class="token punctuation">;</span>
      ok_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  Tester<span class="token operator">&amp;</span> <span class="token function">IsOk</span><span class="token punctuation">(</span><span class="token keyword">const</span> Status<span class="token operator">&amp;</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ss_ <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> s<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ok_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BINARY_OP</span><span class="token expression"><span class="token punctuation">(</span>name<span class="token punctuation">,</span> op<span class="token punctuation">)</span>                          </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">X</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">Y</span><span class="token operator">></span>                        </span><span class="token punctuation">\</span>
  <span class="token expression">Tester<span class="token operator">&amp;</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token keyword">const</span> X<span class="token operator">&amp;</span> x<span class="token punctuation">,</span> <span class="token keyword">const</span> Y<span class="token operator">&amp;</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>             </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>x op y<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                 </span><span class="token punctuation">\</span>
      <span class="token expression">ss_ <span class="token operator">&lt;&lt;</span> </span><span class="token string">" failed: "</span> <span class="token expression"><span class="token operator">&lt;&lt;</span> x <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span></span><span class="token string">" "</span> <span class="token expression"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">op</span> </span></span><span class="token string">" "</span><span class="token expression"><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> y<span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
      <span class="token expression">ok_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                                   </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span>                                                </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>                                    </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span></span></span>

  <span class="token function">BINARY_OP</span><span class="token punctuation">(</span>IsEq<span class="token punctuation">,</span> <span class="token operator">==</span><span class="token punctuation">)</span>
  <span class="token function">BINARY_OP</span><span class="token punctuation">(</span>IsNe<span class="token punctuation">,</span> <span class="token operator">!=</span><span class="token punctuation">)</span>
  <span class="token function">BINARY_OP</span><span class="token punctuation">(</span>IsGe<span class="token punctuation">,</span> <span class="token operator">>=</span><span class="token punctuation">)</span>
  <span class="token function">BINARY_OP</span><span class="token punctuation">(</span>IsGt<span class="token punctuation">,</span> <span class="token operator">></span><span class="token punctuation">)</span>
  <span class="token function">BINARY_OP</span><span class="token punctuation">(</span>IsLe<span class="token punctuation">,</span> <span class="token operator">&lt;=</span><span class="token punctuation">)</span>
  <span class="token function">BINARY_OP</span><span class="token punctuation">(</span>IsLt<span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">BINARY_OP</span></span>

  <span class="token comment">// Attach the specified value to the error message if an error has occurred</span>
  <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">V</span><span class="token operator">></span>
  Tester<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token keyword">const</span> V<span class="token operator">&amp;</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ok_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ss_ <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ASSERT_TRUE</span><span class="token expression"><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token double-colon punctuation">::</span>leveldb<span class="token double-colon punctuation">::</span>test<span class="token double-colon punctuation">::</span><span class="token function">Tester</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span> #c<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ASSERT_OK</span><span class="token expression"><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token double-colon punctuation">::</span>leveldb<span class="token double-colon punctuation">::</span>test<span class="token double-colon punctuation">::</span><span class="token function">Tester</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsOk</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ASSERT_EQ</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token double-colon punctuation">::</span>leveldb<span class="token double-colon punctuation">::</span>test<span class="token double-colon punctuation">::</span><span class="token function">Tester</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsEq</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ASSERT_NE</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token double-colon punctuation">::</span>leveldb<span class="token double-colon punctuation">::</span>test<span class="token double-colon punctuation">::</span><span class="token function">Tester</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsNe</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ASSERT_GE</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token double-colon punctuation">::</span>leveldb<span class="token double-colon punctuation">::</span>test<span class="token double-colon punctuation">::</span><span class="token function">Tester</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsGe</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ASSERT_GT</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token double-colon punctuation">::</span>leveldb<span class="token double-colon punctuation">::</span>test<span class="token double-colon punctuation">::</span><span class="token function">Tester</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsGt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ASSERT_LE</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token double-colon punctuation">::</span>leveldb<span class="token double-colon punctuation">::</span>test<span class="token double-colon punctuation">::</span><span class="token function">Tester</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsLe</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ASSERT_LT</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token double-colon punctuation">::</span>leveldb<span class="token double-colon punctuation">::</span>test<span class="token double-colon punctuation">::</span><span class="token function">Tester</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsLt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
</code></pre>
<p><code>BINARY_OP</code> 宏简化了比较运算函数的定义，使用完后及时 <code>undef</code> 也避免了污染。继续：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">TCONCAT</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token function">TCONCAT1</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">TCONCAT1</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> a</span><span class="token punctuation">##</span><span class="token expression">b</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">TEST</span><span class="token expression"><span class="token punctuation">(</span>base<span class="token punctuation">,</span> name<span class="token punctuation">)</span>                                              </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">class</span> <span class="token class-name">TCONCAT</span><span class="token punctuation">(</span>_Test_<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">public</span> base <span class="token punctuation">{</span>                         </span><span class="token punctuation">\</span>
   <span class="token expression"><span class="token keyword">public</span><span class="token operator">:</span>                                                            </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">void</span> <span class="token function">_Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                      </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_RunIt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                            </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token function">TCONCAT</span><span class="token punctuation">(</span>_Test_<span class="token punctuation">,</span> name<span class="token punctuation">)</span> t<span class="token punctuation">;</span>                                        </span><span class="token punctuation">\</span>
      <span class="token expression">t<span class="token punctuation">.</span><span class="token function">_Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                       </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span>                                                                 </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span><span class="token punctuation">;</span>                                                                  </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">bool</span> <span class="token function">TCONCAT</span><span class="token punctuation">(</span>_Test_ignored_<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>leveldb<span class="token double-colon punctuation">::</span>test<span class="token double-colon punctuation">::</span><span class="token function">RegisterTest</span><span class="token punctuation">(</span> </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">base</span><span class="token expression"><span class="token punctuation">,</span> #name<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token function">TCONCAT</span><span class="token punctuation">(</span>_Test_<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token double-colon punctuation">::</span>_RunIt<span class="token punctuation">)</span><span class="token punctuation">;</span>                  </span></span></span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">void</span> <span class="token function">TCONCAT</span><span class="token punctuation">(</span>_Test_<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token double-colon punctuation">::</span><span class="token function">_Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>

<span class="token comment">// Register the specified test.  Typically not used directly, but</span>
<span class="token comment">// invoked via the macro expansion of TEST.</span>
<span class="token keyword">bool</span> <span class="token function">RegisterTest</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> base<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>定义 <code>TCONCAT1</code> 宏是为了让 <code>TCONCAT</code> 像函数一样支持嵌套调用。全局变量 <code>TCONCAT(_Test_ignored_, name)</code> 则可以实现在 <code>main</code> 函数前对测试类进行注册。注册函数和执行所有测试的实现位于 <a href="https://github.com/google/leveldb/blob/master/util/testharness.cc"><code>util/testharness.cc</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">namespace</span> <span class="token punctuation">{</span>
<span class="token keyword">struct</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> base<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Test<span class="token operator">></span><span class="token operator">*</span> tests<span class="token punctuation">;</span>
<span class="token punctuation">}</span>  <span class="token comment">// namespace</span>

<span class="token keyword">bool</span> <span class="token function">RegisterTest</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> base<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tests <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tests <span class="token operator">=</span> <span class="token keyword">new</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Test<span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  Test t<span class="token punctuation">;</span>
  t<span class="token punctuation">.</span>base <span class="token operator">=</span> base<span class="token punctuation">;</span>
  t<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  t<span class="token punctuation">.</span>func <span class="token operator">=</span> func<span class="token punctuation">;</span>
  tests<span class="token operator">-></span><span class="token function">push_back</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">RunAllTests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> matcher <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"LEVELDB_TESTS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tests <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tests<span class="token operator">-></span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> Test<span class="token operator">&amp;</span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>tests<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>matcher <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>string name <span class="token operator">=</span> t<span class="token punctuation">.</span>base<span class="token punctuation">;</span>
        name<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        name<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> matcher<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"==== Test %s.%s\n"</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>base<span class="token punctuation">,</span> t<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">(</span><span class="token operator">*</span>t<span class="token punctuation">.</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">++</span>num<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"==== PASSED %d tests\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="4.-构建系统" tabindex="-1"><a href="#4.-%E6%9E%84%E5%BB%BA%E7%B3%BB%E7%BB%9F">4. 构建系统</a></h3>
<p>LevelDB 使用 CMake 作为其构建系统，搭建了跨平台、可配置的编译系统。例如使用 CMake 变量 <code>WIN32</code> 实现不同环境的编译：</p>
<pre class="language-cmake"><code class="language-cmake"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">WIN32</span><span class="token punctuation">)</span>
  <span class="token keyword">set</span><span class="token punctuation">(</span>LEVELDB_PLATFORM_NAME LEVELDB_PLATFORM_WINDOWS<span class="token punctuation">)</span>
  <span class="token comment"># TODO(cmumford): Make UNICODE configurable for Windows.</span>
  <span class="token keyword">add_definitions</span><span class="token punctuation">(</span>-D_UNICODE -DUNICODE<span class="token punctuation">)</span>
<span class="token keyword">else</span> <span class="token punctuation">(</span><span class="token variable">WIN32</span><span class="token punctuation">)</span>
  <span class="token keyword">set</span><span class="token punctuation">(</span>LEVELDB_PLATFORM_NAME LEVELDB_PLATFORM_POSIX<span class="token punctuation">)</span>
<span class="token keyword">endif</span> <span class="token punctuation">(</span><span class="token variable">WIN32</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">WIN32</span><span class="token punctuation">)</span>
  <span class="token keyword">target_sources</span><span class="token punctuation">(</span>leveldb
    <span class="token namespace">PRIVATE</span>
      <span class="token string">"<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">PROJECT_SOURCE_DIR</span><span class="token punctuation">}</span></span>/util/env_windows.cc"</span>
      <span class="token string">"<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">PROJECT_SOURCE_DIR</span><span class="token punctuation">}</span></span>/util/windows_logger.h"</span>
  <span class="token punctuation">)</span>
<span class="token keyword">else</span> <span class="token punctuation">(</span><span class="token variable">WIN32</span><span class="token punctuation">)</span>
  <span class="token keyword">target_sources</span><span class="token punctuation">(</span>leveldb
    <span class="token namespace">PRIVATE</span>
      <span class="token string">"<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">PROJECT_SOURCE_DIR</span><span class="token punctuation">}</span></span>/util/env_posix.cc"</span>
      <span class="token string">"<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">PROJECT_SOURCE_DIR</span><span class="token punctuation">}</span></span>/util/posix_logger.h"</span>
  <span class="token punctuation">)</span>
<span class="token keyword">endif</span> <span class="token punctuation">(</span><span class="token variable">WIN32</span><span class="token punctuation">)</span>
</code></pre>
<p>使用 <code>configure_file</code> 和 <code>cmakedefine01</code> 将 CMake 中的变量转为代码中的宏定义：</p>
<pre class="language-cmake"><code class="language-cmake"><span class="token function">check_library_exists</span><span class="token punctuation">(</span>crc32c crc32c_value <span class="token string">""</span> HAVE_CRC32C<span class="token punctuation">)</span>

<span class="token keyword">configure_file</span><span class="token punctuation">(</span>
  <span class="token string">"<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">PROJECT_SOURCE_DIR</span><span class="token punctuation">}</span></span>/port/port_config.h.in"</span>
  <span class="token string">"<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">PROJECT_BINARY_DIR</span><span class="token punctuation">}</span></span>/<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">LEVELDB_PORT_CONFIG_DIR</span><span class="token punctuation">}</span></span>/port_config.h"</span>
<span class="token punctuation">)</span>
</code></pre>
<p>对应的 <a href="https://github.com/google/leveldb/blob/master/port/port_config.h.in"><code>port/port_config.h.in</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// Define to 1 if you have Google CRC32C.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>HAVE_CRC32C<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">cmakedefine</span><span class="token expression"><span class="token number">01</span> HAVE_CRC32C</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">// !defined(HAVE_CRC32C)</span></span>

<span class="token comment">/* after compile */</span>
<span class="token comment">// Define to 1 if you have Google CRC32C.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>HAVE_CRC32C<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HAVE_CRC32C</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">// !defined(HAVE_CRC32C</span></span>
</code></pre>
<p>使用 <code>check_cxx_source_compiles</code> 检查编译器的特性：</p>
<pre class="language-cmake"><code class="language-cmake"><span class="token comment"># Test whether -Wthread-safety is available. See</span>
<span class="token comment"># https://clang.llvm.org/docs/ThreadSafetyAnalysis.html</span>
<span class="token comment"># -Werror is necessary because unknown attributes only generate warnings.</span>
<span class="token keyword">set</span><span class="token punctuation">(</span>OLD_CMAKE_REQUIRED_FLAGS <span class="token punctuation">${</span><span class="token variable">CMAKE_REQUIRED_FLAGS</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">list</span><span class="token punctuation">(</span>APPEND <span class="token variable">CMAKE_REQUIRED_FLAGS</span> -Werror -Wthread-safety<span class="token punctuation">)</span>
<span class="token function">check_cxx_source_compiles</span><span class="token punctuation">(</span><span class="token string">"
struct __attribute__((lockable)) Lock {
  void Acquire() __attribute__((exclusive_lock_function()));
  void Release() __attribute__((unlock_function()));
};
struct ThreadSafeType {
  Lock lock_;
  int data_ __attribute__((guarded_by(lock_)));
};
int main() { return 0; }
"</span>  HAVE_CLANG_THREAD_SAFETY<span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_REQUIRED_FLAGS</span> <span class="token punctuation">${</span>OLD_CMAKE_REQUIRED_FLAGS<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>HAVE_CLANG_THREAD_SAFETY<span class="token punctuation">)</span>
  <span class="token keyword">target_compile_options</span><span class="token punctuation">(</span>leveldb
    <span class="token namespace">PUBLIC</span>
      -Werror -Wthread-safety<span class="token punctuation">)</span>
<span class="token keyword">endif</span><span class="token punctuation">(</span>HAVE_CLANG_THREAD_SAFETY<span class="token punctuation">)</span>
</code></pre>
<h3 id="references" tabindex="-1"><a href="#references">References</a></h3>
<ol>
<li><a href="https://clang.llvm.org/docs/ThreadSafetyAnalysis.html">&quot;Thread Safety Analysis&quot;, <em>Clang Documentation</em></a></li>
<li><a href="https://en.cppreference.com/w/cpp/thread/mutex">&quot;std::mutex&quot;, <em>C++ Reference</em></a></li>
<li><a href="https://en.cppreference.com/w/cpp/thread/unique_lock">&quot;std::unique_lock&quot;, <em>C++ Reference</em></a></li>
<li><a href="https://en.cppreference.com/w/cpp/thread/condition_variable">&quot;std::condition_variable&quot;, <em>C++ Reference</em></a></li>
<li><a href="https://en.cppreference.com/w/cpp/thread/condition_variable/notify_one">&quot;std::condition_variable::notify_one&quot;, <em>C++ Reference</em></a></li>
<li><a href="https://en.cppreference.com/w/cpp/atomic/atomic">&quot;std::atomic&quot;, <em>C++ Reference</em></a></li>
<li><a href="https://en.cppreference.com/w/cpp/atomic/memory_order">&quot;std::memory_order&quot;, <em>C++ Reference</em></a></li>
</ol>

      </div>
      <div id="gitalk-container">
      </div>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2017 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/gitalk.min.js"></script>
    <script src="/dist/main.js"></script>
    <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-61723712-2', 'auto'); ga('send', 'pageview'); </script>
  </body>
</html>
