<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/gitalk.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>LevelDB 源码分析「三、高性能写操作」 | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> LevelDB 源码分析「三、高性能写操作」 </h1>
      </div>
      <div class="info">
        <div class="date"> 2019.08.05 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <p>本系列的<a href="/leveldb/leveldb_02_data_structure.html">前两篇</a>介绍了 LevelDB 中使用的数据结构，并没有牵涉到 LevelDB 的核心实现。接下来的几篇将着重介绍 LevelDB 核心组件，包括日志、内存数据库、SortedTable、Compaction 和版本管理。本篇着重阐述高性能写操作的秘密：日志和内存数据库。</p>
<p>怎样最快地把键值对存起来？不考虑查找的速度的话，追加地写入文件是最快的，查找时反向查找。举个例子🌰：</p>
<pre class="language-python"><code class="language-python"><span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"LY"</span>
<span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"SF"</span>
<span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"MX"</span>
<span class="token keyword">del</span> <span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"ST"</span>
</code></pre>
<p>上面代码中的 5 个操作，顺序地写入文件，每次添加一行，可以得到类似如下的记录：</p>
<pre class="language-markup"><code class="language-markup">Add 1: "LY"
Add 2: "SF"
Add 3: "MX"
Del 1
Add 2: "ST"
</code></pre>
<p>查找时反向查找，例如查找 <code>key=2</code>，返回最后一行最新的结果 &quot;ST&quot;；查找 <code>key=1</code>，返回倒数第二行的删除操作。LevelDB 中写操作使用了相似的技术，其写入分为两步：</p>
<ol>
<li>将数据追加到日志中；</li>
<li>将数据插入内存数据库。</li>
</ol>
<p>追加到日志一来保证了写入速度，二来保证了数据不会丢失，只要日志写入了磁盘，即使机器断电了，重启后也可以根据日志恢复出数据来；插入内存数据库同样维持着高性能，当内存数据库的小大到达一定规模时，会将当前的内存数据库持久化并建立新的内存数据库。</p>
<h3 id="1.-批量写操作-writebatch"><a href="#1.-%E6%89%B9%E9%87%8F%E5%86%99%E6%93%8D%E4%BD%9C-writebatch">1. 批量写操作 WriteBatch</a></h3>
<p>LevelDB 的键值对写入接口为 <code>DB::Put(options, key, value)</code>，删除某个键值对的接口为 <code>DB::Delete(options, key)</code>，其对应的实现为：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// source: db/db_impl.cc</span>

Status DB<span class="token operator">::</span><span class="token function">Put</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteOptions<span class="token operator">&amp;</span> opt<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  WriteBatch batch<span class="token punctuation">;</span>
  batch<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">Write</span><span class="token punctuation">(</span>opt<span class="token punctuation">,</span> <span class="token operator">&amp;</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Status DB<span class="token operator">::</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteOptions<span class="token operator">&amp;</span> opt<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  WriteBatch batch<span class="token punctuation">;</span>
  batch<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">Write</span><span class="token punctuation">(</span>opt<span class="token punctuation">,</span> <span class="token operator">&amp;</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>插入和删除操作首先被打包成一个 <code>WriteBatch</code>。其定义于 <a href="https://github.com/google/leveldb/blob/master/include/leveldb/write_batch.h"><code>include/leveldb/write_batch.h</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// WriteBatch holds a collection of updates to apply atomically to a DB.</span>
<span class="token comment">//</span>
<span class="token comment">// The updates are applied in the order in which they are added</span>
<span class="token comment">// to the WriteBatch.  For example, the value of "key" will be "v3"</span>
<span class="token comment">// after the following batch is written:</span>
<span class="token comment">//</span>
<span class="token comment">//    batch.Put("key", "v1");</span>
<span class="token comment">//    batch.Delete("key");</span>
<span class="token comment">//    batch.Put("key", "v2");</span>
<span class="token comment">//    batch.Put("key", "v3");</span>
<span class="token comment">//</span>
<span class="token comment">// Multiple threads can invoke const methods on a WriteBatch without</span>
<span class="token comment">// external synchronization, but if any of the threads may call a</span>
<span class="token comment">// non-const method, all threads accessing the same WriteBatch must use</span>
<span class="token comment">// external synchronization.</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"leveldb/export.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"leveldb/status.h"</span></span>

<span class="token keyword">namespace</span> leveldb <span class="token punctuation">{</span>

<span class="token keyword">class</span> <span class="token class-name">Slice</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">LEVELDB_EXPORT</span> WriteBatch <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">class</span> <span class="token class-name">LEVELDB_EXPORT</span> Handler <span class="token punctuation">{</span>
   <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Put</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> value<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Delete</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">WriteBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Intentionally copyable.</span>
  <span class="token function">WriteBatch</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
  WriteBatch<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

  <span class="token operator">~</span><span class="token function">WriteBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Store the mapping "key->value" in the database.</span>
  <span class="token keyword">void</span> <span class="token function">Put</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If the database contains a mapping for "key", erase it.  Else do nothing.</span>
  <span class="token keyword">void</span> <span class="token function">Delete</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Clear all updates buffered in this batch.</span>
  <span class="token keyword">void</span> <span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// The size of the database changes caused by this batch.</span>
  <span class="token comment">//</span>
  <span class="token comment">// This number is tied to implementation details, and may change across</span>
  <span class="token comment">// releases. It is intended for LevelDB usage metrics.</span>
  size_t <span class="token function">ApproximateSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

  <span class="token comment">// Copies the operations in "source" to this batch.</span>
  <span class="token comment">//</span>
  <span class="token comment">// This runs in O(source size) time. However, the constant factor is better</span>
  <span class="token comment">// than calling Iterate() over the source batch with a Handler that replicates</span>
  <span class="token comment">// the operations into this batch.</span>
  <span class="token keyword">void</span> <span class="token function">Append</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">&amp;</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Support for iterating over the contents of a batch.</span>
  Status <span class="token function">Iterate</span><span class="token punctuation">(</span>Handler<span class="token operator">*</span> handler<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">WriteBatchInternal</span><span class="token punctuation">;</span>

  std<span class="token operator">::</span>string rep_<span class="token punctuation">;</span>  <span class="token comment">// See comment in write_batch.cc for the format of rep_</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace leveldb</span>
</code></pre>
<p><code>WriteBatch</code> 接口中除了提到的 <code>Put</code> 和 <code>Delete</code>，还提供了一个 <code>Append</code> 方法可以将其他 <code>WriteBatch</code> 合并过来。另外提供了一个 <code>Iterate</code> 迭代函数和对应的 <code>Handler</code> 类接口，后面会使用到。值得注意的还有 <code>friend class WriteBatchInternal;</code>，这种预先定义一个友元类、后期则可以在该友元类中直接访问私有变量和方法，适合一些不方便暴露出来的内部操作。接着看 <code>WriteBatchInternal</code> 的定义 <a href="https://github.com/google/leveldb/blob/master/db/write_batch_internal.h"><code>db/write_batch_internal.h</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"db/dbformat.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"leveldb/write_batch.h"</span></span>

<span class="token keyword">namespace</span> leveldb <span class="token punctuation">{</span>

<span class="token keyword">class</span> <span class="token class-name">MemTable</span><span class="token punctuation">;</span>

<span class="token comment">// WriteBatchInternal provides static methods for manipulating a</span>
<span class="token comment">// WriteBatch that we don't want in the public WriteBatch interface.</span>
<span class="token keyword">class</span> <span class="token class-name">WriteBatchInternal</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token comment">// Return the number of entries in the batch.</span>
  <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">Count</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">*</span> batch<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Set the count for the number of entries in the batch.</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">SetCount</span><span class="token punctuation">(</span>WriteBatch<span class="token operator">*</span> batch<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Return the sequence number for the start of this batch.</span>
  <span class="token keyword">static</span> SequenceNumber <span class="token function">Sequence</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">*</span> batch<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Store the specified number as the sequence number for the start of</span>
  <span class="token comment">// this batch.</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">SetSequence</span><span class="token punctuation">(</span>WriteBatch<span class="token operator">*</span> batch<span class="token punctuation">,</span> SequenceNumber seq<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> Slice <span class="token function">Contents</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">*</span> batch<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">Slice</span><span class="token punctuation">(</span>batch<span class="token operator">-></span>rep_<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">static</span> size_t <span class="token function">ByteSize</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">*</span> batch<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> batch<span class="token operator">-></span>rep_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">SetContents</span><span class="token punctuation">(</span>WriteBatch<span class="token operator">*</span> batch<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> Status <span class="token function">InsertInto</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">*</span> batch<span class="token punctuation">,</span> MemTable<span class="token operator">*</span> memtable<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Append</span><span class="token punctuation">(</span>WriteBatch<span class="token operator">*</span> dst<span class="token punctuation">,</span> <span class="token keyword">const</span> WriteBatch<span class="token operator">*</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace leveldb</span>
</code></pre>
<p>类中全部是静态函数，并且附带至少一个 <code>WriteBatch* batch</code> 参数。因为友元类的原因这些函数里均可以访问 <code>WriteBatch</code> 里唯一的私有成员 <code>rep_</code>。<code>WriteBatch</code> 和 <code>WriteBatchInternal</code> 函数实现均位于 <a href="https://github.com/google/leveldb/blob/master/db/write_batch.cc"><code>db/write_batch.cc</code></a>，为了方便阅读我会把内部的函数重新排序：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// WriteBatch header has an 8-byte sequence number followed by a 4-byte count.</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> size_t kHeader <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>

WriteBatch<span class="token operator">::</span><span class="token function">WriteBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

WriteBatch<span class="token operator">::</span><span class="token operator">~</span><span class="token function">WriteBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

WriteBatch<span class="token operator">::</span>Handler<span class="token operator">::</span><span class="token operator">~</span><span class="token function">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> WriteBatch<span class="token operator">::</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rep_<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rep_<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>kHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

size_t WriteBatch<span class="token operator">::</span><span class="token function">ApproximateSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> rep_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">int</span> WriteBatchInternal<span class="token operator">::</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">*</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">DecodeFixed32</span><span class="token punctuation">(</span>b<span class="token operator">-></span>rep_<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> WriteBatchInternal<span class="token operator">::</span><span class="token function">SetCount</span><span class="token punctuation">(</span>WriteBatch<span class="token operator">*</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">EncodeFixed32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-></span>rep_<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

SequenceNumber WriteBatchInternal<span class="token operator">::</span><span class="token function">Sequence</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">*</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">SequenceNumber</span><span class="token punctuation">(</span><span class="token function">DecodeFixed64</span><span class="token punctuation">(</span>b<span class="token operator">-></span>rep_<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> WriteBatchInternal<span class="token operator">::</span><span class="token function">SetSequence</span><span class="token punctuation">(</span>WriteBatch<span class="token operator">*</span> b<span class="token punctuation">,</span> SequenceNumber seq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">EncodeFixed64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-></span>rep_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> seq<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>WriteBatch::rep_</code> 的前 12 个字节定义为 Header，存储了 sequence number 和 count。<code>EncodeFixed</code> 和 <code>DecodeFixed</code>系列函数实现了数值到字符串的编解码，有兴趣可以前往 <a href="https://github.com/google/leveldb/blob/master/util/coding.cc"><code>util/coding.cc</code></a> 查看实现，这里不详细介绍了。接下来看 <code>Put</code> 和 <code>Delete</code> 的实现：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">void</span> WriteBatch<span class="token operator">::</span><span class="token function">Put</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  WriteBatchInternal<span class="token operator">::</span><span class="token function">SetCount</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> WriteBatchInternal<span class="token operator">::</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rep_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">(</span>kTypeValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">PutLengthPrefixedSlice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rep_<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">PutLengthPrefixedSlice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rep_<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> WriteBatch<span class="token operator">::</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  WriteBatchInternal<span class="token operator">::</span><span class="token function">SetCount</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> WriteBatchInternal<span class="token operator">::</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rep_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">(</span>kTypeDeletion<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">PutLengthPrefixedSlice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rep_<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> WriteBatch<span class="token operator">::</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">&amp;</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  WriteBatchInternal<span class="token operator">::</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> WriteBatchInternal<span class="token operator">::</span><span class="token function">SetContents</span><span class="token punctuation">(</span>WriteBatch<span class="token operator">*</span> b<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> contents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>contents<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> kHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
  b<span class="token operator">-></span>rep_<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>contents<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> contents<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> WriteBatchInternal<span class="token operator">::</span><span class="token function">Append</span><span class="token punctuation">(</span>WriteBatch<span class="token operator">*</span> dst<span class="token punctuation">,</span> <span class="token keyword">const</span> WriteBatch<span class="token operator">*</span> src<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">SetCount</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> <span class="token function">Count</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">Count</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>src<span class="token operator">-></span>rep_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> kHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
  dst<span class="token operator">-></span>rep_<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>src<span class="token operator">-></span>rep_<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> kHeader<span class="token punctuation">,</span> src<span class="token operator">-></span>rep_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> kHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>Put</code> 和 <code>Delete</code> 首先将计数加一，在 <code>rep_</code> 中写入操作类型，再写入键值对。<code>PutLengthPrefixedSlice</code> 函数会先写入字符串的长度，再写入字符串的内容。<code>WriteBatchInternal</code> 的赋值和追加均是对 <code>rep_</code> 的进行操作。继续看迭代函数和 <code>Handle</code> 的部分：</p>
<pre class="language-cpp"><code class="language-cpp">Status WriteBatch<span class="token operator">::</span><span class="token function">Iterate</span><span class="token punctuation">(</span>Handler<span class="token operator">*</span> handler<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
  Slice <span class="token function">input</span><span class="token punctuation">(</span>rep_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> kHeader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Status<span class="token operator">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"malformed WriteBatch (too small)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  input<span class="token punctuation">.</span><span class="token function">remove_prefix</span><span class="token punctuation">(</span>kHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Slice key<span class="token punctuation">,</span> value<span class="token punctuation">;</span>
  <span class="token keyword">int</span> found <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>input<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    found<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> tag <span class="token operator">=</span> input<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    input<span class="token punctuation">.</span><span class="token function">remove_prefix</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> kTypeValue<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GetLengthPrefixedSlice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">,</span> <span class="token operator">&amp;</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token function">GetLengthPrefixedSlice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          handler<span class="token operator">-></span><span class="token function">Put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> Status<span class="token operator">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"bad WriteBatch Put"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> kTypeDeletion<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GetLengthPrefixedSlice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">,</span> <span class="token operator">&amp;</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          handler<span class="token operator">-></span><span class="token function">Delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> Status<span class="token operator">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"bad WriteBatch Delete"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">return</span> Status<span class="token operator">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"unknown WriteBatch tag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>found <span class="token operator">!=</span> WriteBatchInternal<span class="token operator">::</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Status<span class="token operator">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"WriteBatch has wrong count"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Status<span class="token operator">::</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">namespace</span> <span class="token punctuation">{</span>
<span class="token keyword">class</span> <span class="token class-name">MemTableInserter</span> <span class="token operator">:</span> <span class="token keyword">public</span> WriteBatch<span class="token operator">::</span>Handler <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  SequenceNumber sequence_<span class="token punctuation">;</span>
  MemTable<span class="token operator">*</span> mem_<span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">Put</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> value<span class="token punctuation">)</span> override <span class="token punctuation">{</span>
    mem_<span class="token operator">-></span><span class="token function">Add</span><span class="token punctuation">(</span>sequence_<span class="token punctuation">,</span> kTypeValue<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sequence_<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">Delete</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">)</span> override <span class="token punctuation">{</span>
    mem_<span class="token operator">-></span><span class="token function">Add</span><span class="token punctuation">(</span>sequence_<span class="token punctuation">,</span> kTypeDeletion<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token function">Slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sequence_<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>  <span class="token comment">// namespace</span>

Status WriteBatchInternal<span class="token operator">::</span><span class="token function">InsertInto</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">*</span> b<span class="token punctuation">,</span> MemTable<span class="token operator">*</span> memtable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  MemTableInserter inserter<span class="token punctuation">;</span>
  inserter<span class="token punctuation">.</span>sequence_ <span class="token operator">=</span> WriteBatchInternal<span class="token operator">::</span><span class="token function">Sequence</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
  inserter<span class="token punctuation">.</span>mem_ <span class="token operator">=</span> memtable<span class="token punctuation">;</span>
  <span class="token keyword">return</span> b<span class="token operator">-></span><span class="token function">Iterate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>inserter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>迭代函数 <code>WriteBatch::Iterate</code> 会按照顺序将 <code>rep_</code> 中存储的键值对操作放到 <code>hander</code> 上执行。下面的匿名空间里定义了一个继承 <code>Handler</code> 的子类 <code>MemTableInserter</code>，将 <code>Put</code> 和 <code>Delete</code> 转到 <code>MemTable</code> 上执行。<code>MemTable</code> 即为内存数据库，本文稍后介绍。<code>WriteBatchInternal::InsertInto</code> 就直接根据 <code>MemTable</code> 构造 <code>MemTableInserter</code>。这样做的好处，可能就是 <code>WriteBatch::Iterate</code> 与 <code>MemTable</code> 解耦，<code>Handler</code> 可以自行替换。</p>
<p>综合来看，<code>WriteBatch</code> 将所有的修改和删除操作均存储到一个字符串中，并且提供了内存数据库的迭代接口。而单个字符串也可以非常方便地进行持久化，这一点也会在日志部分有所体现。</p>
<h3 id="2.-日志-log"><a href="#2.-%E6%97%A5%E5%BF%97-log">2. 日志 Log</a></h3>
<p>在 <code>DB::Write</code> 函数中，核心的写入步骤代码如下：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// Add to log and apply to memtable.  We can release the lock</span>
<span class="token comment">// during this phase since &amp;w is currently responsible for logging</span>
<span class="token comment">// and protects against concurrent loggers and concurrent writes</span>
<span class="token comment">// into mem_.</span>
<span class="token punctuation">{</span>
  mutex_<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  status <span class="token operator">=</span> log_<span class="token operator">-></span><span class="token function">AddRecord</span><span class="token punctuation">(</span>WriteBatchInternal<span class="token operator">::</span><span class="token function">Contents</span><span class="token punctuation">(</span>updates<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> sync_error <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    status <span class="token operator">=</span> logfile_<span class="token operator">-></span><span class="token function">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sync_error <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    status <span class="token operator">=</span> WriteBatchInternal<span class="token operator">::</span><span class="token function">InsertInto</span><span class="token punctuation">(</span>updates<span class="token punctuation">,</span> mem_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  mutex_<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The state of the log file is indeterminate: the log record we</span>
    <span class="token comment">// just added may or may not show up when the DB is re-opened.</span>
    <span class="token comment">// So we force the DB into a mode where all future writes fail.</span>
    <span class="token function">RecordBackgroundError</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>先追加到日志，再写入内存数据库。这里的 <code>log_</code> 为成员变量，类型为 <code>log::Writer</code>，其定义位于 <a href="https://github.com/google/leveldb/blob/master/db/log_writer.h"><code>db/log_writer.h</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"db/log_format.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"leveldb/slice.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"leveldb/status.h"</span></span>

<span class="token keyword">namespace</span> leveldb <span class="token punctuation">{</span>

<span class="token keyword">class</span> <span class="token class-name">WritableFile</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> log <span class="token punctuation">{</span>

<span class="token keyword">class</span> <span class="token class-name">Writer</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token comment">// Create a writer that will append data to "*dest".</span>
  <span class="token comment">// "*dest" must be initially empty.</span>
  <span class="token comment">// "*dest" must remain live while this Writer is in use.</span>
  <span class="token keyword">explicit</span> <span class="token function">Writer</span><span class="token punctuation">(</span>WritableFile<span class="token operator">*</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Create a writer that will append data to "*dest".</span>
  <span class="token comment">// "*dest" must have initial length "dest_length".</span>
  <span class="token comment">// "*dest" must remain live while this Writer is in use.</span>
  <span class="token function">Writer</span><span class="token punctuation">(</span>WritableFile<span class="token operator">*</span> dest<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> dest_length<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">Writer</span><span class="token punctuation">(</span><span class="token keyword">const</span> Writer<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
  Writer<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Writer<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

  <span class="token operator">~</span><span class="token function">Writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  Status <span class="token function">AddRecord</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> slice<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  Status <span class="token function">EmitPhysicalRecord</span><span class="token punctuation">(</span>RecordType type<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ptr<span class="token punctuation">,</span> size_t length<span class="token punctuation">)</span><span class="token punctuation">;</span>

  WritableFile<span class="token operator">*</span> dest_<span class="token punctuation">;</span>
  <span class="token keyword">int</span> block_offset_<span class="token punctuation">;</span>  <span class="token comment">// Current offset in block</span>

  <span class="token comment">// crc32c values for all supported record types.  These are</span>
  <span class="token comment">// pre-computed to reduce the overhead of computing the crc of the</span>
  <span class="token comment">// record type stored in the header.</span>
  <span class="token keyword">uint32_t</span> type_crc_<span class="token punctuation">[</span>kMaxRecordType <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace log</span>
<span class="token punctuation">}</span>  <span class="token comment">// namespace leveldb</span>
</code></pre>
<p>公开的接口只有一个 <code>Log::Writer::AddRecord</code>，也就是 <code>DB::Write</code>  中调用的函数。另外类中还有一个私有数组 <code>type_crc_</code>，内部存储了预先计算的几种类型的 <code>CRC32</code> 校验值。常量 <code>kMaxRecordType</code> 定义于 <a href="https://github.com/google/leveldb/blob/master/db/format.h"><code>db/log_format.h</code></a>，该文件定义了日志格式相关的几个常量：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">enum</span> <span class="token class-name">RecordType</span> <span class="token punctuation">{</span>
  <span class="token comment">// Zero is reserved for preallocated files</span>
  kZeroType <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>

  kFullType <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>

  <span class="token comment">// For fragments</span>
  kFirstType <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
  kMiddleType <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
  kLastType <span class="token operator">=</span> <span class="token number">4</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> kMaxRecordType <span class="token operator">=</span> kLastType<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> kBlockSize <span class="token operator">=</span> <span class="token number">32768</span><span class="token punctuation">;</span>

<span class="token comment">// Header is checksum (4 bytes), length (2 bytes), type (1 byte).</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> kHeaderSize <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre>
<p>日志类中的 <code>AddRecord</code> 函数每次调用会增加一条记录 Record，同时我们需要保证以后可以按顺序读取出每一条 Record。为了提升日志的读取速度速度，LevelDB 引入了 Block 的概念。在读写文件时会按照一个一个 Block 来读写，默认的 Block 大小为 <code>kBlockSize = 32KB</code>。而一条记录可能比 Block 还要长，所以还需要对过长的 Record 做合适的切分，切成片段 Fragment 后再放入 Block 中。Fragment 分为三种类型，分别是 <code>kFirstType</code>、<code>kMiddleType</code> 和 <code>kLastType</code>，参看下图：</p>
<figure tabindex="1"><a href="../images/0401845d2d596d0a577fe164ba72f66a.svg"><img src="../images/0401845d2d596d0a577fe164ba72f66a.svg" alt=""></a><figcaption>Log Format</figcaption></figure>
<p>继续看 <a href="https://github.com/google/leveldb/blob/master/db/log_writer.cc"><code>db/log_writer.cc</code></a> 的具体实现：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"db/log_writer.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"leveldb/env.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"util/coding.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"util/crc32c.h"</span></span>

<span class="token keyword">namespace</span> leveldb <span class="token punctuation">{</span>
<span class="token keyword">namespace</span> log <span class="token punctuation">{</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">InitTypeCrc</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token operator">*</span> type_crc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> kMaxRecordType<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> t <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    type_crc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> crc32c<span class="token operator">::</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Writer<span class="token operator">::</span><span class="token function">Writer</span><span class="token punctuation">(</span>WritableFile<span class="token operator">*</span> dest<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">dest_</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">block_offset_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">InitTypeCrc</span><span class="token punctuation">(</span>type_crc_<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Writer<span class="token operator">::</span><span class="token function">Writer</span><span class="token punctuation">(</span>WritableFile<span class="token operator">*</span> dest<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> dest_length<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">dest_</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">block_offset_</span><span class="token punctuation">(</span>dest_length <span class="token operator">%</span> kBlockSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">InitTypeCrc</span><span class="token punctuation">(</span>type_crc_<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Writer<span class="token operator">::</span><span class="token operator">~</span><span class="token function">Writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

Status Writer<span class="token operator">::</span><span class="token function">EmitPhysicalRecord</span><span class="token punctuation">(</span>RecordType t<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ptr<span class="token punctuation">,</span>
                                  size_t length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>length <span class="token operator">&lt;=</span> <span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Must fit in two bytes</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>block_offset_ <span class="token operator">+</span> kHeaderSize <span class="token operator">+</span> length <span class="token operator">&lt;=</span> kBlockSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Format the header</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span>kHeaderSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
  buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">(</span>length <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">(</span>length <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  buf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Compute the crc of the record type and the payload.</span>
  <span class="token keyword">uint32_t</span> crc <span class="token operator">=</span> crc32c<span class="token operator">::</span><span class="token function">Extend</span><span class="token punctuation">(</span>type_crc_<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  crc <span class="token operator">=</span> crc32c<span class="token operator">::</span><span class="token function">Mask</span><span class="token punctuation">(</span>crc<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Adjust for storage</span>
  <span class="token function">EncodeFixed32</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> crc<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Write the header and the payload</span>
  Status s <span class="token operator">=</span> dest_<span class="token operator">-></span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token function">Slice</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> kHeaderSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s <span class="token operator">=</span> dest_<span class="token operator">-></span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token function">Slice</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      s <span class="token operator">=</span> dest_<span class="token operator">-></span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  block_offset_ <span class="token operator">+=</span> kHeaderSize <span class="token operator">+</span> length<span class="token punctuation">;</span>
  <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace log</span>
<span class="token punctuation">}</span>  <span class="token comment">// namespace leveldb</span>
</code></pre>
<p>构造时 <code>InitTypeCrc</code> 函数初始化了 <code>type_crc_</code> 数组，另外如果构造时有 <code>dest_length</code> 参数，则将 <code>block_offset_</code> 设为 <code>dest_length % kBlockSize</code>。至于函数 <code>EmitPhysicalRecord</code>，从函数名来看其作用是触发物理记录。该函数先构造了一个 Record Header <code>buf</code>，前 4 字节存储 CRC32 校验值，后面依次存储长度和 Record 类型。最终会将 Header、字节流写入文件并刷新，并且更新 <code>block_offset_</code>。最后来看下 <code>Log::Writer::AddRecord</code> 函数的实现：</p>
<pre class="language-cpp"><code class="language-cpp">Status Writer<span class="token operator">::</span><span class="token function">AddRecord</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> slice<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ptr <span class="token operator">=</span> slice<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  size_t left <span class="token operator">=</span> slice<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Fragment the record if necessary and emit it.  Note that if slice</span>
  <span class="token comment">// is empty, we still want to iterate once to emit a single</span>
  <span class="token comment">// zero-length record</span>
  Status s<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> begin <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> leftover <span class="token operator">=</span> kBlockSize <span class="token operator">-</span> block_offset_<span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>leftover <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>leftover <span class="token operator">&lt;</span> kHeaderSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Switch to a new block</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>leftover <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Fill the trailer (literal below relies on kHeaderSize being 7)</span>
        <span class="token keyword">static_assert</span><span class="token punctuation">(</span>kHeaderSize <span class="token operator">==</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dest_<span class="token operator">-></span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token function">Slice</span><span class="token punctuation">(</span><span class="token string">"\x00\x00\x00\x00\x00\x00"</span><span class="token punctuation">,</span> leftover<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      block_offset_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Invariant: we never leave &lt; kHeaderSize bytes in a block.</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>kBlockSize <span class="token operator">-</span> block_offset_ <span class="token operator">-</span> kHeaderSize <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> size_t avail <span class="token operator">=</span> kBlockSize <span class="token operator">-</span> block_offset_ <span class="token operator">-</span> kHeaderSize<span class="token punctuation">;</span>
    <span class="token keyword">const</span> size_t fragment_length <span class="token operator">=</span> <span class="token punctuation">(</span>left <span class="token operator">&lt;</span> avail<span class="token punctuation">)</span> <span class="token operator">?</span> left <span class="token operator">:</span> avail<span class="token punctuation">;</span>

    RecordType type<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">bool</span> end <span class="token operator">=</span> <span class="token punctuation">(</span>left <span class="token operator">==</span> fragment_length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>begin <span class="token operator">&amp;&amp;</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      type <span class="token operator">=</span> kFullType<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>begin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      type <span class="token operator">=</span> kFirstType<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      type <span class="token operator">=</span> kLastType<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      type <span class="token operator">=</span> kMiddleType<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    s <span class="token operator">=</span> <span class="token function">EmitPhysicalRecord</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> fragment_length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ptr <span class="token operator">+=</span> fragment_length<span class="token punctuation">;</span>
    left <span class="token operator">-=</span> fragment_length<span class="token punctuation">;</span>
    begin <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> left <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>函数首先会计算当前 Block 剩余空间大小 <code>leftover</code>，如果连 Header 都没法写进去，就直接填充 0 进去，后期读取时会直接过滤掉。而后计算可用的空间大小 <code>avail</code> 和当前写入的长度 <code>fragment_length</code> 以及对应的记录类型 <code>type</code>，最后调用 <code>EmitPhysicalRecord</code> 刷入文件。这种方式可以保证写 Record 时按照 <code>BlockSize</code> 对齐。</p>
<p>综上来看，写入时首先会把 <code>WriteBatch::rep_</code> 对齐地追加到日志中，写入时做了合适的切分，并且加入了 CRC 校验。有写肯定有读，当进行恢复操作时就会读取上述日志，<code>Log::Reader</code> 代码实现位于  <a href="https://github.com/google/leveldb/blob/master/db/log_reader.h"><code>db/log_reader.h</code></a> 和 <a href="https://github.com/google/leveldb/blob/master/db/log_reader.cc"><code>db/log_reader.cc</code></a>，读取的过程即为写入的逆过程，有兴趣可以自行阅读。</p>

      </div>
      <div id="gitalk-container">
      </div>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2020 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/gitalk.min.js"></script>
    <script src="/dist/main.js"></script>
  </body>
</html>
