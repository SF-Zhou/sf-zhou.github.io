<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/gitalk.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>LevelDB æºç åˆ†æã€Œä¸‰ã€é«˜æ€§èƒ½å†™æ“ä½œã€ | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> LevelDB æºç åˆ†æã€Œä¸‰ã€é«˜æ€§èƒ½å†™æ“ä½œã€ </h1>
      </div>
      <div class="info">
        <div class="date"> 2019.08.05 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <p>æœ¬ç³»åˆ—çš„<a href="/leveldb/leveldb_02_data_structure.html">å‰ä¸¤ç¯‡</a>ä»‹ç»äº† LevelDB ä¸­ä½¿ç”¨çš„æ•°æ®ç»“æ„ï¼Œå¹¶æ²¡æœ‰ç‰µæ¶‰åˆ° LevelDB çš„æ ¸å¿ƒå®ç°ã€‚æ¥ä¸‹æ¥çš„å‡ ç¯‡å°†ç€é‡ä»‹ç» LevelDB æ ¸å¿ƒç»„ä»¶ï¼ŒåŒ…æ‹¬æ—¥å¿—ã€å†…å­˜æ•°æ®åº“ã€SortedTableã€Compaction å’Œç‰ˆæœ¬ç®¡ç†ã€‚æœ¬ç¯‡ç€é‡é˜è¿°é«˜æ€§èƒ½å†™æ“ä½œçš„ç§˜å¯†ï¼šæ—¥å¿—å’Œå†…å­˜æ•°æ®åº“ã€‚</p>
<p>æ€æ ·æœ€å¿«åœ°æŠŠé”®å€¼å¯¹å­˜èµ·æ¥ï¼Ÿä¸è€ƒè™‘æŸ¥æ‰¾çš„é€Ÿåº¦çš„è¯ï¼Œè¿½åŠ åœ°å†™å…¥æ–‡ä»¶æ˜¯æœ€å¿«çš„ï¼ŒæŸ¥æ‰¾æ—¶åå‘æŸ¥æ‰¾ã€‚ä¸¾ä¸ªä¾‹å­ğŸŒ°ï¼š</p>
<pre class="language-python"><code class="language-python"><span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"LY"</span>
<span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"SF"</span>
<span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"MX"</span>
<span class="token keyword">del</span> <span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"ST"</span>
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­çš„ 5 ä¸ªæ“ä½œï¼Œé¡ºåºåœ°å†™å…¥æ–‡ä»¶ï¼Œæ¯æ¬¡æ·»åŠ ä¸€è¡Œï¼Œå¯ä»¥å¾—åˆ°ç±»ä¼¼å¦‚ä¸‹çš„è®°å½•ï¼š</p>
<pre class="language-markup"><code class="language-markup">Add 1: "LY"
Add 2: "SF"
Add 3: "MX"
Del 1
Add 2: "ST"
</code></pre>
<p>æŸ¥æ‰¾æ—¶åå‘æŸ¥æ‰¾ï¼Œä¾‹å¦‚æŸ¥æ‰¾ <code>key=2</code>ï¼Œè¿”å›æœ€åä¸€è¡Œæœ€æ–°çš„ç»“æœ &quot;ST&quot;ï¼›æŸ¥æ‰¾ <code>key=1</code>ï¼Œè¿”å›å€’æ•°ç¬¬äºŒè¡Œçš„åˆ é™¤æ“ä½œã€‚LevelDB ä¸­å†™æ“ä½œä½¿ç”¨äº†ç›¸ä¼¼çš„æŠ€æœ¯ï¼Œå…¶å†™å…¥åˆ†ä¸ºä¸¤æ­¥ï¼š</p>
<ol>
<li>å°†æ•°æ®è¿½åŠ åˆ°æ—¥å¿—ä¸­ï¼›</li>
<li>å°†æ•°æ®æ’å…¥å†…å­˜æ•°æ®åº“ã€‚</li>
</ol>
<p>è¿½åŠ åˆ°æ—¥å¿—ä¸€æ¥ä¿è¯äº†å†™å…¥é€Ÿåº¦ï¼ŒäºŒæ¥ä¿è¯äº†æ•°æ®ä¸ä¼šä¸¢å¤±ï¼Œåªè¦æ—¥å¿—å†™å…¥äº†ç£ç›˜ï¼Œå³ä½¿æœºå™¨æ–­ç”µäº†ï¼Œé‡å¯åä¹Ÿå¯ä»¥æ ¹æ®æ—¥å¿—æ¢å¤å‡ºæ•°æ®æ¥ï¼›æ’å…¥å†…å­˜æ•°æ®åº“åŒæ ·ç»´æŒç€é«˜æ€§èƒ½ï¼Œå½“å†…å­˜æ•°æ®åº“çš„å°å¤§åˆ°è¾¾ä¸€å®šè§„æ¨¡æ—¶ï¼Œä¼šå°†å½“å‰çš„å†…å­˜æ•°æ®åº“æŒä¹…åŒ–å¹¶å»ºç«‹æ–°çš„å†…å­˜æ•°æ®åº“ã€‚</p>
<h3 id="1.-æ‰¹é‡å†™æ“ä½œ-writebatch"><a href="#1.-%E6%89%B9%E9%87%8F%E5%86%99%E6%93%8D%E4%BD%9C-writebatch">1. æ‰¹é‡å†™æ“ä½œ WriteBatch</a></h3>
<p>LevelDB çš„é”®å€¼å¯¹å†™å…¥æ¥å£ä¸º <code>DB::Put(options, key, value)</code>ï¼Œåˆ é™¤æŸä¸ªé”®å€¼å¯¹çš„æ¥å£ä¸º <code>DB::Delete(options, key)</code>ï¼Œå…¶å¯¹åº”çš„å®ç°ä¸ºï¼š</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// source: db/db_impl.cc</span>

Status DB<span class="token operator">::</span><span class="token function">Put</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteOptions<span class="token operator">&amp;</span> opt<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  WriteBatch batch<span class="token punctuation">;</span>
  batch<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">Write</span><span class="token punctuation">(</span>opt<span class="token punctuation">,</span> <span class="token operator">&amp;</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Status DB<span class="token operator">::</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteOptions<span class="token operator">&amp;</span> opt<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  WriteBatch batch<span class="token punctuation">;</span>
  batch<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">Write</span><span class="token punctuation">(</span>opt<span class="token punctuation">,</span> <span class="token operator">&amp;</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>æ’å…¥å’Œåˆ é™¤æ“ä½œé¦–å…ˆè¢«æ‰“åŒ…æˆä¸€ä¸ª <code>WriteBatch</code>ã€‚å…¶å®šä¹‰äº <a href="https://github.com/google/leveldb/blob/master/include/leveldb/write_batch.h"><code>include/leveldb/write_batch.h</code></a>ï¼š</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// WriteBatch holds a collection of updates to apply atomically to a DB.</span>
<span class="token comment">//</span>
<span class="token comment">// The updates are applied in the order in which they are added</span>
<span class="token comment">// to the WriteBatch.  For example, the value of "key" will be "v3"</span>
<span class="token comment">// after the following batch is written:</span>
<span class="token comment">//</span>
<span class="token comment">//    batch.Put("key", "v1");</span>
<span class="token comment">//    batch.Delete("key");</span>
<span class="token comment">//    batch.Put("key", "v2");</span>
<span class="token comment">//    batch.Put("key", "v3");</span>
<span class="token comment">//</span>
<span class="token comment">// Multiple threads can invoke const methods on a WriteBatch without</span>
<span class="token comment">// external synchronization, but if any of the threads may call a</span>
<span class="token comment">// non-const method, all threads accessing the same WriteBatch must use</span>
<span class="token comment">// external synchronization.</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"leveldb/export.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"leveldb/status.h"</span></span>

<span class="token keyword">namespace</span> leveldb <span class="token punctuation">{</span>

<span class="token keyword">class</span> <span class="token class-name">Slice</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">LEVELDB_EXPORT</span> WriteBatch <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">class</span> <span class="token class-name">LEVELDB_EXPORT</span> Handler <span class="token punctuation">{</span>
   <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Put</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> value<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Delete</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">WriteBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Intentionally copyable.</span>
  <span class="token function">WriteBatch</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
  WriteBatch<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

  <span class="token operator">~</span><span class="token function">WriteBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Store the mapping "key->value" in the database.</span>
  <span class="token keyword">void</span> <span class="token function">Put</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If the database contains a mapping for "key", erase it.  Else do nothing.</span>
  <span class="token keyword">void</span> <span class="token function">Delete</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Clear all updates buffered in this batch.</span>
  <span class="token keyword">void</span> <span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// The size of the database changes caused by this batch.</span>
  <span class="token comment">//</span>
  <span class="token comment">// This number is tied to implementation details, and may change across</span>
  <span class="token comment">// releases. It is intended for LevelDB usage metrics.</span>
  size_t <span class="token function">ApproximateSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

  <span class="token comment">// Copies the operations in "source" to this batch.</span>
  <span class="token comment">//</span>
  <span class="token comment">// This runs in O(source size) time. However, the constant factor is better</span>
  <span class="token comment">// than calling Iterate() over the source batch with a Handler that replicates</span>
  <span class="token comment">// the operations into this batch.</span>
  <span class="token keyword">void</span> <span class="token function">Append</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">&amp;</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Support for iterating over the contents of a batch.</span>
  Status <span class="token function">Iterate</span><span class="token punctuation">(</span>Handler<span class="token operator">*</span> handler<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">WriteBatchInternal</span><span class="token punctuation">;</span>

  std<span class="token operator">::</span>string rep_<span class="token punctuation">;</span>  <span class="token comment">// See comment in write_batch.cc for the format of rep_</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace leveldb</span>
</code></pre>
<p><code>WriteBatch</code> æ¥å£ä¸­é™¤äº†æåˆ°çš„ <code>Put</code> å’Œ <code>Delete</code>ï¼Œè¿˜æä¾›äº†ä¸€ä¸ª <code>Append</code> æ–¹æ³•å¯ä»¥å°†å…¶ä»– <code>WriteBatch</code> åˆå¹¶è¿‡æ¥ã€‚å¦å¤–æä¾›äº†ä¸€ä¸ª <code>Iterate</code> è¿­ä»£å‡½æ•°å’Œå¯¹åº”çš„ <code>Handler</code> ç±»æ¥å£ï¼Œåé¢ä¼šä½¿ç”¨åˆ°ã€‚å€¼å¾—æ³¨æ„çš„è¿˜æœ‰ <code>friend class WriteBatchInternal;</code>ï¼Œè¿™ç§é¢„å…ˆå®šä¹‰ä¸€ä¸ªå‹å…ƒç±»ã€åæœŸåˆ™å¯ä»¥åœ¨è¯¥å‹å…ƒç±»ä¸­ç›´æ¥è®¿é—®ç§æœ‰å˜é‡å’Œæ–¹æ³•ï¼Œé€‚åˆä¸€äº›ä¸æ–¹ä¾¿æš´éœ²å‡ºæ¥çš„å†…éƒ¨æ“ä½œã€‚æ¥ç€çœ‹ <code>WriteBatchInternal</code> çš„å®šä¹‰ <a href="https://github.com/google/leveldb/blob/master/db/write_batch_internal.h"><code>db/write_batch_internal.h</code></a>ï¼š</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"db/dbformat.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"leveldb/write_batch.h"</span></span>

<span class="token keyword">namespace</span> leveldb <span class="token punctuation">{</span>

<span class="token keyword">class</span> <span class="token class-name">MemTable</span><span class="token punctuation">;</span>

<span class="token comment">// WriteBatchInternal provides static methods for manipulating a</span>
<span class="token comment">// WriteBatch that we don't want in the public WriteBatch interface.</span>
<span class="token keyword">class</span> <span class="token class-name">WriteBatchInternal</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token comment">// Return the number of entries in the batch.</span>
  <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">Count</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">*</span> batch<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Set the count for the number of entries in the batch.</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">SetCount</span><span class="token punctuation">(</span>WriteBatch<span class="token operator">*</span> batch<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Return the sequence number for the start of this batch.</span>
  <span class="token keyword">static</span> SequenceNumber <span class="token function">Sequence</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">*</span> batch<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Store the specified number as the sequence number for the start of</span>
  <span class="token comment">// this batch.</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">SetSequence</span><span class="token punctuation">(</span>WriteBatch<span class="token operator">*</span> batch<span class="token punctuation">,</span> SequenceNumber seq<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> Slice <span class="token function">Contents</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">*</span> batch<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">Slice</span><span class="token punctuation">(</span>batch<span class="token operator">-></span>rep_<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">static</span> size_t <span class="token function">ByteSize</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">*</span> batch<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> batch<span class="token operator">-></span>rep_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">SetContents</span><span class="token punctuation">(</span>WriteBatch<span class="token operator">*</span> batch<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> Status <span class="token function">InsertInto</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">*</span> batch<span class="token punctuation">,</span> MemTable<span class="token operator">*</span> memtable<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Append</span><span class="token punctuation">(</span>WriteBatch<span class="token operator">*</span> dst<span class="token punctuation">,</span> <span class="token keyword">const</span> WriteBatch<span class="token operator">*</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace leveldb</span>
</code></pre>
<p>ç±»ä¸­å…¨éƒ¨æ˜¯é™æ€å‡½æ•°ï¼Œå¹¶ä¸”é™„å¸¦è‡³å°‘ä¸€ä¸ª <code>WriteBatch* batch</code> å‚æ•°ã€‚å› ä¸ºå‹å…ƒç±»çš„åŸå› è¿™äº›å‡½æ•°é‡Œå‡å¯ä»¥è®¿é—® <code>WriteBatch</code> é‡Œå”¯ä¸€çš„ç§æœ‰æˆå‘˜ <code>rep_</code>ã€‚<code>WriteBatch</code> å’Œ <code>WriteBatchInternal</code> å‡½æ•°å®ç°å‡ä½äº <a href="https://github.com/google/leveldb/blob/master/db/write_batch.cc"><code>db/write_batch.cc</code></a>ï¼Œä¸ºäº†æ–¹ä¾¿é˜…è¯»æˆ‘ä¼šæŠŠå†…éƒ¨çš„å‡½æ•°é‡æ–°æ’åºï¼š</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// WriteBatch header has an 8-byte sequence number followed by a 4-byte count.</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> size_t kHeader <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>

WriteBatch<span class="token operator">::</span><span class="token function">WriteBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

WriteBatch<span class="token operator">::</span><span class="token operator">~</span><span class="token function">WriteBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

WriteBatch<span class="token operator">::</span>Handler<span class="token operator">::</span><span class="token operator">~</span><span class="token function">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> WriteBatch<span class="token operator">::</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rep_<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rep_<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>kHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

size_t WriteBatch<span class="token operator">::</span><span class="token function">ApproximateSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> rep_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">int</span> WriteBatchInternal<span class="token operator">::</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">*</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">DecodeFixed32</span><span class="token punctuation">(</span>b<span class="token operator">-></span>rep_<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> WriteBatchInternal<span class="token operator">::</span><span class="token function">SetCount</span><span class="token punctuation">(</span>WriteBatch<span class="token operator">*</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">EncodeFixed32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-></span>rep_<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

SequenceNumber WriteBatchInternal<span class="token operator">::</span><span class="token function">Sequence</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">*</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">SequenceNumber</span><span class="token punctuation">(</span><span class="token function">DecodeFixed64</span><span class="token punctuation">(</span>b<span class="token operator">-></span>rep_<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> WriteBatchInternal<span class="token operator">::</span><span class="token function">SetSequence</span><span class="token punctuation">(</span>WriteBatch<span class="token operator">*</span> b<span class="token punctuation">,</span> SequenceNumber seq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">EncodeFixed64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-></span>rep_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> seq<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>WriteBatch::rep_</code> çš„å‰ 12 ä¸ªå­—èŠ‚å®šä¹‰ä¸º Headerï¼Œå­˜å‚¨äº† sequence number å’Œ countã€‚<code>EncodeFixed</code> å’Œ <code>DecodeFixed</code>ç³»åˆ—å‡½æ•°å®ç°äº†æ•°å€¼åˆ°å­—ç¬¦ä¸²çš„ç¼–è§£ç ï¼Œæœ‰å…´è¶£å¯ä»¥å‰å¾€ <a href="https://github.com/google/leveldb/blob/master/util/coding.cc"><code>util/coding.cc</code></a> æŸ¥çœ‹å®ç°ï¼Œè¿™é‡Œä¸è¯¦ç»†ä»‹ç»äº†ã€‚æ¥ä¸‹æ¥çœ‹ <code>Put</code> å’Œ <code>Delete</code> çš„å®ç°ï¼š</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">void</span> WriteBatch<span class="token operator">::</span><span class="token function">Put</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  WriteBatchInternal<span class="token operator">::</span><span class="token function">SetCount</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> WriteBatchInternal<span class="token operator">::</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rep_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">(</span>kTypeValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">PutLengthPrefixedSlice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rep_<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">PutLengthPrefixedSlice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rep_<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> WriteBatch<span class="token operator">::</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  WriteBatchInternal<span class="token operator">::</span><span class="token function">SetCount</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> WriteBatchInternal<span class="token operator">::</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rep_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">(</span>kTypeDeletion<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">PutLengthPrefixedSlice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rep_<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> WriteBatch<span class="token operator">::</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">&amp;</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  WriteBatchInternal<span class="token operator">::</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> WriteBatchInternal<span class="token operator">::</span><span class="token function">SetContents</span><span class="token punctuation">(</span>WriteBatch<span class="token operator">*</span> b<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> contents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>contents<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> kHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
  b<span class="token operator">-></span>rep_<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>contents<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> contents<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> WriteBatchInternal<span class="token operator">::</span><span class="token function">Append</span><span class="token punctuation">(</span>WriteBatch<span class="token operator">*</span> dst<span class="token punctuation">,</span> <span class="token keyword">const</span> WriteBatch<span class="token operator">*</span> src<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">SetCount</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> <span class="token function">Count</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">Count</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>src<span class="token operator">-></span>rep_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> kHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
  dst<span class="token operator">-></span>rep_<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>src<span class="token operator">-></span>rep_<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> kHeader<span class="token punctuation">,</span> src<span class="token operator">-></span>rep_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> kHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>Put</code> å’Œ <code>Delete</code> é¦–å…ˆå°†è®¡æ•°åŠ ä¸€ï¼Œåœ¨ <code>rep_</code> ä¸­å†™å…¥æ“ä½œç±»å‹ï¼Œå†å†™å…¥é”®å€¼å¯¹ã€‚<code>PutLengthPrefixedSlice</code> å‡½æ•°ä¼šå…ˆå†™å…¥å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå†å†™å…¥å­—ç¬¦ä¸²çš„å†…å®¹ã€‚<code>WriteBatchInternal</code> çš„èµ‹å€¼å’Œè¿½åŠ å‡æ˜¯å¯¹ <code>rep_</code> çš„è¿›è¡Œæ“ä½œã€‚ç»§ç»­çœ‹è¿­ä»£å‡½æ•°å’Œ <code>Handle</code> çš„éƒ¨åˆ†ï¼š</p>
<pre class="language-cpp"><code class="language-cpp">Status WriteBatch<span class="token operator">::</span><span class="token function">Iterate</span><span class="token punctuation">(</span>Handler<span class="token operator">*</span> handler<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
  Slice <span class="token function">input</span><span class="token punctuation">(</span>rep_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> kHeader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Status<span class="token operator">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"malformed WriteBatch (too small)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  input<span class="token punctuation">.</span><span class="token function">remove_prefix</span><span class="token punctuation">(</span>kHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Slice key<span class="token punctuation">,</span> value<span class="token punctuation">;</span>
  <span class="token keyword">int</span> found <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>input<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    found<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> tag <span class="token operator">=</span> input<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    input<span class="token punctuation">.</span><span class="token function">remove_prefix</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> kTypeValue<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GetLengthPrefixedSlice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">,</span> <span class="token operator">&amp;</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token function">GetLengthPrefixedSlice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          handler<span class="token operator">-></span><span class="token function">Put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> Status<span class="token operator">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"bad WriteBatch Put"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> kTypeDeletion<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GetLengthPrefixedSlice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">,</span> <span class="token operator">&amp;</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          handler<span class="token operator">-></span><span class="token function">Delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> Status<span class="token operator">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"bad WriteBatch Delete"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">return</span> Status<span class="token operator">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"unknown WriteBatch tag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>found <span class="token operator">!=</span> WriteBatchInternal<span class="token operator">::</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Status<span class="token operator">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"WriteBatch has wrong count"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Status<span class="token operator">::</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">namespace</span> <span class="token punctuation">{</span>
<span class="token keyword">class</span> <span class="token class-name">MemTableInserter</span> <span class="token operator">:</span> <span class="token keyword">public</span> WriteBatch<span class="token operator">::</span>Handler <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  SequenceNumber sequence_<span class="token punctuation">;</span>
  MemTable<span class="token operator">*</span> mem_<span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">Put</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> value<span class="token punctuation">)</span> override <span class="token punctuation">{</span>
    mem_<span class="token operator">-></span><span class="token function">Add</span><span class="token punctuation">(</span>sequence_<span class="token punctuation">,</span> kTypeValue<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sequence_<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">Delete</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">)</span> override <span class="token punctuation">{</span>
    mem_<span class="token operator">-></span><span class="token function">Add</span><span class="token punctuation">(</span>sequence_<span class="token punctuation">,</span> kTypeDeletion<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token function">Slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sequence_<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>  <span class="token comment">// namespace</span>

Status WriteBatchInternal<span class="token operator">::</span><span class="token function">InsertInto</span><span class="token punctuation">(</span><span class="token keyword">const</span> WriteBatch<span class="token operator">*</span> b<span class="token punctuation">,</span> MemTable<span class="token operator">*</span> memtable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  MemTableInserter inserter<span class="token punctuation">;</span>
  inserter<span class="token punctuation">.</span>sequence_ <span class="token operator">=</span> WriteBatchInternal<span class="token operator">::</span><span class="token function">Sequence</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
  inserter<span class="token punctuation">.</span>mem_ <span class="token operator">=</span> memtable<span class="token punctuation">;</span>
  <span class="token keyword">return</span> b<span class="token operator">-></span><span class="token function">Iterate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>inserter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>è¿­ä»£å‡½æ•° <code>WriteBatch::Iterate</code> ä¼šæŒ‰ç…§é¡ºåºå°† <code>rep_</code> ä¸­å­˜å‚¨çš„é”®å€¼å¯¹æ“ä½œæ”¾åˆ° <code>hander</code> ä¸Šæ‰§è¡Œã€‚ä¸‹é¢çš„åŒ¿åç©ºé—´é‡Œå®šä¹‰äº†ä¸€ä¸ªç»§æ‰¿ <code>Handler</code> çš„å­ç±» <code>MemTableInserter</code>ï¼Œå°† <code>Put</code> å’Œ <code>Delete</code> è½¬åˆ° <code>MemTable</code> ä¸Šæ‰§è¡Œã€‚<code>MemTable</code> å³ä¸ºå†…å­˜æ•°æ®åº“ï¼Œæœ¬æ–‡ç¨åä»‹ç»ã€‚<code>WriteBatchInternal::InsertInto</code> å°±ç›´æ¥æ ¹æ® <code>MemTable</code> æ„é€  <code>MemTableInserter</code>ã€‚è¿™æ ·åšçš„å¥½å¤„ï¼Œå¯èƒ½å°±æ˜¯ <code>WriteBatch::Iterate</code> ä¸ <code>MemTable</code> è§£è€¦ï¼Œ<code>Handler</code> å¯ä»¥è‡ªè¡Œæ›¿æ¢ã€‚</p>
<p>ç»¼åˆæ¥çœ‹ï¼Œ<code>WriteBatch</code> å°†æ‰€æœ‰çš„ä¿®æ”¹å’Œåˆ é™¤æ“ä½œå‡å­˜å‚¨åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­ï¼Œå¹¶ä¸”æä¾›äº†å†…å­˜æ•°æ®åº“çš„è¿­ä»£æ¥å£ã€‚è€Œå•ä¸ªå­—ç¬¦ä¸²ä¹Ÿå¯ä»¥éå¸¸æ–¹ä¾¿åœ°è¿›è¡ŒæŒä¹…åŒ–ï¼Œè¿™ä¸€ç‚¹ä¹Ÿä¼šåœ¨æ—¥å¿—éƒ¨åˆ†æœ‰æ‰€ä½“ç°ã€‚</p>
<h3 id="2.-æ—¥å¿—-log"><a href="#2.-%E6%97%A5%E5%BF%97-log">2. æ—¥å¿— Log</a></h3>
<p>åœ¨ <code>DB::Write</code> å‡½æ•°ä¸­ï¼Œæ ¸å¿ƒçš„å†™å…¥æ­¥éª¤ä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// Add to log and apply to memtable.  We can release the lock</span>
<span class="token comment">// during this phase since &amp;w is currently responsible for logging</span>
<span class="token comment">// and protects against concurrent loggers and concurrent writes</span>
<span class="token comment">// into mem_.</span>
<span class="token punctuation">{</span>
  mutex_<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  status <span class="token operator">=</span> log_<span class="token operator">-></span><span class="token function">AddRecord</span><span class="token punctuation">(</span>WriteBatchInternal<span class="token operator">::</span><span class="token function">Contents</span><span class="token punctuation">(</span>updates<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> sync_error <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    status <span class="token operator">=</span> logfile_<span class="token operator">-></span><span class="token function">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sync_error <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    status <span class="token operator">=</span> WriteBatchInternal<span class="token operator">::</span><span class="token function">InsertInto</span><span class="token punctuation">(</span>updates<span class="token punctuation">,</span> mem_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  mutex_<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The state of the log file is indeterminate: the log record we</span>
    <span class="token comment">// just added may or may not show up when the DB is re-opened.</span>
    <span class="token comment">// So we force the DB into a mode where all future writes fail.</span>
    <span class="token function">RecordBackgroundError</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>å…ˆè¿½åŠ åˆ°æ—¥å¿—ï¼Œå†å†™å…¥å†…å­˜æ•°æ®åº“ã€‚è¿™é‡Œçš„ <code>log_</code> ä¸ºæˆå‘˜å˜é‡ï¼Œç±»å‹ä¸º <code>log::Writer</code>ï¼Œå…¶å®šä¹‰ä½äº <a href="https://github.com/google/leveldb/blob/master/db/log_writer.h"><code>db/log_writer.h</code></a>ï¼š</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"db/log_format.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"leveldb/slice.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"leveldb/status.h"</span></span>

<span class="token keyword">namespace</span> leveldb <span class="token punctuation">{</span>

<span class="token keyword">class</span> <span class="token class-name">WritableFile</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> log <span class="token punctuation">{</span>

<span class="token keyword">class</span> <span class="token class-name">Writer</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token comment">// Create a writer that will append data to "*dest".</span>
  <span class="token comment">// "*dest" must be initially empty.</span>
  <span class="token comment">// "*dest" must remain live while this Writer is in use.</span>
  <span class="token keyword">explicit</span> <span class="token function">Writer</span><span class="token punctuation">(</span>WritableFile<span class="token operator">*</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Create a writer that will append data to "*dest".</span>
  <span class="token comment">// "*dest" must have initial length "dest_length".</span>
  <span class="token comment">// "*dest" must remain live while this Writer is in use.</span>
  <span class="token function">Writer</span><span class="token punctuation">(</span>WritableFile<span class="token operator">*</span> dest<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> dest_length<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">Writer</span><span class="token punctuation">(</span><span class="token keyword">const</span> Writer<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
  Writer<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Writer<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

  <span class="token operator">~</span><span class="token function">Writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  Status <span class="token function">AddRecord</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> slice<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  Status <span class="token function">EmitPhysicalRecord</span><span class="token punctuation">(</span>RecordType type<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ptr<span class="token punctuation">,</span> size_t length<span class="token punctuation">)</span><span class="token punctuation">;</span>

  WritableFile<span class="token operator">*</span> dest_<span class="token punctuation">;</span>
  <span class="token keyword">int</span> block_offset_<span class="token punctuation">;</span>  <span class="token comment">// Current offset in block</span>

  <span class="token comment">// crc32c values for all supported record types.  These are</span>
  <span class="token comment">// pre-computed to reduce the overhead of computing the crc of the</span>
  <span class="token comment">// record type stored in the header.</span>
  <span class="token keyword">uint32_t</span> type_crc_<span class="token punctuation">[</span>kMaxRecordType <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace log</span>
<span class="token punctuation">}</span>  <span class="token comment">// namespace leveldb</span>
</code></pre>
<p>å…¬å¼€çš„æ¥å£åªæœ‰ä¸€ä¸ª <code>Log::Writer::AddRecord</code>ï¼Œä¹Ÿå°±æ˜¯ <code>DB::Write</code>  ä¸­è°ƒç”¨çš„å‡½æ•°ã€‚å¦å¤–ç±»ä¸­è¿˜æœ‰ä¸€ä¸ªç§æœ‰æ•°ç»„ <code>type_crc_</code>ï¼Œå†…éƒ¨å­˜å‚¨äº†é¢„å…ˆè®¡ç®—çš„å‡ ç§ç±»å‹çš„ <code>CRC32</code> æ ¡éªŒå€¼ã€‚å¸¸é‡ <code>kMaxRecordType</code> å®šä¹‰äº <a href="https://github.com/google/leveldb/blob/master/db/format.h"><code>db/log_format.h</code></a>ï¼Œè¯¥æ–‡ä»¶å®šä¹‰äº†æ—¥å¿—æ ¼å¼ç›¸å…³çš„å‡ ä¸ªå¸¸é‡ï¼š</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">enum</span> <span class="token class-name">RecordType</span> <span class="token punctuation">{</span>
  <span class="token comment">// Zero is reserved for preallocated files</span>
  kZeroType <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>

  kFullType <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>

  <span class="token comment">// For fragments</span>
  kFirstType <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
  kMiddleType <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
  kLastType <span class="token operator">=</span> <span class="token number">4</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> kMaxRecordType <span class="token operator">=</span> kLastType<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> kBlockSize <span class="token operator">=</span> <span class="token number">32768</span><span class="token punctuation">;</span>

<span class="token comment">// Header is checksum (4 bytes), length (2 bytes), type (1 byte).</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> kHeaderSize <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre>
<p>æ—¥å¿—ç±»ä¸­çš„ <code>AddRecord</code> å‡½æ•°æ¯æ¬¡è°ƒç”¨ä¼šå¢åŠ ä¸€æ¡è®°å½• Recordï¼ŒåŒæ—¶æˆ‘ä»¬éœ€è¦ä¿è¯ä»¥åå¯ä»¥æŒ‰é¡ºåºè¯»å–å‡ºæ¯ä¸€æ¡ Recordã€‚ä¸ºäº†æå‡æ—¥å¿—çš„è¯»å–é€Ÿåº¦é€Ÿåº¦ï¼ŒLevelDB å¼•å…¥äº† Block çš„æ¦‚å¿µã€‚åœ¨è¯»å†™æ–‡ä»¶æ—¶ä¼šæŒ‰ç…§ä¸€ä¸ªä¸€ä¸ª Block æ¥è¯»å†™ï¼Œé»˜è®¤çš„ Block å¤§å°ä¸º <code>kBlockSize = 32KB</code>ã€‚è€Œä¸€æ¡è®°å½•å¯èƒ½æ¯” Block è¿˜è¦é•¿ï¼Œæ‰€ä»¥è¿˜éœ€è¦å¯¹è¿‡é•¿çš„ Record åšåˆé€‚çš„åˆ‡åˆ†ï¼Œåˆ‡æˆç‰‡æ®µ Fragment åå†æ”¾å…¥ Block ä¸­ã€‚Fragment åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼Œåˆ†åˆ«æ˜¯ <code>kFirstType</code>ã€<code>kMiddleType</code> å’Œ <code>kLastType</code>ï¼Œå‚çœ‹ä¸‹å›¾ï¼š</p>
<figure tabindex="1"><a href="../images/0401845d2d596d0a577fe164ba72f66a.svg"><img src="../images/0401845d2d596d0a577fe164ba72f66a.svg" alt=""></a><figcaption>Log Format</figcaption></figure>
<p>ç»§ç»­çœ‹ <a href="https://github.com/google/leveldb/blob/master/db/log_writer.cc"><code>db/log_writer.cc</code></a> çš„å…·ä½“å®ç°ï¼š</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"db/log_writer.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"leveldb/env.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"util/coding.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"util/crc32c.h"</span></span>

<span class="token keyword">namespace</span> leveldb <span class="token punctuation">{</span>
<span class="token keyword">namespace</span> log <span class="token punctuation">{</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">InitTypeCrc</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token operator">*</span> type_crc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> kMaxRecordType<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> t <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    type_crc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> crc32c<span class="token operator">::</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Writer<span class="token operator">::</span><span class="token function">Writer</span><span class="token punctuation">(</span>WritableFile<span class="token operator">*</span> dest<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">dest_</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">block_offset_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">InitTypeCrc</span><span class="token punctuation">(</span>type_crc_<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Writer<span class="token operator">::</span><span class="token function">Writer</span><span class="token punctuation">(</span>WritableFile<span class="token operator">*</span> dest<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> dest_length<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">dest_</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">block_offset_</span><span class="token punctuation">(</span>dest_length <span class="token operator">%</span> kBlockSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">InitTypeCrc</span><span class="token punctuation">(</span>type_crc_<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Writer<span class="token operator">::</span><span class="token operator">~</span><span class="token function">Writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

Status Writer<span class="token operator">::</span><span class="token function">EmitPhysicalRecord</span><span class="token punctuation">(</span>RecordType t<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ptr<span class="token punctuation">,</span>
                                  size_t length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>length <span class="token operator">&lt;=</span> <span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Must fit in two bytes</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>block_offset_ <span class="token operator">+</span> kHeaderSize <span class="token operator">+</span> length <span class="token operator">&lt;=</span> kBlockSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Format the header</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span>kHeaderSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
  buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">(</span>length <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">(</span>length <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  buf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Compute the crc of the record type and the payload.</span>
  <span class="token keyword">uint32_t</span> crc <span class="token operator">=</span> crc32c<span class="token operator">::</span><span class="token function">Extend</span><span class="token punctuation">(</span>type_crc_<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  crc <span class="token operator">=</span> crc32c<span class="token operator">::</span><span class="token function">Mask</span><span class="token punctuation">(</span>crc<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Adjust for storage</span>
  <span class="token function">EncodeFixed32</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> crc<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Write the header and the payload</span>
  Status s <span class="token operator">=</span> dest_<span class="token operator">-></span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token function">Slice</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> kHeaderSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s <span class="token operator">=</span> dest_<span class="token operator">-></span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token function">Slice</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      s <span class="token operator">=</span> dest_<span class="token operator">-></span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  block_offset_ <span class="token operator">+=</span> kHeaderSize <span class="token operator">+</span> length<span class="token punctuation">;</span>
  <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace log</span>
<span class="token punctuation">}</span>  <span class="token comment">// namespace leveldb</span>
</code></pre>
<p>æ„é€ æ—¶ <code>InitTypeCrc</code> å‡½æ•°åˆå§‹åŒ–äº† <code>type_crc_</code> æ•°ç»„ï¼Œå¦å¤–å¦‚æœæ„é€ æ—¶æœ‰ <code>dest_length</code> å‚æ•°ï¼Œåˆ™å°† <code>block_offset_</code> è®¾ä¸º <code>dest_length % kBlockSize</code>ã€‚è‡³äºå‡½æ•° <code>EmitPhysicalRecord</code>ï¼Œä»å‡½æ•°åæ¥çœ‹å…¶ä½œç”¨æ˜¯è§¦å‘ç‰©ç†è®°å½•ã€‚è¯¥å‡½æ•°å…ˆæ„é€ äº†ä¸€ä¸ª Record Header <code>buf</code>ï¼Œå‰ 4 å­—èŠ‚å­˜å‚¨ CRC32 æ ¡éªŒå€¼ï¼Œåé¢ä¾æ¬¡å­˜å‚¨é•¿åº¦å’Œ Record ç±»å‹ã€‚æœ€ç»ˆä¼šå°† Headerã€å­—èŠ‚æµå†™å…¥æ–‡ä»¶å¹¶åˆ·æ–°ï¼Œå¹¶ä¸”æ›´æ–° <code>block_offset_</code>ã€‚æœ€åæ¥çœ‹ä¸‹ <code>Log::Writer::AddRecord</code> å‡½æ•°çš„å®ç°ï¼š</p>
<pre class="language-cpp"><code class="language-cpp">Status Writer<span class="token operator">::</span><span class="token function">AddRecord</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> slice<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ptr <span class="token operator">=</span> slice<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  size_t left <span class="token operator">=</span> slice<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Fragment the record if necessary and emit it.  Note that if slice</span>
  <span class="token comment">// is empty, we still want to iterate once to emit a single</span>
  <span class="token comment">// zero-length record</span>
  Status s<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> begin <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> leftover <span class="token operator">=</span> kBlockSize <span class="token operator">-</span> block_offset_<span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>leftover <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>leftover <span class="token operator">&lt;</span> kHeaderSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Switch to a new block</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>leftover <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Fill the trailer (literal below relies on kHeaderSize being 7)</span>
        <span class="token keyword">static_assert</span><span class="token punctuation">(</span>kHeaderSize <span class="token operator">==</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dest_<span class="token operator">-></span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token function">Slice</span><span class="token punctuation">(</span><span class="token string">"\x00\x00\x00\x00\x00\x00"</span><span class="token punctuation">,</span> leftover<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      block_offset_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Invariant: we never leave &lt; kHeaderSize bytes in a block.</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>kBlockSize <span class="token operator">-</span> block_offset_ <span class="token operator">-</span> kHeaderSize <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> size_t avail <span class="token operator">=</span> kBlockSize <span class="token operator">-</span> block_offset_ <span class="token operator">-</span> kHeaderSize<span class="token punctuation">;</span>
    <span class="token keyword">const</span> size_t fragment_length <span class="token operator">=</span> <span class="token punctuation">(</span>left <span class="token operator">&lt;</span> avail<span class="token punctuation">)</span> <span class="token operator">?</span> left <span class="token operator">:</span> avail<span class="token punctuation">;</span>

    RecordType type<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">bool</span> end <span class="token operator">=</span> <span class="token punctuation">(</span>left <span class="token operator">==</span> fragment_length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>begin <span class="token operator">&amp;&amp;</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      type <span class="token operator">=</span> kFullType<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>begin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      type <span class="token operator">=</span> kFirstType<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      type <span class="token operator">=</span> kLastType<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      type <span class="token operator">=</span> kMiddleType<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    s <span class="token operator">=</span> <span class="token function">EmitPhysicalRecord</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> fragment_length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ptr <span class="token operator">+=</span> fragment_length<span class="token punctuation">;</span>
    left <span class="token operator">-=</span> fragment_length<span class="token punctuation">;</span>
    begin <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> left <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>å‡½æ•°é¦–å…ˆä¼šè®¡ç®—å½“å‰ Block å‰©ä½™ç©ºé—´å¤§å° <code>leftover</code>ï¼Œå¦‚æœè¿ Header éƒ½æ²¡æ³•å†™è¿›å»ï¼Œå°±ç›´æ¥å¡«å…… 0 è¿›å»ï¼ŒåæœŸè¯»å–æ—¶ä¼šç›´æ¥è¿‡æ»¤æ‰ã€‚è€Œåè®¡ç®—å¯ç”¨çš„ç©ºé—´å¤§å° <code>avail</code> å’Œå½“å‰å†™å…¥çš„é•¿åº¦ <code>fragment_length</code> ä»¥åŠå¯¹åº”çš„è®°å½•ç±»å‹ <code>type</code>ï¼Œæœ€åè°ƒç”¨ <code>EmitPhysicalRecord</code> åˆ·å…¥æ–‡ä»¶ã€‚è¿™ç§æ–¹å¼å¯ä»¥ä¿è¯å†™ Record æ—¶æŒ‰ç…§ <code>BlockSize</code> å¯¹é½ã€‚</p>
<p>ç»¼ä¸Šæ¥çœ‹ï¼Œå†™å…¥æ—¶é¦–å…ˆä¼šæŠŠ <code>WriteBatch::rep_</code> å¯¹é½åœ°è¿½åŠ åˆ°æ—¥å¿—ä¸­ï¼Œå†™å…¥æ—¶åšäº†åˆé€‚çš„åˆ‡åˆ†ï¼Œå¹¶ä¸”åŠ å…¥äº† CRC æ ¡éªŒã€‚æœ‰å†™è‚¯å®šæœ‰è¯»ï¼Œå½“è¿›è¡Œæ¢å¤æ“ä½œæ—¶å°±ä¼šè¯»å–ä¸Šè¿°æ—¥å¿—ï¼Œ<code>Log::Reader</code> ä»£ç å®ç°ä½äº  <a href="https://github.com/google/leveldb/blob/master/db/log_reader.h"><code>db/log_reader.h</code></a> å’Œ <a href="https://github.com/google/leveldb/blob/master/db/log_reader.cc"><code>db/log_reader.cc</code></a>ï¼Œè¯»å–çš„è¿‡ç¨‹å³ä¸ºå†™å…¥çš„é€†è¿‡ç¨‹ï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªè¡Œé˜…è¯»ã€‚</p>

      </div>
      <div id="gitalk-container">
      </div>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          CopyrightÂ©2020 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/gitalk.min.js"></script>
    <script src="/dist/main.js"></script>
  </body>
</html>
