<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>PaxosStore 源码分析「四、协议日志」 | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> PaxosStore 源码分析「四、协议日志」 </h1>
      </div>
      <div class="info">
        <div class="date"> 2020.03.08 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <p><a href="/#/Paxos">本系列</a>的<a href="/paxos/paxos_store_03_consensus.html">上一篇</a>里分析了 PaxosStore 中共识协议的实现，本篇将聚焦 Paxos 协议中 PaxosLog 的实现。博文标题为了对齐一下，强行翻译为协议日志，不必太在意 :D</p>
<h3 id="1.-术语解释" tabindex="-1"><a href="#1.-%E6%9C%AF%E8%AF%AD%E8%A7%A3%E9%87%8A">1. 术语解释</a></h3>
<p>PaxosStore 中引入了一些术语，这里笔者会按照自己的理解解释一下。首先是 <strong>Entry</strong>，英文翻译为条目，可以理解为一次 Paxos 过程。Entry 包含一个严格单调递增的编号 <code>iEntry</code> 和一个 Paxos 状态机 <code>poMachine</code>，日常存储于内存中，代码定义于 <a href="https://github.com/Tencent/paxosstore/blob/master/certain/src/EntryInfoMng.h"><code>src/EntryInfoMng.h</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">EntryInfo_t</span> <span class="token punctuation">{</span>
  EntityInfo_t <span class="token operator">*</span>ptEntityInfo<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iEntry<span class="token punctuation">;</span>  <span class="token comment">// 编号</span>

  <span class="token keyword">uint32_t</span> iEntrySize<span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> iInteractCnt<span class="token punctuation">;</span>

  <span class="token keyword">bool</span> bCatchUpFlag<span class="token punctuation">;</span>    <span class="token comment">// 是否正在 CatchUp，后续博文有 CatchUp 的介绍</span>
  <span class="token keyword">bool</span> bUncertain<span class="token punctuation">;</span>      <span class="token comment">// 是否处于 Uncertain 的状态，该 Entry 在内存上的更新未落盘时则处于 Uncertain 状态，落盘完成后取消该状态</span>
  <span class="token keyword">bool</span> bRemoteUpdated<span class="token punctuation">;</span>  <span class="token comment">// 是否需要更新远端节点上的 Entry</span>
  <span class="token keyword">bool</span> bBroadcast<span class="token punctuation">;</span>      <span class="token comment">// 是否需要广播给所有节点</span>
  <span class="token keyword">bool</span> bNotFound<span class="token punctuation">;</span>       <span class="token comment">// 本地对应的 PLog 是否已删除</span>

  clsPaxosCmd <span class="token operator">*</span><span class="token operator">*</span>apWaitingMsg<span class="token punctuation">;</span>

  clsEntryStateMachine <span class="token operator">*</span>poMachine<span class="token punctuation">;</span>  <span class="token comment">// Paxos 状态机</span>

  <span class="token comment">// For clsArrayTimer&lt;EntryInfo_t>.</span>
  clsArrayTimer<span class="token operator">&lt;</span>EntryInfo_t<span class="token operator">></span><span class="token double-colon punctuation">::</span>TimeoutEntry_t tTimeoutEntry<span class="token punctuation">;</span>

  <span class="token comment">// For tEntryList in EntityInfo</span>
  <span class="token function">CIRCLEQ_ENTRY</span><span class="token punctuation">(</span>EntryInfo_t<span class="token punctuation">)</span> tListElt<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>然后是 <strong>Entity</strong>，英文翻译为实体，可以理解为执行多次 Paxos 过程的对象，例如用户的银行账户。Entity 包含一个唯一 ID <code>iEntityID</code>、一组 <code>Entry</code> 和一些自身状态，也存储于内存中，代码定义于 <a href="https://github.com/Tencent/paxosstore/blob/master/certain/src/EntityInfoMng.h"><code>src/EntityInfoMng.h</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">EntityInfo_t</span> <span class="token punctuation">{</span>
  <span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">;</span>  <span class="token comment">// 唯一 ID</span>

  <span class="token keyword">volatile</span> <span class="token keyword">uint64_t</span> iMaxPLogEntry<span class="token punctuation">;</span>        <span class="token comment">// 最大的 PLog 进度</span>
  <span class="token keyword">volatile</span> <span class="token keyword">uint64_t</span> iMaxChosenEntry<span class="token punctuation">;</span>      <span class="token comment">// 已知的全局最大 Chosen 进度</span>
  <span class="token keyword">volatile</span> <span class="token keyword">uint64_t</span> iMaxContChosenEntry<span class="token punctuation">;</span>  <span class="token comment">// 获取到的最大连续 Chosen 进度，连续表示没有空洞</span>

  <span class="token keyword">uint64_t</span> iLocalPreAuthEntry<span class="token punctuation">;</span>   <span class="token comment">// 预授权的 Entry 编号，参见本系列第六篇预授权优化部分</span>
  <span class="token keyword">uint64_t</span> iCatchUpEntry<span class="token punctuation">;</span>        <span class="token comment">// 当前尝试 CatchUp 的最大 Entry</span>
  <span class="token keyword">uint64_t</span> iValueIDGenerator<span class="token punctuation">;</span>    <span class="token comment">// ValueID 生成器，实现上是时间戳 + 自增编号</span>
  <span class="token keyword">uint64_t</span> iNotifyedEntry<span class="token punctuation">;</span>       <span class="token comment">// 已经通知 DBWorker Commit 的最大 Entry</span>
  <span class="token keyword">uint64_t</span> iGetAllFinishTimeMS<span class="token punctuation">;</span>  <span class="token comment">// 上次 GetAll 完成的时间，避免短时间重复 GetAll</span>

  clsClientCmd <span class="token operator">*</span>poClientCmd<span class="token punctuation">;</span>
  clsPaxosCmd <span class="token operator">*</span><span class="token operator">*</span>apWaitingMsg<span class="token punctuation">;</span>
  clsLeasePolicy <span class="token operator">*</span>poLeasePolicy<span class="token punctuation">;</span>

  <span class="token function">CIRCLEQ_HEAD</span><span class="token punctuation">(</span>EntryList_t<span class="token punctuation">,</span> EntryInfo_t<span class="token punctuation">)</span> tEntryList<span class="token punctuation">;</span>  <span class="token comment">// 当前存储的一组 Entry</span>

  <span class="token keyword">uint32_t</span> iLocalAcceptorID<span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> iActiveAcceptorID<span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> iWaitingSize<span class="token punctuation">;</span>

  <span class="token keyword">volatile</span> <span class="token keyword">int32_t</span> iRefCount<span class="token punctuation">;</span>

  <span class="token keyword">bool</span> bRangeLoading<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> bRangeLoaded<span class="token punctuation">;</span>

  <span class="token keyword">bool</span> bGetAllPending<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>内存中的 Entry 持久化时会存储为 <strong>EntryRecord</strong>，<a href="/paxos/paxos_store_03_consensus.html#3.-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0">后者在上一篇中提到过</a>。将所有 <strong>EntryRecord</strong> 按顺序存储起来，就可以按需恢复出 <strong>Entity</strong> 的状态。PaxosStore 中将这些 <strong>EntryRecord</strong> 称为 <strong>PLog</strong>，存储 <strong>PLog</strong> 的数据库称为 <strong>PLogDB</strong>。</p>
<h3 id="2.-日志读写" tabindex="-1"><a href="#2.-%E6%97%A5%E5%BF%97%E8%AF%BB%E5%86%99">2. 日志读写</a></h3>
<p>PaxosStore 中使用 <code>PLogWorker</code> 来处理 <strong>PLog</strong> 的读写，流程基本是请求方将请求塞入队列、<code>PLogWorker</code> 从队列中获取请求、执行读写操作、最后将回复塞入队列。代码见 <a href="https://github.com/Tencent/paxosstore/blob/master/certain/src/PLogWorker.cpp"><code>src/PLogWorker.cpp</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// 将 Req 塞到队列里</span>
<span class="token keyword">int</span> clsPLogWorker<span class="token double-colon punctuation">::</span><span class="token function">EnterPLogReqQueue</span><span class="token punctuation">(</span>clsCmdBase <span class="token operator">*</span>poCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">uint64_t</span> iEntityID <span class="token operator">=</span> poCmd<span class="token operator">-></span><span class="token function">GetEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  clsAsyncQueueMng <span class="token operator">*</span>poQueueMng <span class="token operator">=</span> clsAsyncQueueMng<span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  clsConfigure <span class="token operator">*</span>poConf <span class="token operator">=</span> clsCertainWrapper<span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  clsPLogReqQueue <span class="token operator">*</span>poQueue <span class="token operator">=</span>
      poQueueMng<span class="token operator">-></span><span class="token function">GetPLogReqQueue</span><span class="token punctuation">(</span><span class="token function">Hash</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">)</span> <span class="token operator">%</span> poConf<span class="token operator">-></span><span class="token function">GetPLogWorkerNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  poCmd<span class="token operator">-></span><span class="token function">SetTimestampUS</span><span class="token punctuation">(</span><span class="token function">GetCurrTimeUS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> iRet <span class="token operator">=</span> poQueue<span class="token operator">-></span><span class="token function">PushByMultiThread</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">OSS</span><span class="token double-colon punctuation">::</span><span class="token function">ReportPLogQueueErr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 启动协程处理 PLogReqQueue 中地请求</span>
<span class="token keyword">void</span> clsPLogWorker<span class="token double-colon punctuation">::</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Bind cpu affinity here.</span>
  <span class="token keyword">uint32_t</span> iLocalServerID <span class="token operator">=</span> m_poConf<span class="token operator">-></span><span class="token function">GetLocalServerID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">SetThreadTitle</span><span class="token punctuation">(</span><span class="token string">"plog_%u_%u"</span><span class="token punctuation">,</span> iLocalServerID<span class="token punctuation">,</span> m_iWorkerID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"plog_%u_%u run"</span><span class="token punctuation">,</span> iLocalServerID<span class="token punctuation">,</span> m_iWorkerID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">co_enable_hook_sys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  stCoEpoll_t <span class="token operator">*</span>ev <span class="token operator">=</span> <span class="token function">co_get_epoll_ct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  s_epoll_stat <span class="token operator">=</span> <span class="token punctuation">(</span>EpollRunStat_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">calloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>EpollRunStat_t<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// co_set_eventloop_stat( OnEpollStart,OnEpollEnd );</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">int</span><span class="token punctuation">(</span>m_poConf<span class="token operator">-></span><span class="token function">GetPLogRoutineCnt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    PLogRoutine_t <span class="token operator">*</span>w <span class="token operator">=</span> <span class="token punctuation">(</span>PLogRoutine_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>PLogRoutine_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stCoRoutine_t <span class="token operator">*</span>co <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token function">co_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>co<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> PLogRoutine<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> iRoutineID <span class="token operator">=</span> m_iStartRoutineID <span class="token operator">+</span> i<span class="token punctuation">;</span>
    w<span class="token operator">-></span>pCo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>co<span class="token punctuation">;</span>
    w<span class="token operator">-></span>pSelf <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    w<span class="token operator">-></span>pData <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    w<span class="token operator">-></span>bHasJob <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    w<span class="token operator">-></span>iRoutineID <span class="token operator">=</span> iRoutineID<span class="token punctuation">;</span>
    <span class="token function">co_resume</span><span class="token punctuation">(</span><span class="token punctuation">(</span>stCoRoutine_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>w<span class="token operator">-></span>pCo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PLogWorker idx %d %u Routine\n"</span><span class="token punctuation">,</span> m_iWorkerID<span class="token punctuation">,</span> m_poConf<span class="token operator">-></span><span class="token function">GetPLogRoutineCnt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CertainLogImpt</span><span class="token punctuation">(</span><span class="token string">"PLogWorker idx %d %u Routine"</span><span class="token punctuation">,</span> m_iWorkerID<span class="token punctuation">,</span> m_poConf<span class="token operator">-></span><span class="token function">GetPLogRoutineCnt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">co_eventloop</span><span class="token punctuation">(</span>ev<span class="token punctuation">,</span> CoEpollTick<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 协程 Tick，给空闲的协程分配任务</span>
<span class="token keyword">int</span> clsPLogWorker<span class="token double-colon punctuation">::</span><span class="token function">CoEpollTick</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  clsPLogWorker <span class="token operator">*</span>pPLogWorker <span class="token operator">=</span> <span class="token punctuation">(</span>clsPLogWorker <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
  stack<span class="token operator">&lt;</span>PLogRoutine_t <span class="token operator">*</span><span class="token operator">></span> <span class="token operator">&amp;</span>IdleCoList <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>pPLogWorker<span class="token operator">-></span>m_poCoWorkList<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>pPLogWorker<span class="token operator">-></span><span class="token function">CheckIfExiting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">TIMERUS_START</span><span class="token punctuation">(</span>iCoEpollTickTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iGetFromIdleCoListCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>IdleCoList<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    clsCmdBase <span class="token operator">*</span>poCmd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> iRet <span class="token operator">=</span> pPLogWorker<span class="token operator">-></span>m_poPLogReqQueue<span class="token operator">-></span><span class="token function">TakeByOneThread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> poCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">uint64_t</span> iUseTimeUS <span class="token operator">=</span> <span class="token function">GetCurrTimeUS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> poCmd<span class="token operator">-></span><span class="token function">GetTimestampUS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      s_poPLogReqQueueWait<span class="token operator">-></span><span class="token function">Update</span><span class="token punctuation">(</span>iUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>

      PLogRoutine_t <span class="token operator">*</span>w <span class="token operator">=</span> IdleCoList<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      w<span class="token operator">-></span>pData <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>poCmd<span class="token punctuation">;</span>
      w<span class="token operator">-></span>bHasJob <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      IdleCoList<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">co_resume</span><span class="token punctuation">(</span><span class="token punctuation">(</span>stCoRoutine_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>w<span class="token operator">-></span>pCo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      iGetFromIdleCoListCnt<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  s_poGetFromIdleCoListCnt<span class="token operator">-></span><span class="token function">Update</span><span class="token punctuation">(</span>iGetFromIdleCoListCnt<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">TIMERUS_STOP</span><span class="token punctuation">(</span>iCoEpollTickTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  s_poCoEpollTick<span class="token operator">-></span><span class="token function">Update</span><span class="token punctuation">(</span>iCoEpollTickTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>

  clsCertainUserBase <span class="token operator">*</span>pCertainUser <span class="token operator">=</span> clsCertainWrapper<span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetCertainUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pCertainUser<span class="token operator">-></span><span class="token function">TickHandleCallBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 协程函数：处理 PLog Req</span>
<span class="token keyword">void</span> <span class="token operator">*</span>clsPLogWorker<span class="token double-colon punctuation">::</span><span class="token function">PLogRoutine</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  PLogRoutine_t <span class="token operator">*</span>pPLogRoutine <span class="token operator">=</span> <span class="token punctuation">(</span>PLogRoutine_t <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
  <span class="token function">co_enable_hook_sys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  clsCertainUserBase <span class="token operator">*</span>pCertainUser <span class="token operator">=</span> clsCertainWrapper<span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetCertainUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pCertainUser<span class="token operator">-></span><span class="token function">SetRoutineID</span><span class="token punctuation">(</span>pPLogRoutine<span class="token operator">-></span>iRoutineID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    clsPLogWorker <span class="token operator">*</span>pPLogWorker <span class="token operator">=</span> <span class="token punctuation">(</span>clsPLogWorker <span class="token operator">*</span><span class="token punctuation">)</span>pPLogRoutine<span class="token operator">-></span>pSelf<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pPLogRoutine<span class="token operator">-></span>bHasJob<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">AssertEqual</span><span class="token punctuation">(</span>pPLogRoutine<span class="token operator">-></span>pData<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      pPLogWorker<span class="token operator">-></span>m_poCoWorkList<span class="token operator">-></span><span class="token function">push</span><span class="token punctuation">(</span>pPLogRoutine<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">co_yield_ct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">AssertNotEqual</span><span class="token punctuation">(</span>pPLogRoutine<span class="token operator">-></span>pData<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    clsCmdBase <span class="token operator">*</span>poCmd <span class="token operator">=</span> <span class="token punctuation">(</span>clsCmdBase <span class="token operator">*</span><span class="token punctuation">)</span>pPLogRoutine<span class="token operator">-></span>pData<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>poCmd<span class="token operator">-></span><span class="token function">GetCmdID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> kPaxosCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// PaxosCmd 执行 DoWithPaxosCmd</span>
      pPLogWorker<span class="token operator">-></span><span class="token function">DoWithPaxosCmd</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>clsPaxosCmd <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>poCmd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">AssertEqual</span><span class="token punctuation">(</span>poCmd<span class="token operator">-></span><span class="token function">GetCmdID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kRecoverCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// RecoverCmd 执行 DoWithRecoverCmd</span>
      pPLogWorker<span class="token operator">-></span><span class="token function">DoWithRecoverCmd</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>clsRecoverCmd <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>poCmd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    pPLogRoutine<span class="token operator">-></span>bHasJob <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    pPLogRoutine<span class="token operator">-></span>pData <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 处理 Paxos Cmd</span>
<span class="token comment">// 一种是读取 PLogDB，而后通过 IO 回包</span>
<span class="token comment">// 一种是存储 PaxosCmd 中的 MaxPLogEntry 和 Record 到 PLogDB，而后进入回复阶段</span>
<span class="token comment">// 注意有 CheckHasMore 的逻辑，会检查当前 Entry 之后还有没有更新的记录，后续博文会提高这部分逻辑</span>
<span class="token keyword">int</span> clsPLogWorker<span class="token double-colon punctuation">::</span><span class="token function">DoWithPLogRequest</span><span class="token punctuation">(</span>clsPaxosCmd <span class="token operator">*</span>poPaxosCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iRet<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iEntityID <span class="token operator">=</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iEntry <span class="token operator">=</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">IsPLogReturn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果设定了 PLogReturn (MaxContChosenEntry >= iEntry)</span>
    EntryRecord_t tSrcRecord<span class="token punctuation">;</span>
    <span class="token comment">// 从 PLog Engine 中读取 Record</span>
    iRet <span class="token operator">=</span> m_poPLogEngine<span class="token operator">-></span><span class="token function">GetRecord</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> tSrcRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"record: %s bChose %d"</span><span class="token punctuation">,</span> <span class="token function">EntryRecordToString</span><span class="token punctuation">(</span>tSrcRecord<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                     tSrcRecord<span class="token punctuation">.</span>bChosen<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tSrcRecord<span class="token punctuation">.</span>bChosen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果被 Chosen 了，那么直接将 Record 存到 Cmd 里</span>
        poPaxosCmd<span class="token operator">-></span><span class="token function">SetSrcRecord</span><span class="token punctuation">(</span>tSrcRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果没有被 Chosen，直接将返回值设定为未找到（未 Chosen，皆为变数）</span>
        poPaxosCmd<span class="token operator">-></span><span class="token function">SetResult</span><span class="token punctuation">(</span>eRetCodeNotFound<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> eRetCodeNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      poPaxosCmd<span class="token operator">-></span><span class="token function">SetResult</span><span class="token punctuation">(</span>eRetCodeNotFound<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"BUG cmd: %s ret %d"</span><span class="token punctuation">,</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 通过 IO 发送回复</span>
    m_poIOWorkerRouter<span class="token operator">-></span><span class="token function">GoAndDeleteIfFailed</span><span class="token punctuation">(</span>poPaxosCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">IsCheckHasMore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> m_poConf<span class="token operator">-></span><span class="token function">GetUsePLogWriteWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    EntryRecord_t tRecord <span class="token operator">=</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetSrcRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">uint64_t</span> iMaxPLogEntry <span class="token operator">=</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetMaxPLogEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_poConf<span class="token operator">-></span><span class="token function">GetEnableMaxPLogEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      iMaxPLogEntry <span class="token operator">=</span> INVALID_ENTRY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 将 Cmd 中的 MaxPLogEntry 和 EntryRecord 写入 PLogDB</span>
    iRet <span class="token operator">=</span> m_poPLogEngine<span class="token operator">-></span><span class="token function">PutRecord</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iMaxPLogEntry<span class="token punctuation">,</span> tRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) PutRecord ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
      poPaxosCmd<span class="token operator">-></span><span class="token function">SetPLogError</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">IsCheckHasMore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果设定了要 CheckHasMore</span>
      <span class="token keyword">bool</span> bHasMore <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      vector<span class="token operator">&lt;</span>pair<span class="token operator">&lt;</span><span class="token keyword">uint64_t</span><span class="token punctuation">,</span> string<span class="token operator">></span> <span class="token operator">></span> vecRecord<span class="token punctuation">;</span>
      <span class="token function">TIMERUS_START</span><span class="token punctuation">(</span>iRangeLoadUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 从 PLogDB 中读取未 Commit 的 Record 列表信息</span>
      iRet <span class="token operator">=</span> m_poPLogEngine<span class="token operator">-></span><span class="token function">LoadUncommitedEntrys</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> vecRecord<span class="token punctuation">,</span> bHasMore<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">TIMERUS_STOP</span><span class="token punctuation">(</span>iRangeLoadUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      s_poLoadUncommitedEntrysTimeStat<span class="token operator">-></span><span class="token function">Update</span><span class="token punctuation">(</span>iRangeLoadUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">OSS</span><span class="token double-colon punctuation">::</span><span class="token function">ReportPLogRangeLoadTimeMS</span><span class="token punctuation">(</span>iRet<span class="token punctuation">,</span> iRangeLoadUseTimeUS <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>iRangeLoadUseTimeUS <span class="token operator">></span> <span class="token number">100000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) more %u iRangeLoadUseTimeUS %lu"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> bHasMore<span class="token punctuation">,</span>
                        iRangeLoadUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) LoadUncommitedEntrys ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        poPaxosCmd<span class="token operator">-></span><span class="token function">SetPLogError</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// PLogDB 中还有更多的 Record</span>
        poPaxosCmd<span class="token operator">-></span><span class="token function">SetHasMore</span><span class="token punctuation">(</span>bHasMore<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 进入回复队列</span>
    clsPLogWorker<span class="token double-colon punctuation">::</span><span class="token function">EnterPLogRspQueue</span><span class="token punctuation">(</span>poPaxosCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">SendToWriteWorker</span><span class="token punctuation">(</span>poPaxosCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将回复塞到队列里</span>
<span class="token keyword">int</span> clsPLogWorker<span class="token double-colon punctuation">::</span><span class="token function">EnterPLogRspQueue</span><span class="token punctuation">(</span>clsCmdBase <span class="token operator">*</span>poCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">uint64_t</span> iEntityID <span class="token operator">=</span> poCmd<span class="token operator">-></span><span class="token function">GetEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  clsAsyncQueueMng <span class="token operator">*</span>poQueueMng <span class="token operator">=</span> clsAsyncQueueMng<span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  clsConfigure <span class="token operator">*</span>poConf <span class="token operator">=</span> clsCertainWrapper<span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  clsPLogRspQueue <span class="token operator">*</span>poQueue <span class="token operator">=</span>
      poQueueMng<span class="token operator">-></span><span class="token function">GetPLogRspQueue</span><span class="token punctuation">(</span><span class="token function">Hash</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">)</span> <span class="token operator">%</span> poConf<span class="token operator">-></span><span class="token function">GetEntityWorkerNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> iRet <span class="token operator">=</span> poQueue<span class="token operator">-></span><span class="token function">PushByMultiThread</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"PushByMultiThread ret %d cmd: %s"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">,</span> poCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">poll</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">uint64_t</span> iUseTimeUS <span class="token operator">=</span> <span class="token function">GetCurrTimeUS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> poCmd<span class="token operator">-></span><span class="token function">GetTimestampUS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  s_poPLogCmdOuterTimeStat<span class="token operator">-></span><span class="token function">Update</span><span class="token punctuation">(</span>iUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>代码中的 <code>m_poPLogEngine</code> 实际上是一个 <code>clsPLogBase</code> 对象，用以实现真正的 <strong>PLogDB</strong> 持久化。PaxosStore 中定义了其基类，剩余了部分虚函数需要用户实现：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">PLogEntityMeta_t</span> <span class="token punctuation">{</span>
  <span class="token keyword">uint64_t</span> iMaxPLogEntry<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">clsPLogBase</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">PrintUseTimeStat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">InitUseTimeStat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> <span class="token function">GetRecord</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iEntry<span class="token punctuation">,</span> EntryRecord_t <span class="token operator">&amp;</span>tSrcRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> <span class="token function">PutRecord</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iEntry<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iMaxPLogEntry<span class="token punctuation">,</span> EntryRecord_t tRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">clsPLogBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">Put</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iEntry<span class="token punctuation">,</span> <span class="token keyword">const</span> string <span class="token operator">&amp;</span>strRecord<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iEntry<span class="token punctuation">,</span> string <span class="token operator">&amp;</span>strRecord<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">PutValue</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iEntry<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iValueID<span class="token punctuation">,</span>
                       <span class="token keyword">const</span> string <span class="token operator">&amp;</span>strValue<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">GetValue</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iEntry<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iValueID<span class="token punctuation">,</span>
                       string <span class="token operator">&amp;</span>strValue<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">PutWithPLogEntityMeta</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iEntry<span class="token punctuation">,</span>
                                    <span class="token keyword">const</span> PLogEntityMeta_t <span class="token operator">&amp;</span>tMeta<span class="token punctuation">,</span> <span class="token keyword">const</span> string <span class="token operator">&amp;</span>strRecord<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">GetPLogEntityMeta</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> PLogEntityMeta_t <span class="token operator">&amp;</span>tMeta<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">LoadUncommitedEntrys</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iMaxCommitedEntry<span class="token punctuation">,</span>
                                   <span class="token keyword">uint64_t</span> iMaxLoadingEntry<span class="token punctuation">,</span>
                                   vector<span class="token operator">&lt;</span>pair<span class="token operator">&lt;</span><span class="token keyword">uint64_t</span><span class="token punctuation">,</span> string<span class="token operator">></span> <span class="token operator">></span> <span class="token operator">&amp;</span>vecRecord<span class="token punctuation">,</span> <span class="token keyword">bool</span> <span class="token operator">&amp;</span>bHasMore<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 从 PLogDB 中恢复 EntryRecord 信息，包括 Value</span>
<span class="token keyword">int</span> clsPLogBase<span class="token double-colon punctuation">::</span><span class="token function">GetRecord</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iEntry<span class="token punctuation">,</span> EntryRecord_t <span class="token operator">&amp;</span>tSrcRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iRet<span class="token punctuation">;</span>
  string strTemp<span class="token punctuation">;</span>

  <span class="token function">TIMERUS_START</span><span class="token punctuation">(</span>iGetUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 在 PLogDB 中读取 Entry 序列化的 Record 数据</span>
  iRet <span class="token operator">=</span> <span class="token function">Get</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> strTemp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">TIMERUS_STOP</span><span class="token punctuation">(</span>iGetUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  s_poGetTimeStat<span class="token operator">-></span><span class="token function">Update</span><span class="token punctuation">(</span>iGetUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">OSS</span><span class="token double-colon punctuation">::</span><span class="token function">ReportPLogGetTimeMS</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> iGetUseTimeUS <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>iGetUseTimeUS <span class="token operator">></span> <span class="token number">100000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) iGetUseTimeUS %lu"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iGetUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> eRetCodeNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">InitEntryRecord</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tSrcRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> eRetCodeNotFound<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"BUG probably E(%lu, %lu) Get ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 反序列化</span>
  iRet <span class="token operator">=</span> <span class="token function">StringToEntryRecord</span><span class="token punctuation">(</span>strTemp<span class="token punctuation">,</span> tSrcRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) StringToEntryRecord ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  iRet <span class="token operator">=</span> <span class="token function">CheckEntryRecordMayWithVIDOnly</span><span class="token punctuation">(</span>tSrcRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) CheckEntryRecordMayWithVIDOnly ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">uint64_t</span> iValueID <span class="token operator">=</span> tSrcRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>iValueID<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iValueID <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tSrcRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>bHasValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">TIMERUS_START</span><span class="token punctuation">(</span>iGetValueUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 从 PLogDB 中通过 ValueID 读取 Value</span>
      iRet <span class="token operator">=</span> <span class="token function">GetValue</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iValueID<span class="token punctuation">,</span> strTemp<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">TIMERUS_STOP</span><span class="token punctuation">(</span>iGetValueUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      s_poGetTimeStat<span class="token operator">-></span><span class="token function">Update</span><span class="token punctuation">(</span>iGetValueUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">OSS</span><span class="token double-colon punctuation">::</span><span class="token function">ReportPLogGetValueTimeMS</span><span class="token punctuation">(</span>iRet<span class="token punctuation">,</span> iGetValueUseTimeUS <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>iGetValueUseTimeUS <span class="token operator">></span> <span class="token number">100000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) iGetValueUseTimeUS %lu"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                        iGetValueUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> eRetCodeNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> eRetCodeNotFound<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) GetValue ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      tSrcRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>strValue <span class="token operator">=</span> strTemp<span class="token punctuation">;</span>
      tSrcRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>bHasValue <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  iRet <span class="token operator">=</span> <span class="token function">CheckEntryRecord</span><span class="token punctuation">(</span>tSrcRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) CheckEntryRecord ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将 EntryRecord 写入 PLogDB</span>
<span class="token comment">// 如果已经 Chosen，则可以丢掉长 Value</span>
<span class="token comment">// 若当前已知的 MaxPLogEntry 还未初始化，或 Entry &lt;= MaxPLogEntry</span>
<span class="token comment">// 直接存储 &lt;(Entity, Entry), Record></span>
<span class="token comment">// 否则从 PLogDB 中读取存储的 MaxPLogEntry，如果 Entry &lt;= MaxPLogEntry 仍然直接存</span>
<span class="token comment">// 否则还需要更新并存储 MaxPLogEntry</span>
<span class="token keyword">int</span> clsPLogBase<span class="token double-colon punctuation">::</span><span class="token function">PutRecord</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iEntry<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iMaxPLogEntry<span class="token punctuation">,</span>
                           EntryRecord_t tRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iRet<span class="token punctuation">;</span>
  string strRecord<span class="token punctuation">;</span>

  <span class="token function">CertainLogDebug</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) iMaxPLogEntry %lu record: %s"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iMaxPLogEntry<span class="token punctuation">,</span>
                  <span class="token function">EntryRecordToString</span><span class="token punctuation">(</span>tRecord<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  iRet <span class="token operator">=</span> <span class="token function">CheckEntryRecord</span><span class="token punctuation">(</span>tRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) CheckEntryRecord ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  clsConfigure <span class="token operator">*</span>poConf <span class="token operator">=</span> clsCertainWrapper<span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tRecord<span class="token punctuation">.</span>bChosen <span class="token operator">&amp;&amp;</span> tRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>strValue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> poConf<span class="token operator">-></span><span class="token function">GetMaxEmbedValueSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Record 还没有被 Chosen，并且 Value 的长度超过直接嵌入的限制</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tRecord<span class="token punctuation">.</span>iStoredValueID <span class="token operator">!=</span> tRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>iValueID <span class="token operator">&amp;&amp;</span> tRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>iValueID <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 当前已经存储的 ValueID 与当前 ValueID 不一致，说明要更新</span>
      <span class="token function">TIMERUS_START</span><span class="token punctuation">(</span>iPutValueUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 单独写 Value</span>
      iRet <span class="token operator">=</span> <span class="token function">PutValue</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> tRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>iValueID<span class="token punctuation">,</span> tRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>strValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">CertainLogDebug</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) iValueID %lu size %lu ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                      tRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>iValueID<span class="token punctuation">,</span> tRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>strValue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">TIMERUS_STOP</span><span class="token punctuation">(</span>iPutValueUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      s_poPutTimeStat<span class="token operator">-></span><span class="token function">Update</span><span class="token punctuation">(</span>iPutValueUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">OSS</span><span class="token double-colon punctuation">::</span><span class="token function">ReportPLogPutTimeMS</span><span class="token punctuation">(</span>iRet<span class="token punctuation">,</span> iPutValueUseTimeUS <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>iPutValueUseTimeUS <span class="token operator">></span> <span class="token number">100000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) iPutValueUseTimeUS %lu"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                        iPutValueUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) PutValue ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 更新 StoredValueID</span>
      tRecord<span class="token punctuation">.</span>iStoredValueID <span class="token operator">=</span> tRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>iValueID<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果没有超过限制，直接序列化存储即可</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>strValue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> poConf<span class="token operator">-></span><span class="token function">GetMaxEmbedValueSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tRecord<span class="token punctuation">.</span>iStoredValueID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 序列化</span>
  iRet <span class="token operator">=</span> <span class="token function">EntryRecordToString</span><span class="token punctuation">(</span>tRecord<span class="token punctuation">,</span> strRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) EntryRecordToString ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>iMaxPLogEntry <span class="token operator">==</span> INVALID_ENTRY <span class="token operator">||</span> iEntry <span class="token operator">&lt;=</span> iMaxPLogEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当 MaxPLogEntry 未初始化或 iEntry &lt;= iMaxPLogEntry 时，直接写入 Record</span>
    <span class="token function">TIMERUS_START</span><span class="token punctuation">(</span>iPutUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    iRet <span class="token operator">=</span> <span class="token function">Put</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> strRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIMERUS_STOP</span><span class="token punctuation">(</span>iPutUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    s_poPutTimeStat<span class="token operator">-></span><span class="token function">Update</span><span class="token punctuation">(</span>iPutUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OSS</span><span class="token double-colon punctuation">::</span><span class="token function">ReportPLogPutTimeMS</span><span class="token punctuation">(</span>iRet<span class="token punctuation">,</span> iPutUseTimeUS <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 否则先给 PLog 上锁</span>
    clsAutoPLogEntityLock <span class="token function">oPLogEntityLock</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>

    PLogEntityMeta_t tMeta <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment">// 注意这里初始化为 0</span>
    <span class="token function">TIMERUS_START</span><span class="token punctuation">(</span>iGetPLogMetaUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取 PLog 中存储的 Entity Meta: MaxPLogEntry</span>
    iRet <span class="token operator">=</span> <span class="token function">GetPLogEntityMeta</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> tMeta<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIMERUS_STOP</span><span class="token punctuation">(</span>iGetPLogMetaUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OSS</span><span class="token double-colon punctuation">::</span><span class="token function">ReportPLogGetMetaKeyTimeMS</span><span class="token punctuation">(</span>iRet<span class="token punctuation">,</span> iGetPLogMetaUseTimeUS <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> iRet <span class="token operator">!=</span> Certain<span class="token double-colon punctuation">::</span>eRetCodeNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) GetPLogEntityMeta ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) iMaxPLogEntry %lu tMeta.iMaxPLogEntry %lu"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                   iMaxPLogEntry<span class="token punctuation">,</span> tMeta<span class="token punctuation">.</span>iMaxPLogEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">TIMERUS_START</span><span class="token punctuation">(</span>iPutUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tMeta<span class="token punctuation">.</span>iMaxPLogEntry <span class="token operator">&lt;</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 更新 PLogMeta 同时 Put Record</span>
      tMeta<span class="token punctuation">.</span>iMaxPLogEntry <span class="token operator">=</span> iEntry<span class="token punctuation">;</span>
      iRet <span class="token operator">=</span> <span class="token function">PutWithPLogEntityMeta</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> tMeta<span class="token punctuation">,</span> strRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// iEntry >= tMeta.iMaxPLogEntry, store directly</span>
      <span class="token comment">// to unlock</span>
      iRet <span class="token operator">=</span> <span class="token function">Put</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> strRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">TIMERUS_STOP</span><span class="token punctuation">(</span>iPutUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    s_poPutTimeStat<span class="token operator">-></span><span class="token function">Update</span><span class="token punctuation">(</span>iPutUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OSS</span><span class="token double-colon punctuation">::</span><span class="token function">ReportPLogPutTimeMS</span><span class="token punctuation">(</span>iRet<span class="token punctuation">,</span> iPutUseTimeUS <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) Put ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>PaxosStore 的 Example 中有一份基于 LevelDB 的 PLogDB 实现：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">clsPLogImpl</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> Certain<span class="token double-colon punctuation">::</span><span class="token class-name">clsPLogBase</span></span> <span class="token punctuation">{</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
  dbtype<span class="token double-colon punctuation">::</span>DB <span class="token operator">*</span>m_poLevelDB<span class="token punctuation">;</span>

 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">clsPLogImpl</span><span class="token punctuation">(</span>dbtype<span class="token double-colon punctuation">::</span>DB <span class="token operator">*</span>poLevelDB<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">m_poLevelDB</span><span class="token punctuation">(</span>poLevelDB<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">clsPLogImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">PutValue</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iEntry<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iValueID<span class="token punctuation">,</span>
                       <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>strValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">GetValue</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iEntry<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iValueID<span class="token punctuation">,</span>
                       std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>strValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">Put</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iEntry<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>strRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iEntry<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>strRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">PutWithPLogEntityMeta</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iEntry<span class="token punctuation">,</span>
                                    <span class="token keyword">const</span> Certain<span class="token double-colon punctuation">::</span>PLogEntityMeta_t <span class="token operator">&amp;</span>tMeta<span class="token punctuation">,</span>
                                    <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>strRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">GetPLogEntityMeta</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> Certain<span class="token double-colon punctuation">::</span>PLogEntityMeta_t <span class="token operator">&amp;</span>tMeta<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">LoadUncommitedEntrys</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iMaxCommitedEntry<span class="token punctuation">,</span>
                                   <span class="token keyword">uint64_t</span> iMaxLoadingEntry<span class="token punctuation">,</span>
                                   std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">uint64_t</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">></span> <span class="token operator">></span> <span class="token operator">&amp;</span>vecRecord<span class="token punctuation">,</span>
                                   <span class="token keyword">bool</span> <span class="token operator">&amp;</span>bHasMore<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> clsPLogImpl<span class="token double-colon punctuation">::</span><span class="token function">PutValue</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iEntry<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iValueID<span class="token punctuation">,</span>
                          <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>strValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  clsAutoDisableHook oAuto<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>string strKey<span class="token punctuation">;</span>
  <span class="token function">EncodePLogValueKey</span><span class="token punctuation">(</span>strKey<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iValueID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  dbtype<span class="token double-colon punctuation">::</span>WriteOptions tOpt<span class="token punctuation">;</span>
  dbtype<span class="token double-colon punctuation">::</span>WriteBatch oWB<span class="token punctuation">;</span>
  oWB<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>strKey<span class="token punctuation">,</span> strValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

  dbtype<span class="token double-colon punctuation">::</span>Status s <span class="token operator">=</span> m_poLevelDB<span class="token operator">-></span><span class="token function">Write</span><span class="token punctuation">(</span>tOpt<span class="token punctuation">,</span> <span class="token operator">&amp;</span>oWB<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Certain<span class="token double-colon punctuation">::</span>eRetCodePLogPutErr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> clsPLogImpl<span class="token double-colon punctuation">::</span><span class="token function">GetValue</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iEntry<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iValueID<span class="token punctuation">,</span>
                          std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>strValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  clsAutoDisableHook oAuto<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>string strKey<span class="token punctuation">;</span>
  <span class="token function">EncodePLogValueKey</span><span class="token punctuation">(</span>strKey<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iValueID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  dbtype<span class="token double-colon punctuation">::</span>ReadOptions tOpt<span class="token punctuation">;</span>
  dbtype<span class="token double-colon punctuation">::</span>Status s <span class="token operator">=</span> m_poLevelDB<span class="token operator">-></span><span class="token function">Get</span><span class="token punctuation">(</span>tOpt<span class="token punctuation">,</span> strKey<span class="token punctuation">,</span> <span class="token operator">&amp;</span>strValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">IsNotFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Certain<span class="token double-colon punctuation">::</span>eRetCodeNotFound<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Certain<span class="token double-colon punctuation">::</span>eRetCodePLogGetErr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> clsPLogImpl<span class="token double-colon punctuation">::</span><span class="token function">Put</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iEntry<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>strRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  clsAutoDisableHook oAuto<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>string strKey<span class="token punctuation">;</span>
  <span class="token function">EncodePLogKey</span><span class="token punctuation">(</span>strKey<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

  dbtype<span class="token double-colon punctuation">::</span>WriteOptions tOpt<span class="token punctuation">;</span>
  dbtype<span class="token double-colon punctuation">::</span>WriteBatch oWB<span class="token punctuation">;</span>
  oWB<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>strKey<span class="token punctuation">,</span> strRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>

  dbtype<span class="token double-colon punctuation">::</span>Status s <span class="token operator">=</span> m_poLevelDB<span class="token operator">-></span><span class="token function">Write</span><span class="token punctuation">(</span>tOpt<span class="token punctuation">,</span> <span class="token operator">&amp;</span>oWB<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Certain<span class="token double-colon punctuation">::</span>eRetCodePLogPutErr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> clsPLogImpl<span class="token double-colon punctuation">::</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iEntry<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>strRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  clsAutoDisableHook oAuto<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>string strKey<span class="token punctuation">;</span>
  <span class="token function">EncodePLogKey</span><span class="token punctuation">(</span>strKey<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

  dbtype<span class="token double-colon punctuation">::</span>ReadOptions tOpt<span class="token punctuation">;</span>
  dbtype<span class="token double-colon punctuation">::</span>Status s <span class="token operator">=</span> m_poLevelDB<span class="token operator">-></span><span class="token function">Get</span><span class="token punctuation">(</span>tOpt<span class="token punctuation">,</span> strKey<span class="token punctuation">,</span> <span class="token operator">&amp;</span>strRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">IsNotFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Certain<span class="token double-colon punctuation">::</span>eRetCodeNotFound<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Certain<span class="token double-colon punctuation">::</span>eRetCodePLogGetErr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> clsPLogImpl<span class="token double-colon punctuation">::</span><span class="token function">PutWithPLogEntityMeta</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iEntry<span class="token punctuation">,</span>
                                       <span class="token keyword">const</span> Certain<span class="token double-colon punctuation">::</span>PLogEntityMeta_t <span class="token operator">&amp;</span>tMeta<span class="token punctuation">,</span>
                                       <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>strRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  clsAutoDisableHook oAuto<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>string strKey<span class="token punctuation">;</span>
  <span class="token function">EncodePLogKey</span><span class="token punctuation">(</span>strKey<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token double-colon punctuation">::</span>string strMetaKey<span class="token punctuation">;</span>
  <span class="token function">EncodePLogMetaKey</span><span class="token punctuation">(</span>strMetaKey<span class="token punctuation">,</span> iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  CertainPB<span class="token double-colon punctuation">::</span>PLogEntityMeta tPLogEntityMeta<span class="token punctuation">;</span>
  tPLogEntityMeta<span class="token punctuation">.</span><span class="token function">set_max_plog_entry</span><span class="token punctuation">(</span>tMeta<span class="token punctuation">.</span>iMaxPLogEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>string strMetaValue<span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>tPLogEntityMeta<span class="token punctuation">.</span><span class="token function">SerializeToString</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>strMetaValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  dbtype<span class="token double-colon punctuation">::</span>WriteOptions tOpt<span class="token punctuation">;</span>
  dbtype<span class="token double-colon punctuation">::</span>WriteBatch oWB<span class="token punctuation">;</span>
  oWB<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>strKey<span class="token punctuation">,</span> strRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
  oWB<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>strMetaKey<span class="token punctuation">,</span> strMetaValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

  dbtype<span class="token double-colon punctuation">::</span>Status s <span class="token operator">=</span> m_poLevelDB<span class="token operator">-></span><span class="token function">Write</span><span class="token punctuation">(</span>tOpt<span class="token punctuation">,</span> <span class="token operator">&amp;</span>oWB<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Certain<span class="token double-colon punctuation">::</span>eRetCodePLogPutErr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> clsPLogImpl<span class="token double-colon punctuation">::</span><span class="token function">GetPLogEntityMeta</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> Certain<span class="token double-colon punctuation">::</span>PLogEntityMeta_t <span class="token operator">&amp;</span>tMeta<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  clsAutoDisableHook oAuto<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>string strKey<span class="token punctuation">;</span>
  <span class="token function">EncodePLogMetaKey</span><span class="token punctuation">(</span>strKey<span class="token punctuation">,</span> iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token double-colon punctuation">::</span>string strMetaValue<span class="token punctuation">;</span>
  dbtype<span class="token double-colon punctuation">::</span>ReadOptions tOpt<span class="token punctuation">;</span>
  dbtype<span class="token double-colon punctuation">::</span>Status s <span class="token operator">=</span> m_poLevelDB<span class="token operator">-></span><span class="token function">Get</span><span class="token punctuation">(</span>tOpt<span class="token punctuation">,</span> strKey<span class="token punctuation">,</span> <span class="token operator">&amp;</span>strMetaValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">IsNotFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Certain<span class="token double-colon punctuation">::</span>eRetCodeNotFound<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Certain<span class="token double-colon punctuation">::</span>eRetCodePLogGetErr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  CertainPB<span class="token double-colon punctuation">::</span>PLogEntityMeta tPLogEntityMeta<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tPLogEntityMeta<span class="token punctuation">.</span><span class="token function">ParseFromString</span><span class="token punctuation">(</span>strMetaValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Certain<span class="token double-colon punctuation">::</span>eRetCodeParseProtoErr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  tMeta<span class="token punctuation">.</span>iMaxPLogEntry <span class="token operator">=</span> tPLogEntityMeta<span class="token punctuation">.</span><span class="token function">max_plog_entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> clsPLogImpl<span class="token double-colon punctuation">::</span><span class="token function">LoadUncommitedEntrys</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iMaxCommitedEntry<span class="token punctuation">,</span>
                                      <span class="token keyword">uint64_t</span> iMaxLoadingEntry<span class="token punctuation">,</span>
                                      std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">uint64_t</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">></span> <span class="token operator">></span> <span class="token operator">&amp;</span>vecRecord<span class="token punctuation">,</span>
                                      <span class="token keyword">bool</span> <span class="token operator">&amp;</span>bHasMore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  clsAutoDisableHook oAuto<span class="token punctuation">;</span>
  bHasMore <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  vecRecord<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token double-colon punctuation">::</span>string strStartKey<span class="token punctuation">;</span>
  <span class="token function">EncodePLogKey</span><span class="token punctuation">(</span>strStartKey<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iMaxCommitedEntry <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  dbtype<span class="token double-colon punctuation">::</span>ReadOptions tOpt<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>dbtype<span class="token double-colon punctuation">::</span>Iterator<span class="token operator">></span> <span class="token function">iter</span><span class="token punctuation">(</span>m_poLevelDB<span class="token operator">-></span><span class="token function">NewIterator</span><span class="token punctuation">(</span>tOpt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>iter<span class="token operator">-></span><span class="token function">Seek</span><span class="token punctuation">(</span>strStartKey<span class="token punctuation">)</span><span class="token punctuation">;</span> iter<span class="token operator">-></span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iter<span class="token operator">-></span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dbtype<span class="token double-colon punctuation">::</span>Slice <span class="token operator">&amp;</span>strKey <span class="token operator">=</span> iter<span class="token operator">-></span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">uint64_t</span> iCurrEntityID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">uint64_t</span> iEntry <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">uint64_t</span> iValueID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DecodePLogKey</span><span class="token punctuation">(</span>strKey<span class="token punctuation">,</span> iCurrEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token function">DecodePLogValueKey</span><span class="token punctuation">(</span>strKey<span class="token punctuation">,</span> iCurrEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iValueID<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>iCurrEntityID <span class="token operator">></span> iEntityID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>iValueID <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>iMaxLoadingEntry <span class="token operator">&lt;</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      bHasMore <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token double-colon punctuation">::</span>string strValue <span class="token operator">=</span> iter<span class="token operator">-></span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vecRecord<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span>iEntry<span class="token punctuation">,</span> strValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>实现很简单。<strong>PLogDB</strong> 中存储了键值对 <code>&lt;(EntityID, EntryID), EntryRecord&gt;</code>，以及 Entity 的 PLog Meta 信息 <code>MaxPLogEntry</code>。</p>
<h3 id="3.-恢复流程" tabindex="-1"><a href="#3.-%E6%81%A2%E5%A4%8D%E6%B5%81%E7%A8%8B">3. 恢复流程</a></h3>
<p>PLogDB 中存储的信息可以用来恢复本机的实际 DB 数据，也可以用来恢复集群其他机器的数据。以后者为例，当本机发现其他机器的 Entity 信息较旧时，会触发 PLog 数据的读取：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// 处理请求的 PaxosCmd</span>
<span class="token keyword">int</span> clsEntityWorker<span class="token double-colon punctuation">::</span><span class="token function">DoWithPaxosCmd</span><span class="token punctuation">(</span>clsPaxosCmd <span class="token operator">*</span>poPaxosCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// 对方的 EntryID 较小</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry <span class="token operator">>=</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 且还没有 Chosen 时，那么可以获悉对方的 Entity 信息陈旧</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetSrcRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>bChosen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 构造一个 PaxosCmd</span>
    clsPaxosCmd <span class="token operator">*</span>po <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token function">clsPaxosCmd</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetSrcRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 目标是对方机器</span>
    po<span class="token operator">-></span><span class="token function">SetDestAcceptorID</span><span class="token punctuation">(</span>iAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    po<span class="token operator">-></span><span class="token function">SetPLogReturn</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    po<span class="token operator">-></span><span class="token function">SetMaxChosenEntry</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    po<span class="token operator">-></span><span class="token function">SetUUID</span><span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 塞入请求队列</span>
    iRet <span class="token operator">=</span> clsPLogWorker<span class="token double-colon punctuation">::</span><span class="token function">EnterPLogReqQueue</span><span class="token punctuation">(</span>po<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> po<span class="token punctuation">,</span> po <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"EnterPLogReqQueue ret %d"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>PLogWorker</code> 线程中会依次执行 <code>CoEpollTick</code> -&gt; <code>PLogRoutine</code> -&gt; <code>DoWithPaxosCmd</code> -&gt; <code>DoWithPLogRequest</code> -&gt; <code>PLogDB::GetRecord</code> -&gt; <code>IO::GoAndDeleteIfFailed</code>，将会从 PLogDB 中读取对应的 EntryRecord 并将其发送给对方机器。</p>
<h3 id="4.-总结" tabindex="-1"><a href="#4.-%E6%80%BB%E7%BB%93">4. 总结</a></h3>
<p>Paxos 过程中，节点需要持久化自己做出的承诺，否则将有可能在重启后违背自己的承诺。同时存储自身状态也有利于自身和其他节点做数据恢复。下一篇将继续分析 PaxosStore 协议过程中的一些细节。</p>

      </div>
      <script src="https://giscus.app/client.js"
      data-repo="SF-Zhou/sf-zhou.github.io"
      data-repo-id="MDEwOlJlcG9zaXRvcnk4MDc5ODgwNg=="
      data-category="Announcements"
      data-category-id="DIC_kwDOBNDkVs4CA6GQ"
      data-mapping="title"
      data-reactions-enabled="0"
      data-emit-metadata="0"
      data-input-position="bottom"
      data-theme="preferred_color_scheme"
      data-lang="en"
      crossorigin="anonymous"
      async>
    </script>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2017 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/main.js"></script>
    <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-61723712-2', 'auto'); ga('send', 'pageview'); </script>
  </body>
</html>
