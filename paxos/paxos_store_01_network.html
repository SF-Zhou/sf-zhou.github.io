<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/gitalk.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>PaxosStore 源码分析「一、网络通信」 | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> PaxosStore 源码分析「一、网络通信」 </h1>
      </div>
      <div class="info">
        <div class="date"> 2020.02.15 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <p>PaxosStore 是由微信开源的分布式存储系统，基于 Paxos 协议实现存储的强一致。代码开源于 2017 年，同步发表的还有 VLDB 会议上的论文 &quot;<a href="http://www.vldb.org/pvldb/vol10/p1730-lin.pdf">PaxosStore: High-availability Storage Made Practical in WeChat</a>&quot;。PaxosStore 广泛应用于微信各项存储服务中，代码久经考验。所以开出一个新系列<a href="/#/Paxos">「PaxosStore 源码分析」</a>，希望从这个工业化 Paxos 协议实现中学习一些新东西。作为系列的第一篇，本文会介绍 PaxosStore 代码的整体结构和网络通信的实现。</p>
<h3 id="1.-paxosstore-源码概览" tabindex="-1"><a href="#1.-paxosstore-%E6%BA%90%E7%A0%81%E6%A6%82%E8%A7%88">1. PaxosStore 源码概览</a></h3>
<p><a href="https://github.com/Tencent/paxosstore">PaxosStore 项目</a>中开源了两个 Paxos 实现，分别是 Certain 和 PaxosKV。前者是较为通用的 PLog + DB 的实现，可以接入各类数据库；后者基于 PaxosLog-as-Value 的思想，是针对 KV 系统单独做的场景优化。两个实现是完全独立的，本系列会着重分析 Certain 的源码。Certain 库中代码总计约 18000 行，其目录如下所示：</p>
<pre class="language-markup"><code class="language-markup">certain
├── example  # 样例
├── include  # 头文件
├── model    # 不知何意
├── network  # 网络基础
├── src      # 具体实现
├── third    # 第三方库
└── utils    # 基础工具
</code></pre>
<h3 id="2.-网络通信" tabindex="-1"><a href="#2.-%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1">2. 网络通信</a></h3>
<p>网络通信部分与 Paxos 协议的实现无关，相当于基础库，该部分的代码容易上手阅读，由此入坑。先看 <a href="https://github.com/Tencent/paxosstore/blob/master/certain/network/InetAddr.h"><code>network/InetAddr.h</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">InetAddr_t</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> tAddr<span class="token punctuation">;</span>

  <span class="token keyword">bool</span> <span class="token keyword">operator</span><span class="token operator">==</span><span class="token punctuation">(</span><span class="token keyword">const</span> InetAddr_t <span class="token operator">&amp;</span>tOther<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token operator">&amp;</span>tOtherAddr <span class="token operator">=</span> tOther<span class="token punctuation">.</span>tAddr<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>tAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">!=</span> tOtherAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>tAddr<span class="token punctuation">.</span>sin_port <span class="token operator">!=</span> tOtherAddr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">bool</span> <span class="token keyword">operator</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">const</span> InetAddr_t <span class="token operator">&amp;</span>tOther<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token operator">&amp;</span>tOtherAddr <span class="token operator">=</span> tOther<span class="token punctuation">.</span>tAddr<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>tAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">!=</span> tOtherAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> tAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">&lt;</span> tOtherAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>tAddr<span class="token punctuation">.</span>sin_port <span class="token operator">!=</span> tOtherAddr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> tAddr<span class="token punctuation">.</span>sin_port <span class="token operator">&lt;</span> tOtherAddr<span class="token punctuation">.</span>sin_port<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">InetAddr_t</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tAddr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token function">InetAddr_t</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> tSockAddr<span class="token punctuation">)</span> <span class="token punctuation">{</span> tAddr <span class="token operator">=</span> tSockAddr<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token function">InetAddr_t</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>sIP<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> iPort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tAddr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    tAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>sIP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>iPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">InetAddr_t</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> iIP<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> iPort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tAddr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    tAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> iIP<span class="token punctuation">;</span>
    tAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>iPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  string <span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>sIP <span class="token operator">=</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>tAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">uint16_t</span> iPort <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>tAddr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> acBuffer<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">snprintf</span><span class="token punctuation">(</span>acBuffer<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token string">"%s:%hu"</span><span class="token punctuation">,</span> sIP<span class="token punctuation">,</span> iPort<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> acBuffer<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">uint32_t</span> <span class="token function">GetNetOrderIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> tAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>笔者已将代码使用 clang-format 的格式化。从该段代码中也能一窥其代码风格，变量使用驼峰命名，前缀标明类型，习惯就好。<code>InetAddr_t</code> 类封装了 Socket 地址结构 <code>sockaddr_in</code>，提供了地址与字符串之间的相互转换。继续看 <a href="https://github.com/Tencent/paxosstore/blob/master/certain/network/SocketHelper.h"><code>network/SocketHelper.h</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// 连接信息</span>
<span class="token keyword">struct</span> <span class="token class-name">ConnInfo_t</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iFD<span class="token punctuation">;</span>  <span class="token comment">// 当前连接 fd</span>

  InetAddr_t tLocalAddr<span class="token punctuation">;</span>  <span class="token comment">// 本地地址</span>
  InetAddr_t tPeerAddr<span class="token punctuation">;</span>   <span class="token comment">// 远端地址</span>

  string <span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> acBuffer<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">snprintf</span><span class="token punctuation">(</span>acBuffer<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token string">"fd %d local %s peer %s"</span><span class="token punctuation">,</span> iFD<span class="token punctuation">,</span> tLocalAddr<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             tPeerAddr<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> acBuffer<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 创建 Socket 连接，并设定为非阻塞模式</span>
<span class="token comment">// 如果设定 ptInetAddr，则绑定到该地址</span>
<span class="token keyword">int</span> <span class="token function">CreateSocket</span><span class="token punctuation">(</span><span class="token keyword">const</span> InetAddr_t <span class="token operator">*</span>ptInetAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 检查 Socket 是否合法</span>
<span class="token keyword">bool</span> <span class="token function">CheckIfValid</span><span class="token punctuation">(</span><span class="token keyword">int</span> iFD<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用 iFD 连接指定地址</span>
<span class="token keyword">int</span> <span class="token function">Connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> iFD<span class="token punctuation">,</span> <span class="token keyword">const</span> InetAddr_t <span class="token operator">&amp;</span>tInetAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 连接指定地址，并将连接信息存储到 tConnInfo 中</span>
<span class="token keyword">int</span> <span class="token function">Connect</span><span class="token punctuation">(</span><span class="token keyword">const</span> InetAddr_t <span class="token operator">&amp;</span>tInetAddr<span class="token punctuation">,</span> ConnInfo_t <span class="token operator">&amp;</span>tConnInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 设定非阻塞模式</span>
<span class="token keyword">int</span> <span class="token function">SetNonBlock</span><span class="token punctuation">(</span><span class="token keyword">int</span> iFD<span class="token punctuation">,</span> <span class="token keyword">bool</span> bNonBlock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建非阻塞管道</span>
<span class="token keyword">int</span> <span class="token function">MakeNonBlockPipe</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">&amp;</span>iInFD<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>iOutFD<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>摘录 <code>CreateSocket</code> 和 <code>Connect</code> 的函数实现：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">CreateSocket</span><span class="token punctuation">(</span><span class="token keyword">const</span> InetAddr_t <span class="token operator">*</span>ptInetAddr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iRet<span class="token punctuation">;</span>

  <span class="token keyword">int</span> iFD <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iFD <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"socket ret -1 errno %d"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">int</span> iOptVal <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  iRet <span class="token operator">=</span> <span class="token function">setsockopt</span><span class="token punctuation">(</span>iFD<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>iOptVal<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"setsockopt fail fd %d errno %d"</span><span class="token punctuation">,</span> iFD<span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Close TCP negle algorithm.</span>
  iOptVal <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  iRet <span class="token operator">=</span> <span class="token function">setsockopt</span><span class="token punctuation">(</span>iFD<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">,</span> TCP_NODELAY<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>iOptVal<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>iOptVal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"setsockopt fail fd %d errno %d"</span><span class="token punctuation">,</span> iFD<span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">int</span> iFlags <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>iFD<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  iRet <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>iFD<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> iFlags <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">AssertEqual</span><span class="token punctuation">(</span>iRet<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptInetAddr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> iFD<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>ptAddr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ptInetAddr<span class="token operator">-></span>tAddr<span class="token punctuation">;</span>
  socklen_t tLen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ptAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

  iRet <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>iFD<span class="token punctuation">,</span> ptAddr<span class="token punctuation">,</span> tLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"bind fail fd %d addr %s errno %d"</span><span class="token punctuation">,</span> iFD<span class="token punctuation">,</span> ptInetAddr<span class="token operator">-></span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> iFD<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">Connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> iFD<span class="token punctuation">,</span> <span class="token keyword">const</span> InetAddr_t <span class="token operator">&amp;</span>tInetAddr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token operator">*</span>ptAddr <span class="token operator">=</span> <span class="token operator">&amp;</span>tInetAddr<span class="token punctuation">.</span>tAddr<span class="token punctuation">;</span>
  socklen_t tLen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ptAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> iRet <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>iFD<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptAddr<span class="token punctuation">,</span> tLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINPROGRESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"connect fail fd %d addr %s errno %d"</span><span class="token punctuation">,</span> iFD<span class="token punctuation">,</span> tInetAddr<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">Connect</span><span class="token punctuation">(</span><span class="token keyword">const</span> InetAddr_t <span class="token operator">&amp;</span>tInetAddr<span class="token punctuation">,</span> ConnInfo_t <span class="token operator">&amp;</span>tConnInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iRet<span class="token punctuation">;</span>

  <span class="token keyword">int</span> iFD <span class="token operator">=</span> <span class="token function">CreateSocket</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iFD <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"CreateSocket ret %d"</span><span class="token punctuation">,</span> iFD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  iRet <span class="token operator">=</span> <span class="token function">Connect</span><span class="token punctuation">(</span>iFD<span class="token punctuation">,</span> tInetAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">close</span><span class="token punctuation">(</span>iFD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"Connect ret %d"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  tConnInfo<span class="token punctuation">.</span>iFD <span class="token operator">=</span> iFD<span class="token punctuation">;</span>
  tConnInfo<span class="token punctuation">.</span>tPeerAddr <span class="token operator">=</span> tInetAddr<span class="token punctuation">;</span>

  <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> tAddr <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  socklen_t tLen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

  iRet <span class="token operator">=</span> <span class="token function">getsockname</span><span class="token punctuation">(</span>iFD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">close</span><span class="token punctuation">(</span>iFD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"getsockname fail ret %d errno %d"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>tAddr<span class="token punctuation">.</span>sa_family <span class="token operator">!=</span> AF_INET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">close</span><span class="token punctuation">(</span>iFD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"not spported sa_family %d"</span><span class="token punctuation">,</span> tAddr<span class="token punctuation">.</span>sa_family<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  tConnInfo<span class="token punctuation">.</span>tLocalAddr<span class="token punctuation">.</span>tAddr <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>tAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>CreateSocket</code> 创建 TCP Socket 后，首先将其设定为 <code>SO_REUSEADDR</code>，以保证服务端重启时不会出现 &quot;Address already in use&quot; 的报错；而后将其 TCP 设定为 <code>TCP_NODELAY</code>，缓冲区有数据时立即发包；最后将其设定为 <code>O_NONBLOCK</code> 非阻塞模式，缓冲区不可用时立即返回错误不等待。<code>Connect</code> 建立连接后，使用 <code>getsockname</code> 获取本地地址，并将 <code>fd</code>、远端地址和本地地址保存于 <code>ConnInfo_t</code> 中。</p>
<p>Linux 下高性能的网络通信离不开 Epoll。继续看 <a href="https://github.com/Tencent/paxosstore/blob/master/certain/network/EpollIO.h"><code>network/EpollIO.h</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">int</span> kDefaultFDEvents <span class="token operator">=</span> EPOLLIN <span class="token operator">|</span> EPOLLOUT <span class="token operator">|</span> EPOLLET<span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">int</span> kDefaultEventSize <span class="token operator">=</span> <span class="token number">8096</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">clsFDBase</span><span class="token punctuation">;</span>
<span class="token comment">// IO 处理纯虚基类</span>
<span class="token comment">// 提供 HandleRead/HandleWrite 两种方法，参数为 FD 对象指针</span>
<span class="token keyword">class</span> <span class="token class-name">clsIOHandlerBase</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">clsIOHandlerBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">HandleRead</span><span class="token punctuation">(</span>clsFDBase <span class="token operator">*</span>poFD<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">HandleWrite</span><span class="token punctuation">(</span>clsFDBase <span class="token operator">*</span>poFD<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// FD 基类，POXIS fd 的封装</span>
<span class="token comment">// 保存 fd / io_handler / event 等参数</span>
<span class="token comment">// 保存 readable / writable 两种状态</span>
<span class="token keyword">class</span> <span class="token class-name">clsFDBase</span> <span class="token punctuation">{</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">int</span> m_iFD<span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> m_iFDID<span class="token punctuation">;</span>

  clsIOHandlerBase <span class="token operator">*</span>m_poIOHandler<span class="token punctuation">;</span>
  <span class="token keyword">int</span> m_iEvents<span class="token punctuation">;</span>

  <span class="token keyword">bool</span> m_bReadable<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> m_bWritable<span class="token punctuation">;</span>

 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">clsFDBase</span><span class="token punctuation">(</span><span class="token keyword">int</span> iFD<span class="token punctuation">,</span> clsIOHandlerBase <span class="token operator">*</span>poIOHandler <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> iFDID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token keyword">int</span> iEvents <span class="token operator">=</span> kDefaultFDEvents<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">m_iFD</span><span class="token punctuation">(</span>iFD<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">m_iFDID</span><span class="token punctuation">(</span>iFDID<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">m_poIOHandler</span><span class="token punctuation">(</span>poIOHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">m_iEvents</span><span class="token punctuation">(</span>iEvents<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">m_bReadable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">m_bWritable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">clsFDBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> <span class="token function">GetFD</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_iFD<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">uint32_t</span> <span class="token function">GetFDID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_iFDID<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">int</span> <span class="token function">GetEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_iEvents<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token comment">// 使用宏定义成员变量的 Get/Set 方法</span>
  <span class="token function">BOOLEN_IS_SET</span><span class="token punctuation">(</span>Readable<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">BOOLEN_IS_SET</span><span class="token punctuation">(</span>Writable<span class="token punctuation">)</span><span class="token punctuation">;</span>

  clsIOHandlerBase <span class="token operator">*</span><span class="token function">GetIOHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_poIOHandler<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">SetIOHandler</span><span class="token punctuation">(</span>clsIOHandlerBase <span class="token operator">*</span>poIOHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span> m_poIOHandler <span class="token operator">=</span> poIOHandler<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p><code>clsFDBase</code> 是文件描述符 fd 的封装，实际上这里的 fd 仅限于 Socket 连接。其保存了关心的事件 <code>iEvents</code> 和 IO 事件处理器 <code>poIOHandler</code>，当事件发生时，可以调用 <code>clsIOHandlerBase::HandleRead/Write</code> 进行处理。注意这里默认的事件中使用了边缘触发模式 <code>EPOLLET</code>。负责管理事件的肯定是 Epoll 了：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">clsEpollIO</span> <span class="token punctuation">{</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">int</span> m_iEpollFD<span class="token punctuation">;</span>

  <span class="token keyword">uint32_t</span> m_iEventSize<span class="token punctuation">;</span>
  epoll_event <span class="token operator">*</span>m_ptEpollEv<span class="token punctuation">;</span>

  <span class="token keyword">struct</span> <span class="token class-name">UniqueFDPtr_t</span> <span class="token punctuation">{</span>
    <span class="token keyword">uint32_t</span> iFDID<span class="token punctuation">;</span>
    clsFDBase <span class="token operator">*</span>poFD<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  UniqueFDPtr_t <span class="token operator">*</span>m_atUniqueFDPtrMap<span class="token punctuation">;</span>

 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">clsEpollIO</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> iEventSize <span class="token operator">=</span> kDefaultEventSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">~</span><span class="token function">clsEpollIO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 在 Epoll 中添/删/改 FD 对象</span>
  <span class="token keyword">int</span> <span class="token function">Add</span><span class="token punctuation">(</span>clsFDBase <span class="token operator">*</span>poFD<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> <span class="token function">Remove</span><span class="token punctuation">(</span>clsFDBase <span class="token operator">*</span>poFD<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> <span class="token function">RemoveAndCloseFD</span><span class="token punctuation">(</span>clsFDBase <span class="token operator">*</span>poFD<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> <span class="token function">Modify</span><span class="token punctuation">(</span>clsFDBase <span class="token operator">*</span>poFD<span class="token punctuation">)</span><span class="token punctuation">;</span>

  clsFDBase <span class="token operator">*</span><span class="token function">GetFDBase</span><span class="token punctuation">(</span><span class="token keyword">int</span> iFD<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> iFDID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 执行 epoll_wait 获取可用 fd 并处理</span>
  <span class="token keyword">void</span> <span class="token function">RunOnce</span><span class="token punctuation">(</span><span class="token keyword">int</span> iTimeoutMS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>具体的函数实现位于 <a href="https://github.com/Tencent/paxosstore/blob/master/certain/network/EpollIO.cpp"><code>network/EpollIO.cpp</code></a>，摘录部分：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// 在 epoll 中添加 FD 对象，并根据 fd 存储 FD 对象及其 ID</span>
<span class="token keyword">int</span> clsEpollIO<span class="token double-colon punctuation">::</span><span class="token function">Add</span><span class="token punctuation">(</span>clsFDBase <span class="token operator">*</span>poFD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iFD <span class="token operator">=</span> poFD<span class="token operator">-></span><span class="token function">GetFD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">AssertLess</span><span class="token punctuation">(</span>iFD<span class="token punctuation">,</span> CERTAIN_MAX_FD_NUM<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CertainLogDebug</span><span class="token punctuation">(</span><span class="token string">"fd %d"</span><span class="token punctuation">,</span> iFD<span class="token punctuation">)</span><span class="token punctuation">;</span>

  epoll_event ev <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  ev<span class="token punctuation">.</span>events <span class="token operator">=</span> poFD<span class="token operator">-></span><span class="token function">GetEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>poFD<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> iRet <span class="token operator">=</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>m_iEpollFD<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> iFD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"epoll_ctl fail fd %d errno %d"</span><span class="token punctuation">,</span> iFD<span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">AssertEqual</span><span class="token punctuation">(</span>iRet<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">AssertEqual</span><span class="token punctuation">(</span>m_atUniqueFDPtrMap<span class="token punctuation">[</span>iFD<span class="token punctuation">]</span><span class="token punctuation">.</span>poFD<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  m_atUniqueFDPtrMap<span class="token punctuation">[</span>iFD<span class="token punctuation">]</span><span class="token punctuation">.</span>poFD <span class="token operator">=</span> poFD<span class="token punctuation">;</span>
  m_atUniqueFDPtrMap<span class="token punctuation">[</span>iFD<span class="token punctuation">]</span><span class="token punctuation">.</span>iFDID <span class="token operator">=</span> poFD<span class="token operator">-></span><span class="token function">GetFDID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 执行一次检查，根据事件执行 FD 对象的 HandleRead / HandleWrite</span>
<span class="token keyword">void</span> clsEpollIO<span class="token double-colon punctuation">::</span><span class="token function">RunOnce</span><span class="token punctuation">(</span><span class="token keyword">int</span> iTimeoutMS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iNum<span class="token punctuation">,</span> iRet<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    iNum <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>m_iEpollFD<span class="token punctuation">,</span> m_ptEpollEv<span class="token punctuation">,</span> m_iEventSize<span class="token punctuation">,</span> iTimeoutMS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iNum <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"epoll_wait fail epoll_fd %d errno %d"</span><span class="token punctuation">,</span> m_iEpollFD<span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// You should probably raise "open files" limit.</span>
        <span class="token function">AssertEqual</span><span class="token punctuation">(</span>errno<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assert</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> iNum<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> iEvents <span class="token operator">=</span> m_ptEpollEv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events<span class="token punctuation">;</span>
    clsFDBase <span class="token operator">*</span>poFD <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>clsFDBase <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>m_ptEpollEv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    clsIOHandlerBase <span class="token operator">*</span>poHandler <span class="token operator">=</span> poFD<span class="token operator">-></span><span class="token function">GetIOHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Assert</span><span class="token punctuation">(</span>poHandler <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>iEvents <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>iEvents <span class="token operator">&amp;</span> EPOLLERR<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>iEvents <span class="token operator">&amp;</span> EPOLLHUP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      poFD<span class="token operator">-></span><span class="token function">SetReadable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      iRet <span class="token operator">=</span> poHandler<span class="token operator">-></span><span class="token function">HandleRead</span><span class="token punctuation">(</span>poFD<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>iEvents <span class="token operator">&amp;</span> EPOLLOUT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      poFD<span class="token operator">-></span><span class="token function">SetWritable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      iRet <span class="token operator">=</span> poHandler<span class="token operator">-></span><span class="token function">HandleWrite</span><span class="token punctuation">(</span>poFD<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 根据 fd 获取 FD 对象，加入 ID 校验</span>
clsFDBase <span class="token operator">*</span>clsEpollIO<span class="token double-colon punctuation">::</span><span class="token function">GetFDBase</span><span class="token punctuation">(</span><span class="token keyword">int</span> iFD<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> iFDID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_atUniqueFDPtrMap<span class="token punctuation">[</span>iFD<span class="token punctuation">]</span><span class="token punctuation">.</span>iFDID <span class="token operator">==</span> iFDID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> m_atUniqueFDPtrMap<span class="token punctuation">[</span>iFD<span class="token punctuation">]</span><span class="token punctuation">.</span>poFD<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>RunOnce</code> 获得可用的文件描述符及事件后，读取其对应的 FD 对象并执行 <code>HandleRead</code> 和 <code>HandleWrite</code>，注意这里忽略了处理的返回值。接下来看 <a href="https://github.com/Tencent/paxosstore/blob/master/certain/network/IOChannel.h"><code>network/IOChannel.h</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CERTAIN_IO_BUFFER_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">40</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span>  </span><span class="token comment">// 40MB == 2 * (MAX_WRITEBATCH_SIZE + 1000)</span></span>

<span class="token keyword">class</span> <span class="token class-name">clsIOChannel</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">clsFDBase</span></span> <span class="token punctuation">{</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
  ConnInfo_t m_tConnInfo<span class="token punctuation">;</span>

  <span class="token comment">// 0 &lt;= iStart0 &lt;= iEnd0 &lt;= iStart1 &lt;= iEnd1 &lt;= iSize</span>
  <span class="token comment">// The valid data is [iStart0, iEnd0) and [iStart1, iEnd1).</span>
  <span class="token keyword">struct</span> <span class="token class-name">CBuffer_t</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>pcData<span class="token punctuation">;</span>
    <span class="token keyword">uint32_t</span> iSize<span class="token punctuation">;</span>

    <span class="token keyword">uint32_t</span> iStart0<span class="token punctuation">;</span>
    <span class="token keyword">uint32_t</span> iEnd0<span class="token punctuation">;</span>

    <span class="token keyword">uint32_t</span> iStart1<span class="token punctuation">;</span>
    <span class="token keyword">uint32_t</span> iEnd1<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">InitCBuffer</span><span class="token punctuation">(</span>CBuffer_t <span class="token operator">*</span>ptBuffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ptBuffer<span class="token operator">-></span>pcData <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>CERTAIN_IO_BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ptBuffer<span class="token operator">-></span>iSize <span class="token operator">=</span> CERTAIN_IO_BUFFER_SIZE<span class="token punctuation">;</span>

    ptBuffer<span class="token operator">-></span>iStart0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    ptBuffer<span class="token operator">-></span>iEnd0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    ptBuffer<span class="token operator">-></span>iStart1 <span class="token operator">=</span> ptBuffer<span class="token operator">-></span>iSize<span class="token punctuation">;</span>
    ptBuffer<span class="token operator">-></span>iEnd1 <span class="token operator">=</span> ptBuffer<span class="token operator">-></span>iSize<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">UpdateBuffer</span><span class="token punctuation">(</span>CBuffer_t <span class="token operator">*</span>ptBuffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">AssertNotMore</span><span class="token punctuation">(</span>ptBuffer<span class="token operator">-></span>iStart0<span class="token punctuation">,</span> ptBuffer<span class="token operator">-></span>iEnd0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">AssertNotMore</span><span class="token punctuation">(</span>ptBuffer<span class="token operator">-></span>iEnd0<span class="token punctuation">,</span> ptBuffer<span class="token operator">-></span>iStart1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">AssertNotMore</span><span class="token punctuation">(</span>ptBuffer<span class="token operator">-></span>iStart1<span class="token punctuation">,</span> ptBuffer<span class="token operator">-></span>iEnd1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">AssertNotMore</span><span class="token punctuation">(</span>ptBuffer<span class="token operator">-></span>iEnd1<span class="token punctuation">,</span> ptBuffer<span class="token operator">-></span>iSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptBuffer<span class="token operator">-></span>iStart1 <span class="token operator">&lt;</span> ptBuffer<span class="token operator">-></span>iEnd1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">AssertEqual</span><span class="token punctuation">(</span>ptBuffer<span class="token operator">-></span>iStart0<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">AssertEqual</span><span class="token punctuation">(</span>ptBuffer<span class="token operator">-></span>iStart1<span class="token punctuation">,</span> ptBuffer<span class="token operator">-></span>iEnd1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ptBuffer<span class="token operator">-></span>iStart1 <span class="token operator">=</span> ptBuffer<span class="token operator">-></span>iSize<span class="token punctuation">;</span>
    ptBuffer<span class="token operator">-></span>iEnd1 <span class="token operator">=</span> ptBuffer<span class="token operator">-></span>iSize<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptBuffer<span class="token operator">-></span>iStart0 <span class="token operator">==</span> ptBuffer<span class="token operator">-></span>iEnd0<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ptBuffer<span class="token operator">-></span>iStart0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      ptBuffer<span class="token operator">-></span>iEnd0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptBuffer<span class="token operator">-></span>iStart1 <span class="token operator">-</span> ptBuffer<span class="token operator">-></span>iEnd0 <span class="token operator">&lt;=</span> ptBuffer<span class="token operator">-></span>iStart0<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ptBuffer<span class="token operator">-></span>iStart1 <span class="token operator">=</span> ptBuffer<span class="token operator">-></span>iStart0<span class="token punctuation">;</span>
      ptBuffer<span class="token operator">-></span>iEnd1 <span class="token operator">=</span> ptBuffer<span class="token operator">-></span>iEnd0<span class="token punctuation">;</span>

      ptBuffer<span class="token operator">-></span>iStart0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      ptBuffer<span class="token operator">-></span>iEnd0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">uint32_t</span> <span class="token function">GetSize</span><span class="token punctuation">(</span>CBuffer_t <span class="token operator">*</span>ptBuffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">uint32_t</span> iSize <span class="token operator">=</span> <span class="token punctuation">(</span>ptBuffer<span class="token operator">-></span>iEnd1 <span class="token operator">-</span> ptBuffer<span class="token operator">-></span>iStart1<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>ptBuffer<span class="token operator">-></span>iEnd0 <span class="token operator">-</span> ptBuffer<span class="token operator">-></span>iStart0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> iSize<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">DestroyCBuffer</span><span class="token punctuation">(</span>CBuffer_t <span class="token operator">*</span>ptBuffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">free</span><span class="token punctuation">(</span>ptBuffer<span class="token operator">-></span>pcData<span class="token punctuation">)</span><span class="token punctuation">,</span> ptBuffer<span class="token operator">-></span>pcData <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>ptBuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>CBuffer_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  string m_strReadBytes<span class="token punctuation">;</span>
  CBuffer_t m_tWriteBuffer<span class="token punctuation">;</span>

  <span class="token keyword">uint64_t</span> m_iTotalReadCnt<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> m_iTotalWriteCnt<span class="token punctuation">;</span>

  <span class="token keyword">uint64_t</span> m_iTimestampUS<span class="token punctuation">;</span>

  <span class="token keyword">uint32_t</span> m_iServerID<span class="token punctuation">;</span>

  <span class="token keyword">bool</span> m_bBroken<span class="token punctuation">;</span>

 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">class</span> <span class="token class-name">clsSerializeCBBase</span> <span class="token punctuation">{</span>
   <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">Call</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>pcBuffer<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> iSize<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">clsSerializeCBBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 构造，io_handler / conn_info / server_id / fd_id</span>
  <span class="token function">clsIOChannel</span><span class="token punctuation">(</span>clsIOHandlerBase <span class="token operator">*</span>poHandler<span class="token punctuation">,</span> <span class="token keyword">const</span> ConnInfo_t <span class="token operator">&amp;</span>tConnInfo<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> iServerID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
               <span class="token keyword">uint32_t</span> iFDID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">clsFDBase</span><span class="token punctuation">(</span>tConnInfo<span class="token punctuation">.</span>iFD<span class="token punctuation">,</span> poHandler<span class="token punctuation">,</span> iFDID<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">m_tConnInfo</span><span class="token punctuation">(</span>tConnInfo<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">m_iTotalReadCnt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">m_iTotalWriteCnt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">m_iTimestampUS</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">m_iServerID</span><span class="token punctuation">(</span>iServerID<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">m_bBroken</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">InitCBuffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_tWriteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 析构，删内存</span>
  <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">clsIOChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">PrintInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">DestroyCBuffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_tWriteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">int</span> <span class="token function">Read</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>pcBuffer<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> iSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> <span class="token function">Write</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pcBuffer<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> iSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> <span class="token function">FlushWriteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">TYPE_GET_SET</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">,</span> TimestampUS<span class="token punctuation">,</span> iTimestampUS<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Return 0 iff append successfully.</span>
  <span class="token keyword">int</span> <span class="token function">AppendReadBytes</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pcBuffer<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> iSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> <span class="token function">AppendWriteBytes</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pcBuffer<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> iSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> <span class="token function">AppendWriteBytes</span><span class="token punctuation">(</span>clsSerializeCBBase <span class="token operator">*</span>poSerializeCB<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">uint32_t</span> <span class="token function">GetWriteByteSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">GetSize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_tWriteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">uint32_t</span> <span class="token function">GetServerID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_iServerID<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">const</span> ConnInfo_t <span class="token operator">&amp;</span><span class="token function">GetConnInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_tConnInfo<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">bool</span> <span class="token function">IsBroken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_bBroken<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">bool</span> <span class="token function">IsBufferBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Check if above 1/8 CERTAIN_IO_BUFFER_SIZE.</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">GetWriteByteSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">></span> CERTAIN_IO_BUFFER_SIZE<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">PrintInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p><code>clsIOChannel</code> 则继承了 <code>clsFDBase</code> 类，并封装了 Socket 连接。类的声明中有一大部分是用来定义写入缓存 <code>CBuffer_t</code>，简单来说就是 Flush 剩下的部分存为 <code>[iStart1, iEnd1)</code>，新缓存存到 <code>[iStart0, iEnd0)</code>，故每次执行 Flush 时，都需要先写 <code>[iStart1, iEnd1)</code>。来看函数的实现：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">int</span> clsIOChannel<span class="token double-colon punctuation">::</span><span class="token function">Read</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>pcBuffer<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> iSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iRet<span class="token punctuation">;</span>
  <span class="token keyword">int</span> iFD <span class="token operator">=</span> clsFDBase<span class="token double-colon punctuation">::</span><span class="token function">GetFD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_bBroken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">Assert</span><span class="token punctuation">(</span>clsFDBase<span class="token double-colon punctuation">::</span><span class="token function">IsReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">uint32_t</span> iCurr <span class="token operator">=</span> m_strReadBytes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">AssertLess</span><span class="token punctuation">(</span>iCurr<span class="token punctuation">,</span> iSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">memcpy</span><span class="token punctuation">(</span>pcBuffer<span class="token punctuation">,</span> m_strReadBytes<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iCurr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  m_strReadBytes<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>iCurr <span class="token operator">&lt;</span> iSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    iRet <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>iFD<span class="token punctuation">,</span> pcBuffer <span class="token operator">+</span> iCurr<span class="token punctuation">,</span> iSize <span class="token operator">-</span> iCurr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      iCurr <span class="token operator">+=</span> iRet<span class="token punctuation">;</span>
      m_iTotalReadCnt <span class="token operator">+=</span> iRet<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// read 返回 0，连接中断</span>
      InetAddr_t tPeerAddr <span class="token operator">=</span> m_tConnInfo<span class="token punctuation">.</span>tPeerAddr<span class="token punctuation">;</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"closed by peer %s fd %d"</span><span class="token punctuation">,</span> tPeerAddr<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iFD<span class="token punctuation">)</span><span class="token punctuation">;</span>

      m_bBroken <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogDebug</span><span class="token punctuation">(</span><span class="token string">"read ret -1 fd %d errno %d"</span><span class="token punctuation">,</span> iFD<span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 遇到中断</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 暂时不可用</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EAGAIN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        clsFDBase<span class="token double-colon punctuation">::</span><span class="token function">SetReadable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      m_bBroken <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"read ret -1 conn: %s errno %d"</span><span class="token punctuation">,</span> m_tConnInfo<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_bBroken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>iCurr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">Assert</span><span class="token punctuation">(</span>m_bBroken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> iCurr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> clsIOChannel<span class="token double-colon punctuation">::</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pcBuffer<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> iSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iRet<span class="token punctuation">;</span>

  iRet <span class="token operator">=</span> <span class="token function">AppendWriteBytes</span><span class="token punctuation">(</span>pcBuffer<span class="token punctuation">,</span> iSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"AppendWriteBytes ret %d"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  iRet <span class="token operator">=</span> <span class="token function">FlushWriteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"FlushWriteBuffer ret %d"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> iSize<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 真正地写入</span>
<span class="token keyword">int</span> clsIOChannel<span class="token double-colon punctuation">::</span><span class="token function">FlushWriteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iRet<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_bBroken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">Assert</span><span class="token punctuation">(</span>clsFDBase<span class="token double-colon punctuation">::</span><span class="token function">IsWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">uint32_t</span> iDataSize <span class="token operator">=</span> <span class="token function">GetSize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_tWriteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iDataSize <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">int</span> iFD <span class="token operator">=</span> clsFDBase<span class="token double-colon punctuation">::</span><span class="token function">GetFD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">iovec</span> atBuffer<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  atBuffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> m_tWriteBuffer<span class="token punctuation">.</span>pcData <span class="token operator">+</span> m_tWriteBuffer<span class="token punctuation">.</span>iStart1<span class="token punctuation">;</span>
  atBuffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> m_tWriteBuffer<span class="token punctuation">.</span>iEnd1 <span class="token operator">-</span> m_tWriteBuffer<span class="token punctuation">.</span>iStart1<span class="token punctuation">;</span>

  atBuffer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> m_tWriteBuffer<span class="token punctuation">.</span>pcData <span class="token operator">+</span> m_tWriteBuffer<span class="token punctuation">.</span>iStart0<span class="token punctuation">;</span>
  atBuffer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> m_tWriteBuffer<span class="token punctuation">.</span>iEnd0 <span class="token operator">-</span> m_tWriteBuffer<span class="token punctuation">.</span>iStart0<span class="token punctuation">;</span>

  <span class="token keyword">int</span> iBufferIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>iDataSize <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">AssertLess</span><span class="token punctuation">(</span>iBufferIdx<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    iRet <span class="token operator">=</span> <span class="token function">writev</span><span class="token punctuation">(</span>iFD<span class="token punctuation">,</span> atBuffer <span class="token operator">+</span> iBufferIdx<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">-</span> iBufferIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">AssertNotEqual</span><span class="token punctuation">(</span>iRet<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      m_iTotalWriteCnt <span class="token operator">+=</span> iRet<span class="token punctuation">;</span>
      iDataSize <span class="token operator">-=</span> iRet<span class="token punctuation">;</span>

      <span class="token keyword">while</span> <span class="token punctuation">(</span>iRet <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">AssertLess</span><span class="token punctuation">(</span>iBufferIdx<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">size_t</span><span class="token punctuation">(</span>iRet<span class="token punctuation">)</span> <span class="token operator">&lt;</span> atBuffer<span class="token punctuation">[</span>iBufferIdx<span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          atBuffer<span class="token punctuation">[</span>iBufferIdx<span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">-=</span> iRet<span class="token punctuation">;</span>
          atBuffer<span class="token punctuation">[</span>iBufferIdx<span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>atBuffer<span class="token punctuation">[</span>iBufferIdx<span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">+</span> iRet<span class="token punctuation">;</span>
          iRet <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          iRet <span class="token operator">-=</span> atBuffer<span class="token punctuation">[</span>iBufferIdx<span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token punctuation">;</span>
          atBuffer<span class="token punctuation">[</span>iBufferIdx<span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          iBufferIdx<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogDebug</span><span class="token punctuation">(</span><span class="token string">"read ret -1 fd %d errno %d"</span><span class="token punctuation">,</span> iFD<span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EAGAIN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        clsFDBase<span class="token double-colon punctuation">::</span><span class="token function">SetWritable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      m_bBroken <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"write fail fd %d errno %d"</span><span class="token punctuation">,</span> iFD<span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  m_tWriteBuffer<span class="token punctuation">.</span>iStart0 <span class="token operator">=</span> m_tWriteBuffer<span class="token punctuation">.</span>iEnd0 <span class="token operator">-</span> atBuffer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token punctuation">;</span>
  m_tWriteBuffer<span class="token punctuation">.</span>iStart1 <span class="token operator">=</span> m_tWriteBuffer<span class="token punctuation">.</span>iEnd1 <span class="token operator">-</span> atBuffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token punctuation">;</span>
  <span class="token function">UpdateBuffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_tWriteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_bBroken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 读取同样写入 buffer 中</span>
<span class="token keyword">int</span> clsIOChannel<span class="token double-colon punctuation">::</span><span class="token function">AppendReadBytes</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pcBuffer<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> iSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  m_strReadBytes<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>pcBuffer<span class="token punctuation">,</span> iSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 写入 buffer 中</span>
<span class="token keyword">int</span> clsIOChannel<span class="token double-colon punctuation">::</span><span class="token function">AppendWriteBytes</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pcBuffer<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> iSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">UpdateBuffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_tWriteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>iSize <span class="token operator">></span> m_tWriteBuffer<span class="token punctuation">.</span>iStart1 <span class="token operator">-</span> m_tWriteBuffer<span class="token punctuation">.</span>iEnd0<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">memcpy</span><span class="token punctuation">(</span>m_tWriteBuffer<span class="token punctuation">.</span>pcData <span class="token operator">+</span> m_tWriteBuffer<span class="token punctuation">.</span>iEnd0<span class="token punctuation">,</span> pcBuffer<span class="token punctuation">,</span> iSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  m_tWriteBuffer<span class="token punctuation">.</span>iEnd0 <span class="token operator">+=</span> iSize<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 序列化地写入 buffer 中</span>
<span class="token keyword">int</span> clsIOChannel<span class="token double-colon punctuation">::</span><span class="token function">AppendWriteBytes</span><span class="token punctuation">(</span>clsSerializeCBBase <span class="token operator">*</span>poCB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">UpdateBuffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_tWriteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> iRet <span class="token operator">=</span> poCB<span class="token operator">-></span><span class="token function">Call</span><span class="token punctuation">(</span>m_tWriteBuffer<span class="token punctuation">.</span>pcData <span class="token operator">+</span> m_tWriteBuffer<span class="token punctuation">.</span>iEnd0<span class="token punctuation">,</span>
                        m_tWriteBuffer<span class="token punctuation">.</span>iStart1 <span class="token operator">-</span> m_tWriteBuffer<span class="token punctuation">.</span>iEnd0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"poCB->Call max_size %u ret %d"</span><span class="token punctuation">,</span> m_tWriteBuffer<span class="token punctuation">.</span>iStart1 <span class="token operator">-</span> m_tWriteBuffer<span class="token punctuation">.</span>iEnd0<span class="token punctuation">,</span>
                    iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  m_tWriteBuffer<span class="token punctuation">.</span>iEnd0 <span class="token operator">+=</span> iRet<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>Read</code> 时先将缓存的数据读取出来，后执行 <code>read(fd)</code> 读取真实的数据。注意 <code>Readable</code> 状态的判断和使用。<code>Write</code> 时先将数据写入缓存中，而后执行 <code>FlushWriteBuffer</code> 执行真正的 <code>write(fd)</code>。实际使用中需要配合 <code>clsEpollIO</code> 和 <code>clsIOHandlerBase</code> 一起使用，在 <code>HandleRead</code> 执行 <code>Read</code>，在 <code>HandleWrite</code> 时执行 <code>FlushWriteBuffer</code>，这部分将在之后的 <code>clsIOWorker</code> 类中有所体现。</p>
<p>接下来看一下 <code>ConnWorker</code> 的实现。这里调整一下代码的顺序，先看 <a href="https://github.com/Tencent/paxosstore/blob/master/certain/src/ConnWorker.h"><code>src/ConnWorker.h</code></a> 中 <code>clsConnWorker</code> 的定义：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">clsConnWorker</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">clsThreadBase</span></span> <span class="token punctuation">{</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
  clsConfigure <span class="token operator">*</span>m_poConf<span class="token punctuation">;</span>
  clsEpollIO <span class="token operator">*</span>m_poEpollIO<span class="token punctuation">;</span>

  clsListenHandler <span class="token operator">*</span>m_poListenHandler<span class="token punctuation">;</span>
  clsNegoHandler <span class="token operator">*</span>m_poNegoHandler<span class="token punctuation">;</span>

  <span class="token keyword">int</span> <span class="token function">AddListen</span><span class="token punctuation">(</span><span class="token keyword">const</span> InetAddr_t <span class="token operator">&amp;</span>tInetAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> <span class="token function">AddAllListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> <span class="token function">RecvNegoMsg</span><span class="token punctuation">(</span>clsNegoContext <span class="token operator">*</span>poNegoCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> <span class="token function">AcceptOneFD</span><span class="token punctuation">(</span>clsListenContext <span class="token operator">*</span>poContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">clsConnWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">clsConnWorker</span><span class="token punctuation">(</span>clsConfigure <span class="token operator">*</span>poConf<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> <span class="token function">HandleListen</span><span class="token punctuation">(</span>clsListenContext <span class="token operator">*</span>poContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> <span class="token function">HandleNego</span><span class="token punctuation">(</span>clsNegoContext <span class="token operator">*</span>poNegoCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p><code>clsConnWorker</code> 继承于 <code>clsThreadBase</code>，封装了 <code>pthread</code>，线程启动时会执行 <code>Run</code> 函数：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">void</span> clsConnWorker<span class="token double-colon punctuation">::</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">uint32_t</span> iLocalServerID <span class="token operator">=</span> m_poConf<span class="token operator">-></span><span class="token function">GetLocalServerID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">SetThreadTitle</span><span class="token punctuation">(</span><span class="token string">"conn_%u"</span><span class="token punctuation">,</span> iLocalServerID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"conn_%u run"</span><span class="token punctuation">,</span> iLocalServerID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> iRet <span class="token operator">=</span> <span class="token function">AddAllListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"AddAllListen ret %d"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Assert</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    m_poEpollIO<span class="token operator">-></span><span class="token function">RunOnce</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CheckIfExiting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"conn_%u exit\n"</span><span class="token punctuation">,</span> iLocalServerID<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"conn_%u exit"</span><span class="token punctuation">,</span> iLocalServerID<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>Run</code> 函数中首先会执行 <code>AddAllListen</code> 启动服务端的地址监听 <code>AddAllListen</code>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">int</span> clsConnWorker<span class="token double-colon punctuation">::</span><span class="token function">AddAllListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iRet<span class="token punctuation">;</span>

  <span class="token keyword">uint32_t</span> iLocalServerID <span class="token operator">=</span> m_poConf<span class="token operator">-></span><span class="token function">GetLocalServerID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  vector<span class="token operator">&lt;</span>InetAddr_t<span class="token operator">></span> vecServerAddr <span class="token operator">=</span> m_poConf<span class="token operator">-></span><span class="token function">GetServerAddrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">AssertLess</span><span class="token punctuation">(</span>iLocalServerID<span class="token punctuation">,</span> vecServerAddr<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  iRet <span class="token operator">=</span> <span class="token function">AddListen</span><span class="token punctuation">(</span>vecServerAddr<span class="token punctuation">[</span>iLocalServerID<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"AddListen ret %d"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> clsConnWorker<span class="token double-colon punctuation">::</span><span class="token function">AddListen</span><span class="token punctuation">(</span><span class="token keyword">const</span> InetAddr_t <span class="token operator">&amp;</span>tLocalAddr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iRet<span class="token punctuation">;</span>
  <span class="token keyword">int</span> iBacklog <span class="token operator">=</span> <span class="token number">8096</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> iFD <span class="token operator">=</span> <span class="token function">CreateSocket</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tLocalAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iFD <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"CreateSocket ret %d"</span><span class="token punctuation">,</span> iFD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  iRet <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>iFD<span class="token punctuation">,</span> iBacklog<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"listen ret - 1 errno %d"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"Start listen addr %s fd %d"</span><span class="token punctuation">,</span> tLocalAddr<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iFD<span class="token punctuation">)</span><span class="token punctuation">;</span>

  clsListenContext <span class="token operator">*</span>poContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">clsListenContext</span><span class="token punctuation">(</span>iFD<span class="token punctuation">,</span> m_poListenHandler<span class="token punctuation">,</span> tLocalAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

  iRet <span class="token operator">=</span> m_poEpollIO<span class="token operator">-></span><span class="token function">Add</span><span class="token punctuation">(</span>poContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"m_poEpollIO->Add ret %d"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">AssertEqual</span><span class="token punctuation">(</span><span class="token function">close</span><span class="token punctuation">(</span>iFD<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> poContext<span class="token punctuation">,</span> poContext <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>AddListen</code> 中创建了 Socket 连接，并且监听了服务端设定的地址，而后创建了一 <code>clsListenContext</code> 对象并将其加入 Epoll 对象中。当该连接可读时，说明有新的客户端尝试连接 <code>connect</code>，服务端需执行 <code>accept</code> 接受连接，这里看 <code>clsListenContext</code> 及其 <code>Handler</code> 的实现：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">clsListenContext</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">clsFDBase</span></span> <span class="token punctuation">{</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
  InetAddr_t m_tLocalAddr<span class="token punctuation">;</span>

 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">clsListenContext</span><span class="token punctuation">(</span><span class="token keyword">int</span> iFD<span class="token punctuation">,</span> clsIOHandlerBase <span class="token operator">*</span>poIOHandler<span class="token punctuation">,</span> <span class="token keyword">const</span> InetAddr_t <span class="token operator">&amp;</span>tLocalAddr<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">clsFDBase</span><span class="token punctuation">(</span>iFD<span class="token punctuation">,</span> poIOHandler<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>EPOLLIN <span class="token operator">|</span> EPOLLET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_tLocalAddr</span><span class="token punctuation">(</span>tLocalAddr<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">clsListenContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  InetAddr_t <span class="token function">GetLocalAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_tLocalAddr<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">clsListenHandler</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">clsIOHandlerBase</span></span> <span class="token punctuation">{</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
  clsConnWorker <span class="token operator">*</span>m_poConnWorker<span class="token punctuation">;</span>

 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">clsListenHandler</span><span class="token punctuation">(</span>clsConnWorker <span class="token operator">*</span>poConnWorker<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">m_poConnWorker</span><span class="token punctuation">(</span>poConnWorker<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">clsListenHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">HandleRead</span><span class="token punctuation">(</span>clsFDBase <span class="token operator">*</span>poFD<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">HandleWrite</span><span class="token punctuation">(</span>clsFDBase <span class="token operator">*</span>poFD<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> clsListenHandler<span class="token double-colon punctuation">::</span><span class="token function">HandleRead</span><span class="token punctuation">(</span>clsFDBase <span class="token operator">*</span>poFD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> m_poConnWorker<span class="token operator">-></span><span class="token function">HandleListen</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>clsListenContext <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>poFD<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> clsListenHandler<span class="token double-colon punctuation">::</span><span class="token function">HandleWrite</span><span class="token punctuation">(</span>clsFDBase <span class="token operator">*</span>poFD<span class="token punctuation">)</span> <span class="token punctuation">{</span> CERTAIN_EPOLLIO_UNREACHABLE<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token comment">// 处理 Listen，要么建立连接，要么重新 Listen</span>
<span class="token keyword">int</span> clsConnWorker<span class="token double-colon punctuation">::</span><span class="token function">HandleListen</span><span class="token punctuation">(</span>clsListenContext <span class="token operator">*</span>poContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> iRet <span class="token operator">=</span> <span class="token function">AcceptOneFD</span><span class="token punctuation">(</span>poContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Relisten when the fd is invalid, Check if Bug.</span>

      clsAutoDelete<span class="token operator">&lt;</span>clsListenContext<span class="token operator">></span> <span class="token function">oAuto</span><span class="token punctuation">(</span>poContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"AcceptOnce ret %d"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">int</span> iFD <span class="token operator">=</span> poContext<span class="token operator">-></span><span class="token function">GetFD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      iRet <span class="token operator">=</span> <span class="token function">close</span><span class="token punctuation">(</span>iFD<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">AssertEqual</span><span class="token punctuation">(</span>iRet<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      iRet <span class="token operator">=</span> <span class="token function">AddListen</span><span class="token punctuation">(</span>poContext<span class="token operator">-></span><span class="token function">GetLocalAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">AssertEqual</span><span class="token punctuation">(</span>iRet<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">AssertEqual</span><span class="token punctuation">(</span>iRet<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// accept client 端的连接，并将 NegoContext 加入 epoll</span>
<span class="token keyword">int</span> clsConnWorker<span class="token double-colon punctuation">::</span><span class="token function">AcceptOneFD</span><span class="token punctuation">(</span>clsListenContext <span class="token operator">*</span>poContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iRet<span class="token punctuation">;</span>
  <span class="token keyword">int</span> iFD<span class="token punctuation">,</span> iListenFD <span class="token operator">=</span> poContext<span class="token operator">-></span><span class="token function">GetFD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ConnInfo_t tConnInfo<span class="token punctuation">;</span>

  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> tSockAddr<span class="token punctuation">;</span>
  socklen_t tLen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tSockAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    iFD <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>iListenFD<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tSockAddr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iFD <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EAGAIN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"accept ret -1 errno %d"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">AssertEqual</span><span class="token punctuation">(</span><span class="token function">SetNonBlock</span><span class="token punctuation">(</span>iFD<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  tConnInfo<span class="token punctuation">.</span>tLocalAddr <span class="token operator">=</span> poContext<span class="token operator">-></span><span class="token function">GetLocalAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tConnInfo<span class="token punctuation">.</span>tPeerAddr <span class="token operator">=</span> <span class="token function">InetAddr_t</span><span class="token punctuation">(</span>tSockAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  tConnInfo<span class="token punctuation">.</span>iFD <span class="token operator">=</span> iFD<span class="token punctuation">;</span>

  <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"accept conn %s"</span><span class="token punctuation">,</span> tConnInfo<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  clsNegoContext <span class="token operator">*</span>poNegoCtx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">clsNegoContext</span><span class="token punctuation">(</span>m_poNegoHandler<span class="token punctuation">,</span> tConnInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  iRet <span class="token operator">=</span> m_poEpollIO<span class="token operator">-></span><span class="token function">Add</span><span class="token punctuation">(</span>poNegoCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"m_poEpollIO->Add ret %d"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">AssertEqual</span><span class="token punctuation">(</span><span class="token function">close</span><span class="token punctuation">(</span>tConnInfo<span class="token punctuation">.</span>iFD<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> poNegoCtx<span class="token punctuation">,</span> poNegoCtx <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>在 <code>AcceptOneFD</code> 中，服务端接受了新连接，将新连接设定为非阻塞模式，并构造了 <code>clsNegoContext</code> 加入 Epoll 对象中，当客户端写入数据、该连接可读时：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// 协商上下文</span>
<span class="token keyword">class</span> <span class="token class-name">clsNegoContext</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">clsFDBase</span></span> <span class="token punctuation">{</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
  ConnInfo_t m_tConnInfo<span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> m_iServerID<span class="token punctuation">;</span>

 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">clsNegoContext</span><span class="token punctuation">(</span>clsIOHandlerBase <span class="token operator">*</span>poHandler<span class="token punctuation">,</span> <span class="token keyword">const</span> ConnInfo_t <span class="token operator">&amp;</span>tConnInfo<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">clsFDBase</span><span class="token punctuation">(</span>tConnInfo<span class="token punctuation">.</span>iFD<span class="token punctuation">,</span> poHandler<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>EPOLLIN <span class="token operator">|</span> EPOLLET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">m_tConnInfo</span><span class="token punctuation">(</span>tConnInfo<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">m_iServerID</span><span class="token punctuation">(</span>INVALID_SERVER_ID<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">clsNegoContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">const</span> ConnInfo_t <span class="token operator">&amp;</span><span class="token function">GetConnInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_tConnInfo<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token function">TYPE_GET_SET</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">,</span> ServerID<span class="token punctuation">,</span> iServerID<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">clsNegoHandler</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">clsIOHandlerBase</span></span> <span class="token punctuation">{</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
  clsConnWorker <span class="token operator">*</span>m_poConnWorker<span class="token punctuation">;</span>

 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">clsNegoHandler</span><span class="token punctuation">(</span>clsConnWorker <span class="token operator">*</span>poConnWorker<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">m_poConnWorker</span><span class="token punctuation">(</span>poConnWorker<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">clsNegoHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">HandleRead</span><span class="token punctuation">(</span>clsFDBase <span class="token operator">*</span>poFD<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">HandleWrite</span><span class="token punctuation">(</span>clsFDBase <span class="token operator">*</span>poFD<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> clsNegoHandler<span class="token double-colon punctuation">::</span><span class="token function">HandleRead</span><span class="token punctuation">(</span>clsFDBase <span class="token operator">*</span>poFD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 当 client 发送数据时</span>
  <span class="token keyword">return</span> m_poConnWorker<span class="token operator">-></span><span class="token function">HandleNego</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>clsNegoContext <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>poFD<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> clsNegoHandler<span class="token double-colon punctuation">::</span><span class="token function">HandleWrite</span><span class="token punctuation">(</span>clsFDBase <span class="token operator">*</span>poFD<span class="token punctuation">)</span> <span class="token punctuation">{</span> CERTAIN_EPOLLIO_UNREACHABLE<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token comment">// 校验 client 连接，并从 epoll 中删除 NegoContext，加入连接池</span>
<span class="token keyword">int</span> clsConnWorker<span class="token double-colon punctuation">::</span><span class="token function">HandleNego</span><span class="token punctuation">(</span>clsNegoContext <span class="token operator">*</span>poNegoCtx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iRet<span class="token punctuation">;</span>
  clsAutoDelete<span class="token operator">&lt;</span>clsNegoContext<span class="token operator">></span> <span class="token function">oAuto</span><span class="token punctuation">(</span>poNegoCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>

  iRet <span class="token operator">=</span> <span class="token function">RecvNegoMsg</span><span class="token punctuation">(</span>poNegoCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"RecvNegoMsg ret %d"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_poEpollIO<span class="token operator">-></span><span class="token function">RemoveAndCloseFD</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>clsFDBase <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>poNegoCtx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  m_poEpollIO<span class="token operator">-></span><span class="token function">Remove</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>clsFDBase <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>poNegoCtx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// For check only.</span>
  ConnInfo_t tConnInfo <span class="token operator">=</span> poNegoCtx<span class="token operator">-></span><span class="token function">GetConnInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> bInnerServer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  vector<span class="token operator">&lt;</span>InetAddr_t<span class="token operator">></span> vecAddr <span class="token operator">=</span> m_poConf<span class="token operator">-></span><span class="token function">GetServerAddrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> vecAddr<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vecAddr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">GetNetOrderIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> tConnInfo<span class="token punctuation">.</span>tPeerAddr<span class="token punctuation">.</span><span class="token function">GetNetOrderIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!=</span> poNegoCtx<span class="token operator">-></span><span class="token function">GetServerID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"%u -> %u Check if replace machine conn: %s"</span><span class="token punctuation">,</span> poNegoCtx<span class="token operator">-></span><span class="token function">GetServerID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span>
                        tConnInfo<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        poNegoCtx<span class="token operator">-></span><span class="token function">SetServerID</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      bInnerServer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bInnerServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"conn %s not from Inner Servers, check it"</span><span class="token punctuation">,</span> tConnInfo<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>poNegoCtx<span class="token operator">-></span><span class="token function">GetFD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"srvid %u conn %s from Inner Servers"</span><span class="token punctuation">,</span> poNegoCtx<span class="token operator">-></span><span class="token function">GetServerID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 tConnInfo<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  iRet <span class="token operator">=</span> clsConnInfoMng<span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">PutByOneThread</span><span class="token punctuation">(</span>poNegoCtx<span class="token operator">-></span><span class="token function">GetServerID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                       poNegoCtx<span class="token operator">-></span><span class="token function">GetConnInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"clsConnInfoMng PutByOneThread ret %d"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>poNegoCtx<span class="token operator">-></span><span class="token function">GetFD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 接收 MagicNumber 并设定 ServerID</span>
<span class="token keyword">int</span> clsConnWorker<span class="token double-colon punctuation">::</span><span class="token function">RecvNegoMsg</span><span class="token punctuation">(</span>clsNegoContext <span class="token operator">*</span>poNegoCtx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iRet<span class="token punctuation">;</span>

  <span class="token keyword">const</span> ConnInfo_t <span class="token operator">&amp;</span>tConnInfo <span class="token operator">=</span> poNegoCtx<span class="token operator">-></span><span class="token function">GetConnInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> iFD <span class="token operator">=</span> tConnInfo<span class="token punctuation">.</span>iFD<span class="token punctuation">;</span>

  <span class="token keyword">uint8_t</span> acNego<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    iRet <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>iFD<span class="token punctuation">,</span> acNego<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EAGAIN <span class="token operator">||</span> errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"conn %s errno %d"</span><span class="token punctuation">,</span> tConnInfo<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"conn %s closed by peer"</span><span class="token punctuation">,</span> tConnInfo<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"simple close conn %s"</span><span class="token punctuation">,</span> tConnInfo<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">AssertEqual</span><span class="token punctuation">(</span>iRet<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">uint16_t</span> hMagicNum <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>acNego<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hMagicNum <span class="token operator">!=</span> RP_MAGIC_NUM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"BUG conn %s no RP_MAGIC_NUM found"</span><span class="token punctuation">,</span> tConnInfo<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">uint32_t</span> iServerID <span class="token operator">=</span> <span class="token keyword">uint32_t</span><span class="token punctuation">(</span>acNego<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  poNegoCtx<span class="token operator">-></span><span class="token function">SetServerID</span><span class="token punctuation">(</span>iServerID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">CertainLogDebug</span><span class="token punctuation">(</span><span class="token string">"iServerID %u conn %s"</span><span class="token punctuation">,</span> iServerID<span class="token punctuation">,</span> tConnInfo<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>RecvNegoMsg</code> 函数中会尝试读取客户端发送过来的三个字节，校验 Magic Number；<code>RecvNegoMsg</code> 函数中会判断是否为内部服务器；均成功则将键值对 <code>&lt;ServerID, ConnInfo&gt;</code> 加入连接池 <code>clsConnInfoMng</code> 中：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// 连接池单例</span>
<span class="token keyword">class</span> <span class="token class-name">clsConnInfoMng</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">clsSingleton</span><span class="token operator">&lt;</span><span class="token class-name">clsConnInfoMng</span><span class="token operator">></span></span> <span class="token punctuation">{</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
  clsConfigure <span class="token operator">*</span>m_poConf<span class="token punctuation">;</span>

  <span class="token keyword">uint32_t</span> m_iServerNum<span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> m_iLocalServerID<span class="token punctuation">;</span>

  clsMutex m_oMutex<span class="token punctuation">;</span>

  vector<span class="token operator">&lt;</span>queue<span class="token operator">&lt;</span>ConnInfo_t<span class="token operator">></span> <span class="token operator">></span> m_vecIntConnQueue<span class="token punctuation">;</span>

  <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">clsSingleton</span><span class="token operator">&lt;</span>clsConnInfoMng<span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token function">clsConnInfoMng</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">RemoveInvalidConn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">int</span> <span class="token function">Init</span><span class="token punctuation">(</span>clsConfigure <span class="token operator">*</span>poConf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">Destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> <span class="token function">TakeByMultiThread</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> iIOWorkerID<span class="token punctuation">,</span> <span class="token keyword">const</span> vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span>clsIOChannel <span class="token operator">*</span><span class="token operator">></span> <span class="token operator">></span> vecIntChannel<span class="token punctuation">,</span>
                        ConnInfo_t <span class="token operator">&amp;</span>tConnInfo<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> <span class="token operator">&amp;</span>iServerID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> <span class="token function">PutByOneThread</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> iServerID<span class="token punctuation">,</span> <span class="token keyword">const</span> ConnInfo_t <span class="token operator">&amp;</span>tConnInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> clsConnInfoMng<span class="token double-colon punctuation">::</span><span class="token function">Init</span><span class="token punctuation">(</span>clsConfigure <span class="token operator">*</span>poConf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  m_poConf <span class="token operator">=</span> poConf<span class="token punctuation">;</span>

  m_iServerNum <span class="token operator">=</span> m_poConf<span class="token operator">-></span><span class="token function">GetServerNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  m_iLocalServerID <span class="token operator">=</span> m_poConf<span class="token operator">-></span><span class="token function">GetLocalServerID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">Assert</span><span class="token punctuation">(</span>m_vecIntConnQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  m_vecIntConnQueue<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>m_iServerNum<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> clsConnInfoMng<span class="token double-colon punctuation">::</span><span class="token function">Destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> m_vecIntConnQueue<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">int</span> clsConnInfoMng<span class="token double-colon punctuation">::</span><span class="token function">PutByOneThread</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> iServerID<span class="token punctuation">,</span> <span class="token keyword">const</span> ConnInfo_t <span class="token operator">&amp;</span>tConnInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iServerID <span class="token operator">==</span> m_iLocalServerID <span class="token operator">||</span>
      <span class="token punctuation">(</span>iServerID <span class="token operator">>=</span> m_iServerNum <span class="token operator">&amp;&amp;</span> iServerID <span class="token operator">!=</span> INVALID_SERVER_ID<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"Unexpected server id %u"</span><span class="token punctuation">,</span> iServerID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">CertainLogDebug</span><span class="token punctuation">(</span><span class="token string">"iServerID %u conn %s"</span><span class="token punctuation">,</span> iServerID<span class="token punctuation">,</span> tConnInfo<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  clsThreadLock <span class="token function">oLock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_oMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">AssertLess</span><span class="token punctuation">(</span>iServerID<span class="token punctuation">,</span> m_iServerNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
  m_vecIntConnQueue<span class="token punctuation">[</span>iServerID<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>tConnInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> clsConnInfoMng<span class="token double-colon punctuation">::</span><span class="token function">RemoveInvalidConn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">uint32_t</span> iInvalidCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> iConnNotToken <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> m_vecIntConnQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_vecIntConnQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      iConnNotToken<span class="token operator">++</span><span class="token punctuation">;</span>
      ConnInfo_t tConnInfo <span class="token operator">=</span> m_vecIntConnQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CheckIfValid</span><span class="token punctuation">(</span>tConnInfo<span class="token punctuation">.</span>iFD<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      iInvalidCnt<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"Invalid conn: %s"</span><span class="token punctuation">,</span> tConnInfo<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">int</span> iRet <span class="token operator">=</span> <span class="token function">close</span><span class="token punctuation">(</span>tConnInfo<span class="token punctuation">.</span>iFD<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"close fail fd %d errno %d"</span><span class="token punctuation">,</span> tConnInfo<span class="token punctuation">.</span>iFD<span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      m_vecIntConnQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>iInvalidCnt <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"iInvalidCnt %u"</span><span class="token punctuation">,</span> iInvalidCnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>iConnNotToken <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogImpt</span><span class="token punctuation">(</span><span class="token string">"iConnNotToken %u"</span><span class="token punctuation">,</span> iConnNotToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> clsConnInfoMng<span class="token double-colon punctuation">::</span><span class="token function">TakeByMultiThread</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> iIOWorkerID<span class="token punctuation">,</span>
                                      <span class="token keyword">const</span> vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span>clsIOChannel <span class="token operator">*</span><span class="token operator">></span> <span class="token operator">></span> vecIntChannel<span class="token punctuation">,</span>
                                      ConnInfo_t <span class="token operator">&amp;</span>tConnInfo<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> <span class="token operator">&amp;</span>iServerID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  clsThreadLock <span class="token function">oLock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_oMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">RemoveInvalidConn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> m_vecIntConnQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> m_iLocalServerID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">Assert</span><span class="token punctuation">(</span>m_vecIntConnQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_vecIntConnQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Use min first to make every IOWorker has equal IO channels.</span>

    <span class="token keyword">int32_t</span> iMinChannelCnt <span class="token operator">=</span> INT32_MAX<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> iWorkerID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> iWorkerID <span class="token operator">&lt;</span> m_poConf<span class="token operator">-></span><span class="token function">GetIOWorkerNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>iWorkerID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">int32_t</span> iTemp <span class="token operator">=</span> clsIOWorkerRouter<span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetAndAddIntChannelCnt</span><span class="token punctuation">(</span>iWorkerID<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>iMinChannelCnt <span class="token operator">></span> iTemp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        iMinChannelCnt <span class="token operator">=</span> iTemp<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">AssertNotMore</span><span class="token punctuation">(</span>iMinChannelCnt<span class="token punctuation">,</span> vecIntChannel<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vecIntChannel<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">uint32_t</span><span class="token punctuation">(</span>iMinChannelCnt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      tConnInfo <span class="token operator">=</span> m_vecIntConnQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      m_vecIntConnQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      iServerID <span class="token operator">=</span> i<span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>后调用 <code>TakeByMultiThread</code> 则可以取出校验后可用的连接、读写数据实现网络通信了。</p>
<h3 id="3.-总结" tabindex="-1"><a href="#3.-%E6%80%BB%E7%BB%93">3. 总结</a></h3>
<p>Paxos 协议执行过程中包含大量的消息收发，网络通信的性能就十分重要。PaxosStore 中使用了 Epoll 和边缘触发获得高性能，并实现了一定程度的封装提高易用性。下一篇将继续分析 PaxosStore 模块间消息的传递。</p>
<h3 id="references" tabindex="-1"><a href="#references">References</a></h3>
<ol>
<li><a href="https://github.com/Tencent/paxosstore">&quot;Tencent/PaxosStore&quot;, <em>GitHub</em></a></li>
<li><a href="http://www.vldb.org/pvldb/vol10/p1730-lin.pdf">&quot;PaxosStore: High-availability Storage Made Practical in WeChat&quot;, <em>Jianjun Zheng</em></a></li>
</ol>

      </div>
      <div id="gitalk-container">
      </div>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2021 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/gitalk.min.js"></script>
    <script src="/dist/main.js"></script>
    <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-61723712-2', 'auto'); ga('send', 'pageview'); </script>
  </body>
</html>
