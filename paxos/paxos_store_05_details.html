<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/gitalk.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>PaxosStore 源码分析「五、实现细节」 | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> PaxosStore 源码分析「五、实现细节」 </h1>
      </div>
      <div class="info">
        <div class="date"> 2020.03.26 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <p>本系列的上一篇里分析了 PaxosStore 中的协议日志的实现，本篇将深入协议过程中的一些细节，这些实现细节集中在 <a href="https://github.com/Tencent/paxosstore/blob/master/certain/src/EntityWorker.cpp"><code>src/EntityWorker.cpp</code></a> 这个庞然大物里。</p>
<h3 id="1.-entitycatchup" tabindex="-1"><a href="#1.-entitycatchup">1. EntityCatchUp</a></h3>
<p>在对某个 Entity 执行读写前，需要保证该 Entity 在本地的所有 Entry 都已经提交到 DB 了，这样读写才会有意义。简而言之就是 <code>CommittedEntry</code> = <code>MaxChosenEntry</code>。</p>
<p>借此机会，过一遍样例的流程。从 <a href="https://github.com/Tencent/paxosstore/blob/master/certain/example/CardTool.cpp"><code>example/CardTool.cpp</code></a> 这个 Client 开始看：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token function">Run</span><span class="token punctuation">(</span>strAddr<span class="token punctuation">,</span> strOper<span class="token punctuation">,</span> oRequest<span class="token punctuation">,</span> oResponse<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vecIPList<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

grpc<span class="token double-colon punctuation">::</span>Status <span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>strAddr<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>strOper<span class="token punctuation">,</span>
                 example<span class="token double-colon punctuation">::</span>CardRequest <span class="token operator">&amp;</span>oRequest<span class="token punctuation">,</span> example<span class="token double-colon punctuation">::</span>CardResponse <span class="token operator">&amp;</span>oResponse<span class="token punctuation">,</span>
                 std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">></span> <span class="token operator">*</span>poIPList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>strOper<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'I'</span><span class="token operator">:</span>
      oRequest<span class="token punctuation">.</span><span class="token function">set_entity_id</span><span class="token punctuation">(</span><span class="token function">GetEntityID</span><span class="token punctuation">(</span>oRequest<span class="token punctuation">.</span><span class="token function">card_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      oRequest<span class="token punctuation">.</span><span class="token function">mutable_card_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">set_last_modified_time</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      oStatus <span class="token operator">=</span> oClient<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>oRequest<span class="token punctuation">.</span><span class="token function">entity_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> example<span class="token double-colon punctuation">::</span>eInsertCard<span class="token punctuation">,</span> <span class="token operator">&amp;</span>oRequest<span class="token punctuation">,</span> <span class="token operator">&amp;</span>oResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>该 Client 会调用 gRPC 向 Server 发送请求，直接看 Server 端的处理函数 <a href="https://github.com/Tencent/paxosstore/blob/master/certain/example/ServiceImpl.cpp"><code>example/ServiceImpl.cpp</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">int</span> clsServiceImpl<span class="token double-colon punctuation">::</span><span class="token function">InsertCard</span><span class="token punctuation">(</span>grpc<span class="token double-colon punctuation">::</span>ServerContext <span class="token operator">&amp;</span>oContext<span class="token punctuation">,</span> <span class="token keyword">const</span> example<span class="token double-colon punctuation">::</span>CardRequest <span class="token operator">&amp;</span>oRequest<span class="token punctuation">,</span>
                               example<span class="token double-colon punctuation">::</span>CardResponse <span class="token operator">&amp;</span>oResponse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">BatchFunc</span><span class="token punctuation">(</span>example<span class="token double-colon punctuation">::</span>OperCode<span class="token double-colon punctuation">::</span>eInsertCard<span class="token punctuation">,</span> oRequest<span class="token punctuation">,</span> oResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> clsServiceImpl<span class="token double-colon punctuation">::</span><span class="token function">BatchFunc</span><span class="token punctuation">(</span><span class="token keyword">int</span> iOper<span class="token punctuation">,</span> <span class="token keyword">const</span> example<span class="token double-colon punctuation">::</span>CardRequest <span class="token operator">&amp;</span>oRequest<span class="token punctuation">,</span>
                              example<span class="token double-colon punctuation">::</span>CardResponse <span class="token operator">&amp;</span>oResponse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">uint64_t</span> iStartUS <span class="token operator">=</span> <span class="token class-name">Certain</span><span class="token double-colon punctuation">::</span><span class="token function">GetCurrTimeUS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 1. 将请求构造为 QueueItem，压入队列，压入 BatchMap</span>
  <span class="token keyword">uint64_t</span> iPushStartUS <span class="token operator">=</span> <span class="token class-name">Certain</span><span class="token double-colon punctuation">::</span><span class="token function">GetCurrTimeUS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  QueueItem_t <span class="token operator">*</span>poItem <span class="token operator">=</span> <span class="token keyword">new</span> QueueItem_t<span class="token punctuation">;</span>
  Certain<span class="token double-colon punctuation">::</span>clsAutoDelete<span class="token operator">&lt;</span>QueueItem_t<span class="token operator">></span> <span class="token function">oAutoDelete</span><span class="token punctuation">(</span>poItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  poItem<span class="token operator">-></span>iOper <span class="token operator">=</span> iOper<span class="token punctuation">;</span>
  poItem<span class="token operator">-></span>iEntityID <span class="token operator">=</span> oRequest<span class="token punctuation">.</span><span class="token function">entity_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  poItem<span class="token operator">-></span>poRequest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>oRequest<span class="token punctuation">;</span>
  poItem<span class="token operator">-></span>poResponse <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>oResponse<span class="token punctuation">;</span>
  poItem<span class="token operator">-></span>iRet <span class="token operator">=</span> BatchStatus<span class="token double-colon punctuation">::</span>WAITING<span class="token punctuation">;</span>

  <span class="token punctuation">{</span>
    Certain<span class="token double-colon punctuation">::</span>clsThreadLock <span class="token function">oLock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_poBatchMapMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_oBatchMap<span class="token punctuation">[</span>poItem<span class="token operator">-></span>iEntityID<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>poItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">uint64_t</span> iPushEndUS <span class="token operator">=</span> <span class="token class-name">Certain</span><span class="token double-colon punctuation">::</span><span class="token function">GetCurrTimeUS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 2. 上锁，同一个 EntityID 的请求都会在队列里</span>
  <span class="token keyword">uint64_t</span> iLockStartUS <span class="token operator">=</span> <span class="token class-name">Certain</span><span class="token double-colon punctuation">::</span><span class="token function">GetCurrTimeUS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Certain<span class="token double-colon punctuation">::</span>clsAutoEntityLock <span class="token function">oAuto</span><span class="token punctuation">(</span>poItem<span class="token operator">-></span>iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>poItem<span class="token operator">-></span>iRet <span class="token operator">!=</span> BatchStatus<span class="token double-colon punctuation">::</span>WAITING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> poItem<span class="token operator">-></span>iRet<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  clsDBImpl <span class="token operator">*</span>poDBEngine <span class="token operator">=</span>
      <span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>clsDBImpl <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>Certain<span class="token double-colon punctuation">::</span>clsCertainWrapper<span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetDBEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  dbtype<span class="token double-colon punctuation">::</span>DB <span class="token operator">*</span>poDB <span class="token operator">=</span> poDBEngine<span class="token operator">-></span><span class="token function">GetDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  clsTemporaryTable <span class="token function">oTable</span><span class="token punctuation">(</span>poDB<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iLockEndUS <span class="token operator">=</span> <span class="token class-name">Certain</span><span class="token double-colon punctuation">::</span><span class="token function">GetCurrTimeUS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 3. 将具有相同 EntityID 的请求弹出</span>
  <span class="token keyword">uint64_t</span> iPopStartUS <span class="token operator">=</span> <span class="token class-name">Certain</span><span class="token double-colon punctuation">::</span><span class="token function">GetCurrTimeUS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>queue<span class="token operator">&lt;</span>QueueItem_t <span class="token operator">*</span><span class="token operator">></span> oQueue<span class="token punctuation">;</span>
  <span class="token punctuation">{</span>
    Certain<span class="token double-colon punctuation">::</span>clsThreadLock <span class="token function">oLock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_poBatchMapMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> iter <span class="token operator">=</span> m_oBatchMap<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>poItem<span class="token operator">-></span>iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>iter <span class="token operator">!=</span> m_oBatchMap<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>iter<span class="token operator">-></span>second<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      oQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>iter<span class="token operator">-></span>second<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      iter<span class="token operator">-></span>second<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">uint64_t</span> iPopEndUS <span class="token operator">=</span> <span class="token class-name">Certain</span><span class="token double-colon punctuation">::</span><span class="token function">GetCurrTimeUS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 4. 该 EntityID 执行 EntityCatchUp，如果失败则统一返回</span>
  <span class="token keyword">uint64_t</span> iCatchUpStartUS <span class="token operator">=</span> <span class="token class-name">Certain</span><span class="token double-colon punctuation">::</span><span class="token function">GetCurrTimeUS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Certain<span class="token double-colon punctuation">::</span>clsCertainWrapper <span class="token operator">*</span>poCertain <span class="token operator">=</span> Certain<span class="token double-colon punctuation">::</span>clsCertainWrapper<span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iEntry <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> iMaxCommitedEntry <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> iRet <span class="token operator">=</span> poCertain<span class="token operator">-></span><span class="token function">EntityCatchUp</span><span class="token punctuation">(</span>poItem<span class="token operator">-></span>iEntityID<span class="token punctuation">,</span> iMaxCommitedEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">BatchReturn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oQueue<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> iRet<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">uint64_t</span> iCatchUpEndUS <span class="token operator">=</span> <span class="token class-name">Certain</span><span class="token double-colon punctuation">::</span><span class="token function">GetCurrTimeUS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 5. 遍历所有请求，执行 HandleSingleCommand</span>
  <span class="token keyword">uint64_t</span> iBatchHandleStartUS <span class="token operator">=</span> <span class="token class-name">Certain</span><span class="token double-colon punctuation">::</span><span class="token function">GetCurrTimeUS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">uint64_t</span><span class="token operator">></span> vecUUID<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iQueueSize <span class="token operator">=</span> oQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iRead <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> iWrite <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>iQueueSize <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    QueueItem_t <span class="token operator">*</span>poItem <span class="token operator">=</span> oQueue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    oQueue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">--</span>iQueueSize<span class="token punctuation">;</span>

    <span class="token function">assert</span><span class="token punctuation">(</span>poItem<span class="token operator">-></span>iRet <span class="token operator">==</span> BatchStatus<span class="token double-colon punctuation">::</span>WAITING<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HandleSingleCommand</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oTable<span class="token punctuation">,</span> poItem<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vecUUID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>poItem<span class="token operator">-></span>iOper <span class="token operator">==</span> example<span class="token double-colon punctuation">::</span>OperCode<span class="token double-colon punctuation">::</span>eSelectCard<span class="token punctuation">)</span>
      iRead<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      iWrite<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token comment">// Re-push items since they need to RunPaxos.</span>
    oQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>poItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">uint64_t</span> iBatchHandleEndUS <span class="token operator">=</span> <span class="token class-name">Certain</span><span class="token double-colon punctuation">::</span><span class="token function">GetCurrTimeUS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 6. 跑 Paxos 协议，批量返回</span>
  <span class="token keyword">uint64_t</span> iRunPaxosStartUS <span class="token operator">=</span> <span class="token class-name">Certain</span><span class="token double-colon punctuation">::</span><span class="token function">GetCurrTimeUS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  iEntry <span class="token operator">=</span> iMaxCommitedEntry <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  iRet <span class="token operator">=</span> poCertain<span class="token operator">-></span><span class="token function">RunPaxos</span><span class="token punctuation">(</span>poItem<span class="token operator">-></span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> example<span class="token double-colon punctuation">::</span>OperCode<span class="token double-colon punctuation">::</span>eBatchFunc<span class="token punctuation">,</span> vecUUID<span class="token punctuation">,</span>
                             oTable<span class="token punctuation">.</span><span class="token function">GetWriteBatchString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">BatchReturn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oQueue<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iRunPaxosEndUS <span class="token operator">=</span> <span class="token class-name">Certain</span><span class="token double-colon punctuation">::</span><span class="token function">GetCurrTimeUS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">uint64_t</span> iEndUS <span class="token operator">=</span> <span class="token class-name">Certain</span><span class="token double-colon punctuation">::</span><span class="token function">GetCurrTimeUS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 7. 提供成功则执行提交</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    poDBEngine<span class="token operator">-></span><span class="token function">Commit</span><span class="token punctuation">(</span>poItem<span class="token operator">-></span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> oTable<span class="token punctuation">.</span><span class="token function">GetWriteBatchString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span>
      <span class="token string">"iEntityID %lu iPushTime %lu iLockTime %lu iPopTime %lu "</span>
      <span class="token string">"iCatchUpTime %lu iBatchHandleTime %lu iRunPaxos %lu iTotalUS %lu "</span>
      <span class="token string">"iRead %lu iWrite %lu"</span><span class="token punctuation">,</span>
      poItem<span class="token operator">-></span>iEntityID<span class="token punctuation">,</span> iPushEndUS <span class="token operator">-</span> iPushStartUS<span class="token punctuation">,</span> iLockEndUS <span class="token operator">-</span> iLockStartUS<span class="token punctuation">,</span>
      iPopEndUS <span class="token operator">-</span> iPopStartUS<span class="token punctuation">,</span> iCatchUpEndUS <span class="token operator">-</span> iCatchUpStartUS<span class="token punctuation">,</span>
      iBatchHandleEndUS <span class="token operator">-</span> iBatchHandleStartUS<span class="token punctuation">,</span> iRunPaxosEndUS <span class="token operator">-</span> iRunPaxosStartUS<span class="token punctuation">,</span> iEndUS <span class="token operator">-</span> iStartUS<span class="token punctuation">,</span>
      iRead<span class="token punctuation">,</span> iWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>

  iRet <span class="token operator">=</span> poItem<span class="token operator">-></span>iRet<span class="token punctuation">;</span>
  <span class="token keyword">return</span> iRet<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>注意步骤 4 中的 <code>EntityCatchUp</code>，在跑 <code>Paxos</code> 协议前会先确定本地所有的 Entry 已经提交到 DB。注意这里并不保证也不需要保证 Entry 是全局最新的，因为如果不是，跑协议的过程中会失败、然后触发 CatchUp，之后的博文会分析该过程。</p>
<p>来看 <code>EntityCatchUp</code> 的实现，位于 <a href="https://github.com/Tencent/paxosstore/blob/master/certain/src/CertainWrapper.cpp#L64"><code>src/CertainWrapper.cpp</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">int</span> clsCertainWrapper<span class="token double-colon punctuation">::</span><span class="token function">EntityCatchUp</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> <span class="token operator">&amp;</span>iMaxCommitedEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token keyword">uint32_t</span> iMaxCommitNum <span class="token operator">=</span> <span class="token function">GetConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetMaxCommitNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">uint32_t</span> iCommitCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">uint64_t</span> iEntry <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>string strWriteBatch<span class="token punctuation">;</span>

  <span class="token keyword">uint32_t</span> iFlag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  iMaxCommitedEntry <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 从 Data DB 中读取 MaxCommitedEntry</span>
  <span class="token keyword">int</span> iRet <span class="token operator">=</span> m_poDBEngine<span class="token operator">-></span><span class="token function">GetEntityMeta</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iMaxCommitedEntry<span class="token punctuation">,</span> iFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> iRet <span class="token operator">!=</span> eRetCodeNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"iEntityID %lu GetEntityMeta ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> iRet<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 至多尝试 iMaxCommitNum 次 Commit</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>iCommitCnt <span class="token operator">&lt;</span> iMaxCommitNum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 检查 DB 状态</span>
    iRet <span class="token operator">=</span> <span class="token function">CheckDBStatus</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iMaxCommitedEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> eRetCodeOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> eRetCodeDBLagBehind<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"CheckDBStatus iEntityID %lu ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> iRet<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    iEntry <span class="token operator">=</span> iMaxCommitedEntry <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token class-name">OSS</span><span class="token double-colon punctuation">::</span><span class="token function">ReportGetAndCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 从 PLog 中获取 iMaxCommitedEntry 下一个的 Record</span>
    iRet <span class="token operator">=</span> <span class="token function">GetWriteBatch</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> strWriteBatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) GetWriteBatch ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> iRet<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">TIMERMS_START</span><span class="token punctuation">(</span>iCommitUseTimeMS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将该 Record 提交到 Data DB</span>
    iRet <span class="token operator">=</span> m_poDBEngine<span class="token operator">-></span><span class="token function">Commit</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> strWriteBatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIMERMS_STOP</span><span class="token punctuation">(</span>iCommitUseTimeMS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OSS</span><span class="token double-colon punctuation">::</span><span class="token function">ReportDBCommit</span><span class="token punctuation">(</span>iRet<span class="token punctuation">,</span> iCommitUseTimeMS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) Commit ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> iRet<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    iCommitCnt<span class="token operator">++</span><span class="token punctuation">;</span>
    iMaxCommitedEntry<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>iCommitCnt <span class="token operator">==</span> iMaxCommitNum <span class="token operator">&amp;&amp;</span> <span class="token function">CheckDBStatus</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iMaxCommitedEntry<span class="token punctuation">)</span> <span class="token operator">!=</span> eRetCodeOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"iEntityID %lu iCommitCnt == iMaxCommitNum %u"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iMaxCommitNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Certain<span class="token double-colon punctuation">::</span>eRetCodeDBCommitLimited<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> clsCertainWrapper<span class="token double-colon punctuation">::</span><span class="token function">CheckDBStatus</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iCommitedEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">uint64_t</span> iMaxContChosenEntry <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iMaxChosenEntry <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iLeaseTimeoutMS <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">bool</span> bTriggleRecovered <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token comment">// 从内存中读取 Entity 对应的 iMaxContChosenEntry 和 iMaxChosenEntry 信息</span>
  <span class="token keyword">int</span> iRet <span class="token operator">=</span> m_poEntityGroupMng<span class="token operator">-></span><span class="token function">GetMaxChosenEntry</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iMaxContChosenEntry<span class="token punctuation">,</span> iMaxChosenEntry<span class="token punctuation">,</span>
                                                   iLeaseTimeoutMS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> eRetCodeNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 内存中没有查询到该 EntityID 的信息，则通过 PLog 恢复</span>
    bTriggleRecovered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">// 构造一条 Recover Cmd</span>
    clsRecoverCmd <span class="token operator">*</span>poCmd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">clsRecoverCmd</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iCommitedEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    clsAutoDelete<span class="token operator">&lt;</span>clsRecoverCmd<span class="token operator">></span> <span class="token function">oAuto</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    poCmd<span class="token operator">-></span><span class="token function">SetTimestampUS</span><span class="token punctuation">(</span><span class="token function">GetCurrTimeUS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送一条 Recover Cmd 并等待结果</span>
    iRet <span class="token operator">=</span> <span class="token function">SyncWaitCmd</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"iEntityID %lu SyncWaitCmd ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> iRet<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 从 Recover Cmd 的结果中读取 iMaxContChosenEntry 和 iMaxChosenEntry</span>
    iMaxContChosenEntry <span class="token operator">=</span> poCmd<span class="token operator">-></span><span class="token function">GetMaxContChosenEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    iMaxChosenEntry <span class="token operator">=</span> poCmd<span class="token operator">-></span><span class="token function">GetMaxChosenEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"iEntityID %lu GetMaxChosenEntry iRet %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> iRet<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>iLeaseTimeoutMS <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 租约相关，以后再分析</span>
    <span class="token class-name">OSS</span><span class="token double-colon punctuation">::</span><span class="token function">ReportLeaseWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">poll</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> iLeaseTimeoutMS<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"iEntityID %lu wait iLeaseTimeoutMS %lu"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iLeaseTimeoutMS<span class="token punctuation">)</span><span class="token punctuation">;</span>

    iRet <span class="token operator">=</span> m_poEntityGroupMng<span class="token operator">-></span><span class="token function">GetMaxChosenEntry</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iMaxContChosenEntry<span class="token punctuation">,</span> iMaxChosenEntry<span class="token punctuation">,</span>
                                                 iLeaseTimeoutMS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"iEntityID %lu iLeaseTimeoutMS %lu ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iLeaseTimeoutMS<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> iRet<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// iMaxContChosenEntry may update posterior to iCommitedEntry.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iMaxContChosenEntry <span class="token operator">&lt;</span> iCommitedEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    iMaxContChosenEntry <span class="token operator">=</span> iCommitedEntry<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>iCommitedEntry <span class="token operator">+</span> m_poConf<span class="token operator">-></span><span class="token function">GetMaxCatchUpNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> iMaxContChosenEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// All entrys of the entity are eliminated, help trigger db catchup.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iMaxContChosenEntry <span class="token operator">==</span> iMaxChosenEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"notify_db iEntityID %lu entrys: %lu %lu"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iCommitedEntry<span class="token punctuation">,</span>
                      iMaxContChosenEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 通知 DBWorker 异步做恢复</span>
      clsDBWorker<span class="token double-colon punctuation">::</span><span class="token function">NotifyDBWorker</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"iEntityID %lu entrys: %lu %lu %lu"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iCommitedEntry<span class="token punctuation">,</span>
                    iMaxContChosenEntry<span class="token punctuation">,</span> iMaxChosenEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bTriggleRecovered<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 触发 Recover，同样也是发送一条 Recover Cmd</span>
      <span class="token function">TriggeRecover</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iCommitedEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> eRetCodeCatchUp<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 本地的 Chosen 小于全局的 Chosen，先追赶上全局的进度</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iMaxContChosenEntry <span class="token operator">&lt;</span> iMaxChosenEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"iEntityID %lu entrys: %lu %lu %lu"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iCommitedEntry<span class="token punctuation">,</span>
                    iMaxContChosenEntry<span class="token punctuation">,</span> iMaxChosenEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bTriggleRecovered<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 触发 Recover</span>
      <span class="token function">TriggeRecover</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iCommitedEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> eRetCodeCatchUp<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>iCommitedEntry <span class="token operator">>=</span> iMaxChosenEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 只有 Committed 和 Chosen 一致，DB 才是本地最新的</span>
    <span class="token keyword">return</span> eRetCodeOK<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 否则 Committed 需要追赶</span>
    <span class="token keyword">return</span> eRetCodeDBLagBehind<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> clsCertainWrapper<span class="token double-colon punctuation">::</span><span class="token function">GetWriteBatch</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iEntry<span class="token punctuation">,</span> string <span class="token operator">&amp;</span>strWriteBatch<span class="token punctuation">,</span>
                                     <span class="token keyword">uint64_t</span> <span class="token operator">*</span>piValueID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  EntryRecord_t tRecord<span class="token punctuation">;</span>
  <span class="token comment">// 从 PLog 中读取对应的 Record</span>
  <span class="token keyword">int</span> iRet <span class="token operator">=</span> m_poPLogEngine<span class="token operator">-></span><span class="token function">GetRecord</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> tRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> eRetCodeNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"BUG probably E(%lu, %lu) ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> iRet<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) not found"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> eRetCodeNotFound<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 要确定已经 Chosen 了</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tRecord<span class="token punctuation">.</span>bChosen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"unchosen: %s"</span><span class="token punctuation">,</span> <span class="token function">EntryRecordToString</span><span class="token punctuation">(</span>tRecord<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> eRetCodeNotFound<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>piValueID <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>piValueID <span class="token operator">=</span> tRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>iValueID<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 拿到已经 Chosen 的 WriteBatch</span>
  strWriteBatch <span class="token operator">=</span> tRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>strValue<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这里有几个进度：</p>
<ol>
<li>已经提交到 Data DB 的进度：<code>CommittedEntry</code></li>
<li>获取到的最大连续 Chosen 进度：<code>MaxContChosenEntry</code></li>
<li>已知的全局最大 Chosen 进度：<code>MaxChosenEntry</code></li>
</ol>
<p>只有 <code>CommittedEntry</code> &lt; <code>MaxContChosenEntry</code> == <code>MaxChosenEntry</code> 时，DB 才可以直接通过读取 PLog 的方式来追赶到本地最新的进度，其他情况均需要进行先进行 Recover。来继续看看这里的 Recover 怎么实现的。</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">int</span> clsCertainWrapper<span class="token double-colon punctuation">::</span><span class="token function">SyncWaitCmd</span><span class="token punctuation">(</span>clsClientCmd <span class="token operator">*</span>poCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">uint64_t</span> iEntityID <span class="token operator">=</span> poCmd<span class="token operator">-></span><span class="token function">GetEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iEntry <span class="token operator">=</span> poCmd<span class="token operator">-></span><span class="token function">GetEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">uint32_t</span> iPipeIdx<span class="token punctuation">;</span>
  <span class="token comment">// 获取一个空的通知管道</span>
  <span class="token keyword">int</span> iRet <span class="token operator">=</span> m_poPipeMng<span class="token operator">-></span><span class="token function">GetIdlePipeIdx</span><span class="token punctuation">(</span>iPipeIdx<span class="token punctuation">,</span> iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) GetIdlePipeIdx ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> iRet<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  poCmd<span class="token operator">-></span><span class="token function">SetPipeIdx</span><span class="token punctuation">(</span>iPipeIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 分配 IOWorker</span>
  <span class="token keyword">uint32_t</span> iIOWorkerID <span class="token operator">=</span> <span class="token function">Hash</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">)</span> <span class="token operator">%</span> m_poConf<span class="token operator">-></span><span class="token function">GetIOWorkerNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  poCmd<span class="token operator">-></span><span class="token function">SetIOTracker</span><span class="token punctuation">(</span><span class="token function">IOTracker_t</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> iIOWorkerID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">uint32_t</span> iEntityWorkerID <span class="token operator">=</span> <span class="token function">Hash</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">)</span> <span class="token operator">%</span> m_poConf<span class="token operator">-></span><span class="token function">GetEntityWorkerNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  clsIOReqQueue <span class="token operator">*</span>poIOReqQueue <span class="token operator">=</span> m_poQueueMng<span class="token operator">-></span><span class="token function">GetIOReqQueue</span><span class="token punctuation">(</span>iEntityWorkerID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 将 Cmd 推入对应的 IO 队列中</span>
  iRet <span class="token operator">=</span> poIOReqQueue<span class="token operator">-></span><span class="token function">PushByMultiThread</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    m_poPipeMng<span class="token operator">-></span><span class="token function">PutIdlePipeIdx</span><span class="token punctuation">(</span>iPipeIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"PushByMultiThread ret %d"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> eRetCodeQueueFailed<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  uintptr_t iCheck <span class="token operator">=</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>poCmd<span class="token punctuation">;</span>

  <span class="token function">CertainLogDebug</span><span class="token punctuation">(</span><span class="token string">"iPipeIdx %u iPtr %lu E(%lu, %lu) iUUID %lu"</span><span class="token punctuation">,</span> iPipeIdx<span class="token punctuation">,</span> iCheck<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                  poCmd<span class="token operator">-></span><span class="token function">GetUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">bool</span> bOneMoreTry <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">// 等待管道通知（Cmd 完成后管道另一段有写入，这边读取就完成了等待）</span>
  iRet <span class="token operator">=</span> m_poPipeMng<span class="token operator">-></span><span class="token function">SyncWaitByPipeIdx</span><span class="token punctuation">(</span>iPipeIdx<span class="token punctuation">,</span> iCheck<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> eRetCodePipePtrErr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bOneMoreTry <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// Try one more time, prev timeout ptr may come first.</span>
    <span class="token comment">// There's probably some BUG in certain.</span>
    iRet <span class="token operator">=</span> m_poPipeMng<span class="token operator">-></span><span class="token function">SyncWaitByPipeIdx</span><span class="token punctuation">(</span>iPipeIdx<span class="token punctuation">,</span> iCheck<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"BUG probably ibOneMoreTry %u ret %d cmd: %s"</span><span class="token punctuation">,</span> bOneMoreTry<span class="token punctuation">,</span> iRet<span class="token punctuation">,</span>
                    poCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_poPipeMng<span class="token operator">-></span><span class="token function">PutIdlePipeIdx</span><span class="token punctuation">(</span>iPipeIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> eRetCodePipeWaitFailed<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 回收通知管道</span>
  m_poPipeMng<span class="token operator">-></span><span class="token function">PutIdlePipeIdx</span><span class="token punctuation">(</span>iPipeIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> poCmd<span class="token operator">-></span><span class="token function">GetResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>塞入 IO 队列中的 Recover Cmd 会在 <code>EntityWorker</code> 中被处理掉，这里的调用关系非常复杂：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">void</span> clsEntityWorker<span class="token double-colon punctuation">::</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 2.Do with IO request.</span>
    poCmd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    iRet <span class="token operator">=</span> m_poIOReqQueue<span class="token operator">-></span><span class="token function">TakeByOneThread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">Assert</span><span class="token punctuation">(</span>poCmd <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      bHasWork <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

      iRet <span class="token operator">=</span> <span class="token function">DoWithIOReq</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"DoWithIOReq ret %d cmd %s"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">,</span> poCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> eRetCodePtrReuse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">delete</span> poCmd<span class="token punctuation">,</span> poCmd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> clsEntityWorker<span class="token double-colon punctuation">::</span><span class="token function">DoWithIOReq</span><span class="token punctuation">(</span>clsCmdBase <span class="token operator">*</span>poCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>clsCertainWrapper<span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetEnableLearnOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>poCmd<span class="token operator">-></span><span class="token function">GetCmdID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> kPaxosCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      clsClientCmd <span class="token operator">*</span>poClientCmd <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>clsClientCmd <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">AssertNotEqual</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>poClientCmd<span class="token punctuation">,</span> eRetCodeRejectAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> eRetCodeRejectAll<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">uint64_t</span> iEntityID <span class="token operator">=</span> poCmd<span class="token operator">-></span><span class="token function">GetEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">AssertEqual</span><span class="token punctuation">(</span><span class="token function">Hash</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">)</span> <span class="token operator">%</span> m_poConf<span class="token operator">-></span><span class="token function">GetEntityWorkerNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m_iWorkerID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"cmd: %s"</span><span class="token punctuation">,</span> poCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  clsPaxosCmd <span class="token operator">*</span>poPaxosCmd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  clsClientCmd <span class="token operator">*</span>poClientCmd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  clsRecoverCmd <span class="token operator">*</span>poRecoverCmd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>poCmd<span class="token operator">-></span><span class="token function">GetCmdID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> kWriteBatchCmd<span class="token operator">:</span>
      poClientCmd <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>clsClientCmd <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">DoWithClientCmd</span><span class="token punctuation">(</span>poClientCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> kRecoverCmd<span class="token operator">:</span>
      poRecoverCmd <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>clsRecoverCmd <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">DoWithRecoverCmd</span><span class="token punctuation">(</span>poRecoverCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> kPaxosCmd<span class="token operator">:</span>
      poPaxosCmd <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>clsPaxosCmd <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">DoWithPaxosCmd</span><span class="token punctuation">(</span>poPaxosCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"cmd: %s"</span><span class="token punctuation">,</span> poCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">Assert</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> clsEntityWorker<span class="token double-colon punctuation">::</span><span class="token function">DoWithRecoverCmd</span><span class="token punctuation">(</span>clsRecoverCmd <span class="token operator">*</span>poCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">uint64_t</span> iEntityID <span class="token operator">=</span> poCmd<span class="token operator">-></span><span class="token function">GetEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iMaxCommitedEntry <span class="token operator">=</span> poCmd<span class="token operator">-></span><span class="token function">GetMaxCommitedEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"cmd: %s"</span><span class="token punctuation">,</span> poCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 这里 Entry = 0 有特殊作用，下文会解释</span>
  EntryInfo_t <span class="token operator">*</span>ptInfo <span class="token operator">=</span> m_poEntryMng<span class="token operator">-></span><span class="token function">FindEntryInfo</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">AssertEqual</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  EntityInfo_t <span class="token operator">*</span>ptEntityInfo <span class="token operator">=</span> m_poEntityMng<span class="token operator">-></span><span class="token function">FindEntityInfo</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 内存中有对应的 EntityInfo</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"Failover E(%lu, %lu) Entrys: %lu %lu %lu ref %d %u"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span>
                    iMaxCommitedEntry<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token punctuation">,</span>
                    ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry<span class="token punctuation">,</span>
                    ptEntityInfo<span class="token operator">-></span>iRefCount<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>bRangeLoading<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>poCmd<span class="token operator">-></span><span class="token function">IsEvictEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>

    <span class="token function">Assert</span><span class="token punctuation">(</span>m_poEntityMng<span class="token operator">-></span><span class="token function">Refresh</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>poCmd<span class="token operator">-></span><span class="token function">IsCheckGetAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>

    <span class="token comment">// 检查是否进行 CatchUp</span>
    <span class="token function">CheckForCatchUp</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> INVALID_ACCEPTOR_ID<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CheckIfNeedNotifyDB</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    poCmd<span class="token operator">-></span><span class="token function">SetMaxChosenEntry</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    poCmd<span class="token operator">-></span><span class="token function">SetMaxContChosenEntry</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">AssertEqual</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry <span class="token operator">&lt;</span> ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 本地晚于全局进度，返回 CatchUp 状态码</span>
      <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">,</span> eRetCodeCatchUp<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry <span class="token operator">==</span> INVALID_ENTRY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// PLog 还没有加载完，如果正在加载，就给 Cmd 加上超时</span>
      <span class="token function">CheckIfWaitRecoverCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 其他情况则完成 OK 状态</span>
    <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">,</span> eRetCodeOK<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 内存中没有对应的 EntityInfo</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>poCmd<span class="token operator">-></span><span class="token function">IsEvictEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_poEntityMng<span class="token operator">-></span><span class="token function">CheckAndEliminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>

    <span class="token comment">// 创建一个</span>
    ptEntityInfo <span class="token operator">=</span> m_poEntityMng<span class="token operator">-></span><span class="token function">CreateEntityInfo</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"CreateEntityInfo failed cmd: %s"</span><span class="token punctuation">,</span> poCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">,</span> eRetCodeRouteErr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 检查是否进行 CatchUp</span>
    <span class="token function">CheckForCatchUp</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> INVALID_ACCEPTOR_ID<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">CheckIfWaitRecoverCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> clsEntityWorker<span class="token double-colon punctuation">::</span><span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>clsClientCmd <span class="token operator">*</span>poCmd<span class="token punctuation">,</span> <span class="token keyword">int</span> iResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>poCmd <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 设定 Result</span>
  poCmd<span class="token operator">-></span><span class="token function">SetResult</span><span class="token punctuation">(</span>iResult<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>iResult <span class="token operator">!=</span> eRetCodeOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"InvalidClientCmd cmd %u uuid %lu result: %d"</span><span class="token punctuation">,</span> poCmd<span class="token operator">-></span><span class="token function">GetCmdID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    poCmd<span class="token operator">-></span><span class="token function">GetUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 使用 IO Worker 通知 Cmd 完成</span>
  <span class="token keyword">int</span> iRet <span class="token operator">=</span> m_poIOWorkerRouter<span class="token operator">-></span><span class="token function">Go</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"BUG probably Go ret %d poCmd: %s"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">,</span> poCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// sum of list size &lt;= MAX_ASYNC_PIPE_NUM</span>
    m_poWaitingGoList<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 如果不是 bRangeLoading 状态，直接报错 eRetCodeQueueFull</span>
<span class="token comment">// 否则新建 Entry(0)，并加到 Timeout 队列里，超时的处理之后会提到</span>
<span class="token keyword">void</span> clsEntityWorker<span class="token double-colon punctuation">::</span><span class="token function">CheckIfWaitRecoverCmd</span><span class="token punctuation">(</span>EntityInfo_t <span class="token operator">*</span>ptEntityInfo<span class="token punctuation">,</span> clsRecoverCmd <span class="token operator">*</span>poCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// If the cmd is most likely timeout eventually, do fast failover.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ptEntityInfo<span class="token operator">-></span>bRangeLoading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// It should range load from plog, but failed as queue full.</span>
    <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">,</span> eRetCodeQueueFull<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//</span>
    ptEntityInfo<span class="token operator">-></span>poClientCmd <span class="token operator">=</span> poCmd<span class="token punctuation">;</span>
    <span class="token comment">// 再次出现 Entry(0)，用来对应 RecoverCmd</span>
    EntryInfo_t <span class="token operator">*</span>ptInfo <span class="token operator">=</span> m_poEntryMng<span class="token operator">-></span><span class="token function">CreateEntryInfo</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_poEntryMng<span class="token operator">-></span><span class="token function">AddTimeout</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> m_poConf<span class="token operator">-></span><span class="token function">GetRecoverTimeoutMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// NotifyedEntry &lt; MaxContChosenEntry，发通知给 DBWorker 做 CatchUp</span>
<span class="token keyword">void</span> clsEntityWorker<span class="token double-colon punctuation">::</span><span class="token function">CheckIfNeedNotifyDB</span><span class="token punctuation">(</span>EntityInfo_t <span class="token operator">*</span>ptEntityInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iNotifyedEntry <span class="token operator">&lt;</span> ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> iRet <span class="token operator">=</span> clsDBWorker<span class="token double-colon punctuation">::</span><span class="token function">NotifyDBWorker</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"NotifyDBWorker iEntityID %lu ret %d"</span><span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iEntityID<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      ptEntityInfo<span class="token operator">-></span>iNotifyedEntry <span class="token operator">=</span> ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>DoWithRecoverCmd</code> 里最核心的调用就是 <code>CheckForCatchUp</code> 了，用以检查并实施 CatchUp。该函数在 <code>EntityWorker</code> 中频繁出现，涉及的逻辑非常复杂，下一节详述。</p>
<h3 id="2.-checkforcatchup" tabindex="-1"><a href="#2.-checkforcatchup">2. CheckForCatchUp</a></h3>
<p><code>CheckForCatchUp</code> 会有两种行为，一种是 <code>MaxPLogEntry</code> == <code>INVALID_ENTRY</code>，即还没有从 PLog 中加载记录，则调用 <code>RangeLoadFromPLog</code> 加载 PLog；另一种是 <code>MaxContChosenEntry</code> &lt; <code>MaxChosenEntry</code>，本地的进度晚于全局的进度，则调用 <code>LimitedCatchUp</code> 做限制性恢复。</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// 创建 CatchUp 的 Entry，调用 LimitedCatchUp</span>
<span class="token comment">// CheckForCatchUp may elimate current EntryInfo_t.</span>
<span class="token comment">// So it must be called in the end of use of EntryInfo_t.</span>
<span class="token keyword">void</span> clsEntityWorker<span class="token double-colon punctuation">::</span><span class="token function">CheckForCatchUp</span><span class="token punctuation">(</span>EntityInfo_t <span class="token operator">*</span>ptEntityInfo<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> iDestAcceptorID<span class="token punctuation">,</span>
                                      <span class="token keyword">uint64_t</span> iDestMaxChosenEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">uint64_t</span> iEntityID <span class="token operator">=</span> ptEntityInfo<span class="token operator">-></span>iEntityID<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry <span class="token operator">&lt;</span> iDestMaxChosenEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"iMaxChosenEntry %lu iDestMaxChosenEntry %lu"</span><span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">,</span>
                   iDestMaxChosenEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry <span class="token operator">=</span> iDestMaxChosenEntry<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 预先创建好 [MaxPLogEntry + 1, MaxChosenEntry] 的 Entry</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry <span class="token operator">!=</span> INVALID_ENTRY <span class="token operator">&amp;&amp;</span>
      ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry <span class="token operator">&lt;</span> ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">uint32_t</span> iPreOpenCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> m_poConf<span class="token operator">-></span><span class="token function">GetMaxCatchUpNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">uint64_t</span> iEntry <span class="token operator">=</span> ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry <span class="token operator">+</span> i<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>iEntry <span class="token operator">></span> ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CheckIfEntryNumLimited</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      EntryInfo_t <span class="token operator">*</span>ptInfo <span class="token operator">=</span> m_poEntryMng<span class="token operator">-></span><span class="token function">FindEntryInfo</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ptInfo <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ptInfo <span class="token operator">=</span> m_poEntryMng<span class="token operator">-></span><span class="token function">CreateEntryInfo</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        iPreOpenCnt<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iPreOpenCnt <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) iPreOpenCnt %u"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">,</span>
                      iPreOpenCnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 正在 RangeLoad，则返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>bRangeLoading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"iEntityID %lu entrys: %lu %lu %lu"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span>
                   ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iCatchUpEntry<span class="token punctuation">,</span>
                   ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 正在 GetAll，则返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>bGetAllPending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"EntityID %lu GetAllPending, not need catch up"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// RangeLoadFromPLog --> iMaxPLogEntry == INVALID_ENTRY</span>
  <span class="token comment">// LimitedCatchUp --> iMaxContChosenEntry &lt; iMaxChosenEntry</span>
  <span class="token keyword">int</span> iLoopCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> iCatchUpCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry <span class="token operator">&lt;</span> ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> iRet <span class="token operator">=</span> <span class="token function">LimitedCatchUp</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> iDestAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"LimitedCatchUp ret %d"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    iLoopCnt<span class="token operator">++</span><span class="token punctuation">;</span>
    iCatchUpCnt <span class="token operator">+=</span> iRet<span class="token punctuation">;</span>

    <span class="token comment">// LimitedCatchUp 可能触发 RangeLoad，此时需要等待异步恢复完成</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>bRangeLoading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// LimitedCatchUp 的循环中 break 退出的，这里也继续 break</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry <span class="token operator">&lt;</span> ptEntityInfo<span class="token operator">-></span>iCatchUpEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 一个都没有恢复，退出</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// One remain group and one newly extend group is processed at most.</span>
  <span class="token comment">// But it is possible when db lags badly, and entry increases quickly.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iLoopCnt <span class="token operator">>=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"Check if db lags badly Cnt(%d, %d) E(%lu, %lu)"</span><span class="token punctuation">,</span> iLoopCnt<span class="token punctuation">,</span> iCatchUpCnt<span class="token punctuation">,</span>
                    iEntityID<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 处于未加载 PLog 的状态，则调用 RangeLoadFromPLog 加载恢复数据</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry <span class="token operator">==</span> INVALID_ENTRY <span class="token operator">&amp;&amp;</span>
      ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry <span class="token operator">==</span> ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span>ptEntityInfo<span class="token operator">-></span>bRangeLoading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RangeLoadFromPLog</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>RangeLoadFromPLog</code> 在其他地方也有调用，将在下一小节分析；而 <code>LimitedCatchUp</code> 仅在此处有调用：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// 设定 CatchUp 的目标，遍历，将已经 Chosen 的记录 PushCmdToDBWorker，实现 CatchUp</span>
<span class="token comment">// 当找不到对应的 EntryInfo 时，会尝试 RangeLoadFromPLog / LoadFromPLogWorker恢复并退出</span>
<span class="token keyword">int</span> clsEntityWorker<span class="token double-colon punctuation">::</span><span class="token function">LimitedCatchUp</span><span class="token punctuation">(</span>EntityInfo_t <span class="token operator">*</span>ptEntityInfo<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> iDestAcceptorID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// MaxContChosenEntry &lt;= CatchUpEntry &lt;= MaxChosenEntry</span>
  <span class="token function">AssertNotMore</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iCatchUpEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">AssertNotMore</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iCatchUpEntry<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Used to make LimitedCatchUp amortized complexity O(1).</span>
  <span class="token keyword">bool</span> bExtend <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">uint64_t</span> iEntityID <span class="token operator">=</span> ptEntityInfo<span class="token operator">-></span>iEntityID<span class="token punctuation">;</span>

  <span class="token comment">// 设定 MaxCatchUpEntry 目标</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry <span class="token operator">==</span> ptEntityInfo<span class="token operator">-></span>iCatchUpEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">uint64_t</span> iOldCatchUpEntry <span class="token operator">=</span> ptEntityInfo<span class="token operator">-></span>iCatchUpEntry<span class="token punctuation">;</span>
    <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"extend iEntityID %lu entrys: %lu %lu %lu %lu"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span>
                   ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iCatchUpEntry<span class="token punctuation">,</span>
                   ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 最多 CatchUp MaxCatchUpNum 条记录</span>
    ptEntityInfo<span class="token operator">-></span>iCatchUpEntry <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iCatchUpEntry <span class="token operator">+</span> m_poConf<span class="token operator">-></span><span class="token function">GetMaxCatchUpNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                      <span class="token keyword">uint64_t</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bExtend <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token class-name">OSS</span><span class="token double-colon punctuation">::</span><span class="token function">ReportBatchCatchUp</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iCatchUpEntry <span class="token operator">-</span> iOldCatchUpEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>iDestAcceptorID <span class="token operator">!=</span> INVALID_ACCEPTOR_ID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ptEntityInfo<span class="token operator">-></span>iActiveAcceptorID <span class="token operator">=</span> iDestAcceptorID<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">int</span> iReadyCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> iCatchUpCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntry <span class="token operator">=</span> ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
       iEntry <span class="token operator">&lt;=</span> ptEntityInfo<span class="token operator">-></span>iCatchUpEntry<span class="token punctuation">;</span> <span class="token operator">++</span>iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">AssertEqual</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>bRangeLoading<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    EntryInfo_t <span class="token operator">*</span>ptInfo <span class="token operator">=</span> m_poEntryMng<span class="token operator">-></span><span class="token function">FindEntryInfo</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptInfo <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 内存中找不到 EntryInfo</span>
      <span class="token comment">// 刚刚拓展了 CatchUp 范围，则尝试 RangeLoad 并退出</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>bExtend<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">RangeLoadFromPLog</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CheckIfEntryNumLimited</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) catchup limited by entry"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 内存中找不到，也可能是由于 LRU 缓存的自动删除</span>
      <span class="token comment">// 调用 LoadFromPLogWorker 恢复单个 entry 的记录</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry <span class="token operator">==</span> INVALID_ENTRY <span class="token operator">||</span> iEntry <span class="token operator">&lt;=</span> ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ptInfo <span class="token operator">=</span> m_poEntryMng<span class="token operator">-></span><span class="token function">CreateEntryInfo</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">LoadFromPLogWorker</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          m_poEntryMng<span class="token operator">-></span><span class="token function">DestroyEntryInfo</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        ptInfo <span class="token operator">=</span> m_poEntryMng<span class="token operator">-></span><span class="token function">CreateEntryInfo</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"Check it E(%lu, %lu)"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 确定已经 Chosen 的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ptInfo<span class="token operator">-></span>bUncertain <span class="token operator">&amp;&amp;</span> ptInfo<span class="token operator">-></span>poMachine<span class="token operator">-></span><span class="token function">GetEntryState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> kEntryStateChosen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 恰好是接下来需要提交的那一个</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 推入 DB 处理队列</span>
        <span class="token function">PushCmdToDBWorker</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token comment">// 成功地 CatchUp 一个</span>
        iCatchUpCnt<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 继续处理，这里很重要，和下面的 break 一起来看</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 还没有 Chosen 的，并且没有加入超时列表的，说明它没有在等待异步操作结果</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ptInfo<span class="token operator">-></span>bUncertain <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>m_poEntryMng<span class="token operator">-></span><span class="token function">WaitForTimeout</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 激活该 EntryInfo</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ActivateEntry</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      iReadyCnt<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 流程走到这里，并且不是刚刚拓展过范围，则直接退出</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bExtend<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// break 退出的，MaxContChosenEntry &lt; CatchUpEntry</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>iCatchUpCnt <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">||</span> iReadyCnt <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span>
        <span class="token string">"iEntityID %lu Entrys: %lu &lt;= %lu &lt;= %lu "</span>
        <span class="token string">"iCatchUpCnt %d iReadyCnt %d"</span><span class="token punctuation">,</span>
        ptEntityInfo<span class="token operator">-></span>iEntityID<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iCatchUpEntry<span class="token punctuation">,</span>
        ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">,</span> iCatchUpCnt<span class="token punctuation">,</span> iReadyCnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> iCatchUpCnt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="3.-rangeloadfromplog" tabindex="-1"><a href="#3.-rangeloadfromplog">3. RangeLoadFromPLog</a></h3>
<p>在 <code>CheckForCatchUp</code> 和 <code>DoWithPaxosCmd</code> 中会调用 <code>RangeLoadFromPLog</code>，用来批量的恢复 PLog 中的 Record 记录到内存中。通过构造一条 <code>RecoverCmd</code> 启动该流程：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">int</span> clsEntityWorker<span class="token double-colon punctuation">::</span><span class="token function">RangeLoadFromPLog</span><span class="token punctuation">(</span>EntityInfo_t <span class="token operator">*</span>ptEntityInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CheckIfEntryNumLimited</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iEntityID<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"iEntityID %lu stop loading by entry limit"</span><span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry <span class="token operator">&lt;</span> ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_poEntryMng<span class="token operator">-></span><span class="token function">CheckIfCatchUpLimited</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"iEntityID %lu stop loading by catchup limit"</span><span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 标记 RangeLoading</span>
  <span class="token function">AssertEqual</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>bRangeLoading<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ptEntityInfo<span class="token operator">-></span>bRangeLoading <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token comment">// 构造一条 Recover Cmd</span>
  clsRecoverCmd <span class="token operator">*</span>poCmd <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token function">clsRecoverCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iEntityID<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 标记 Entity 是否已经加载过 / 当前已知的 MaxPLogEntry / 加载记录的最大长度</span>
  poCmd<span class="token operator">-></span><span class="token function">SetRangeLoaded</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>bRangeLoaded<span class="token punctuation">)</span><span class="token punctuation">;</span>
  poCmd<span class="token operator">-></span><span class="token function">SetMaxPLogEntry</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">)</span>ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  poCmd<span class="token operator">-></span><span class="token function">SetMaxNum</span><span class="token punctuation">(</span>m_poConf<span class="token operator">-></span><span class="token function">GetMaxCatchUpNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"cmd: %s"</span><span class="token punctuation">,</span> poCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 塞入 PLog Req 队列</span>
  <span class="token keyword">int</span> iRet <span class="token operator">=</span> clsPLogWorker<span class="token double-colon punctuation">::</span><span class="token function">EnterPLogReqQueue</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ptEntityInfo<span class="token operator">-></span>bRangeLoading <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> poCmd<span class="token punctuation">,</span> poCmd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"iEntityID %lu EnterPLogReqQueue ret %d"</span><span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iEntityID<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>PLogWorker</code> 拿到 <code>RecoverCmd</code> 后，调用 <code>FillRecoverCmd</code>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// 填充 RecoverCmd，这个函数名 emmm</span>
<span class="token comment">// 首先从 DB Engine 中读取 MaxCommittedEntry</span>
<span class="token comment">// 如果 Entity 还没有 RangeLoaded，就从 PLogDB 中获取 Entity 的 MaxPLogEntry，直接返回</span>
<span class="token comment">// 否则从 PLogDB 中加载从 MaxCommitedEntry 到 MaxLoadingEntry 的 Entity Record 信息</span>
<span class="token keyword">int</span> clsPLogWorker<span class="token double-colon punctuation">::</span><span class="token function">FillRecoverCmd</span><span class="token punctuation">(</span>clsRecoverCmd <span class="token operator">*</span>poRecoverCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">CertainLogDebug</span><span class="token punctuation">(</span><span class="token string">"cmd: %s"</span><span class="token punctuation">,</span> poRecoverCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">uint64_t</span> iEntityID <span class="token operator">=</span> poRecoverCmd<span class="token operator">-></span><span class="token function">GetEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 默认是 0</span>
  <span class="token keyword">uint64_t</span> iMaxCommitedEntry <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">TIMERUS_START</span><span class="token punctuation">(</span>iGetEntityMetaUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> iFlag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 在 DataDB 中获取 MaxCommitedEntry</span>
  <span class="token keyword">int</span> iRet <span class="token operator">=</span> m_poDBEngine<span class="token operator">-></span><span class="token function">GetEntityMeta</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iMaxCommitedEntry<span class="token punctuation">,</span> iFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">TIMERUS_STOP</span><span class="token punctuation">(</span>iGetEntityMetaUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  s_poGetEntityMetaTimeStat<span class="token operator">-></span><span class="token function">Update</span><span class="token punctuation">(</span>iGetEntityMetaUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> iRet <span class="token operator">!=</span> eRetCodeNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"GetEntityMeta iFlag %u cmd: %s ret %d"</span><span class="token punctuation">,</span> iFlag<span class="token punctuation">,</span>
                    poRecoverCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

	<span class="token comment">// 这里的 kDBFlagCheckGetAll 代码里没有任何地方有设定，所以忽略</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iFlag <span class="token operator">==</span> kDBFlagCheckGetAll<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>

  <span class="token keyword">typedef</span> vector<span class="token operator">&lt;</span>pair<span class="token operator">&lt;</span><span class="token keyword">uint64_t</span><span class="token punctuation">,</span> EntryRecord_t<span class="token operator">></span> <span class="token operator">></span> EntryRecordList_t<span class="token punctuation">;</span>
  EntryRecordList_t tEntryRecordList<span class="token punctuation">;</span>

  <span class="token comment">// 如果启用 MaxPLogEntry（默认启用），并且该 Entity 还没有做过 RangeLoad</span>
  <span class="token comment">// 那么仅从 PLogDB 中读取 MaxPLogEntry，而后标记 HasMore 并直接返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_poConf<span class="token operator">-></span><span class="token function">GetEnableMaxPLogEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>poRecoverCmd<span class="token operator">-></span><span class="token function">IsRangeLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">AssertEqual</span><span class="token punctuation">(</span>poRecoverCmd<span class="token operator">-></span><span class="token function">GetMaxPLogEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> INVALID_ENTRY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    PLogEntityMeta_t tMeta <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">TIMERUS_START</span><span class="token punctuation">(</span>iGetPLogMetaUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 从 PLogDB 中获取 Entity 的 MaxPLogEntry</span>
    iRet <span class="token operator">=</span> m_poPLogEngine<span class="token operator">-></span><span class="token function">GetPLogEntityMeta</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> tMeta<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIMERUS_STOP</span><span class="token punctuation">(</span>iGetPLogMetaUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OSS</span><span class="token double-colon punctuation">::</span><span class="token function">ReportPLogGetMetaKeyTimeMS</span><span class="token punctuation">(</span>iRet<span class="token punctuation">,</span> iGetPLogMetaUseTimeUS <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> iRet <span class="token operator">!=</span> Certain<span class="token double-colon punctuation">::</span>eRetCodeNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"iEntityID %lu GetPLogEntityMeta ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 要么是从 DB 中读到的，要么是 tMeta 的默认值 0</span>
      <span class="token keyword">uint64_t</span> iMaxPLogEntry <span class="token operator">=</span> tMeta<span class="token punctuation">.</span>iMaxPLogEntry<span class="token punctuation">;</span>

      <span class="token comment">// GetAll 逻辑影响，暂时忽略</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>iMaxPLogEntry <span class="token operator">&lt;</span> iMaxCommitedEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        iMaxPLogEntry <span class="token operator">=</span> iMaxCommitedEntry<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 读取到的 MaxPLogEntry / MaxCommitedEntry</span>
      poRecoverCmd<span class="token operator">-></span><span class="token function">SetMaxPLogEntry</span><span class="token punctuation">(</span>iMaxPLogEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
      poRecoverCmd<span class="token operator">-></span><span class="token function">SetMaxCommitedEntry</span><span class="token punctuation">(</span>iMaxCommitedEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
      poRecoverCmd<span class="token operator">-></span><span class="token function">SetMaxLoadingEntry</span><span class="token punctuation">(</span>iMaxCommitedEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
      poRecoverCmd<span class="token operator">-></span><span class="token function">SetEntryRecordList</span><span class="token punctuation">(</span>tEntryRecordList<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 标记 HasMore，说明后面还有数据，这里只是把几个 Entry 进度读出来</span>
      poRecoverCmd<span class="token operator">-></span><span class="token function">SetHasMore</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 直接返回</span>
      <span class="token keyword">return</span> eRetCodeOK<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">bool</span> bHasMore <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  vector<span class="token operator">&lt;</span>pair<span class="token operator">&lt;</span><span class="token keyword">uint64_t</span><span class="token punctuation">,</span> string<span class="token operator">></span> <span class="token operator">></span> vecRecord<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iMaxLoadingEntry <span class="token operator">=</span> iMaxCommitedEntry <span class="token operator">+</span> poRecoverCmd<span class="token operator">-></span><span class="token function">GetMaxNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">TIMERUS_START</span><span class="token punctuation">(</span>iRangeLoadUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 从 PLogDB 中加载从 MaxCommitedEntry 到 MaxLoadingEntry 的 Entity Record 信息</span>
  iRet <span class="token operator">=</span> m_poPLogEngine<span class="token operator">-></span><span class="token function">LoadUncommitedEntrys</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iMaxCommitedEntry<span class="token punctuation">,</span> iMaxLoadingEntry<span class="token punctuation">,</span>
                                              vecRecord<span class="token punctuation">,</span> bHasMore<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">TIMERUS_STOP</span><span class="token punctuation">(</span>iRangeLoadUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  s_poLoadUncommitedEntrysTimeStat<span class="token operator">-></span><span class="token function">Update</span><span class="token punctuation">(</span>iRangeLoadUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">OSS</span><span class="token double-colon punctuation">::</span><span class="token function">ReportPLogRangeLoadTimeMS</span><span class="token punctuation">(</span>iRet<span class="token punctuation">,</span> iRangeLoadUseTimeUS <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRangeLoadUseTimeUS <span class="token operator">></span> <span class="token number">100000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) entrys: %lu %lu iRangeLoadUseTimeUS %lu"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span>
                    iMaxCommitedEntry<span class="token punctuation">,</span> iPLogCommitedEntry<span class="token punctuation">,</span> iMaxLoadingEntry<span class="token punctuation">,</span> iRangeLoadUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"LoadUncommitedEntrys E(%lu, %lu) ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iMaxCommitedEntry<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 遍历</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> vecRecord<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">uint64_t</span> iEntry <span class="token operator">=</span> vecRecord<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>first<span class="token punctuation">;</span>

    <span class="token comment">// 反序列化</span>
    EntryRecord_t tRecord<span class="token punctuation">;</span>
    iRet <span class="token operator">=</span> <span class="token function">StringToEntryRecord</span><span class="token punctuation">(</span>vecRecord<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>second<span class="token punctuation">,</span> tRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) StringToEntryRecord ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 读取对应的 Value</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>iValueID <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>tRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>bHasValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">TIMERUS_START</span><span class="token punctuation">(</span>iGetValueUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      iRet <span class="token operator">=</span> m_poPLogEngine<span class="token operator">-></span><span class="token function">GetValue</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> tRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>iValueID<span class="token punctuation">,</span>
                                      tRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>strValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">TIMERUS_STOP</span><span class="token punctuation">(</span>iGetValueUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      s_poGetTimeStat<span class="token operator">-></span><span class="token function">Update</span><span class="token punctuation">(</span>iGetValueUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">OSS</span><span class="token double-colon punctuation">::</span><span class="token function">ReportPLogGetValueTimeMS</span><span class="token punctuation">(</span>iRet<span class="token punctuation">,</span> iGetValueUseTimeUS <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>iGetValueUseTimeUS <span class="token operator">></span> <span class="token number">100000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) iGetValueUseTimeUS %lu"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                        iGetValueUseTimeUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"GetValue ret %d E(%lu, %lu) record: %s"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                        <span class="token function">EntryRecordToString</span><span class="token punctuation">(</span>tRecord<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      tRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>bHasValue <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    tEntryRecordList<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">pair</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint64_t</span><span class="token punctuation">,</span> EntryRecord_t<span class="token operator">></span></span></span><span class="token punctuation">(</span>iEntry<span class="token punctuation">,</span> tRecord<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 将读取到的信息写入 RecoverCmd</span>
  poRecoverCmd<span class="token operator">-></span><span class="token function">SetMaxCommitedEntry</span><span class="token punctuation">(</span>iMaxCommitedEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 实际读到的 Record 可能没这么多，这里语义不符</span>
  poRecoverCmd<span class="token operator">-></span><span class="token function">SetMaxLoadingEntry</span><span class="token punctuation">(</span>iMaxLoadingEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 实际读到的 Record</span>
  poRecoverCmd<span class="token operator">-></span><span class="token function">SetEntryRecordList</span><span class="token punctuation">(</span>tEntryRecordList<span class="token punctuation">)</span><span class="token punctuation">;</span>
  poRecoverCmd<span class="token operator">-></span><span class="token function">SetHasMore</span><span class="token punctuation">(</span>bHasMore<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> eRetCodeOK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>而后 <code>PLogWorker</code> 会把这条 <code>RecoverCmd</code> 塞回回复队列里，<code>EntityWorker</code> 回调用 <code>RangeRecoverFromPLog</code> 处理：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// 从 PLog 回复中确认是否已经完成 RangeLoaded</span>
<span class="token comment">// 若出错，处理错误后直接返回</span>
<span class="token comment">// 从读取到的 EntryRecordList 恢复 EntityInfo 信息，更新 MaxChosenEntry</span>
<span class="token comment">// 处理 WaitingMsg，检查 CatchUp，回复 RecoverCmd</span>
<span class="token keyword">int</span> clsEntityWorker<span class="token double-colon punctuation">::</span><span class="token function">RangeRecoverFromPLog</span><span class="token punctuation">(</span>clsRecoverCmd <span class="token operator">*</span>poCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">uint64_t</span> iEntityID <span class="token operator">=</span> poCmd<span class="token operator">-></span><span class="token function">GetEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iEntry <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  EntityInfo_t <span class="token operator">*</span>ptEntityInfo <span class="token operator">=</span> m_poEntityMng<span class="token operator">-></span><span class="token function">FindEntityInfo</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">AssertNotEqual</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 完成 RangeLoad，关闭标记</span>
  <span class="token function">AssertEqual</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>bRangeLoading<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ptEntityInfo<span class="token operator">-></span>bRangeLoading <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>poCmd<span class="token operator">-></span><span class="token function">GetResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> eRetCodeOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Recover Cmd 失败，处理错误后返回</span>
    <span class="token comment">// 回复 ClientCmd 错误</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">GetCmdID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> kRecoverCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> poCmd<span class="token operator">-></span><span class="token function">GetResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 将失败的 IsCheckGetAll Cmd 重新塞入 GetAllWorker 中，暂时忽略</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ptEntityInfo<span class="token operator">-></span>bGetAllPending <span class="token operator">&amp;&amp;</span> poCmd<span class="token operator">-></span><span class="token function">IsCheckGetAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">GetCurrTimeMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> ptEntityInfo<span class="token operator">-></span>iGetAllFinishTimeMS <span class="token operator">+</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      clsPaxosCmd <span class="token operator">*</span>po <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">clsPaxosCmd</span><span class="token punctuation">(</span><span class="token function">GetPeerAcceptorID</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">)</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">int</span> iRet <span class="token operator">=</span> clsGetAllWorker<span class="token double-colon punctuation">::</span><span class="token function">EnterReqQueue</span><span class="token punctuation">(</span>po<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">delete</span> po<span class="token punctuation">,</span> po <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"iEntityID %lu triggle getall by peer ret %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>

      ptEntityInfo<span class="token operator">-></span>bGetAllPending <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// &lt;Entry, Record></span>
  <span class="token keyword">typedef</span> vector<span class="token operator">&lt;</span>pair<span class="token operator">&lt;</span><span class="token keyword">uint64_t</span><span class="token punctuation">,</span> EntryRecord_t<span class="token operator">></span> <span class="token operator">></span> EntryRecordList_t<span class="token punctuation">;</span>
  <span class="token keyword">const</span> EntryRecordList_t <span class="token operator">&amp;</span>tEntryRecordList <span class="token operator">=</span> poCmd<span class="token operator">-></span><span class="token function">GetEntryRecordList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">AssertNotMore</span><span class="token punctuation">(</span>tEntryRecordList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m_poConf<span class="token operator">-></span><span class="token function">GetMaxCatchUpNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 根据 Cmd 返回的信息，更新已知的全局 Chosen 进度，这里的更新有些是冗余的</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry <span class="token operator">&lt;</span> poCmd<span class="token operator">-></span><span class="token function">GetMaxCommitedEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry <span class="token operator">=</span> poCmd<span class="token operator">-></span><span class="token function">GetMaxCommitedEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>poCmd<span class="token operator">-></span><span class="token function">IsHasMore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry <span class="token operator">&lt;</span> poCmd<span class="token operator">-></span><span class="token function">GetMaxLoadingEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry <span class="token operator">=</span> poCmd<span class="token operator">-></span><span class="token function">GetMaxLoadingEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tEntryRecordList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">uint64_t</span> iEntry <span class="token operator">=</span> tEntryRecordList<span class="token punctuation">.</span><span class="token function">rbegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>first<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tEntryRecordList<span class="token punctuation">.</span><span class="token function">rbegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>second<span class="token punctuation">.</span>bChosen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry <span class="token operator">&lt;</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry <span class="token operator">=</span> iEntry<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry <span class="token operator">&lt;</span> iEntry <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry <span class="token operator">=</span> iEntry <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">AssertNotMore</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iCatchUpEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry <span class="token operator">&lt;</span> poCmd<span class="token operator">-></span><span class="token function">GetMaxCommitedEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 本地的 Committed，一定是已知的</span>
    ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry <span class="token operator">=</span> poCmd<span class="token operator">-></span><span class="token function">GetMaxCommitedEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iCatchUpEntry <span class="token operator">&lt;</span> ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ptEntityInfo<span class="token operator">-></span>iCatchUpEntry <span class="token operator">=</span> ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iNotifyedEntry <span class="token operator">&lt;</span> poCmd<span class="token operator">-></span><span class="token function">GetMaxCommitedEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 已经 Committed，一定也是不需要 Notify 的</span>
    ptEntityInfo<span class="token operator">-></span>iNotifyedEntry <span class="token operator">=</span> poCmd<span class="token operator">-></span><span class="token function">GetMaxCommitedEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 遍历读到的 EntryRecordList，恢复 EntryInfo</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tEntryRecordList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    iEntry <span class="token operator">=</span> tEntryRecordList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>first<span class="token punctuation">;</span>
    <span class="token function">AssertLess</span><span class="token punctuation">(</span>poCmd<span class="token operator">-></span><span class="token function">GetMaxCommitedEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">AssertNotMore</span><span class="token punctuation">(</span>iEntry<span class="token punctuation">,</span> poCmd<span class="token operator">-></span><span class="token function">GetMaxLoadingEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    EntryInfo_t <span class="token operator">*</span>ptInfo <span class="token operator">=</span> m_poEntryMng<span class="token operator">-></span><span class="token function">FindEntryInfo</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptInfo <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> EntryRecord_t <span class="token operator">&amp;</span>tRecord <span class="token operator">=</span> tEntryRecordList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>second<span class="token punctuation">;</span>

      <span class="token comment">// 除了当前 Chosen 且 MaxContChosenEntry + 1 == iEntry 这种情况</span>
      <span class="token comment">// 其他的均需要检查数量限制，超过则直接跳过</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>tRecord<span class="token punctuation">.</span>bChosen <span class="token operator">&amp;&amp;</span> ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CheckIfEntryNumLimited</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) catchup limited by entry"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      ptInfo <span class="token operator">=</span> m_poEntryMng<span class="token operator">-></span><span class="token function">CreateEntryInfo</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 创建并恢复 EntryInfo</span>
      <span class="token function">AssertNotMore</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">RecoverEntry</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> tRecord<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 上面已经更新过了，这里应该是多余的</span>
      <span class="token function">UpdateMaxChosenEntry</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) st %d maybe loaded by plog"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                      ptInfo<span class="token operator">-></span>poMachine<span class="token operator">-></span><span class="token function">GetEntryState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Speed up applying DB.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ptInfo<span class="token operator">-></span>bUncertain <span class="token operator">&amp;&amp;</span> ptInfo<span class="token operator">-></span>poMachine<span class="token operator">-></span><span class="token function">GetEntryState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> kEntryStateChosen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 仅 MaxContChosenEntry + 1 == iEntry 时，推入 DB Worker</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PushCmdToDBWorker</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iCatchUpEntry <span class="token operator">&lt;</span> ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">AssertEqual</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iCatchUpEntry <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
          ptEntityInfo<span class="token operator">-></span>iCatchUpEntry<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">AssertNotMore</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iCatchUpEntry<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>poCmd<span class="token operator">-></span><span class="token function">IsHasMore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 没有更多可以读取的记录了</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tEntryRecordList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 可以知道 MaxPLogEntry 可以到最后一个 Entry</span>
      ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry <span class="token operator">=</span> tEntryRecordList<span class="token punctuation">.</span><span class="token function">rbegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>first<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 列表为空，MaxPLogEntry 可以到 Cmd->MaxCommittedEntry</span>
      ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry <span class="token operator">=</span> poCmd<span class="token operator">-></span><span class="token function">GetMaxCommitedEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ptEntityInfo<span class="token operator">-></span>bRangeLoaded <span class="token operator">&amp;&amp;</span> poCmd<span class="token operator">-></span><span class="token function">GetMaxPLogEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> INVALID_ENTRY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 还没有完成 RangeLoaded，且 Cmd->MaxPLogEntry 有数值</span>
    <span class="token function">CertainLogImpt</span><span class="token punctuation">(</span><span class="token string">"iEntityID %lu iMaxPLogEntry %lu -> %lu"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry<span class="token punctuation">,</span>
                   poCmd<span class="token operator">-></span><span class="token function">GetMaxPLogEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Assert</span><span class="token punctuation">(</span><span class="token operator">!</span>poCmd<span class="token operator">-></span><span class="token function">IsRangeLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry <span class="token operator">==</span> INVALID_ENTRY <span class="token operator">||</span>
        ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry <span class="token operator">&lt;</span> poCmd<span class="token operator">-></span><span class="token function">GetMaxPLogEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 使用 Cmd->MaxPLogEntry 作为 MaxPLogEntry</span>
      ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry <span class="token operator">=</span> poCmd<span class="token operator">-></span><span class="token function">GetMaxPLogEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"iEntityID %lu iMaxPLogEntry %lu -> %lu"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span>
                      ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry<span class="token punctuation">,</span> poCmd<span class="token operator">-></span><span class="token function">GetMaxPLogEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 标记完成 Range Loaded</span>
  ptEntityInfo<span class="token operator">-></span>bRangeLoaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"iEntityID %lu entrys: %lu %lu %lu iEmptyEntryCnt %u"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span>
                 poCmd<span class="token operator">-></span><span class="token function">GetMaxCommitedEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> poCmd<span class="token operator">-></span><span class="token function">GetMaxLoadingEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry<span class="token punctuation">,</span> iEmptyEntryCnt<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 处理 WaitingMsg，以后再分析等待的 Msg 是啥</span>
  <span class="token keyword">uint32_t</span> iWaitingMsgPtrSize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clsPaxosCmd <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">*</span> m_iAcceptorNum<span class="token punctuation">;</span>
  clsPaxosCmd <span class="token operator">*</span><span class="token operator">*</span>apWaitingMsg <span class="token operator">=</span> <span class="token punctuation">(</span>clsPaxosCmd <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>iWaitingMsgPtrSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span> <span class="token function">oAutoFreeWaitingMsgPtr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>apWaitingMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">memcpy</span><span class="token punctuation">(</span>apWaitingMsg<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>apWaitingMsg<span class="token punctuation">,</span> iWaitingMsgPtrSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>apWaitingMsg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> iWaitingMsgPtrSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> iRet <span class="token operator">=</span> <span class="token function">DoWithWaitingMsg</span><span class="token punctuation">(</span>apWaitingMsg<span class="token punctuation">,</span> m_iAcceptorNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
  m_poMemCacheCtrl<span class="token operator">-></span><span class="token function">UpdateTotalSize</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"DoWithWaitingMsg ret %d"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 检查是否进行 CatchUp</span>
  <span class="token function">CheckForCatchUp</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> INVALID_ACCEPTOR_ID<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">GetCmdID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> kRecoverCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ClientCmd 是 RecoverCmd，设定 MaxChosenEntry</span>
    clsRecoverCmd <span class="token operator">*</span>po <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>clsRecoverCmd <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    po<span class="token operator">-></span><span class="token function">SetMaxChosenEntry</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry <span class="token operator">&lt;</span> ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// MaxContChosenEntry &lt; MaxChosenEntry, 返回 CatchUp 状态码</span>
      <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> eRetCodeCatchUp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 否则返回 OK</span>
      <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> eRetCodeOK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>总的来说，<code>RangeLoadFromPLog</code> 会异步的启动恢复流程，经过 <code>FillRecoverCmd</code> 读取 Record 记录，再回到 <code>RangeRecoverFromPLog</code> 恢复成 <code>EntryInfo</code>、更新进度信息。</p>
<h3 id="4.-dowithtimeout-+-activateentry" tabindex="-1"><a href="#4.-dowithtimeout-%2B-activateentry">4. DoWithTimeout + ActivateEntry</a></h3>
<p><code>EntityWorker</code> 的 Loop 循环中也需要处理各类超时情况，包括 Entry 的超时和 Cmd 的超时：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// 处理超时的 Entry</span>
<span class="token keyword">int</span> clsEntityWorker<span class="token double-colon punctuation">::</span><span class="token function">DoWithTimeout</span><span class="token punctuation">(</span>EntryInfo_t <span class="token operator">*</span>ptInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  EntityInfo_t <span class="token operator">*</span>ptEntityInfo <span class="token operator">=</span> ptInfo<span class="token operator">-></span>ptEntityInfo<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"iEntry %lu"</span><span class="token punctuation">,</span> ptInfo<span class="token operator">-></span>iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">AssertNotEqual</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">uint64_t</span> iEntityID <span class="token operator">=</span> ptEntityInfo<span class="token operator">-></span>iEntityID<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iEntry <span class="token operator">=</span> ptInfo<span class="token operator">-></span>iEntry<span class="token punctuation">;</span>
  <span class="token function">AssertEqual</span><span class="token punctuation">(</span><span class="token function">Hash</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">)</span> <span class="token operator">%</span> m_poConf<span class="token operator">-></span><span class="token function">GetEntityWorkerNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m_iWorkerID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptInfo<span class="token operator">-></span>iEntry <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Entry(0)，用来匹配 RecoverCmd</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">AssertEqual</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">GetCmdID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kRecoverCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 直接超时判定 Cmd 超时</span>
    <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> eRetCodeTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 标记 Cmd 超时</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">GetEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> eRetCodeTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_poEntryMng<span class="token operator">-></span><span class="token function">AddTimeout</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 落盘超时</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptInfo<span class="token operator">-></span>bUncertain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"Check if disk busy E(%lu, %lu) st %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                    ptInfo<span class="token operator">-></span>poMachine<span class="token operator">-></span><span class="token function">GetEntryState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// GetAll 超时</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>bGetAllPending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> eRetCodeTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_poEntryMng<span class="token operator">-></span><span class="token function">DestroyEntryInfo</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) GetAllPending, timeout and destroy entry"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 其他情况，重新激活一下该 EntryInfo</span>
  <span class="token function">ActivateEntry</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>ActivateEntry</code> 激活操作大致分为三种情况：本地确定 Chosen 的，可以清理返回；远程 Chosen 的，找 ActiveAcceptor 同步；还没有 Chosen 的，广播一下。</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> clsEntityWorker<span class="token double-colon punctuation">::</span><span class="token function">ActivateEntry</span><span class="token punctuation">(</span>EntryInfo_t <span class="token operator">*</span>ptInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  EntityInfo_t <span class="token operator">*</span>ptEntityInfo <span class="token operator">=</span> ptInfo<span class="token operator">-></span>ptEntityInfo<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iEntityID <span class="token operator">=</span> ptEntityInfo<span class="token operator">-></span>iEntityID<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iEntry <span class="token operator">=</span> ptInfo<span class="token operator">-></span>iEntry<span class="token punctuation">;</span>

  <span class="token keyword">uint32_t</span> iLocalAcceptorID <span class="token operator">=</span> ptEntityInfo<span class="token operator">-></span>iLocalAcceptorID<span class="token punctuation">;</span>
  clsEntryStateMachine <span class="token operator">*</span>poMachine <span class="token operator">=</span> ptInfo<span class="token operator">-></span>poMachine<span class="token punctuation">;</span>
  <span class="token function">AssertEqual</span><span class="token punctuation">(</span>ptInfo<span class="token operator">-></span>bUncertain<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">AssertEqual</span><span class="token punctuation">(</span>m_poEntryMng<span class="token operator">-></span><span class="token function">WaitForTimeout</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// The entry is newly open and has no activity.</span>
  <span class="token comment">// 刚新建的，没有有效信息，清掉返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry <span class="token operator">&lt;</span> iEntry <span class="token operator">&amp;&amp;</span> poMachine<span class="token operator">-></span><span class="token function">IsLocalEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"iEntityID %lu entrys: %lu %lu %lu ref %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span>
                   ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iCatchUpEntry<span class="token punctuation">,</span>
                   ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iRefCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CleanUpEntry</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// The entry has been sent to the DB worker.</span>
  <span class="token comment">// 已经送到 DB Worker，清掉返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry <span class="token operator">>=</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CleanUpEntry</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Not need to broadcast, wait for being elimated or commited.</span>
  <span class="token comment">// 已经 Chosen 了，不需要广播，增加被杀的概率，返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>poMachine<span class="token operator">-></span><span class="token function">GetEntryState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> kEntryStateChosen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) st %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> poMachine<span class="token operator">-></span><span class="token function">GetEntryState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_poEntryMng<span class="token operator">-></span><span class="token function">IncreaseEliminatePriority</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// For catch up.</span>
  <span class="token comment">// 还没有 Chosen，但全局已经 Chosen 了，和其他机器同步一下</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iEntry <span class="token operator">&lt;=</span> ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_poEntryMng<span class="token operator">-></span><span class="token function">CheckIfCatchUpLimited</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) catchup limited"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Machine A fix the entry only.</span>
    <span class="token comment">// 该 Entry 已经处理两次以上</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptInfo<span class="token operator">-></span>iInteractCnt <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"May need fix E(%lu, %lu) st %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                      ptInfo<span class="token operator">-></span>poMachine<span class="token operator">-></span><span class="token function">GetEntryState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">OSS</span><span class="token double-colon punctuation">::</span><span class="token function">ReportMayNeedFix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>m_poConf<span class="token operator">-></span><span class="token function">GetEnableAutoFixEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">CertainLogZero</span><span class="token punctuation">(</span><span class="token string">"ProposeNoop for Fix E(%lu, %lu) st %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                       ptInfo<span class="token operator">-></span>poMachine<span class="token operator">-></span><span class="token function">GetEntryState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 发起一个空提议</span>
        <span class="token function">ProposeNoop</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 该 Entry 已经处理三次以上，清掉返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptInfo<span class="token operator">-></span>iInteractCnt <span class="token operator">></span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CleanUpEntry</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 增加处理计数</span>
    ptInfo<span class="token operator">-></span>iInteractCnt<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">uint32_t</span> iActiveAcceptorID <span class="token operator">=</span> <span class="token function">GetPeerAcceptorID</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">AssertEqual</span><span class="token punctuation">(</span>ptInfo<span class="token operator">-></span>bRemoteUpdated<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ptInfo<span class="token operator">-></span>bRemoteUpdated <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// 和 ActiveAcceptor 同步一下这个 Entry 的状态</span>
    <span class="token function">SyncEntryRecord</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> iActiveAcceptorID<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ptInfo<span class="token operator">-></span>bRemoteUpdated <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token class-name">OSS</span><span class="token double-colon punctuation">::</span><span class="token function">ReportSingleCatchUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 加入到超时列表，超时时间 15 秒</span>
    m_poEntryMng<span class="token operator">-></span><span class="token function">AddTimeout</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> <span class="token number">15000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"sync acceptor %u E(%lu, %lu) st %d"</span><span class="token punctuation">,</span> iActiveAcceptorID<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                    ptInfo<span class="token operator">-></span>poMachine<span class="token operator">-></span><span class="token function">GetEntryState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptInfo<span class="token operator">-></span>iInteractCnt <span class="token operator">></span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CleanUpEntry</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 还没有 Chosen，并且也没有确定全局已经 Chosen</span>
  <span class="token keyword">const</span> EntryRecord_t <span class="token operator">&amp;</span>tRecord <span class="token operator">=</span> poMachine<span class="token operator">-></span><span class="token function">GetRecord</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"Broadcast E(%lu, %lu) st %u iMaxChosenEntry %lu r[%u] %s"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                  poMachine<span class="token operator">-></span><span class="token function">GetEntryState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">,</span> iLocalAcceptorID<span class="token punctuation">,</span>
                  <span class="token function">EntryRecordToString</span><span class="token punctuation">(</span>tRecord<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  ptInfo<span class="token operator">-></span>iInteractCnt<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token comment">// 广播确认一下</span>
  <span class="token function">BroadcastToRemote</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> ptInfo<span class="token operator">-></span>poMachine<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">OSS</span><span class="token double-colon punctuation">::</span><span class="token function">ReportTimeoutBroadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Wait longer, as broadcast is heavy, and many candidates to reply.</span>
  <span class="token comment">// 加入超时列表，超时时间 30 秒</span>
  m_poEntryMng<span class="token operator">-></span><span class="token function">AddTimeout</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> <span class="token number">30000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="5.-总结" tabindex="-1"><a href="#5.-%E6%80%BB%E7%BB%93">5. 总结</a></h3>
<p>PaxosStore 的代码大多是异步的，一个长的处理流程会拆成多个小块，梳理起来确实会有些复杂。本篇把这些细碎的逻辑拎出来阅读，下一步将会把这些小流程串起来，看看完整的 Paxos / CatchUp 流程。</p>

      </div>
      <div id="gitalk-container">
      </div>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2021 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/gitalk.min.js"></script>
    <script src="/dist/main.js"></script>
    <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-61723712-2', 'auto'); ga('send', 'pageview'); </script>
  </body>
</html>
