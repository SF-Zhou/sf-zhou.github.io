<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/gitalk.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>PaxosStore 源码分析「六、流程细节」 | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> PaxosStore 源码分析「六、流程细节」 </h1>
      </div>
      <div class="info">
        <div class="date"> 2020.04.12 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <p>本篇继续来看 PaxosStore 中 Paxos 流程的细节。</p>
<h3 id="1.-paxos-流程"><a href="#1.-paxos-%E6%B5%81%E7%A8%8B">1. Paxos 流程</a></h3>
<p>PaxosStore 中一次普通的 Paxos 协议过程如下图所示：</p>
<figure tabindex="1"><a href="../images/ff2cd1a1c77f43848425b96df20946f8.svg"><img src="../images/ff2cd1a1c77f43848425b96df20946f8.svg" alt=""></a><figcaption>Paxos 协议过程</figcaption></figure>
<p>假设现在有 A / B / C 三个节点的集群，由 A 发起 Paxos 过程，首先会调用 <code>RunPaxos</code>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">int</span> clsCertainWrapper<span class="token operator">::</span><span class="token function">RunPaxos</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iEntry<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> hSubCmdID<span class="token punctuation">,</span>
                                <span class="token keyword">const</span> vector<span class="token operator">&lt;</span><span class="token keyword">uint64_t</span><span class="token operator">></span> <span class="token operator">&amp;</span>vecWBUUID<span class="token punctuation">,</span> <span class="token keyword">const</span> string <span class="token operator">&amp;</span>strWriteBatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_poConf<span class="token operator">-></span><span class="token function">GetEnableLearnOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Learner 模式下不允许发起 Paxos 过程</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) reject if learn only %u"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                    m_poConf<span class="token operator">-></span><span class="token function">GetEnableLearnOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> eRetCodeRejectAll<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> vecWBUUID<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 检查 UUID 是否重复，之后会分析 UUID 的作用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clsUUIDGroupMng<span class="token operator">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">IsUUIDExist</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> vecWBUUID<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> eRetCodeDupUUID<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 检查 WriteBatch 的长度限制，默认 20MB</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>strWriteBatch<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> vecWBUUID<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">32</span> <span class="token operator">></span> MAX_WRITEBATCH_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"BUG maybe strWriteBatch.size %lu vecWBUUID.size %lu"</span><span class="token punctuation">,</span> strWriteBatch<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    vecWBUUID<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> eRetCodeSizeExceed<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">TIMERMS_START</span><span class="token punctuation">(</span>iUseTimeMS<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">uint64_t</span> iUUID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>strWriteBatch<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">AssertEqual</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> vecWBUUID<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    iUUID <span class="token operator">=</span> clsCmdFactory<span class="token operator">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetNextUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// AssertLess(0, vecWBUUID.size());</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 构造一个新的 WriteBatch Cmd</span>
  clsWriteBatchCmd <span class="token operator">*</span>poWB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">clsWriteBatchCmd</span><span class="token punctuation">(</span>hSubCmdID<span class="token punctuation">,</span> iUUID<span class="token punctuation">,</span> vecWBUUID<span class="token punctuation">,</span> strWriteBatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
  clsAutoDelete<span class="token operator">&lt;</span>clsWriteBatchCmd<span class="token operator">></span> <span class="token function">oAuto</span><span class="token punctuation">(</span>poWB<span class="token punctuation">)</span><span class="token punctuation">;</span>

  poWB<span class="token operator">-></span><span class="token function">SetTimestampUS</span><span class="token punctuation">(</span><span class="token function">GetCurrTimeUS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  poWB<span class="token operator">-></span><span class="token function">SetEntityID</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  poWB<span class="token operator">-></span><span class="token function">SetEntry</span><span class="token punctuation">(</span>iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  poWB<span class="token operator">-></span><span class="token function">SetEvalOnly</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// WriteBatch 为空时为 ReadOnly 模式</span>
  poWB<span class="token operator">-></span><span class="token function">SetReadOnly</span><span class="token punctuation">(</span>strWriteBatch<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 同步等待 Cmd 执行完成</span>
  <span class="token keyword">int</span> iRet <span class="token operator">=</span> <span class="token function">SyncWaitCmd</span><span class="token punctuation">(</span>poWB<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">TIMERMS_STOP</span><span class="token punctuation">(</span>iUseTimeMS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  OSS<span class="token operator">::</span><span class="token function">ReportRunPaxosTimeMS</span><span class="token punctuation">(</span>iRet<span class="token punctuation">,</span> iUseTimeMS<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> iRet<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>SyncWaitCmd</code> 的代码<a href="/paxos/paxos_store_05_details.html">上一篇中</a>分析过，直接跳到 <code>DoWithClientCmd</code>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// 处理 Client Cmd，转为 Paxos Cmd 并塞入 PLogReq</span>
<span class="token keyword">int</span> clsEntityWorker<span class="token operator">::</span><span class="token function">DoWithClientCmd</span><span class="token punctuation">(</span>clsClientCmd <span class="token operator">*</span>poCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iRet<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iEntityID <span class="token operator">=</span> poCmd<span class="token operator">-></span><span class="token function">GetEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  EntityInfo_t <span class="token operator">*</span>ptEntityInfo <span class="token operator">=</span> m_poEntityMng<span class="token operator">-></span><span class="token function">FindEntityInfo</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 确定非空</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// CheckDBStatus may not refresh the entity LRU,</span>
    <span class="token comment">// and the ptEntityInfo is at the tail of the entity LRU.</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"BUG maybe check it cmd: %s"</span><span class="token punctuation">,</span> poCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">,</span> eRetCodeEntityEvicted<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 确保 Recovering 完成</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry <span class="token operator">==</span> INVALID_ENTRY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">,</span> eRetCodeRecovering<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 确保非 GetAll 等待状态</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>bGetAllPending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">,</span> eRetCodeGetAllPending<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">uint32_t</span> iLocalAcceptorID <span class="token operator">=</span> ptEntityInfo<span class="token operator">-></span>iLocalAcceptorID<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>iLocalAcceptorID <span class="token operator">==</span> INVALID_ACCEPTOR_ID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">,</span> eRetCodeRouteErr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 当前没有处理其他 ClientCmd</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"BUG probably cmd: %s"</span><span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">,</span> eRetCodeUnkown<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 要求 WirteBatchCmd 的 Entry 刚好是下一个 Chosen 目标</span>
  <span class="token comment">// 前者必定满足（ClientCmd 目前仅有 WriteBatchCmd</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>poCmd<span class="token operator">-></span><span class="token function">GetCmdID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> kWriteBatchCmd <span class="token operator">||</span> poCmd<span class="token operator">-></span><span class="token function">IsEvalOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>poCmd<span class="token operator">-></span><span class="token function">GetEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Use suggested lease to avoid this error.</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"Check iEntityID %lu Entrys: %lu %lu cmd: %s"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span>
                      ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">,</span>
                      poCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">,</span> eRetCodeTurnErr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">AssertEqual</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">Assert</span><span class="token punctuation">(</span>m_poEntityMng<span class="token operator">-></span><span class="token function">Refresh</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">uint64_t</span> iEntry <span class="token operator">=</span> ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

  EntryInfo_t <span class="token operator">*</span>ptInfo <span class="token operator">=</span> m_poEntryMng<span class="token operator">-></span><span class="token function">FindEntryInfo</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptInfo <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当前 EntryInfo 为空</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CheckIfEntryNumLimited</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">,</span> eRetCodeEntryLimited<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ptInfo <span class="token operator">=</span> m_poEntryMng<span class="token operator">-></span><span class="token function">CreateEntryInfo</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_poEntryMng<span class="token operator">-></span><span class="token function">AddTimeout</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> m_poConf<span class="token operator">-></span><span class="token function">GetCmdTimeoutMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果已经有 MaxChosenEntry + 1 的 PLog，那么此处可以判断是忙碌状态</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iEntry <span class="token operator">&lt;=</span> ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">LoadFromPLogWorker</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        m_poEntryMng<span class="token operator">-></span><span class="token function">DestroyEntryInfo</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) iMaxPLogEntry %lu ref %d Check if Busy"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                      ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iRefCount<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">,</span> eRetCodeBusy<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Uncertain 状态，需要等待 PLog 恢复完成</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptInfo<span class="token operator">-></span>bUncertain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">,</span> eRetCodePLogPending<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  clsEntryStateMachine <span class="token operator">*</span>poMachine <span class="token operator">=</span> ptInfo<span class="token operator">-></span>poMachine<span class="token punctuation">;</span>
  <span class="token keyword">int</span> iEntryState <span class="token operator">=</span> poMachine<span class="token operator">-></span><span class="token function">GetEntryState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) state %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iEntryState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">AssertNotEqual</span><span class="token punctuation">(</span>iEntryState<span class="token punctuation">,</span> kEntryStateChosen<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">AssertEqual</span><span class="token punctuation">(</span>ptInfo<span class="token operator">-></span>bRemoteUpdated<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">AssertEqual</span><span class="token punctuation">(</span>ptInfo<span class="token operator">-></span>bBroadcast<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  poCmd<span class="token operator">-></span><span class="token function">SetEntry</span><span class="token punctuation">(</span>iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  m_poEntryMng<span class="token operator">-></span><span class="token function">AddTimeout</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> m_poConf<span class="token operator">-></span><span class="token function">GetCmdTimeoutMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  ptEntityInfo<span class="token operator">-></span>poClientCmd <span class="token operator">=</span> poCmd<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>poCmd<span class="token operator">-></span><span class="token function">IsReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>poMachine<span class="token operator">-></span><span class="token function">IsLocalEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      poMachine<span class="token operator">-></span><span class="token function">ResetAllCheckedEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      poMachine<span class="token operator">-></span><span class="token function">SetCheckedEmpty</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">BroadcastToRemote</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      m_poEntryMng<span class="token operator">-></span><span class="token function">AddTimeout</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> m_poConf<span class="token operator">-></span><span class="token function">GetCmdTimeoutMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      OSS<span class="token operator">::</span><span class="token function">ReportCheckEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      OSS<span class="token operator">::</span><span class="token function">ReportPaxosForRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    OSS<span class="token operator">::</span><span class="token function">ReportPaxosForWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poLeasePolicy<span class="token operator">-></span><span class="token function">GetLeaseTimeoutMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iLocalAcceptorID <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"Check if master busy E(%lu, %lu)"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ptEntityInfo<span class="token operator">-></span>poClientCmd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    m_poEntryMng<span class="token operator">-></span><span class="token function">AddTimeout</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">,</span> eRetCodeLeaseReject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    OSS<span class="token operator">::</span><span class="token function">ReportLeaseReject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 计算 Proposal 编号</span>
  <span class="token keyword">uint32_t</span> iProposalNum <span class="token operator">=</span> poMachine<span class="token operator">-></span><span class="token function">GetNextPreparedNum</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  EntryRecord_t tTempRecord<span class="token punctuation">;</span>
  <span class="token function">InitEntryRecord</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tTempRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">bool</span> bSetValue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">// 预授权优化相关，下一节会介绍</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_poConf<span class="token operator">-></span><span class="token function">GetEnablePreAuth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> iProposalNum <span class="token operator">==</span> iLocalAcceptorID <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
      iEntry <span class="token operator">==</span> ptEntityInfo<span class="token operator">-></span>iLocalPreAuthEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>poMachine<span class="token operator">-></span><span class="token function">IsLocalEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"BUG probably Check E(%lu, %lu)"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_poConf<span class="token operator">-></span><span class="token function">GetLocalAcceptFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      tTempRecord<span class="token punctuation">.</span>iAcceptedNum <span class="token operator">=</span> iProposalNum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    bSetValue <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>iProposalNum <span class="token operator">==</span> iLocalAcceptorID <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    iProposalNum <span class="token operator">=</span> poMachine<span class="token operator">-></span><span class="token function">GetNextPreparedNum</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 本地当然 Promised</span>
  tTempRecord<span class="token punctuation">.</span>iPreparedNum <span class="token operator">=</span> iProposalNum<span class="token punctuation">;</span>
  tTempRecord<span class="token punctuation">.</span>iPromisedNum <span class="token operator">=</span> iProposalNum<span class="token punctuation">;</span>

  <span class="token comment">// 生成 ValueID</span>
  poCmd<span class="token operator">-></span><span class="token function">SetWriteBatchID</span><span class="token punctuation">(</span>clsEntityInfoMng<span class="token operator">::</span><span class="token function">GenerateValueID</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> tTempRecord<span class="token punctuation">.</span>iPreparedNum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 预授权的会直接在这里赋值</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>bSetValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tTempRecord<span class="token punctuation">.</span>tValue <span class="token operator">=</span>
        <span class="token function">PaxosValue_t</span><span class="token punctuation">(</span>poCmd<span class="token operator">-></span><span class="token function">GetWriteBatchID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> poCmd<span class="token operator">-></span><span class="token function">GetWBUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> poCmd<span class="token operator">-></span><span class="token function">GetWriteBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_poMemCacheCtrl<span class="token operator">-></span><span class="token function">IsOverLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) TotalSize %lu"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                    m_poMemCacheCtrl<span class="token operator">-></span><span class="token function">GetTotalSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> eRetCodeMemCacheLimited<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 更新状态机</span>
  iEntryState <span class="token operator">=</span>
      poMachine<span class="token operator">-></span><span class="token function">Update</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iLocalAcceptorID<span class="token punctuation">,</span> iLocalAcceptorID<span class="token punctuation">,</span> tTempRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
  m_poMemCacheCtrl<span class="token operator">-></span><span class="token function">UpdateTotalSize</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iEntryState <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"poMachine->Update ret %d cmd: %s state: %s"</span><span class="token punctuation">,</span> iEntryState<span class="token punctuation">,</span>
                    poCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> poMachine<span class="token operator">-></span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> eRetCodeUnkown<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> EntryRecord_t <span class="token operator">&amp;</span>tUpdatedRecord <span class="token operator">=</span> poMachine<span class="token operator">-></span><span class="token function">GetRecord</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 构造 PaxosCmd</span>
  clsPaxosCmd <span class="token operator">*</span>poPaxosCmd <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token function">clsPaxosCmd</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tUpdatedRecord<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  poPaxosCmd<span class="token operator">-></span><span class="token function">SetUUID</span><span class="token punctuation">(</span>poCmd<span class="token operator">-></span><span class="token function">GetUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  poPaxosCmd<span class="token operator">-></span><span class="token function">SetMaxPLogEntry</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">)</span>ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">CertainLogDebug</span><span class="token punctuation">(</span><span class="token string">"record: %s state %d"</span><span class="token punctuation">,</span> <span class="token function">EntryRecordToString</span><span class="token punctuation">(</span>tUpdatedRecord<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iEntryState<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 进入 PLog 队列前均为 Uncertain 状态</span>
  ptInfo<span class="token operator">-></span>bUncertain <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// 需要广播</span>
  ptInfo<span class="token operator">-></span>bBroadcast <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token comment">// 塞入 PLog Req 队列进行持久化</span>
  iRet <span class="token operator">=</span> clsPLogWorker<span class="token operator">::</span><span class="token function">EnterPLogReqQueue</span><span class="token punctuation">(</span>poPaxosCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"EnterPLogReqQueue ret %d"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">delete</span> poPaxosCmd<span class="token punctuation">,</span> poPaxosCmd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    ptInfo<span class="token operator">-></span>bUncertain <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token function">CleanUpEntry</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>PLog 持久化部分在<a href="/paxos/paxos_store_04_paxos_log.html">第四篇博文</a>中有分析，这里跳过。继续来看 PLog 持久化完成后的处理：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// 处理 PLog 中的 PaxosCmd</span>
<span class="token comment">// 1. 更新 MaxPLogEntry</span>
<span class="token comment">// 2. SyncRecord</span>
<span class="token comment">// 3. Chosen Update</span>
<span class="token comment">// 4. Response Client</span>
<span class="token comment">// 5. Do Waiting Msg</span>
<span class="token keyword">int</span> clsEntityWorker<span class="token operator">::</span><span class="token function">DoWithPaxosCmdFromPLog</span><span class="token punctuation">(</span>clsPaxosCmd <span class="token operator">*</span>poPaxosCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iRet<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iEntityID <span class="token operator">=</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iEntry <span class="token operator">=</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">AssertEqual</span><span class="token punctuation">(</span><span class="token function">Hash</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">)</span> <span class="token operator">%</span> m_poConf<span class="token operator">-></span><span class="token function">GetEntityWorkerNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m_iWorkerID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">CertainLogDebug</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu)"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 必然有 Entry</span>
  EntryInfo_t <span class="token operator">*</span>ptInfo <span class="token operator">=</span> m_poEntryMng<span class="token operator">-></span><span class="token function">FindEntryInfo</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">AssertNotEqual</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 必然有 Entity</span>
  EntityInfo_t <span class="token operator">*</span>ptEntityInfo <span class="token operator">=</span> ptInfo<span class="token operator">-></span>ptEntityInfo<span class="token punctuation">;</span>
  <span class="token function">AssertNotEqual</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 注册定时器</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_poEntryMng<span class="token operator">-></span><span class="token function">WaitForTimeout</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    m_poEntryMng<span class="token operator">-></span><span class="token function">AddTimeout</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> <span class="token number">15000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">uint32_t</span> iLocalAcceptorID <span class="token operator">=</span> ptEntityInfo<span class="token operator">-></span>iLocalAcceptorID<span class="token punctuation">;</span>
  <span class="token function">AssertLess</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">,</span> m_iAcceptorNum<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">AssertEqual</span><span class="token punctuation">(</span>ptInfo<span class="token operator">-></span>bUncertain<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果持久化出错，及时退出</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">IsPLogError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"plog error cmd: %s"</span><span class="token punctuation">,</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ptInfo<span class="token operator">-></span>bUncertain <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token function">CleanUpEntry</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// IsPLogLoad 模式，这里无关</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">IsPLogLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">RecoverFromPLogWorker</span><span class="token punctuation">(</span>poPaxosCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// PLog 持久化完成，为 Certain 的状态</span>
  ptInfo<span class="token operator">-></span>bUncertain <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token comment">// 更新 MaxPLogEntry</span>
  <span class="token comment">// Keep iMaxPLogEntry consistent with data in disk.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">IsCheckHasMore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>poPaxosCmd<span class="token operator">-></span><span class="token function">IsHasMore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// MARK: MaxLogEntry</span>
    <span class="token comment">// 从 PLog 读取回来，此时确定没有更多的记录</span>
    <span class="token comment">// 那么 EntityInfo->MaxPLogEntry 无论是没有初始化，还是小于当前 Cmd 的 Entry</span>
    <span class="token comment">// 都可以被更新掉。这是合理的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry <span class="token operator">==</span> INVALID_ENTRY <span class="token operator">||</span> ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry <span class="token operator">&lt;</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry <span class="token operator">=</span> iEntry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry <span class="token operator">!=</span> INVALID_ENTRY <span class="token operator">&amp;&amp;</span> ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry <span class="token operator">&lt;</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 此时不确定有没有更多的记录（可能有，可能没检查</span>
    <span class="token comment">// 如果 MaxPLogEntry 已经初始化过，且小于当前 Cmd 的 Entry，才可以更新</span>
    ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry <span class="token operator">=</span> iEntry<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  clsEntryStateMachine <span class="token operator">*</span>poMachine <span class="token operator">=</span> ptInfo<span class="token operator">-></span>poMachine<span class="token punctuation">;</span>

  <span class="token comment">// 本地已经拿到的 Entry，状态机还不是 Chosen，那么一定报错</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iEntry <span class="token operator">&lt;=</span> ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry <span class="token operator">&amp;&amp;</span>
      poMachine<span class="token operator">-></span><span class="token function">GetEntryState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> kEntryStateChosen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    clsClientCmd <span class="token operator">*</span>poClientCmd <span class="token operator">=</span> ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token punctuation">;</span>

    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) MaxContChosenEntry %lu ClientNull %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                    ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token punctuation">,</span> poClientCmd <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>poClientCmd <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> poClientCmd<span class="token operator">-></span><span class="token function">GetEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 和其他节点同步状态</span>
  <span class="token function">SyncEntryRecord</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetDestAcceptorID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> EntryRecord_t <span class="token operator">&amp;</span>tSrcRecord <span class="token operator">=</span> poMachine<span class="token operator">-></span><span class="token function">GetRecord</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetSrcRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> tSrcRecord<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">AssertEqual</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  poMachine<span class="token operator">-></span><span class="token function">SetStoredValueID</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果已经 Chosen 了</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>poMachine<span class="token operator">-></span><span class="token function">GetEntryState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> kEntryStateChosen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 此时已经 Chosen，不需要再 CatchUp 该 Entry 了</span>
    m_poEntryMng<span class="token operator">-></span><span class="token function">RemoveCatchUpFlag</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    OSS<span class="token operator">::</span><span class="token function">ReportChosenProposalNum</span><span class="token punctuation">(</span>tSrcRecord<span class="token punctuation">.</span>iAcceptedNum<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>tSrcRecord<span class="token punctuation">.</span>iAcceptedNum <span class="token operator">></span> m_iAcceptorNum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"Not PreAuth record: %s"</span><span class="token punctuation">,</span> <span class="token function">EntryRecordToString</span><span class="token punctuation">(</span>tSrcRecord<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Update iLocalPreAuthEntry.</span>
    <span class="token comment">// 更新预授权 Entry 编号，下一节会分析</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clsEntryStateMachine<span class="token operator">::</span><span class="token function">GetAcceptorID</span><span class="token punctuation">(</span>tSrcRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>iValueID<span class="token punctuation">)</span> <span class="token operator">==</span>
        ptEntityInfo<span class="token operator">-></span>iLocalAcceptorID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iLocalPreAuthEntry <span class="token operator">&lt;</span> iEntry <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ptEntityInfo<span class="token operator">-></span>iLocalPreAuthEntry <span class="token operator">=</span> iEntry <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 已知的 MaxChosenEntry</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry <span class="token operator">&lt;</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry <span class="token operator">=</span> iEntry<span class="token punctuation">;</span>

      <span class="token comment">// Remove Lease for the slave when chosen.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iLocalAcceptorID <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ptEntityInfo<span class="token operator">-></span>poLeasePolicy<span class="token operator">-></span><span class="token function">Reset</span><span class="token punctuation">(</span>m_poConf<span class="token operator">-></span><span class="token function">GetLeaseDurationMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    clsClientCmd <span class="token operator">*</span>poClientCmd <span class="token operator">=</span> ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token punctuation">;</span>
    <span class="token function">AssertNotEqual</span><span class="token punctuation">(</span>tSrcRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>iValueID<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// wb.size == 0 &lt;==> readonly cmd</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tSrcRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>strValue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> vector<span class="token operator">&lt;</span><span class="token keyword">uint64_t</span><span class="token operator">></span> <span class="token operator">&amp;</span>vecUUID <span class="token operator">=</span> tSrcRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>vecValueUUID<span class="token punctuation">;</span>
      <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"uuid num %lu cmd: %s"</span><span class="token punctuation">,</span> vecUUID<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> vecUUID<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        m_poUUIDMng<span class="token operator">-></span><span class="token function">AddUUID</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> vecUUID<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 检查 ClientCmd 中的值与实际写入的值是否一致</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>poClientCmd <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> poClientCmd<span class="token operator">-></span><span class="token function">GetEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogDebug</span><span class="token punctuation">(</span><span class="token string">"cli_cmd: %s chosen: %s"</span><span class="token punctuation">,</span> poClientCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                      <span class="token function">EntryRecordToString</span><span class="token punctuation">(</span>tSrcRecord<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">AssertEqual</span><span class="token punctuation">(</span>poClientCmd<span class="token operator">-></span><span class="token function">GetEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>poClientCmd<span class="token operator">-></span><span class="token function">GetWriteBatchID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> tSrcRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>iValueID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">if</span> CERTAIN_DEBUG</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tSrcRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>strValue <span class="token operator">!=</span> ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">GetWriteBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"BUG record: %s cli_cmd: %s"</span><span class="token punctuation">,</span> <span class="token function">EntryRecordToString</span><span class="token punctuation">(</span>tSrcRecord<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                          ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">AssertEqual</span><span class="token punctuation">(</span><span class="token function">CRC32</span><span class="token punctuation">(</span>tSrcRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>strValue<span class="token punctuation">)</span><span class="token punctuation">,</span>
                      <span class="token function">CRC32</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">GetWriteBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token comment">// 一致则 OK</span>
        <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> eRetCodeOK<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"wb_id(%lu, %lu) cmd %s"</span><span class="token punctuation">,</span> poClientCmd<span class="token operator">-></span><span class="token function">GetWriteBatchID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        tSrcRecord<span class="token punctuation">.</span>tValue<span class="token punctuation">.</span>iValueID<span class="token punctuation">,</span> poClientCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 不一致则返回版本错误</span>
        <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> eRetCodeOtherVChosen<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 处理 WaitingMsg</span>
  <span class="token keyword">uint32_t</span> iWaitingMsgPtrSize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clsPaxosCmd <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">*</span> m_iAcceptorNum<span class="token punctuation">;</span>
  clsPaxosCmd <span class="token operator">*</span><span class="token operator">*</span>apWaitingMsg <span class="token operator">=</span> <span class="token punctuation">(</span>clsPaxosCmd <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>iWaitingMsgPtrSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span> <span class="token function">oAutoFreeWaitingMsgPtr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>apWaitingMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">memcpy</span><span class="token punctuation">(</span>apWaitingMsg<span class="token punctuation">,</span> ptInfo<span class="token operator">-></span>apWaitingMsg<span class="token punctuation">,</span> iWaitingMsgPtrSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>ptInfo<span class="token operator">-></span>apWaitingMsg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> iWaitingMsgPtrSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

  iRet <span class="token operator">=</span> <span class="token function">DoWithWaitingMsg</span><span class="token punctuation">(</span>apWaitingMsg<span class="token punctuation">,</span> m_iAcceptorNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"DoWithWaitingMsg ret %d"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    m_poMemCacheCtrl<span class="token operator">-></span><span class="token function">UpdateTotalSize</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 检查是否进行 CatchUp</span>
  <span class="token function">CheckForCatchUp</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetDestAcceptorID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>SyncEntryRecord</code> 会和其他节点同步 Entry Record：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">void</span> clsEntityWorker<span class="token operator">::</span><span class="token function">SyncEntryRecord</span><span class="token punctuation">(</span>EntryInfo_t <span class="token operator">*</span>ptInfo<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> iDestAcceptorID<span class="token punctuation">,</span>
                                      <span class="token keyword">uint64_t</span> iUUID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  EntityInfo_t <span class="token operator">*</span>ptEntityInfo <span class="token operator">=</span> ptInfo<span class="token operator">-></span>ptEntityInfo<span class="token punctuation">;</span>
  <span class="token function">AssertNotEqual</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">uint64_t</span> iEntityID <span class="token operator">=</span> ptEntityInfo<span class="token operator">-></span>iEntityID<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iEntry <span class="token operator">=</span> ptInfo<span class="token operator">-></span>iEntry<span class="token punctuation">;</span>

  <span class="token keyword">uint32_t</span> iLocalAcceptorID <span class="token operator">=</span> ptEntityInfo<span class="token operator">-></span>iLocalAcceptorID<span class="token punctuation">;</span>

  clsEntryStateMachine <span class="token operator">*</span>poMachine <span class="token operator">=</span> ptInfo<span class="token operator">-></span>poMachine<span class="token punctuation">;</span>
  <span class="token keyword">const</span> EntryRecord_t <span class="token operator">&amp;</span>tSrcRecord <span class="token operator">=</span> poMachine<span class="token operator">-></span><span class="token function">GetRecord</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">CertainLogDebug</span><span class="token punctuation">(</span><span class="token string">"state %d bRemoteUpdated %u bBroadcast %u record %s"</span><span class="token punctuation">,</span> poMachine<span class="token operator">-></span><span class="token function">GetEntryState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  ptInfo<span class="token operator">-></span>bRemoteUpdated<span class="token punctuation">,</span> ptInfo<span class="token operator">-></span>bBroadcast<span class="token punctuation">,</span>
                  <span class="token function">EntryRecordToString</span><span class="token punctuation">(</span>tSrcRecord<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果需要广播</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptInfo<span class="token operator">-></span>bBroadcast<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">AssertEqual</span><span class="token punctuation">(</span>iDestAcceptorID<span class="token punctuation">,</span> INVALID_ACCEPTOR_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 广播给所有节点</span>
    <span class="token function">BroadcastToRemote</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> poMachine<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ptInfo<span class="token operator">-></span>bBroadcast <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    ptInfo<span class="token operator">-></span>bRemoteUpdated <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果 DestAcceptorID 需要更新</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptInfo<span class="token operator">-></span>bRemoteUpdated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">AssertNotEqual</span><span class="token punctuation">(</span>iDestAcceptorID<span class="token punctuation">,</span> INVALID_ACCEPTOR_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> EntryRecord_t <span class="token operator">&amp;</span>tDestRecord <span class="token operator">=</span> poMachine<span class="token operator">-></span><span class="token function">GetRecord</span><span class="token punctuation">(</span>iDestAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// If dest has been chosen, it's no use to send msg.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tDestRecord<span class="token punctuation">.</span>bChosen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 构造回复</span>
      clsPaxosCmd <span class="token operator">*</span>po <span class="token operator">=</span>
          <span class="token keyword">new</span> <span class="token function">clsPaxosCmd</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tSrcRecord<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tDestRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>

      po<span class="token operator">-></span><span class="token function">SetUUID</span><span class="token punctuation">(</span>iUUID<span class="token punctuation">)</span><span class="token punctuation">;</span>
      po<span class="token operator">-></span><span class="token function">SetDestAcceptorID</span><span class="token punctuation">(</span>iDestAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>

      po<span class="token operator">-></span><span class="token function">SetMaxChosenEntry</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 通过 IO Worker 发送回去</span>
      m_poIOWorkerRouter<span class="token operator">-></span><span class="token function">GoAndDeleteIfFailed</span><span class="token punctuation">(</span>po<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ptInfo<span class="token operator">-></span>bRemoteUpdated <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>A 节点广播出去后，B 节点和 C 节点收到会调用 <code>DoWithPaxosCmd</code> 处理：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// 处理接收到的 PaxosCmd</span>
<span class="token keyword">int</span> clsEntityWorker<span class="token operator">::</span><span class="token function">DoWithPaxosCmd</span><span class="token punctuation">(</span>clsPaxosCmd <span class="token operator">*</span>poPaxosCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iRet<span class="token punctuation">;</span>

  <span class="token keyword">uint32_t</span> iRandomDropRatio <span class="token operator">=</span> m_poConf<span class="token operator">-></span><span class="token function">GetRandomDropRatio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRandomDropRatio <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> m_poRandom<span class="token operator">-></span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">&lt;</span> iRandomDropRatio<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> eRetCodeRandomDrop<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 请求超时，直接拒绝</span>
  <span class="token keyword">uint32_t</span> iIOReqTimeoutUS <span class="token operator">=</span> m_poConf<span class="token operator">-></span><span class="token function">GetIOReqTimeoutMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iIOReqTimeoutUS <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">uint64_t</span> iCurrTimeUS <span class="token operator">=</span> <span class="token function">GetCurrTimeUS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iCurrTimeUS <span class="token operator">>=</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetTimestampUS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> iIOReqTimeoutUS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"reject cmd: %s"</span><span class="token punctuation">,</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> eRetCodeReject<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">uint32_t</span> iAcceptorID <span class="token operator">=</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetSrcAcceptorID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iEntityID <span class="token operator">=</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iEntry <span class="token operator">=</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  EntityInfo_t <span class="token operator">*</span>ptEntityInfo <span class="token operator">=</span> m_poEntityMng<span class="token operator">-></span><span class="token function">FindEntityInfo</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果当前内存中没有该 Entity 的 Info</span>
    <span class="token comment">// 检查能否清理，失败则上报，并返回错误</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_poEntityMng<span class="token operator">-></span><span class="token function">CheckAndEliminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">EvictEntity</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        OSS<span class="token operator">::</span><span class="token function">ReportEvictFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        OSS<span class="token operator">::</span><span class="token function">ReportEntityLimited</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> eRetCodeEntityLimited<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        OSS<span class="token operator">::</span><span class="token function">ReportEvictSucc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 创建新的 EntityInfo</span>
    ptEntityInfo <span class="token operator">=</span> m_poEntityMng<span class="token operator">-></span><span class="token function">CreateEntityInfo</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"CreateEntityInfo failed cmd: %s"</span><span class="token punctuation">,</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> eRetCodeRouteErr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 后台从 PLog 中尝试恢复信息</span>
    <span class="token function">RangeLoadFromPLog</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">Assert</span><span class="token punctuation">(</span>m_poEntityMng<span class="token operator">-></span><span class="token function">Refresh</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  ptEntityInfo<span class="token operator">-></span>iActiveAcceptorID <span class="token operator">=</span> iAcceptorID<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> eRetCodeNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span>
        <span class="token string">"E(%lu %lu) not found, need get all, "</span>
        <span class="token string">"bGetAllPending %d MaxPLogEntry %lu MaxContChosenEntry %lu"</span><span class="token punctuation">,</span>
        iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>bGetAllPending<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry<span class="token punctuation">,</span>
        ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>bGetAllPending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> eRetCodeGetAllPending<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry <span class="token operator">>=</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ptEntityInfo<span class="token operator">-></span>bGetAllPending <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> eRetCodeGetAllPending<span class="token punctuation">)</span><span class="token punctuation">;</span>

    iRet <span class="token operator">=</span> clsGetAllWorker<span class="token operator">::</span><span class="token function">EnterReqQueue</span><span class="token punctuation">(</span>poPaxosCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ptEntityInfo<span class="token operator">-></span>bGetAllPending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> eRetCodeQueueFailed<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">uint32_t</span> iLocalAcceptorID <span class="token operator">=</span> ptEntityInfo<span class="token operator">-></span>iLocalAcceptorID<span class="token punctuation">;</span>
  <span class="token function">AssertNotEqual</span><span class="token punctuation">(</span>iAcceptorID<span class="token punctuation">,</span> iLocalAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// INVALID_ACCEPTOR_ID was used to get a identical packet.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetDestAcceptorID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> INVALID_ACCEPTOR_ID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    poPaxosCmd<span class="token operator">-></span><span class="token function">SetDestAcceptorID</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ptEntityInfo<span class="token operator">-></span>bRangeLoaded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 还没有完成 RangeLoad 的步骤</span>
    <span class="token comment">// RangeLoadFromPLog first, which will GetMaxPLogEntry.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ptEntityInfo<span class="token operator">-></span>bRangeLoading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 还没有启动 RangeLoad，则启动</span>
      <span class="token function">RangeLoadFromPLog</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ptEntityInfo<span class="token operator">-></span>bRangeLoading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"ignore cmd: %s"</span><span class="token punctuation">,</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> eRetCodeMsgIngnored<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Wait for resolving uncertain status.</span>
  EntryInfo_t <span class="token operator">*</span>ptInfo <span class="token operator">=</span> m_poEntryMng<span class="token operator">-></span><span class="token function">FindEntryInfo</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptInfo <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> ptInfo<span class="token operator">-></span>bUncertain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_poMemCacheCtrl<span class="token operator">-></span><span class="token function">IsOverLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) TotalSize %lu"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                      m_poMemCacheCtrl<span class="token operator">-></span><span class="token function">GetTotalSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> eRetCodeMemCacheLimited<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptInfo<span class="token operator">-></span>apWaitingMsg<span class="token punctuation">[</span>iAcceptorID<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"cmd: %s replaced with new cmd: %s"</span><span class="token punctuation">,</span>
                     ptInfo<span class="token operator">-></span>apWaitingMsg<span class="token punctuation">[</span>iAcceptorID<span class="token punctuation">]</span><span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                     poPaxosCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">delete</span> ptInfo<span class="token operator">-></span>apWaitingMsg<span class="token punctuation">[</span>iAcceptorID<span class="token punctuation">]</span><span class="token punctuation">;</span>
      ptInfo<span class="token operator">-></span>apWaitingMsg<span class="token punctuation">[</span>iAcceptorID<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"waiting cmd: %s"</span><span class="token punctuation">,</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设定 WaitingMsg，之后会介绍作用</span>
    ptInfo<span class="token operator">-></span>apWaitingMsg<span class="token punctuation">[</span>iAcceptorID<span class="token punctuation">]</span> <span class="token operator">=</span> poPaxosCmd<span class="token punctuation">;</span>
    m_poMemCacheCtrl<span class="token operator">-></span><span class="token function">UpdateTotalSize</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">CertainLogDebug</span><span class="token punctuation">(</span><span class="token string">"iAcceptorID %u E(%lu, %lu) entrys: %lu %lu"</span><span class="token punctuation">,</span> iAcceptorID<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                  ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>bRangeLoading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果还处理 RangeLoad 的阶段</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_poMemCacheCtrl<span class="token operator">-></span><span class="token function">IsOverLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) TotalSize %lu"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                      m_poMemCacheCtrl<span class="token operator">-></span><span class="token function">GetTotalSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> eRetCodeMemCacheLimited<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// The first loading could contain the entry probably.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>apWaitingMsg<span class="token punctuation">[</span>iAcceptorID<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"pending cmd: %s"</span><span class="token punctuation">,</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        ptEntityInfo<span class="token operator">-></span>apWaitingMsg<span class="token punctuation">[</span>iAcceptorID<span class="token punctuation">]</span> <span class="token operator">=</span> poPaxosCmd<span class="token punctuation">;</span>
        m_poMemCacheCtrl<span class="token operator">-></span><span class="token function">UpdateTotalSize</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>apWaitingMsg<span class="token punctuation">[</span>iAcceptorID<span class="token punctuation">]</span><span class="token operator">-></span><span class="token function">GetEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"cmd: %s replaced with new cmd: %s"</span><span class="token punctuation">,</span>
                        ptEntityInfo<span class="token operator">-></span>apWaitingMsg<span class="token punctuation">[</span>iAcceptorID<span class="token punctuation">]</span><span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        poPaxosCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> ptEntityInfo<span class="token operator">-></span>apWaitingMsg<span class="token punctuation">[</span>iAcceptorID<span class="token punctuation">]</span><span class="token punctuation">;</span>
        ptEntityInfo<span class="token operator">-></span>apWaitingMsg<span class="token punctuation">[</span>iAcceptorID<span class="token punctuation">]</span> <span class="token operator">=</span> poPaxosCmd<span class="token punctuation">;</span>
        m_poMemCacheCtrl<span class="token operator">-></span><span class="token function">UpdateTotalSize</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"ignore cmd: %s"</span><span class="token punctuation">,</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> eRetCodeMsgIngnored<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ptEntityInfo<span class="token operator">-></span>bRangeLoaded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Avoid GetMaxPLogEntry before PutRecord.</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"ignore cmd: %s"</span><span class="token punctuation">,</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> eRetCodeMsgIngnored<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">CertainLogDebug</span><span class="token punctuation">(</span><span class="token string">"iAcceptorID %u E(%lu, %lu) iMaxChosenEntry %lu"</span><span class="token punctuation">,</span> iAcceptorID<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                  ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_poConf<span class="token operator">-></span><span class="token function">GetEnableLearnOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetSrcRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>bChosen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 学习者模式，Cmd 非 chosen 状态</span>
    <span class="token function">CheckForCatchUp</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> iAcceptorID<span class="token punctuation">,</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetMaxChosenEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"learn only, ignore cmd: %s"</span><span class="token punctuation">,</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> eRetCodeMsgIngnored<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry <span class="token operator">>=</span> iEntry <span class="token operator">&amp;&amp;</span> poPaxosCmd<span class="token operator">-></span><span class="token function">IsQuickRsp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果 Cmd 中的 Entry 比全局已经 Chosen 的 Entry 小，说明发送消息的节点进度慢了，快速回复告诉它最新的进度</span>
    clsPaxosCmd <span class="token operator">*</span>po <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">clsPaxosCmd</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    po<span class="token operator">-></span><span class="token function">SetDestAcceptorID</span><span class="token punctuation">(</span>iAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    po<span class="token operator">-></span><span class="token function">SetResult</span><span class="token punctuation">(</span>eRetCodeRemoteNewer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    po<span class="token operator">-></span><span class="token function">SetUUID</span><span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    po<span class="token operator">-></span><span class="token function">SetMaxChosenEntry</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    OSS<span class="token operator">::</span><span class="token function">ReportFastFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_poIOWorkerRouter<span class="token operator">-></span><span class="token function">GoAndDeleteIfFailed</span><span class="token punctuation">(</span>po<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">CheckForCatchUp</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> iAcceptorID<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu %lu) QuickRsp iMaxChosenEntry %lu"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                    ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> eRetCodeRemoteNewer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">GetUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">GetEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">IsReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> eRetCodeRemoteNewer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptInfo <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ptInfo<span class="token operator">-></span>bUncertain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">GetEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      m_poEntryMng<span class="token operator">-></span><span class="token function">RemoveTimeout</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) Remove For CatchUp"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">CheckForCatchUp</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> iAcceptorID<span class="token punctuation">,</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetMaxChosenEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry <span class="token operator">>=</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptInfo <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> ptInfo<span class="token operator">-></span>poMachine<span class="token operator">-></span><span class="token function">GetEntryState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> kEntryStateChosen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetSrcRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>bChosen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> EntryRecord_t <span class="token operator">&amp;</span>tLocalRecord <span class="token operator">=</span> ptInfo<span class="token operator">-></span>poMachine<span class="token operator">-></span><span class="token function">GetRecord</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> EntryRecord_t <span class="token operator">&amp;</span>tRemoteRecord <span class="token operator">=</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetSrcRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      clsPaxosCmd <span class="token operator">*</span>po <span class="token operator">=</span>
          <span class="token keyword">new</span> <span class="token function">clsPaxosCmd</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tLocalRecord<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tRemoteRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>

      po<span class="token operator">-></span><span class="token function">SetDestAcceptorID</span><span class="token punctuation">(</span>iAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>
      po<span class="token operator">-></span><span class="token function">SetMaxChosenEntry</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      po<span class="token operator">-></span><span class="token function">SetUUID</span><span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      m_poIOWorkerRouter<span class="token operator">-></span><span class="token function">GoAndDeleteIfFailed</span><span class="token punctuation">(</span>po<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Entry not more than iMaxContChosenEntry must be chosen.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry <span class="token operator">>=</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetSrcRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>bChosen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      clsPaxosCmd <span class="token operator">*</span>po <span class="token operator">=</span>
          <span class="token keyword">new</span> <span class="token function">clsPaxosCmd</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetSrcRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      po<span class="token operator">-></span><span class="token function">SetDestAcceptorID</span><span class="token punctuation">(</span>iAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>
      po<span class="token operator">-></span><span class="token function">SetPLogReturn</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      po<span class="token operator">-></span><span class="token function">SetMaxChosenEntry</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      po<span class="token operator">-></span><span class="token function">SetUUID</span><span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      iRet <span class="token operator">=</span> clsPLogWorker<span class="token operator">::</span><span class="token function">EnterPLogReqQueue</span><span class="token punctuation">(</span>po<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">delete</span> po<span class="token punctuation">,</span> po <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"EnterPLogReqQueue ret %d"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"Check if msg delay cmd: %s"</span><span class="token punctuation">,</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptInfo <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Entry Info 为空</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CheckIfEntryNumLimited</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> eRetCodeEntryLimited<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 创建新的 Entry Info</span>
    ptInfo <span class="token operator">=</span> m_poEntryMng<span class="token operator">-></span><span class="token function">CreateEntryInfo</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_poEntryMng<span class="token operator">-></span><span class="token function">AddTimeout</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry <span class="token operator">==</span> INVALID_ENTRY <span class="token operator">||</span> iEntry <span class="token operator">&lt;=</span> ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">LoadFromPLogWorker</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        m_poEntryMng<span class="token operator">-></span><span class="token function">DestroyEntryInfo</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        ptInfo<span class="token operator">-></span>apWaitingMsg<span class="token punctuation">[</span>iAcceptorID<span class="token punctuation">]</span> <span class="token operator">=</span> poPaxosCmd<span class="token punctuation">;</span>
        m_poMemCacheCtrl<span class="token operator">-></span><span class="token function">UpdateTotalSize</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ptInfo<span class="token operator">-></span>bNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">AssertNotMore</span><span class="token punctuation">(</span>iEntry<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

    clsPaxosCmd <span class="token operator">*</span>po <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">clsPaxosCmd</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    po<span class="token operator">-></span><span class="token function">SetResult</span><span class="token punctuation">(</span>eRetCodeNotFound<span class="token punctuation">)</span><span class="token punctuation">;</span>
    po<span class="token operator">-></span><span class="token function">SetDestAcceptorID</span><span class="token punctuation">(</span>iAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    po<span class="token operator">-></span><span class="token function">SetMaxChosenEntry</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    po<span class="token operator">-></span><span class="token function">SetUUID</span><span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    m_poIOWorkerRouter<span class="token operator">-></span><span class="token function">GoAndDeleteIfFailed</span><span class="token punctuation">(</span>po<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"E(%lu %lu) not found and MaxContChoseEntry %lu"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                   ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ptInfo<span class="token operator">-></span>poMachine<span class="token operator">-></span><span class="token function">GetEntryState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> kEntryStateChosen <span class="token operator">&amp;&amp;</span>
             ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry <span class="token operator">>=</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    clsPaxosCmd <span class="token operator">*</span>po <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">clsPaxosCmd</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    po<span class="token operator">-></span><span class="token function">SetResult</span><span class="token punctuation">(</span>eRetCodeNotFound<span class="token punctuation">)</span><span class="token punctuation">;</span>
    po<span class="token operator">-></span><span class="token function">SetDestAcceptorID</span><span class="token punctuation">(</span>iAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    po<span class="token operator">-></span><span class="token function">SetMaxChosenEntry</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    po<span class="token operator">-></span><span class="token function">SetUUID</span><span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    m_poIOWorkerRouter<span class="token operator">-></span><span class="token function">GoAndDeleteIfFailed</span><span class="token punctuation">(</span>po<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"E(%lu %lu) not found and MaxContChoseEntry %lu"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                    ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">GetEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. Avoid multi create for concurrent read.</span>
    <span class="token comment">// 2. When timeout, cleanup if empty, otherwise to get chosen.</span>
    m_poEntryMng<span class="token operator">-></span><span class="token function">AddTimeout</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">AssertNotEqual</span><span class="token punctuation">(</span>ptInfo<span class="token operator">-></span>poMachine<span class="token operator">-></span><span class="token function">GetEntryState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kEntryStateChosen<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 更新 Entry Record</span>
  iRet <span class="token operator">=</span> <span class="token function">UpdateRecord</span><span class="token punctuation">(</span>poPaxosCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"UpdateRecord ret %d"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 检查是否进行 CatchUp</span>
  <span class="token function">CheckForCatchUp</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> iAcceptorID<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>iEntry <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetMaxChosenEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>DoWithPaxosCmd</code> 中大部分都是对于 <code>EntityInfo</code> 和 <code>EntryInfo</code> 的判断，有些细节笔者也在理解中，之后可能会补上。核心的调用自然是 <code>UpdateRecord</code>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">int</span> clsEntityWorker<span class="token operator">::</span><span class="token function">UpdateRecord</span><span class="token punctuation">(</span>clsPaxosCmd <span class="token operator">*</span>poPaxosCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">uint32_t</span> iAcceptorID <span class="token operator">=</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetSrcAcceptorID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iEntityID <span class="token operator">=</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iEntry <span class="token operator">=</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">CertainLogDebug</span><span class="token punctuation">(</span><span class="token string">"iAcceptorID %u E(%lu, %lu)"</span><span class="token punctuation">,</span> iAcceptorID<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

  EntityInfo_t <span class="token operator">*</span>ptEntityInfo <span class="token operator">=</span> m_poEntityMng<span class="token operator">-></span><span class="token function">FindEntityInfo</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">AssertNotEqual</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">uint32_t</span> iLocalAcceptorID <span class="token operator">=</span> ptEntityInfo<span class="token operator">-></span>iLocalAcceptorID<span class="token punctuation">;</span>

  EntryInfo_t <span class="token operator">*</span>ptInfo <span class="token operator">=</span> m_poEntryMng<span class="token operator">-></span><span class="token function">FindEntryInfo</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">AssertNotEqual</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  clsEntryStateMachine <span class="token operator">*</span>poMachine <span class="token operator">=</span> ptInfo<span class="token operator">-></span>poMachine<span class="token punctuation">;</span>
  <span class="token keyword">const</span> EntryRecord_t tOldRecord <span class="token operator">=</span> poMachine<span class="token operator">-></span><span class="token function">GetRecord</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">CertainLogDebug</span><span class="token punctuation">(</span><span class="token string">"before update cmd: %s state %u"</span><span class="token punctuation">,</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  poMachine<span class="token operator">-></span><span class="token function">GetEntryState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> EntryRecord_t <span class="token operator">&amp;</span>tSrcRecord <span class="token operator">=</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetSrcRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> EntryRecord_t <span class="token operator">&amp;</span>tDestRecord <span class="token operator">=</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetDestRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_poMemCacheCtrl<span class="token operator">-></span><span class="token function">IsOverLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) TotalSize %lu"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                    m_poMemCacheCtrl<span class="token operator">-></span><span class="token function">GetTotalSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> eRetCodeMemCacheLimited<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 根据 Cmd 携带的本地和远端的状态，Update 状态机</span>
  <span class="token keyword">int</span> iRet <span class="token operator">=</span> poMachine<span class="token operator">-></span><span class="token function">Update</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> iLocalAcceptorID<span class="token punctuation">,</span> iAcceptorID<span class="token punctuation">,</span> tSrcRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
  m_poMemCacheCtrl<span class="token operator">-></span><span class="token function">UpdateTotalSize</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"poMachine->Update ret %d cmd: %s state: %s"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">,</span>
                    poPaxosCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> poMachine<span class="token operator">-></span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">CertainLogDebug</span><span class="token punctuation">(</span><span class="token string">"after  update cmd: %s state %u"</span><span class="token punctuation">,</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  poMachine<span class="token operator">-></span><span class="token function">GetEntryState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 当前处于获得了 MajorityPromise 的状态，则尝试往内部写入值</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>poMachine<span class="token operator">-></span><span class="token function">GetEntryState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> kEntryStateMajorityPromise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    PaxosValue_t tValue<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">GetEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      tValue<span class="token punctuation">.</span>bHasValue <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      tValue<span class="token punctuation">.</span>iValueID <span class="token operator">=</span> ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">GetWriteBatchID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      tValue<span class="token punctuation">.</span>strValue <span class="token operator">=</span> ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">GetWriteBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      tValue<span class="token punctuation">.</span>vecValueUUID <span class="token operator">=</span> ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">GetWBUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      tValue<span class="token punctuation">.</span>bHasValue <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      tValue<span class="token punctuation">.</span>iValueID <span class="token operator">=</span> clsEntityInfoMng<span class="token operator">::</span><span class="token function">GenerateValueID</span><span class="token punctuation">(</span>
          ptEntityInfo<span class="token punctuation">,</span> poMachine<span class="token operator">-></span><span class="token function">GetRecord</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">)</span><span class="token punctuation">.</span>iPreparedNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> bAcceptPreparedValue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    iRet <span class="token operator">=</span> poMachine<span class="token operator">-></span><span class="token function">AcceptOnMajorityPromise</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">,</span> tValue<span class="token punctuation">,</span> bAcceptPreparedValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogFatal</span><span class="token punctuation">(</span><span class="token string">"state: %s"</span><span class="token punctuation">,</span> poMachine<span class="token operator">-></span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 没有接收该 Value，并且有对应的 ClientCmd，则返回拒绝</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bAcceptPreparedValue <span class="token operator">&amp;&amp;</span> ptEntityInfo<span class="token operator">-></span>poClientCmd <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span>
        ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">GetEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> eRetCodeMajPromFailed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 获取更新后的状态</span>
  <span class="token keyword">const</span> EntryRecord_t <span class="token operator">&amp;</span>tNewRecord <span class="token operator">=</span> poMachine<span class="token operator">-></span><span class="token function">GetRecord</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> EntryRecord_t <span class="token operator">&amp;</span>tRemoteRecord <span class="token operator">=</span> poMachine<span class="token operator">-></span><span class="token function">GetRecord</span><span class="token punctuation">(</span>iAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 判断是否存在远端 Record 更新</span>
  <span class="token keyword">bool</span> bRemoteUpdated <span class="token operator">=</span> <span class="token function">IsEntryRecordUpdated</span><span class="token punctuation">(</span>tDestRecord<span class="token punctuation">,</span> tNewRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 判断是否存在本地 Record 更新</span>
  <span class="token keyword">bool</span> bLocalUpdated <span class="token operator">=</span> <span class="token function">IsEntryRecordUpdated</span><span class="token punctuation">(</span>tOldRecord<span class="token punctuation">,</span> tNewRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 构造 PaxosCmd，附带最新的 Record 信息</span>
  clsPaxosCmd <span class="token operator">*</span>po <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token function">clsPaxosCmd</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tNewRecord<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tRemoteRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
  po<span class="token operator">-></span><span class="token function">SetUUID</span><span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  po<span class="token operator">-></span><span class="token function">SetMaxPLogEntry</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">)</span>ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">AssertEqual</span><span class="token punctuation">(</span>ptInfo<span class="token operator">-></span>bBroadcast<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  po<span class="token operator">-></span><span class="token function">SetDestAcceptorID</span><span class="token punctuation">(</span>iAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>bLocalUpdated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 本地有更新，则需要落盘</span>
    ptInfo<span class="token operator">-></span>bRemoteUpdated <span class="token operator">=</span> bRemoteUpdated<span class="token punctuation">;</span>

    ptInfo<span class="token operator">-></span>bUncertain <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">// Opt for req on the newest entry.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry <span class="token operator">==</span> INVALID_ENTRY <span class="token operator">&amp;&amp;</span> ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry <span class="token operator">&lt;=</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      po<span class="token operator">-></span><span class="token function">SetCheckHasMore</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 加到 PLogReq 队列中</span>
    iRet <span class="token operator">=</span> clsPLogWorker<span class="token operator">::</span><span class="token function">EnterPLogReqQueue</span><span class="token punctuation">(</span>po<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"EnterPLogReqQueue ret %d"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">delete</span> po<span class="token punctuation">,</span> po <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      ptInfo<span class="token operator">-></span>bUncertain <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token function">CleanUpEntry</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Only slave has lease, as requests go to master first.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iEntry <span class="token operator">></span> ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry <span class="token operator">&amp;&amp;</span> poMachine<span class="token operator">-></span><span class="token function">IsRemoteCompeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ptEntityInfo<span class="token operator">-></span>poLeasePolicy<span class="token operator">-></span><span class="token function">OnRecvMsgSuccessfully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通知 DB 落盘</span>
    <span class="token function">CheckIfNeedNotifyDB</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    clsAutoDelete<span class="token operator">&lt;</span>clsPaxosCmd<span class="token operator">></span> <span class="token function">oAuto</span><span class="token punctuation">(</span>po<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">IsReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">GetUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          poMachine<span class="token operator">-></span><span class="token function">IsLocalEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        poMachine<span class="token operator">-></span><span class="token function">SetCheckedEmpty</span><span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetSrcAcceptorID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>poMachine<span class="token operator">-></span><span class="token function">IsReadOK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> eRetCodeOK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>poMachine<span class="token operator">-></span><span class="token function">IsLocalEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> eRetCodeReadFailed<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 同步状态</span>
    ptInfo<span class="token operator">-></span>bRemoteUpdated <span class="token operator">=</span> bRemoteUpdated<span class="token punctuation">;</span>
    <span class="token function">SyncEntryRecord</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> po<span class="token operator">-></span><span class="token function">GetDestAcceptorID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> po<span class="token operator">-></span><span class="token function">GetUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>如果是本地有更新，会先进行 PLog 持久化，再去和其他节点同步状态。例如 A 节点给 B 和 C 发送 Prepare 后，B 先 Promise，进入 <code>EntryStatePromiseRemote</code> 的状态，会先进行 PLog 持久化，再给 A 发送回复。A 收到 B 的 Promised 后，获得多数派支持进入 <code>EntryStateMajorityPromise</code> 状态，同样会先进行 PLog 持久化，给 B 回复 Accept 请求。此时如果收到 C 的 Promised，A 本地是不需要进行 PLog 持久化的，会直接给 C 回复最新的状态。</p>
<p>上面走完一轮就完成了一半的 Paxos 过程。下面发送 Accept、接受并回复 Accepted 和上面的过程是类似的。PaxosStore 中通过消息队列和 RPC 将整个流程彻底异步化，提高了并发性能。可以看到，总的 Latency 至少包括 2 次 RPC RTT。对于 3 个节点的集群，共计 8 次 fsync，单节点平均执行 2.67 次 fsync，Latency 里至少包含 5 次 fsync 的时间。对于高并发系统这样的性能表现仍然是不够的，所以 PaxosStore 中额外使用了预授权优化提高性能。</p>
<h3 id="2.-预授权优化"><a href="#2.-%E9%A2%84%E6%8E%88%E6%9D%83%E4%BC%98%E5%8C%96">2. 预授权优化</a></h3>
<p>回忆一下 Paxos 流程：第一阶段 Proposer 发起 Prepare 请求，Acceptor 接受后回复 Promised；Proposer 获得多数派支持后，进入第二阶段发送 Accept 请求，Acceptor 接受后回复 Accepted，多数派通过后值被 Chosen。</p>
<p>PaxosStore 通过下面两个简单的操作实现一阶段提交：</p>
<ol>
<li>如果当前节点 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">i</span></span></span></span></eq> 发起的 Paxos 过程成功，记录 LocalPreAuthEntry = Entry + 1；</li>
<li>如果当前节点 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">i</span></span></span></span></eq> 发起 Paxos 过程的 Entry = LocalPreAuthEntry，则将 PreparedNum / ProposalNum / AcceptedNum 设定为 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">i</span></span></span></span></eq>，直接发送 Accept 请求；否则将 PreparedNum / ProposalNum 设定为 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>+</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">i + N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.74285em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></eq>，走正常流程发送 Prepare 请求。</li>
</ol>
<p>简单来想，就是 Acceptor 在 Accept Entry 的请求时，已经 Promise 了 Entry + 1 且 PreparedNum &lt; N 的请求。另一个角度看，只有上一轮成功发起 Paxos 流程的唯一节点会发送 PreparedNum &lt; N 的请求，可以在不违反 Paxos 协议的前提下直接发送 Accept 请求。</p>
<p>理解了这个操作后就会感受到这个优化的精妙。经过优化后整个 Paxos 过程的 Latency 降低到 1 次 RPC RTT，对于 3 节点集群，单节点平均执行 1.33 次 fsync。</p>
<h3 id="3.-总结"><a href="#3.-%E6%80%BB%E7%BB%93">3. 总结</a></h3>
<p>PaxosStore 整个项目还是比较艰深的，从一月开始断断续续一遍读一边总结，之后应该也会慢慢查漏补缺更新这些博文。写博文的时候自己也在加深理解，同时也会体会到 PaxosStore 项目中的些许精妙。</p>
<p>PS：如果你对 Paxos、分布式存储系统、基础架构等有兴趣，我或许可以帮你内推到开发 PaxosStore 的小组，坐标广州微信技术架构部。</p>

      </div>
      <div id="gitalk-container">
      </div>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2020 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://travis-ci.com/SF-Zhou/sf-zhou.github.io">Travis CI</a>.
        </div>
      </div>
    </div>
    <script src="/dist/gitalk.min.js"></script>
    <script src="/dist/main.js"></script>
  </body>
</html>
