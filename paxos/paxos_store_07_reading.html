<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/dist/favicon.ico">
    <link rel="apple-touch-icon" href="/dist/favicon.png">
    <link rel="stylesheet" type="text/css" href="/dist/highlight.css">
    <link rel="stylesheet" type="text/css" href="/dist/katex.min.css">
    <link rel="stylesheet" type="text/css" href="/dist/gitalk.css">
    <link rel="stylesheet" type="text/css" href="/dist/main.css">
    <title>PaxosStore 源码分析「七、其他细节」 | SF-Zhou's Blog</title>
  </head>
  <body>
    <div class="app">
      <div class="title">
        <h1> PaxosStore 源码分析「七、其他细节」 </h1>
      </div>
      <div class="info">
        <div class="date"> 2020.04.26 </div>
        <a href="https://github.com/SF-Zhou">
          <div class="author"> SF-Zhou </div>
        </a>
      </div>
      <div class="markdown">
        <p>作为<a href="/#/Paxos">本系列</a>的最后一篇博文，本篇会争取把之前挖的坑一一填上，包括读取、CatchUp 和 Recovery 的流程，以及 WaitingMsg 的使用。</p>
<h3 id="1.-读取流程"><a href="#1.-%E8%AF%BB%E5%8F%96%E6%B5%81%E7%A8%8B">1. 读取流程</a></h3>
<p>首先可以看下 <a href="https://github.com/Tencent/paxosstore/blob/master/certain/example/ServiceImpl.cpp#L35"><code>example/ServiceImpl.cpp</code></a> 中对读取的处理：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">int</span> clsServiceImpl<span class="token operator">::</span><span class="token function">SelectCard</span><span class="token punctuation">(</span>grpc<span class="token operator">::</span>ServerContext <span class="token operator">&amp;</span>oContext<span class="token punctuation">,</span> <span class="token keyword">const</span> example<span class="token operator">::</span>CardRequest <span class="token operator">&amp;</span>oRequest<span class="token punctuation">,</span>
                               example<span class="token operator">::</span>CardResponse <span class="token operator">&amp;</span>oResponse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iRet <span class="token operator">=</span> <span class="token function">BatchFunc</span><span class="token punctuation">(</span>example<span class="token operator">::</span>OperCode<span class="token operator">::</span>eSelectCard<span class="token punctuation">,</span> oRequest<span class="token punctuation">,</span> oResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> iRet<span class="token punctuation">;</span>

  clsDBImpl <span class="token operator">*</span>poDBEngine <span class="token operator">=</span>
      <span class="token keyword">dynamic_cast</span><span class="token operator">&lt;</span>clsDBImpl <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>Certain<span class="token operator">::</span>clsCertainWrapper<span class="token operator">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetDBEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  dbtype<span class="token operator">::</span>DB <span class="token operator">*</span>poDB <span class="token operator">=</span> poDBEngine<span class="token operator">-></span><span class="token function">GetDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  clsTemporaryTable <span class="token function">oTable</span><span class="token punctuation">(</span>poDB<span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token operator">::</span>string strKey<span class="token punctuation">;</span>
  <span class="token function">EncodeInfoKey</span><span class="token punctuation">(</span>strKey<span class="token punctuation">,</span> oRequest<span class="token punctuation">.</span><span class="token function">entity_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> oRequest<span class="token punctuation">.</span><span class="token function">card_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>string strValue<span class="token punctuation">;</span>
  iRet <span class="token operator">=</span> oTable<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>strKey<span class="token punctuation">,</span> strValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> Certain<span class="token operator">::</span>eRetCodeNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> example<span class="token operator">::</span>StatusCode<span class="token operator">::</span>eCardNotExist<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>oResponse<span class="token punctuation">.</span><span class="token function">mutable_card_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ParseFromString</span><span class="token punctuation">(</span>strValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Certain<span class="token operator">::</span>eRetCodeParseProtoErr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> iRet<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>首先会跑一遍 <code>BatchFunc</code>，然后正常地读取一遍本地数据库。换句话说如果 <code>BatchFunc</code> 成功返回了，那么本地数据也是最新的。如果仔细看 <code>BatchFunc</code> 的实现，会发现纯读的请求对应的 <code>write_batch</code> 是空的，其他的和正常写入没有区别。来看下对于纯读的请求 PaxosStore 是如何处理的：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// src/CertainWrapper.cpp</span>
<span class="token keyword">int</span> clsCertainWrapper<span class="token operator">::</span><span class="token function">RunPaxos</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> iEntry<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> hSubCmdID<span class="token punctuation">,</span>
                                <span class="token keyword">const</span> vector<span class="token operator">&lt;</span><span class="token keyword">uint64_t</span><span class="token operator">></span> <span class="token operator">&amp;</span>vecWBUUID<span class="token punctuation">,</span> <span class="token keyword">const</span> string <span class="token operator">&amp;</span>strWriteBatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// WriteBatch 为空时为 ReadOnly 模式</span>
  poWB<span class="token operator">-></span><span class="token function">SetReadOnly</span><span class="token punctuation">(</span>strWriteBatch<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">// src/EntryState.cpp</span>
<span class="token keyword">void</span> clsEntryStateMachine<span class="token operator">::</span><span class="token function">SetCheckedEmpty</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> iAcceptorID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 设定 CheckedEmpty 状态</span>
  m_atRecord<span class="token punctuation">[</span>iAcceptorID<span class="token punctuation">]</span><span class="token punctuation">.</span>bCheckedEmpty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">bool</span> clsEntryStateMachine<span class="token operator">::</span><span class="token function">IsReadOK</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 检查是否多数派为空</span>
  <span class="token keyword">uint32_t</span> iCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> s_iAcceptorNum<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_atRecord<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bCheckedEmpty <span class="token operator">&amp;&amp;</span> m_atRecord<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>iPromisedNum <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      iCount<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">CertainLogDebug</span><span class="token punctuation">(</span><span class="token string">"iCount %u"</span><span class="token punctuation">,</span> iCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> iCount <span class="token operator">>=</span> s_iMajorityNum<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// src/Command.cpp</span>
<span class="token keyword">int</span> clsPaxosCmd<span class="token operator">::</span><span class="token function">ParseFromArray</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pcBuffer<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> iLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  CertainPB<span class="token operator">::</span>PaxosCmd oPaxosCmd<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oPaxosCmd<span class="token punctuation">.</span><span class="token function">ParseFromArray</span><span class="token punctuation">(</span>pcBuffer<span class="token punctuation">,</span> iLen<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"ParseFromArray fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">SetFromHeader</span><span class="token punctuation">(</span>oPaxosCmd<span class="token punctuation">.</span><span class="token function">mutable_header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  m_iSrcAcceptorID <span class="token operator">=</span> oPaxosCmd<span class="token punctuation">.</span><span class="token function">src_acceptor_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  m_iDestAcceptorID <span class="token operator">=</span> oPaxosCmd<span class="token punctuation">.</span><span class="token function">dest_acceptor_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ConvertFromPB</span><span class="token punctuation">(</span>m_tSrcRecord<span class="token punctuation">,</span> <span class="token operator">&amp;</span>oPaxosCmd<span class="token punctuation">.</span><span class="token function">src_record</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ConvertFromPB</span><span class="token punctuation">(</span>m_tDestRecord<span class="token punctuation">,</span> <span class="token operator">&amp;</span>oPaxosCmd<span class="token punctuation">.</span><span class="token function">dest_record</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果是 Check Empty 的 Cmd</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oPaxosCmd<span class="token punctuation">.</span><span class="token function">check_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">Assert</span><span class="token punctuation">(</span><span class="token function">IsEntryRecordEmpty</span><span class="token punctuation">(</span>m_tSrcRecord<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Assert</span><span class="token punctuation">(</span><span class="token function">IsEntryRecordEmpty</span><span class="token punctuation">(</span>m_tDestRecord<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 目标 PromisedNum 设为 -1，-1 &lt; 0</span>
    m_tDestRecord<span class="token punctuation">.</span>iPromisedNum <span class="token operator">=</span> INVALID_PROPOSAL_NUM<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  m_bQuickRsp <span class="token operator">=</span> oPaxosCmd<span class="token punctuation">.</span><span class="token function">quick_rsp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  m_iMaxChosenEntry <span class="token operator">=</span> oPaxosCmd<span class="token punctuation">.</span><span class="token function">max_chosen_entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// src/EntityWorker.cpp</span>
<span class="token keyword">int</span> clsEntityWorker<span class="token operator">::</span><span class="token function">DoWithClientCmd</span><span class="token punctuation">(</span>clsClientCmd <span class="token operator">*</span>poCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>poCmd<span class="token operator">-></span><span class="token function">IsReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>poMachine<span class="token operator">-></span><span class="token function">IsLocalEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      poMachine<span class="token operator">-></span><span class="token function">ResetAllCheckedEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      poMachine<span class="token operator">-></span><span class="token function">SetCheckedEmpty</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">BroadcastToRemote</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 此时的 Record 为初始化状态</span>
      m_poEntryMng<span class="token operator">-></span><span class="token function">AddTimeout</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> m_poConf<span class="token operator">-></span><span class="token function">GetCmdTimeoutMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">OSS</span><span class="token operator">::</span><span class="token function">ReportCheckEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token class-name">OSS</span><span class="token operator">::</span><span class="token function">ReportPaxosForRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token class-name">OSS</span><span class="token operator">::</span><span class="token function">ReportPaxosForWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">// 接收回复的 PaxosCmd 并更新 Record</span>
<span class="token keyword">int</span> clsEntityWorker<span class="token operator">::</span><span class="token function">UpdateRecord</span><span class="token punctuation">(</span>clsPaxosCmd <span class="token operator">*</span>poPaxosCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// 判断是否存在远端 Record 更新，上面的 -1 会让这里变成 true</span>
  <span class="token keyword">bool</span> bRemoteUpdated <span class="token operator">=</span> <span class="token function">IsEntryRecordUpdated</span><span class="token punctuation">(</span>tDestRecord<span class="token punctuation">,</span> tNewRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 判断是否存在本地 Record 更新，都是初始化的状态，仍然 false</span>
  <span class="token keyword">bool</span> bLocalUpdated <span class="token operator">=</span> <span class="token function">IsEntryRecordUpdated</span><span class="token punctuation">(</span>tOldRecord<span class="token punctuation">,</span> tNewRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>bLocalUpdated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通知 DB 落盘</span>
    <span class="token function">CheckIfNeedNotifyDB</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    clsAutoDelete<span class="token operator">&lt;</span>clsPaxosCmd<span class="token operator">></span> <span class="token function">oAuto</span><span class="token punctuation">(</span>po<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">IsReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果发起方的命令是 ReadOnly 的</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">GetUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          poMachine<span class="token operator">-></span><span class="token function">IsLocalEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 标记回复节点 Checked 成功</span>
        poMachine<span class="token operator">-></span><span class="token function">SetCheckedEmpty</span><span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetSrcAcceptorID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 多数派为空，返回成功</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>poMachine<span class="token operator">-></span><span class="token function">IsReadOK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> eRetCodeOK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>poMachine<span class="token operator">-></span><span class="token function">IsLocalEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> eRetCodeReadFailed<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 同步状态</span>
    ptInfo<span class="token operator">-></span>bRemoteUpdated <span class="token operator">=</span> bRemoteUpdated<span class="token punctuation">;</span>
    <span class="token function">SyncEntryRecord</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">,</span> po<span class="token operator">-></span><span class="token function">GetDestAcceptorID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> po<span class="token operator">-></span><span class="token function">GetUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>逻辑非常隐含，初始化 Record 后，标记 <code>CheckedEmpty</code> 直接发送出去；接收到的节点反序列化时将 <code>CheckedEmpty</code> 的 Cmd 的 <code>src.PromisedNum</code> 设为 -1，使得 <code>bRemoteUpdated</code> 始终成立，始终回包；<code>bLocalUpdated</code> 为 <code>false</code> 所以不会落盘；最后发起请求的节点获得多数派为空的回复后，确定本地和全局进度一致。对应的失败处理留给读者自己分析。</p>
<p>严格来说这样写代码并不好，逻辑隐藏地太深了。当然以此实现的不落盘读取还是很精妙的。</p>
<h3 id="2.-catchup-流程"><a href="#2.-catchup-%E6%B5%81%E7%A8%8B">2. CatchUp 流程</a></h3>
<p>CatchUp 包括 <code>EntityCatchUp</code> 和 <code>CheckForCatchUp</code>，前者负责将 <code>CommittedEntry</code> 追赶到 <code>MaxChosenEntry</code>，后者负责将 <code>MaxContChosenEntry</code> 追赶到 <code>MaxChosenEntry</code>。在之前的<a href="/paxos/paxos_store_05_details.html">「五、实现细节」</a>有对应的函数细节分析，这里看一下实际运行时的状态。考虑以下情况：</p>
<ol>
<li>A 机网络中断；</li>
<li>客户端向 A 机发出请求，超时，转而请求 B；</li>
<li>B / C 达成了一些共识；</li>
<li>A 机网络恢复；</li>
<li>客户端向 A 机发出读取请求，A 机首先执行 <code>EntityCatchUp</code> 提交 PLog 到 DB，而后发起协议，由于 B / C 进度更新，返回 RemoteNewer；</li>
<li>A 机执行 <code>CheckForCatchUp</code>，向 B / C 机请求缺失的 PLog。</li>
</ol>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">int</span> clsEntityWorker<span class="token operator">::</span><span class="token function">DoWithPaxosCmd</span><span class="token punctuation">(</span>clsPaxosCmd <span class="token operator">*</span>poPaxosCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// B / C 检查发现 A 机发起协议的 Entry 落后，返回当前 MaxChosenEntry 和 RemoteNewer</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry <span class="token operator">>=</span> iEntry <span class="token operator">&amp;&amp;</span> poPaxosCmd<span class="token operator">-></span><span class="token function">IsQuickRsp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    clsPaxosCmd <span class="token operator">*</span>po <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">clsPaxosCmd</span><span class="token punctuation">(</span>iLocalAcceptorID<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    po<span class="token operator">-></span><span class="token function">SetDestAcceptorID</span><span class="token punctuation">(</span>iAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    po<span class="token operator">-></span><span class="token function">SetResult</span><span class="token punctuation">(</span>eRetCodeRemoteNewer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    po<span class="token operator">-></span><span class="token function">SetUUID</span><span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    po<span class="token operator">-></span><span class="token function">SetMaxChosenEntry</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">OSS</span><span class="token operator">::</span><span class="token function">ReportFastFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_poIOWorkerRouter<span class="token operator">-></span><span class="token function">GoAndDeleteIfFailed</span><span class="token punctuation">(</span>po<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">CheckForCatchUp</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> iAcceptorID<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu %lu) QuickRsp iMaxChosenEntry %lu"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span>
                    ptEntityInfo<span class="token operator">-></span>iMaxChosenEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// A 机接收到 B / C 的回复，首先通知 ClientCmd 失败，而后执行 CheckForCatchUp</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> eRetCodeRemoteNewer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">GetUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">GetEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">IsReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> eRetCodeRemoteNewer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptInfo <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ptInfo<span class="token operator">-></span>bUncertain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>poClientCmd <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> ptEntityInfo<span class="token operator">-></span>poClientCmd<span class="token operator">-></span><span class="token function">GetEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      m_poEntryMng<span class="token operator">-></span><span class="token function">RemoveTimeout</span><span class="token punctuation">(</span>ptInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"E(%lu, %lu) Remove For CatchUp"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">CheckForCatchUp</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> iAcceptorID<span class="token punctuation">,</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetMaxChosenEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>由于本地不存在对应的 PLog 记录，<code>CheckForCatchUp</code> 最终会调用 <code>ActivateEntry</code> 向 Active 节点通过 RPC 同步记录。这里有一个隐含的拦截逻辑，在 <a href="https://github.com/Tencent/paxosstore/blob/master/certain/src/IOWorker.cpp#L199"><code>src/IOWorker.cpp</code></a> 中：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// 调用 Go 并 Delete</span>
<span class="token keyword">int</span> clsIOWorkerRouter<span class="token operator">::</span><span class="token function">GoAndDeleteIfFailed</span><span class="token punctuation">(</span>clsCmdBase <span class="token operator">*</span>poCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iRet<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>poCmd<span class="token operator">-></span><span class="token function">GetCmdID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> kPaxosCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    clsPaxosCmd <span class="token operator">*</span>poPaxosCmd <span class="token operator">=</span> <span class="token keyword">dynamic_cast</span><span class="token operator">&lt;</span>clsPaxosCmd <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前 Cmd 的 Entry 小于 MaxChosenEntry</span>
    <span class="token comment">// 或者当前 Cmd 的 Entry 等于 MaxChosenEntry 并且 SrcRecord 还没有被 Chosen</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetMaxChosenEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetMaxChosenEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
         <span class="token operator">!</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetSrcRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>bChosen<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 表明自己对全局仍然是需要追赶的状态，通过 CatchUpWorker 缓速 Cmd</span>
      iRet <span class="token operator">=</span> m_poCatchUpWorker<span class="token operator">-></span><span class="token function">PushCatchUpCmdByMultiThread</span><span class="token punctuation">(</span>poPaxosCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"PushCatchUpCmdByMultiThread ret %d"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> poCmd<span class="token punctuation">,</span> poCmd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  iRet <span class="token operator">=</span> <span class="token function">Go</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"Go E(%lu, %lu) ret %d"</span><span class="token punctuation">,</span> poCmd<span class="token operator">-></span><span class="token function">GetEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> poCmd<span class="token operator">-></span><span class="token function">GetEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> poCmd<span class="token punctuation">,</span> poCmd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>CatchUpWorker</code> 中有流量和次数限制，避免短时间内发出大量追赶请求而影响正常服务的响应：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// CatchUp Loop，从 CatchUp 队列中取出 Cmd，通过流量和次数控速，再发送</span>
<span class="token keyword">void</span> clsCatchUpWorker<span class="token operator">::</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iRet<span class="token punctuation">;</span>
  <span class="token function">SetThreadTitle</span><span class="token punctuation">(</span><span class="token string">"catchup_%u"</span><span class="token punctuation">,</span> m_iLocalServerID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"catchup_%u run"</span><span class="token punctuation">,</span> m_iLocalServerID<span class="token punctuation">)</span><span class="token punctuation">;</span>

  clsSmartSleepCtrl <span class="token function">oSleepCtrl</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CheckIfExiting</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"catchup_%u exit\n"</span><span class="token punctuation">,</span> m_iLocalServerID<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"catchup_%u exit"</span><span class="token punctuation">,</span> m_iLocalServerID<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    m_poCatchUpCtrl<span class="token operator">-></span><span class="token function">UpdateCatchUpSpeed</span><span class="token punctuation">(</span>m_poConf<span class="token operator">-></span><span class="token function">GetMaxCatchUpSpeedKB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_poCatchUpCtrl<span class="token operator">-></span><span class="token function">UpdateCatchUpCnt</span><span class="token punctuation">(</span>m_poConf<span class="token operator">-></span><span class="token function">GetMaxCatchUpCnt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    clsPaxosCmd <span class="token operator">*</span>poCmd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    iRet <span class="token operator">=</span> m_poCatchUpQueue<span class="token operator">-></span><span class="token function">TakeByOneThread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      oSleepCtrl<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">PrintStat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      oSleepCtrl<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">uint64_t</span> iEntityID <span class="token operator">=</span> poCmd<span class="token operator">-></span><span class="token function">GetEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">uint32_t</span> iDestAcceptorID <span class="token operator">=</span> poCmd<span class="token operator">-></span><span class="token function">GetDestAcceptorID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">uint64_t</span> iByteSize <span class="token operator">=</span> <span class="token function">EstimateSize</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 流量控速</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">uint64_t</span> iWaitTimeMS <span class="token operator">=</span> m_poCatchUpCtrl<span class="token operator">-></span><span class="token function">UseByteSize</span><span class="token punctuation">(</span>iByteSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>iWaitTimeMS <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token function">CertainLogImpt</span><span class="token punctuation">(</span><span class="token string">"catchup iByteSize %lu iWaitTimeMS %lu"</span><span class="token punctuation">,</span> iByteSize<span class="token punctuation">,</span> iWaitTimeMS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">usleep</span><span class="token punctuation">(</span>iWaitTimeMS <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 次数控速</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">uint64_t</span> iWaitTimeMS <span class="token operator">=</span> m_poCatchUpCtrl<span class="token operator">-></span><span class="token function">UseCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>iWaitTimeMS <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token function">CertainLogImpt</span><span class="token punctuation">(</span><span class="token string">"catchup iWaitTimeMS %lu by count"</span><span class="token punctuation">,</span> iWaitTimeMS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">usleep</span><span class="token punctuation">(</span>iWaitTimeMS <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 发送 CMD 并更新统计</span>
    iRet <span class="token operator">=</span> m_poIOWorkerRouter<span class="token operator">-></span><span class="token function">Go</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"Go ret %d cmd: %s"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">,</span> poCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">delete</span> poCmd<span class="token punctuation">,</span> poCmd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">DoStat</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iDestAcceptorID<span class="token punctuation">,</span> iByteSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>B / C 机收到这些 Entry 落后的请求后，将自身的 PLog 记录回包，A 机收到后正常更新即可追赶到全局最新的进度。</p>
<h3 id="3.-recover-流程"><a href="#3.-recover-%E6%B5%81%E7%A8%8B">3. Recover 流程</a></h3>
<p>当 Entry Record 中的 Value 成功提交到 DB 之后，其对应的 PLog 就可以“安全”删除了。PLog 删除的代码在开源版中并没有提供，询问了 PaxosStore 的开发者之后，确认 PLog 定期扫描删除已经提交的 Record 以减轻存储压力。考虑以下情况：</p>
<ol>
<li>A 机挂掉；</li>
<li>B / C 机达成了一些共识；</li>
<li>B / C 机删除了对应的 PLog；</li>
<li>A 机重启成功；</li>
<li>客户端向 A 机发出读取请求，A 机发起协议，由于 B / C 进度更新，返回 RemoteNewer；</li>
<li>A 机 CheckForCatchUp，向 B / C 机请求缺失的 PLog，返回 NotFound。</li>
</ol>
<p>此时已经没有可读取的 PLog 供 A 机恢复，A 机只能向 B / C 请求全量的 DB 数据以恢复，也就是这里说的 Recover 流程。</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">int</span> clsEntityWorker<span class="token operator">::</span><span class="token function">DoWithPaxosCmd</span><span class="token punctuation">(</span>clsPaxosCmd <span class="token operator">*</span>poPaxosCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>poPaxosCmd<span class="token operator">-></span><span class="token function">GetResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> eRetCodeNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span>
        <span class="token string">"E(%lu %lu) not found, need get all, "</span>
        <span class="token string">"bGetAllPending %d MaxPLogEntry %lu MaxContChosenEntry %lu"</span><span class="token punctuation">,</span>
        iEntityID<span class="token punctuation">,</span> iEntry<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>bGetAllPending<span class="token punctuation">,</span> ptEntityInfo<span class="token operator">-></span>iMaxPLogEntry<span class="token punctuation">,</span>
        ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>bGetAllPending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> eRetCodeGetAllPending<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptEntityInfo<span class="token operator">-></span>iMaxContChosenEntry <span class="token operator">>=</span> iEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ptEntityInfo<span class="token operator">-></span>bGetAllPending <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">InvalidClientCmd</span><span class="token punctuation">(</span>ptEntityInfo<span class="token punctuation">,</span> eRetCodeGetAllPending<span class="token punctuation">)</span><span class="token punctuation">;</span>

    iRet <span class="token operator">=</span> clsGetAllWorker<span class="token operator">::</span><span class="token function">EnterReqQueue</span><span class="token punctuation">(</span>poPaxosCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> eRetCodePtrReuse<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ptEntityInfo<span class="token operator">-></span>bGetAllPending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> eRetCodeQueueFailed<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> clsGetAllWorker<span class="token operator">::</span><span class="token function">HandleInQueue</span><span class="token punctuation">(</span>clsPaxosCmd <span class="token operator">*</span>poCmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">OSS</span><span class="token operator">::</span><span class="token function">ReportGetAllReq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  clsDBBase <span class="token operator">*</span>pDataDB <span class="token operator">=</span> clsCertainWrapper<span class="token operator">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetDBEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iCommitedEntry <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> iRet <span class="token operator">=</span> pDataDB<span class="token operator">-></span><span class="token function">GetAllAndSet</span><span class="token punctuation">(</span>poCmd<span class="token operator">-></span><span class="token function">GetEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> poCmd<span class="token operator">-></span><span class="token function">GetSrcAcceptorID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iCommitedEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"EntityID %lu GetAllAndSet iRet %d"</span><span class="token punctuation">,</span> poCmd<span class="token operator">-></span><span class="token function">GetEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OSS</span><span class="token operator">::</span><span class="token function">ReportGetAllFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  poCmd<span class="token operator">-></span><span class="token function">SetResult</span><span class="token punctuation">(</span>iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>

  poCmd<span class="token operator">-></span><span class="token function">SetEntry</span><span class="token punctuation">(</span>iCommitedEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> iEntityID <span class="token operator">=</span> poCmd<span class="token operator">-></span><span class="token function">GetEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> iSrcAcceptorID <span class="token operator">=</span> poCmd<span class="token operator">-></span><span class="token function">GetSrcAcceptorID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    iRet <span class="token operator">=</span> clsEntityWorker<span class="token operator">::</span><span class="token function">EnterGetAllRspQueue</span><span class="token punctuation">(</span>poCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"EntityID %lu EnterGetAllRspQueue iRet %d"</span><span class="token punctuation">,</span> poCmd<span class="token operator">-></span><span class="token function">GetEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">poll</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">CertainLogImpt</span><span class="token punctuation">(</span><span class="token string">"EntityID %lu srcAcceptorid %u iCommitedEntry %lu iRet %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span>
                 iSrcAcceptorID<span class="token punctuation">,</span> iCommitedEntry<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这里需要 DB 提供 <code>GetAllAndSet</code> 方法用以向 <code>iAcceptorID</code> 对应的机器获取 <code>iEntityID</code> 相关的全量数据。一般通过 RPC 请求数据，可以参见 <a href="https://github.com/Tencent/paxosstore/blob/master/certain/example/DBImpl.cpp#L146"><code>example/DBImpl.cpp</code></a>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// 使用 RPC 向 iAcceptorID 取数据</span>
<span class="token keyword">int</span> clsDBImpl<span class="token operator">::</span><span class="token function">GetAllAndSet</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> iEntityID<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> iAcceptorID<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> <span class="token operator">&amp;</span>iMaxCommitedEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  clsAutoDisableHook oAuto<span class="token punctuation">;</span>
  <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"Start GetAllAndSet()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> iRet <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">// Step 1: Sets flags for deleting.</span>
  <span class="token punctuation">{</span>
    Certain<span class="token operator">::</span>clsAutoEntityLock <span class="token function">oEntityLock</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    iRet <span class="token operator">=</span> <span class="token function">SetEntityMeta</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"SetFlag() iEntityID %lu iRet %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Certain<span class="token operator">::</span>eRetCodeSetFlagErr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Step 2: Deletes all kvs in db related to iEntityID.</span>
  std<span class="token operator">::</span>string strNextKey<span class="token punctuation">;</span>
  <span class="token function">EncodeInfoKey</span><span class="token punctuation">(</span>strNextKey<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    iRet <span class="token operator">=</span> <span class="token function">Clear</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> strNextKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"Clear() iEntityID %lu iRet %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Certain<span class="token operator">::</span>eRetCodeClearDBErr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>strNextKey<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">poll</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>strNextKey<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Step 3: Gets local machine ID.</span>
  clsCertainUserImpl <span class="token operator">*</span>poCertainUser <span class="token operator">=</span> <span class="token keyword">dynamic_cast</span><span class="token operator">&lt;</span>clsCertainUserImpl <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>
      Certain<span class="token operator">::</span>clsCertainWrapper<span class="token operator">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetCertainUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> iLocalAcceptorID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  iRet <span class="token operator">=</span> poCertainUser<span class="token operator">-></span><span class="token function">GetLocalAcceptorID</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iLocalAcceptorID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"GetLocalAcceptorID() iEntityID %lu iRet %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Certain<span class="token operator">::</span>eRetCodeGetLocalMachineIDErr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">grpc_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  grpc<span class="token operator">::</span>ChannelArguments oArgs<span class="token punctuation">;</span>
  oArgs<span class="token punctuation">.</span><span class="token function">SetInt</span><span class="token punctuation">(</span>GRPC_ARG_MAX_CONCURRENT_STREAMS<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  iRet <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token comment">// iAcceptorID is the ID of peer machine.</span>
  <span class="token keyword">uint32_t</span> iAcceptorNum <span class="token operator">=</span> Certain<span class="token operator">::</span>clsCertainWrapper<span class="token operator">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetAcceptorNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>iAcceptorID <span class="token operator">=</span> <span class="token punctuation">(</span>iLocalAcceptorID <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> iAcceptorNum<span class="token punctuation">;</span>
       iRet <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> iAcceptorID <span class="token operator">!=</span> iLocalAcceptorID<span class="token punctuation">;</span>
       iAcceptorID <span class="token operator">=</span> <span class="token punctuation">(</span>iAcceptorID <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> iAcceptorNum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token operator">::</span>string strAddr<span class="token punctuation">;</span>
    iRet <span class="token operator">=</span> poCertainUser<span class="token operator">-></span><span class="token function">GetServiceAddr</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iAcceptorID<span class="token punctuation">,</span> strAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"GetSvrAddr() iEntityID %lu iRet %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
      iRet <span class="token operator">=</span> Certain<span class="token operator">::</span>eRetCodeGetPeerSvrAddrErr<span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Step 4: Gets commited entry and sets local value.</span>
    example<span class="token operator">::</span>GetRequest oRequest<span class="token punctuation">;</span>
    oRequest<span class="token punctuation">.</span><span class="token function">set_entity_id</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    example<span class="token operator">::</span>GetResponse oResponse<span class="token punctuation">;</span>

    clsClient <span class="token function">oClient</span><span class="token punctuation">(</span>strAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> kRetry <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> kRetry<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      grpc<span class="token operator">::</span>Status oRet <span class="token operator">=</span> oClient<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>oRequest<span class="token punctuation">.</span><span class="token function">entity_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> example<span class="token operator">::</span>OperCode<span class="token operator">::</span>eGetDBEntityMeta<span class="token punctuation">,</span>
                                       <span class="token operator">&amp;</span>oRequest<span class="token punctuation">,</span> <span class="token operator">&amp;</span>oResponse<span class="token punctuation">,</span> strAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      iRet <span class="token operator">=</span> oRet<span class="token punctuation">.</span><span class="token function">error_code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"GetEntityMeta() iEntityID %lu iRet %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
      iRet <span class="token operator">=</span> Certain<span class="token operator">::</span>eRetCodeGetPeerCommitedEntryErr<span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    iMaxCommitedEntry <span class="token operator">=</span> oResponse<span class="token punctuation">.</span><span class="token function">max_commited_entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">uint64_t</span> iSequenceNumber <span class="token operator">=</span> oResponse<span class="token punctuation">.</span><span class="token function">sequence_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">{</span>
      Certain<span class="token operator">::</span>clsAutoEntityLock <span class="token function">oEntityLock</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>
      iRet <span class="token operator">=</span> <span class="token function">SetEntityMeta</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> iMaxCommitedEntry<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"SetEntityMeta() iEntityID %lu iRet %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        iRet <span class="token operator">=</span> Certain<span class="token operator">::</span>eRetCodeSetDBEntityMetaErr<span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Step 5: Gets data from peer endpoint.</span>
    std<span class="token operator">::</span>string strNextKey<span class="token punctuation">;</span>
    <span class="token function">EncodeInfoKey</span><span class="token punctuation">(</span>strNextKey<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      std<span class="token operator">::</span>string strWriteBatch<span class="token punctuation">;</span>
      oRequest<span class="token punctuation">.</span><span class="token function">set_max_size</span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      oRequest<span class="token punctuation">.</span><span class="token function">set_next_key</span><span class="token punctuation">(</span>strNextKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      oRequest<span class="token punctuation">.</span><span class="token function">set_sequence_number</span><span class="token punctuation">(</span>iSequenceNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
      oResponse<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> kRetry<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        grpc<span class="token operator">::</span>Status oRet <span class="token operator">=</span> oClient<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>oRequest<span class="token punctuation">.</span><span class="token function">entity_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> example<span class="token operator">::</span>OperCode<span class="token operator">::</span>eGetAllForCertain<span class="token punctuation">,</span>
                                         <span class="token operator">&amp;</span>oRequest<span class="token punctuation">,</span> <span class="token operator">&amp;</span>oResponse<span class="token punctuation">,</span> strAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        iRet <span class="token operator">=</span> oRet<span class="token punctuation">.</span><span class="token function">error_code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          strNextKey <span class="token operator">=</span> oResponse<span class="token punctuation">.</span><span class="token function">next_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          strWriteBatch <span class="token operator">=</span> oResponse<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"GetAllForCertain() iEntityID %lu iRet %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        iRet <span class="token operator">=</span> Certain<span class="token operator">::</span>eRetCodeGetDataFromPeerErr<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>strWriteBatch<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dbtype<span class="token operator">::</span>WriteBatch <span class="token function">oWriteBatch</span><span class="token punctuation">(</span>strWriteBatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>strWriteBatch<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          oWriteBatch<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        iRet <span class="token operator">=</span> <span class="token function">MultiPut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oWriteBatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"WriteBatch::Write() iEntityID %lu iRet %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
          iRet <span class="token operator">=</span> Certain<span class="token operator">::</span>eRetCodeCommitLocalDBErr<span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>strNextKey<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">poll</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>strNextKey<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Step 6: Re-deletes all kvs in db related to iEntityID.</span>
      std<span class="token operator">::</span>string strNextKey<span class="token punctuation">;</span>
      <span class="token function">EncodeInfoKey</span><span class="token punctuation">(</span>strNextKey<span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> iDelRet <span class="token operator">=</span> <span class="token function">Clear</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> strNextKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>iDelRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"Re-clear() iEntityID %lu iRet %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
          iRet <span class="token operator">=</span> Certain<span class="token operator">::</span>eRetCodeReClearDBErr<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>strNextKey<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token function">poll</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>strNextKey<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"Abort GetAllAndSet() iEntityID %lu iRet %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> iRet<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Step 7: Clear flag.</span>
  <span class="token punctuation">{</span>
    Certain<span class="token operator">::</span>clsAutoEntityLock <span class="token function">oEntityLock</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    iRet <span class="token operator">=</span> <span class="token function">SetEntityMeta</span><span class="token punctuation">(</span>iEntityID<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"SetFlag() iEntityID %lu iRet %d"</span><span class="token punctuation">,</span> iEntityID<span class="token punctuation">,</span> iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Certain<span class="token operator">::</span>eRetCodeClearFlagErr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"Finish GetAllAndSet()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> Certain<span class="token operator">::</span>eRetCodeOK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>在恢复数据的过程中，需要为该 <code>iEntityID</code> 加锁加 Flag 以拒绝其他读写服务，样例里使用的是协程锁，并且在 Entity Meta 中设置了 <code>kDBFlagCheckGetAll=1</code> 的 Flag。</p>
<h3 id="4.-waitingmsg"><a href="#4.-waitingmsg">4. WaitingMsg</a></h3>
<p>在 <code>EntryInfo</code> 里有一项 <code>WaitingMsg</code> 属性，当需要等待 <code>PLog</code> 读取或写入时，会将当前的 <code>Cmd</code> 存入该列表中暂存起来：</p>
<pre class="language-cpp"><code class="language-cpp">ptInfo<span class="token operator">-></span>apWaitingMsg<span class="token punctuation">[</span>iAcceptorID<span class="token punctuation">]</span> <span class="token operator">=</span> poPaxosCmd<span class="token punctuation">;</span>
</code></pre>
<p>而当 <code>PLog</code> 读写完成时，会调用 <code>DoWithWaitingMsg</code> 处理这些等待的 <code>Cmd</code>：</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// 将 WaitingMsg 中的 Cmd 推入 IO Req</span>
<span class="token keyword">int</span> clsEntityWorker<span class="token operator">::</span><span class="token function">DoWithWaitingMsg</span><span class="token punctuation">(</span>clsPaxosCmd <span class="token operator">*</span><span class="token operator">*</span>apWaitingMsg<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> iCnt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">uint32_t</span> iFailCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> iCnt<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    clsPaxosCmd <span class="token operator">*</span>poPaxosCmd <span class="token operator">=</span> apWaitingMsg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    apWaitingMsg<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>poPaxosCmd <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">CertainLogInfo</span><span class="token punctuation">(</span><span class="token string">"cmd: %s"</span><span class="token punctuation">,</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> iRet <span class="token operator">=</span> <span class="token function">DoWithIOReq</span><span class="token punctuation">(</span><span class="token keyword">dynamic_cast</span><span class="token operator">&lt;</span>clsCmdBase <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>poPaxosCmd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      iFailCnt<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"DoWithIOReq ret %d cmd %s"</span><span class="token punctuation">,</span> iRet<span class="token punctuation">,</span> poPaxosCmd<span class="token operator">-></span><span class="token function">GetTextCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iRet <span class="token operator">!=</span> eRetCodePtrReuse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> poPaxosCmd<span class="token punctuation">,</span> poPaxosCmd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>iFailCnt <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CertainLogError</span><span class="token punctuation">(</span><span class="token string">"iFailCnt %u"</span><span class="token punctuation">,</span> iFailCnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>

      </div>
      <div id="gitalk-container">
      </div>
      <div class="footer">
        <div class="license">
          Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.
        </div>
        <div class="copyright">
          Copyright©2020 SF-Zhou, All Rights Reserved. Powered by <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.
        </div>
      </div>
    </div>
    <script src="/dist/gitalk.min.js"></script>
    <script src="/dist/main.js"></script>
  </body>
</html>
